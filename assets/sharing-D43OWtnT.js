import{c as E,d as p,a as C,h as g,b as y}from"./firebase-config-DV_efyn3.js";import{g as b}from"./main-CbZLFheF.js";const e={modal:document.getElementById("share-modal"),closeBtn:document.getElementById("close-share-modal"),title:document.getElementById("share-modal-title"),friendsList:document.getElementById("share-friends-list"),sharePlanCheckbox:document.getElementById("share-planning-checkbox"),shareShoppingListCheckbox:document.getElementById("share-shopping-list-checkbox"),confirmBtn:document.getElementById("confirm-share-btn")};let i={};function I(){e.modal.classList.add("hidden");const t=document.getElementById("share-mode-selection");t&&t.classList.remove("hidden"),e.confirmBtn.textContent="Envoyer le partage";const r=e.confirmBtn.cloneNode(!0);e.confirmBtn.parentNode&&(e.confirmBtn.parentNode.replaceChild(r,e.confirmBtn),e.confirmBtn=r,r.addEventListener("click",N))}async function N(){const t=b();if(!t||!i.plan)return;const r=Array.from(e.friendsList.querySelectorAll('input[type="checkbox"]:checked')).map(n=>n.value),a=document.querySelector('input[name="share-mode"]:checked')?.value;if(r.length===0){alert("Veuillez sélectionner au moins un ami.");return}if(!a){alert("Veuillez sélectionner un mode de partage.");return}e.confirmBtn.disabled=!0,e.confirmBtn.textContent="Envoi en cours...";try{const n=E(p,"shares");let s={};a==="collaborate"?s={senderId:t,createdAt:new Date,type:"collaborative_plan_invite",planId:i.plan.id,planName:i.plan.name}:s={senderId:t,createdAt:new Date,type:"share",plan:{name:i.plan.name,weeks:i.plan.weeks||{},manualItems:i.plan.manualItems||[],defaultNumPeople:i.plan.defaultNumPeople||1,startDay:i.plan.startDay||"Lundi"}};for(const m of r)await C(n,{...s,receiverId:m,status:"pending"});I(),alert("Partage envoyé avec succès !")}catch(n){console.error("Erreur lors de l'envoi du partage : ",n),alert("Une erreur est survenue lors de l'envoi du partage.")}finally{e.confirmBtn.disabled=!1,e.confirmBtn.textContent="Envoyer le partage"}}async function M(t={}){const{plan:r}=t;if(!r){alert("Aucun plan sélectionné à partager.");return}i={plan:r},e.title.textContent=`Partager le plan "${r.name}"`,e.friendsList.innerHTML='<p class="text-gray-500">Chargement des amis...</p>',e.modal.classList.remove("hidden");const a=b();if(a)try{const n=await g(y(p,"users",a));if(n.exists()){const m=n.data().friends||[];if(m.length===0){e.friendsList.innerHTML=`<p class="text-gray-500">Vous n'avez pas d'amis à qui partager.</p>`;return}e.friendsList.innerHTML="";for(const f of m){const h=await g(y(p,"users",f));if(h.exists()){const u=h.data(),d=document.createElement("label");d.className="flex items-center p-2 hover:bg-gray-100 rounded-lg cursor-pointer";const o=document.createElement("input");o.type="checkbox",o.value=u.uid,o.className="form-checkbox h-5 w-5 text-tomato rounded focus:ring-tomato",d.appendChild(o);const l=document.createElement("img");l.src=u.photoURL||"https://placehold.co/40x40",l.alt=u.displayName,l.className="w-8 h-8 rounded-full ml-3 mr-3",d.appendChild(l);const c=document.createElement("span");c.className="font-medium",c.textContent=u.displayName||u.email,d.appendChild(c),e.friendsList.appendChild(d)}}}}catch(n){console.error("Erreur lors du chargement des amis pour le partage : ",n),e.friendsList.innerHTML='<p class="text-red-500">Une erreur est survenue.</p>'}}async function k(t){const r=b();if(!r||!t)return;const a=Array.from(e.friendsList.querySelectorAll('input[type="checkbox"]:checked:not(:disabled)')).map(n=>n.value);if(a.length===0){alert("Veuillez sélectionner au moins un ami à inviter.");return}e.confirmBtn.disabled=!0,e.confirmBtn.textContent="Envoi en cours...";try{const n=await g(y(p,"plans",t));if(!n.exists())throw new Error("Plan not found");const s=n.data().name,m=E(p,"shares"),f={senderId:r,createdAt:new Date,type:"collaborative_plan_invite",planId:t,planName:s};for(const h of a)await C(m,{...f,receiverId:h,status:"pending"});I(),alert("Invitation(s) envoyée(s) avec succès !")}catch(n){console.error("Erreur lors de l'envoi de l'invitation : ",n),alert("Une erreur est survenue lors de l'envoi de l'invitation.")}finally{e.confirmBtn.disabled=!1}}async function S(t){if(!t||!t.id){alert("Plan non valide pour l'invitation.");return}i={plan:t},e.title.textContent=`Inviter à collaborer sur "${t.name}"`;const r=document.getElementById("share-mode-selection");r&&r.classList.add("hidden"),e.friendsList.innerHTML='<p class="text-gray-500">Chargement des amis...</p>',e.modal.classList.remove("hidden");const a=b();if(!a)return;try{const s=await g(y(p,"users",a));if(s.exists()){const f=s.data().friends||[],h=[t.userId,...t.collaborators||[]];if(f.length===0){e.friendsList.innerHTML=`<p class="text-gray-500">Vous n'avez pas d'amis à inviter.</p>`;return}e.friendsList.innerHTML="";for(const u of f){const d=await g(y(p,"users",u));if(d.exists()){const o=d.data(),l=h.includes(o.uid),c=document.createElement("label");c.className=`flex items-center p-2 rounded-lg ${l?"opacity-50 cursor-not-allowed":"hover:bg-gray-100 cursor-pointer"}`;const v=document.createElement("input");v.type="checkbox",v.value=o.uid,v.className="form-checkbox h-5 w-5 text-tomato rounded focus:ring-tomato",l&&(v.disabled=!0,v.checked=!0),c.appendChild(v);const x=document.createElement("img");x.src=o.photoURL||"https://placehold.co/40x40",x.alt=o.displayName,x.className="w-8 h-8 rounded-full ml-3 mr-3",c.appendChild(x);const L=document.createElement("span");if(L.className="font-medium",L.textContent=o.displayName||o.email,l){const B=document.createElement("span");B.className="text-xs text-gray-400 ml-2",B.textContent="(déjà membre)",L.appendChild(B)}c.appendChild(L),e.friendsList.appendChild(c)}}}}catch(s){console.error("Erreur lors du chargement des amis pour l'invitation : ",s),e.friendsList.innerHTML='<p class="text-red-500">Une erreur est survenue.</p>'}e.confirmBtn.textContent="Envoyer l'invitation";const n=e.confirmBtn.cloneNode(!0);e.confirmBtn.parentNode.replaceChild(n,e.confirmBtn),e.confirmBtn=n,n.addEventListener("click",()=>k(t.id))}e.closeBtn?.addEventListener("click",I);e.modal?.addEventListener("click",t=>{t.target===e.modal&&I()});e.confirmBtn?.addEventListener("click",N);export{S as a,M as o};
