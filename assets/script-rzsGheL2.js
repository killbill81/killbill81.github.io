const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/main-DOZ5ZINl.js","assets/firebase-config-CPJ13vib.js","assets/firebase-config-DVv8XtdB.css"])))=>i.map(i=>d[i]);
import{e as gt,i as yt,b as ht,s as Ee,h as vt,g as fe,j as Te,_ as He,a as xt,k as Et,p as bt}from"./main-DOZ5ZINl.js";import{r as be,l as Ae,m as Lt,n as Ct,p as It,t as wt,v as St,x as qe,d as k,o as Mt,c as ae,g as ce,b as Q,j as Fe,q as Le,y as Re,w as je,i as Bt,z as kt,A as Oe,s as Dt,f as Nt,u as $t}from"./firebase-config-CPJ13vib.js";import{r as de,t as Pt}from"./recipes-YeGsctgT.js";import{o as Tt,a as Ht}from"./sharing-BV84mwUq.js";import{ingredientModalManager as At}from"./ingredient-modal-D7goZ8KJ.js";let K=null,se=null;function Ft(i,re){if(!be||!i)return;const Y=gt();if(!Y)return;const D=Ae(be,`plans_presence/${i}`);K=Ae(be,`plans_presence/${i}/${Y.uid}`);const N={displayName:Y.displayName||Y.email,photoURL:Y.photoURL,status:"idle",last_seen:qe()};Lt(K).remove(),Ct(K,N),se&&se(),se=It(D,v=>{const H=v.val()||{};typeof re=="function"&&re(H)})}function Rt(){K&&(St(K),K=null),se&&(se(),se=null)}function Ce(i){K&&wt(K,{status:i,last_seen:qe()})}function zt(){const i={mealPlanGrid:document.getElementById("meal-plan-grid"),currentWeekDisplay:document.getElementById("current-week-display"),prevWeekBtn:document.getElementById("prev-week-btn"),nextWeekBtn:document.getElementById("next-week-btn"),clearMenuBtn:document.getElementById("clear-menu-btn"),shoppingListContainer:document.getElementById("shopping-list"),startDaySelect:document.getElementById("start-day-select"),defaultServingsControl:document.getElementById("default-servings-control"),mealSelectModal:document.getElementById("meal-select-modal"),closeMealSelectModalBtn:document.getElementById("close-meal-select-modal"),mealSelectModalTitle:document.getElementById("meal-select-modal-title"),mealSelectList:document.getElementById("meal-select-list"),recipeFormModal:document.getElementById("edit-recipe-form-modal"),closeRecipeModalBtn:document.getElementById("close-edit-recipe-modal"),cancelRecipeBtn:document.getElementById("edit-cancel-recipe-btn"),recipeForm:document.getElementById("edit-recipe-form"),addItemInput:document.getElementById("add-item-input"),addItemBtn:document.getElementById("add-item-btn"),addItemResults:document.getElementById("add-item-results"),importListBtn:document.getElementById("import-list-btn"),importListModal:document.getElementById("import-list-modal"),closeImportListModalBtn:document.getElementById("close-import-list-modal"),importListContainer:document.getElementById("import-list-container"),exportTxtBtn:document.getElementById("export-txt-btn"),exportPdfBtn:document.getElementById("export-pdf-btn"),exportPlanPdfBtn:document.getElementById("export-plan-pdf-btn"),sharePlanBtn:document.getElementById("share-plan-btn"),planSelect:document.getElementById("plan-select"),inviteParticipantBtn:document.getElementById("invite-participant-btn"),historyPlanBtn:document.getElementById("history-plan-btn"),planHistoryModal:document.getElementById("plan-history-modal"),closePlanHistoryModalBtn:document.getElementById("close-plan-history-modal"),planHistoryList:document.getElementById("plan-history-list"),savePlanBtn:document.getElementById("save-plan-btn"),openTrashBtn:document.getElementById("open-trash-btn"),trashCount:document.getElementById("trash-count"),trashModal:document.getElementById("trash-modal"),closeTrashModalBtn:document.getElementById("close-trash-modal"),trashListContainer:document.getElementById("trash-list-container"),emptyTrashBtn:document.getElementById("empty-trash-btn"),smartPlanBtn:document.getElementById("smart-plan-btn"),archivePlanBtn:document.getElementById("archive-plan-btn")};function re(e,a){const t=document.createElement("div");t.className="flex items-center space-x-2";const r=document.createElement("button");r.className="btn btn-outline btn-xs",r.textContent="-";const n=document.createElement("span");n.className="font-medium text-center w-6",n.textContent=e;const o=document.createElement("button");return o.className="btn btn-outline btn-xs",o.textContent="+",r.addEventListener("click",()=>{let l=parseInt(n.textContent,10);l>1&&(l--,n.textContent=l,a(l))}),o.addEventListener("click",()=>{let l=parseInt(n.textContent,10);l++,n.textContent=l,a(l)}),t.appendChild(r),t.appendChild(n),t.appendChild(o),t}function Y(e,a,t,r=!1){const n=document.createElement("div");n.className="flex flex-col items-center justify-center h-full";const o=document.createElement("button");o.className="text-gray-600 hover:bg-gray-100 p-0 h-4 flex items-center justify-center w-full rounded-md",o.innerHTML='<i class="fas fa-plus"></i>',o.disabled=r;const l=document.createElement("span");l.className="font-medium text-center text-sm my-1",l.textContent=e;const s=document.createElement("button");return s.className="text-gray-600 hover:bg-gray-100 p-0 h-4 flex items-center justify-center w-full rounded-md",s.innerHTML='<i class="fas fa-minus"></i>',s.disabled=r,a&&(o.classList.add("text-white"),l.classList.add("text-white"),s.classList.add("text-white")),r||(o.addEventListener("click",()=>{let c=parseInt(l.textContent,10);c++,l.textContent=c,t(c)}),s.addEventListener("click",()=>{let c=parseInt(l.textContent,10);c>1&&(c--,l.textContent=c,t(c))})),n.appendChild(o),n.appendChild(l),n.appendChild(s),n}de.setActivityUpdater(Ce),de.setOnSaveCallback(async()=>{});let D=1,N="Lundi",v={},H={},P={};const _=[];let X=null,z=[],ee=[],R=1,te=null,ge=[],d=null;const q=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];function ue(e){return e?e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase():""}function Ue(e){return e?e.replace(/\./g,"_"):""}async function Ie(){if(k)try{ee=(await ce(ae(k,"ingredients"))).docs.map(a=>({id:a.id,...a.data()})),ee.sort((a,t)=>a.name.localeCompare(t.name))}catch(e){console.error("Erreur lors de la récupération des ingrédients: ",e)}}function we(){if(!d)v={},H={},P={},R=1,N="Lundi";else{const e=d.weeks?d.weeks[D]||{}:{};v=e.menuData||{},H=e.servingsData||{},P=e.remarksData||{},R=d.defaultNumPeople||1,N=d.startDay||"Lundi"}if(i.startDaySelect&&(i.startDaySelect.value=N),i.defaultServingsControl){i.defaultServingsControl.innerHTML="";const e=re(R,async a=>{R=a,d&&await V({defaultNumPeople:a},`a changé le nombre de personnes par défaut à ${a}`)});i.defaultServingsControl.appendChild(e)}dt(),oe(i.mealPlanGrid,{menuData:v,servingsData:H,remarksData:P,defaultNumPeople:R,startDay:N},!1),me(document.getElementById("mobile-meal-plan"),{menuData:v,servingsData:H,remarksData:P,defaultNumPeople:R,startDay:N},!1),ie()}async function V(e,a){if(!d)return;await Te(d.id,d,a);const t=Q(k,"plans",d.id);try{await $t(t,{...e,lastUpdated:new Date})}catch(r){console.error("Error updating plan:",r),alert("Une erreur de sauvegarde est survenue.")}}function ye(){i.planHistoryModal.classList.add("hidden")}async function _e(e){if(d&&confirm("Voulez-vous vraiment restaurer cette version ? L'état actuel sera sauvegardé dans l'historique avant la restauration."))try{const a=Q(k,"plans",d.id,"history",e),t=await Fe(a);if(!t.exists())throw new Error("Version de l'historique non trouvée.");const r=t.data().planState;await Te(d.id,d);const n=Q(k,"plans",d.id);await Dt(n,r),ye()}catch(a){console.error("Erreur lors du rollback :",a)}}async function ze(e,a){if(d&&confirm("Êtes-vous sûr de vouloir supprimer définitivement cette entrée de l'historique ?"))try{const t=Q(k,"plans",d.id,"history",e);await Nt(t),a.remove()}catch(t){console.error("Erreur lors de la suppression de l'historique :",t),alert("Une erreur est survenue lors de la suppression.")}}async function Ve(){if(d){i.planHistoryList.innerHTML="<p>Chargement de l'historique...</p>",i.planHistoryModal.classList.remove("hidden");try{const e=ae(k,"plans",d.id,"history"),a=Le(e,Re("timestamp","desc")),t=await ce(a);if(i.planHistoryList.innerHTML="",t.empty){i.planHistoryList.innerHTML="<p>Aucun historique pour ce plan.</p>";return}t.forEach(r=>{const n=r.data(),o=document.createElement("div");o.className="p-3 border-b flex justify-between items-center";const l=document.createElement("div"),s=n.timestamp?.toDate().toLocaleString("fr-FR")||"Date inconnue",c=n.description||"Modification diverse",u=n.modifiedByName||"Inconnu";l.innerHTML=`
                    <p class="font-medium">${u} ${c}</p>
                    <p class="text-sm text-gray-500">${s}</p>
                `;const m=document.createElement("div");m.className="flex items-center space-x-2";const p=document.createElement("button");p.className="btn btn-secondary btn-sm",p.textContent="Revenir à cette version",p.addEventListener("click",()=>_e(r.id));const f=document.createElement("button");f.className="text-red-500 hover:bg-red-100 text-sm px-3 py-1 rounded-md",f.innerHTML='<i class="fas fa-times"></i>',f.title="Supprimer cette version",f.addEventListener("click",g=>{g.stopPropagation(),ze(r.id,o)}),m.appendChild(p),m.appendChild(f),o.appendChild(l),o.appendChild(m),i.planHistoryList.appendChild(o)})}catch(e){console.error("Erreur de chargement de l'historique:",e),i.planHistoryList.innerHTML=`<p class="text-red-500">Impossible de charger l'historique.</p>`}}}async function Qe(){if(!d)return alert("Veuillez d'abord sélectionner un menu.");if(Object.keys(v).length>0){if(confirm(`Un menu existe déjà. Voulez-vous créer un NOUVEAU menu pour cette suggestion ?
(OK = Nouveau menu, Annuler = Écraser l'actuel)`)){const t=prompt("Nom du nouveau menu :",`Menu Intelligent - ${new Date().toLocaleDateString("fr-FR")}`);if(!t)return;i.smartPlanBtn.disabled=!0,i.smartPlanBtn.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i> Création du menu...';const r=await vt(t);if(!r){i.smartPlanBtn.disabled=!1,i.smartPlanBtn.innerHTML='<i class="fas fa-magic mr-1 md:mr-2"></i> Menu Intelligent';return}const n={id:r,name:t,userId:fe(),weeks:{},isOwner:!0};ge.push(n),i.planSelect.value=r,xe()}else if(!confirm("Voulez-vous vraiment ÉCRASER le menu actuel ?"))return}i.smartPlanBtn.disabled=!0;const e=i.smartPlanBtn.innerHTML;i.smartPlanBtn.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i> Chef Gusto réfléchit...';try{const t=(await ce(ae(k,"recipes"))).docs.map(g=>({id:g.id,...g.data()})),r=fe(),n=await ce(Le(ae(k,"plans"),je("userId","==",r),Re("lastUpdated","desc"))),o=[];n.docs.slice(0,3).forEach(g=>{const y=g.data();y.weeks&&Object.values(y.weeks).forEach(x=>{x.menuData&&Object.values(x.menuData).forEach(h=>{h.MIDI&&o.push(h.MIDI),h.SOIR&&o.push(h.SOIR)})})});const s=await Bt(kt,"suggestMenu")({recipes:t,history:[...new Set(o)],season:Ee.getCurrentSeason()}),c=s.data.menu,u=s.data.description,m={Lundi:0,Mardi:1,Mercredi:2,Jeudi:3,Vendredi:4,Samedi:5,Dimanche:6},p=JSON.parse(JSON.stringify(v));for(const[g,y]of Object.entries(c)){const x=m[g];if(x===void 0)continue;const h=(E,w)=>{const C=`${x}-${w==="MIDI"?"lunch":"dinner"}-1`;if(E){const M=t.find(A=>A.name===E);M?p[C]=[{id:M.id}]:console.warn(`Recipe not found for Smart Plan: ${E}`)}else delete p[C]};h(y.MIDI,"MIDI"),h(y.SOIR,"SOIR")}await V({[`weeks.${D}.menuData`]:p},u||"Génération Smart Plan par l'IA"),v=p,oe(i.mealPlanGrid,{menuData:v,servingsData:H,remarksData:P,defaultNumPeople:R,startDay:N},!1);const f=document.getElementById("mobile-meal-plan");f&&me(f,{menuData:v,servingsData:H,remarksData:P,defaultNumPeople:R,startDay:N},!1),ie(),alert(u||"Menu généré avec succès !")}catch(a){console.error("Smart Plan error:",a),alert("Erreur lors de la génération : "+a.message)}finally{i.smartPlanBtn.disabled=!1,i.smartPlanBtn.innerHTML=e}}async function Je(){if(!d){alert("Veuillez d'abord sélectionner un plan.");return}if(confirm(`Voulez-vous vraiment vider le menu de la semaine ${D} pour le plan "${d.name}" ?`)){v={},H={},P={},oe(i.mealPlanGrid,{menuData:v,servingsData:H,remarksData:P,defaultNumPeople:R,startDay:N},!1);const e=document.getElementById("mobile-meal-plan");e&&me(e,{menuData:v,servingsData:H,remarksData:P,defaultNumPeople:R,startDay:N},!1),await V({[`weeks.${D}.menuData`]:{},[`weeks.${D}.servingsData`]:{},[`weeks.${D}.remarksData`]:{}},"a vidé le menu de la semaine"),ie()}}function me(e,a,t=!1){if(!e)return;const r=a.menuData||{},n=a.servingsData||{},o=a.remarksData||{},l=a.defaultNumPeople||1,s=a.startDay||"Lundi";e.innerHTML="";const c=document.createDocumentFragment(),u=q.indexOf(s);[...q.slice(u),...q.slice(0,u)].forEach(p=>{const f=q.indexOf(p),g=document.createElement("div");g.className="bg-blue-100 border border-blue-300 rounded-xl shadow-md p-4 mb-4";const y=document.createElement("h3");y.className="text-xl font-bold text-gray-800 dark:text-gray-800 mb-3",y.textContent=p.toUpperCase(),g.appendChild(y);const x=document.createElement("div");x.className="space-y-4",["lunch","dinner"].forEach(h=>{const E=document.createElement("div");E.className=`border-t pt-3 ${h==="lunch"?"bg-amber-50":"bg-stone-100"} rounded-lg p-2`;const w=document.createElement("div");w.className="flex justify-between items-center mb-2";const C=document.createElement("h4");if(C.className="text-lg font-semibold text-tomato",C.textContent=h==="lunch"?"Midi":"Soir",w.appendChild(C),!t){const S=`${f}-${h}`,I=n[S]||l,b=re(I,L=>{Pe(S,L)});w.appendChild(b)}E.appendChild(w);const M=document.createElement("div");M.className="space-y-2";let A=!1;const $=["Entrée","Plat","Accompagnement","Dessert","Remarque"];for(let S=0;S<$.length;S++){const I=$[S],b=`${f}-${h}-${S}`,L=r[b],T=document.createElement("div");T.className="mb-2";const j=document.createElement("h5");if(j.className="text-md font-semibold text-gray-700 mb-1",j.textContent=I,T.appendChild(j),I==="Remarque")T.appendChild(Ne(b,o,t));else{const B=document.createElement("div");if(B.className="space-y-1",Array.isArray(L)&&L.length>0&&(A=!0,L.forEach((F,J)=>{const W=z.find(O=>O.id===F.id);if(W){const O=ke(W,b,J,t);if(O.classList.remove("bg-white","shadow-sm"),O.classList.add("bg-emerald-200","border","border-emerald-400"),!t){const U=O.querySelector(".edit-meal-btn"),ne=O.querySelector(".delete-meal-btn");U&&U.classList.remove("hidden"),ne&&ne.classList.remove("hidden")}B.appendChild(O)}})),t)A||(B.innerHTML='<p class="text-sm text-gray-500 italic">Aucun plat prévu.</p>');else{const F=document.createElement("button");F.className="btn btn-outline btn-sm w-full mt-2",F.innerHTML=`<i class="fas fa-plus mr-2"></i> Ajouter une ${I.toLowerCase()}`,F.addEventListener("click",()=>{Be(b)}),B.appendChild(F)}T.appendChild(B)}M.appendChild(T)}E.appendChild(M),x.appendChild(E)}),g.appendChild(x),c.appendChild(g)}),e.appendChild(c)}function oe(e,a,t=!1){if(!e)return;const r=a.menuData||{},n=a.servingsData||{},o=a.remarksData||{},l=a.defaultNumPeople||1,s=a.startDay||"Lundi",c=document.createDocumentFragment(),u=["lunch","dinner"],m=5,p=q.indexOf(s);[...q.slice(p),...q.slice(0,p)].forEach(g=>{const y=q.indexOf(g),x=document.createElement("div");x.className="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] items-stretch border-b border-gray-300";const h=document.createElement("div");h.className="font-bold p-2 flex items-center justify-center bg-gray-100 dark:bg-gray-100 text-sm border-r border-gray-300 text-gray-800 dark:text-gray-800",h.textContent=g.toUpperCase(),x.appendChild(h),u.forEach(E=>{const w=`${y}-${E}`,C=n[w]||l,M=n.hasOwnProperty(w),A=document.createElement("div"),$=Y(C,M,I=>{Pe(w,I)},t);let S="border-r border-gray-300 flex items-center justify-center transition-colors duration-300";M?S+=" bg-tomato":S+=E==="lunch"?" bg-amber-50":" bg-stone-100",A.className=S,A.appendChild($),x.appendChild(A);for(let I=0;I<m;I++){const b=`${y}-${E}-${I}`,L=r[b],T=document.createElement("div"),j=le(b);let B="meal-slot p-1 min-h-[70px] flex flex-col justify-start border-r border-gray-300";if(B+=E==="lunch"?" bg-amber-50":" bg-stone-100",T.className=B,T.dataset.slotId=b,j==="Remarque")T.appendChild(Ne(b,o,t));else if(Array.isArray(L)&&L.length>0){const F=document.createElement("div");F.className="w-full",L.forEach((J,W)=>{const O=z.find(U=>U.id===J.id);if(O)F.appendChild(ke(O,b,W,t));else{const U=document.createElement("div");U.className="p-1 bg-red-100 text-red-700 rounded shadow-sm text-center text-xs font-medium",U.textContent="Recette supprimée",F.appendChild(U)}}),T.appendChild(F),t||T.appendChild(De(b,!0))}else t||T.appendChild(De(b,!1));x.appendChild(T)}}),c.appendChild(x)}),e.innerHTML="",e.appendChild(c),t||it()}async function We(){const e=fe();if(!k||!e)return[];try{const a=Le(ae(k,"shopping_lists"),je("userId","==",e));return(await ce(a)).docs.map(o=>({id:o.id,...o.data()})).filter(o=>o.isShared!==!0)}catch(a){return console.error("Erreur de chargement des listes de courses sauvegardées: ",a),[]}}async function Ge(){const e=await We();if(i.importListContainer.innerHTML="",e.length===0){i.importListContainer.innerHTML='<p class="text-center text-gray-500">Aucune liste sauvegardée.</p>';return}e.forEach(a=>{const t=document.createElement("button");t.className="w-full text-left p-2 hover:bg-gray-100 rounded-lg transition-colors duration-150",t.textContent=a.name,t.addEventListener("click",()=>{confirm(`Voulez-vous vraiment importer les ingrédients de la liste "${a.name}" ?`)&&(a.ingredients.forEach(r=>{const n=parseFloat(String(r.quantity).replace(",","."))||0;Z(r.name,n,r.unit)}),he())}),i.importListContainer.appendChild(t)}),i.importListModal.classList.remove("hidden")}function he(){i.importListModal.classList.add("hidden")}function Ke(){i.addItemInput?.addEventListener("input",()=>{const e=i.addItemInput.value.toLowerCase(),a=i.addItemResults;if(a.innerHTML="",!e){a.classList.add("hidden");return}let t=ee.filter(n=>n.name.toLowerCase().includes(e));t.forEach(n=>n.seasonScore=Ee.getIngredientScore(n)),t.sort((n,o)=>o.seasonScore!==n.seasonScore?o.seasonScore-n.seasonScore:n.name.localeCompare(o.name)),t.forEach(n=>{const o=document.createElement("div");o.className="p-2 hover:bg-gray-100 cursor-pointer flex justify-between items-center";const l=document.createElement("span");if(l.textContent=n.name,o.appendChild(l),Ee.config.mode!=="disabled"){if(n.seasonScore===2){const s=document.createElement("span");s.className="text-[10px] bg-green-100 text-green-700 px-1.5 py-0.5 rounded-full border border-green-200 ml-2 whitespace-nowrap",s.textContent="De saison",o.appendChild(s)}else if(n.seasonScore===0){const s=document.createElement("span");s.className="text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded-full border border-gray-200 ml-2 whitespace-nowrap",s.textContent="Hors saison",o.appendChild(s),o.classList.add("opacity-75")}}o.addEventListener("click",()=>{Z(n.name,1,n.unit),i.addItemInput.value="",a.classList.add("hidden")}),a.appendChild(o)});const r=document.createElement("div");r.className="p-2 bg-green-50 hover:bg-green-200 cursor-pointer font-bold text-green-700",r.textContent=`+ Créer "${i.addItemInput.value}"`,r.addEventListener("click",()=>{const n=i.addItemInput.value;At.open(n,async()=>{await Ie();const o=ee.find(s=>s.name===n),l=o?o.unit:"";Z(n,1,l),i.addItemInput.value="",a.classList.add("hidden")})}),a.appendChild(r),a.classList.remove("hidden")}),i.addItemBtn?.addEventListener("click",()=>{const e=i.addItemInput.value;e&&(Z(e,1,""),i.addItemInput.value="",i.addItemResults.classList.add("hidden"))}),document.addEventListener("click",e=>{i.addItemInput&&!i.addItemInput.contains(e.target)&&!i.addItemResults.contains(e.target)&&i.addItemResults.classList.add("hidden")})}function Ye(){if(_.length===0){alert("La liste de courses est vide.");return}const e=_.reduce((n,o)=>{const l=o.category||"Inconnue";return n[l]||(n[l]=[]),n[l].push(o),n},{}),a=Object.keys(e).sort((n,o)=>n==="Inconnue"?1:o==="Inconnue"?-1:n.localeCompare(o));let t=`Liste de courses - GustoPlan

`;a.forEach(n=>{t+=`--- ${n.toUpperCase()} ---
`,e[n].sort((l,s)=>l.name.localeCompare(s.name)).forEach(l=>{let c=`${Number.isInteger(l.totalQuantity)?l.totalQuantity:parseFloat(l.totalQuantity.toFixed(2))} ${l.unit||""} ${l.name}`;if(l.sources&&l.sources.length>0){const u=l.sources.reduce((p,f)=>{const g=f.servings?` - ${f.servings} pers.`:"",y=`${f.recipeName} (${f.day} ${f.time})${g}`;return p[y]||(p[y]=0),p[y]+=f.quantity,p},{}),m=Object.keys(u).join(" / ");c+=` *** ${m} ***`}t+=c+`
`}),t+=`
`});const r=new Blob([t],{type:"text/plain;charset=utf-8"});saveAs(r,"liste-de-courses.txt")}function Xe(){if(_.length===0){alert("La liste de courses est vide.");return}const{jsPDF:e}=window.jspdf,a=new e,t=_.reduce((c,u)=>{const m=u.category||"Inconnue";return c[m]||(c[m]=[]),c[m].push(u),c},{}),r=Object.keys(t).sort((c,u)=>c==="Inconnue"?1:u==="Inconnue"?-1:c.localeCompare(u));a.setFontSize(18),a.text("Liste de courses - GustoPlan",14,22);let n=35;const o=a.internal.pageSize.height,l=20,s=()=>{n>o-l&&(a.addPage(),n=20)};r.forEach(c=>{s(),a.setFontSize(14),a.setFont(void 0,"bold"),a.text(`--- ${c.toUpperCase()} ---`,14,n),n+=8,a.setFont(void 0,"normal"),t[c].sort((m,p)=>m.name.localeCompare(p.name)).forEach(m=>{s(),a.setFontSize(12);const p=Number.isInteger(m.totalQuantity)?m.totalQuantity:parseFloat(m.totalQuantity.toFixed(2));if(a.text(`${p} ${m.unit||""} ${m.name}`,14,n),n+=6,m.sources&&m.sources.length>0){const f=m.sources.reduce((g,y)=>{const x=y.servings?` - ${y.servings} pers.`:"",h=`${y.recipeName} (${y.day} ${y.time})${x}`;return g[h]||(g[h]=0),g[h]+=y.quantity,g},{});a.setFontSize(9),a.setTextColor(100);for(const g in f)s(),a.text(`  * ${g}`,18,n),n+=5;a.setTextColor(0)}n+=2}),n+=5}),a.save("liste-de-courses.pdf")}async function Ze(){if(!d){alert("Veuillez sélectionner un menu à exporter.");return}const e=document.getElementById("loading-overlay");e&&e.classList.remove("hidden");try{const{jsPDF:a}=window.jspdf,t=new a,r=Q(k,"plans",d.id),n=await Fe(r),o=n.exists()?n.data():null;if(!o||!o.weeks){alert("Ce menu est vide et ne peut pas être exporté.");return}t.setFontSize(18),t.text(`Menu de Repas : ${o.name}`,14,20);const l=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"],s={0:"E",1:"P",2:"A",3:"D"},c=Object.keys(o.weeks).sort((m,p)=>parseInt(m)-parseInt(p));let u=!0;for(const m of c){const f=o.weeks[m].menuData||{};if(Object.keys(f).length===0)continue;const g=[["Jour","Midi","Soir"]],y=[],x=l.indexOf(o.startDay||"Lundi"),h=[...l.slice(x),...l.slice(0,x)];for(const w of h){const C=l.indexOf(w);let M=[],A=[];for(const $ of["lunch","dinner"])for(const S in s){const I=`${C}-${$}-${S}`;f[I]&&Array.isArray(f[I])&&f[I].forEach(b=>{const L=`[${s[S]}] ${b.name}`;$==="lunch"?M.push(L):A.push(L)})}y.push([w,M.join(`
`)||"-",A.join(`
`)||"-"])}t.setFontSize(14);const E=u?30:t.autoTable.previous.finalY+20;t.text(`Semaine ${m}`,14,E-5),t.autoTable({startY:E,head:g,body:y,theme:"grid",styles:{cellPadding:2,fontSize:8,valign:"middle"},headStyles:{fillColor:[41,128,185],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[245,245,245]}}),u=!1}t.save(`menu_${o.name.replace(/ /g,"_")}.pdf`)}catch(a){console.error("Erreur lors de la génération du PDF du plan :",a),alert("Une erreur est survenue lors de la création du PDF.")}finally{e&&e.classList.add("hidden")}}async function Z(e,a,t,r=!1){if(!d)return alert("Veuillez sélectionner un menu.");const n=Q(k,"plans",d.id);try{await Oe(k,async o=>{const l=await o.get(n);if(!l.exists())throw"Le menu n'existe plus.";const s=l.data().manualItems||[],c=`${e.trim().toLowerCase()}_${t||""}`,u=s.findIndex(p=>`${p.name.trim().toLowerCase()}_${p.unit||""}`===c);if(u>-1)s[u].totalQuantity+=a;else{const p=ee.find(f=>f.name.toLowerCase()===e.trim().toLowerCase());s.push({name:e.trim(),totalQuantity:a,unit:t,source:"manual",category:p?.category||"Inconnue"})}const m=s.filter(p=>p.totalQuantity!==0);o.update(n,{manualItems:m,lastUpdated:new Date})})}catch(o){console.error("Erreur transactionnelle lors de l'ajustement de l'ingrédient: ",o),alert("Une erreur de synchronisation est survenue. Veuillez réessayer.")}}function Se(e){const a=e?e.toLowerCase():"";return a.includes("g")||a.includes("ml")?10:1}function et(e){if(i.openTrashBtn&&(i.openTrashBtn.classList.remove("hidden"),i.trashCount&&(i.trashCount.textContent=e.length,e.length>0?(i.trashCount.classList.remove("bg-gray-200"),i.trashCount.classList.add("bg-red-500","text-white")):(i.trashCount.classList.add("bg-gray-200"),i.trashCount.classList.remove("bg-red-500","text-white")))),e&&e.length>0){if(i.emptyTrashBtn){i.emptyTrashBtn.classList.remove("hidden");const a=i.emptyTrashBtn.cloneNode(!0);i.emptyTrashBtn.parentNode.replaceChild(a,i.emptyTrashBtn),i.emptyTrashBtn=a,i.emptyTrashBtn.addEventListener("click",async()=>{if(!d||!confirm("Voulez-vous supprimer définitivement tous les éléments de la corbeille ?"))return;const t=Q(k,"plans",d.id),r=e.map(n=>`${n.name}_${n.unit||""}`);try{await He(()=>import("./main-DOZ5ZINl.js").then(n=>n.l),__vite__mapDeps([0,1,2])).then(n=>{n.updateDoc(t,{hiddenTrashItems:n.arrayUnion(...r),lastUpdated:new Date})}),i.trashModal.classList.add("hidden")}catch(n){console.error("Erreur vidage corbeille:",n)}})}if(i.trashListContainer){i.trashListContainer.innerHTML="";const a=document.createElement("ul");a.className="space-y-2",e.forEach(t=>{const r=document.createElement("li");r.className="p-2 rounded bg-gray-100 flex justify-between items-center group";const n=document.createElement("span");n.className="text-sm text-gray-500 line-through",n.textContent=t.name,r.appendChild(n);const o=document.createElement("div");o.className="flex items-center space-x-2";const l=document.createElement("button");l.className="btn btn-xs btn-outline text-blue-600 hover:bg-blue-50 border-blue-300",l.innerHTML='<i class="fas fa-undo mr-1"></i> Restaurer',l.addEventListener("click",async()=>{if(!d)return;const c=Q(k,"plans",d.id);try{await Oe(k,async u=>{const m=await u.get(c);if(!m.exists())return;const f=(m.data().manualItems||[]).filter(g=>!(g.name.toLowerCase()===t.name.toLowerCase()&&g.unit===t.unit));u.update(c,{manualItems:f,lastUpdated:new Date})}),e.length<=1&&i.trashModal.classList.add("hidden")}catch(u){console.error("Erreur lors de la restauration :",u)}});const s=document.createElement("button");s.className="text-gray-400 hover:text-red-600 text-xs p-1 rounded-md",s.title="Supprimer définitivement",s.innerHTML='<i class="fas fa-times"></i>',s.addEventListener("click",async()=>{if(!d)return;const c=Q(k,"plans",d.id),u=`${t.name}_${t.unit||""}`;try{await He(()=>import("./main-DOZ5ZINl.js").then(m=>m.l),__vite__mapDeps([0,1,2])).then(m=>{m.updateDoc(c,{hiddenTrashItems:m.arrayUnion(u),lastUpdated:new Date})}),e.length<=1&&i.trashModal.classList.add("hidden")}catch(m){console.error("Erreur suppression définitive:",m)}}),o.appendChild(l),o.appendChild(s),r.appendChild(o),a.appendChild(r)}),i.trashListContainer.appendChild(a)}}else i.trashListContainer&&(i.trashListContainer.innerHTML='<p class="text-center text-gray-500 italic py-4">La corbeille est vide.</p>'),i.emptyTrashBtn&&i.emptyTrashBtn.classList.add("hidden")}function Me(e=[]){et(e);const a=i.shoppingListContainer;if(!a)return;if(a.innerHTML="",_.length===0&&e.length===0){a.innerHTML='<p class="text-center text-gray-500 italic py-4">Votre liste de courses est vide.</p>';return}const t=d?d.checkedItems||{}:{},r=_.reduce((o,l)=>{const s=l.category||"Inconnue";return o[s]||(o[s]=[]),o[s].push(l),o},{});Object.keys(r).sort((o,l)=>o==="Inconnue"?1:l==="Inconnue"?-1:o.localeCompare(l)).forEach(o=>{const l=document.createElement("h4");l.className="text-sm font-bold text-stone-800 bg-stone-200 mt-4 mb-2 px-3 py-1 rounded-md",l.textContent=o,a.appendChild(l);const s=document.createElement("ul");s.className="space-y-2",r[o].sort((u,m)=>u.name.localeCompare(m.name)).forEach(u=>{const m=`${u.name}_${u.unit||""}`,p=Ue(m),f=t.hasOwnProperty(p)?t[p]:t[m]||!1,g=document.createElement("li");let y="p-2 rounded";u.hasManualEntry===!0||u.source==="manual"?(g.style.backgroundColor="#ffedd5",y+=" bg-orange-100"):y+=" bg-gray-50",g.className=y;const h=document.createElement("div");h.className="flex justify-between items-center";const E=document.createElement("div");if(E.className="flex-grow flex items-center",f){const L=document.createElement("i");L.className="fas fa-check mr-2 bg-green-500 text-white rounded-full p-1 flex items-center justify-center w-5 h-5",E.appendChild(L)}const w=document.createElement("span");w.className="text-sm font-medium transition-all duration-200",f&&w.classList.add("line-through","text-gray-400"),w.textContent=u.name,E.appendChild(w),h.appendChild(E);const C=document.createElement("div");C.className="flex items-center space-x-2 mx-2";const M=document.createElement("span");M.className="font-medium w-20 text-center text-sm",f&&M.classList.add("text-gray-400");const A=Number.isInteger(u.totalQuantity)?u.totalQuantity:parseFloat(u.totalQuantity.toFixed(2));M.textContent=`${A} ${u.unit||""}`.trim();const $=document.createElement("div");$.className="flex flex-col";const S=document.createElement("button");S.className="btn btn-outline btn-xs rounded-b-none",S.textContent="+",S.addEventListener("click",async()=>{const L=Se(u.unit);await Z(u.name,L,u.unit)});const I=document.createElement("button");I.className="btn btn-outline btn-xs rounded-t-none -mt-px",I.textContent="-",I.addEventListener("click",async()=>{const L=Se(u.unit);await Z(u.name,-L,u.unit)}),$.appendChild(S),$.appendChild(I),C.appendChild(M),C.appendChild($),h.appendChild(C);const b=document.createElement("button");if(b.className="delete-item-btn text-red-500 hover:text-red-700",b.innerHTML='<i class="fas fa-trash-alt"></i>',b.addEventListener("click",()=>{Z(u.name,-u.totalQuantity,u.unit,!0)}),h.appendChild(b),g.appendChild(h),u.sources&&u.sources.length>0){const L=document.createElement("div");L.className="p-2 mt-1 ml-4 rounded-md bg-stone-100";const T=u.sources.reduce((j,B)=>{const F=B.servings?` - ${B.servings} pers.`:"",J=`${B.recipeName} (${B.day} ${B.time})${F}`;return j[J]||(j[J]=0),j[J]+=B.quantity,j},{});for(const j in T){const B=document.createElement("span");B.className="block text-xs text-gray-500",B.textContent=`↳ ${j}`,L.appendChild(B)}g.appendChild(L)}s.appendChild(g)}),a.appendChild(s)})}async function ie(){if(!d){_.length=0,Me();return}const e=d.manualItems?JSON.parse(JSON.stringify(d.manualItems)):[],a=new Map(e.map(s=>{const c=`${s.name.trim().toLowerCase()}_${s.unit||""}`;return s.hasManualEntry=!0,[c,s]})),t=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];if(d.weeks)for(const s in d.weeks){const c=d.weeks[s],u=c.menuData||{},m=c.servingsData||{};for(const p in u){const f=u[p];if(!Array.isArray(f))continue;const[g,y]=p.split("-"),x=parseInt(g,10),h=t[x]||"Jour inconnu",E=y==="lunch"?"midi":"soir",w=`${x}-${y}`,C=parseInt(m[w]||d.defaultNumPeople,10);for(const M of f){const $=z.find(I=>I.id===M.id)||M;if(!$||!Array.isArray($.ingredients))continue;const S=$.servings||1;S<=0||$.ingredients.forEach(I=>{const{name:b,quantity:L,unit:T}=I;if(!b||!L)return;const j=ee.find(G=>G.name.toLowerCase()===b.trim().toLowerCase()),B=j?j.category:"Inconnue",F=parseFloat(String(L).replace(",","."));if(isNaN(F))return;const W=F/S*C,O=T||"",U=`${b.trim().toLowerCase()}_${O}`,ne={recipeName:$.name,day:`${h} (S${s})`,time:E,quantity:W,servings:C};if(a.has(U)){const G=a.get(U);G.totalQuantity+=W,G.source==="manual"&&(G.source="mixed"),Array.isArray(G.sources)?G.sources.push(ne):G.sources=[ne]}else a.set(U,{name:b.trim(),totalQuantity:W,unit:O,source:"plan",category:B,sources:[ne]})})}}}const r=Array.from(a.values()),n=d.hiddenTrashItems||[],o=r.filter(s=>s.totalQuantity>0).sort((s,c)=>s.name.localeCompare(c.name)),l=r.filter(s=>{const c=`${s.name}_${s.unit||""}`;return s.totalQuantity<=0&&s.sources&&s.sources.length>0&&!n.includes(c)}).sort((s,c)=>s.name.localeCompare(c.name));_.length=0,_.push(...o),Me(l)}function Be(e){const a=le(e);if(!a||!i.mealSelectModal)return;i.mealSelectModalTitle.textContent=`Sélectionner : ${a}`,i.mealSelectList.innerHTML="";const t=document.createElement("input");t.type="text",t.placeholder="Rechercher dans la catégorie...",t.className="w-full p-2 mb-4 border border-gray-300 rounded-lg",i.mealSelectList.appendChild(t);const r=ue(a),n=z.filter(s=>ue(s.category)===r).sort((s,c)=>{const u=s.isFavorite?1:0,m=c.isFavorite?1:0;return m!==u?m-u:s.name.localeCompare(c.name)}),o=document.createElement("div");o.className="space-y-1 max-h-80 overflow-y-auto",i.mealSelectList.appendChild(o);function l(s=""){o.innerHTML="";const c=s.toLowerCase(),u=n.filter(m=>m.name.toLowerCase().includes(c));u.length===0?o.innerHTML='<p class="text-gray-500 p-4">Aucun plat ne correspond à votre recherche.</p>':u.forEach(m=>{const p=document.createElement("button");p.className="w-full text-left p-2 hover:bg-gray-100 rounded-lg transition-colors duration-150";const f=document.createElement("p");f.className="font-medium text-gray-800 text-sm",m.isFavorite?f.innerHTML=`${m.name} <i class="fas fa-heart text-red-500 ml-2"></i>`:f.textContent=m.name,p.appendChild(f),p.addEventListener("click",()=>{lt(e,m),pe()}),o.appendChild(p)})}t.addEventListener("input",s=>l(s.target.value)),l(),i.mealSelectModal.classList.remove("hidden"),t.focus()}function pe(){i.mealSelectModal&&i.mealSelectModal.classList.add("hidden")}function tt(e){X=e.target.closest(".meal-card");const a=X.closest(".meal-slot").dataset.slotId;e.dataTransfer.setData("text/plain",a),setTimeout(()=>{X&&(X.style.opacity="0.5")},0)}function nt(){X&&(X.style.opacity="1",X=null)}function at(e){e.preventDefault();const a=e.target.closest(".meal-slot");a&&le(a.dataset.slotId)!=="Remarque"&&a.classList.add("bg-gray-200")}function st(e){const a=e.target.closest(".meal-slot");a&&a.classList.remove("bg-gray-200")}async function rt(e){e.preventDefault();const a=e.dataTransfer.getData("text/plain"),t=e.target.closest(".meal-slot");if(t){t.classList.remove("bg-gray-200");const r=t.dataset.slotId,n=le(r);if(n==="Remarque")return;if(a&&r&&a!==r){const o=v[a],l=le(a);if(ue(l)!==ue(n)){alert(`Action impossible : un(e) "${l}" ne peut pas aller dans la catégorie "${n}".`);return}const s=v[r];v[r]=o,s?v[a]=s:delete v[a],oe(i.mealPlanGrid,{menuData:v,servingsData:H,remarksData:P,defaultNumPeople:R,startDay:N},!1),await V({[`weeks.${D}.menuData`]:v},"a déplacé un plat"),await ie()}}}function le(e){switch(e.split("-")[2]){case"0":return"Entrée";case"1":return"Plat";case"2":return"Accompagnement";case"3":return"Dessert";case"4":return"Remarque";default:return""}}function ke(e,a,t,r=!1){const n=document.createElement("div");if(n.className="meal-card p-1 flex flex-col items-center bg-white rounded shadow-sm text-center relative w-full mb-1",r||(n.classList.add("cursor-grab"),n.draggable=!0),!r){const c=document.createElement("button");c.className="absolute -top-2 -right-1 text-base",c.innerHTML='<i class="fas fa-heart"></i>',e.isFavorite?c.classList.add("text-red-500"):c.classList.add("text-gray-300","hover:text-red-400"),c.addEventListener("click",u=>{u.stopPropagation(),Pt(e.id,e.isFavorite)}),c.addEventListener("mousedown",u=>u.stopPropagation()),n.appendChild(c)}const o=document.createElement("span");if(o.className="text-xs font-medium p-1 break-words w-full text-gray-800 dark:text-gray-800",o.textContent=e.name,n.appendChild(o),!r){const c=document.createElement("div");c.className="absolute top-0 left-0 flex";const u=document.createElement("button");u.className="edit-meal-btn text-gray-600 hover:text-gray-800 hidden px-1 py-0.5",u.innerHTML='<i class="fas fa-pencil-alt fa-xs"></i>',u.title="Modifier la recette",u.addEventListener("click",p=>{p.stopPropagation();const f=z.find(g=>g.id===e.id);de.openForm(f||e,"Modifier la recette")}),u.addEventListener("mousedown",p=>p.stopPropagation()),c.appendChild(u);const m=document.createElement("button");m.className="delete-meal-btn text-red-700 hover:text-red-900 hidden px-1 py-0.5",m.innerHTML='<i class="fas fa-times-circle fa-xs"></i>',m.title="Retirer du menu",m.addEventListener("click",p=>{p.stopPropagation(),ct(a,t)}),m.addEventListener("mousedown",p=>p.stopPropagation()),c.appendChild(m),n.appendChild(c),n.addEventListener("mouseenter",()=>{u.classList.remove("hidden"),m.classList.remove("hidden")}),n.addEventListener("mouseleave",()=>{u.classList.add("hidden"),m.classList.add("hidden")})}const l=document.createElement("div");l.className="absolute bottom-1 right-1";const s=document.createElement("button");return s.className="info-meal-btn bg-gray-500 text-white hover:bg-gray-600 rounded w-3 h-3 flex items-center justify-center shadow-sm",s.innerHTML='<i class="fas fa-plus fa-xs"></i>',s.title="Plus d'infos",s.dataset.slotId=a,s.dataset.mealIndex=t,s.addEventListener("mousedown",c=>c.stopPropagation()),l.appendChild(s),n.appendChild(l),n}function ot(e,a){if(document.querySelectorAll(".planner-ingredient-tooltip").forEach(l=>l.remove()),te===e){e.classList.remove("info-open"),e.innerHTML='<i class="fas fa-plus fa-xs"></i>',te=null;return}te&&(te.classList.remove("info-open"),te.innerHTML='<i class="fas fa-plus fa-xs"></i>'),e.classList.add("info-open"),e.innerHTML='<i class="fas fa-times fa-xs"></i>',te=e;const t=document.createElement("div");if(t.className="planner-ingredient-tooltip z-50 w-64 p-3 bg-white border border-gray-200 rounded-lg shadow-lg text-left text-sm",a.ingredients&&a.ingredients.length>0){if(a.servings&&a.servings>0){const c=document.createElement("p");c.className="mb-2 text-sm text-gray-600 flex items-center",c.innerHTML=`<i class="fas fa-users mr-2"></i> Pour ${a.servings} ${a.servings>1?"personnes":"personne"}`,t.appendChild(c)}const l=document.createElement("h4");l.className="font-bold mb-2 text-gray-800",l.textContent="Ingrédients :",t.appendChild(l);const s=document.createElement("ul");s.className="space-y-1 text-gray-600",a.ingredients.forEach(c=>{const u=document.createElement("li");u.textContent=`• ${c.quantity||""} ${c.unit||""} ${c.name}`.trim(),s.appendChild(u)}),t.appendChild(s)}else t.textContent="Aucun ingrédient spécifié pour cette recette.";document.body.appendChild(t);const r=e.closest(".meal-card").getBoundingClientRect(),n=t.getBoundingClientRect();if(window.innerWidth<768){t.style.width="90vw",t.style.maxWidth="320px";const l=t.getBoundingClientRect();let s=r.bottom+10,c=(window.innerWidth-l.width)/2;s+l.height>window.innerHeight&&(s=r.top-l.height-10),t.style.top=`${s}px`,t.style.left=`${c}px`}else{let l=r.right+10;l+n.width>window.innerWidth&&(l=r.left-n.width-10);let s=r.top;s+n.height>window.innerHeight&&(s=r.bottom-n.height),s<10&&(s=10),t.style.left=`${l}px`,t.style.top=`${s}px`}t.style.position="fixed"}function De(e,a=!1){const t=document.createElement("div"),r=document.createElement("button");return a?(t.className="w-full flex justify-center pt-1",r.className="add-more-meal-btn text-gray-400 hover:text-green-500 transition-colors duration-150",r.innerHTML='<i class="fas fa-plus-circle"></i>',r.title="Ajouter une autre recette"):(t.className="flex items-center justify-center h-full",r.className="add-meal-btn text-green-500 hover:text-green-700 transition-transform duration-150 hover:scale-125",r.innerHTML='<i class="fas fa-plus-circle text-lg"></i>'),r.addEventListener("click",()=>Be(e)),t.appendChild(r),t}function Ne(e,a,t=!1){if(t){const n=document.createElement("p");return n.className="w-full h-full p-1 text-xs text-gray-700",n.textContent=a[e]||"",n}const r=document.createElement("textarea");return r.className="w-full h-full p-1 text-xs bg-white border-0 rounded focus:outline-none focus:ring-1 focus:ring-tomato resize-none",r.placeholder="Remarque...",r.value=P[e]||"",r.dataset.slotId=e,r.addEventListener("change",n=>{const o=n.target.value;o?P[e]=o:delete P[e];const[l,s]=e.split("-"),m=`a modifié la remarque pour ${q[parseInt(l,10)]} ${s==="lunch"?"midi":"soir"}`;V({[`weeks.${D}.remarksData`]:P},m)}),r.addEventListener("focus",n=>{Ce({type:"editing_remark",fieldId:e})}),r.addEventListener("blur",n=>{Ce("idle")}),r}function it(){document.querySelectorAll(".meal-card").forEach(e=>{e.addEventListener("dragstart",tt),e.addEventListener("dragend",nt)}),document.querySelectorAll(".meal-slot").forEach(e=>{e.addEventListener("dragover",at),e.addEventListener("dragleave",st),e.addEventListener("drop",rt)})}async function lt(e,a){const t=JSON.parse(JSON.stringify(v)),r=t[e],n={id:a.id};Array.isArray(r)?r.push(n):t[e]=[n];const[o,l]=e.split("-"),s=q[parseInt(o,10)],c=l==="lunch"?"midi":"soir",u=`a ajouté '${a.name}' à ${s} ${c}`;await V({[`weeks.${D}.menuData`]:t},u),pe()}async function ct(e,a){if(!d||!v[e]||!Array.isArray(v[e]))return;const t=v[e][a],r=JSON.parse(JSON.stringify(v));r[e].splice(a,1),r[e].length===0&&delete r[e];const[n,o]=e.split("-"),l=q[parseInt(n,10)],s=o==="lunch"?"midi":"soir",c=`a supprimé '${t.name}' de ${l} ${s}`;await V({[`weeks.${D}.menuData`]:r},c)}function $e(e){e>=1&&e<=52&&(D=e,we())}function dt(){i.currentWeekDisplay&&(i.currentWeekDisplay.textContent=`Semaine ${D}`)}function ut(){i.prevWeekBtn?.addEventListener("click",()=>$e(D-1)),i.nextWeekBtn?.addEventListener("click",()=>$e(D+1)),i.clearMenuBtn?.addEventListener("click",Je),i.startDaySelect?.addEventListener("change",async t=>{N=t.target.value,d&&await V({startDay:N},`a changé le premier jour de la semaine à '${N}'`)}),i.planSelect?.addEventListener("change",xe),i.closeMealSelectModalBtn?.addEventListener("click",pe),i.mealSelectModal?.addEventListener("click",t=>{t.target===i.mealSelectModal&&pe()}),i.closeRecipeModalBtn?.addEventListener("click",()=>de.closeForm()),i.cancelRecipeBtn?.addEventListener("click",()=>de.closeForm()),i.importListBtn?.addEventListener("click",Ge),i.closeImportListModalBtn?.addEventListener("click",he),i.importListModal?.addEventListener("click",t=>{t.target===i.importListModal&&he()}),i.exportTxtBtn?.addEventListener("click",Ye),i.exportPdfBtn?.addEventListener("click",Xe),i.exportPlanPdfBtn?.addEventListener("click",Ze);const e=t=>{const r=t.target.closest(".info-meal-btn");if(r){const n=r.dataset.slotId,o=parseInt(r.dataset.mealIndex,10);if(n&&!isNaN(o)){const l=v[n]?.[o];if(l&&l.id){const s=z.find(c=>c.id===l.id);s&&ot(r,s)}}}};i.mealPlanGrid?.addEventListener("click",e),document.getElementById("mobile-meal-plan")?.addEventListener("click",e),i.sharePlanBtn?.addEventListener("click",()=>{if(!d){alert("Veuillez sélectionner un menu à partager.");return}Tt({plan:d})}),i.inviteParticipantBtn?.addEventListener("click",()=>{if(!d){alert("Veuillez sélectionner un menu pour inviter des participants.");return}Ht(d)}),i.historyPlanBtn?.addEventListener("click",Ve),i.closePlanHistoryModalBtn?.addEventListener("click",ye),i.smartPlanBtn?.addEventListener("click",Qe),i.archivePlanBtn?.addEventListener("click",async()=>{const t=d&&d.isOwner?"Voulez-vous archiver ce menu ? Il sera masqué pour vous mais restera accessible par Chef Gusto pour ses recommandations.":"Voulez-vous masquer ce menu collaboratif de votre liste ? Il restera accessible aux autres membres et Chef Gusto pourra toujours s'y référer.";d&&confirm(t)&&(await xt(d.id,!0),alert("Menu masqué/archivé avec succès."))}),i.planHistoryModal?.addEventListener("click",t=>{t.target===i.planHistoryModal&&ye()}),i.openTrashBtn?.addEventListener("click",()=>{i.trashModal.classList.remove("hidden")}),i.closeTrashModalBtn?.addEventListener("click",()=>{i.trashModal.classList.add("hidden")}),i.trashModal?.addEventListener("click",t=>{t.target===i.trashModal&&i.trashModal.classList.add("hidden")}),i.savePlanBtn?.addEventListener("click",async()=>{if(!d){alert("Veuillez sélectionner un menu de travail avant de sauvegarder.");return}const t=document.getElementById("save-plan-as-modal"),r=document.getElementById("save-plan-as-form"),n=document.getElementById("save-plan-name"),o=document.getElementById("cancel-save-plan-as-btn"),l=document.getElementById("close-save-plan-as-modal"),s=new Date().toLocaleDateString("fr-FR"),c=d.weeks?Object.keys(d.weeks).filter(f=>d.weeks[f]&&Object.keys(d.weeks[f].menuData||{}).length>0).length:0,u=c>1?`${c} semaines`:`${c} semaine`;n.value=`${d.name} (${u}) - ${s}`,t.classList.remove("hidden");const m=async f=>{f.preventDefault();const g=n.value;if(!g)return;d.weeks||(d.weeks={}),d.weeks[D]={menuData:v,servingsData:H,remarksData:P},d.startDay=N,d.defaultNumPeople=R;const y=JSON.parse(JSON.stringify(d));if(y.weeks)for(const x in y.weeks){const h=y.weeks[x];if(h&&h.menuData)for(const E in h.menuData){const w=h.menuData[E];Array.isArray(w)&&(h.menuData[E]=w.map(C=>C&&C.id&&z.find(A=>A.id===C.id)||C))}}await Et(g,y),t.classList.add("hidden"),r.removeEventListener("submit",m)},p=()=>{t.classList.add("hidden"),r.removeEventListener("submit",m)};r.addEventListener("submit",m,{once:!0}),o.addEventListener("click",p,{once:!0}),l.addEventListener("click",p,{once:!0})})}function mt(e=""){return e.split(" ").map(r=>r[0]).join("").substring(0,2).toUpperCase()}function ve(e=[],a={}){const t=document.getElementById("collaborators-bar"),r=document.getElementById("activity-labels-container"),n=document.getElementById("name-tooltip");if(!t||!n||!r)return;if(t.innerHTML="",r.innerHTML="",document.querySelectorAll(".remark-lock-overlay").forEach(s=>s.remove()),document.querySelectorAll("textarea[data-slot-id]").forEach(s=>{s.disabled=!1}),e.length<=1&&Object.keys(a).length<=1){t.classList.add("hidden");return}let o="";const l=fe();e.forEach(s=>{if(!s)return;const c=a.hasOwnProperty(s.uid),u=a[s.uid]||{},m=document.createElement("div");m.className="w-8 h-8 rounded-full flex items-center justify-center bg-gray-300 text-white font-bold text-xs ring-2 ring-white cursor-pointer transition-all duration-300";const p=c?"(présent)":"(absent)";if(m.dataset.name=`${s.displayName||"Inconnu"} ${p}`,s.photoURL?m.innerHTML=`<img src="${s.photoURL}" alt="${s.displayName}" class="w-full h-full rounded-full object-cover">`:m.textContent=mt(s.displayName),c||m.classList.add("grayscale","opacity-50"),m.addEventListener("mouseenter",f=>{n.textContent=f.currentTarget.dataset.name,n.classList.remove("hidden");const g=f.currentTarget.getBoundingClientRect();n.style.left=`${g.left+g.width/2-n.offsetWidth/2}px`,n.style.top=`${g.top-n.offsetHeight-5}px`}),m.addEventListener("mouseleave",()=>{n.classList.add("hidden")}),t.appendChild(m),c&&s.uid!==l){const f=u.status;if(typeof f=="object"&&f.type==="editing_remark"){const g=document.querySelector(`textarea[data-slot-id="${f.fieldId}"]`);if(g){g.disabled=!0;const y=document.createElement("div");y.className="remark-lock-overlay absolute inset-0 bg-gray-400 bg-opacity-25 flex items-center justify-center text-xs text-white font-bold",y.innerHTML=`<i class="fas fa-lock mr-1"></i> ${s.displayName} écrit...`,g.parentElement&&(g.parentElement.classList.add("relative"),g.parentElement.appendChild(y))}}else if(typeof f=="string"&&f!=="idle"){let g="";switch(f){case"editing_recipe":g="modifie une recette...";break}g&&(o+=`<span class="italic mr-4">${s.displayName} ${g}</span>`)}}}),r.innerHTML=o,t.classList.remove("hidden")}function xe(){Rt();const e=i.planSelect.value;e&&localStorage.setItem("lastActivePlanId",e),d=ge.find(s=>s.id===e)||null;const a=document.getElementById("delete-plan-btn"),t=document.getElementById("rename-plan-btn"),r=document.getElementById("leave-plan-btn"),n=document.getElementById("invite-participant-btn"),o=document.getElementById("history-plan-btn"),l=document.getElementById("archive-plan-btn");if(a&&(a.style.display=d&&d.isOwner?"inline-flex":"none"),t&&(t.style.display=d&&d.isOwner?"inline-flex":"none"),o&&(o.style.display=d&&d.isOwner?"inline-flex":"none"),l&&(l.style.display=d?"inline-flex":"none"),r&&(r.style.display=d&&!d.isOwner?"inline-flex":"none"),n){const s=d&&(d.type==="collaborative"||d.collaborators&&d.collaborators.length>0);n.style.display=d&&d.isOwner&&s?"inline-flex":"none"}d&&d.participants&&d.participants.length>1?(ve(d.participants,{}),Ft(d.id,s=>{ve(d.participants,s)})):ve([],{}),d&&(d.manualItems=d.manualItems||[]),we()}async function Pe(e,a){if(!d)return;const t=JSON.parse(JSON.stringify(H));a===R?delete t[e]:t[e]=a;const[r,n]=e.split("-"),s=`a changé le nombre de personnes pour ${q[parseInt(r,10)]} ${n==="lunch"?"midi":"soir"} à ${a}`;await V({[`weeks.${D}.servingsData`]:t},s)}async function pt(){if(!k)return;const e=yt();ut(),Ke(),await Ie();const a=Mt(ae(k,"recipes"),r=>{if(console.log("Recipe data updated from listener."),z=r.docs.map(n=>{const o=n.data();return{id:n.id,...o,imageUrl:o.imageUrl||""}}),d){for(const n in v){const o=v[n];if(Array.isArray(o)){const l=o.map(s=>{if(s&&s.id){const c=z.find(u=>u.id===s.id);return c?{...c}:s}return s});v[n]=l}}oe(i.mealPlanGrid,{menuData:v,servingsData:H,remarksData:P,defaultNumPeople:R,startDay:N},!1),me(document.getElementById("mobile-meal-plan"),{menuData:v,servingsData:H,remarksData:P,defaultNumPeople:R,startDay:N},!1),ie()}}),t=ht(r=>{ge=r,bt(r);const n=localStorage.getItem("selectedPlanId"),o=localStorage.getItem("lastActivePlanId");n&&r.some(l=>l.id===n)?(i.planSelect.value=n,localStorage.removeItem("selectedPlanId")):o&&r.some(l=>l.id===o)&&(i.planSelect.value=o),xe()});return()=>{t(),a(),e()}}const ft=pt();return async()=>{const e=await ft;typeof e=="function"&&e()}}export{zt as default};
