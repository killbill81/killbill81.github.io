import{d as c,g as S,c as g,b as O,f as P,a as L,q as Q,w as k,s as ne,u as ae}from"./firebase-config-CDPbqvnt.js";import{g as H}from"./main-BGm1g1S0.js";import{o as se}from"./sharing-DASuy-ML.js";function le(){const V=document.getElementById("search-bar"),b=document.getElementById("lists-container"),G=document.getElementById("add-list-btn"),x=document.getElementById("shared-lists-container"),D=document.getElementById("list-form-modal"),$=document.getElementById("list-modal-title"),J=document.getElementById("close-list-modal"),K=document.getElementById("cancel-list-btn"),_=document.getElementById("list-form"),C=document.getElementById("list-id"),R=document.getElementById("list-name"),U=document.getElementById("ingredients-list"),W=document.getElementById("add-ingredient-btn"),f=document.getElementById("save-list-btn");let w=[],I="",B=[],u=[];async function A(){await N(),await M(),await j()}async function N(){if(c)try{B=(await S(g(c,"ingredients"))).docs.map(e=>({id:e.id,...e.data()})),B.sort((e,n)=>e.name.localeCompare(n.name))}catch(t){console.error("Erreur lors de la récupération de la liste des ingrédients: ",t)}}async function M(){const t=H();if(!(!c||!t))try{const e=Q(g(c,"shopping_lists"),k("userId","==",t));w=(await S(e)).docs.map(a=>({id:a.id,...a.data()})).filter(a=>a.isShared!==!0),F()}catch(e){console.error("Erreur de chargement des listes: ",e)}}async function j(){const t=H();if(!(!c||!t)){console.log(`Recherche de listes partagées pour userId: ${t}`);try{const e=Q(g(c,"shopping_lists"),k("userId","==",t),k("isShared","==",!0)),n=await S(e);console.log(`Trouvé ${n.size} liste(s) partagée(s).`);const a=n.docs.map(i=>({id:i.id,...i.data()}));Y(a)}catch(e){console.error("Erreur de chargement des listes partagées: ",e)}}}async function z(t=null){await N(),_.reset(),U.innerHTML="",u=[],t?($.textContent="Modifier la liste",C.value=t.id,R.value=t.name,t.ingredients&&t.ingredients.length>0?t.ingredients.forEach(e=>v(e)):v()):($.textContent="Créer une liste",C.value="",v()),D.classList.remove("hidden")}function T(){D.classList.add("hidden")}async function X(t){t.preventDefault(),f.disabled=!0;const e=H();if(!e){alert("Erreur : utilisateur non connecté."),f.disabled=!1;return}const n=u.filter(s=>s&&s.name&&s.quantity),a={name:R.value,ingredients:n,userId:e};if(!a.name){alert("Le nom de la liste est requis."),f.disabled=!1;return}const i=C.value;try{i?await ne(L(c,"shopping_lists",i),a):await O(g(c,"shopping_lists"),a),T(),await M()}catch(s){console.error("Erreur de sauvegarde de la liste: ",s)}finally{f.disabled=!1}}function v(t={quantity:"",name:"",unit:""}){const e=document.createElement("div");e.className="relative flex items-stretch space-x-2 ingredient-row";const n={...t};u.push(n);const a=u.length-1,i=document.createElement("input");i.type="text",i.className="ingredient-quantity mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm",i.placeholder="Qté",i.value=n.quantity,i.addEventListener("change",p=>{u[a].quantity=p.target.value});const s=document.createElement("input");s.type="text",s.className="ingredient-unit mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm bg-gray-100",s.placeholder="Unité",s.readOnly=!0,s.value=n.unit||"";const l=document.createElement("div");l.className="relative w-1/2";const r=document.createElement("input");r.type="text",r.className="ingredient-name mt-1 block w-full rounded-md border-gray-300 shadow-sm",r.placeholder="Chercher un ingrédient...",r.value=n.name,l.appendChild(r);const d=document.createElement("div");d.className="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto",l.appendChild(d),r.addEventListener("input",()=>{const p=r.value.toLowerCase();if(!p){d.classList.add("hidden");return}const y=B.filter(m=>m.name.toLowerCase().includes(p));d.innerHTML="",y.forEach(m=>{const h=document.createElement("div");h.className="p-2 ingredient-search-item cursor-pointer",h.textContent=m.name,h.addEventListener("click",()=>{r.value=m.name,s.value=m.unit,d.classList.add("hidden"),u[a].name=m.name,u[a].unit=m.unit,u[a].id=m.id}),d.appendChild(h)});const E=document.createElement("div");E.className="p-2 bg-blue-50 hover:bg-blue-200 cursor-pointer font-bold text-blue-700",E.textContent=`+ Créer "${r.value}"`,E.addEventListener("click",async()=>{const m=r.value,h="pièce(s)";try{const q=await O(g(c,"ingredients"),{name:m,unit:h,category:"Inconnue"});await N(),r.value=m,s.value=h,d.classList.add("hidden"),u[a].name=m,u[a].unit=h,u[a].id=q.id}catch(q){console.error("Erreur d'ajout d'ingrédient",q),alert("L'ingrédient n'a pas pu être créé.")}}),d.appendChild(E),d.classList.remove("hidden")});const o=document.createElement("button");o.type="button",o.className="text-red-500 hover:bg-red-50 text-sm px-3 py-1 rounded-md mt-1",o.innerHTML='<i class="fas fa-trash"></i>',o.addEventListener("click",()=>{e.remove(),u[a]=null}),e.appendChild(l),e.appendChild(i),e.appendChild(s),e.appendChild(o),U.appendChild(e)}function F(){b.innerHTML="";let t=w;if(I){const e=I.toLowerCase();t=w.filter(n=>n.name.toLowerCase().includes(e))}if(t.length===0){b.innerHTML='<p class="text-center text-gray-500 p-10 col-span-full">Aucune liste de courses trouvée.</p>';return}t.sort((e,n)=>e.name.localeCompare(n.name)),t.forEach(e=>{const n=document.createElement("div");n.className="bg-white rounded-lg shadow-md p-4 flex flex-col";const a=document.createElement("div");a.className="flex justify-between items-start border-b pb-2 mb-2";const i=document.createElement("h4");i.className="text-lg font-bold text-gray-800",i.textContent=e.name,a.appendChild(i);const s=document.createElement("div");s.className="flex space-x-2";const l=document.createElement("button");l.className="text-blue-500 hover:bg-blue-50 text-sm px-3 py-1 rounded-md",l.innerHTML='<i class="fas fa-edit"></i>',l.addEventListener("click",()=>z(e)),s.appendChild(l);const r=document.createElement("button");r.className="text-green-500 hover:bg-green-50 text-sm px-3 py-1 rounded-md",r.innerHTML='<i class="fas fa-share-alt"></i>',r.addEventListener("click",()=>se({})),s.appendChild(r);const d=document.createElement("button");d.className="text-red-500 hover:bg-red-50 text-sm px-3 py-1 rounded-md",d.innerHTML='<i class="fas fa-trash"></i>',d.addEventListener("click",()=>Z(e.id,e.name)),s.appendChild(d),a.appendChild(s);const o=document.createElement("ul");o.className="space-y-1 text-sm text-gray-600 flex-grow",e.ingredients&&e.ingredients.length>0?e.ingredients.forEach(p=>{const y=document.createElement("li");y.textContent=`${p.quantity} ${p.unit||""} - ${p.name}`.trim(),o.appendChild(y)}):o.innerHTML='<li class="italic text-gray-400">Cette liste est vide.</li>',n.appendChild(a),n.appendChild(o),b.appendChild(n)})}function Y(t){if(x.innerHTML="",t.length===0){x.innerHTML='<p class="text-center text-gray-500 p-10 col-span-full">Aucune liste de courses partagée trouvée.</p>';return}t.sort((e,n)=>e.name.localeCompare(n.name)),t.forEach(e=>{const n=document.createElement("div");n.className="bg-white rounded-lg shadow-md p-4 flex flex-col";const a=document.createElement("div");a.className="flex justify-between items-start border-b pb-2 mb-2";const i=document.createElement("h4");i.className="text-lg font-bold text-gray-800",i.textContent=e.name,a.appendChild(i);const s=document.createElement("div");s.className="flex space-x-2";const l=document.createElement("button");l.className="btn btn-secondary btn-sm",l.innerHTML='<i class="fas fa-copy mr-2"></i> Copier dans mes listes',l.title="Copier cette liste dans vos listes personnelles",l.addEventListener("click",()=>te(e.id)),s.appendChild(l);const r=document.createElement("button");r.className="text-red-500 hover:bg-red-50 text-sm px-3 py-1 rounded-md",r.innerHTML='<i class="fas fa-trash"></i>',r.title="Supprimer cette liste partagée",r.addEventListener("click",()=>ee(e.id,e.name)),s.appendChild(r),a.appendChild(s);const d=document.createElement("ul");d.className="space-y-1 text-sm text-gray-600 flex-grow",e.ingredients&&e.ingredients.length>0?e.ingredients.forEach(o=>{const p=document.createElement("li");p.textContent=`${o.quantity} ${o.unit||""} - ${o.name}`.trim(),d.appendChild(p)}):d.innerHTML='<li class="italic text-gray-400">Cette liste est vide.</li>',n.appendChild(a),n.appendChild(d),x.appendChild(n)})}async function Z(t,e){if(confirm(`Êtes-vous sûr de vouloir supprimer la liste "${e}" ?`))try{await P(L(c,"shopping_lists",t)),await M()}catch(n){console.error("Erreur de suppression de la liste: ",n)}}async function ee(t,e){if(confirm(`Êtes-vous sûr de vouloir supprimer la liste partagée "${e}" ?`))try{await P(L(c,"shopping_lists",t)),await j()}catch(n){console.error("Erreur de suppression de la liste partagée: ",n),alert("Une erreur est survenue.")}}async function te(t){if(confirm("Voulez-vous vraiment copier cette liste dans vos listes personnelles ? Elle ne sera plus considérée comme une liste partagée."))try{const e=L(c,"shopping_lists",t);await ae(e,{isShared:!1}),await A()}catch(e){console.error("Erreur lors de la copie de la liste: ",e),alert("Une erreur est survenue.")}}V.addEventListener("input",t=>{I=t.target.value,F()}),G.addEventListener("click",()=>z()),J.addEventListener("click",T),K.addEventListener("click",T),_.addEventListener("submit",X),W.addEventListener("click",()=>v()),c&&A()}export{le as default};
