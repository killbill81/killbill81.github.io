import{i as G,a as b,u as T,f as J,b as K,c as k,j as O,k as Q,q as V,w as $,o as z,l as W}from"./main-CZsIi34i.js";const d=G();let v,C,w,p,a,y,L,h,f,i,E,D,M,x,R,P=null,B=null;function X(){v&&v.classList.remove("hidden")}function q(){v&&v.classList.add("hidden"),p&&p.reset()}function Y(t,n){B=t,i&&(i.value=n),y&&y.classList.remove("hidden"),i&&i.focus()}function N(){B=null,y&&y.classList.add("hidden"),f&&f.reset()}function Z(t,n){P=t,x&&(x.textContent="Confirmer la suppression"),R&&(R.textContent=`ÃŠtes-vous sÃ»r de vouloir supprimer le plan "${n}" ? Cette action est irrÃ©versible.`),E&&E.classList.remove("hidden")}function S(){P=null,E&&E.classList.add("hidden")}async function _(t){const n=O();if(n)try{await K(k(d,"plans"),{userId:n.uid,name:t,type:"personal",weeks:{},manualItems:[],defaultNumPeople:1,startDay:"Lundi",lastUpdated:new Date}),q()}catch(e){console.error("Error creating plan: ",e),alert("Erreur lors de la crÃ©ation du plan.")}}async function ee(t,n){if(!(!t||!n))try{const e=b(d,"plans",t);await T(e,{name:n}),N()}catch(e){console.error("Error renaming plan: ",e),alert("Erreur lors du renommage du plan.")}}async function ne(t){const n=O()?.uid;if(!(!t||!n)&&confirm("Voulez-vous vraiment quitter ce plan partagÃ© ? Il n'apparaÃ®tra plus dans votre liste."))try{const e=b(d,"plans",t);await T(e,{collaborators:Q(n)})}catch(e){console.error("Erreur pour quitter le plan: ",e),alert("Une erreur est survenue.")}}async function te(t){if(t)try{await J(b(d,"plans",t))}catch(n){console.error("Error deleting plan: ",n),alert("Erreur lors de la suppression du plan.")}}function le(t){const n=O();if(!n)return()=>{};let e=new Map;const s=()=>{t(Array.from(e.values()).sort((c,I)=>c.name.localeCompare(I.name)))},l=async c=>{const m=[c.userId,...c.collaborators||[]].map(r=>W(b(d,"users",r)));return(await Promise.all(m)).map(r=>r.exists()?r.data():{uid:r.id,displayName:"Inconnu"})},u=V(k(d,"plans"),$("userId","==",n.uid)),U=z(u,async c=>{const m=c.docChanges().map(async o=>{if(o.type==="removed")e.delete(o.doc.id);else{const r=o.doc.data(),g=await l(r);e.set(o.doc.id,{id:o.doc.id,...r,isOwner:!0,participants:g})}});await Promise.all(m),s()}),A=V(k(d,"plans"),$("collaborators","array-contains",n.uid)),F=z(A,async c=>{const m=c.docChanges().map(async o=>{if(o.type==="removed")e.delete(o.doc.id);else{const r=o.doc.data(),g=await l(r),j=g.find(H=>H.uid===r.userId);e.set(o.doc.id,{id:o.doc.id,...r,isOwner:!1,ownerName:j?.displayName||"Inconnu",participants:g})}});await Promise.all(m),s()});return()=>{U(),F()}}function oe(t){if(!a)return;const n=a.value;if(a.innerHTML="",t.length===0){const e=document.createElement("option");e.value="",e.textContent="Aucun plan personnel",e.disabled=!0,a.appendChild(e);return}t.forEach(e=>{const s=document.createElement("option");s.value=e.id;let l=e.name;e.collaborators&&e.collaborators.length>0&&(e.isOwner?l=`ðŸ‘‘ ${e.name} [Collab]`:l=`ðŸ‘¥ ${e.name} [Collab] (de ${e.ownerName})`),s.textContent=l,a.appendChild(s)}),n&&a.querySelector(`option[value="${n}"]`)?a.value=n:a.selectedIndex=0}function re(){v=document.getElementById("create-plan-modal"),C=document.getElementById("close-create-plan-modal"),w=document.getElementById("cancel-create-plan-btn"),p=document.getElementById("create-plan-form"),a=document.getElementById("plan-select"),y=document.getElementById("rename-plan-modal"),L=document.getElementById("close-rename-plan-modal"),h=document.getElementById("cancel-rename-plan-btn"),f=document.getElementById("rename-plan-form"),i=document.getElementById("new-plan-name"),E=document.getElementById("delete-confirm-modal"),D=document.getElementById("cancel-delete-btn"),M=document.getElementById("confirm-delete-btn"),x=document.getElementById("delete-confirm-title"),R=document.getElementById("delete-confirm-message");const t=document.getElementById("create-plan-btn"),n=document.getElementById("rename-plan-btn"),e=document.getElementById("leave-plan-btn"),s=document.getElementById("delete-plan-btn");t&&t.addEventListener("click",X),n&&n.addEventListener("click",()=>{if(a&&a.value){const l=a.options[a.selectedIndex];Y(a.value,l.text)}else alert("Veuillez sÃ©lectionner un plan Ã  renommer.")}),e&&e.addEventListener("click",()=>{a&&a.value?ne(a.value):alert("Veuillez sÃ©lectionner un plan.")}),s&&s.addEventListener("click",()=>{if(a&&a.value){const l=a.options[a.selectedIndex].text;Z(a.value,l)}else alert("Veuillez sÃ©lectionner un plan Ã  supprimer.")}),C&&C.addEventListener("click",q),w&&w.addEventListener("click",q),p&&p.addEventListener("submit",l=>{l.preventDefault();const u=document.getElementById("plan-name");u&&u.value&&_(u.value)}),L&&L.addEventListener("click",N),h&&h.addEventListener("click",N),f&&f.addEventListener("submit",l=>{l.preventDefault(),B&&i.value&&ee(B,i.value)}),D&&D.addEventListener("click",S),M&&M.addEventListener("click",()=>{P&&te(P).then(()=>{S()})})}export{le as getUserPlans,re as initPlanManagement,oe as populatePlanSelector};
