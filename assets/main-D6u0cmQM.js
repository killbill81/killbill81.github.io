import{o as Bn,s as Sn,a as Ut,q as ue,w as te,c as F,d as b,b as Fe,e as $,g as we,f as pe,u as ke,h as He,i as Se,j as dt,k as Gt,l as gt,m as Ot,n as kn,p as Mn,r as Et,t as zt,v as Nn,x as Tn,y as Dn,z as Pn,A as _n,B as Xt,C as $n,D as Hn,_ as jn}from"./firebase-config-DRNfbNj5.js";const An=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"}));let ht=null;function Yt(){return new Promise(e=>{Bn(Ut,t=>{if(ht=t,t){console.log("User is logged in:",t.uid);const n=document.getElementById("logout-btn"),a=document.getElementById("profile-btn");n&&n.classList.remove("hidden"),a&&a.classList.remove("hidden"),n&&!n.hasAttribute("data-listener-attached")&&(n.addEventListener("click",()=>{Sn(Ut).catch(o=>{console.error("Sign Out Error",o)})}),n.setAttribute("data-listener-attached","true")),e(t)}else{console.log("User not logged in. Redirecting to login.html");const n=window.location.origin+"/login.html";window.location.href!==n&&(window.location.href=n),e(null)}})})}function ve(){return ht?ht.uid:null}function De(){return ht}const Rn=Object.freeze(Object.defineProperty({__proto__:null,getCurrentUser:De,getCurrentUserId:ve,protectPage:Yt},Symbol.toStringTag,{value:"Module"}));async function qn(e){if(confirm("Voulez-vous charger cette sauvegarde ? Attention, cela √©crasera la planification de la semaine correspondante dans votre plan de travail actuel."))try{const t=ve();if(!t)throw new Error("Utilisateur non trouv√©");const n=$(b,"plan_saves",e),a=await we(n);if(!a.exists())throw new Error("Sauvegarde non trouv√©e.");const o=a.data(),l=o.weekData.weekNumber,c=ue(F(b,"plans"),te("userId","==",t)),f=await pe(c);if(f.empty)throw new Error("Aucun plan de travail trouv√© pour y charger la sauvegarde.");const y=f.docs[0],x=$(b,"plans",y.id);await ke(x,{[`weeks.${l}`]:o.weekData}),localStorage.setItem("selectedPlanId",y.id),et("menu")}catch(t){console.error("Erreur lors du chargement de la sauvegarde:",t),alert(t.message)}}async function Fn(e){if(confirm("√ätes-vous s√ªr de vouloir supprimer cette sauvegarde ? Cette action est d√©finitive."))try{await He($(b,"plan_saves",e))}catch(t){console.error("Erreur lors de la suppression de la sauvegarde:",t),alert("La suppression a √©chou√©.")}}function Un(){const e=document.getElementById("all-plans-list"),t=ve();if(!t||!e)return e.innerHTML="<p>Erreur de chargement.</p>",()=>{};const n=ue(F(b,"plan_saves"),te("userId","==",t)),a=Fe(n,o=>{if(e.innerHTML="",o.empty){e.innerHTML=`<p class="text-center text-gray-500 p-10 col-span-full">Vous n'avez aucune sauvegarde.</p>`;return}const l=o.docs.map(c=>({id:c.id,...c.data()}));l.sort((c,f)=>f.savedAt.toMillis()-c.savedAt.toMillis()),l.forEach(c=>{const f=document.createElement("div");f.className="bg-white rounded-xl shadow-md p-4 flex flex-col justify-between";const y=c.savedAt?.toDate().toLocaleString("fr-FR")||"Date inconnue",x=c.planData;let w="Plan vide ou sans donn√©es.";if(x&&x.weeks){const H=Object.keys(x.weeks).length;H>0&&(w=`Contient ${H} semaine(s).`)}const C=document.createElement("div");C.innerHTML=`
                <h3 class="text-lg font-bold text-gray-800 mb-2">${c.name}</h3>
                <p class="text-sm text-gray-500">Sauvegard√© le : ${y}</p>
                <p class="text-sm text-gray-600 mt-2">${w}</p>
            `;const L=document.createElement("div");L.className="mt-4 pt-4 border-t border-gray-200 flex items-center justify-end space-x-2";const P=document.createElement("button");P.className="btn btn-secondary btn-sm",P.textContent="Voir",P.addEventListener("click",()=>{localStorage.setItem("selectedPlanId",c.id),et("view-plan")});const M=document.createElement("button");M.className="btn btn-primary btn-sm",M.textContent="Charger",M.addEventListener("click",()=>qn(c.id)),M.style.display="none";const p=document.createElement("button");p.className="btn btn-ghost text-red-500 hover:bg-red-100 btn-sm",p.innerHTML='<i class="fas fa-trash"></i>',p.title="Supprimer la sauvegarde",p.addEventListener("click",()=>Fn(c.id)),L.appendChild(p),L.appendChild(P),L.appendChild(M),f.appendChild(C),f.appendChild(L),e.appendChild(f)})});return()=>{a()}}const On=Object.freeze(Object.defineProperty({__proto__:null,default:Un},Symbol.toStringTag,{value:"Module"}));class $t{constructor(t,n,a,o,l,c,f,y,x,w,C,L,P,M,p,H){this.db=t,this.modal=document.getElementById(n),this.form=document.getElementById(a),this.modalTitle=document.getElementById(o),this.recipeIdInput=document.getElementById(l),this.recipeNameInput=document.getElementById(c),this.recipeCategoryInput=document.getElementById(f),this.recipeServingsInput=document.getElementById(y),this.recipePrepTimeInput=document.getElementById(x),this.recipeDifficultyInput=document.getElementById(w),this.recipeStepsTextarea=document.getElementById(C),this.ingredientsListDiv=document.getElementById(L),this.addIngredientBtn=document.getElementById(P),this.saveRecipeBtn=document.getElementById(M),this.closeButton=document.getElementById(p),this.cancelButton=document.getElementById(H),this.masterIngredientList=[],this.activityUpdater=null,this.boundAddIngredient=()=>this.addIngredientInput(void 0,this.form.ingredients),this.boundCloseForm=()=>this.closeForm(),this.boundHandleSubmit=G=>this.handleSubmit(G),this.addIngredientBtn.addEventListener("click",this.boundAddIngredient),this.closeButton.addEventListener("click",this.boundCloseForm),this.cancelButton.addEventListener("click",this.boundCloseForm),this.saveRecipeBtn.addEventListener("click",this.boundHandleSubmit)}setActivityUpdater(t){this.activityUpdater=t}destroy(){this.addIngredientBtn.removeEventListener("click",this.boundAddIngredient),this.closeButton.removeEventListener("click",this.boundCloseForm),this.cancelButton.removeEventListener("click",this.boundCloseForm),this.saveRecipeBtn.removeEventListener("click",this.boundHandleSubmit)}async openForm(t=null,n="Ajouter une recette"){this.activityUpdater&&this.activityUpdater("editing_recipe"),await this.fetchMasterIngredients(),console.log("openForm called with recipe:",t,"and title:",n),this.form.reset(),this.ingredientsListDiv.innerHTML="",this.modalTitle.textContent=n;const a=[];if(this.form.ingredients=a,t){this.recipeIdInput.value=t.id||"",this.recipeNameInput.value=t.name||"";const o=t.category||"Plat";for(const l of this.recipeCategoryInput.options)if(l.value.toLowerCase()===o.toLowerCase()){l.selected=!0;break}this.recipeServingsInput.value=parseInt(t.servings)||"",this.recipePrepTimeInput.value=parseInt(t.prepTime)||"",this.recipeDifficultyInput.value=t.difficulty||"Moyen",this.recipeStepsTextarea.value=t.steps||"",t.ingredients&&t.ingredients.length>0?t.ingredients.forEach(l=>this.addIngredientInput({...l},a)):this.addIngredientInput(void 0,a)}else this.recipeIdInput.value="",this.addIngredientInput(void 0,a);this.modal.classList.remove("hidden")}closeForm(){this.activityUpdater&&this.activityUpdater("idle"),this.modal.classList.add("hidden")}async fetchMasterIngredients(){if(this.masterIngredientList=[],!!this.db)try{const t=await pe(F(this.db,"ingredients"));this.masterIngredientList=t.docs.map(n=>({id:n.id,...n.data()})),this.masterIngredientList.sort((n,a)=>n.name.localeCompare(a.name))}catch(t){console.error("Erreur lors de la r√©cup√©ration de la liste des ingr√©dients: ",t),alert("Impossible de charger la liste des ingr√©dients de base. La recherche ne fonctionnera pas.")}}addIngredientInput(t={quantity:"",name:"",unit:""},n){const a=document.createElement("div");a.className="relative flex items-stretch space-x-2 ingredient-row";const o={...t};n.push(o);const l=n.length-1,c=document.createElement("input");c.type="text",c.className="ingredient-quantity mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm",c.placeholder="Qt√©",c.value=o.quantity,c.addEventListener("change",L=>{n[l].quantity=L.target.value});const f=document.createElement("input");f.type="text",f.className="ingredient-unit mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm bg-gray-100",f.placeholder="Unit√©",f.readOnly=!0,f.value=o.unit||"";const y=document.createElement("div");y.className="relative w-1/2";const x=document.createElement("input");x.type="text",x.className="ingredient-name mt-1 block w-full rounded-md border-gray-300 shadow-sm",x.placeholder="Chercher un ingr√©dient...",x.value=o.name,y.appendChild(x);const w=document.createElement("div");w.className="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto",y.appendChild(w),x.addEventListener("input",()=>{const L=x.value.toLowerCase();if(!L){w.classList.add("hidden");return}const P=this.masterIngredientList.filter(p=>p.name.toLowerCase().includes(L));w.innerHTML="",P.forEach(p=>{const H=document.createElement("div");H.className="p-2 ingredient-search-item cursor-pointer",H.textContent=p.name,H.addEventListener("click",()=>{x.value=p.name,f.value=p.unit,w.classList.add("hidden"),n[l].name=p.name,n[l].unit=p.unit,n[l].id=p.id}),w.appendChild(H)});const M=document.createElement("div");M.className="p-2 bg-blue-50 hover:bg-blue-200 cursor-pointer font-bold text-blue-700",M.textContent=`+ Cr√©er "${x.value}"`,M.addEventListener("click",async()=>{const p=x.value,H="pi√®ce(s)";try{const G=await Se(F(this.db,"ingredients"),{name:p,unit:H});await this.fetchMasterIngredients(),x.value=p,f.value=H,w.classList.add("hidden"),n[l].name=p,n[l].unit=H,n[l].id=G.id}catch(G){console.error("Erreur d'ajout d'ingr√©dient",G),alert("L'ingr√©dient n'a pas pu √™tre cr√©√©.")}}),w.appendChild(M),w.classList.remove("hidden")});const C=document.createElement("button");C.type="button",C.className="btn btn-ghost text-red-500 hover:bg-red-50 btn-sm mt-1",C.innerHTML='<i class="fas fa-trash"></i>',C.addEventListener("click",()=>{a.remove(),n[l]=null}),a.appendChild(y),a.appendChild(c),a.appendChild(f),a.appendChild(C),this.ingredientsListDiv.appendChild(a)}async handleSubmit(t){t.preventDefault(),this.saveRecipeBtn.disabled=!0,this.saveRecipeBtn.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i> Sauvegarde...',console.log("Ingredients array from form before filter:",this.form.ingredients);const n=this.form.ingredients.filter(l=>l!==null&&l.quantity&&l.name);console.log("Ingredients array after filter:",n);const a={name:this.recipeNameInput.value,category:this.recipeCategoryInput.value,servings:parseInt(this.recipeServingsInput.value)||0,prepTime:parseInt(this.recipePrepTimeInput.value)||0,difficulty:this.recipeDifficultyInput.value,steps:this.recipeStepsTextarea.value,ingredients:n,imageUrl:""};console.log("Recipe data being sent to Firebase:",a);const o=this.recipeIdInput.value;try{o?await dt($(this.db,"recipes",o),a):await Se(F(this.db,"recipes"),a),this.closeForm(),console.log("Recipe saved successfully!"),this.onSaveCallback&&this.onSaveCallback()}catch(l){console.error("Erreur de sauvegarde: ",l),alert("Une erreur est survenue lors de la sauvegarde.")}finally{this.saveRecipeBtn.disabled=!1,this.saveRecipeBtn.textContent="Sauvegarder"}}setOnSaveCallback(t){this.onSaveCallback=t}}const zn=Object.freeze(Object.defineProperty({__proto__:null,RecipeFormHandler:$t},Symbol.toStringTag,{value:"Module"}));let Mt=()=>{};function Vn(){const e=document.getElementById("search-friends-input");return document.getElementById("search-friends-btn").addEventListener("click",()=>Vt(e.value)),e.addEventListener("keyup",n=>{n.key==="Enter"&&Vt(e.value)}),Qn(),Kt(),()=>{Mt&&Mt()}}async function Qn(){const e=document.getElementById("friends-list-container"),t=De()?.uid;if(!t||!e)return;e.innerHTML='<p class="text-gray-500">Chargement...</p>';const n=$(b,"users",t);Mt=Fe(n,async a=>{if(!a.exists()){e.innerHTML='<p class="text-red-500">Erreur: Utilisateur non trouv√©.</p>';return}const o=a.data().friends||[];if(e.innerHTML="",o.length===0){e.innerHTML=`<p class="text-gray-500">Vous n'avez pas encore d'amis. Utilisez la recherche pour en ajouter.</p>`;return}for(const l of o)try{const c=await we($(b,"users",l));c.exists()&&e.appendChild(Jn(c.data()))}catch(c){console.error("Erreur de chargement d'un ami",c)}})}function Jn(e){const t=document.createElement("div");t.className="bg-white p-3 rounded-lg flex items-center justify-between shadow-sm";const n=document.createElement("div");n.className="flex items-center",n.innerHTML=`
        <img src="${e.photoURL||"https://placehold.co/40"}" alt="Avatar" class="w-10 h-10 rounded-full mr-3">
        <div>
            <p class="font-bold">${e.displayName}</p>
            <p class="text-sm text-gray-500">${e.email}</p>
        </div>
    `;const a=document.createElement("button");return a.className="btn btn-ghost text-red-500 btn-sm",a.innerHTML='<i class="fas fa-user-times"></i>',a.title="Retirer cet ami",a.addEventListener("click",()=>Wn(e.uid)),t.appendChild(n),t.appendChild(a),t}async function Wn(e){const t=De()?.uid;if(!t||!e){console.error("Impossible de supprimer l'ami : ID utilisateur ou ID ami manquant.");return}if(!confirm("Voulez-vous vraiment retirer cet ami ? Cette action est unilat√©rale."))return;console.log(`Tentative de suppression de l'ami ${e} pour l'utilisateur ${t}`);const n=$(b,"users",t);try{await ke(n,{friends:Gt(e)}),console.log("Ami supprim√© avec succ√®s de la base de donn√©es.")}catch(a){console.error("Erreur lors de la suppression de l'ami: ",a),alert("Une erreur est survenue.")}}async function Vt(e){const t=document.getElementById("search-results-container"),n=De()?.uid;if(!(!e||!t)){t.innerHTML='<p class="text-gray-500">Recherche en cours...</p>';try{const a=e.toLowerCase(),o=a+"Ô£ø",l=ue(F(b,"users"),te("displayName_lowercase",">=",a),te("displayName_lowercase","<",o)),c=ue(F(b,"users"),te("email","==",a)),[f,y]=await Promise.all([pe(l),pe(c)]),x=new Map;if(f.forEach(w=>x.set(w.id,w.data())),y.forEach(w=>x.set(w.id,w.data())),t.innerHTML="",x.size===0){t.innerHTML='<p class="text-gray-500">Aucun utilisateur trouv√©.</p>';return}x.forEach(w=>{if(w.uid===n)return;const C=document.createElement("div");C.className="bg-gray-50 p-2 rounded-lg flex items-center justify-between",C.innerHTML=`
                <div class="flex items-center">
                    <img src="${w.photoURL||"https://placehold.co/32"}" class="w-8 h-8 rounded-full mr-2">
                    <span class="font-medium text-sm">${w.displayName} (${w.email})</span>
                </div>
            `;const L=document.createElement("button");L.className="btn btn-secondary btn-xs",L.innerHTML='<i class="fas fa-user-plus"></i>',L.addEventListener("click",()=>Gn(w.uid)),C.appendChild(L),t.appendChild(C)})}catch(a){console.error("Erreur de recherche: ",a),t.innerHTML='<p class="text-red-500">Erreur de recherche.</p>'}}}async function Gn(e){const t=De()?.uid;if(!t||t===e)return;const n=ue(F(b,"friend_requests"),te("senderId","==",t),te("receiverId","==",e)),a=ue(F(b,"friend_requests"),te("senderId","==",e),te("receiverId","==",t)),[o,l]=await Promise.all([pe(n),pe(a)]);if(!o.empty||!l.empty)return alert("Une demande d'ami existe d√©j√† avec cet utilisateur.");if((await we($(b,"users",t))).data()?.friends?.includes(e))return alert("Vous √™tes d√©j√† ami avec cet utilisateur.");try{await Se(F(b,"friend_requests"),{senderId:t,receiverId:e,status:"pending",createdAt:gt()}),alert("Demande d'ami envoy√©e !")}catch(f){console.error("Erreur lors de l'envoi de la demande d'ami: ",f),alert("Une erreur est survenue.")}}async function Kt(){const e=document.getElementById("pending-requests-container"),t=document.getElementById("declined-requests-container"),n=De()?.uid;if(!(!n||!e||!t)){e.innerHTML='<p class="text-gray-500">Chargement...</p>',t.innerHTML='<p class="text-gray-500">Chargement...</p>';try{const a=ue(F(b,"friend_requests"),te("senderId","==",n)),o=await pe(a),l=[],c=[];for(const f of o.docs){const y={id:f.id,...f.data()},x=await we($(b,"users",y.receiverId));x.exists()&&(y.receiver=x.data()),y.status==="pending"?l.push(y):y.status==="declined"&&c.push(y)}e.innerHTML="",l.length>0?l.forEach(f=>e.appendChild(Qt(f))):e.innerHTML='<p class="text-gray-500">Aucune demande en attente.</p>',t.innerHTML="",c.length>0?c.forEach(f=>t.appendChild(Qt(f))):t.innerHTML='<p class="text-gray-500">Aucune demande rejet√©e.</p>'}catch(a){console.error("Erreur lors du chargement des demandes envoy√©es: ",a),e.innerHTML='<p class="text-red-500">Erreur de chargement.</p>',t.innerHTML='<p class="text-red-500">Erreur de chargement.</p>'}}}function Qt(e){const t=document.createElement("div");t.className="bg-white p-3 rounded-lg flex items-center justify-between shadow-sm";const n=e.receiver,a=document.createElement("div");a.className="flex items-center",a.innerHTML=`
        <img src="${n?.photoURL||"https://placehold.co/40"}" alt="Avatar" class="w-10 h-10 rounded-full mr-3">
        <div>
            <p class="font-bold">${n?.displayName||"Utilisateur inconnu"}</p>
            <p class="text-sm text-gray-500">Statut : <span class="font-medium">${e.status}</span></p>
        </div>
    `;const o=document.createElement("button");return o.className="btn btn-ghost text-red-500 btn-sm",o.innerHTML='<i class="fas fa-times-circle"></i>',o.title="Annuler la demande",o.addEventListener("click",async()=>{confirm("Voulez-vous vraiment annuler cette demande ?")&&(await He($(b,"friend_requests",e.id)),Kt())}),t.appendChild(a),t.appendChild(o),t}async function Zt(e){try{const t=$(b,"friend_requests",e);await ke(t,{status:"accepted"})}catch(t){throw console.error("Erreur lors de l'acceptation de la demande d'ami: ",t),t}}async function en(e){try{const t=$(b,"friend_requests",e);await ke(t,{status:"declined"})}catch(t){throw console.error("Erreur lors du refus de la demande d'ami: ",t),t}}const Xn=Object.freeze(Object.defineProperty({__proto__:null,acceptFriendRequest:Zt,declineFriendRequest:en,default:Vn},Symbol.toStringTag,{value:"Module"}));function Yn(){const e=document.getElementById("ingredients-list-container"),t=document.getElementById("add-ingredient-btn"),n=document.getElementById("category-tabs"),a=document.getElementById("search-bar"),o=document.getElementById("ingredient-form-modal"),l=document.getElementById("ingredient-modal-title"),c=document.getElementById("close-ingredient-modal"),f=document.getElementById("cancel-ingredient-btn"),y=document.getElementById("ingredient-form"),x=document.getElementById("ingredient-id"),w=document.getElementById("ingredient-name"),C=document.getElementById("ingredient-unit"),L=document.getElementById("ingredient-category"),P=document.getElementById("manage-categories-btn"),M=document.getElementById("category-management-modal"),p=document.getElementById("close-category-modal"),H=document.getElementById("done-category-modal-btn"),G=document.getElementById("add-category-form"),Me=document.getElementById("new-category-name"),z=document.getElementById("category-list");let R=[],T=[],O="",X="",Le=null;const be=["g","kg","ml","l","pi√®ce(s)","c.√†.s.","c.√†.c.","pinc√©e(s)"];async function ye(){await Ce(),await xe()}async function Ce(){if(b)try{T=(await pe(F(b,"ingredient_categories"))).docs.map(_=>({id:_.id,..._.data()})),T.sort((_,S)=>_.name.localeCompare(S.name))}catch(q){console.error("Erreur lors de la r√©cup√©ration des cat√©gories: ",q)}}async function xe(){if(b)try{R=(await pe(F(b,"ingredients"))).docs.map(_=>({id:_.id,..._.data()})),W(),oe()}catch(q){console.error("Erreur de chargement des ingr√©dients: ",q)}}function Ae(q=null){y.reset(),C.innerHTML="",be.forEach(j=>{const ne=document.createElement("option");ne.value=j,ne.textContent=j,C.appendChild(ne)});const _=T.map(j=>j.name),S=[...new Set(R.map(j=>j.category).filter(Boolean))],N=[...new Set([..._,...S])];N.sort((j,ne)=>j.localeCompare(ne.name)),L.innerHTML="",N.forEach(j=>{const ne=document.createElement("option");ne.value=j,ne.textContent=j,L.appendChild(ne)}),q?(l.textContent="Modifier l'ingr√©dient",x.value=q.id,w.value=q.name,C.value=q.unit||"",L.value=q.category||(N.length>0?N[0]:"")):(l.textContent="Ajouter un ingr√©dient",x.value="",C.value=be[0],L.value=O||(N.length>0?N[0]:"")),o.classList.remove("hidden")}function Re(){o.classList.add("hidden")}async function U(q){q.preventDefault();const _=x.value,S={name:w.value,unit:C.value,category:L.value};if(!S.name||!S.category){alert("Le nom et la cat√©gorie sont requis.");return}try{_?await dt($(b,"ingredients",_),S):await Se(F(b,"ingredients"),S),Re(),await xe()}catch(N){console.error("Erreur de sauvegarde de l'ingr√©dient: ",N)}}function B(){J(),M.classList.remove("hidden")}function Q(){M.classList.add("hidden")}function J(){if(z.innerHTML="",T.length===0){z.innerHTML='<p class="text-gray-500">Aucune cat√©gorie d√©finie.</p>';return}T.forEach(q=>{const _=document.createElement("div");_.className="flex items-center justify-between p-2 border-b";const S=document.createElement("span");S.textContent=q.name,_.appendChild(S);const N=document.createElement("div");N.className="flex space-x-2";const j=document.createElement("button");j.className="btn btn-ghost btn-xs text-blue-500",j.innerHTML='<i class="fas fa-edit"></i>',j.addEventListener("click",()=>Z(q)),N.appendChild(j);const ne=document.createElement("button");ne.className="btn btn-ghost btn-xs text-red-500",ne.innerHTML='<i class="fas fa-trash"></i>',ne.addEventListener("click",()=>me(q)),N.appendChild(ne),_.appendChild(N),z.appendChild(_)})}async function K(q){q.preventDefault();const _=Me.value.trim();if(_&&!T.find(S=>S.name.toLowerCase()===_.toLowerCase()))try{await Se(F(b,"ingredient_categories"),{name:_}),Me.value="",await Ce(),J(),W()}catch(S){console.error("Erreur d'ajout de cat√©gorie: ",S)}else alert("Cette cat√©gorie existe d√©j√† ou le nom est invalide.")}async function Z(q){const _=q.name,S=prompt(`Entrez le nouveau nom pour la cat√©gorie "${_}":`,_);if(S&&S.trim()!==""&&S!==_)try{await dt($(b,"ingredient_categories",q.id),{name:S});const N=ue(F(b,"ingredients"),te("category","==",_)),j=await pe(N),ne=Ot(b);j.forEach(ze=>{ne.update(ze.ref,{category:S})}),await ne.commit(),await ye(),J()}catch(N){console.error("Erreur de renommage: ",N)}}async function me(q){if(confirm(`√ätes-vous s√ªr de vouloir supprimer la cat√©gorie "${q.name}"?

Tous les ingr√©dients associ√©s seront d√©plac√©s vers la cat√©gorie "Inconnue".`))try{await He($(b,"ingredient_categories",q.id));const _=ue(F(b,"ingredients"),te("category","==",q.name)),S=await pe(_),N=Ot(b);S.forEach(j=>{N.update(j.ref,{category:"Inconnue"})}),await N.commit(),O="",await ye(),J()}catch(_){console.error("Erreur de suppression: ",_)}}function W(){n.innerHTML="";const q=T.map(N=>N.name),_=[...new Set(R.map(N=>N.category||"Inconnue"))];let S=[...new Set([...q,..._])];S.sort((N,j)=>N.localeCompare(j)),S.includes("Inconnue")&&(S=S.filter(N=>N!=="Inconnue"),S.push("Inconnue")),S.length===0&&R.length>0&&S.push("Inconnue"),!O&&S.length>0&&(O=S[0]),S.forEach(N=>{const j=document.createElement("button"),ne=N===O;j.className=`px-4 py-2 text-sm font-medium rounded-t-lg ${ne?"bg-tomato text-white":"text-gray-500 hover:text-tomato"}`,j.textContent=N,j.addEventListener("click",()=>ie(N)),n.appendChild(j)})}function ie(q){O=q,W(),oe()}function oe(){e.innerHTML="";const q=O||(T.length>0?T[0].name:"Inconnue");let _=R.filter(N=>(N.category||"Inconnue")===q);if(X){const N=X.toLowerCase();_=_.filter(j=>j.name.toLowerCase().includes(N))}if(_.length===0){e.innerHTML='<p class="text-center text-gray-500 p-10">Aucun ingr√©dient dans cette cat√©gorie.</p>';return}_.sort((N,j)=>N.name.localeCompare(j.name,"fr",{sensitivity:"base"}));const S=document.createElement("div");S.className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4",_.forEach(N=>{const j=document.createElement("div");j.className="p-3 bg-white shadow-sm rounded-lg flex flex-col items-start space-y-2";const ne=document.createElement("div");ne.className="flex-grow w-full flex justify-between items-center";const ze=document.createElement("span");ze.className="font-medium text-gray-800",ze.textContent=N.name;const Je=document.createElement("span");Je.className="text-gray-500 text-sm bg-gray-100 px-2 py-1 rounded-full",Je.textContent=N.unit,ne.appendChild(ze),ne.appendChild(Je);const We=document.createElement("div");We.className="w-full flex justify-end items-center space-x-2 border-t pt-2 mt-2";const Ge=document.createElement("button");Ge.className="btn btn-ghost btn-xs text-blue-500 hover:bg-blue-50",Ge.innerHTML='<i class="fas fa-edit"></i>',Ge.addEventListener("click",()=>Ae(N));const Xe=document.createElement("button");Xe.className="btn btn-ghost btn-xs text-red-500 hover:bg-red-50",Xe.innerHTML='<i class="fas fa-trash-alt"></i>',Xe.addEventListener("click",()=>Ie(N.id,N.name)),We.appendChild(Ge),We.appendChild(Xe),j.appendChild(ne),j.appendChild(We),S.appendChild(j)}),e.appendChild(S)}async function Ie(q,_){if(confirm(`√ätes-vous s√ªr de vouloir supprimer l'ingr√©dient "${_}" ?`))try{await He($(b,"ingredients",q)),await xe()}catch(S){console.error("Erreur de suppression de l'ingr√©dient: ",S)}}a.addEventListener("input",q=>{const _=q.target.value.toLowerCase();if(!X&&_&&(Le=O),X=_,X){const S=R.find(N=>N.name.toLowerCase().includes(X));S&&(O=S.category||"Inconnue")}else Le&&(O=Le,Le=null);W(),oe()}),t.addEventListener("click",()=>Ae()),c.addEventListener("click",Re),f.addEventListener("click",Re),y.addEventListener("submit",U),P.addEventListener("click",B),p.addEventListener("click",Q),H.addEventListener("click",Q),G.addEventListener("submit",K),ye()}const Kn=Object.freeze(Object.defineProperty({__proto__:null,default:Yn},Symbol.toStringTag,{value:"Module"})),V={modal:document.getElementById("share-modal"),closeBtn:document.getElementById("close-share-modal"),title:document.getElementById("share-modal-title"),friendsList:document.getElementById("share-friends-list"),sharePlanCheckbox:document.getElementById("share-planning-checkbox"),shareShoppingListCheckbox:document.getElementById("share-shopping-list-checkbox"),confirmBtn:document.getElementById("confirm-share-btn")};let je={};function yt(){V.modal.classList.add("hidden");const e=document.getElementById("share-mode-selection");e&&e.classList.remove("hidden"),V.confirmBtn.textContent="Envoyer le partage";const t=V.confirmBtn.cloneNode(!0);V.confirmBtn.parentNode&&(V.confirmBtn.parentNode.replaceChild(t,V.confirmBtn),V.confirmBtn=t,t.addEventListener("click",tn))}async function tn(){const e=ve();if(!e||!je.plan)return;const t=Array.from(V.friendsList.querySelectorAll('input[type="checkbox"]:checked')).map(a=>a.value),n=document.querySelector('input[name="share-mode"]:checked')?.value;if(t.length===0){alert("Veuillez s√©lectionner au moins un ami.");return}if(!n){alert("Veuillez s√©lectionner un mode de partage.");return}V.confirmBtn.disabled=!0,V.confirmBtn.textContent="Envoi en cours...";try{const a=F(b,"shares");let o={};n==="collaborate"?o={senderId:e,createdAt:new Date,type:"collaborative_plan_invite",planId:je.plan.id,planName:je.plan.name}:o={senderId:e,createdAt:new Date,type:"share",plan:{name:je.plan.name,weeks:je.plan.weeks||{},manualItems:je.plan.manualItems||[],defaultNumPeople:je.plan.defaultNumPeople||1,startDay:je.plan.startDay||"Lundi"}};for(const l of t)await Se(a,{...o,receiverId:l,status:"pending"});yt(),alert("Partage envoy√© avec succ√®s !")}catch(a){console.error("Erreur lors de l'envoi du partage : ",a),alert("Une erreur est survenue lors de l'envoi du partage.")}finally{V.confirmBtn.disabled=!1,V.confirmBtn.textContent="Envoyer le partage"}}async function Ht(e={}){const{plan:t}=e;if(!t){alert("Aucun plan s√©lectionn√© √† partager.");return}je={plan:t},V.title.textContent=`Partager le plan "${t.name}"`,V.friendsList.innerHTML='<p class="text-gray-500">Chargement des amis...</p>',V.modal.classList.remove("hidden");const n=ve();if(n)try{const a=await we($(b,"users",n));if(a.exists()){const l=a.data().friends||[];if(l.length===0){V.friendsList.innerHTML=`<p class="text-gray-500">Vous n'avez pas d'amis √† qui partager.</p>`;return}V.friendsList.innerHTML="";for(const c of l){const f=await we($(b,"users",c));if(f.exists()){const y=f.data(),x=document.createElement("label");x.className="flex items-center p-2 hover:bg-gray-100 rounded-lg cursor-pointer";const w=document.createElement("input");w.type="checkbox",w.value=y.uid,w.className="form-checkbox h-5 w-5 text-tomato rounded focus:ring-tomato",x.appendChild(w);const C=document.createElement("img");C.src=y.photoURL||"https://placehold.co/40x40",C.alt=y.displayName,C.className="w-8 h-8 rounded-full ml-3 mr-3",x.appendChild(C);const L=document.createElement("span");L.className="font-medium",L.textContent=y.displayName||y.email,x.appendChild(L),V.friendsList.appendChild(x)}}}}catch(a){console.error("Erreur lors du chargement des amis pour le partage : ",a),V.friendsList.innerHTML='<p class="text-red-500">Une erreur est survenue.</p>'}}async function Zn(e){const t=ve();if(!t||!e)return;const n=Array.from(V.friendsList.querySelectorAll('input[type="checkbox"]:checked:not(:disabled)')).map(a=>a.value);if(n.length===0){alert("Veuillez s√©lectionner au moins un ami √† inviter.");return}V.confirmBtn.disabled=!0,V.confirmBtn.textContent="Envoi en cours...";try{const a=await we($(b,"plans",e));if(!a.exists())throw new Error("Plan not found");const o=a.data().name,l=F(b,"shares"),c={senderId:t,createdAt:new Date,type:"collaborative_plan_invite",planId:e,planName:o};for(const f of n)await Se(l,{...c,receiverId:f,status:"pending"});yt(),alert("Invitation(s) envoy√©e(s) avec succ√®s !")}catch(a){console.error("Erreur lors de l'envoi de l'invitation : ",a),alert("Une erreur est survenue lors de l'envoi de l'invitation.")}finally{V.confirmBtn.disabled=!1}}async function nn(e){if(!e||!e.id){alert("Plan non valide pour l'invitation.");return}je={plan:e},V.title.textContent=`Inviter √† collaborer sur "${e.name}"`;const t=document.getElementById("share-mode-selection");t&&t.classList.add("hidden"),V.friendsList.innerHTML='<p class="text-gray-500">Chargement des amis...</p>',V.modal.classList.remove("hidden");const n=ve();if(!n)return;try{const o=await we($(b,"users",n));if(o.exists()){const c=o.data().friends||[],f=[e.userId,...e.collaborators||[]];if(c.length===0){V.friendsList.innerHTML=`<p class="text-gray-500">Vous n'avez pas d'amis √† inviter.</p>`;return}V.friendsList.innerHTML="";for(const y of c){const x=await we($(b,"users",y));if(x.exists()){const w=x.data(),C=f.includes(w.uid),L=document.createElement("label");L.className=`flex items-center p-2 rounded-lg ${C?"opacity-50 cursor-not-allowed":"hover:bg-gray-100 cursor-pointer"}`;const P=document.createElement("input");P.type="checkbox",P.value=w.uid,P.className="form-checkbox h-5 w-5 text-tomato rounded focus:ring-tomato",C&&(P.disabled=!0,P.checked=!0),L.appendChild(P);const M=document.createElement("img");M.src=w.photoURL||"https://placehold.co/40x40",M.alt=w.displayName,M.className="w-8 h-8 rounded-full ml-3 mr-3",L.appendChild(M);const p=document.createElement("span");if(p.className="font-medium",p.textContent=w.displayName||w.email,C){const H=document.createElement("span");H.className="text-xs text-gray-400 ml-2",H.textContent="(d√©j√† membre)",p.appendChild(H)}L.appendChild(p),V.friendsList.appendChild(L)}}}}catch(o){console.error("Erreur lors du chargement des amis pour l'invitation : ",o),V.friendsList.innerHTML='<p class="text-red-500">Une erreur est survenue.</p>'}V.confirmBtn.textContent="Envoyer l'invitation";const a=V.confirmBtn.cloneNode(!0);V.confirmBtn.parentNode.replaceChild(a,V.confirmBtn),V.confirmBtn=a,a.addEventListener("click",()=>Zn(e.id))}V.closeBtn?.addEventListener("click",yt);V.modal?.addEventListener("click",e=>{e.target===V.modal&&yt()});V.confirmBtn?.addEventListener("click",tn);const ea=Object.freeze(Object.defineProperty({__proto__:null,openInviteParticipantModal:nn,openShareModal:Ht},Symbol.toStringTag,{value:"Module"}));function ta(){const e=document.getElementById("search-bar"),t=document.getElementById("lists-container"),n=document.getElementById("add-list-btn"),a=document.getElementById("shared-lists-container"),o=document.getElementById("list-form-modal"),l=document.getElementById("list-modal-title"),c=document.getElementById("close-list-modal"),f=document.getElementById("cancel-list-btn"),y=document.getElementById("list-form"),x=document.getElementById("list-id"),w=document.getElementById("list-name"),C=document.getElementById("ingredients-list"),L=document.getElementById("add-ingredient-btn"),P=document.getElementById("save-list-btn");let M=[],p="",H=[],G=[];async function Me(){await z(),await R(),await T()}async function z(){if(b)try{H=(await pe(F(b,"ingredients"))).docs.map(B=>({id:B.id,...B.data()})),H.sort((B,Q)=>B.name.localeCompare(Q.name))}catch(U){console.error("Erreur lors de la r√©cup√©ration de la liste des ingr√©dients: ",U)}}async function R(){const U=ve();if(!(!b||!U))try{const B=ue(F(b,"shopping_lists"),te("userId","==",U));M=(await pe(B)).docs.map(J=>({id:J.id,...J.data()})).filter(J=>J.isShared!==!0),ye()}catch(B){console.error("Erreur de chargement des listes: ",B)}}async function T(){const U=ve();if(!(!b||!U)){console.log(`Recherche de listes partag√©es pour userId: ${U}`);try{const B=ue(F(b,"shopping_lists"),te("userId","==",U),te("isShared","==",!0)),Q=await pe(B);console.log(`Trouv√© ${Q.size} liste(s) partag√©e(s).`);const J=Q.docs.map(K=>({id:K.id,...K.data()}));Ce(J)}catch(B){console.error("Erreur de chargement des listes partag√©es: ",B)}}}async function O(U=null){await z(),y.reset(),C.innerHTML="",G=[],U?(l.textContent="Modifier la liste",x.value=U.id,w.value=U.name,U.ingredients&&U.ingredients.length>0?U.ingredients.forEach(B=>be(B)):be()):(l.textContent="Cr√©er une liste",x.value="",be()),o.classList.remove("hidden")}function X(){o.classList.add("hidden")}async function Le(U){U.preventDefault(),P.disabled=!0;const B=ve();if(!B){alert("Erreur : utilisateur non connect√©."),P.disabled=!1;return}const Q=G.filter(Z=>Z&&Z.name&&Z.quantity),J={name:w.value,ingredients:Q,userId:B};if(!J.name){alert("Le nom de la liste est requis."),P.disabled=!1;return}const K=x.value;try{K?await dt($(b,"shopping_lists",K),J):await Se(F(b,"shopping_lists"),J),X(),await R()}catch(Z){console.error("Erreur de sauvegarde de la liste: ",Z)}finally{P.disabled=!1}}function be(U={quantity:"",name:"",unit:""}){const B=document.createElement("div");B.className="relative flex items-stretch space-x-2 ingredient-row";const Q={...U};G.push(Q);const J=G.length-1,K=document.createElement("input");K.type="text",K.className="ingredient-quantity mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm",K.placeholder="Qt√©",K.value=Q.quantity,K.addEventListener("change",Ie=>{G[J].quantity=Ie.target.value});const Z=document.createElement("input");Z.type="text",Z.className="ingredient-unit mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm bg-gray-100",Z.placeholder="Unit√©",Z.readOnly=!0,Z.value=Q.unit||"";const me=document.createElement("div");me.className="relative w-1/2";const W=document.createElement("input");W.type="text",W.className="ingredient-name mt-1 block w-full rounded-md border-gray-300 shadow-sm",W.placeholder="Chercher un ingr√©dient...",W.value=Q.name,me.appendChild(W);const ie=document.createElement("div");ie.className="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto",me.appendChild(ie),W.addEventListener("input",()=>{const Ie=W.value.toLowerCase();if(!Ie){ie.classList.add("hidden");return}const q=H.filter(S=>S.name.toLowerCase().includes(Ie));ie.innerHTML="",q.forEach(S=>{const N=document.createElement("div");N.className="p-2 ingredient-search-item cursor-pointer",N.textContent=S.name,N.addEventListener("click",()=>{W.value=S.name,Z.value=S.unit,ie.classList.add("hidden"),G[J].name=S.name,G[J].unit=S.unit,G[J].id=S.id}),ie.appendChild(N)});const _=document.createElement("div");_.className="p-2 bg-blue-50 hover:bg-blue-200 cursor-pointer font-bold text-blue-700",_.textContent=`+ Cr√©er "${W.value}"`,_.addEventListener("click",async()=>{const S=W.value,N="pi√®ce(s)";try{const j=await Se(F(b,"ingredients"),{name:S,unit:N,category:"Inconnue"});await z(),W.value=S,Z.value=N,ie.classList.add("hidden"),G[J].name=S,G[J].unit=N,G[J].id=j.id}catch(j){console.error("Erreur d'ajout d'ingr√©dient",j),alert("L'ingr√©dient n'a pas pu √™tre cr√©√©.")}}),ie.appendChild(_),ie.classList.remove("hidden")});const oe=document.createElement("button");oe.type="button",oe.className="btn btn-ghost text-red-500 hover:bg-red-50 btn-sm mt-1",oe.innerHTML='<i class="fas fa-trash"></i>',oe.addEventListener("click",()=>{B.remove(),G[J]=null}),B.appendChild(me),B.appendChild(K),B.appendChild(Z),B.appendChild(oe),C.appendChild(B)}function ye(){t.innerHTML="";let U=M;if(p){const B=p.toLowerCase();U=M.filter(Q=>Q.name.toLowerCase().includes(B))}if(U.length===0){t.innerHTML='<p class="text-center text-gray-500 p-10 col-span-full">Aucune liste de courses trouv√©e.</p>';return}U.sort((B,Q)=>B.name.localeCompare(Q.name)),U.forEach(B=>{const Q=document.createElement("div");Q.className="bg-white rounded-lg shadow-md p-4 flex flex-col";const J=document.createElement("div");J.className="flex justify-between items-start border-b pb-2 mb-2";const K=document.createElement("h4");K.className="text-lg font-bold text-gray-800",K.textContent=B.name,J.appendChild(K);const Z=document.createElement("div");Z.className="flex space-x-2";const me=document.createElement("button");me.className="btn btn-ghost btn-sm text-blue-500",me.innerHTML='<i class="fas fa-edit"></i>',me.addEventListener("click",()=>O(B)),Z.appendChild(me);const W=document.createElement("button");W.className="btn btn-ghost btn-sm text-green-500",W.innerHTML='<i class="fas fa-share-alt"></i>',W.addEventListener("click",()=>Ht({})),Z.appendChild(W);const ie=document.createElement("button");ie.className="btn btn-ghost btn-sm text-red-500",ie.innerHTML='<i class="fas fa-trash"></i>',ie.addEventListener("click",()=>xe(B.id,B.name)),Z.appendChild(ie),J.appendChild(Z);const oe=document.createElement("ul");oe.className="space-y-1 text-sm text-gray-600 flex-grow",B.ingredients&&B.ingredients.length>0?B.ingredients.forEach(Ie=>{const q=document.createElement("li");q.textContent=`${Ie.quantity} ${Ie.unit||""} - ${Ie.name}`.trim(),oe.appendChild(q)}):oe.innerHTML='<li class="italic text-gray-400">Cette liste est vide.</li>',Q.appendChild(J),Q.appendChild(oe),t.appendChild(Q)})}function Ce(U){if(a.innerHTML="",U.length===0){a.innerHTML='<p class="text-center text-gray-500 p-10 col-span-full">Aucune liste de courses partag√©e trouv√©e.</p>';return}U.sort((B,Q)=>B.name.localeCompare(Q.name)),U.forEach(B=>{const Q=document.createElement("div");Q.className="bg-white rounded-lg shadow-md p-4 flex flex-col";const J=document.createElement("div");J.className="flex justify-between items-start border-b pb-2 mb-2";const K=document.createElement("h4");K.className="text-lg font-bold text-gray-800",K.textContent=B.name,J.appendChild(K);const Z=document.createElement("div");Z.className="flex space-x-2";const me=document.createElement("button");me.className="btn btn-secondary btn-sm",me.innerHTML='<i class="fas fa-copy mr-2"></i> Copier dans mes listes',me.title="Copier cette liste dans vos listes personnelles",me.addEventListener("click",()=>Re(B.id)),Z.appendChild(me);const W=document.createElement("button");W.className="btn btn-ghost btn-sm text-red-500",W.innerHTML='<i class="fas fa-trash"></i>',W.title="Supprimer cette liste partag√©e",W.addEventListener("click",()=>Ae(B.id,B.name)),Z.appendChild(W),J.appendChild(Z);const ie=document.createElement("ul");ie.className="space-y-1 text-sm text-gray-600 flex-grow",B.ingredients&&B.ingredients.length>0?B.ingredients.forEach(oe=>{const Ie=document.createElement("li");Ie.textContent=`${oe.quantity} ${oe.unit||""} - ${oe.name}`.trim(),ie.appendChild(Ie)}):ie.innerHTML='<li class="italic text-gray-400">Cette liste est vide.</li>',Q.appendChild(J),Q.appendChild(ie),a.appendChild(Q)})}async function xe(U,B){if(confirm(`√ätes-vous s√ªr de vouloir supprimer la liste "${B}" ?`))try{await He($(b,"shopping_lists",U)),await R()}catch(Q){console.error("Erreur de suppression de la liste: ",Q)}}async function Ae(U,B){if(confirm(`√ätes-vous s√ªr de vouloir supprimer la liste partag√©e "${B}" ?`))try{await He($(b,"shopping_lists",U)),await T()}catch(Q){console.error("Erreur de suppression de la liste partag√©e: ",Q),alert("Une erreur est survenue.")}}async function Re(U){if(confirm("Voulez-vous vraiment copier cette liste dans vos listes personnelles ? Elle ne sera plus consid√©r√©e comme une liste partag√©e."))try{const B=$(b,"shopping_lists",U);await ke(B,{isShared:!1}),await Me()}catch(B){console.error("Erreur lors de la copie de la liste: ",B),alert("Une erreur est survenue.")}}e.addEventListener("input",U=>{p=U.target.value,ye()}),n.addEventListener("click",()=>O()),c.addEventListener("click",X),f.addEventListener("click",X),y.addEventListener("submit",Le),L.addEventListener("click",()=>be()),b&&Me()}const na=Object.freeze(Object.defineProperty({__proto__:null,default:ta},Symbol.toStringTag,{value:"Module"})),Pe=kn();let ct,wt,Lt,ot,ce,ut,Ct,It,lt,Qe,mt,Bt,St,Nt,Tt,vt=null,bt=null;function Dt(){ct&&ct.classList.remove("hidden")}function rt(){ct&&ct.classList.add("hidden"),ot&&ot.reset()}function an(e,t){bt=e,Qe&&(Qe.value=t),ut&&ut.classList.remove("hidden"),Qe&&Qe.focus()}function it(){bt=null,ut&&ut.classList.add("hidden"),lt&&lt.reset()}function sn(e,t){vt=e,Nt&&(Nt.textContent="Confirmer la suppression"),Tt&&(Tt.textContent=`√ätes-vous s√ªr de vouloir supprimer le plan "${t}" ? Cette action est irr√©versible.`),mt&&mt.classList.remove("hidden")}function kt(){vt=null,mt&&mt.classList.add("hidden")}async function aa(e){const t=De();if(t)try{await Se(F(Pe,"plans"),{userId:t.uid,name:e,type:"personal",weeks:{},manualItems:[],defaultNumPeople:1,startDay:"Lundi",lastUpdated:new Date}),rt()}catch(n){console.error("Error creating plan: ",n),alert("Erreur lors de la cr√©ation du plan.")}}async function sa(e,t){if(!(!e||!t))try{const n=$(Pe,"plans",e);await ke(n,{name:t}),it()}catch(n){console.error("Error renaming plan: ",n),alert("Erreur lors du renommage du plan.")}}async function ra(e){const t=De()?.uid;if(!(!e||!t)&&confirm("Voulez-vous vraiment quitter ce plan partag√© ? Il n'appara√Ætra plus dans votre liste."))try{const n=$(Pe,"plans",e);await ke(n,{collaborators:Gt(t)})}catch(n){console.error("Erreur pour quitter le plan: ",n),alert("Une erreur est survenue.")}}async function ia(e){if(e)try{await He($(Pe,"plans",e))}catch(t){console.error("Error deleting plan: ",t),alert("Erreur lors de la suppression du plan.")}}function rn(e){const t=De();if(!t)return()=>{};let n=new Map;const a=()=>{e(Array.from(n.values()).sort((x,w)=>x.name.localeCompare(w.name)))},o=async x=>{const C=[x.userId,...x.collaborators||[]].map(P=>we($(Pe,"users",P)));return(await Promise.all(C)).map(P=>P.exists()?P.data():{uid:P.id,displayName:"Inconnu"})},l=ue(F(Pe,"plans"),te("userId","==",t.uid)),c=Fe(l,async x=>{const C=x.docChanges().map(async L=>{if(L.type==="removed")n.delete(L.doc.id);else{const P=L.doc.data(),M=await o(P);n.set(L.doc.id,{id:L.doc.id,...P,isOwner:!0,participants:M})}});await Promise.all(C),a()}),f=ue(F(Pe,"plans"),te("collaborators","array-contains",t.uid)),y=Fe(f,async x=>{const C=x.docChanges().map(async L=>{if(L.type==="removed")n.delete(L.doc.id);else{const P=L.doc.data(),M=await o(P),p=M.find(H=>H.uid===P.userId);n.set(L.doc.id,{id:L.doc.id,...P,isOwner:!1,ownerName:p?.displayName||"Inconnu",participants:M})}});await Promise.all(C),a()});return()=>{c(),y()}}function on(e){if(!ce)return;const t=ce.value;if(ce.innerHTML="",e.length===0){const n=document.createElement("option");n.value="",n.textContent="Aucun plan personnel",n.disabled=!0,ce.appendChild(n);return}e.forEach(n=>{const a=document.createElement("option");a.value=n.id;let o=n.name;n.collaborators&&n.collaborators.length>0&&(n.isOwner?o=`üëë ${n.name} [Collab]`:o=`üë• ${n.name} [Collab] (de ${n.ownerName})`),a.textContent=o,ce.appendChild(a)}),t&&ce.querySelector(`option[value="${t}"]`)?ce.value=t:ce.selectedIndex=0}function ln(){ct=document.getElementById("create-plan-modal"),wt=document.getElementById("close-create-plan-modal"),Lt=document.getElementById("cancel-create-plan-btn"),ot=document.getElementById("create-plan-form"),ce=document.getElementById("plan-select"),ut=document.getElementById("rename-plan-modal"),Ct=document.getElementById("close-rename-plan-modal"),It=document.getElementById("cancel-rename-plan-btn"),lt=document.getElementById("rename-plan-form"),Qe=document.getElementById("new-plan-name"),mt=document.getElementById("delete-confirm-modal"),Bt=document.getElementById("cancel-delete-btn"),St=document.getElementById("confirm-delete-btn"),Nt=document.getElementById("delete-confirm-title"),Tt=document.getElementById("delete-confirm-message");const e=document.getElementById("create-plan-btn"),t=document.getElementById("rename-plan-btn"),n=document.getElementById("leave-plan-btn"),a=document.getElementById("delete-plan-btn"),o=w=>{w.preventDefault();const C=document.getElementById("plan-name");C&&C.value&&aa(C.value)},l=w=>{w.preventDefault(),bt&&Qe.value&&sa(bt,Qe.value)},c=()=>{vt&&ia(vt).then(()=>{kt()})},f=()=>{if(ce&&ce.value){const w=ce.options[ce.selectedIndex];an(ce.value,w.text)}else alert("Veuillez s√©lectionner un plan √† renommer.")},y=()=>{ce&&ce.value?ra(ce.value):alert("Veuillez s√©lectionner un plan.")},x=()=>{if(ce&&ce.value){const w=ce.options[ce.selectedIndex].text;sn(ce.value,w)}else alert("Veuillez s√©lectionner un plan √† supprimer.")};return e?.addEventListener("click",Dt),t?.addEventListener("click",f),n?.addEventListener("click",y),a?.addEventListener("click",x),wt?.addEventListener("click",rt),Lt?.addEventListener("click",rt),ot?.addEventListener("submit",o),Ct?.addEventListener("click",it),It?.addEventListener("click",it),lt?.addEventListener("submit",l),Bt?.addEventListener("click",kt),St?.addEventListener("click",c),()=>{e?.removeEventListener("click",Dt),t?.removeEventListener("click",f),n?.removeEventListener("click",y),a?.removeEventListener("click",x),wt?.removeEventListener("click",rt),Lt?.removeEventListener("click",rt),ot?.removeEventListener("submit",o),Ct?.removeEventListener("click",it),It?.removeEventListener("click",it),lt?.removeEventListener("submit",l),Bt?.removeEventListener("click",kt),St?.removeEventListener("click",c)}}async function dn(e,t){if(!(!e||!t))try{const n=$(Pe,"plans",e);await ke(n,{collaborators:Mn(t),type:"collaborative"})}catch(n){console.error("Error adding collaborator: ",n)}}async function Pt(e,t,n="Modification diverse"){if(!e||!t)return;const a=De();if(a)try{const o=F(Pe,"plans",e,"history"),l=JSON.parse(JSON.stringify(t));await Se(o,{planState:l,timestamp:gt(),modifiedBy:a.uid,modifiedByName:a.displayName||a.email,description:n})}catch(o){console.error("Error saving history:",o)}}async function cn(e,t){const n=De();if(!(!n||!e||!t))try{const a=F(Pe,"plan_saves"),o=ue(a,te("userId","==",n.uid),te("name","==",e)),l=await pe(o);if(l.empty)await Se(a,{userId:n.uid,name:e,savedAt:gt(),planData:t});else{const c=l.docs[0].id,f=$(Pe,"plan_saves",c);await ke(f,{planData:t,savedAt:gt()})}}catch(a){console.error("Error saving or updating plan save:",a),alert("Erreur lors de la sauvegarde.")}}async function oa(e,t,n){if(!e||!t||!n)return;const a=$(Pe,"plans",e);try{await ke(a,{[`weeks.${t}`]:n,lastUpdated:new Date}),console.log(`Week ${t} of plan ${e} saved successfully.`)}catch(o){console.error("Error saving plan week:",o),alert("Erreur lors de la sauvegarde du plan.")}}const la=Object.freeze(Object.defineProperty({__proto__:null,addCollaborator:dn,getUserPlans:rn,initPlanManagement:ln,openCreatePlanModal:Dt,openDeleteConfirmModal:sn,openRenamePlanModal:an,populatePlanSelector:on,saveHistory:Pt,saveOrUpdatePlanSaveByName:cn,savePlanWeek:oa},Symbol.toStringTag,{value:"Module"}));let un=[],mn=[],pn=()=>{},fn=()=>{};const he={btn:null,badge:null,badgeMobile:null,dropdown:null,list:null};async function da(e,t,n){const a=ve();if(a)try{const o=$(b,"shares",e);if(await ke(o,{status:"accepted"}),t.plan){const l=n.displayName||"Inconnu",c=`Copie de "${t.plan.name}" (de ${l})`,f={...t.plan,userId:a,name:c,isShared:!0,originalOwnerId:t.senderId,sharedAt:new Date,collaborators:[]};delete f.id,await Se(F(b,"plans"),f)}t.shoppingList&&await Se(F(b,"shopping_lists"),{name:`${t.shoppingList.name} (de ${n.displayName})`,ingredients:t.shoppingList.ingredients,userId:a,isShared:!0,originalOwner:n.uid,sharedAt:new Date})}catch(o){console.error("Erreur lors de l'acceptation du partage : ",o),alert("Une erreur est survenue.")}}async function ca(e,t){const n=ve();if(!(!n||!t||!t.planId))try{await dn(t.planId,n);const a=$(b,"shares",e);await ke(a,{status:"accepted"})}catch(a){console.error("Erreur lors de l'acceptation de l'invitation : ",a),alert("Une erreur est survenue.")}}async function Jt(e){try{const t=$(b,"shares",e);await ke(t,{status:"declined"})}catch(t){console.error("Erreur lors du refus du partage : ",t),alert("Une erreur est survenue.")}}async function ua(e){try{await Zt(e)}catch{alert("Erreur lors de l'acceptation.")}}async function ma(e){try{await en(e)}catch{alert("Erreur lors du refus.")}}function gn(){if(!he.list)return;const e=[...un,...mn];e.sort((n,a)=>a.createdAt.toMillis()-n.createdAt.toMillis());const t=n=>{n&&(e.length>0?(n.textContent=e.length,n.classList.remove("hidden")):n.classList.add("hidden"))};t(he.badge),t(he.badgeMobile),he.list.innerHTML="",e.length===0?he.list.innerHTML='<p class="text-gray-500 text-center p-4">Aucune nouvelle notification.</p>':e.forEach(n=>{const a=pa(n);he.list.appendChild(a)})}function pa(e){const t=document.createElement("div");t.className="p-3 border-b border-gray-100 hover:bg-gray-50";const n=document.createElement("p");n.className="text-sm font-medium text-gray-800";const a=document.createElement("p");a.className="text-xs text-gray-500 mb-3";const o=document.createElement("div");o.className="flex space-x-2 justify-end";const l=e.data.type||e.type;if(l==="collaborative_plan_invite"){n.textContent="Invitation √† collaborer",a.textContent=`${e.sender.displayName} vous invite √† modifier son plan "${e.data.planName}".`;const c=Ye("Accepter","btn-secondary",y=>{y.target.textContent="...",y.target.disabled=!0,ca(e.id,e.data)}),f=Ye("Refuser","btn-ghost text-red-500",y=>{y.target.disabled=!0,Jt(e.id)});o.append(c,f)}else if(l==="share"){n.textContent=`Partage de ${e.sender.displayName||e.sender.email}`;let c=[];e.data.plan&&c.push("planification"),e.data.shoppingList&&c.push("liste de courses"),a.textContent=`Contenu : ${c.join(" et ")}`;const f=Ye("Accepter","btn-secondary",x=>{x.target.textContent="...",x.target.disabled=!0,da(e.id,e.data,e.sender)}),y=Ye("Refuser","btn-ghost text-red-500",x=>{x.target.disabled=!0,Jt(e.id)});o.append(f,y)}else if(l==="friend_request"){n.textContent="Invitation d'ami",a.textContent=`${e.sender.displayName||e.sender.email} vous a envoy√© une invitation.`;const c=Ye("Accepter","btn-secondary",y=>{y.target.textContent="...",y.target.disabled=!0,ua(e.id)}),f=Ye("Refuser","btn-ghost text-red-500",y=>{y.target.disabled=!0,ma(e.id)});o.append(c,f)}return t.append(n,a,o),t}function Ye(e,t,n){const a=document.createElement("button");return a.className=`btn btn-xs ${t}`,a.textContent=e,a.addEventListener("click",o=>{o.stopPropagation(),n(o)}),a}function fa(e){const t=F(b,"shares"),n=ue(t,te("receiverId","==",e),te("status","==","pending"));pn=Fe(n,async a=>{const o=[];for(const l of a.docs){const c=l.data(),f=await we($(b,"users",c.senderId));f.exists()&&o.push({type:c.type||"share",id:l.id,data:c,sender:f.data(),createdAt:c.createdAt})}un=o,gn()},a=>{console.error("Erreur d'√©coute des partages:",a)})}function ga(e){const t=F(b,"friend_requests"),n=ue(t,te("receiverId","==",e),te("status","==","pending"));fn=Fe(n,async a=>{const o=[];for(const l of a.docs){const c=l.data(),f=await we($(b,"users",c.senderId));f.exists()&&o.push({type:"friend_request",id:l.id,data:c,sender:f.data(),createdAt:c.createdAt})}mn=o,gn()},a=>{console.error("Erreur d'√©coute des invitations d'amis:",a)})}function hn(){if(he.btn=document.getElementById("notifications-btn"),he.badge=document.getElementById("notifications-badge"),he.badgeMobile=document.getElementById("notifications-badge-mobile"),he.dropdown=document.getElementById("notifications-dropdown"),he.list=document.getElementById("notifications-list"),!he.btn)return;const e=ve();e&&(pn(),fn(),fa(e),ga(e),he.btn.addEventListener("click",t=>{t.stopPropagation(),he.dropdown.classList.toggle("hidden")}),document.addEventListener("click",t=>{he.dropdown&&!he.dropdown.classList.contains("hidden")&&!he.btn.contains(t.target)&&!he.dropdown.contains(t.target)&&he.dropdown.classList.add("hidden")}))}const ha=Object.freeze(Object.defineProperty({__proto__:null,initNotifications:hn},Symbol.toStringTag,{value:"Module"}));let Oe=null,Ze=null;function vn(e,t){if(!Et||!e)return;const n=De();if(!n)return;const a=zt(Et,`plans_presence/${e}`);Oe=zt(Et,`plans_presence/${e}/${n.uid}`);const o={displayName:n.displayName||n.email,photoURL:n.photoURL,status:"idle",last_seen:Xt()};Nn(Oe).remove(),Tn(Oe,o),Ze&&Ze(),Ze=Dn(a,l=>{const c=l.val()||{};typeof t=="function"&&t(c)})}function bn(){Oe&&(Pn(Oe),Oe=null),Ze&&(Ze(),Ze=null)}function ft(e){Oe&&_n(Oe,{status:e,last_seen:Xt()})}const va=Object.freeze(Object.defineProperty({__proto__:null,connectToPresenceChannel:vn,disconnectFromPresenceChannel:bn,updateUserActivity:ft},Symbol.toStringTag,{value:"Module"}));let Ke=null;async function jt(e,t){if(!e)return;const n=$(b,"recipes",e);try{await ke(n,{isFavorite:!t})}catch(a){console.error("Error toggling favorite status:",a)}}function ba(){const e=document.getElementById("search-bar"),t=document.getElementById("category-tabs"),n=document.getElementById("recipe-list-container"),a=document.getElementById("add-recipe-btn");Ke&&Ke.destroy(),Ke=new $t(b,"recipe-form-modal","recipe-form","recipe-modal-title","recipe-id","recipe-name","recipe-category","recipe-servings","recipe-prep-time","recipe-difficulty","recipe-steps","ingredients-list","add-ingredient-btn","save-recipe-btn","close-recipe-modal","cancel-recipe-btn"),Ke.setOnSaveCallback(()=>{});let o=[],l="",c="",f=null;const y=["Entr√©e","Plat","Accompagnement","Dessert"],x={PLAT:"bg-orange-100",DESSERT:"bg-amber-100",ENTREE:"bg-lime-100",ACCOMPAGNEMENT:"bg-stone-200","PETIT-DEJEUNER":"bg-orange-100",BOISSON:"bg-cyan-100",SAUCE:"bg-red-100"},w={PLAT:"text-orange-800",DESSERT:"text-amber-800",ENTREE:"text-lime-800",ACCOMPAGNEMENT:"text-stone-800","PETIT-DEJEUNER":"text-orange-800",BOISSON:"text-cyan-800",SAUCE:"text-red-800"},C="bg-gray-100",L="text-gray-800";function P(){return b?Fe(F(b,"recipes"),R=>{console.log("Recipe data updated on /recipes page from listener."),o=R.docs.map(T=>({id:T.id,...T.data()})),p(),H()},R=>{console.error("Erreur lors de l'√©coute des recettes: ",R)}):()=>{}}function M(z){l=z,p(),H()}function p(){if(!t)return;t.innerHTML="";const R=[...new Set(o.map(T=>T.category||"Non class√©"))].sort((T,O)=>{const X=ye=>{const Ce=ye.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();for(let xe=0;xe<y.length;xe++)if(y[xe].normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()===Ce)return xe;return-1},Le=X(T),be=X(O);return Le>-1&&be>-1?Le-be:Le>-1?-1:be>-1?1:T.localeCompare(O)});!l&&R.length>0&&(l=R[0]),R.forEach(T=>{const O=document.createElement("button"),X=T.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toUpperCase();if(T===l){const be=x[X]||C,ye=w[X]||L;O.className=`px-4 py-2 text-sm font-bold rounded-t-lg ${be} ${ye}`}else O.className="px-4 py-2 text-sm font-medium text-gray-500 hover:text-tomato";O.textContent=T,O.addEventListener("click",()=>M(T)),t.appendChild(O)})}function H(){if(!n)return;n.innerHTML="";let z=o.filter(T=>(T.category||"Non class√©")===l);if(c){const T=c.toLowerCase();z=z.filter(O=>O.name.toLowerCase().includes(T))}if(z.sort((T,O)=>T.name.localeCompare(O.name)),z.length===0){n.innerHTML='<p class="text-gray-500 text-center p-10">Aucune recette trouv√©e.</p>';return}const R=document.createElement("div");R.className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4",z.forEach(T=>{R.appendChild(G(T))}),n.appendChild(R)}function G(z){const R=document.createElement("div");R.className="bg-white dark:bg-gray-800 shadow-md rounded-lg flex flex-col p-3";const T=document.createElement("div");T.className="w-full flex justify-between items-start";const O=document.createElement("h4");O.className="font-bold text-gray-800 dark:text-gray-200 pr-2",O.textContent=z.name,O.title=z.name,T.appendChild(O);const X=document.createElement("button");X.className="text-lg flex-shrink-0",X.innerHTML='<i class="fas fa-heart"></i>',z.isFavorite?X.classList.add("text-red-500"):X.classList.add("text-gray-300","dark:text-gray-500","hover:text-red-400"),X.addEventListener("click",Ae=>{Ae.stopPropagation(),jt(z.id,z.isFavorite)}),T.appendChild(X),R.appendChild(T);const Le=document.createElement("p");Le.className="text-sm text-gray-600 dark:text-gray-400 mt-1 w-full",Le.textContent=`${z.difficulty||""} - Pour ${z.servings||"?"} pers.`,R.appendChild(Le);const be=document.createElement("div");be.className="flex-grow",R.appendChild(be);const ye=document.createElement("div");ye.className="w-full flex justify-end items-center space-x-2 border-t dark:border-gray-700 pt-2 mt-2";const Ce=document.createElement("button");Ce.className="btn btn-ghost btn-sm text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/50",Ce.innerHTML='<i class="fas fa-edit"></i>',Ce.title="Modifier",Ce.addEventListener("click",()=>Ke.openForm(z,"Modifier la recette")),ye.appendChild(Ce);const xe=document.createElement("button");return xe.className="btn btn-ghost btn-sm text-red-500 hover:bg-red-50 dark:hover:bg-red-900/50",xe.innerHTML='<i class="fas fa-trash-alt"></i>',xe.title="Supprimer",xe.addEventListener("click",()=>Me(z.id,z.name)),ye.appendChild(xe),R.appendChild(ye),R}async function Me(z,R){if(confirm(`√ätes-vous s√ªr de vouloir supprimer la recette "${R}" ?`))try{await He($(b,"recipes",z)),fetchAllRecipes()}catch(T){console.error("Erreur lors de la suppression: ",T)}}if(a.addEventListener("click",()=>Ke.openForm(null,"Ajouter une recette")),e.addEventListener("input",z=>{const R=z.target.value;if(!c&&R&&(f=l),c=R,c){const T=c.toLowerCase(),O=o.find(X=>X.name.toLowerCase().includes(T));O&&(l=O.category||"Non class√©")}else f&&(l=f,f=null);p(),H()}),b)return P()}const ya=Object.freeze(Object.defineProperty({__proto__:null,default:ba,toggleFavoriteStatus:jt},Symbol.toStringTag,{value:"Module"}));let Ue=null;function xa(){const e={mealPlanGrid:document.getElementById("meal-plan-grid"),currentWeekDisplay:document.getElementById("current-week-display"),prevWeekBtn:document.getElementById("prev-week-btn"),nextWeekBtn:document.getElementById("next-week-btn"),clearMenuBtn:document.getElementById("clear-menu-btn"),shoppingListContainer:document.getElementById("shopping-list"),startDaySelect:document.getElementById("start-day-select"),defaultServingsControl:document.getElementById("default-servings-control"),mealSelectModal:document.getElementById("meal-select-modal"),closeMealSelectModalBtn:document.getElementById("close-meal-select-modal"),mealSelectModalTitle:document.getElementById("meal-select-modal-title"),mealSelectList:document.getElementById("meal-select-list"),recipeFormModal:document.getElementById("edit-recipe-form-modal"),closeRecipeModalBtn:document.getElementById("close-edit-recipe-modal"),cancelRecipeBtn:document.getElementById("edit-cancel-recipe-btn"),recipeForm:document.getElementById("edit-recipe-form"),addItemInput:document.getElementById("add-item-input"),addItemBtn:document.getElementById("add-item-btn"),addItemResults:document.getElementById("add-item-results"),importListBtn:document.getElementById("import-list-btn"),importListModal:document.getElementById("import-list-modal"),closeImportListModalBtn:document.getElementById("close-import-list-modal"),importListContainer:document.getElementById("import-list-container"),exportTxtBtn:document.getElementById("export-txt-btn"),exportPdfBtn:document.getElementById("export-pdf-btn"),exportPlanPdfBtn:document.getElementById("export-plan-pdf-btn"),sharePlanBtn:document.getElementById("share-plan-btn"),planSelect:document.getElementById("plan-select"),inviteParticipantBtn:document.getElementById("invite-participant-btn"),historyPlanBtn:document.getElementById("history-plan-btn"),planHistoryModal:document.getElementById("plan-history-modal"),closePlanHistoryModalBtn:document.getElementById("close-plan-history-modal"),planHistoryList:document.getElementById("plan-history-list"),savePlanBtn:document.getElementById("save-plan-btn")};function t(s,i){const d=document.createElement("div");d.className="flex items-center space-x-2";const u=document.createElement("button");u.className="btn btn-outline btn-xs",u.textContent="-";const r=document.createElement("span");r.className="font-medium text-center w-6",r.textContent=s;const g=document.createElement("button");return g.className="btn btn-outline btn-xs",g.textContent="+",u.addEventListener("click",()=>{let h=parseInt(r.textContent,10);h>1&&(h--,r.textContent=h,i(h))}),g.addEventListener("click",()=>{let h=parseInt(r.textContent,10);h++,r.textContent=h,i(h)}),d.appendChild(u),d.appendChild(r),d.appendChild(g),d}function n(s,i,d,u=!1){const r=document.createElement("div");r.className="flex flex-col items-center justify-center h-full";const g=document.createElement("button");g.className="btn btn-ghost btn-xs p-0 h-4 flex items-center justify-center w-full",g.innerHTML='<i class="fas fa-plus"></i>',g.disabled=u;const h=document.createElement("span");h.className="font-medium text-center text-sm my-1",h.textContent=s;const m=document.createElement("button");return m.className="btn btn-ghost btn-xs p-0 h-4 flex items-center justify-center w-full",m.innerHTML='<i class="fas fa-minus"></i>',m.disabled=u,i&&(g.classList.add("text-white"),h.classList.add("text-white"),m.classList.add("text-white")),u||(g.addEventListener("click",()=>{let v=parseInt(h.textContent,10);v++,h.textContent=v,d(v)}),m.addEventListener("click",()=>{let v=parseInt(h.textContent,10);v>1&&(v--,h.textContent=v,d(v))})),r.appendChild(g),r.appendChild(h),r.appendChild(m),r}Ue&&Ue.destroy(),Ue=new $t(b,"edit-recipe-form-modal","edit-recipe-form","edit-recipe-modal-title","edit-recipe-id","edit-recipe-name","edit-recipe-category","edit-recipe-servings","edit-recipe-prep-time","edit-recipe-difficulty","edit-recipe-steps","edit-ingredients-list","edit-add-ingredient-btn","edit-save-recipe-btn","close-edit-recipe-modal","edit-cancel-recipe-btn"),Ue.setActivityUpdater(ft),Ue.setOnSaveCallback(async()=>{});let a=1,o="Lundi",l={},c={},f={};const y=[];let x=null,w=[],C=[],L=1,P=null,M=[],p=null;const H=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];function G(s){return s?s.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase():""}async function Me(s){const i=document.getElementById("unit-select-modal"),d=document.getElementById("unit-modal-title"),u=document.getElementById("unit-modal-list"),r=document.getElementById("unit-modal-cancel");return d.textContent=`Choisir une unit√© pour "${s}"`,u.innerHTML="",new Promise((g,h)=>{const m=["g","kg","ml","l","pi√®ce(s)","c.√†.s.","c.√†.c.","pinc√©e(s)"],v=E=>{i.classList.add("hidden"),g(E)};m.forEach(E=>{const I=document.createElement("button");I.className="btn btn-outline",I.textContent=E,I.addEventListener("click",()=>v(E)),u.appendChild(I)});const k=()=>{i.classList.add("hidden"),h()};r.addEventListener("click",k,{once:!0}),i.addEventListener("click",E=>{E.target===i&&k()},{once:!0}),i.classList.remove("hidden")})}async function z(){if(b)try{C=(await pe(F(b,"ingredients"))).docs.map(i=>({id:i.id,...i.data()})),C.sort((i,d)=>i.name.localeCompare(d.name))}catch(s){console.error("Erreur lors de la r√©cup√©ration des ingr√©dients: ",s)}}function R(){if(!p)l={},c={},f={},L=1,o="Lundi";else{const s=p.weeks?p.weeks[a]||{}:{};l=s.menuData||{},c=s.servingsData||{},f=s.remarksData||{},L=p.defaultNumPeople||1,o=p.startDay||"Lundi"}if(e.startDaySelect&&(e.startDaySelect.value=o),e.defaultServingsControl){e.defaultServingsControl.innerHTML="";const s=t(L,async i=>{L=i,p&&await T({defaultNumPeople:i},`a chang√© le nombre de personnes par d√©faut √† ${i}`)});e.defaultServingsControl.appendChild(s)}En(),Ce(e.mealPlanGrid,{menuData:l,servingsData:c,remarksData:f,defaultNumPeople:L,startDay:o},!1),ye(document.getElementById("mobile-meal-plan"),{menuData:l,servingsData:c,remarksData:f,defaultNumPeople:L,startDay:o},!1),W()}async function T(s,i){if(!p)return;await Pt(p.id,p,i);const d=$(b,"plans",p.id);try{await ke(d,{...s,lastUpdated:new Date})}catch(u){console.error("Error updating plan:",u),alert("Une erreur de sauvegarde est survenue.")}}function O(){e.planHistoryModal.classList.add("hidden")}async function X(s){if(p&&confirm("Voulez-vous vraiment restaurer cette version ? L'√©tat actuel sera sauvegard√© dans l'historique avant la restauration."))try{const i=$(b,"plans",p.id,"history",s),d=await we(i);if(!d.exists())throw new Error("Version de l'historique non trouv√©e.");const u=d.data().planState;await Pt(p.id,p);const r=$(b,"plans",p.id);await dt(r,u),O()}catch(i){console.error("Erreur lors du rollback :",i)}}async function Le(s,i){if(p&&confirm("√ätes-vous s√ªr de vouloir supprimer d√©finitivement cette entr√©e de l'historique ?"))try{const d=$(b,"plans",p.id,"history",s);await He(d),i.remove()}catch(d){console.error("Erreur lors de la suppression de l'historique :",d),alert("Une erreur est survenue lors de la suppression.")}}async function be(){if(p){e.planHistoryList.innerHTML="<p>Chargement de l'historique...</p>",e.planHistoryModal.classList.remove("hidden");try{const s=F(b,"plans",p.id,"history"),i=ue(s,$n("timestamp","desc")),d=await pe(i);if(e.planHistoryList.innerHTML="",d.empty){e.planHistoryList.innerHTML="<p>Aucun historique pour ce plan.</p>";return}d.forEach(u=>{const r=u.data(),g=document.createElement("div");g.className="p-3 border-b flex justify-between items-center";const h=document.createElement("div"),m=r.timestamp?.toDate().toLocaleString("fr-FR")||"Date inconnue",v=r.description||"Modification diverse",k=r.modifiedByName||"Inconnu";h.innerHTML=`
                    <p class="font-medium">${k} ${v}</p>
                    <p class="text-sm text-gray-500">${m}</p>
                `;const E=document.createElement("div");E.className="flex items-center space-x-2";const I=document.createElement("button");I.className="btn btn-secondary btn-sm",I.textContent="Revenir √† cette version",I.addEventListener("click",()=>X(u.id));const D=document.createElement("button");D.className="btn btn-ghost text-red-500 hover:bg-red-100 btn-sm",D.innerHTML='<i class="fas fa-times"></i>',D.title="Supprimer cette version",D.addEventListener("click",A=>{A.stopPropagation(),Le(u.id,g)}),E.appendChild(I),E.appendChild(D),g.appendChild(h),g.appendChild(E),e.planHistoryList.appendChild(g)})}catch(s){console.error("Erreur de chargement de l'historique:",s),e.planHistoryList.innerHTML=`<p class="text-red-500">Impossible de charger l'historique.</p>`}}}function ye(s,i,d=!1){if(!s)return;const u=i.menuData||{},r=i.servingsData||{};i.remarksData;const g=i.defaultNumPeople||1,h=i.startDay||"Lundi";s.innerHTML="";const m=document.createDocumentFragment(),v=H.indexOf(h);[...H.slice(v),...H.slice(0,v)].forEach(E=>{const I=H.indexOf(E),D=document.createElement("div");D.className="bg-blue-100 border border-blue-300 rounded-xl shadow-md p-4 mb-4";const A=document.createElement("h3");A.className="text-xl font-bold text-gray-800 mb-3",A.textContent=E.toUpperCase(),D.appendChild(A);const ae=document.createElement("div");ae.className="space-y-4",["lunch","dinner"].forEach(se=>{const le=document.createElement("div");le.className="border-t pt-3";const de=document.createElement("div");de.className="flex justify-between items-center mb-2";const fe=document.createElement("h4");if(fe.className="text-lg font-semibold text-tomato",fe.textContent=se==="lunch"?"Midi":"Soir",de.appendChild(fe),!d){const Y=`${I}-${se}`,re=r[Y]||g,ge=t(re,Be=>{Ft(Y,Be)});de.appendChild(ge)}le.appendChild(de);const ee=document.createElement("div");ee.className="space-y-2";let Ne=!1;for(let Y=0;Y<4;Y++){const re=`${I}-${se}-${Y}`,ge=u[re];Array.isArray(ge)&&ge.length>0&&(Ne=!0,ge.forEach((Be,Te)=>{const _e=w.find(Ee=>Ee.id===Be.id);if(_e){const Ee=ne(_e,re,Te,d);if(Ee.classList.remove("bg-white","shadow-sm"),Ee.classList.add("bg-emerald-200","border","border-emerald-400"),!d){const tt=Ee.querySelector(".edit-meal-btn"),qe=Ee.querySelector(".delete-meal-btn");tt&&tt.classList.remove("hidden"),qe&&qe.classList.remove("hidden")}ee.appendChild(Ee)}}))}if(!d){const Y=document.createElement("button");Y.className="btn btn-outline btn-sm w-full mt-2",Y.innerHTML='<i class="fas fa-plus mr-2"></i> Ajouter un plat',Y.addEventListener("click",()=>{const re=`${I}-${se}-1`;ie(re)}),ee.appendChild(Y)}!Ne&&d&&(ee.innerHTML='<p class="text-sm text-gray-500 italic">Aucun plat pr√©vu.</p>'),le.appendChild(ee),ae.appendChild(le)}),D.appendChild(ae),m.appendChild(D)}),s.appendChild(m)}function Ce(s,i,d=!1){if(!s)return;const u=i.menuData||{},r=i.servingsData||{},g=i.remarksData||{},h=i.defaultNumPeople||1,m=i.startDay||"Lundi",v=document.createDocumentFragment(),k=["lunch","dinner"],E=5,I=H.indexOf(m);[...H.slice(I),...H.slice(0,I)].forEach(A=>{const ae=H.indexOf(A),se=document.createElement("div");se.className="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] items-stretch border-b border-gray-300";const le=document.createElement("div");le.className="font-bold p-2 flex items-center justify-center bg-gray-100 text-sm border-r border-gray-300",le.textContent=A.toUpperCase(),se.appendChild(le),k.forEach(de=>{const fe=`${ae}-${de}`,ee=r[fe]||h,Ne=r.hasOwnProperty(fe),Y=document.createElement("div"),re=n(ee,Ne,Be=>{Ft(fe,Be)},d);let ge="border-r border-gray-300 flex items-center justify-center transition-colors duration-300";Ne?ge+=" bg-tomato":ge+=de==="lunch"?" bg-amber-50":" bg-stone-100",Y.className=ge,Y.appendChild(re),se.appendChild(Y);for(let Be=0;Be<E;Be++){const Te=`${ae}-${de}-${Be}`,_e=u[Te],Ee=document.createElement("div"),tt=j(Te);let qe="meal-slot p-1 min-h-[70px] flex flex-col justify-start border-r border-gray-300";if(qe+=de==="lunch"?" bg-amber-50":" bg-stone-100",Ee.className=qe,Ee.dataset.slotId=Te,tt==="Remarque")Ee.appendChild(We(Te,g,d));else if(Array.isArray(_e)&&_e.length>0){const Ve=document.createElement("div");Ve.className="w-full",_e.forEach((nt,at)=>{const $e=w.find(st=>st.id===nt.id);if($e)Ve.appendChild(ne($e,Te,at,d));else{const st=document.createElement("div");st.className="p-1 bg-red-100 text-red-700 rounded shadow-sm text-center text-xs font-medium",st.textContent="Recette supprim√©e",Ve.appendChild(st)}}),Ee.appendChild(Ve),d||Ee.appendChild(Je(Te,!0))}else d||Ee.appendChild(Je(Te,!1));se.appendChild(Ee)}}),v.appendChild(se)}),s.innerHTML="",s.appendChild(v),d||Ge()}async function xe(){const s=ve();if(!b||!s)return[];try{const i=ue(F(b,"shopping_lists"),te("userId","==",s));return(await pe(i)).docs.map(g=>({id:g.id,...g.data()})).filter(g=>g.isShared!==!0)}catch(i){return console.error("Erreur de chargement des listes de courses sauvegard√©es: ",i),[]}}async function Ae(){const s=await xe();if(e.importListContainer.innerHTML="",s.length===0){e.importListContainer.innerHTML='<p class="text-center text-gray-500">Aucune liste sauvegard√©e.</p>';return}s.forEach(i=>{const d=document.createElement("button");d.className="w-full text-left p-2 hover:bg-gray-100 rounded-lg transition-colors duration-150",d.textContent=i.name,d.addEventListener("click",()=>{confirm(`Voulez-vous vraiment importer les ingr√©dients de la liste "${i.name}" ?`)&&(i.ingredients.forEach(u=>{const r=parseFloat(String(u.quantity).replace(",","."))||0;K(u.name,r,u.unit)}),Re())}),e.importListContainer.appendChild(d)}),e.importListModal.classList.remove("hidden")}function Re(){e.importListModal.classList.add("hidden")}function U(){e.addItemInput?.addEventListener("input",()=>{const s=e.addItemInput.value.toLowerCase(),i=e.addItemResults;if(i.innerHTML="",!s){i.classList.add("hidden");return}C.filter(r=>r.name.toLowerCase().includes(s)).forEach(r=>{const g=document.createElement("div");g.className="p-2 hover:bg-gray-100 cursor-pointer",g.textContent=r.name,g.addEventListener("click",()=>{K(r.name,1,r.unit),e.addItemInput.value="",i.classList.add("hidden")}),i.appendChild(g)});const u=document.createElement("div");u.className="p-2 bg-green-50 hover:bg-green-200 cursor-pointer font-bold text-green-700",u.textContent=`+ Cr√©er "${e.addItemInput.value}"`,u.addEventListener("click",async()=>{const r=e.addItemInput.value;try{const g=await Me(r);await Se(F(b,"ingredients"),{name:r,unit:g}),await z(),K(r,1,g),e.addItemInput.value="",i.classList.add("hidden")}catch{}}),i.appendChild(u),i.classList.remove("hidden")}),e.addItemBtn?.addEventListener("click",()=>{const s=e.addItemInput.value;s&&(K(s,1,""),e.addItemInput.value="",e.addItemResults.classList.add("hidden"))}),document.addEventListener("click",s=>{e.addItemInput&&!e.addItemInput.contains(s.target)&&!e.addItemResults.contains(s.target)&&e.addItemResults.classList.add("hidden")})}function B(){if(y.length===0){alert("La liste de courses est vide.");return}const s=y.reduce((r,g)=>{const h=g.category||"Inconnue";return r[h]||(r[h]=[]),r[h].push(g),r},{}),i=Object.keys(s).sort((r,g)=>r==="Inconnue"?1:g==="Inconnue"?-1:r.localeCompare(g));let d=`Liste de courses - GustoPlan

`;i.forEach(r=>{d+=`--- ${r.toUpperCase()} ---
`,s[r].sort((h,m)=>h.name.localeCompare(m.name)).forEach(h=>{let v=`${Number.isInteger(h.totalQuantity)?h.totalQuantity:parseFloat(h.totalQuantity.toFixed(2))} ${h.unit||""} ${h.name}`;if(h.sources&&h.sources.length>0){const k=h.sources.reduce((I,D)=>{const A=`${D.recipeName} (${D.day} ${D.time})`;return I[A]||(I[A]=0),I[A]+=D.quantity,I},{}),E=Object.keys(k).join(" / ");v+=` *** ${E} ***`}d+=v+`
`}),d+=`
`});const u=new Blob([d],{type:"text/plain;charset=utf-8"});saveAs(u,"liste-de-courses.txt")}function Q(){if(y.length===0){alert("La liste de courses est vide.");return}const{jsPDF:s}=window.jspdf,i=new s,d=y.reduce((v,k)=>{const E=k.category||"Inconnue";return v[E]||(v[E]=[]),v[E].push(k),v},{}),u=Object.keys(d).sort((v,k)=>v==="Inconnue"?1:k==="Inconnue"?-1:v.localeCompare(k));i.setFontSize(18),i.text("Liste de courses - GustoPlan",14,22);let r=35;const g=i.internal.pageSize.height,h=20,m=()=>{r>g-h&&(i.addPage(),r=20)};u.forEach(v=>{m(),i.setFontSize(14),i.setFont(void 0,"bold"),i.text(`--- ${v.toUpperCase()} ---`,14,r),r+=8,i.setFont(void 0,"normal"),d[v].sort((E,I)=>E.name.localeCompare(I.name)).forEach(E=>{m(),i.setFontSize(12);const I=Number.isInteger(E.totalQuantity)?E.totalQuantity:parseFloat(E.totalQuantity.toFixed(2));if(i.text(`${I} ${E.unit||""} ${E.name}`,14,r),r+=6,E.sources&&E.sources.length>0){const D=E.sources.reduce((A,ae)=>{const se=`${ae.recipeName} (${ae.day} ${ae.time})`;return A[se]||(A[se]=0),A[se]+=ae.quantity,A},{});i.setFontSize(9),i.setTextColor(100);for(const A in D)m(),i.text(`  * ${A}`,18,r),r+=5;i.setTextColor(0)}r+=2}),r+=5}),i.save("liste-de-courses.pdf")}async function J(){if(!p){alert("Veuillez s√©lectionner un plan √† exporter.");return}const s=document.getElementById("loading-overlay");s&&s.classList.remove("hidden");try{const{jsPDF:i}=window.jspdf,d=new i,u=$(b,"plans",p.id),r=await we(u),g=r.exists()?r.data():null;if(!g||!g.weeks){alert("Ce plan est vide et ne peut pas √™tre export√©.");return}d.setFontSize(18),d.text(`Plan de Repas: ${g.name}`,14,20);const h=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"],m={0:"E",1:"P",2:"A",3:"D"},v=Object.keys(g.weeks).sort((E,I)=>parseInt(E)-parseInt(I));let k=!0;for(const E of v){const D=g.weeks[E].menuData||{};if(Object.keys(D).length===0)continue;const A=[["Jour","Midi","Soir"]],ae=[],se=h.indexOf(g.startDay||"Lundi"),le=[...h.slice(se),...h.slice(0,se)];for(const fe of le){const ee=h.indexOf(fe);let Ne=[],Y=[];for(const re of["lunch","dinner"])for(const ge in m){const Be=`${ee}-${re}-${ge}`;D[Be]&&Array.isArray(D[Be])&&D[Be].forEach(Te=>{const _e=`[${m[ge]}] ${Te.name}`;re==="lunch"?Ne.push(_e):Y.push(_e)})}ae.push([fe,Ne.join(`
`)||"-",Y.join(`
`)||"-"])}d.setFontSize(14);const de=k?30:d.autoTable.previous.finalY+20;d.text(`Semaine ${E}`,14,de-5),d.autoTable({startY:de,head:A,body:ae,theme:"grid",styles:{cellPadding:2,fontSize:8,valign:"middle"},headStyles:{fillColor:[41,128,185],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[245,245,245]}}),k=!1}d.save(`plan_${g.name.replace(/ /g,"_")}.pdf`)}catch(i){console.error("Erreur lors de la g√©n√©ration du PDF du plan :",i),alert("Une erreur est survenue lors de la cr√©ation du PDF.")}finally{s&&s.classList.add("hidden")}}async function K(s,i,d,u=!1){if(!p)return alert("Veuillez s√©lectionner un plan.");const r=$(b,"plans",p.id);try{await Hn(b,async g=>{const h=await g.get(r);if(!h.exists())throw"Le plan n'existe plus.";const m=h.data().manualItems||[],v=`${s.trim().toLowerCase()}_${d||""}`,k=m.findIndex(I=>`${I.name.trim().toLowerCase()}_${I.unit||""}`===v);if(k>-1)m[k].totalQuantity+=i;else{const I=C.find(D=>D.name.toLowerCase()===s.trim().toLowerCase());m.push({name:s.trim(),totalQuantity:i,unit:d,source:"manual",category:I?.category||"Inconnue"})}const E=m.filter(I=>I.totalQuantity!==0);g.update(r,{manualItems:E,lastUpdated:new Date})})}catch(g){console.error("Erreur transactionnelle lors de l'ajustement de l'ingr√©dient: ",g),alert("Une erreur de synchronisation est survenue. Veuillez r√©essayer.")}}function Z(s){const i=s?s.toLowerCase():"";return i.includes("g")||i.includes("ml")?10:1}function me(){const s=e.shoppingListContainer;if(!s)return;if(s.innerHTML="",y.length===0){s.innerHTML='<p class="text-center text-gray-500 italic py-4">Votre liste de courses est vide.</p>';return}const i=y.reduce((u,r)=>{const g=r.category||"Inconnue";return u[g]||(u[g]=[]),u[g].push(r),u},{});Object.keys(i).sort((u,r)=>u==="Inconnue"?1:r==="Inconnue"?-1:u.localeCompare(r)).forEach(u=>{const r=document.createElement("h4");r.className="text-sm font-bold text-stone-800 bg-stone-200 mt-4 mb-2 px-3 py-1 rounded-md",r.textContent=u,s.appendChild(r);const g=document.createElement("ul");g.className="space-y-2",i[u].sort((m,v)=>m.name.localeCompare(v.name)).forEach(m=>{const v=document.createElement("li");let k="p-2 rounded";v.className=k+(m.source==="manual"?" bg-lemon":" bg-gray-50");const E=document.createElement("div");E.className="flex justify-between items-center";const I=document.createElement("span");I.className="flex-grow text-sm font-medium",I.textContent=m.name,E.appendChild(I);const D=document.createElement("div");D.className="flex items-center space-x-2 mx-2";const A=document.createElement("span");A.className="font-medium w-20 text-center text-sm";const ae=Number.isInteger(m.totalQuantity)?m.totalQuantity:parseFloat(m.totalQuantity.toFixed(2));A.textContent=`${ae} ${m.unit||""}`.trim();const se=document.createElement("div");se.className="flex flex-col";const le=document.createElement("button");le.className="btn btn-outline btn-xs rounded-b-none",le.textContent="+",le.addEventListener("click",async()=>{const ee=Z(m.unit);await K(m.name,ee,m.unit)});const de=document.createElement("button");de.className="btn btn-outline btn-xs rounded-t-none -mt-px",de.textContent="-",de.addEventListener("click",async()=>{const ee=Z(m.unit);await K(m.name,-ee,m.unit)}),se.appendChild(le),se.appendChild(de),D.appendChild(A),D.appendChild(se),E.appendChild(D);const fe=document.createElement("button");if(fe.className="delete-item-btn text-red-500 hover:text-red-700",fe.innerHTML='<i class="fas fa-trash-alt"></i>',fe.addEventListener("click",()=>{K(m.name,-m.totalQuantity,m.unit,!0)}),E.appendChild(fe),v.appendChild(E),m.sources&&m.sources.length>0){const ee=document.createElement("div");ee.className="p-2 mt-1 ml-4 rounded-md bg-stone-100";const Ne=m.sources.reduce((Y,re)=>{const ge=`${re.recipeName} (${re.day} ${re.time})`;return Y[ge]||(Y[ge]=0),Y[ge]+=re.quantity,Y},{});for(const Y in Ne){const re=document.createElement("span");re.className="block text-xs text-gray-500",re.textContent=`‚Ü≥ ${Y}`,ee.appendChild(re)}v.appendChild(ee)}g.appendChild(v)}),s.appendChild(g)})}async function W(){if(!p){y.length=0,me();return}const s=p.manualItems?JSON.parse(JSON.stringify(p.manualItems)):[],i=new Map(s.map(r=>[`${r.name.trim().toLowerCase()}_${r.unit||""}`,r])),d=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];if(p.weeks)for(const r in p.weeks){const g=p.weeks[r],h=g.menuData||{},m=g.servingsData||{};for(const v in h){const k=h[v];if(!Array.isArray(k))continue;const[E,I]=v.split("-"),D=parseInt(E,10),A=d[D]||"Jour inconnu",ae=I==="lunch"?"midi":"soir",se=`${D}-${I}`,le=parseInt(m[se]||p.defaultNumPeople,10);for(const de of k){const ee=w.find(Y=>Y.id===de.id)||de;if(!ee||!Array.isArray(ee.ingredients))continue;const Ne=ee.servings||1;Ne<=0||ee.ingredients.forEach(Y=>{const{name:re,quantity:ge,unit:Be}=Y;if(!re||!ge)return;const Te=C.find($e=>$e.name.toLowerCase()===re.trim().toLowerCase()),_e=Te?Te.category:"Inconnue",Ee=parseFloat(String(ge).replace(",","."));if(isNaN(Ee))return;const qe=Ee/Ne*le,Ve=Be||"",nt=`${re.trim().toLowerCase()}_${Ve}`,at={recipeName:ee.name,day:`${A} (S${r})`,time:ae,quantity:qe};if(i.has(nt)){const $e=i.get(nt);$e.totalQuantity+=qe,$e.source==="manual"&&($e.source="mixed"),Array.isArray($e.sources)?$e.sources.push(at):$e.sources=[at]}else i.set(nt,{name:re.trim(),totalQuantity:qe,unit:Ve,source:"plan",category:_e,sources:[at]})})}}}const u=Array.from(i.values()).filter(r=>r.totalQuantity>0);y.length=0,y.push(...u.sort((r,g)=>r.name.localeCompare(g.name))),me()}function ie(s){const i=j(s);if(!i||!e.mealSelectModal)return;e.mealSelectModalTitle.textContent=`S√©lectionner : ${i}`,e.mealSelectList.innerHTML="";const d=document.createElement("input");d.type="text",d.placeholder="Rechercher dans la cat√©gorie...",d.className="w-full p-2 mb-4 border border-gray-300 rounded-lg",e.mealSelectList.appendChild(d);const u=G(i),r=w.filter(m=>G(m.category)===u).sort((m,v)=>{const k=m.isFavorite?1:0,E=v.isFavorite?1:0;return E!==k?E-k:m.name.localeCompare(v.name)}),g=document.createElement("div");g.className="space-y-1 max-h-80 overflow-y-auto",e.mealSelectList.appendChild(g);function h(m=""){g.innerHTML="";const v=m.toLowerCase(),k=r.filter(E=>E.name.toLowerCase().includes(v));k.length===0?g.innerHTML='<p class="text-gray-500 p-4">Aucun plat ne correspond √† votre recherche.</p>':k.forEach(E=>{const I=document.createElement("button");I.className="w-full text-left p-2 hover:bg-gray-100 rounded-lg transition-colors duration-150";const D=document.createElement("p");D.className="font-medium text-gray-800 text-sm",E.isFavorite?D.innerHTML=`${E.name} <i class="fas fa-heart text-red-500 ml-2"></i>`:D.textContent=E.name,I.appendChild(D),I.addEventListener("click",()=>{Xe(s,E),oe()}),g.appendChild(I)})}d.addEventListener("input",m=>h(m.target.value)),h(),e.mealSelectModal.classList.remove("hidden"),d.focus()}function oe(){e.mealSelectModal&&e.mealSelectModal.classList.add("hidden")}function Ie(s){x=s.target.closest(".meal-card");const i=x.closest(".meal-slot").dataset.slotId;s.dataTransfer.setData("text/plain",i),setTimeout(()=>{x&&(x.style.opacity="0.5")},0)}function q(){x&&(x.style.opacity="1",x=null)}function _(s){s.preventDefault();const i=s.target.closest(".meal-slot");i&&j(i.dataset.slotId)!=="Remarque"&&i.classList.add("bg-gray-200")}function S(s){const i=s.target.closest(".meal-slot");i&&i.classList.remove("bg-gray-200")}async function N(s){s.preventDefault();const i=s.dataTransfer.getData("text/plain"),d=s.target.closest(".meal-slot");if(d){d.classList.remove("bg-gray-200");const u=d.dataset.slotId,r=j(u);if(r==="Remarque")return;if(i&&u&&i!==u){const g=l[i],h=j(i);if(G(h)!==G(r)){alert(`Action impossible : un(e) "${h}" ne peut pas aller dans la cat√©gorie "${r}".`);return}const m=l[u];l[u]=g,m?l[i]=m:delete l[i],Ce(e.mealPlanGrid,{menuData:l,servingsData:c,remarksData:f,defaultNumPeople:L,startDay:o},!1),await T({[`weeks.${a}.menuData`]:l},"a d√©plac√© un plat"),await W()}}}function j(s){switch(s.split("-")[2]){case"0":return"Entr√©e";case"1":return"Plat";case"2":return"Accompagnement";case"3":return"Dessert";case"4":return"Remarque";default:return""}}function ne(s,i,d,u=!1){const r=document.createElement("div");if(r.className="meal-card p-1 flex flex-col items-center bg-white rounded shadow-sm text-center relative w-full mb-1",u||(r.classList.add("cursor-grab"),r.draggable=!0),!u){const v=document.createElement("button");v.className="absolute -top-2 -right-1 text-base",v.innerHTML='<i class="fas fa-heart"></i>',s.isFavorite?v.classList.add("text-red-500"):v.classList.add("text-gray-300","hover:text-red-400"),v.addEventListener("click",k=>{k.stopPropagation(),jt(s.id,s.isFavorite)}),v.addEventListener("mousedown",k=>k.stopPropagation()),r.appendChild(v)}const g=document.createElement("span");if(g.className="text-xs font-medium p-1 break-words w-full",g.textContent=s.name,r.appendChild(g),!u){const v=document.createElement("div");v.className="absolute top-0 left-0 flex";const k=document.createElement("button");k.className="edit-meal-btn text-gray-600 hover:text-gray-800 hidden px-1 py-0.5",k.innerHTML='<i class="fas fa-pencil-alt fa-xs"></i>',k.title="Modifier la recette",k.addEventListener("click",I=>{I.stopPropagation();const D=w.find(A=>A.id===s.id);Ue.openForm(D||s,"Modifier la recette")}),k.addEventListener("mousedown",I=>I.stopPropagation()),v.appendChild(k);const E=document.createElement("button");E.className="delete-meal-btn text-red-700 hover:text-red-900 hidden px-1 py-0.5",E.innerHTML='<i class="fas fa-times-circle fa-xs"></i>',E.title="Retirer du planning",E.addEventListener("click",I=>{I.stopPropagation(),xn(i,d)}),E.addEventListener("mousedown",I=>I.stopPropagation()),v.appendChild(E),r.appendChild(v),r.addEventListener("mouseenter",()=>{k.classList.remove("hidden"),E.classList.remove("hidden")}),r.addEventListener("mouseleave",()=>{k.classList.add("hidden"),E.classList.add("hidden")})}const h=document.createElement("div");h.className="absolute bottom-1 right-1";const m=document.createElement("button");return m.className="info-meal-btn bg-gray-500 text-white hover:bg-gray-600 rounded w-3 h-3 flex items-center justify-center shadow-sm",m.innerHTML='<i class="fas fa-plus fa-xs"></i>',m.title="Plus d'infos",m.dataset.slotId=i,m.dataset.mealIndex=d,m.addEventListener("mousedown",v=>v.stopPropagation()),h.appendChild(m),r.appendChild(h),r}function ze(s,i){if(document.querySelectorAll(".planner-ingredient-tooltip").forEach(h=>h.remove()),P===s){s.classList.remove("info-open"),s.innerHTML='<i class="fas fa-plus fa-xs"></i>',P=null;return}P&&(P.classList.remove("info-open"),P.innerHTML='<i class="fas fa-plus fa-xs"></i>'),s.classList.add("info-open"),s.innerHTML='<i class="fas fa-times fa-xs"></i>',P=s;const d=document.createElement("div");if(d.className="planner-ingredient-tooltip z-50 w-64 p-3 bg-white border border-gray-200 rounded-lg shadow-lg text-left text-sm",i.ingredients&&i.ingredients.length>0){if(i.servings&&i.servings>0){const v=document.createElement("p");v.className="mb-2 text-sm text-gray-600 flex items-center",v.innerHTML=`<i class="fas fa-users mr-2"></i> Pour ${i.servings} ${i.servings>1?"personnes":"personne"}`,d.appendChild(v)}const h=document.createElement("h4");h.className="font-bold mb-2 text-gray-800",h.textContent="Ingr√©dients :",d.appendChild(h);const m=document.createElement("ul");m.className="space-y-1 text-gray-600",i.ingredients.forEach(v=>{const k=document.createElement("li");k.textContent=`‚Ä¢ ${v.quantity||""} ${v.unit||""} ${v.name}`.trim(),m.appendChild(k)}),d.appendChild(m)}else d.textContent="Aucun ingr√©dient sp√©cifi√© pour cette recette.";document.body.appendChild(d);const u=s.closest(".meal-card").getBoundingClientRect(),r=d.getBoundingClientRect();if(window.innerWidth<768){d.style.width="90vw",d.style.maxWidth="320px";const h=d.getBoundingClientRect();let m=u.bottom+10,v=(window.innerWidth-h.width)/2;m+h.height>window.innerHeight&&(m=u.top-h.height-10),d.style.top=`${m}px`,d.style.left=`${v}px`}else{let h=u.right+10;h+r.width>window.innerWidth&&(h=u.left-r.width-10);let m=u.top;m+r.height>window.innerHeight&&(m=u.bottom-r.height),m<10&&(m=10),d.style.left=`${h}px`,d.style.top=`${m}px`}d.style.position="fixed"}function Je(s,i=!1){const d=document.createElement("div"),u=document.createElement("button");return i?(d.className="w-full flex justify-center pt-1",u.className="add-more-meal-btn text-gray-400 hover:text-green-500 transition-colors duration-150",u.innerHTML='<i class="fas fa-plus-circle"></i>',u.title="Ajouter une autre recette"):(d.className="flex items-center justify-center h-full",u.className="add-meal-btn text-green-500 hover:text-green-700 transition-transform duration-150 hover:scale-125",u.innerHTML='<i class="fas fa-plus-circle text-lg"></i>'),u.addEventListener("click",()=>ie(s)),d.appendChild(u),d}function We(s,i,d=!1){if(d){const r=document.createElement("p");return r.className="w-full h-full p-1 text-xs text-gray-700",r.textContent=i[s]||"",r}const u=document.createElement("textarea");return u.className="w-full h-full p-1 text-xs bg-transparent border-0 rounded focus:outline-none focus:ring-1 focus:ring-tomato resize-none",u.placeholder="Remarque...",u.value=f[s]||"",u.dataset.slotId=s,u.addEventListener("change",r=>{const g=r.target.value;g?f[s]=g:delete f[s];const[h,m]=s.split("-"),E=`a modifi√© la remarque pour ${H[parseInt(h,10)]} ${m==="lunch"?"midi":"soir"}`;T({[`weeks.${a}.remarksData`]:f},E)}),u.addEventListener("focus",r=>{ft({type:"editing_remark",fieldId:s})}),u.addEventListener("blur",r=>{ft("idle")}),u}function Ge(){document.querySelectorAll(".meal-card").forEach(s=>{s.addEventListener("dragstart",Ie),s.addEventListener("dragend",q)}),document.querySelectorAll(".meal-slot").forEach(s=>{s.addEventListener("dragover",_),s.addEventListener("dragleave",S),s.addEventListener("drop",N)})}async function Xe(s,i){const d=JSON.parse(JSON.stringify(l)),u=d[s],r={id:i.id};Array.isArray(u)?u.push(r):d[s]=[r];const[g,h]=s.split("-"),m=H[parseInt(g,10)],v=h==="lunch"?"midi":"soir",k=`a ajout√© '${i.name}' √† ${m} ${v}`;await T({[`weeks.${a}.menuData`]:d},k),oe()}async function xn(s,i){if(!p||!l[s]||!Array.isArray(l[s]))return;const d=l[s][i],u=JSON.parse(JSON.stringify(l));u[s].splice(i,1),u[s].length===0&&delete u[s];const[r,g]=s.split("-"),h=H[parseInt(r,10)],m=g==="lunch"?"midi":"soir",v=`a supprim√© '${d.name}' de ${h} ${m}`;await T({[`weeks.${a}.menuData`]:u},v)}async function At(){if(confirm("Voulez-vous vraiment vider le menu de cette semaine ?")){const s={id:availablePlans.length>0?availablePlans[0].id:`${ve()}_semaine-${a}`,name:availablePlans.length>0?availablePlans[0].name:"Mon plan",menuData:{},servingsData:{},remarksData:{},defaultNumPeople:L,startDay:o,lastUpdated:new Date};loadPlan(s),availablePlans.length>0?availablePlans[0]=s:availablePlans.push(s),await T({[`weeks.${a}`]:{menuData:{},servingsData:{},remarksData:{}}},`a vid√© le menu de la semaine ${a}`)}}function Rt(s){s>=1&&s<=52&&(a=s,R())}function En(){e.currentWeekDisplay&&(e.currentWeekDisplay.textContent=`Semaine ${a}`)}function wn(){e.prevWeekBtn?.addEventListener("click",()=>Rt(a-1)),e.nextWeekBtn?.addEventListener("click",()=>Rt(a+1)),e.clearMenuBtn?.addEventListener("click",At),e.startDaySelect?.addEventListener("change",async d=>{o=d.target.value,p&&await T({startDay:o},`a chang√© le premier jour de la semaine √† '${o}'`)}),e.planSelect?.addEventListener("change",qt),e.closeMealSelectModalBtn?.addEventListener("click",oe),e.mealSelectModal?.addEventListener("click",d=>{d.target===e.mealSelectModal&&oe()}),e.closeRecipeModalBtn?.addEventListener("click",()=>Ue.closeForm()),e.cancelRecipeBtn?.addEventListener("click",()=>Ue.closeForm()),e.importListBtn?.addEventListener("click",Ae),e.closeImportListModalBtn?.addEventListener("click",Re),e.importListModal?.addEventListener("click",d=>{d.target===e.importListModal&&Re()}),e.exportTxtBtn?.addEventListener("click",B),e.exportPdfBtn?.addEventListener("click",Q),e.exportPlanPdfBtn?.addEventListener("click",J);const s=d=>{const u=d.target.closest(".info-meal-btn");if(u){const r=u.dataset.slotId,g=parseInt(u.dataset.mealIndex,10);if(r&&!isNaN(g)){const h=l[r]?.[g];if(h&&h.id){const m=w.find(v=>v.id===h.id);m&&ze(u,m)}}}};e.mealPlanGrid?.addEventListener("click",s),document.getElementById("mobile-meal-plan")?.addEventListener("click",s),e.sharePlanBtn?.addEventListener("click",()=>{if(!p){alert("Veuillez s√©lectionner un plan √† partager.");return}Ht({plan:p})}),e.inviteParticipantBtn?.addEventListener("click",()=>{if(!p){alert("Veuillez s√©lectionner un plan pour inviter des participants.");return}nn(p)}),e.historyPlanBtn?.addEventListener("click",be),e.closePlanHistoryModalBtn?.addEventListener("click",O),e.planHistoryModal?.addEventListener("click",d=>{d.target===e.planHistoryModal&&O()}),e.savePlanBtn?.addEventListener("click",async()=>{if(!p){alert("Veuillez s√©lectionner un plan de travail avant de sauvegarder.");return}const d=document.getElementById("save-plan-as-modal"),u=document.getElementById("save-plan-as-form"),r=document.getElementById("save-plan-name"),g=document.getElementById("cancel-save-plan-as-btn"),h=document.getElementById("close-save-plan-as-modal"),m=new Date().toLocaleDateString("fr-FR"),v=p.weeks?Object.keys(p.weeks).filter(D=>p.weeks[D]&&Object.keys(p.weeks[D].menuData||{}).length>0).length:0,k=v>1?`${v} semaines`:`${v} semaine`;r.value=`${p.name} (${k}) - ${m}`,d.classList.remove("hidden");const E=async D=>{D.preventDefault();const A=r.value;if(!A)return;p.weeks||(p.weeks={}),p.weeks[a]={menuData:l,servingsData:c,remarksData:f},p.startDay=o,p.defaultNumPeople=L;const ae=JSON.parse(JSON.stringify(p));if(ae.weeks)for(const se in ae.weeks){const le=ae.weeks[se];if(le&&le.menuData)for(const de in le.menuData){const fe=le.menuData[de];Array.isArray(fe)&&(le.menuData[de]=fe.map(ee=>ee&&ee.id&&w.find(Y=>Y.id===ee.id)||ee))}}await cn(A,ae),d.classList.add("hidden"),u.removeEventListener("submit",E)},I=()=>{d.classList.add("hidden"),u.removeEventListener("submit",E)};u.addEventListener("submit",E,{once:!0}),g.addEventListener("click",I,{once:!0}),h.addEventListener("click",I,{once:!0})})}function Ln(s=""){return s.split(" ").map(u=>u[0]).join("").substring(0,2).toUpperCase()}function xt(s=[],i={}){const d=document.getElementById("collaborators-bar"),u=document.getElementById("activity-labels-container"),r=document.getElementById("name-tooltip");if(!d||!r||!u)return;if(d.innerHTML="",u.innerHTML="",document.querySelectorAll(".remark-lock-overlay").forEach(m=>m.remove()),document.querySelectorAll("textarea[data-slot-id]").forEach(m=>{m.disabled=!1}),s.length<=1&&Object.keys(i).length<=1){d.classList.add("hidden");return}let g="";const h=ve();s.forEach(m=>{if(!m)return;const v=i.hasOwnProperty(m.uid),k=i[m.uid]||{},E=document.createElement("div");E.className="w-8 h-8 rounded-full flex items-center justify-center bg-gray-300 text-white font-bold text-xs ring-2 ring-white cursor-pointer transition-all duration-300";const I=v?"(pr√©sent)":"(absent)";if(E.dataset.name=`${m.displayName||"Inconnu"} ${I}`,m.photoURL?E.innerHTML=`<img src="${m.photoURL}" alt="${m.displayName}" class="w-full h-full rounded-full object-cover">`:E.textContent=Ln(m.displayName),v||E.classList.add("grayscale","opacity-50"),E.addEventListener("mouseenter",D=>{r.textContent=D.currentTarget.dataset.name,r.classList.remove("hidden");const A=D.currentTarget.getBoundingClientRect();r.style.left=`${A.left+A.width/2-r.offsetWidth/2}px`,r.style.top=`${A.top-r.offsetHeight-5}px`}),E.addEventListener("mouseleave",()=>{r.classList.add("hidden")}),d.appendChild(E),v&&m.uid!==h){const D=k.status;if(typeof D=="object"&&D.type==="editing_remark"){const A=document.querySelector(`textarea[data-slot-id="${D.fieldId}"]`);if(A){A.disabled=!0;const ae=document.createElement("div");ae.className="remark-lock-overlay absolute inset-0 bg-gray-400 bg-opacity-25 flex items-center justify-center text-xs text-white font-bold",ae.innerHTML=`<i class="fas fa-lock mr-1"></i> ${m.displayName} √©crit...`,A.parentElement&&(A.parentElement.classList.add("relative"),A.parentElement.appendChild(ae))}}else if(typeof D=="string"&&D!=="idle"){let A="";switch(D){case"editing_recipe":A="modifie une recette...";break}A&&(g+=`<span class="italic mr-4">${m.displayName} ${A}</span>`)}}}),u.innerHTML=g,d.classList.remove("hidden")}function qt(){bn();const s=e.planSelect.value;p=M.find(h=>h.id===s)||null;const i=document.getElementById("delete-plan-btn"),d=document.getElementById("rename-plan-btn"),u=document.getElementById("leave-plan-btn"),r=document.getElementById("invite-participant-btn"),g=document.getElementById("history-plan-btn");if(i&&(i.style.display=p&&p.isOwner?"inline-flex":"none"),d&&(d.style.display=p&&p.isOwner?"inline-flex":"none"),g&&(g.style.display=p&&p.isOwner?"inline-flex":"none"),u&&(u.style.display=p&&!p.isOwner?"inline-flex":"none"),r){const h=p&&(p.type==="collaborative"||p.collaborators&&p.collaborators.length>0);r.style.display=p&&p.isOwner&&h?"inline-flex":"none"}p&&p.participants&&p.participants.length>1?(xt(p.participants,{}),vn(p.id,h=>{xt(p.participants,h)})):xt([],{}),p&&(p.manualItems=p.manualItems||[]),R()}async function Ft(s,i){if(!p)return;const d=JSON.parse(JSON.stringify(c));i===L?delete d[s]:d[s]=i;const[u,r]=s.split("-"),m=`a chang√© le nombre de personnes pour ${H[parseInt(u,10)]} ${r==="lunch"?"midi":"soir"} √† ${i}`;await T({[`weeks.${a}.servingsData`]:d},m)}async function Cn(){if(!b)return;const s=ln();wn(),U(),await z();const i=Fe(F(b,"recipes"),u=>{if(console.log("Recipe data updated from listener."),w=u.docs.map(r=>({id:r.id,...r.data()})),p){for(const r in l){const g=l[r];if(Array.isArray(g)){const h=g.map(m=>{if(m&&m.id){const v=w.find(k=>k.id===m.id);return v?{...v}:m}return m});l[r]=h}}Ce(e.mealPlanGrid,{menuData:l,servingsData:c,remarksData:f,defaultNumPeople:L,startDay:o},!1),ye(document.getElementById("mobile-meal-plan"),{menuData:l,servingsData:c,remarksData:f,defaultNumPeople:L,startDay:o},!1),W()}}),d=rn(u=>{M=u,on(u);const r=localStorage.getItem("selectedPlanId");r&&u.some(g=>g.id===r)&&(e.planSelect.value=r,localStorage.removeItem("selectedPlanId")),qt()});return()=>{d(),i(),s()}}const In=Cn();return async()=>{const s=await In;typeof s=="function"&&s()}}const Ea=Object.freeze(Object.defineProperty({__proto__:null,default:xa},Symbol.toStringTag,{value:"Module"}));function wa(){const e=yn();return _t(),()=>{typeof e=="function"&&e()}}async function _t(){const e=document.getElementById("received-shares-container"),t=ve();if(!(!t||!e)){e.innerHTML='<p class="text-gray-500">Chargement des partages re√ßus...</p>';try{const n=ue(F(b,"plans"),te("userId","==",t),te("isShared","==",!0)),a=ue(F(b,"plans"),te("collaborators","array-contains",t)),[o,l]=await Promise.all([pe(n),pe(a)]);let c=[];if(o.forEach(f=>c.push({id:f.id,type:"Planification (Copie)",...f.data()})),l.forEach(f=>c.push({id:f.id,type:"Planification (Collaboratif)",...f.data()})),c.length===0){e.innerHTML=`<p class="text-gray-500">Vous n'avez aucun contenu partag√© par d'autres utilisateurs.</p>`;return}c.sort((f,y)=>(y.sharedAt?.seconds||y.lastUpdated?.seconds||0)-(f.sharedAt?.seconds||f.lastUpdated?.seconds||0)),e.innerHTML="";for(const f of c){const y=f.originalOwnerId||f.userId;if(!y)continue;const x=await we($(b,"users",y)),w=x.exists()?x.data().displayName:"Utilisateur inconnu";e.appendChild(La(f,w))}}catch(n){console.error("Erreur lors du chargement des partages re√ßus : ",n),e.innerHTML='<p class="text-red-500">Une erreur est survenue.</p>'}}}function La(e,t){const n=document.createElement("div");n.className="bg-white rounded-lg p-4 flex justify-between items-center shadow-sm";const a=document.createElement("div"),o=document.createElement("p");o.className="font-bold text-gray-800";let l="";e.type.includes("Collaboratif")?l=' <span class="text-xs font-medium bg-blue-100 text-blue-800 px-2 py-1 rounded-full">Collab</span>':e.type.includes("Copie")&&(l=' <span class="text-xs font-medium bg-gray-200 text-gray-800 px-2 py-1 rounded-full">Copie</span>'),o.innerHTML=`${e.name}${l}`;const c=document.createElement("p");c.className="text-sm text-gray-500 mt-1";const f=e.sharedAt?new Date(e.sharedAt.seconds*1e3).toLocaleDateString("fr-FR"):e.lastUpdated?new Date(e.lastUpdated.seconds*1e3).toLocaleDateString("fr-FR"):"date inconnue";c.textContent=`Partag√© par ${t} le ${f}`,a.appendChild(o),a.appendChild(c),n.appendChild(a);const y=document.createElement("button");return y.className="btn btn-ghost text-red-500 btn-sm",y.innerHTML='<i class="fas fa-trash"></i>',y.title="Supprimer ce contenu partag√©",y.addEventListener("click",()=>Ca(e.id,e.type)),n.appendChild(y),n}async function Ca(e,t){if(confirm(`Voulez-vous vraiment supprimer cette ${t.toLowerCase()} partag√©e ?`))try{const n=t.startsWith("Planification")?"plans":"shopping_lists",a=$(b,n,e),o=await we(a);o.exists()&&o.data().userId===ve()?(await He(a),_t()):(alert("Vous n'avez pas la permission de supprimer cet √©l√©ment ou il a d√©j√† √©t√© supprim√©."),_t())}catch(n){console.error("Erreur de suppression: ",n),alert("Une erreur est survenue.")}}async function yn(){const e=document.getElementById("sent-shares-container"),t=ve();if(!t||!e)return()=>{};e.innerHTML='<p class="text-gray-500">Chargement des partages envoy√©s...</p>';const n=F(b,"shares"),a=ue(n,te("senderId","==",t));return Fe(a,async o=>{if(o.empty){e.innerHTML=`<p class="text-gray-500">Vous n'avez envoy√© aucun partage.</p>`;return}const l=o.docs.sort((c,f)=>(f.data().createdAt?.seconds||0)-(c.data().createdAt?.seconds||0));e.innerHTML="";for(const c of l){const f=c.data();try{const y=await we($(b,"users",f.receiverId));if(y.exists()){const x=y.data();e.appendChild(Ia(f,x.displayName,c.id))}}catch(y){console.error("Could not load receiver for sent share",y)}}},o=>{console.error("Erreur lors du chargement des partages envoy√©s : ",o),e&&(e.innerHTML='<p class="text-red-500">Une erreur est survenue.</p>')})}function Ia(e,t,n){const a=document.createElement("div");a.className="bg-white rounded-lg p-4 flex justify-between items-center shadow-sm";const o=document.createElement("div"),l=document.createElement("p");l.className="font-bold text-gray-800";let c=[];e.plan&&c.push("Planification"),e.shoppingList&&c.push("Liste de courses"),l.textContent=c.join(" et ");const f=document.createElement("p");f.className="text-sm text-gray-500";const y=new Date(e.createdAt.seconds*1e3).toLocaleDateString("fr-FR");f.textContent=`Envoy√© √† ${t} le ${y}`,o.appendChild(l),o.appendChild(f),a.appendChild(o);const x=document.createElement("div");x.className="flex items-center space-x-4";const w=document.createElement("span");w.textContent=e.status;let C="bg-gray-200 text-gray-800";switch(e.status){case"accepted":C="bg-green-100 text-green-800";break;case"declined":C="bg-red-100 text-red-800";break;case"pending":C="bg-yellow-100 text-yellow-800";break}w.className=`text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full ${C}`,x.appendChild(w);const L=document.createElement("button");return L.className="btn btn-ghost text-red-500 btn-sm",L.innerHTML='<i class="fas fa-trash"></i>',L.title="Annuler le partage",L.addEventListener("click",()=>Ba(n)),x.appendChild(L),a.appendChild(x),a}async function Ba(e){if(confirm("Voulez-vous vraiment annuler ce partage ? L'autre utilisateur ne le verra plus."))try{await He($(b,"shares",e)),yn()}catch(t){console.error("Erreur lors de la suppression du partage: ",t),alert("Une erreur est survenue.")}}const Sa=Object.freeze(Object.defineProperty({__proto__:null,default:wa},Symbol.toStringTag,{value:"Module"}));function ka(){const e=localStorage.getItem("selectedPlanId"),t=document.getElementById("plan-view-name"),n=document.getElementById("meal-plan-grid"),a=document.getElementById("close-view-plan-btn");if(a&&a.addEventListener("click",()=>{localStorage.removeItem("selectedPlanId"),et("plans")}),!e)return t&&(t.textContent="Aucune sauvegarde s√©lectionn√©e"),n&&(n.innerHTML=`<p class="text-center text-red-500">Erreur : Aucun ID de sauvegarde trouv√©. Veuillez retourner √† la page 'Mes Plans Sauvegard√©s' et en s√©lectionner une.</p>`),()=>{};async function o(){try{const l=$(b,"plan_saves",e),c=await we(l);if(!c.exists())throw new Error("Sauvegarde non trouv√©e");const f=c.data(),y=f.planData;if(!y)throw new Error("Les donn√©es du plan sauvegard√© sont corrompues ou manquantes.");t&&(t.textContent=`Vue de : ${f.name}`),Ma(n,y)}catch(l){console.error("Error fetching save:",l),t&&(t.textContent="Erreur"),n&&(n.innerHTML=`<p class="text-center text-red-500">${l.message}</p>`)}}return o(),()=>{localStorage.removeItem("selectedPlanId")}}function Ma(e,t){if(!e)return;e.innerHTML="";const n=Object.keys(t.weeks||{}).sort((a,o)=>parseInt(a)-parseInt(o));if(n.length===0){e.innerHTML='<p class="text-center text-gray-500 p-10 col-span-full">Ce plan est vide.</p>';return}n.forEach(a=>{const o=t.weeks[a],l=document.createElement("h3");l.className="text-lg font-bold text-gray-700 mt-6 mb-2 col-span-full",l.textContent=`Semaine ${a}`,e.appendChild(l);const c=document.createElement("div");Na(c,o,t.startDay,t.defaultNumPeople),e.appendChild(c)})}function Na(e,t,n,a){const o=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"],l=o.indexOf(n||"Lundi"),c=[...o.slice(l),...o.slice(0,l)],f=t.menuData||{},y=t.servingsData||{},x=t.remarksData||{};c.forEach(w=>{const C=o.indexOf(w),L=document.createElement("div");L.className="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] items-stretch border-b border-gray-300";const P=document.createElement("div");P.className="font-bold p-2 flex items-center justify-center bg-gray-100 text-sm border-r border-gray-300",P.textContent=w.toUpperCase(),L.appendChild(P),["lunch","dinner"].forEach(M=>{const p=`${C}-${M}`,H=y[p]||a||1,G=document.createElement("div");G.className="border-r border-gray-300 flex items-center justify-center",G.innerHTML=`<div class="text-center"><i class="fas fa-users fa-xs mb-1"></i><br>${H}</div>`,L.appendChild(G);for(let Me=0;Me<5;Me++){const z=`${C}-${M}-${Me}`,R=document.createElement("div");if(R.className="meal-slot p-1 min-h-[50px] border-r border-gray-300",Me===4)R.textContent=x[z]||"",R.classList.add("text-xs","italic","text-gray-600");else{const T=f[z];Array.isArray(T)&&T.length>0&&T.forEach(O=>{const X=document.createElement("div");X.className="p-1 bg-white rounded shadow-sm text-center text-xs font-medium",X.textContent=O.name,R.appendChild(X)})}L.appendChild(R)}}),e.appendChild(L)})}const Ta=Object.freeze(Object.defineProperty({__proto__:null,default:ka},Symbol.toStringTag,{value:"Module"})),Wt=document.querySelector("main"),Da={menu:{html:`
        <div class="flex flex-col md:flex-row md:space-x-2">

            <!-- Left Column: Meal Planner -->
            <div class="w-full md:w-5/6">
                <section id="meal-planning-section" aria-labelledby="meal-planning-heading" class="mb-8 md:mb-12">
                                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                                        <h2 id="meal-planning-heading" class="text-xl md:text-2xl font-bold text-gray-800">Planification des repas</h2>
                                        <div class="mt-3 md:mt-0 flex items-center space-x-2 md:space-x-3 plan-actions">
                                            <button id="generate-plan-ai-btn" class="btn btn-primary btn-sm">
                                                <i class="fas fa-robot mr-1 md:mr-2"></i> IA Semaine
                                            </button>
                                            <button id="clear-menu-btn" class="btn btn-outline btn-sm text-red-800 hover:bg-red-100">
                                                <i class="fas fa-trash-alt mr-1 md:mr-2"></i> Vider le menu
                                            </button>
                                            <button id="export-plan-pdf-btn" class="btn btn-outline btn-sm">
                                                <i class="fas fa-file-pdf mr-1 md:mr-2"></i> Exporter Plan (PDF)
                                            </button>
                                            <button id="share-plan-btn" class="btn btn-secondary btn-sm">
                                                <i class="fas fa-share-alt mr-1 md:mr-2"></i> Partager
                                            </button>
                                            <button id="save-plan-btn" class="btn btn-secondary btn-sm">
                                                <i class="fas fa-save mr-1 md:mr-2"></i> Sauvegarder Plan
                                            </button>
                                        </div>
                                    </div>
                            
                                    <!-- Week Navigation & Plan Selector -->
                                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 space-y-3 md:space-y-0">
                                        <!-- Week Navigation -->
                                        <div class="flex justify-between items-center bg-white p-2 md:p-3 rounded-lg shadow-sm">
                                            <button id="prev-week-btn" class="btn btn-ghost btn-sm" aria-label="Semaine pr√©c√©dente">
                                                <i class="fas fa-chevron-left mr-1 md:mr-2"></i> Pr√©c.
                                            </button>
                                            <div id="current-week-display" class="text-gray-700 font-medium text-sm md:text-base text-center mx-4">Semaine X</div>
                                            <button id="next-week-btn" class="btn btn-ghost btn-sm" aria-label="Semaine suivante">
                                                Suiv. <i class="fas fa-chevron-right ml-1 md:ml-2"></i>
                                            </button>
                                        </div>
                                        <!-- Plan Selector -->
                                        <div class="flex flex-wrap items-center justify-center gap-2 bg-white p-3 rounded-lg shadow-sm">
                                            <label for="plan-select" class="text-sm font-medium text-gray-700">Plan affich√©:</label>
                                            <select id="plan-select" class="rounded-md border-gray-300 shadow-sm focus:border-tomato focus:ring focus:ring-tomato focus:ring-opacity-50 text-sm py-1">
                                                <!-- Options will be generated by JS -->
                                            </select>
                                            <button id="create-plan-btn" class="btn btn-primary btn-sm" title="Cr√©er un nouveau plan">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                            <button id="rename-plan-btn" class="btn btn-ghost text-blue-500 hover:bg-blue-100 btn-sm" title="Renommer le plan s√©lectionn√©">
                                                <i class="fas fa-pencil-alt"></i>
                                            </button>
                                            <button id="history-plan-btn" class="btn btn-ghost text-purple-500 hover:bg-purple-100 btn-sm" title="Historique des modifications">
                                                <i class="fas fa-history"></i>
                                            </button>
                                            <button id="leave-plan-btn" class="btn btn-ghost text-yellow-600 hover:bg-yellow-100 btn-sm" title="Quitter le plan collaboratif">
                                                <i class="fas fa-door-open"></i>
                                            </button>
                                            <button id="delete-plan-btn" class="btn btn-ghost text-red-500 hover:bg-red-100 btn-sm" title="Supprimer le plan s√©lectionn√©">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            <button id="invite-participant-btn" class="btn btn-ghost text-green-500 hover:bg-green-100 btn-sm hidden" title="Inviter un participant">
                                                <i class="fas fa-user-plus"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Collaborators Bar -->
                                    <div id="collaborators-bar" class="flex items-center space-x-2 mb-4 hidden">
                                        <!-- Avatars will be injected here -->
                                    </div>

                                    <!-- Activity Labels -->
                                    <div id="activity-labels-container" class="text-sm text-gray-600 mb-4 h-6">
                                        <!-- e.g., 'Sophie is adding a recipe...' -->
                                    </div>
                            
                                            <!-- Settings Section -->
                                            <div class="inline-flex items-center space-x-6 bg-white p-3 rounded-lg shadow-sm mb-4">                                        <div>
                                            <label for="start-day-select" class="text-sm font-medium text-gray-700">D√©but de semaine:</label>
                                            <select id="start-day-select" class="rounded-md border-gray-300 shadow-sm focus:border-tomato focus:ring-tomato text-sm py-1">
                                                <option>Lundi</option>
                                                <option>Mardi</option>
                                                <option>Mercredi</option>
                                                <option>Jeudi</option>
                                                <option>Vendredi</option>
                                                <option>Samedi</option>
                                                <option>Dimanche</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="default-servings-input" class="text-sm font-medium text-gray-700">Personnes par d√©faut:</label>
                                            <div id="default-servings-control" class="mt-1"></div>
                                        </div>
                                    </div>                    <!-- Responsive Meal Plan Grid -->
<div class="bg-white rounded-xl shadow-md p-4">
                        <!-- Desktop Grid (Visible on large screens) -->
                        <div id="desktop-plan-container" class="hidden lg:block">
                            <div id="meal-plan-grid-layout">
                                <!-- Header -->
                                <div class="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] gap-1 text-center mb-1">
                                    <div class="p-2"></div> <!-- Empty corner -->
                                    <div class="p-2 rounded-t-lg bg-amber-100 text-amber-800 font-bold col-span-6">MIDI</div>
                                    <div class="p-2 rounded-t-lg bg-stone-200 text-stone-800 font-bold col-span-6">SOIR</div>
                                    
                                    <div class="p-1"></div> <!-- Empty under day name -->
                                    <div class="p-1 text-xs font-semibold"><i class="fas fa-users"></i></div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Entr√©e</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Plat</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Accomp.</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Dessert</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Remarque</div>

                                    <div class="p-1 text-xs font-semibold"><i class="fas fa-users"></i></div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Entr√©e</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Plat</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Accomp.</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Dessert</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Remarque</div>
                                </div>
                                <!-- Rows generated by JS -->
                                <div id="meal-plan-grid" class="space-y-1">
                                    <div class="p-10 text-center text-gray-500 italic col-span-full">Chargement du planning...</div>
                                </div>
                            </div>
                        </div>

                        <!-- Mobile Accordion (Visible on small screens) -->
                        <div id="mobile-meal-plan" class="lg:hidden space-y-2">
                            <!-- Mobile content will be generated by JS here -->
                             <div class="p-10 text-center text-gray-500 italic col-span-full">Chargement du planning...</div>
                        </div>
                    </div>
                                    </section>


                                </div>
                    
                                <!-- Right Column: Shopping List -->
                                <div class="w-full md:w-1/6">
                                    <section id="shopping-list-section" aria-labelledby="shopping-list-heading" class="mb-8 md:mb-12 md:sticky md:top-24">
                                        <div class="bg-white rounded-xl shadow-md p-4 md:p-6">
                                            <h2 id="shopping-list-heading" class="text-xl md:text-2xl font-bold text-gray-800 mb-4">Liste de courses</h2>
                                            <div class="flex justify-end space-x-2 mb-4">
                                                <button id="import-list-btn" class="btn btn-secondary btn-sm">
                                                    <i class="fas fa-download mr-2"></i>Importer une liste
                                                </button>
                                                <div id="export-buttons-container" class="flex space-x-2">
                                                    <button id="export-txt-btn" class="btn btn-outline btn-sm">
                                                        <i class="fas fa-file-alt mr-2"></i>TXT
                                                    </button>
                                                    <button id="export-pdf-btn" class="btn btn-outline btn-sm">
                                                        <i class="fas fa-file-pdf mr-2"></i>PDF
                                                    </button>
                                                </div>
                                            </div>
                    
                                            <!-- Shopping List Container -->
                                            <div id="shopping-list-container" class="mb-4 max-h-[70vh] overflow-y-auto pr-2">                            <ul id="shopping-list" class="space-y-2 text-sm">
                                <!-- Les articles de la liste de courses seront g√©n√©r√©s ici -->
                            </ul>
                        </div>

                        <!-- Add Item Input -->
                        <div class="mt-4 flex items-stretch">
                            <div class="relative flex-grow">
                                <input type="text" id="add-item-input" placeholder="Chercher ou ajouter..." class="w-full border border-gray-300 rounded-l-lg px-2 py-1 text-xs focus:outline-none focus:ring-2 focus:ring-tomato focus:border-transparent">
                                <div id="add-item-results" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto bottom-full mb-2"></div>
                            </div>
                            <button id="add-item-btn" class="btn btn-primary rounded-l-none -ml-px btn-xs" aria-label="Ajouter l'article">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>

                         <!-- AI Shopping Tips Placeholder -->
                        <div id="ai-shopping-tip" class="mt-6 bg-avocado bg-opacity-10 rounded-lg p-3 hidden">
                            <div class="flex items-start">
                                 <div class="w-8 h-8 bg-avocado bg-opacity-20 rounded-full flex items-center justify-center mr-3 shrink-0">
                                    <i class="fas fa-lightbulb text-avocado"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-avocado mb-1 text-sm">Astuce √âconomique</h4>
                                    <p id="ai-shopping-tip-text" class="text-sm text-gray-700">...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <!-- Shared Plans Modal -->
        <div id="shared-plans-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-6xl max-h-[90vh] overflow-y-auto relative">
                <button id="close-shared-plans-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" aria-label="Fermer">
                    <i class="fas fa-times text-xl"></i>
                </button>
                <h3 id="shared-plans-modal-title" class="text-2xl font-bold mb-6">Plans partag√©s pour la Semaine X</h3>
                <div id="shared-plans-modal-container" class="space-y-6">
                    <!-- Shared plans will be loaded here -->
                </div>
            </div>
        </div>
        `,script:"./script.js"},recipes:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Recettes</h2>
            <button id="add-recipe-btn" class="btn btn-primary">
                <i class="fas fa-plus mr-2"></i> Ajouter une recette
            </button>
        </div>

        <!-- Search Bar -->
        <div class="mb-6">
            <input type="text" id="search-bar" placeholder="Rechercher une recette..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-tomato focus:border-tomato">
        </div>

        <!-- Tabs Navigation -->
        <div id="category-tabs" class="mb-6 border-b border-gray-200 flex space-x-4 flex-nowrap overflow-x-auto pb-2">
            <!-- Tabs will be generated by recipes.js here -->
        </div>

        <!-- Recipe List Container -->
        <div id="recipe-list-container">
            <!-- Recipes for the selected tab will be loaded here -->
        </div>

        <!-- Reconstructed Recipe Form Modal -->
        <div id="recipe-form-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-3xl max-h-[90vh] overflow-y-auto relative">
                <button id="close-recipe-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" aria-label="Fermer">
                    <i class="fas fa-times text-xl"></i>
                </button>
                <h3 id="recipe-modal-title" class="text-2xl font-bold mb-6">Ajouter/Modifier une recette</h3>
                <form id="recipe-form" class="space-y-4">
                    <input type="hidden" id="recipe-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label for="recipe-name" class="block text-sm font-medium text-gray-700">Nom de la recette</label>
                            <input type="text" id="recipe-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                        </div>
                        <div>
                            <label for="recipe-category" class="block text-sm font-medium text-gray-700">Cat√©gorie</label>
                            <select id="recipe-category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                                <option>ENTREE</option>
                                <option>PLAT</option>
                                <option>ACCOMPAGNEMENT</option>
                                <option>DESSERT</option>
                            </select>
                        </div>
                        <div>
                            <label for="recipe-servings" class="block text-sm font-medium text-gray-700">Nombre de personnes</label>
                            <input type="number" id="recipe-servings" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" min="1">
                        </div>
                        <div>
                            <label for="recipe-prep-time" class="block text-sm font-medium text-gray-700">Temps de pr√©paration (min)</label>
                            <input type="number" id="recipe-prep-time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" min="0">
                        </div>
                         <div>
                            <label for="recipe-difficulty" class="block text-sm font-medium text-gray-700">Difficult√©</label>
                            <select id="recipe-difficulty" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                <option>Tr√®s facile</option>
                                <option>Facile</option>
                                <option>Moyen</option>
                                <option>Difficile</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-lg font-medium text-gray-800 mb-2">Ingr√©dients</h4>
                        <div id="ingredients-list" class="space-y-2"></div>
                        <button type="button" id="add-ingredient-btn" class="btn btn-outline btn-sm mt-2">
                            <i class="fas fa-plus mr-2"></i> Ajouter un ingr√©dient
                        </button>
                    </div>
                    <div>
                        <label for="recipe-steps" class="block text-lg font-medium text-gray-800">Pr√©paration</label>
                        <textarea id="recipe-steps" rows="8" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                    </div>
                    <div class="flex justify-end space-x-4 pt-4">
                        <button type="button" id="cancel-recipe-btn" class="btn btn-ghost">Annuler</button>
                        <button type="submit" id="save-recipe-btn" class="btn btn-primary">Sauvegarder</button>
                    </div>
                </form>
            </div>
        </div>
        `,script:"./recipes.js"},ingredients:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Ingr√©dients</h2>
            <div class="flex space-x-2">
                <button id="manage-categories-btn" class="btn btn-outline">
                    <i class="fas fa-tags mr-2"></i> G√©rer les cat√©gories
                </button>
                <button id="add-ingredient-btn" class="btn btn-primary">
                    <i class="fas fa-plus mr-2"></i> Ajouter un ingr√©dient
                </button>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="mb-6">
            <input type="text" id="search-bar" placeholder="Rechercher un ingr√©dient..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-tomato focus:border-tomato">
        </div>

        <!-- Tabs Navigation -->
        <div id="category-tabs" class="mb-6 border-b border-gray-200 flex space-x-4 flex-nowrap overflow-x-auto pb-2">
            <!-- Tabs will be generated by ingredients.js here -->
        </div>

        <!-- Ingredient List Container -->
        <div id="ingredients-list-container">
            <p class="text-center text-gray-500 p-10">Chargement des ingr√©dients...</p>
        </div>

        <!-- Ingredient Form Modal -->
        <div id="ingredient-form-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-md relative">
                <button id="close-ingredient-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
                <h3 id="ingredient-modal-title" class="text-lg font-bold mb-4">Ajouter un Ingr√©dient</h3>
                <form id="ingredient-form" class="space-y-4">
                    <input type="hidden" id="ingredient-id">
                    <div>
                        <label for="ingredient-name" class="block text-sm font-medium text-gray-700">Nom</label>
                        <input type="text" id="ingredient-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                    </div>
                    <div>
                        <label for="ingredient-unit" class="block text-sm font-medium text-gray-700">Unit√© par d√©faut</label>
                        <select id="ingredient-unit" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select>
                    </div>
                    <div>
                        <label for="ingredient-category" class="block text-sm font-medium text-gray-700">Cat√©gorie</label>
                        <select id="ingredient-category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></select>
                    </div>
                    <div class="flex justify-end space-x-4 pt-2">
                        <button type="button" id="cancel-ingredient-btn" class="btn btn-ghost">Annuler</button>
                        <button type="submit" id="save-ingredient-btn" class="btn btn-primary">Sauvegarder</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Category Management Modal -->
        <div id="category-management-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-lg relative">
                <h3 class="text-lg font-bold mb-4">G√©rer les cat√©gories d'ingr√©dients</h3>
                <form id="add-category-form" class="flex items-center space-x-2 mb-4">
                    <input type="text" id="new-category-name" placeholder="Nom de la nouvelle cat√©gorie" class="flex-grow mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                    <button type="submit" class="btn btn-secondary">Ajouter</button>
                </form>
                <div id="category-list" class="max-h-64 overflow-y-auto border rounded-lg p-2"></div>
                <div class="flex justify-end space-x-4 mt-4">
                     <button type="button" id="close-category-modal" class="btn btn-ghost">Annuler</button>
                    <button type="button" id="done-category-modal-btn" class="btn btn-primary">Termin√©</button>
                </div>
            </div>
        </div>
        `,script:"./ingredients.js"},lists:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Listes de Courses</h2>
            <button id="add-list-btn" class="btn btn-primary">
                <i class="fas fa-plus mr-2"></i> Cr√©er une liste
            </button>
        </div>

        <!-- Search Bar -->
        <div class="mb-6">
            <input type="text" id="search-bar" placeholder="Rechercher une liste..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-tomato focus:border-tomato">
        </div>

        <!-- Lists Container -->
        <div id="lists-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

        <div class="mt-12">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6">Listes Partag√©es</h2>
            <div id="shared-lists-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Les listes partag√©es seront charg√©es ici par JS -->
            </div>
        </div>

        <!-- List Form Modal -->
        <div id="list-form-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-start justify-center z-[100] hidden pt-20">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-3xl min-h-[75vh] max-h-[90vh] overflow-y-auto relative">
                <button id="close-list-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10"><i class="fas fa-times text-xl"></i></button>
                <h3 id="list-modal-title" class="text-lg font-bold mb-4">Cr√©er une liste</h3>
                <form id="list-form" class="space-y-4 pb-20">
                    <input type="hidden" id="list-id">
                    <div>
                        <label for="list-name" class="block text-sm font-medium text-gray-700">Nom de la liste</label>
                        <input type="text" id="list-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                    </div>
                    <div>
                        <h4 class="text-md font-medium text-gray-800 mb-2">Ingr√©dients</h4>
                        <div id="ingredients-list" class="space-y-2"></div>
                        <button type="button" id="add-ingredient-btn" class="btn btn-outline btn-sm mt-2">
                            <i class="fas fa-plus mr-2"></i> Ajouter un ingr√©dient
                        </button>
                    </div>
                </form>
                <div class="absolute bottom-0 left-0 right-0 px-6 py-4 bg-white/95 backdrop-blur-sm border-t border-gray-200 flex justify-end space-x-4">
                    <button type="button" id="cancel-list-btn" class="btn btn-ghost">Annuler</button>
                    <button type="submit" form="list-form" id="save-list-btn" class="btn btn-primary">Sauvegarder la liste</button>
                </div>
            </div>
        </div>
        `,script:"./lists.js"},friends:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Amis</h2>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="md:col-span-2 space-y-8">
                <div>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Liste d'amis</h3>
                    <div id="friends-list-container" class="space-y-4">
                        <!-- La liste d'amis sera charg√©e ici -->
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Demandes envoy√©es en attente</h3>
                    <div id="pending-requests-container" class="space-y-4">
                        <!-- Les demandes envoy√©es en attente seront charg√©es ici -->
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Demandes rejet√©es</h3>
                    <div id="declined-requests-container" class="space-y-4">
                        <!-- Les demandes rejet√©es seront charg√©es ici -->
                    </div>
                </div>
            </div>
            <div>
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Rechercher un ami</h3>
                    <div class="mb-4">
                        <div class="flex items-center space-x-2">
                            <input type="text" id="search-friends-input" placeholder="Nom ou email..." class="flex-grow p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-tomato focus:border-tomato">
                            <button id="search-friends-btn" class="btn btn-primary"><i class="fas fa-search"></i></button>
                        </div>
                        <div id="search-results-container" class="mt-2 space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>
        `,script:"./friends.js"},shared:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Partages</h2>
        </div>

        <div class="space-y-12">
            <div>
                <h3 class="text-xl font-bold text-gray-700 border-b pb-2 mb-4">Partages Re√ßus</h3>
                <div id="received-shares-container" class="space-y-4">
                    <!-- L'historique des partages accept√©s sera charg√© ici -->
                </div>
            </div>
            <div>
                <h3 class="text-xl font-bold text-gray-700 border-b pb-2 mb-4">Mes Partages Envoy√©s</h3>
                <div id="sent-shares-container" class="space-y-4">
                    <!-- L'historique des partages envoy√©s sera charg√© ici -->
                </div>
            </div>
        </div>
        `,script:"./shared.js"},plans:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Plans Sauvegard√©s</h2>
        </div>
        <div id="all-plans-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- La liste des plans sera charg√©e ici -->
            <p class="text-center text-gray-500 p-10 col-span-full">Chargement de vos plans...</p>
        </div>
        `,script:"./all-plans.js"},"view-plan":{html:`
        <section aria-labelledby="meal-planning-heading" class="mb-8 md:mb-12">
            <div class="flex justify-between items-center mb-4">
                <h2 id="plan-view-name" class="text-xl md:text-2xl font-bold text-gray-800">Chargement du plan...</h2>
                <button id="close-view-plan-btn" class="btn btn-outline">
                    <i class="fas fa-times mr-2"></i> Fermer et voir mes plans
                </button>
            </div>
            <div class="bg-white rounded-xl shadow-md p-4">
                <div id="meal-plan-grid-layout">
                    <!-- Header -->
                    <div class="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] gap-1 text-center mb-1">
                        <div class="p-2"></div> <!-- Empty corner -->
                        <div class="p-2 rounded-t-lg bg-amber-100 text-amber-800 font-bold col-span-6">MIDI</div>
                        <div class="p-2 rounded-t-lg bg-stone-200 text-stone-800 font-bold col-span-6">SOIR</div>
                        <div class="p-1"></div> <!-- Empty under day name -->
                        <div class="p-1 text-xs font-semibold"><i class="fas fa-users"></i></div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Entr√©e</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Plat</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Accomp.</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Dessert</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Remarque</div>
                        <div class="p-1 text-xs font-semibold"><i class="fas fa-users"></i></div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Entr√©e</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Plat</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Accomp.</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Dessert</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Remarque</div>
                    </div>
                    <!-- Rows generated by JS -->
                    <div id="meal-plan-grid" class="space-y-1">
                        <div class="p-10 text-center text-gray-500 italic col-span-full">Chargement de la planification...</div>
                    </div>
                </div>
            </div>
        </section>
        `,script:"./view-plan.js"}},Pa=Object.assign({"./all-plans.js":On,"./auth.js":Rn,"./firebase-config.js":jn,"./form-handler.js":zn,"./friends.js":Xn,"./ingredients.js":Kn,"./lists.js":na,"./main.js":An,"./notifications.js":ha,"./plans.js":la,"./presence.js":va,"./recipes.js":ya,"./script.js":Ea,"./shared.js":Sa,"./sharing.js":ea,"./view-plan.js":Ta});let pt=null;async function et(e){typeof pt=="function"&&(pt(),pt=null);const t=Da[e];if(t&&Wt){if(Wt.innerHTML=t.html,t.script){const n=Pa[t.script];n?n.default&&typeof n.default=="function"&&(pt=n.default()):console.error(`Module not found for path: ${t.script}`)}}else console.error(`Route not found: ${e}`)}function _a(){const e=De();if(e){const n=document.getElementById("user-display-name");n&&(n.textContent=e.displayName||e.email)}const t=document.querySelectorAll(".nav-btn");t.forEach(n=>{n.addEventListener("click",a=>{const o=a.currentTarget.dataset.path;et(o),t.forEach(l=>{l.classList.remove("bg-tomato","text-white"),l.classList.add("bg-white","text-tomato")}),a.currentTarget.classList.add("bg-tomato","text-white"),a.currentTarget.classList.remove("bg-white","text-tomato")})}),et("menu"),hn()}document.addEventListener("DOMContentLoaded",()=>{Yt().then(M=>{M&&_a()});const e=document.getElementById("profile-btn"),t=document.getElementById("profile-menu");e&&t&&(e.addEventListener("click",M=>{M.stopPropagation(),t.classList.toggle("hidden");const p=!t.classList.contains("hidden");e.setAttribute("aria-expanded",p)}),document.addEventListener("click",M=>{!(t.contains(M.target)||e.contains(M.target))&&!t.classList.contains("hidden")&&(t.classList.add("hidden"),e.setAttribute("aria-expanded","false"))}));const n=document.getElementById("settings-link"),a=document.getElementById("settings-modal"),o=document.getElementById("close-settings-modal"),l=document.getElementById("dark-mode-toggle"),c=M=>{M==="dark"?(document.documentElement.classList.add("dark"),l&&(l.checked=!0)):(document.documentElement.classList.remove("dark"),l&&(l.checked=!1))},f=localStorage.getItem("theme");f?c(f):window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?c("dark"):c("light"),n&&a&&n.addEventListener("click",M=>{M.preventDefault(),a.classList.remove("hidden")}),o&&a&&o.addEventListener("click",()=>{a.classList.add("hidden")}),a&&a.addEventListener("click",M=>{M.target===a&&a.classList.add("hidden")}),l&&l.addEventListener("change",()=>{const M=l.checked?"dark":"light";localStorage.setItem("theme",M),c(M)});const y=document.getElementById("mobile-menu-btn"),x=document.getElementById("mobile-menu"),w=document.querySelectorAll(".nav-btn-mobile"),C=document.getElementById("notifications-btn-mobile"),L=document.getElementById("notifications-dropdown");C&&L&&C.addEventListener("click",M=>{M.stopPropagation(),L.classList.toggle("hidden")}),y&&x&&y.addEventListener("click",()=>{x.classList.toggle("hidden")});const P=document.getElementById("profile-btn-mobile");P&&a&&P.addEventListener("click",()=>{a.classList.remove("hidden"),x&&x.classList.add("hidden")}),w.forEach(M=>{M.addEventListener("click",p=>{const H=p.currentTarget.dataset.path;et(H),x&&x.classList.add("hidden")})})});
