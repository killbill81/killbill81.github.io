import{o as jn,s as Kt,a as St,q as Le,w as le,c as J,d as w,b as Ve,e as H,g as Se,h as Ee,u as Pe,i as Fe,j as _e,k as gt,l as cn,m as wt,n as Yt,p as un,r as qn,t as Mt,v as Zt,x as Un,y as Fn,z as On,A as zn,B as Vn,C as mn,D as Qn,E as en,_ as Wn}from"./firebase-config-CV1YP_xo.js";const Jn=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"}));let Lt=null;function pn(){return new Promise(e=>{jn(St,t=>{if(Lt=t,t){console.log("User is logged in:",t.uid);const n=document.getElementById("logout-btn"),a=document.getElementById("profile-btn");n&&n.classList.remove("hidden"),a&&a.classList.remove("hidden"),n&&!n.hasAttribute("data-listener-attached")&&(n.addEventListener("click",()=>{Kt(St).catch(i=>{console.error("Sign Out Error",i)})}),n.setAttribute("data-listener-attached","true"));const r=document.getElementById("logout-btn-mobile");r&&!r.hasAttribute("data-listener-attached")&&(r.addEventListener("click",()=>{Kt(St).catch(i=>{console.error("Sign Out Error",i)})}),r.setAttribute("data-listener-attached","true")),e(t)}else{console.log("User not logged in. Redirecting to login.html");const n=window.location.origin+"/login.html";window.location.href!==n&&(window.location.href=n),e(null)}})})}function Ie(){return Lt?Lt.uid:null}function Re(){return Lt}const Gn=Object.freeze(Object.defineProperty({__proto__:null,getCurrentUser:Re,getCurrentUserId:Ie,protectPage:pn},Symbol.toStringTag,{value:"Module"}));async function Xn(e){if(confirm("Voulez-vous charger cette sauvegarde ? Attention, cela √©crasera la planification de la semaine correspondante dans votre plan de travail actuel."))try{const t=Ie();if(!t)throw new Error("Utilisateur non trouv√©");const n=H(w,"plan_saves",e),a=await Se(n);if(!a.exists())throw new Error("Sauvegarde non trouv√©e.");const r=a.data(),i=r.weekData.weekNumber,c=Le(J(w,"plans"),le("userId","==",t)),f=await Ee(c);if(f.empty)throw new Error("Aucun plan de travail trouv√© pour y charger la sauvegarde.");const g=f.docs[0],p=H(w,"plans",g.id);await Pe(p,{[`weeks.${i}`]:r.weekData}),localStorage.setItem("selectedPlanId",g.id),ct("menu")}catch(t){console.error("Erreur lors du chargement de la sauvegarde:",t),alert(t.message)}}async function Kn(e){if(confirm("√ätes-vous s√ªr de vouloir supprimer cette sauvegarde ? Cette action est d√©finitive."))try{await Fe(H(w,"plan_saves",e))}catch(t){console.error("Erreur lors de la suppression de la sauvegarde:",t),alert("La suppression a √©chou√©.")}}function Yn(){const e=document.getElementById("all-plans-list"),t=Ie();if(!t||!e)return e.innerHTML="<p>Erreur de chargement.</p>",()=>{};const n=Le(J(w,"plan_saves"),le("userId","==",t)),a=Ve(n,r=>{if(e.innerHTML="",r.empty){e.innerHTML=`<p class="text-center text-gray-500 p-10 col-span-full">Vous n'avez aucune sauvegarde.</p>`;return}const i=r.docs.map(c=>({id:c.id,...c.data()}));i.sort((c,f)=>f.savedAt.toMillis()-c.savedAt.toMillis()),i.forEach(c=>{const f=document.createElement("div");f.className="bg-white rounded-xl shadow-md p-4 flex flex-col justify-between";const g=c.savedAt?.toDate().toLocaleString("fr-FR")||"Date inconnue",p=c.planData;let E="Plan vide ou sans donn√©es.";if(p&&p.weeks){const N=Object.keys(p.weeks).length;N>0&&(E=`Contient ${N} semaine(s).`)}const I=document.createElement("div");I.innerHTML=`
                <h3 class="text-lg font-bold text-gray-800 mb-2">${c.name}</h3>
                <p class="text-sm text-gray-500">Sauvegard√© le : ${g}</p>
                <p class="text-sm text-gray-600 mt-2">${E}</p>
            `;const b=document.createElement("div");b.className="mt-4 pt-4 border-t border-gray-200 flex items-center justify-end space-x-2";const B=document.createElement("button");B.className="btn btn-secondary btn-sm",B.textContent="Voir",B.addEventListener("click",()=>{localStorage.setItem("selectedPlanId",c.id),ct("view-plan")});const U=document.createElement("button");U.className="btn btn-primary btn-sm",U.textContent="Charger",U.addEventListener("click",()=>Xn(c.id)),U.style.display="none";const l=document.createElement("button");l.className="btn btn-ghost text-red-500 hover:bg-red-100 btn-sm",l.innerHTML='<i class="fas fa-trash"></i>',l.title="Supprimer la sauvegarde",l.addEventListener("click",()=>Kn(c.id)),b.appendChild(l),b.appendChild(B),b.appendChild(U),f.appendChild(I),f.appendChild(b),e.appendChild(f)})});return()=>{a()}}const Zn=Object.freeze(Object.defineProperty({__proto__:null,default:Yn},Symbol.toStringTag,{value:"Module"}));class Ot{constructor(t,n,a,r,i,c,f,g,p,E,I,b,B,U,l,N){this.db=t,this.modal=document.getElementById(n),this.form=document.getElementById(a),this.modalTitle=document.getElementById(r),this.recipeIdInput=document.getElementById(i),this.recipeNameInput=document.getElementById(c),this.recipeCategoryInput=document.getElementById(f),this.recipeServingsInput=document.getElementById(g),this.recipePrepTimeInput=document.getElementById(p),this.recipeDifficultyInput=document.getElementById(E),this.recipeImageUrlInput=document.getElementById("edit-recipe-image-url"),this.recipeStepsTextarea=document.getElementById(I),this.ingredientsListDiv=document.getElementById(b),this.addIngredientBtn=document.getElementById(B),this.saveRecipeBtn=document.getElementById(U),this.closeButton=document.getElementById(l),this.cancelButton=document.getElementById(N),this.masterIngredientList=[],this.activityUpdater=null,this.boundAddIngredient=()=>this.addIngredientInput(void 0,this.form.ingredients),this.boundCloseForm=()=>this.closeForm(),this.boundHandleSubmit=A=>this.handleSubmit(A),this.addIngredientBtn.addEventListener("click",this.boundAddIngredient),this.closeButton.addEventListener("click",this.boundCloseForm),this.cancelButton.addEventListener("click",this.boundCloseForm),this.saveRecipeBtn.addEventListener("click",this.boundHandleSubmit)}setActivityUpdater(t){this.activityUpdater=t}destroy(){this.addIngredientBtn.removeEventListener("click",this.boundAddIngredient),this.closeButton.removeEventListener("click",this.boundCloseForm),this.cancelButton.removeEventListener("click",this.boundCloseForm),this.saveRecipeBtn.removeEventListener("click",this.boundHandleSubmit)}async openForm(t=null,n="Ajouter une recette"){this.activityUpdater&&this.activityUpdater("editing_recipe"),await this.fetchMasterIngredients(),console.log("openForm called with recipe:",t,"and title:",n),this.form.reset(),this.ingredientsListDiv.innerHTML="",this.modalTitle.textContent=n;const a=[];if(this.form.ingredients=a,t){this.recipeIdInput.value=t.id||"",this.recipeNameInput.value=t.name||"";const r=t.category||"Plat";for(const i of this.recipeCategoryInput.options)if(i.value.toLowerCase()===r.toLowerCase()){i.selected=!0;break}this.recipeServingsInput.value=parseInt(t.servings)||"",this.recipePrepTimeInput.value=parseInt(t.prepTime)||"",this.recipeDifficultyInput.value=t.difficulty||"Moyen",this.recipeImageUrlInput.value=t.imageUrl||"",this.recipeStepsTextarea.value=t.steps||"",t.ingredients&&t.ingredients.length>0?t.ingredients.forEach(i=>this.addIngredientInput({...i},a)):this.addIngredientInput(void 0,a)}else this.recipeIdInput.value="",this.addIngredientInput(void 0,a);this.modal.classList.remove("hidden")}closeForm(){this.activityUpdater&&this.activityUpdater("idle"),this.modal.classList.add("hidden")}async fetchMasterIngredients(){if(this.masterIngredientList=[],!!this.db)try{const t=await Ee(J(this.db,"ingredients"));this.masterIngredientList=t.docs.map(n=>({id:n.id,...n.data()})),this.masterIngredientList.sort((n,a)=>n.name.localeCompare(a.name))}catch(t){console.error("Erreur lors de la r√©cup√©ration de la liste des ingr√©dients: ",t),alert("Impossible de charger la liste des ingr√©dients de base. La recherche ne fonctionnera pas.")}}addIngredientInput(t={quantity:"",name:"",unit:""},n){const a=document.createElement("div");a.className="relative flex items-stretch space-x-2 ingredient-row";const r={...t};n.push(r);const i=n.length-1,c=document.createElement("input");c.type="text",c.className="ingredient-quantity mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm",c.placeholder="Qt√©",c.value=r.quantity,c.addEventListener("change",b=>{n[i].quantity=b.target.value});const f=document.createElement("input");f.type="text",f.className="ingredient-unit mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm bg-gray-100",f.placeholder="Unit√©",f.readOnly=!0,f.value=r.unit||"";const g=document.createElement("div");g.className="relative w-1/2";const p=document.createElement("input");p.type="text",p.className="ingredient-name mt-1 block w-full rounded-md border-gray-300 shadow-sm",p.placeholder="Chercher un ingr√©dient...",p.value=r.name,g.appendChild(p);const E=document.createElement("div");E.className="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto",g.appendChild(E),p.addEventListener("input",()=>{const b=p.value.toLowerCase();if(!b){E.classList.add("hidden");return}const B=this.masterIngredientList.filter(l=>l.name.toLowerCase().includes(b));E.innerHTML="",B.forEach(l=>{const N=document.createElement("div");N.className="p-2 ingredient-search-item cursor-pointer",N.textContent=l.name,N.addEventListener("click",()=>{p.value=l.name,f.value=l.unit,E.classList.add("hidden"),n[i].name=l.name,n[i].unit=l.unit,n[i].id=l.id}),E.appendChild(N)});const U=document.createElement("div");U.className="p-2 bg-blue-50 hover:bg-blue-200 cursor-pointer font-bold text-blue-700",U.textContent=`+ Cr√©er "${p.value}"`,U.addEventListener("click",async()=>{const l=p.value,N="pi√®ce(s)";try{const A=await _e(J(this.db,"ingredients"),{name:l,unit:N});await this.fetchMasterIngredients(),p.value=l,f.value=N,E.classList.add("hidden"),n[i].name=l,n[i].unit=N,n[i].id=A.id}catch(A){console.error("Erreur d'ajout d'ingr√©dient",A),alert("L'ingr√©dient n'a pas pu √™tre cr√©√©.")}}),E.appendChild(U),E.classList.remove("hidden")});const I=document.createElement("button");I.type="button",I.className="btn btn-ghost text-red-500 hover:bg-red-50 btn-sm mt-1",I.innerHTML='<i class="fas fa-trash"></i>',I.addEventListener("click",()=>{a.remove(),n[i]=null}),a.appendChild(g),a.appendChild(c),a.appendChild(f),a.appendChild(I),this.ingredientsListDiv.appendChild(a)}async handleSubmit(t){t.preventDefault(),this.saveRecipeBtn.disabled=!0,this.saveRecipeBtn.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i> Sauvegarde...',console.log("Ingredients array from form before filter:",this.form.ingredients);const n=this.form.ingredients.filter(i=>i!==null&&i.quantity&&i.name);console.log("Ingredients array after filter:",n);const a={name:this.recipeNameInput.value,category:this.recipeCategoryInput.value,servings:parseInt(this.recipeServingsInput.value)||0,prepTime:parseInt(this.recipePrepTimeInput.value)||0,difficulty:this.recipeDifficultyInput.value,steps:this.recipeStepsTextarea.value,ingredients:n,imageUrl:this.recipeImageUrlInput.value||`https://loremflickr.com/400/300/${encodeURIComponent(this.recipeNameInput.value)}`};console.log("Recipe data being sent to Firebase:",a);const r=this.recipeIdInput.value;try{r?await gt(H(this.db,"recipes",r),a):await _e(J(this.db,"recipes"),a),this.closeForm(),console.log("Recipe saved successfully!"),this.onSaveCallback&&this.onSaveCallback()}catch(i){console.error("Erreur de sauvegarde: ",i),alert("Une erreur est survenue lors de la sauvegarde.")}finally{this.saveRecipeBtn.disabled=!1,this.saveRecipeBtn.textContent="Sauvegarder"}}setOnSaveCallback(t){this.onSaveCallback=t}}const ea=Object.freeze(Object.defineProperty({__proto__:null,RecipeFormHandler:Ot},Symbol.toStringTag,{value:"Module"}));let Rt=()=>{};function ta(){const e=document.getElementById("search-friends-input");return document.getElementById("search-friends-btn").addEventListener("click",()=>tn(e.value)),e.addEventListener("keyup",n=>{n.key==="Enter"&&tn(e.value)}),na(),fn(),()=>{Rt&&Rt()}}async function na(){const e=document.getElementById("friends-list-container"),t=Re()?.uid;if(!t||!e)return;e.innerHTML='<p class="text-gray-500">Chargement...</p>';const n=H(w,"users",t);Rt=Ve(n,async a=>{if(!a.exists()){e.innerHTML='<p class="text-red-500">Erreur: Utilisateur non trouv√©.</p>';return}const r=a.data().friends||[];if(e.innerHTML="",r.length===0){e.innerHTML=`<p class="text-gray-500">Vous n'avez pas encore d'amis. Utilisez la recherche pour en ajouter.</p>`;return}for(const i of r)try{const c=await Se(H(w,"users",i));c.exists()&&e.appendChild(aa(c.data()))}catch(c){console.error("Erreur de chargement d'un ami",c)}})}function aa(e){const t=document.createElement("div");t.className="bg-white p-3 rounded-lg flex items-center justify-between shadow-sm";const n=document.createElement("div");n.className="flex items-center",n.innerHTML=`
        <img src="${e.photoURL||"https://placehold.co/40"}" alt="Avatar" class="w-10 h-10 rounded-full mr-3">
        <div>
            <p class="font-bold">${e.displayName}</p>
            <p class="text-sm text-gray-500">${e.email}</p>
        </div>
    `;const a=document.createElement("button");return a.className="btn btn-ghost text-red-500 btn-sm",a.innerHTML='<i class="fas fa-user-times"></i>',a.title="Retirer cet ami",a.addEventListener("click",()=>sa(e.uid)),t.appendChild(n),t.appendChild(a),t}async function sa(e){const t=Re()?.uid;if(!t||!e){console.error("Impossible de supprimer l'ami : ID utilisateur ou ID ami manquant.");return}if(!confirm("Voulez-vous vraiment retirer cet ami ? Cette action est unilat√©rale."))return;console.log(`Tentative de suppression de l'ami ${e} pour l'utilisateur ${t}`);const n=H(w,"users",t);try{await Pe(n,{friends:cn(e)}),console.log("Ami supprim√© avec succ√®s de la base de donn√©es.")}catch(a){console.error("Erreur lors de la suppression de l'ami: ",a),alert("Une erreur est survenue.")}}async function tn(e){const t=document.getElementById("search-results-container"),n=Re()?.uid;if(!(!e||!t)){t.innerHTML='<p class="text-gray-500">Recherche en cours...</p>';try{const a=e.toLowerCase(),r=a+"Ô£ø",i=Le(J(w,"users"),le("displayName_lowercase",">=",a),le("displayName_lowercase","<",r)),c=Le(J(w,"users"),le("email","==",a)),[f,g]=await Promise.all([Ee(i),Ee(c)]),p=new Map;if(f.forEach(E=>p.set(E.id,E.data())),g.forEach(E=>p.set(E.id,E.data())),t.innerHTML="",p.size===0){t.innerHTML='<p class="text-gray-500">Aucun utilisateur trouv√©.</p>';return}p.forEach(E=>{if(E.uid===n)return;const I=document.createElement("div");I.className="bg-gray-50 p-2 rounded-lg flex items-center justify-between",I.innerHTML=`
                <div class="flex items-center">
                    <img src="${E.photoURL||"https://placehold.co/32"}" class="w-8 h-8 rounded-full mr-2">
                    <span class="font-medium text-sm">${E.displayName} (${E.email})</span>
                </div>
            `;const b=document.createElement("button");b.className="btn btn-secondary btn-xs",b.innerHTML='<i class="fas fa-user-plus"></i>',b.addEventListener("click",()=>ra(E.uid)),I.appendChild(b),t.appendChild(I)})}catch(a){console.error("Erreur de recherche: ",a),t.innerHTML='<p class="text-red-500">Erreur de recherche.</p>'}}}async function ra(e){const t=Re()?.uid;if(!t||t===e)return;const n=Le(J(w,"friend_requests"),le("senderId","==",t),le("receiverId","==",e)),a=Le(J(w,"friend_requests"),le("senderId","==",e),le("receiverId","==",t)),[r,i]=await Promise.all([Ee(n),Ee(a)]);if(!r.empty||!i.empty)return alert("Une demande d'ami existe d√©j√† avec cet utilisateur.");if((await Se(H(w,"users",t))).data()?.friends?.includes(e))return alert("Vous √™tes d√©j√† ami avec cet utilisateur.");try{await _e(J(w,"friend_requests"),{senderId:t,receiverId:e,status:"pending",createdAt:wt()}),alert("Demande d'ami envoy√©e !")}catch(f){console.error("Erreur lors de l'envoi de la demande d'ami: ",f),alert("Une erreur est survenue.")}}async function fn(){const e=document.getElementById("pending-requests-container"),t=document.getElementById("declined-requests-container"),n=Re()?.uid;if(!(!n||!e||!t)){e.innerHTML='<p class="text-gray-500">Chargement...</p>',t.innerHTML='<p class="text-gray-500">Chargement...</p>';try{const a=Le(J(w,"friend_requests"),le("senderId","==",n)),r=await Ee(a),i=[],c=[];for(const f of r.docs){const g={id:f.id,...f.data()},p=await Se(H(w,"users",g.receiverId));p.exists()&&(g.receiver=p.data()),g.status==="pending"?i.push(g):g.status==="declined"&&c.push(g)}e.innerHTML="",i.length>0?i.forEach(f=>e.appendChild(nn(f))):e.innerHTML='<p class="text-gray-500">Aucune demande en attente.</p>',t.innerHTML="",c.length>0?c.forEach(f=>t.appendChild(nn(f))):t.innerHTML='<p class="text-gray-500">Aucune demande rejet√©e.</p>'}catch(a){console.error("Erreur lors du chargement des demandes envoy√©es: ",a),e.innerHTML='<p class="text-red-500">Erreur de chargement.</p>',t.innerHTML='<p class="text-red-500">Erreur de chargement.</p>'}}}function nn(e){const t=document.createElement("div");t.className="bg-white p-3 rounded-lg flex items-center justify-between shadow-sm";const n=e.receiver,a=document.createElement("div");a.className="flex items-center",a.innerHTML=`
        <img src="${n?.photoURL||"https://placehold.co/40"}" alt="Avatar" class="w-10 h-10 rounded-full mr-3">
        <div>
            <p class="font-bold">${n?.displayName||"Utilisateur inconnu"}</p>
            <p class="text-sm text-gray-500">Statut : <span class="font-medium">${e.status}</span></p>
        </div>
    `;const r=document.createElement("button");return r.className="btn btn-ghost text-red-500 btn-sm",r.innerHTML='<i class="fas fa-times-circle"></i>',r.title="Annuler la demande",r.addEventListener("click",async()=>{confirm("Voulez-vous vraiment annuler cette demande ?")&&(await Fe(H(w,"friend_requests",e.id)),fn())}),t.appendChild(a),t.appendChild(r),t}async function gn(e){try{const t=H(w,"friend_requests",e);await Pe(t,{status:"accepted"})}catch(t){throw console.error("Erreur lors de l'acceptation de la demande d'ami: ",t),t}}async function hn(e){try{const t=H(w,"friend_requests",e);await Pe(t,{status:"declined"})}catch(t){throw console.error("Erreur lors du refus de la demande d'ami: ",t),t}}const ia=Object.freeze(Object.defineProperty({__proto__:null,acceptFriendRequest:gn,declineFriendRequest:hn,default:ta},Symbol.toStringTag,{value:"Module"}));function oa(){const e=document.getElementById("ingredients-list-container"),t=document.getElementById("add-ingredient-btn"),n=document.getElementById("category-tabs"),a=document.getElementById("search-bar"),r=document.getElementById("ingredient-form-modal"),i=document.getElementById("ingredient-modal-title"),c=document.getElementById("close-ingredient-modal"),f=document.getElementById("cancel-ingredient-btn"),g=document.getElementById("ingredient-form"),p=document.getElementById("ingredient-id"),E=document.getElementById("ingredient-name"),I=document.getElementById("ingredient-unit"),b=document.getElementById("ingredient-category"),B=document.getElementById("manage-categories-btn"),U=document.getElementById("category-management-modal"),l=document.getElementById("close-category-modal"),N=document.getElementById("done-category-modal-btn"),A=document.getElementById("add-category-form"),ae=document.getElementById("new-category-name"),D=document.getElementById("category-list");let k=[],S=[],j="",Q="",oe=null;const ne=["g","kg","ml","l","pi√®ce(s)","c.√†.s.","c.√†.c.","pinc√©e(s)"];async function X(){await re(),await ee()}async function re(){if(w)try{S=(await Ee(J(w,"ingredient_categories"))).docs.map(F=>({id:F.id,...F.data()})),S.sort((F,P)=>F.name.localeCompare(P.name))}catch(W){console.error("Erreur lors de la r√©cup√©ration des cat√©gories: ",W)}}async function ee(){if(w)try{k=(await Ee(J(w,"ingredients"))).docs.map(F=>({id:F.id,...F.data()})),se(),he()}catch(W){console.error("Erreur de chargement des ingr√©dients: ",W)}}function pe(W=null){g.reset(),I.innerHTML="",ne.forEach(V=>{const de=document.createElement("option");de.value=V,de.textContent=V,I.appendChild(de)});const F=S.map(V=>V.name),P=[...new Set(k.map(V=>V.category).filter(Boolean))],_=[...new Set([...F,...P])];_.sort((V,de)=>V.localeCompare(de.name)),b.innerHTML="",_.forEach(V=>{const de=document.createElement("option");de.value=V,de.textContent=V,b.appendChild(de)}),W?(i.textContent="Modifier l'ingr√©dient",p.value=W.id,E.value=W.name,I.value=W.unit||"",b.value=W.category||(_.length>0?_[0]:""),document.getElementById("ingredient-image-url").value=W.imageUrl||""):(i.textContent="Ajouter un ingr√©dient",p.value="",I.value=ne[0],b.value=j||(_.length>0?_[0]:"")),r.classList.remove("hidden")}function Te(){r.classList.add("hidden")}async function R(W){W.preventDefault();const F=p.value,P={name:E.value,unit:I.value,category:b.value,imageUrl:document.getElementById("ingredient-image-url").value||`https://loremflickr.com/400/300/${encodeURIComponent(E.value)}`};if(!P.name||!P.category){alert("Le nom et la cat√©gorie sont requis.");return}try{F?await gt(H(w,"ingredients",F),P):await _e(J(w,"ingredients"),P),Te(),await ee()}catch(_){console.error("Erreur de sauvegarde de l'ingr√©dient: ",_)}}function T(){z(),U.classList.remove("hidden")}function O(){U.classList.add("hidden")}function z(){if(D.innerHTML="",S.length===0){D.innerHTML='<p class="text-gray-500">Aucune cat√©gorie d√©finie.</p>';return}S.forEach(W=>{const F=document.createElement("div");F.className="flex items-center justify-between p-2 border-b";const P=document.createElement("span");P.textContent=W.name,F.appendChild(P);const _=document.createElement("div");_.className="flex space-x-2";const V=document.createElement("button");V.className="btn btn-ghost btn-xs text-blue-500",V.innerHTML='<i class="fas fa-edit"></i>',V.addEventListener("click",()=>te(W)),_.appendChild(V);const de=document.createElement("button");de.className="btn btn-ghost btn-xs text-red-500",de.innerHTML='<i class="fas fa-trash"></i>',de.addEventListener("click",()=>Ce(W)),_.appendChild(de),F.appendChild(_),D.appendChild(F)})}async function Y(W){W.preventDefault();const F=ae.value.trim();if(F&&!S.find(P=>P.name.toLowerCase()===F.toLowerCase()))try{await _e(J(w,"ingredient_categories"),{name:F}),ae.value="",await re(),z(),se()}catch(P){console.error("Erreur d'ajout de cat√©gorie: ",P)}else alert("Cette cat√©gorie existe d√©j√† ou le nom est invalide.")}async function te(W){const F=W.name,P=prompt(`Entrez le nouveau nom pour la cat√©gorie "${F}":`,F);if(P&&P.trim()!==""&&P!==F)try{await gt(H(w,"ingredient_categories",W.id),{name:P});const _=Le(J(w,"ingredients"),le("category","==",F)),V=await Ee(_),de=Yt(w);V.forEach(Ke=>{de.update(Ke.ref,{category:P})}),await de.commit(),await X(),z()}catch(_){console.error("Erreur de renommage: ",_)}}async function Ce(W){if(confirm(`√ätes-vous s√ªr de vouloir supprimer la cat√©gorie "${W.name}"?

Tous les ingr√©dients associ√©s seront d√©plac√©s vers la cat√©gorie "Inconnue".`))try{await Fe(H(w,"ingredient_categories",W.id));const F=Le(J(w,"ingredients"),le("category","==",W.name)),P=await Ee(F),_=Yt(w);P.forEach(V=>{_.update(V.ref,{category:"Inconnue"})}),await _.commit(),j="",await X(),z()}catch(F){console.error("Erreur de suppression: ",F)}}function se(){n.innerHTML="";const W=S.map(_=>_.name),F=[...new Set(k.map(_=>_.category||"Inconnue"))];let P=[...new Set([...W,...F])];P.sort((_,V)=>_.localeCompare(V)),P.includes("Inconnue")&&(P=P.filter(_=>_!=="Inconnue"),P.push("Inconnue")),P.length===0&&k.length>0&&P.push("Inconnue"),!j&&P.length>0&&(j=P[0]),P.forEach(_=>{const V=document.createElement("button"),de=_===j;V.className=`px-4 py-2 text-sm font-medium rounded-t-lg ${de?"bg-tomato text-white":"text-gray-500 hover:text-tomato"}`,V.textContent=_,V.addEventListener("click",()=>fe(_)),n.appendChild(V)})}function fe(W){j=W,se(),he()}function he(){e.innerHTML="";const W=j||(S.length>0?S[0].name:"Inconnue");let F=k.filter(_=>(_.category||"Inconnue")===W);if(Q){const _=Q.toLowerCase();F=F.filter(V=>V.name.toLowerCase().includes(_))}if(F.length===0){e.innerHTML='<p class="text-center text-gray-500 p-10">Aucun ingr√©dient dans cette cat√©gorie.</p>';return}F.sort((_,V)=>_.name.localeCompare(V.name,"fr",{sensitivity:"base"}));const P=document.createElement("div");P.className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4",F.forEach(_=>{const V=document.createElement("div");if(V.className="p-3 bg-white shadow-sm rounded-lg flex flex-col items-start space-y-2",_.imageUrl){const at=document.createElement("img");at.src=_.imageUrl,at.alt=_.name,at.className="w-full h-24 object-cover rounded-md mb-2",V.appendChild(at)}const de=document.createElement("div");de.className="flex-grow w-full flex justify-between items-center";const Ke=document.createElement("span");Ke.className="font-medium text-gray-800",Ke.textContent=_.name;const et=document.createElement("span");et.className="text-gray-500 text-sm bg-gray-100 px-2 py-1 rounded-full",et.textContent=_.unit,de.appendChild(Ke),de.appendChild(et);const Ye=document.createElement("div");Ye.className="w-full flex justify-end items-center space-x-2 border-t pt-2 mt-2";const tt=document.createElement("button");tt.className="btn btn-ghost btn-xs text-blue-500 hover:bg-blue-50",tt.innerHTML='<i class="fas fa-edit"></i>',tt.addEventListener("click",()=>pe(_));const nt=document.createElement("button");nt.className="btn btn-ghost btn-xs text-red-500 hover:bg-red-50",nt.innerHTML='<i class="fas fa-trash-alt"></i>',nt.addEventListener("click",()=>De(_.id,_.name)),Ye.appendChild(tt),Ye.appendChild(nt),V.appendChild(de),V.appendChild(Ye),P.appendChild(V)}),e.appendChild(P)}async function De(W,F){if(confirm(`√ätes-vous s√ªr de vouloir supprimer l'ingr√©dient "${F}" ?`))try{await Fe(H(w,"ingredients",W)),await ee()}catch(P){console.error("Erreur de suppression de l'ingr√©dient: ",P)}}a.addEventListener("input",W=>{const F=W.target.value.toLowerCase();if(!Q&&F&&(oe=j),Q=F,Q){const P=k.find(_=>_.name.toLowerCase().includes(Q));P&&(j=P.category||"Inconnue")}else oe&&(j=oe,oe=null);se(),he()}),t.addEventListener("click",()=>pe()),c.addEventListener("click",Te),f.addEventListener("click",Te),g.addEventListener("submit",R),B.addEventListener("click",T),l.addEventListener("click",O),N.addEventListener("click",O),A.addEventListener("submit",Y),X()}const la=Object.freeze(Object.defineProperty({__proto__:null,default:oa},Symbol.toStringTag,{value:"Module"})),K={modal:document.getElementById("share-modal"),closeBtn:document.getElementById("close-share-modal"),title:document.getElementById("share-modal-title"),friendsList:document.getElementById("share-friends-list"),sharePlanCheckbox:document.getElementById("share-planning-checkbox"),shareShoppingListCheckbox:document.getElementById("share-shopping-list-checkbox"),confirmBtn:document.getElementById("confirm-share-btn")};let ze={};function kt(){K.modal.classList.add("hidden");const e=document.getElementById("share-mode-selection");e&&e.classList.remove("hidden"),K.confirmBtn.textContent="Envoyer le partage";const t=K.confirmBtn.cloneNode(!0);K.confirmBtn.parentNode&&(K.confirmBtn.parentNode.replaceChild(t,K.confirmBtn),K.confirmBtn=t,t.addEventListener("click",yn))}async function yn(){const e=Ie();if(!e||!ze.plan)return;const t=Array.from(K.friendsList.querySelectorAll('input[type="checkbox"]:checked')).map(a=>a.value),n=document.querySelector('input[name="share-mode"]:checked')?.value;if(t.length===0){alert("Veuillez s√©lectionner au moins un ami.");return}if(!n){alert("Veuillez s√©lectionner un mode de partage.");return}K.confirmBtn.disabled=!0,K.confirmBtn.textContent="Envoi en cours...";try{const a=J(w,"shares");let r={};n==="collaborate"?r={senderId:e,createdAt:new Date,type:"collaborative_plan_invite",planId:ze.plan.id,planName:ze.plan.name}:r={senderId:e,createdAt:new Date,type:"share",plan:{name:ze.plan.name,weeks:ze.plan.weeks||{},manualItems:ze.plan.manualItems||[],defaultNumPeople:ze.plan.defaultNumPeople||1,startDay:ze.plan.startDay||"Lundi"}};for(const i of t)await _e(a,{...r,receiverId:i,status:"pending"});kt(),alert("Partage envoy√© avec succ√®s !")}catch(a){console.error("Erreur lors de l'envoi du partage : ",a),alert("Une erreur est survenue lors de l'envoi du partage.")}finally{K.confirmBtn.disabled=!1,K.confirmBtn.textContent="Envoyer le partage"}}async function zt(e={}){const{plan:t}=e;if(!t){alert("Aucun plan s√©lectionn√© √† partager.");return}ze={plan:t},K.title.textContent=`Partager le plan "${t.name}"`,K.friendsList.innerHTML='<p class="text-gray-500">Chargement des amis...</p>',K.modal.classList.remove("hidden");const n=Ie();if(n)try{const a=await Se(H(w,"users",n));if(a.exists()){const i=a.data().friends||[];if(i.length===0){K.friendsList.innerHTML=`<p class="text-gray-500">Vous n'avez pas d'amis √† qui partager.</p>`;return}K.friendsList.innerHTML="";for(const c of i){const f=await Se(H(w,"users",c));if(f.exists()){const g=f.data(),p=document.createElement("label");p.className="flex items-center p-2 hover:bg-gray-100 rounded-lg cursor-pointer";const E=document.createElement("input");E.type="checkbox",E.value=g.uid,E.className="form-checkbox h-5 w-5 text-tomato rounded focus:ring-tomato",p.appendChild(E);const I=document.createElement("img");I.src=g.photoURL||"https://placehold.co/40x40",I.alt=g.displayName,I.className="w-8 h-8 rounded-full ml-3 mr-3",p.appendChild(I);const b=document.createElement("span");b.className="font-medium",b.textContent=g.displayName||g.email,p.appendChild(b),K.friendsList.appendChild(p)}}}}catch(a){console.error("Erreur lors du chargement des amis pour le partage : ",a),K.friendsList.innerHTML='<p class="text-red-500">Une erreur est survenue.</p>'}}async function da(e){const t=Ie();if(!t||!e)return;const n=Array.from(K.friendsList.querySelectorAll('input[type="checkbox"]:checked:not(:disabled)')).map(a=>a.value);if(n.length===0){alert("Veuillez s√©lectionner au moins un ami √† inviter.");return}K.confirmBtn.disabled=!0,K.confirmBtn.textContent="Envoi en cours...";try{const a=await Se(H(w,"plans",e));if(!a.exists())throw new Error("Plan not found");const r=a.data().name,i=J(w,"shares"),c={senderId:t,createdAt:new Date,type:"collaborative_plan_invite",planId:e,planName:r};for(const f of n)await _e(i,{...c,receiverId:f,status:"pending"});kt(),alert("Invitation(s) envoy√©e(s) avec succ√®s !")}catch(a){console.error("Erreur lors de l'envoi de l'invitation : ",a),alert("Une erreur est survenue lors de l'envoi de l'invitation.")}finally{K.confirmBtn.disabled=!1}}async function vn(e){if(!e||!e.id){alert("Plan non valide pour l'invitation.");return}ze={plan:e},K.title.textContent=`Inviter √† collaborer sur "${e.name}"`;const t=document.getElementById("share-mode-selection");t&&t.classList.add("hidden"),K.friendsList.innerHTML='<p class="text-gray-500">Chargement des amis...</p>',K.modal.classList.remove("hidden");const n=Ie();if(!n)return;try{const r=await Se(H(w,"users",n));if(r.exists()){const c=r.data().friends||[],f=[e.userId,...e.collaborators||[]];if(c.length===0){K.friendsList.innerHTML=`<p class="text-gray-500">Vous n'avez pas d'amis √† inviter.</p>`;return}K.friendsList.innerHTML="";for(const g of c){const p=await Se(H(w,"users",g));if(p.exists()){const E=p.data(),I=f.includes(E.uid),b=document.createElement("label");b.className=`flex items-center p-2 rounded-lg ${I?"opacity-50 cursor-not-allowed":"hover:bg-gray-100 cursor-pointer"}`;const B=document.createElement("input");B.type="checkbox",B.value=E.uid,B.className="form-checkbox h-5 w-5 text-tomato rounded focus:ring-tomato",I&&(B.disabled=!0,B.checked=!0),b.appendChild(B);const U=document.createElement("img");U.src=E.photoURL||"https://placehold.co/40x40",U.alt=E.displayName,U.className="w-8 h-8 rounded-full ml-3 mr-3",b.appendChild(U);const l=document.createElement("span");if(l.className="font-medium",l.textContent=E.displayName||E.email,I){const N=document.createElement("span");N.className="text-xs text-gray-400 ml-2",N.textContent="(d√©j√† membre)",l.appendChild(N)}b.appendChild(l),K.friendsList.appendChild(b)}}}}catch(r){console.error("Erreur lors du chargement des amis pour l'invitation : ",r),K.friendsList.innerHTML='<p class="text-red-500">Une erreur est survenue.</p>'}K.confirmBtn.textContent="Envoyer l'invitation";const a=K.confirmBtn.cloneNode(!0);K.confirmBtn.parentNode.replaceChild(a,K.confirmBtn),K.confirmBtn=a,a.addEventListener("click",()=>da(e.id))}K.closeBtn?.addEventListener("click",kt);K.modal?.addEventListener("click",e=>{e.target===K.modal&&kt()});K.confirmBtn?.addEventListener("click",yn);const ca=Object.freeze(Object.defineProperty({__proto__:null,openInviteParticipantModal:vn,openShareModal:zt},Symbol.toStringTag,{value:"Module"}));function ua(){const e=document.getElementById("search-bar"),t=document.getElementById("lists-container"),n=document.getElementById("add-list-btn"),a=document.getElementById("shared-lists-container"),r=document.getElementById("list-form-modal"),i=document.getElementById("list-modal-title"),c=document.getElementById("close-list-modal"),f=document.getElementById("cancel-list-btn"),g=document.getElementById("list-form"),p=document.getElementById("list-id"),E=document.getElementById("list-name"),I=document.getElementById("ingredients-list"),b=document.getElementById("add-ingredient-btn"),B=document.getElementById("save-list-btn");let U=[],l="",N=[],A=[];async function ae(){await D(),await k(),await S()}async function D(){if(w)try{N=(await Ee(J(w,"ingredients"))).docs.map(T=>({id:T.id,...T.data()})),N.sort((T,O)=>T.name.localeCompare(O.name))}catch(R){console.error("Erreur lors de la r√©cup√©ration de la liste des ingr√©dients: ",R)}}async function k(){const R=Ie();if(!(!w||!R))try{const T=Le(J(w,"shopping_lists"),le("userId","==",R));U=(await Ee(T)).docs.map(z=>({id:z.id,...z.data()})).filter(z=>z.isShared!==!0),X()}catch(T){console.error("Erreur de chargement des listes: ",T)}}async function S(){const R=Ie();if(!(!w||!R)){console.log(`Recherche de listes partag√©es pour userId: ${R}`);try{const T=Le(J(w,"shopping_lists"),le("userId","==",R),le("isShared","==",!0)),O=await Ee(T);console.log(`Trouv√© ${O.size} liste(s) partag√©e(s).`);const z=O.docs.map(Y=>({id:Y.id,...Y.data()}));re(z)}catch(T){console.error("Erreur de chargement des listes partag√©es: ",T)}}}async function j(R=null){await D(),g.reset(),I.innerHTML="",A=[],R?(i.textContent="Modifier la liste",p.value=R.id,E.value=R.name,R.ingredients&&R.ingredients.length>0?R.ingredients.forEach(T=>ne(T)):ne()):(i.textContent="Cr√©er une liste",p.value="",ne()),r.classList.remove("hidden")}function Q(){r.classList.add("hidden")}async function oe(R){R.preventDefault(),B.disabled=!0;const T=Ie();if(!T){alert("Erreur : utilisateur non connect√©."),B.disabled=!1;return}const O=A.filter(te=>te&&te.name&&te.quantity),z={name:E.value,ingredients:O,userId:T};if(!z.name){alert("Le nom de la liste est requis."),B.disabled=!1;return}const Y=p.value;try{Y?await gt(H(w,"shopping_lists",Y),z):await _e(J(w,"shopping_lists"),z),Q(),await k()}catch(te){console.error("Erreur de sauvegarde de la liste: ",te)}finally{B.disabled=!1}}function ne(R={quantity:"",name:"",unit:""}){const T=document.createElement("div");T.className="relative flex items-stretch space-x-2 ingredient-row";const O={...R};A.push(O);const z=A.length-1,Y=document.createElement("input");Y.type="text",Y.className="ingredient-quantity mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm",Y.placeholder="Qt√©",Y.value=O.quantity,Y.addEventListener("change",De=>{A[z].quantity=De.target.value});const te=document.createElement("input");te.type="text",te.className="ingredient-unit mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm bg-gray-100",te.placeholder="Unit√©",te.readOnly=!0,te.value=O.unit||"";const Ce=document.createElement("div");Ce.className="relative w-1/2";const se=document.createElement("input");se.type="text",se.className="ingredient-name mt-1 block w-full rounded-md border-gray-300 shadow-sm",se.placeholder="Chercher un ingr√©dient...",se.value=O.name,Ce.appendChild(se);const fe=document.createElement("div");fe.className="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto",Ce.appendChild(fe),se.addEventListener("input",()=>{const De=se.value.toLowerCase();if(!De){fe.classList.add("hidden");return}const W=N.filter(P=>P.name.toLowerCase().includes(De));fe.innerHTML="",W.forEach(P=>{const _=document.createElement("div");_.className="p-2 ingredient-search-item cursor-pointer",_.textContent=P.name,_.addEventListener("click",()=>{se.value=P.name,te.value=P.unit,fe.classList.add("hidden"),A[z].name=P.name,A[z].unit=P.unit,A[z].id=P.id}),fe.appendChild(_)});const F=document.createElement("div");F.className="p-2 bg-blue-50 hover:bg-blue-200 cursor-pointer font-bold text-blue-700",F.textContent=`+ Cr√©er "${se.value}"`,F.addEventListener("click",async()=>{const P=se.value,_="pi√®ce(s)";try{const V=await _e(J(w,"ingredients"),{name:P,unit:_,category:"Inconnue"});await D(),se.value=P,te.value=_,fe.classList.add("hidden"),A[z].name=P,A[z].unit=_,A[z].id=V.id}catch(V){console.error("Erreur d'ajout d'ingr√©dient",V),alert("L'ingr√©dient n'a pas pu √™tre cr√©√©.")}}),fe.appendChild(F),fe.classList.remove("hidden")});const he=document.createElement("button");he.type="button",he.className="btn btn-ghost text-red-500 hover:bg-red-50 btn-sm mt-1",he.innerHTML='<i class="fas fa-trash"></i>',he.addEventListener("click",()=>{T.remove(),A[z]=null}),T.appendChild(Ce),T.appendChild(Y),T.appendChild(te),T.appendChild(he),I.appendChild(T)}function X(){t.innerHTML="";let R=U;if(l){const T=l.toLowerCase();R=U.filter(O=>O.name.toLowerCase().includes(T))}if(R.length===0){t.innerHTML='<p class="text-center text-gray-500 p-10 col-span-full">Aucune liste de courses trouv√©e.</p>';return}R.sort((T,O)=>T.name.localeCompare(O.name)),R.forEach(T=>{const O=document.createElement("div");O.className="bg-white rounded-lg shadow-md p-4 flex flex-col";const z=document.createElement("div");z.className="flex justify-between items-start border-b pb-2 mb-2";const Y=document.createElement("h4");Y.className="text-lg font-bold text-gray-800",Y.textContent=T.name,z.appendChild(Y);const te=document.createElement("div");te.className="flex space-x-2";const Ce=document.createElement("button");Ce.className="btn btn-ghost btn-sm text-blue-500",Ce.innerHTML='<i class="fas fa-edit"></i>',Ce.addEventListener("click",()=>j(T)),te.appendChild(Ce);const se=document.createElement("button");se.className="btn btn-ghost btn-sm text-green-500",se.innerHTML='<i class="fas fa-share-alt"></i>',se.addEventListener("click",()=>zt({})),te.appendChild(se);const fe=document.createElement("button");fe.className="btn btn-ghost btn-sm text-red-500",fe.innerHTML='<i class="fas fa-trash"></i>',fe.addEventListener("click",()=>ee(T.id,T.name)),te.appendChild(fe),z.appendChild(te);const he=document.createElement("ul");he.className="space-y-1 text-sm text-gray-600 flex-grow",T.ingredients&&T.ingredients.length>0?T.ingredients.forEach(De=>{const W=document.createElement("li");W.textContent=`${De.quantity} ${De.unit||""} - ${De.name}`.trim(),he.appendChild(W)}):he.innerHTML='<li class="italic text-gray-400">Cette liste est vide.</li>',O.appendChild(z),O.appendChild(he),t.appendChild(O)})}function re(R){if(a.innerHTML="",R.length===0){a.innerHTML='<p class="text-center text-gray-500 p-10 col-span-full">Aucune liste de courses partag√©e trouv√©e.</p>';return}R.sort((T,O)=>T.name.localeCompare(O.name)),R.forEach(T=>{const O=document.createElement("div");O.className="bg-white rounded-lg shadow-md p-4 flex flex-col";const z=document.createElement("div");z.className="flex justify-between items-start border-b pb-2 mb-2";const Y=document.createElement("h4");Y.className="text-lg font-bold text-gray-800",Y.textContent=T.name,z.appendChild(Y);const te=document.createElement("div");te.className="flex space-x-2";const Ce=document.createElement("button");Ce.className="btn btn-secondary btn-sm",Ce.innerHTML='<i class="fas fa-copy mr-2"></i> Copier dans mes listes',Ce.title="Copier cette liste dans vos listes personnelles",Ce.addEventListener("click",()=>Te(T.id)),te.appendChild(Ce);const se=document.createElement("button");se.className="btn btn-ghost btn-sm text-red-500",se.innerHTML='<i class="fas fa-trash"></i>',se.title="Supprimer cette liste partag√©e",se.addEventListener("click",()=>pe(T.id,T.name)),te.appendChild(se),z.appendChild(te);const fe=document.createElement("ul");fe.className="space-y-1 text-sm text-gray-600 flex-grow",T.ingredients&&T.ingredients.length>0?T.ingredients.forEach(he=>{const De=document.createElement("li");De.textContent=`${he.quantity} ${he.unit||""} - ${he.name}`.trim(),fe.appendChild(De)}):fe.innerHTML='<li class="italic text-gray-400">Cette liste est vide.</li>',O.appendChild(z),O.appendChild(fe),a.appendChild(O)})}async function ee(R,T){if(confirm(`√ätes-vous s√ªr de vouloir supprimer la liste "${T}" ?`))try{await Fe(H(w,"shopping_lists",R)),await k()}catch(O){console.error("Erreur de suppression de la liste: ",O)}}async function pe(R,T){if(confirm(`√ätes-vous s√ªr de vouloir supprimer la liste partag√©e "${T}" ?`))try{await Fe(H(w,"shopping_lists",R)),await S()}catch(O){console.error("Erreur de suppression de la liste partag√©e: ",O),alert("Une erreur est survenue.")}}async function Te(R){if(confirm("Voulez-vous vraiment copier cette liste dans vos listes personnelles ? Elle ne sera plus consid√©r√©e comme une liste partag√©e."))try{const T=H(w,"shopping_lists",R);await Pe(T,{isShared:!1}),await ae()}catch(T){console.error("Erreur lors de la copie de la liste: ",T),alert("Une erreur est survenue.")}}e.addEventListener("input",R=>{l=R.target.value,X()}),n.addEventListener("click",()=>j()),c.addEventListener("click",Q),f.addEventListener("click",Q),g.addEventListener("submit",oe),b.addEventListener("click",()=>ne()),w&&ae()}const ma=Object.freeze(Object.defineProperty({__proto__:null,default:ua},Symbol.toStringTag,{value:"Module"})),Ue=un();let ht,Nt,Tt,pt,xe,yt,Dt,_t,ft,Ze,vt,Pt,$t,At,jt,Ct=null,It=null;function qt(){ht&&ht.classList.remove("hidden")}function ut(){ht&&ht.classList.add("hidden"),pt&&pt.reset()}function bn(e,t){It=e,Ze&&(Ze.value=t),yt&&yt.classList.remove("hidden"),Ze&&Ze.focus()}function mt(){It=null,yt&&yt.classList.add("hidden"),ft&&ft.reset()}function xn(e,t){Ct=e,At&&(At.textContent="Confirmer la suppression"),jt&&(jt.textContent=`√ätes-vous s√ªr de vouloir supprimer le plan "${t}" ? Cette action est irr√©versible.`),vt&&vt.classList.remove("hidden")}function Ht(){Ct=null,vt&&vt.classList.add("hidden")}async function pa(e){const t=Re();if(t)try{await _e(J(Ue,"plans"),{userId:t.uid,name:e,type:"personal",weeks:{},manualItems:[],checkedItems:{},defaultNumPeople:1,startDay:"Lundi",lastUpdated:new Date}),ut()}catch(n){console.error("Error creating plan: ",n),alert("Erreur lors de la cr√©ation du plan.")}}async function fa(e,t){if(!(!e||!t))try{const n=H(Ue,"plans",e);await Pe(n,{name:t}),mt()}catch(n){console.error("Error renaming plan: ",n),alert("Erreur lors du renommage du plan.")}}async function ga(e){const t=Re()?.uid;if(!(!e||!t)&&confirm("Voulez-vous vraiment quitter ce plan partag√© ? Il n'appara√Ætra plus dans votre liste."))try{const n=H(Ue,"plans",e);await Pe(n,{collaborators:cn(t)})}catch(n){console.error("Erreur pour quitter le plan: ",n),alert("Une erreur est survenue.")}}async function ha(e){if(e)try{await Fe(H(Ue,"plans",e))}catch(t){console.error("Error deleting plan: ",t),alert("Erreur lors de la suppression du plan.")}}function Vt(e){const t=Re();if(!t)return()=>{};let n=new Map;const a=()=>{e(Array.from(n.values()).sort((p,E)=>p.name.localeCompare(E.name)))},r=async p=>{const I=[p.userId,...p.collaborators||[]].map(B=>Se(H(Ue,"users",B)));return(await Promise.all(I)).map(B=>B.exists()?B.data():{uid:B.id,displayName:"Inconnu"})},i=Le(J(Ue,"plans"),le("userId","==",t.uid)),c=Ve(i,async p=>{const I=p.docChanges().map(async b=>{if(b.type==="removed")n.delete(b.doc.id);else{const B=b.doc.data(),U=await r(B);n.set(b.doc.id,{id:b.doc.id,...B,isOwner:!0,participants:U})}});await Promise.all(I),a()}),f=Le(J(Ue,"plans"),le("collaborators","array-contains",t.uid)),g=Ve(f,async p=>{const I=p.docChanges().map(async b=>{if(b.type==="removed")n.delete(b.doc.id);else{const B=b.doc.data(),U=await r(B),l=U.find(N=>N.uid===B.userId);n.set(b.doc.id,{id:b.doc.id,...B,isOwner:!1,ownerName:l?.displayName||"Inconnu",participants:U})}});await Promise.all(I),a()});return()=>{c(),g()}}function En(e){if(!xe)return;const t=xe.value;if(xe.innerHTML="",e.length===0){const n=document.createElement("option");n.value="",n.textContent="Aucun plan personnel",n.disabled=!0,xe.appendChild(n);return}e.forEach(n=>{const a=document.createElement("option");a.value=n.id;let r=n.name;n.collaborators&&n.collaborators.length>0&&(n.isOwner?r=`üëë ${n.name} [Collab]`:r=`üë• ${n.name} [Collab] (de ${n.ownerName})`),a.textContent=r,xe.appendChild(a)}),t&&xe.querySelector(`option[value="${t}"]`)?xe.value=t:xe.selectedIndex=0}function wn(){ht=document.getElementById("create-plan-modal"),Nt=document.getElementById("close-create-plan-modal"),Tt=document.getElementById("cancel-create-plan-btn"),pt=document.getElementById("create-plan-form"),xe=document.getElementById("plan-select"),yt=document.getElementById("rename-plan-modal"),Dt=document.getElementById("close-rename-plan-modal"),_t=document.getElementById("cancel-rename-plan-btn"),ft=document.getElementById("rename-plan-form"),Ze=document.getElementById("new-plan-name"),vt=document.getElementById("delete-confirm-modal"),Pt=document.getElementById("cancel-delete-btn"),$t=document.getElementById("confirm-delete-btn"),At=document.getElementById("delete-confirm-title"),jt=document.getElementById("delete-confirm-message");const e=document.getElementById("create-plan-btn"),t=document.getElementById("rename-plan-btn"),n=document.getElementById("leave-plan-btn"),a=document.getElementById("delete-plan-btn"),r=E=>{E.preventDefault();const I=document.getElementById("plan-name");I&&I.value&&pa(I.value)},i=E=>{E.preventDefault(),It&&Ze.value&&fa(It,Ze.value)},c=()=>{Ct&&ha(Ct).then(()=>{Ht()})},f=()=>{if(xe&&xe.value){const E=xe.options[xe.selectedIndex];bn(xe.value,E.text)}else alert("Veuillez s√©lectionner un plan √† renommer.")},g=()=>{xe&&xe.value?ga(xe.value):alert("Veuillez s√©lectionner un plan.")},p=()=>{if(xe&&xe.value){const E=xe.options[xe.selectedIndex].text;xn(xe.value,E)}else alert("Veuillez s√©lectionner un plan √† supprimer.")};return e?.addEventListener("click",qt),t?.addEventListener("click",f),n?.addEventListener("click",g),a?.addEventListener("click",p),Nt?.addEventListener("click",ut),Tt?.addEventListener("click",ut),pt?.addEventListener("submit",r),Dt?.addEventListener("click",mt),_t?.addEventListener("click",mt),ft?.addEventListener("submit",i),Pt?.addEventListener("click",Ht),$t?.addEventListener("click",c),()=>{e?.removeEventListener("click",qt),t?.removeEventListener("click",f),n?.removeEventListener("click",g),a?.removeEventListener("click",p),Nt?.removeEventListener("click",ut),Tt?.removeEventListener("click",ut),pt?.removeEventListener("submit",r),Dt?.removeEventListener("click",mt),_t?.removeEventListener("click",mt),ft?.removeEventListener("submit",i),Pt?.removeEventListener("click",Ht),$t?.removeEventListener("click",c)}}async function Ln(e,t){if(!(!e||!t))try{const n=H(Ue,"plans",e);await Pe(n,{collaborators:qn(t),type:"collaborative"})}catch(n){console.error("Error adding collaborator: ",n)}}async function Ut(e,t,n="Modification diverse"){if(!e||!t)return;const a=Re();if(a)try{const r=J(Ue,"plans",e,"history"),i=JSON.parse(JSON.stringify(t));await _e(r,{planState:i,timestamp:wt(),modifiedBy:a.uid,modifiedByName:a.displayName||a.email,description:n})}catch(r){console.error("Error saving history:",r)}}async function Cn(e,t){const n=Re();if(!(!n||!e||!t))try{const a=J(Ue,"plan_saves"),r=Le(a,le("userId","==",n.uid),le("name","==",e)),i=await Ee(r);if(i.empty)await _e(a,{userId:n.uid,name:e,savedAt:wt(),planData:t});else{const c=i.docs[0].id,f=H(Ue,"plan_saves",c);await Pe(f,{planData:t,savedAt:wt()})}}catch(a){console.error("Error saving or updating plan save:",a),alert("Erreur lors de la sauvegarde.")}}async function ya(e,t,n){if(!e||!t||!n)return;const a=H(Ue,"plans",e);try{await Pe(a,{[`weeks.${t}`]:n,lastUpdated:new Date}),console.log(`Week ${t} of plan ${e} saved successfully.`)}catch(r){console.error("Error saving plan week:",r),alert("Erreur lors de la sauvegarde du plan.")}}const va=Object.freeze(Object.defineProperty({__proto__:null,addCollaborator:Ln,getUserPlans:Vt,initPlanManagement:wn,openCreatePlanModal:qt,openDeleteConfirmModal:xn,openRenamePlanModal:bn,populatePlanSelector:En,saveHistory:Ut,saveOrUpdatePlanSaveByName:Cn,savePlanWeek:ya},Symbol.toStringTag,{value:"Module"}));let In=[],kn=[],Bn=()=>{},Sn=()=>{};const Z={btn:null,btnMobile:null,badge:null,badgeMobile:null,dropdown:null,list:null};async function ba(e,t,n){const a=Ie();if(a)try{const r=H(w,"shares",e);if(await Pe(r,{status:"accepted"}),t.plan){const i=n.displayName||"Inconnu",c=`Copie de "${t.plan.name}" (de ${i})`,f={...t.plan,userId:a,name:c,isShared:!0,originalOwnerId:t.senderId,sharedAt:new Date,collaborators:[]};delete f.id,await _e(J(w,"plans"),f)}t.shoppingList&&await _e(J(w,"shopping_lists"),{name:`${t.shoppingList.name} (de ${n.displayName})`,ingredients:t.shoppingList.ingredients,userId:a,isShared:!0,originalOwner:n.uid,sharedAt:new Date})}catch(r){console.error("Erreur lors de l'acceptation du partage : ",r),alert("Une erreur est survenue.")}}async function xa(e,t){const n=Ie();if(!(!n||!t||!t.planId))try{await Ln(t.planId,n);const a=H(w,"shares",e);await Pe(a,{status:"accepted"})}catch(a){console.error("Erreur lors de l'acceptation de l'invitation : ",a),alert("Une erreur est survenue.")}}async function an(e){try{const t=H(w,"shares",e);await Pe(t,{status:"declined"})}catch(t){console.error("Erreur lors du refus du partage : ",t),alert("Une erreur est survenue.")}}async function Ea(e){try{await gn(e)}catch{alert("Erreur lors de l'acceptation.")}}async function wa(e){try{await hn(e)}catch{alert("Erreur lors du refus.")}}function Mn(){if(!Z.list)return;const e=[...In,...kn];e.sort((n,a)=>a.createdAt.toMillis()-n.createdAt.toMillis());const t=n=>{n&&(e.length>0?(n.textContent=e.length,n.classList.remove("hidden")):n.classList.add("hidden"))};t(Z.badge),t(Z.badgeMobile),Z.list.innerHTML="",e.length===0?Z.list.innerHTML='<p class="text-gray-500 text-center p-4">Aucune nouvelle notification.</p>':e.forEach(n=>{const a=La(n);Z.list.appendChild(a)})}function La(e){const t=document.createElement("div");t.className="p-3 border-b border-gray-100 hover:bg-gray-50";const n=document.createElement("p");n.className="text-sm font-medium text-gray-800";const a=document.createElement("p");a.className="text-xs text-gray-500 mb-3";const r=document.createElement("div");r.className="flex space-x-2 justify-end";const i=e.data.type||e.type;if(i==="collaborative_plan_invite"){n.textContent="Invitation √† collaborer",a.textContent=`${e.sender.displayName} vous invite √† modifier son plan "${e.data.planName}".`;const c=rt("Accepter","btn-secondary",g=>{g.target.textContent="...",g.target.disabled=!0,xa(e.id,e.data)}),f=rt("Refuser","btn-ghost text-red-500",g=>{g.target.disabled=!0,an(e.id)});r.append(c,f)}else if(i==="share"){n.textContent=`Partage de ${e.sender.displayName||e.sender.email}`;let c=[];e.data.plan&&c.push("planification"),e.data.shoppingList&&c.push("liste de courses"),a.textContent=`Contenu : ${c.join(" et ")}`;const f=rt("Accepter","btn-secondary",p=>{p.target.textContent="...",p.target.disabled=!0,ba(e.id,e.data,e.sender)}),g=rt("Refuser","btn-ghost text-red-500",p=>{p.target.disabled=!0,an(e.id)});r.append(f,g)}else if(i==="friend_request"){n.textContent="Invitation d'ami",a.textContent=`${e.sender.displayName||e.sender.email} vous a envoy√© une invitation.`;const c=rt("Accepter","btn-secondary",g=>{g.target.textContent="...",g.target.disabled=!0,Ea(e.id)}),f=rt("Refuser","btn-ghost text-red-500",g=>{g.target.disabled=!0,wa(e.id)});r.append(c,f)}return t.append(n,a,r),t}function rt(e,t,n){const a=document.createElement("button");return a.className=`btn btn-xs ${t}`,a.textContent=e,a.addEventListener("click",r=>{r.stopPropagation(),n(r)}),a}function Ca(e){const t=J(w,"shares"),n=Le(t,le("receiverId","==",e),le("status","==","pending"));Bn=Ve(n,async a=>{const r=[];for(const i of a.docs){const c=i.data(),f=await Se(H(w,"users",c.senderId));f.exists()&&r.push({type:c.type||"share",id:i.id,data:c,sender:f.data(),createdAt:c.createdAt})}In=r,Mn()},a=>{console.error("Erreur d'√©coute des partages:",a)})}function Ia(e){const t=J(w,"friend_requests"),n=Le(t,le("receiverId","==",e),le("status","==","pending"));Sn=Ve(n,async a=>{const r=[];for(const i of a.docs){const c=i.data(),f=await Se(H(w,"users",c.senderId));f.exists()&&r.push({type:"friend_request",id:i.id,data:c,sender:f.data(),createdAt:c.createdAt})}kn=r,Mn()},a=>{console.error("Erreur d'√©coute des invitations d'amis:",a)})}function Nn(){if(Z.btn=document.getElementById("notifications-btn"),Z.btnMobile=document.getElementById("notifications-btn-mobile"),Z.badge=document.getElementById("notifications-badge"),Z.badgeMobile=document.getElementById("notifications-badge-mobile"),Z.dropdown=document.getElementById("notifications-dropdown"),Z.list=document.getElementById("notifications-list"),!Z.btn||!Z.dropdown)return;const e=Ie();if(!e)return;Bn(),Sn(),Ca(e),Ia(e);const t=n=>{if(n.stopPropagation(),!Z.dropdown.classList.toggle("hidden")){const r=window.innerWidth<768,i=r?Z.btnMobile:Z.btn;if(!i)return;const c=i.getBoundingClientRect();Z.dropdown.style.position="fixed",r?(Z.dropdown.style.top=`${c.bottom+8}px`,Z.dropdown.style.left="50%",Z.dropdown.style.transform="translateX(-50%)",Z.dropdown.style.width="95vw",Z.dropdown.style.right="auto"):(Z.dropdown.style.top=`${c.bottom+8}px`,Z.dropdown.style.left="auto",Z.dropdown.style.right=`${window.innerWidth-c.right}px`,Z.dropdown.style.transform="none",Z.dropdown.style.width="20rem")}};Z.btn.addEventListener("click",t),Z.btnMobile&&Z.btnMobile.addEventListener("click",t),document.addEventListener("click",n=>{Z.dropdown&&!Z.dropdown.classList.contains("hidden")&&(Z.btn.contains(n.target)||Z.btnMobile&&Z.btnMobile.contains(n.target)||Z.dropdown.contains(n.target)||Z.dropdown.classList.add("hidden"))})}const ka=Object.freeze(Object.defineProperty({__proto__:null,initNotifications:Nn},Symbol.toStringTag,{value:"Module"}));let Xe=null,dt=null;function Tn(e,t){if(!Mt||!e)return;const n=Re();if(!n)return;const a=Zt(Mt,`plans_presence/${e}`);Xe=Zt(Mt,`plans_presence/${e}/${n.uid}`);const r={displayName:n.displayName||n.email,photoURL:n.photoURL,status:"idle",last_seen:mn()};Un(Xe).remove(),Fn(Xe,r),dt&&dt(),dt=On(a,i=>{const c=i.val()||{};typeof t=="function"&&t(c)})}function Dn(){Xe&&(zn(Xe),Xe=null),dt&&(dt(),dt=null)}function Et(e){Xe&&Vn(Xe,{status:e,last_seen:mn()})}const Ba=Object.freeze(Object.defineProperty({__proto__:null,connectToPresenceChannel:Tn,disconnectFromPresenceChannel:Dn,updateUserActivity:Et},Symbol.toStringTag,{value:"Module"}));let it=null;async function Qt(e,t){if(!e)return;const n=H(w,"recipes",e);try{await Pe(n,{isFavorite:!t})}catch(a){console.error("Error toggling favorite status:",a)}}function Sa(){const e=document.getElementById("search-bar"),t=document.getElementById("category-tabs"),n=document.getElementById("recipe-list-container"),a=document.getElementById("add-recipe-btn");it&&it.destroy(),it=new Ot(w,"edit-recipe-form-modal","edit-recipe-form","edit-recipe-modal-title","edit-recipe-id","edit-recipe-name","edit-recipe-category","edit-recipe-servings","edit-recipe-prep-time","edit-recipe-difficulty","edit-recipe-steps","edit-ingredients-list","edit-add-ingredient-btn","edit-save-recipe-btn","close-edit-recipe-modal","edit-cancel-recipe-btn"),it.setOnSaveCallback(()=>{});let r=[],i="",c="",f=null;const g=["Entr√©e","Plat","Accompagnement","Dessert"],p={PLAT:"bg-orange-100",DESSERT:"bg-amber-100",ENTREE:"bg-lime-100",ACCOMPAGNEMENT:"bg-stone-200","PETIT-DEJEUNER":"bg-orange-100",BOISSON:"bg-cyan-100",SAUCE:"bg-red-100"},E={PLAT:"text-orange-800",DESSERT:"text-amber-800",ENTREE:"text-lime-800",ACCOMPAGNEMENT:"text-stone-800","PETIT-DEJEUNER":"text-orange-800",BOISSON:"text-cyan-800",SAUCE:"text-red-800"},I="bg-gray-100",b="text-gray-800";function B(){return w?Ve(J(w,"recipes"),k=>{console.log("Recipe data updated on /recipes page from listener."),r=k.docs.map(S=>({id:S.id,...S.data()})),l(),N()},k=>{console.error("Erreur lors de l'√©coute des recettes: ",k)}):()=>{}}function U(D){i=D,l(),N()}function l(){if(!t)return;t.innerHTML="";const k=[...new Set(r.map(S=>S.category||"Non class√©"))].sort((S,j)=>{const Q=X=>{const re=X.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();for(let ee=0;ee<g.length;ee++)if(g[ee].normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()===re)return ee;return-1},oe=Q(S),ne=Q(j);return oe>-1&&ne>-1?oe-ne:oe>-1?-1:ne>-1?1:S.localeCompare(j)});!i&&k.length>0&&(i=k[0]),k.forEach(S=>{const j=document.createElement("button"),Q=S.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toUpperCase();if(S===i){const ne=p[Q]||I,X=E[Q]||b;j.className=`px-4 py-2 text-sm font-bold rounded-t-lg ${ne} ${X}`}else j.className="px-4 py-2 text-sm font-medium text-gray-500 hover:text-tomato";j.textContent=S,j.addEventListener("click",()=>U(S)),t.appendChild(j)})}function N(){if(!n)return;n.innerHTML="";let D=r.filter(S=>(S.category||"Non class√©")===i);if(c){const S=c.toLowerCase();D=D.filter(j=>j.name.toLowerCase().includes(S))}if(D.sort((S,j)=>S.name.localeCompare(j.name)),D.length===0){n.innerHTML='<p class="text-gray-500 text-center p-10">Aucune recette trouv√©e.</p>';return}const k=document.createElement("div");k.className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4",D.forEach(S=>{k.appendChild(A(S))}),n.appendChild(k)}function A(D){const k=document.createElement("div");if(k.className="bg-white dark:bg-gray-800 shadow-md rounded-lg flex flex-col p-3",D.imageUrl){const pe=document.createElement("img");pe.src=D.imageUrl,pe.alt=D.name,pe.className="w-full h-24 object-cover rounded-md mb-2",k.appendChild(pe)}const S=document.createElement("div");S.className="w-full flex justify-between items-start";const j=document.createElement("h4");j.className="font-bold text-gray-800 dark:text-gray-200 pr-2",j.textContent=D.name,j.title=D.name,S.appendChild(j);const Q=document.createElement("button");Q.className="text-lg flex-shrink-0",Q.innerHTML='<i class="fas fa-heart"></i>',D.isFavorite?Q.classList.add("text-red-500"):Q.classList.add("text-gray-300","dark:text-gray-500","hover:text-red-400"),Q.addEventListener("click",pe=>{pe.stopPropagation(),Qt(D.id,D.isFavorite)}),S.appendChild(Q),k.appendChild(S);const oe=document.createElement("p");oe.className="text-sm text-gray-600 dark:text-gray-400 mt-1 w-full",oe.textContent=`${D.difficulty||""} - Pour ${D.servings||"?"} pers.`,k.appendChild(oe);const ne=document.createElement("div");ne.className="flex-grow",k.appendChild(ne);const X=document.createElement("div");X.className="w-full flex justify-end items-center space-x-2 border-t dark:border-gray-700 pt-2 mt-2";const re=document.createElement("button");re.className="btn btn-ghost btn-sm text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/50",re.innerHTML='<i class="fas fa-edit"></i>',re.title="Modifier",re.addEventListener("click",()=>it.openForm(D,"Modifier la recette")),X.appendChild(re);const ee=document.createElement("button");return ee.className="btn btn-ghost btn-sm text-red-500 hover:bg-red-50 dark:hover:bg-red-900/50",ee.innerHTML='<i class="fas fa-trash-alt"></i>',ee.title="Supprimer",ee.addEventListener("click",()=>ae(D.id,D.name)),X.appendChild(ee),k.appendChild(X),k}async function ae(D,k){if(confirm(`√ätes-vous s√ªr de vouloir supprimer la recette "${k}" ?`))try{await Fe(H(w,"recipes",D)),fetchAllRecipes()}catch(S){console.error("Erreur lors de la suppression: ",S)}}if(a.addEventListener("click",()=>it.openForm(null,"Ajouter une recette")),e.addEventListener("input",D=>{const k=D.target.value;if(!c&&k&&(f=i),c=k,c){const S=c.toLowerCase(),j=r.find(Q=>Q.name.toLowerCase().includes(S));j&&(i=j.category||"Non class√©")}else f&&(i=f,f=null);l(),N()}),w)return B()}const Ma=Object.freeze(Object.defineProperty({__proto__:null,default:Sa,toggleFavoriteStatus:Qt},Symbol.toStringTag,{value:"Module"})),Na="modulepreload",Ta=function(e){return"/"+e},sn={},lt=function(t,n,a){let r=Promise.resolve();if(n&&n.length>0){let g=function(p){return Promise.all(p.map(E=>Promise.resolve(E).then(I=>({status:"fulfilled",value:I}),I=>({status:"rejected",reason:I}))))};document.getElementsByTagName("link");const c=document.querySelector("meta[property=csp-nonce]"),f=c?.nonce||c?.getAttribute("nonce");r=g(n.map(p=>{if(p=Ta(p),p in sn)return;sn[p]=!0;const E=p.endsWith(".css"),I=E?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${p}"]${I}`))return;const b=document.createElement("link");if(b.rel=E?"stylesheet":Na,E||(b.as="script"),b.crossOrigin="",b.href=p,f&&b.setAttribute("nonce",f),document.head.appendChild(b),E)return new Promise((B,U)=>{b.addEventListener("load",B),b.addEventListener("error",()=>U(new Error(`Unable to preload CSS for ${p}`)))})}))}function i(c){const f=new Event("vite:preloadError",{cancelable:!0});if(f.payload=c,window.dispatchEvent(f),!f.defaultPrevented)throw c}return r.then(c=>{for(const f of c||[])f.status==="rejected"&&i(f.reason);return t().catch(i)})};let Je=null;function Da(){const e={mealPlanGrid:document.getElementById("meal-plan-grid"),currentWeekDisplay:document.getElementById("current-week-display"),prevWeekBtn:document.getElementById("prev-week-btn"),nextWeekBtn:document.getElementById("next-week-btn"),clearMenuBtn:document.getElementById("clear-menu-btn"),shoppingListContainer:document.getElementById("shopping-list"),startDaySelect:document.getElementById("start-day-select"),defaultServingsControl:document.getElementById("default-servings-control"),mealSelectModal:document.getElementById("meal-select-modal"),closeMealSelectModalBtn:document.getElementById("close-meal-select-modal"),mealSelectModalTitle:document.getElementById("meal-select-modal-title"),mealSelectList:document.getElementById("meal-select-list"),recipeFormModal:document.getElementById("edit-recipe-form-modal"),closeRecipeModalBtn:document.getElementById("close-edit-recipe-modal"),cancelRecipeBtn:document.getElementById("edit-cancel-recipe-btn"),recipeForm:document.getElementById("edit-recipe-form"),addItemInput:document.getElementById("add-item-input"),addItemBtn:document.getElementById("add-item-btn"),addItemResults:document.getElementById("add-item-results"),importListBtn:document.getElementById("import-list-btn"),importListModal:document.getElementById("import-list-modal"),closeImportListModalBtn:document.getElementById("close-import-list-modal"),importListContainer:document.getElementById("import-list-container"),exportTxtBtn:document.getElementById("export-txt-btn"),exportPdfBtn:document.getElementById("export-pdf-btn"),exportPlanPdfBtn:document.getElementById("export-plan-pdf-btn"),sharePlanBtn:document.getElementById("share-plan-btn"),planSelect:document.getElementById("plan-select"),inviteParticipantBtn:document.getElementById("invite-participant-btn"),historyPlanBtn:document.getElementById("history-plan-btn"),planHistoryModal:document.getElementById("plan-history-modal"),closePlanHistoryModalBtn:document.getElementById("close-plan-history-modal"),planHistoryList:document.getElementById("plan-history-list"),savePlanBtn:document.getElementById("save-plan-btn"),openTrashBtn:document.getElementById("open-trash-btn"),trashCount:document.getElementById("trash-count"),trashModal:document.getElementById("trash-modal"),closeTrashModalBtn:document.getElementById("close-trash-modal"),trashListContainer:document.getElementById("trash-list-container"),emptyTrashBtn:document.getElementById("empty-trash-btn")};function t(s,o){const d=document.createElement("div");d.className="flex items-center space-x-2";const v=document.createElement("button");v.className="btn btn-outline btn-xs",v.textContent="-";const u=document.createElement("span");u.className="font-medium text-center w-6",u.textContent=s;const y=document.createElement("button");return y.className="btn btn-outline btn-xs",y.textContent="+",v.addEventListener("click",()=>{let h=parseInt(u.textContent,10);h>1&&(h--,u.textContent=h,o(h))}),y.addEventListener("click",()=>{let h=parseInt(u.textContent,10);h++,u.textContent=h,o(h)}),d.appendChild(v),d.appendChild(u),d.appendChild(y),d}function n(s,o,d,v=!1){const u=document.createElement("div");u.className="flex flex-col items-center justify-center h-full";const y=document.createElement("button");y.className="btn btn-ghost btn-xs p-0 h-4 flex items-center justify-center w-full",y.innerHTML='<i class="fas fa-plus"></i>',y.disabled=v;const h=document.createElement("span");h.className="font-medium text-center text-sm my-1",h.textContent=s;const m=document.createElement("button");return m.className="btn btn-ghost btn-xs p-0 h-4 flex items-center justify-center w-full",m.innerHTML='<i class="fas fa-minus"></i>',m.disabled=v,o&&(y.classList.add("text-white"),h.classList.add("text-white"),m.classList.add("text-white")),v||(y.addEventListener("click",()=>{let x=parseInt(h.textContent,10);x++,h.textContent=x,d(x)}),m.addEventListener("click",()=>{let x=parseInt(h.textContent,10);x>1&&(x--,h.textContent=x,d(x))})),u.appendChild(y),u.appendChild(h),u.appendChild(m),u}Je&&Je.destroy(),Je=new Ot(w,"edit-recipe-form-modal","edit-recipe-form","edit-recipe-modal-title","edit-recipe-id","edit-recipe-name","edit-recipe-category","edit-recipe-servings","edit-recipe-prep-time","edit-recipe-difficulty","edit-recipe-steps","edit-ingredients-list","edit-add-ingredient-btn","edit-save-recipe-btn","close-edit-recipe-modal","edit-cancel-recipe-btn"),Je.setActivityUpdater(Et),Je.setOnSaveCallback(async()=>{});let a=1,r="Lundi",i={},c={},f={};const g=[];let p=null,E=[],I=[],b=1,B=null,U=[],l=null;const N=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];function A(s){return s?s.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase():""}async function ae(s){const o=document.getElementById("unit-select-modal"),d=document.getElementById("unit-modal-title"),v=document.getElementById("unit-modal-list"),u=document.getElementById("unit-modal-cancel");return d.textContent=`Choisir une unit√© pour "${s}"`,v.innerHTML="",new Promise((y,h)=>{const m=["g","kg","ml","l","pi√®ce(s)","c.√†.s.","c.√†.c.","pinc√©e(s)"],x=C=>{o.classList.add("hidden"),y(C)};m.forEach(C=>{const M=document.createElement("button");M.className="btn btn-outline",M.textContent=C,M.addEventListener("click",()=>x(C)),v.appendChild(M)});const L=()=>{o.classList.add("hidden"),h()};u.addEventListener("click",L,{once:!0}),o.addEventListener("click",C=>{C.target===o&&L()},{once:!0}),o.classList.remove("hidden")})}async function D(){if(w)try{I=(await Ee(J(w,"ingredients"))).docs.map(o=>({id:o.id,...o.data()})),I.sort((o,d)=>o.name.localeCompare(d.name))}catch(s){console.error("Erreur lors de la r√©cup√©ration des ingr√©dients: ",s)}}function k(){if(!l)i={},c={},f={},b=1,r="Lundi";else{const s=l.weeks?l.weeks[a]||{}:{};i=s.menuData||{},c=s.servingsData||{},f=s.remarksData||{},b=l.defaultNumPeople||1,r=l.startDay||"Lundi"}if(e.startDaySelect&&(e.startDaySelect.value=r),e.defaultServingsControl){e.defaultServingsControl.innerHTML="";const s=t(b,async o=>{b=o,l&&await S({defaultNumPeople:o},`a chang√© le nombre de personnes par d√©faut √† ${o}`)});e.defaultServingsControl.appendChild(s)}Pn(),re(e.mealPlanGrid,{menuData:i,servingsData:c,remarksData:f,defaultNumPeople:b,startDay:r},!1),X(document.getElementById("mobile-meal-plan"),{menuData:i,servingsData:c,remarksData:f,defaultNumPeople:b,startDay:r},!1),se()}async function S(s,o){if(!l)return;await Ut(l.id,l,o);const d=H(w,"plans",l.id);try{await Pe(d,{...s,lastUpdated:new Date})}catch(v){console.error("Error updating plan:",v),alert("Une erreur de sauvegarde est survenue.")}}function j(){e.planHistoryModal.classList.add("hidden")}async function Q(s){if(l&&confirm("Voulez-vous vraiment restaurer cette version ? L'√©tat actuel sera sauvegard√© dans l'historique avant la restauration."))try{const o=H(w,"plans",l.id,"history",s),d=await Se(o);if(!d.exists())throw new Error("Version de l'historique non trouv√©e.");const v=d.data().planState;await Ut(l.id,l);const u=H(w,"plans",l.id);await gt(u,v),j()}catch(o){console.error("Erreur lors du rollback :",o)}}async function oe(s,o){if(l&&confirm("√ätes-vous s√ªr de vouloir supprimer d√©finitivement cette entr√©e de l'historique ?"))try{const d=H(w,"plans",l.id,"history",s);await Fe(d),o.remove()}catch(d){console.error("Erreur lors de la suppression de l'historique :",d),alert("Une erreur est survenue lors de la suppression.")}}async function ne(){if(l){e.planHistoryList.innerHTML="<p>Chargement de l'historique...</p>",e.planHistoryModal.classList.remove("hidden");try{const s=J(w,"plans",l.id,"history"),o=Le(s,Qn("timestamp","desc")),d=await Ee(o);if(e.planHistoryList.innerHTML="",d.empty){e.planHistoryList.innerHTML="<p>Aucun historique pour ce plan.</p>";return}d.forEach(v=>{const u=v.data(),y=document.createElement("div");y.className="p-3 border-b flex justify-between items-center";const h=document.createElement("div"),m=u.timestamp?.toDate().toLocaleString("fr-FR")||"Date inconnue",x=u.description||"Modification diverse",L=u.modifiedByName||"Inconnu";h.innerHTML=`
                    <p class="font-medium">${L} ${x}</p>
                    <p class="text-sm text-gray-500">${m}</p>
                `;const C=document.createElement("div");C.className="flex items-center space-x-2";const M=document.createElement("button");M.className="btn btn-secondary btn-sm",M.textContent="Revenir √† cette version",M.addEventListener("click",()=>Q(v.id));const $=document.createElement("button");$.className="btn btn-ghost text-red-500 hover:bg-red-100 btn-sm",$.innerHTML='<i class="fas fa-times"></i>',$.title="Supprimer cette version",$.addEventListener("click",q=>{q.stopPropagation(),oe(v.id,y)}),C.appendChild(M),C.appendChild($),y.appendChild(h),y.appendChild(C),e.planHistoryList.appendChild(y)})}catch(s){console.error("Erreur de chargement de l'historique:",s),e.planHistoryList.innerHTML=`<p class="text-red-500">Impossible de charger l'historique.</p>`}}}function X(s,o,d=!1){if(!s)return;const v=o.menuData||{},u=o.servingsData||{},y=o.remarksData||{},h=o.defaultNumPeople||1,m=o.startDay||"Lundi";s.innerHTML="";const x=document.createDocumentFragment(),L=N.indexOf(m);[...N.slice(L),...N.slice(0,L)].forEach(M=>{const $=N.indexOf(M),q=document.createElement("div");q.className="bg-blue-100 border border-blue-300 rounded-xl shadow-md p-4 mb-4";const G=document.createElement("h3");G.className="text-xl font-bold text-gray-800 mb-3",G.textContent=M.toUpperCase(),q.appendChild(G);const ce=document.createElement("div");ce.className="space-y-4",["lunch","dinner"].forEach(ue=>{const me=document.createElement("div");me.className=`border-t pt-3 ${ue==="lunch"?"bg-amber-50":"bg-stone-100"} rounded-lg p-2`;const we=document.createElement("div");we.className="flex justify-between items-center mb-2";const Me=document.createElement("h4");if(Me.className="text-lg font-semibold text-tomato",Me.textContent=ue==="lunch"?"Midi":"Soir",we.appendChild(Me),!d){const ve=`${$}-${ue}`,ie=u[ve]||h,ye=t(ie,be=>{Xt(ve,be)});we.appendChild(ye)}me.appendChild(we);const ke=document.createElement("div");ke.className="space-y-2";let Ne=!1;const Be=["Entr√©e","Plat","Accompagnement","Dessert","Remarque"];for(let ve=0;ve<Be.length;ve++){const ie=Be[ve],ye=`${$}-${ue}-${ve}`,be=v[ye],ge=document.createElement("div");ge.className="mb-2";const Ae=document.createElement("h5");if(Ae.className="text-md font-semibold text-gray-700 mb-1",Ae.textContent=ie,ge.appendChild(Ae),ie==="Remarque")ge.appendChild(Ye(ye,y,d));else{const Oe=document.createElement("div");if(Oe.className="space-y-1",Array.isArray(be)&&be.length>0&&(Ne=!0,be.forEach(($e,bt)=>{const Qe=E.find(He=>He.id===$e.id);if(Qe){const He=de(Qe,ye,bt,d);if(He.classList.remove("bg-white","shadow-sm"),He.classList.add("bg-emerald-200","border","border-emerald-400"),!d){const je=He.querySelector(".edit-meal-btn"),st=He.querySelector(".delete-meal-btn");je&&je.classList.remove("hidden"),st&&st.classList.remove("hidden")}Oe.appendChild(He)}})),d)Ne||(Oe.innerHTML='<p class="text-sm text-gray-500 italic">Aucun plat pr√©vu.</p>');else{const $e=document.createElement("button");$e.className="btn btn-outline btn-sm w-full mt-2",$e.innerHTML=`<i class="fas fa-plus mr-2"></i> Ajouter une ${ie.toLowerCase()}`,$e.addEventListener("click",()=>{fe(ye)}),Oe.appendChild($e)}ge.appendChild(Oe)}ke.appendChild(ge)}me.appendChild(ke),ce.appendChild(me)}),q.appendChild(ce),x.appendChild(q)}),s.appendChild(x)}function re(s,o,d=!1){if(!s)return;const v=o.menuData||{},u=o.servingsData||{},y=o.remarksData||{},h=o.defaultNumPeople||1,m=o.startDay||"Lundi",x=document.createDocumentFragment(),L=["lunch","dinner"],C=5,M=N.indexOf(m);[...N.slice(M),...N.slice(0,M)].forEach(q=>{const G=N.indexOf(q),ce=document.createElement("div");ce.className="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] items-stretch border-b border-gray-300";const ue=document.createElement("div");ue.className="font-bold p-2 flex items-center justify-center bg-gray-100 text-sm border-r border-gray-300",ue.textContent=q.toUpperCase(),ce.appendChild(ue),L.forEach(me=>{const we=`${G}-${me}`,Me=u[we]||h,ke=u.hasOwnProperty(we),Ne=document.createElement("div"),Be=n(Me,ke,ie=>{Xt(we,ie)},d);let ve="border-r border-gray-300 flex items-center justify-center transition-colors duration-300";ke?ve+=" bg-tomato":ve+=me==="lunch"?" bg-amber-50":" bg-stone-100",Ne.className=ve,Ne.appendChild(Be),ce.appendChild(Ne);for(let ie=0;ie<C;ie++){const ye=`${G}-${me}-${ie}`,be=v[ye],ge=document.createElement("div"),Ae=V(ye);let Oe="meal-slot p-1 min-h-[70px] flex flex-col justify-start border-r border-gray-300";if(Oe+=me==="lunch"?" bg-amber-50":" bg-stone-100",ge.className=Oe,ge.dataset.slotId=ye,Ae==="Remarque")ge.appendChild(Ye(ye,y,d));else if(Array.isArray(be)&&be.length>0){const $e=document.createElement("div");$e.className="w-full",be.forEach((bt,Qe)=>{const He=E.find(je=>je.id===bt.id);if(He)$e.appendChild(de(He,ye,Qe,d));else{const je=document.createElement("div");je.className="p-1 bg-red-100 text-red-700 rounded shadow-sm text-center text-xs font-medium",je.textContent="Recette supprim√©e",$e.appendChild(je)}}),ge.appendChild($e),d||ge.appendChild(et(ye,!0))}else d||ge.appendChild(et(ye,!1));ce.appendChild(ge)}}),x.appendChild(ce)}),s.innerHTML="",s.appendChild(x),d||tt()}async function ee(){const s=Ie();if(!w||!s)return[];try{const o=Le(J(w,"shopping_lists"),le("userId","==",s));return(await Ee(o)).docs.map(y=>({id:y.id,...y.data()})).filter(y=>y.isShared!==!0)}catch(o){return console.error("Erreur de chargement des listes de courses sauvegard√©es: ",o),[]}}async function pe(){const s=await ee();if(e.importListContainer.innerHTML="",s.length===0){e.importListContainer.innerHTML='<p class="text-center text-gray-500">Aucune liste sauvegard√©e.</p>';return}s.forEach(o=>{const d=document.createElement("button");d.className="w-full text-left p-2 hover:bg-gray-100 rounded-lg transition-colors duration-150",d.textContent=o.name,d.addEventListener("click",()=>{confirm(`Voulez-vous vraiment importer les ingr√©dients de la liste "${o.name}" ?`)&&(o.ingredients.forEach(v=>{const u=parseFloat(String(v.quantity).replace(",","."))||0;Y(v.name,u,v.unit)}),Te())}),e.importListContainer.appendChild(d)}),e.importListModal.classList.remove("hidden")}function Te(){e.importListModal.classList.add("hidden")}function R(){e.addItemInput?.addEventListener("input",()=>{const s=e.addItemInput.value.toLowerCase(),o=e.addItemResults;if(o.innerHTML="",!s){o.classList.add("hidden");return}I.filter(u=>u.name.toLowerCase().includes(s)).forEach(u=>{const y=document.createElement("div");y.className="p-2 hover:bg-gray-100 cursor-pointer",y.textContent=u.name,y.addEventListener("click",()=>{Y(u.name,1,u.unit),e.addItemInput.value="",o.classList.add("hidden")}),o.appendChild(y)});const v=document.createElement("div");v.className="p-2 bg-green-50 hover:bg-green-200 cursor-pointer font-bold text-green-700",v.textContent=`+ Cr√©er "${e.addItemInput.value}"`,v.addEventListener("click",async()=>{const u=e.addItemInput.value;try{const y=await ae(u);await _e(J(w,"ingredients"),{name:u,unit:y}),await D(),Y(u,1,y),e.addItemInput.value="",o.classList.add("hidden")}catch{}}),o.appendChild(v),o.classList.remove("hidden")}),e.addItemBtn?.addEventListener("click",()=>{const s=e.addItemInput.value;s&&(Y(s,1,""),e.addItemInput.value="",e.addItemResults.classList.add("hidden"))}),document.addEventListener("click",s=>{e.addItemInput&&!e.addItemInput.contains(s.target)&&!e.addItemResults.contains(s.target)&&e.addItemResults.classList.add("hidden")})}function T(){if(g.length===0){alert("La liste de courses est vide.");return}const s=g.reduce((u,y)=>{const h=y.category||"Inconnue";return u[h]||(u[h]=[]),u[h].push(y),u},{}),o=Object.keys(s).sort((u,y)=>u==="Inconnue"?1:y==="Inconnue"?-1:u.localeCompare(y));let d=`Liste de courses - GustoPlan

`;o.forEach(u=>{d+=`--- ${u.toUpperCase()} ---
`,s[u].sort((h,m)=>h.name.localeCompare(m.name)).forEach(h=>{let x=`${Number.isInteger(h.totalQuantity)?h.totalQuantity:parseFloat(h.totalQuantity.toFixed(2))} ${h.unit||""} ${h.name}`;if(h.sources&&h.sources.length>0){const L=h.sources.reduce((M,$)=>{const q=`${$.recipeName} (${$.day} ${$.time})`;return M[q]||(M[q]=0),M[q]+=$.quantity,M},{}),C=Object.keys(L).join(" / ");x+=` *** ${C} ***`}d+=x+`
`}),d+=`
`});const v=new Blob([d],{type:"text/plain;charset=utf-8"});saveAs(v,"liste-de-courses.txt")}function O(){if(g.length===0){alert("La liste de courses est vide.");return}const{jsPDF:s}=window.jspdf,o=new s,d=g.reduce((x,L)=>{const C=L.category||"Inconnue";return x[C]||(x[C]=[]),x[C].push(L),x},{}),v=Object.keys(d).sort((x,L)=>x==="Inconnue"?1:L==="Inconnue"?-1:x.localeCompare(L));o.setFontSize(18),o.text("Liste de courses - GustoPlan",14,22);let u=35;const y=o.internal.pageSize.height,h=20,m=()=>{u>y-h&&(o.addPage(),u=20)};v.forEach(x=>{m(),o.setFontSize(14),o.setFont(void 0,"bold"),o.text(`--- ${x.toUpperCase()} ---`,14,u),u+=8,o.setFont(void 0,"normal"),d[x].sort((C,M)=>C.name.localeCompare(M.name)).forEach(C=>{m(),o.setFontSize(12);const M=Number.isInteger(C.totalQuantity)?C.totalQuantity:parseFloat(C.totalQuantity.toFixed(2));if(o.text(`${M} ${C.unit||""} ${C.name}`,14,u),u+=6,C.sources&&C.sources.length>0){const $=C.sources.reduce((q,G)=>{const ce=`${G.recipeName} (${G.day} ${G.time})`;return q[ce]||(q[ce]=0),q[ce]+=G.quantity,q},{});o.setFontSize(9),o.setTextColor(100);for(const q in $)m(),o.text(`  * ${q}`,18,u),u+=5;o.setTextColor(0)}u+=2}),u+=5}),o.save("liste-de-courses.pdf")}async function z(){if(!l){alert("Veuillez s√©lectionner un plan √† exporter.");return}const s=document.getElementById("loading-overlay");s&&s.classList.remove("hidden");try{const{jsPDF:o}=window.jspdf,d=new o,v=H(w,"plans",l.id),u=await Se(v),y=u.exists()?u.data():null;if(!y||!y.weeks){alert("Ce plan est vide et ne peut pas √™tre export√©.");return}d.setFontSize(18),d.text(`Plan de Repas: ${y.name}`,14,20);const h=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"],m={0:"E",1:"P",2:"A",3:"D"},x=Object.keys(y.weeks).sort((C,M)=>parseInt(C)-parseInt(M));let L=!0;for(const C of x){const $=y.weeks[C].menuData||{};if(Object.keys($).length===0)continue;const q=[["Jour","Midi","Soir"]],G=[],ce=h.indexOf(y.startDay||"Lundi"),ue=[...h.slice(ce),...h.slice(0,ce)];for(const we of ue){const Me=h.indexOf(we);let ke=[],Ne=[];for(const Be of["lunch","dinner"])for(const ve in m){const ie=`${Me}-${Be}-${ve}`;$[ie]&&Array.isArray($[ie])&&$[ie].forEach(ye=>{const be=`[${m[ve]}] ${ye.name}`;Be==="lunch"?ke.push(be):Ne.push(be)})}G.push([we,ke.join(`
`)||"-",Ne.join(`
`)||"-"])}d.setFontSize(14);const me=L?30:d.autoTable.previous.finalY+20;d.text(`Semaine ${C}`,14,me-5),d.autoTable({startY:me,head:q,body:G,theme:"grid",styles:{cellPadding:2,fontSize:8,valign:"middle"},headStyles:{fillColor:[41,128,185],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[245,245,245]}}),L=!1}d.save(`plan_${y.name.replace(/ /g,"_")}.pdf`)}catch(o){console.error("Erreur lors de la g√©n√©ration du PDF du plan :",o),alert("Une erreur est survenue lors de la cr√©ation du PDF.")}finally{s&&s.classList.add("hidden")}}async function Y(s,o,d,v=!1){if(!l)return alert("Veuillez s√©lectionner un plan.");const u=H(w,"plans",l.id);try{await en(w,async y=>{const h=await y.get(u);if(!h.exists())throw"Le plan n'existe plus.";const m=h.data().manualItems||[],x=`${s.trim().toLowerCase()}_${d||""}`,L=m.findIndex(M=>`${M.name.trim().toLowerCase()}_${M.unit||""}`===x);if(L>-1)m[L].totalQuantity+=o;else{const M=I.find($=>$.name.toLowerCase()===s.trim().toLowerCase());m.push({name:s.trim(),totalQuantity:o,unit:d,source:"manual",category:M?.category||"Inconnue"})}const C=m.filter(M=>M.totalQuantity!==0);y.update(u,{manualItems:C,lastUpdated:new Date})})}catch(y){console.error("Erreur transactionnelle lors de l'ajustement de l'ingr√©dient: ",y),alert("Une erreur de synchronisation est survenue. Veuillez r√©essayer.")}}function te(s){const o=s?s.toLowerCase():"";return o.includes("g")||o.includes("ml")?10:1}function Ce(s=[]){const o=e.shoppingListContainer;if(!o)return;if(o.innerHTML="",g.length===0&&s.length===0){o.innerHTML='<p class="text-center text-gray-500 italic py-4">Votre liste de courses est vide.</p>';return}const d=l?l.checkedItems||{}:{},v=g.reduce((y,h)=>{const m=h.category||"Inconnue";return y[m]||(y[m]=[]),y[m].push(h),y},{});if(Object.keys(v).sort((y,h)=>y==="Inconnue"?1:h==="Inconnue"?-1:y.localeCompare(h)).forEach(y=>{const h=document.createElement("h4");h.className="text-sm font-bold text-stone-800 bg-stone-200 mt-4 mb-2 px-3 py-1 rounded-md",h.textContent=y,o.appendChild(h);const m=document.createElement("ul");m.className="space-y-2",v[y].sort((L,C)=>L.name.localeCompare(C.name)).forEach(L=>{const C=`${L.name}_${L.unit||""}`,M=d[C],$=document.createElement("li");let q="p-2 rounded";$.className=q+(L.source==="manual"?" bg-lemon":" bg-gray-50");const G=document.createElement("div");G.className="flex justify-between items-center";const ce=document.createElement("div");if(ce.className="flex-grow flex items-center",M){const ie=document.createElement("i");ie.className="fas fa-check mr-2 bg-green-500 text-white rounded-full p-1 flex items-center justify-center w-5 h-5",ce.appendChild(ie)}const ue=document.createElement("span");ue.className="text-sm font-medium transition-all duration-200",M&&ue.classList.add("line-through","text-gray-400"),ue.textContent=L.name,ce.appendChild(ue),G.appendChild(ce);const me=document.createElement("div");me.className="flex items-center space-x-2 mx-2";const we=document.createElement("span");we.className="font-medium w-20 text-center text-sm",M&&we.classList.add("text-gray-400");const Me=Number.isInteger(L.totalQuantity)?L.totalQuantity:parseFloat(L.totalQuantity.toFixed(2));we.textContent=`${Me} ${L.unit||""}`.trim();const ke=document.createElement("div");ke.className="flex flex-col";const Ne=document.createElement("button");Ne.className="btn btn-outline btn-xs rounded-b-none",Ne.textContent="+",Ne.addEventListener("click",async()=>{const ie=te(L.unit);await Y(L.name,ie,L.unit)});const Be=document.createElement("button");Be.className="btn btn-outline btn-xs rounded-t-none -mt-px",Be.textContent="-",Be.addEventListener("click",async()=>{const ie=te(L.unit);await Y(L.name,-ie,L.unit)}),ke.appendChild(Ne),ke.appendChild(Be),me.appendChild(we),me.appendChild(ke),G.appendChild(me);const ve=document.createElement("button");if(ve.className="delete-item-btn text-red-500 hover:text-red-700",ve.innerHTML='<i class="fas fa-trash-alt"></i>',ve.addEventListener("click",()=>{Y(L.name,-L.totalQuantity,L.unit,!0)}),G.appendChild(ve),$.appendChild(G),L.sources&&L.sources.length>0){const ie=document.createElement("div");ie.className="p-2 mt-1 ml-4 rounded-md bg-stone-100";const ye=L.sources.reduce((be,ge)=>{const Ae=`${ge.recipeName} (${ge.day} ${ge.time})`;return be[Ae]||(be[Ae]=0),be[Ae]+=ge.quantity,be},{});for(const be in ye){const ge=document.createElement("span");ge.className="block text-xs text-gray-500",ge.textContent=`‚Ü≥ ${be}`,ie.appendChild(ge)}$.appendChild(ie)}m.appendChild($)}),o.appendChild(m)}),e.openTrashBtn&&(e.openTrashBtn.classList.remove("hidden"),e.trashCount&&(e.trashCount.textContent=s.length,s.length>0?(e.trashCount.classList.remove("bg-gray-200"),e.trashCount.classList.add("bg-red-500","text-white")):(e.trashCount.classList.add("bg-gray-200"),e.trashCount.classList.remove("bg-red-500","text-white")))),s&&s.length>0){if(e.emptyTrashBtn){e.emptyTrashBtn.classList.remove("hidden");const y=e.emptyTrashBtn.cloneNode(!0);e.emptyTrashBtn.parentNode.replaceChild(y,e.emptyTrashBtn),e.emptyTrashBtn=y,e.emptyTrashBtn.addEventListener("click",async()=>{if(!l||!confirm("Voulez-vous supprimer d√©finitivement tous les √©l√©ments de la corbeille ?"))return;const h=H(w,"plans",l.id),m=s.map(x=>`${x.name}_${x.unit||""}`);try{await lt(()=>import("./firebase-config-CV1YP_xo.js").then(x=>x.F),[]).then(x=>{x.updateDoc(h,{hiddenTrashItems:x.arrayUnion(...m),lastUpdated:new Date})}),e.trashModal.classList.add("hidden")}catch(x){console.error("Erreur vidage corbeille:",x)}})}if(e.trashListContainer){e.trashListContainer.innerHTML="";const y=document.createElement("ul");y.className="space-y-2",s.forEach(h=>{const m=document.createElement("li");m.className="p-2 rounded bg-gray-100 flex justify-between items-center group";const x=document.createElement("span");x.className="text-sm text-gray-500 line-through",x.textContent=h.name,m.appendChild(x);const L=document.createElement("div");L.className="flex items-center space-x-2";const C=document.createElement("button");C.className="btn btn-xs btn-outline text-blue-600 hover:bg-blue-50 border-blue-300",C.innerHTML='<i class="fas fa-undo mr-1"></i> Restaurer',C.addEventListener("click",async()=>{if(!l)return;const $=H(w,"plans",l.id);try{await en(w,async q=>{const G=await q.get($);if(!G.exists())return;const ue=(G.data().manualItems||[]).filter(me=>!(me.name.toLowerCase()===h.name.toLowerCase()&&me.unit===h.unit));q.update($,{manualItems:ue,lastUpdated:new Date})}),s.length<=1&&e.trashModal.classList.add("hidden")}catch(q){console.error("Erreur lors de la restauration :",q)}});const M=document.createElement("button");M.className="btn btn-xs btn-ghost text-gray-400 hover:text-red-600",M.title="Supprimer d√©finitivement",M.innerHTML='<i class="fas fa-times"></i>',M.addEventListener("click",async()=>{if(!l)return;const $=H(w,"plans",l.id),q=`${h.name}_${h.unit||""}`;try{await lt(()=>import("./firebase-config-CV1YP_xo.js").then(G=>G.F),[]).then(G=>{G.updateDoc($,{hiddenTrashItems:G.arrayUnion(q),lastUpdated:new Date})}),s.length<=1&&e.trashModal.classList.add("hidden")}catch(G){console.error("Erreur suppression d√©finitive:",G)}}),L.appendChild(C),L.appendChild(M),m.appendChild(L),y.appendChild(m)}),e.trashListContainer.appendChild(y)}}else e.trashListContainer&&(e.trashListContainer.innerHTML='<p class="text-center text-gray-500 italic py-4">La corbeille est vide.</p>'),e.emptyTrashBtn&&e.emptyTrashBtn.classList.add("hidden")}async function se(){if(!l){g.length=0,Ce();return}const s=l.manualItems?JSON.parse(JSON.stringify(l.manualItems)):[],o=new Map(s.map(m=>[`${m.name.trim().toLowerCase()}_${m.unit||""}`,m])),d=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];if(l.weeks)for(const m in l.weeks){const x=l.weeks[m],L=x.menuData||{},C=x.servingsData||{};for(const M in L){const $=L[M];if(!Array.isArray($))continue;const[q,G]=M.split("-"),ce=parseInt(q,10),ue=d[ce]||"Jour inconnu",me=G==="lunch"?"midi":"soir",we=`${ce}-${G}`,Me=parseInt(C[we]||l.defaultNumPeople,10);for(const ke of $){const Be=E.find(ie=>ie.id===ke.id)||ke;if(!Be||!Array.isArray(Be.ingredients))continue;const ve=Be.servings||1;ve<=0||Be.ingredients.forEach(ie=>{const{name:ye,quantity:be,unit:ge}=ie;if(!ye||!be)return;const Ae=I.find(We=>We.name.toLowerCase()===ye.trim().toLowerCase()),Oe=Ae?Ae.category:"Inconnue",$e=parseFloat(String(be).replace(",","."));if(isNaN($e))return;const Qe=$e/ve*Me,He=ge||"",je=`${ye.trim().toLowerCase()}_${He}`,st={recipeName:Be.name,day:`${ue} (S${m})`,time:me,quantity:Qe};if(o.has(je)){const We=o.get(je);We.totalQuantity+=Qe,We.source==="manual"&&(We.source="mixed"),Array.isArray(We.sources)?We.sources.push(st):We.sources=[st]}else o.set(je,{name:ye.trim(),totalQuantity:Qe,unit:He,source:"plan",category:Oe,sources:[st]})})}}}const v=Array.from(o.values()),u=l.hiddenTrashItems||[],y=v.filter(m=>m.totalQuantity>0).sort((m,x)=>m.name.localeCompare(x.name)),h=v.filter(m=>{const x=`${m.name}_${m.unit||""}`;return m.totalQuantity<=0&&m.sources&&m.sources.length>0&&!u.includes(x)}).sort((m,x)=>m.name.localeCompare(x.name));g.length=0,g.push(...y),Ce(h)}function fe(s){const o=V(s);if(!o||!e.mealSelectModal)return;e.mealSelectModalTitle.textContent=`S√©lectionner : ${o}`,e.mealSelectList.innerHTML="";const d=document.createElement("input");d.type="text",d.placeholder="Rechercher dans la cat√©gorie...",d.className="w-full p-2 mb-4 border border-gray-300 rounded-lg",e.mealSelectList.appendChild(d);const v=A(o),u=E.filter(m=>A(m.category)===v).sort((m,x)=>{const L=m.isFavorite?1:0,C=x.isFavorite?1:0;return C!==L?C-L:m.name.localeCompare(x.name)}),y=document.createElement("div");y.className="space-y-1 max-h-80 overflow-y-auto",e.mealSelectList.appendChild(y);function h(m=""){y.innerHTML="";const x=m.toLowerCase(),L=u.filter(C=>C.name.toLowerCase().includes(x));L.length===0?y.innerHTML='<p class="text-gray-500 p-4">Aucun plat ne correspond √† votre recherche.</p>':L.forEach(C=>{const M=document.createElement("button");M.className="w-full text-left p-2 hover:bg-gray-100 rounded-lg transition-colors duration-150";const $=document.createElement("p");$.className="font-medium text-gray-800 text-sm",C.isFavorite?$.innerHTML=`${C.name} <i class="fas fa-heart text-red-500 ml-2"></i>`:$.textContent=C.name,M.appendChild($),M.addEventListener("click",()=>{nt(s,C),he()}),y.appendChild(M)})}d.addEventListener("input",m=>h(m.target.value)),h(),e.mealSelectModal.classList.remove("hidden"),d.focus()}function he(){e.mealSelectModal&&e.mealSelectModal.classList.add("hidden")}function De(s){p=s.target.closest(".meal-card");const o=p.closest(".meal-slot").dataset.slotId;s.dataTransfer.setData("text/plain",o),setTimeout(()=>{p&&(p.style.opacity="0.5")},0)}function W(){p&&(p.style.opacity="1",p=null)}function F(s){s.preventDefault();const o=s.target.closest(".meal-slot");o&&V(o.dataset.slotId)!=="Remarque"&&o.classList.add("bg-gray-200")}function P(s){const o=s.target.closest(".meal-slot");o&&o.classList.remove("bg-gray-200")}async function _(s){s.preventDefault();const o=s.dataTransfer.getData("text/plain"),d=s.target.closest(".meal-slot");if(d){d.classList.remove("bg-gray-200");const v=d.dataset.slotId,u=V(v);if(u==="Remarque")return;if(o&&v&&o!==v){const y=i[o],h=V(o);if(A(h)!==A(u)){alert(`Action impossible : un(e) "${h}" ne peut pas aller dans la cat√©gorie "${u}".`);return}const m=i[v];i[v]=y,m?i[o]=m:delete i[o],re(e.mealPlanGrid,{menuData:i,servingsData:c,remarksData:f,defaultNumPeople:b,startDay:r},!1),await S({[`weeks.${a}.menuData`]:i},"a d√©plac√© un plat"),await se()}}}function V(s){switch(s.split("-")[2]){case"0":return"Entr√©e";case"1":return"Plat";case"2":return"Accompagnement";case"3":return"Dessert";case"4":return"Remarque";default:return""}}function de(s,o,d,v=!1){const u=document.createElement("div");if(u.className="meal-card p-1 flex flex-col items-center bg-white rounded shadow-sm text-center relative w-full mb-1",v||(u.classList.add("cursor-grab"),u.draggable=!0),!v){const x=document.createElement("button");x.className="absolute -top-2 -right-1 text-base",x.innerHTML='<i class="fas fa-heart"></i>',s.isFavorite?x.classList.add("text-red-500"):x.classList.add("text-gray-300","hover:text-red-400"),x.addEventListener("click",L=>{L.stopPropagation(),Qt(s.id,s.isFavorite)}),x.addEventListener("mousedown",L=>L.stopPropagation()),u.appendChild(x)}const y=document.createElement("span");if(y.className="text-xs font-medium p-1 break-words w-full",y.textContent=s.name,u.appendChild(y),!v){const x=document.createElement("div");x.className="absolute top-0 left-0 flex";const L=document.createElement("button");L.className="edit-meal-btn text-gray-600 hover:text-gray-800 hidden px-1 py-0.5",L.innerHTML='<i class="fas fa-pencil-alt fa-xs"></i>',L.title="Modifier la recette",L.addEventListener("click",M=>{M.stopPropagation();const $=E.find(q=>q.id===s.id);Je.openForm($||s,"Modifier la recette")}),L.addEventListener("mousedown",M=>M.stopPropagation()),x.appendChild(L);const C=document.createElement("button");C.className="delete-meal-btn text-red-700 hover:text-red-900 hidden px-1 py-0.5",C.innerHTML='<i class="fas fa-times-circle fa-xs"></i>',C.title="Retirer du planning",C.addEventListener("click",M=>{M.stopPropagation(),at(o,d)}),C.addEventListener("mousedown",M=>M.stopPropagation()),x.appendChild(C),u.appendChild(x),u.addEventListener("mouseenter",()=>{L.classList.remove("hidden"),C.classList.remove("hidden")}),u.addEventListener("mouseleave",()=>{L.classList.add("hidden"),C.classList.add("hidden")})}const h=document.createElement("div");h.className="absolute bottom-1 right-1";const m=document.createElement("button");return m.className="info-meal-btn bg-gray-500 text-white hover:bg-gray-600 rounded w-3 h-3 flex items-center justify-center shadow-sm",m.innerHTML='<i class="fas fa-plus fa-xs"></i>',m.title="Plus d'infos",m.dataset.slotId=o,m.dataset.mealIndex=d,m.addEventListener("mousedown",x=>x.stopPropagation()),h.appendChild(m),u.appendChild(h),u}function Ke(s,o){if(document.querySelectorAll(".planner-ingredient-tooltip").forEach(h=>h.remove()),B===s){s.classList.remove("info-open"),s.innerHTML='<i class="fas fa-plus fa-xs"></i>',B=null;return}B&&(B.classList.remove("info-open"),B.innerHTML='<i class="fas fa-plus fa-xs"></i>'),s.classList.add("info-open"),s.innerHTML='<i class="fas fa-times fa-xs"></i>',B=s;const d=document.createElement("div");if(d.className="planner-ingredient-tooltip z-50 w-64 p-3 bg-white border border-gray-200 rounded-lg shadow-lg text-left text-sm",o.ingredients&&o.ingredients.length>0){if(o.servings&&o.servings>0){const x=document.createElement("p");x.className="mb-2 text-sm text-gray-600 flex items-center",x.innerHTML=`<i class="fas fa-users mr-2"></i> Pour ${o.servings} ${o.servings>1?"personnes":"personne"}`,d.appendChild(x)}const h=document.createElement("h4");h.className="font-bold mb-2 text-gray-800",h.textContent="Ingr√©dients :",d.appendChild(h);const m=document.createElement("ul");m.className="space-y-1 text-gray-600",o.ingredients.forEach(x=>{const L=document.createElement("li");L.textContent=`‚Ä¢ ${x.quantity||""} ${x.unit||""} ${x.name}`.trim(),m.appendChild(L)}),d.appendChild(m)}else d.textContent="Aucun ingr√©dient sp√©cifi√© pour cette recette.";document.body.appendChild(d);const v=s.closest(".meal-card").getBoundingClientRect(),u=d.getBoundingClientRect();if(window.innerWidth<768){d.style.width="90vw",d.style.maxWidth="320px";const h=d.getBoundingClientRect();let m=v.bottom+10,x=(window.innerWidth-h.width)/2;m+h.height>window.innerHeight&&(m=v.top-h.height-10),d.style.top=`${m}px`,d.style.left=`${x}px`}else{let h=v.right+10;h+u.width>window.innerWidth&&(h=v.left-u.width-10);let m=v.top;m+u.height>window.innerHeight&&(m=v.bottom-u.height),m<10&&(m=10),d.style.left=`${h}px`,d.style.top=`${m}px`}d.style.position="fixed"}function et(s,o=!1){const d=document.createElement("div"),v=document.createElement("button");return o?(d.className="w-full flex justify-center pt-1",v.className="add-more-meal-btn text-gray-400 hover:text-green-500 transition-colors duration-150",v.innerHTML='<i class="fas fa-plus-circle"></i>',v.title="Ajouter une autre recette"):(d.className="flex items-center justify-center h-full",v.className="add-meal-btn text-green-500 hover:text-green-700 transition-transform duration-150 hover:scale-125",v.innerHTML='<i class="fas fa-plus-circle text-lg"></i>'),v.addEventListener("click",()=>fe(s)),d.appendChild(v),d}function Ye(s,o,d=!1){if(d){const u=document.createElement("p");return u.className="w-full h-full p-1 text-xs text-gray-700",u.textContent=o[s]||"",u}const v=document.createElement("textarea");return v.className="w-full h-full p-1 text-xs bg-white border-0 rounded focus:outline-none focus:ring-1 focus:ring-tomato resize-none",v.placeholder="Remarque...",v.value=f[s]||"",v.dataset.slotId=s,v.addEventListener("change",u=>{const y=u.target.value;y?f[s]=y:delete f[s];const[h,m]=s.split("-"),C=`a modifi√© la remarque pour ${N[parseInt(h,10)]} ${m==="lunch"?"midi":"soir"}`;S({[`weeks.${a}.remarksData`]:f},C)}),v.addEventListener("focus",u=>{Et({type:"editing_remark",fieldId:s})}),v.addEventListener("blur",u=>{Et("idle")}),v}function tt(){document.querySelectorAll(".meal-card").forEach(s=>{s.addEventListener("dragstart",De),s.addEventListener("dragend",W)}),document.querySelectorAll(".meal-slot").forEach(s=>{s.addEventListener("dragover",F),s.addEventListener("dragleave",P),s.addEventListener("drop",_)})}async function nt(s,o){const d=JSON.parse(JSON.stringify(i)),v=d[s],u={id:o.id};Array.isArray(v)?v.push(u):d[s]=[u];const[y,h]=s.split("-"),m=N[parseInt(y,10)],x=h==="lunch"?"midi":"soir",L=`a ajout√© '${o.name}' √† ${m} ${x}`;await S({[`weeks.${a}.menuData`]:d},L),he()}async function at(s,o){if(!l||!i[s]||!Array.isArray(i[s]))return;const d=i[s][o],v=JSON.parse(JSON.stringify(i));v[s].splice(o,1),v[s].length===0&&delete v[s];const[u,y]=s.split("-"),h=N[parseInt(u,10)],m=y==="lunch"?"midi":"soir",x=`a supprim√© '${d.name}' de ${h} ${m}`;await S({[`weeks.${a}.menuData`]:v},x)}async function Wt(){if(confirm("Voulez-vous vraiment vider le menu de cette semaine ?")){const s={id:availablePlans.length>0?availablePlans[0].id:`${Ie()}_semaine-${a}`,name:availablePlans.length>0?availablePlans[0].name:"Mon plan",menuData:{},servingsData:{},remarksData:{},defaultNumPeople:b,startDay:r,lastUpdated:new Date};loadPlan(s),availablePlans.length>0?availablePlans[0]=s:availablePlans.push(s),await S({[`weeks.${a}`]:{menuData:{},servingsData:{},remarksData:{}}},`a vid√© le menu de la semaine ${a}`)}}function Jt(s){s>=1&&s<=52&&(a=s,k())}function Pn(){e.currentWeekDisplay&&(e.currentWeekDisplay.textContent=`Semaine ${a}`)}function $n(){e.prevWeekBtn?.addEventListener("click",()=>Jt(a-1)),e.nextWeekBtn?.addEventListener("click",()=>Jt(a+1)),e.clearMenuBtn?.addEventListener("click",Wt),e.startDaySelect?.addEventListener("change",async d=>{r=d.target.value,l&&await S({startDay:r},`a chang√© le premier jour de la semaine √† '${r}'`)}),e.planSelect?.addEventListener("change",Gt),e.closeMealSelectModalBtn?.addEventListener("click",he),e.mealSelectModal?.addEventListener("click",d=>{d.target===e.mealSelectModal&&he()}),e.closeRecipeModalBtn?.addEventListener("click",()=>Je.closeForm()),e.cancelRecipeBtn?.addEventListener("click",()=>Je.closeForm()),e.importListBtn?.addEventListener("click",pe),e.closeImportListModalBtn?.addEventListener("click",Te),e.importListModal?.addEventListener("click",d=>{d.target===e.importListModal&&Te()}),e.exportTxtBtn?.addEventListener("click",T),e.exportPdfBtn?.addEventListener("click",O),e.exportPlanPdfBtn?.addEventListener("click",z);const s=d=>{const v=d.target.closest(".info-meal-btn");if(v){const u=v.dataset.slotId,y=parseInt(v.dataset.mealIndex,10);if(u&&!isNaN(y)){const h=i[u]?.[y];if(h&&h.id){const m=E.find(x=>x.id===h.id);m&&Ke(v,m)}}}};e.mealPlanGrid?.addEventListener("click",s),document.getElementById("mobile-meal-plan")?.addEventListener("click",s),e.sharePlanBtn?.addEventListener("click",()=>{if(!l){alert("Veuillez s√©lectionner un plan √† partager.");return}zt({plan:l})}),e.inviteParticipantBtn?.addEventListener("click",()=>{if(!l){alert("Veuillez s√©lectionner un plan pour inviter des participants.");return}vn(l)}),e.historyPlanBtn?.addEventListener("click",ne),e.closePlanHistoryModalBtn?.addEventListener("click",j),e.planHistoryModal?.addEventListener("click",d=>{d.target===e.planHistoryModal&&j()}),e.openTrashBtn?.addEventListener("click",()=>{e.trashModal.classList.remove("hidden")}),e.closeTrashModalBtn?.addEventListener("click",()=>{e.trashModal.classList.add("hidden")}),e.trashModal?.addEventListener("click",d=>{d.target===e.trashModal&&e.trashModal.classList.add("hidden")}),e.savePlanBtn?.addEventListener("click",async()=>{if(!l){alert("Veuillez s√©lectionner un plan de travail avant de sauvegarder.");return}const d=document.getElementById("save-plan-as-modal"),v=document.getElementById("save-plan-as-form"),u=document.getElementById("save-plan-name"),y=document.getElementById("cancel-save-plan-as-btn"),h=document.getElementById("close-save-plan-as-modal"),m=new Date().toLocaleDateString("fr-FR"),x=l.weeks?Object.keys(l.weeks).filter($=>l.weeks[$]&&Object.keys(l.weeks[$].menuData||{}).length>0).length:0,L=x>1?`${x} semaines`:`${x} semaine`;u.value=`${l.name} (${L}) - ${m}`,d.classList.remove("hidden");const C=async $=>{$.preventDefault();const q=u.value;if(!q)return;l.weeks||(l.weeks={}),l.weeks[a]={menuData:i,servingsData:c,remarksData:f},l.startDay=r,l.defaultNumPeople=b;const G=JSON.parse(JSON.stringify(l));if(G.weeks)for(const ce in G.weeks){const ue=G.weeks[ce];if(ue&&ue.menuData)for(const me in ue.menuData){const we=ue.menuData[me];Array.isArray(we)&&(ue.menuData[me]=we.map(Me=>Me&&Me.id&&E.find(Ne=>Ne.id===Me.id)||Me))}}await Cn(q,G),d.classList.add("hidden"),v.removeEventListener("submit",C)},M=()=>{d.classList.add("hidden"),v.removeEventListener("submit",C)};v.addEventListener("submit",C,{once:!0}),y.addEventListener("click",M,{once:!0}),h.addEventListener("click",M,{once:!0})})}function Hn(s=""){return s.split(" ").map(v=>v[0]).join("").substring(0,2).toUpperCase()}function Bt(s=[],o={}){const d=document.getElementById("collaborators-bar"),v=document.getElementById("activity-labels-container"),u=document.getElementById("name-tooltip");if(!d||!u||!v)return;if(d.innerHTML="",v.innerHTML="",document.querySelectorAll(".remark-lock-overlay").forEach(m=>m.remove()),document.querySelectorAll("textarea[data-slot-id]").forEach(m=>{m.disabled=!1}),s.length<=1&&Object.keys(o).length<=1){d.classList.add("hidden");return}let y="";const h=Ie();s.forEach(m=>{if(!m)return;const x=o.hasOwnProperty(m.uid),L=o[m.uid]||{},C=document.createElement("div");C.className="w-8 h-8 rounded-full flex items-center justify-center bg-gray-300 text-white font-bold text-xs ring-2 ring-white cursor-pointer transition-all duration-300";const M=x?"(pr√©sent)":"(absent)";if(C.dataset.name=`${m.displayName||"Inconnu"} ${M}`,m.photoURL?C.innerHTML=`<img src="${m.photoURL}" alt="${m.displayName}" class="w-full h-full rounded-full object-cover">`:C.textContent=Hn(m.displayName),x||C.classList.add("grayscale","opacity-50"),C.addEventListener("mouseenter",$=>{u.textContent=$.currentTarget.dataset.name,u.classList.remove("hidden");const q=$.currentTarget.getBoundingClientRect();u.style.left=`${q.left+q.width/2-u.offsetWidth/2}px`,u.style.top=`${q.top-u.offsetHeight-5}px`}),C.addEventListener("mouseleave",()=>{u.classList.add("hidden")}),d.appendChild(C),x&&m.uid!==h){const $=L.status;if(typeof $=="object"&&$.type==="editing_remark"){const q=document.querySelector(`textarea[data-slot-id="${$.fieldId}"]`);if(q){q.disabled=!0;const G=document.createElement("div");G.className="remark-lock-overlay absolute inset-0 bg-gray-400 bg-opacity-25 flex items-center justify-center text-xs text-white font-bold",G.innerHTML=`<i class="fas fa-lock mr-1"></i> ${m.displayName} √©crit...`,q.parentElement&&(q.parentElement.classList.add("relative"),q.parentElement.appendChild(G))}}else if(typeof $=="string"&&$!=="idle"){let q="";switch($){case"editing_recipe":q="modifie une recette...";break}q&&(y+=`<span class="italic mr-4">${m.displayName} ${q}</span>`)}}}),v.innerHTML=y,d.classList.remove("hidden")}function Gt(){Dn();const s=e.planSelect.value;s&&localStorage.setItem("lastActivePlanId",s),l=U.find(h=>h.id===s)||null;const o=document.getElementById("delete-plan-btn"),d=document.getElementById("rename-plan-btn"),v=document.getElementById("leave-plan-btn"),u=document.getElementById("invite-participant-btn"),y=document.getElementById("history-plan-btn");if(o&&(o.style.display=l&&l.isOwner?"inline-flex":"none"),d&&(d.style.display=l&&l.isOwner?"inline-flex":"none"),y&&(y.style.display=l&&l.isOwner?"inline-flex":"none"),v&&(v.style.display=l&&!l.isOwner?"inline-flex":"none"),u){const h=l&&(l.type==="collaborative"||l.collaborators&&l.collaborators.length>0);u.style.display=l&&l.isOwner&&h?"inline-flex":"none"}l&&l.participants&&l.participants.length>1?(Bt(l.participants,{}),Tn(l.id,h=>{Bt(l.participants,h)})):Bt([],{}),l&&(l.manualItems=l.manualItems||[]),k()}async function Xt(s,o){if(!l)return;const d=JSON.parse(JSON.stringify(c));o===b?delete d[s]:d[s]=o;const[v,u]=s.split("-"),m=`a chang√© le nombre de personnes pour ${N[parseInt(v,10)]} ${u==="lunch"?"midi":"soir"} √† ${o}`;await S({[`weeks.${a}.servingsData`]:d},m)}async function Rn(){if(!w)return;const s=wn();$n(),R(),await D();const o=Ve(J(w,"recipes"),v=>{if(console.log("Recipe data updated from listener."),E=v.docs.map(u=>{const y=u.data();return{id:u.id,...y,imageUrl:y.imageUrl||""}}),l){for(const u in i){const y=i[u];if(Array.isArray(y)){const h=y.map(m=>{if(m&&m.id){const x=E.find(L=>L.id===m.id);return x?{...x}:m}return m});i[u]=h}}re(e.mealPlanGrid,{menuData:i,servingsData:c,remarksData:f,defaultNumPeople:b,startDay:r},!1),X(document.getElementById("mobile-meal-plan"),{menuData:i,servingsData:c,remarksData:f,defaultNumPeople:b,startDay:r},!1),se()}}),d=Vt(v=>{U=v,En(v);const u=localStorage.getItem("selectedPlanId"),y=localStorage.getItem("lastActivePlanId");u&&v.some(h=>h.id===u)?(e.planSelect.value=u,localStorage.removeItem("selectedPlanId")):y&&v.some(h=>h.id===y)&&(e.planSelect.value=y),Gt()});return()=>{d(),o(),s()}}const An=Rn();return async()=>{const s=await An;typeof s=="function"&&s()}}const _a=Object.freeze(Object.defineProperty({__proto__:null,default:Da},Symbol.toStringTag,{value:"Module"}));function Pa(){const e=_n();return Ft(),()=>{typeof e=="function"&&e()}}async function Ft(){const e=document.getElementById("received-shares-container"),t=Ie();if(!(!t||!e)){e.innerHTML='<p class="text-gray-500">Chargement des partages re√ßus...</p>';try{const n=Le(J(w,"plans"),le("userId","==",t),le("isShared","==",!0)),a=Le(J(w,"plans"),le("collaborators","array-contains",t)),[r,i]=await Promise.all([Ee(n),Ee(a)]);let c=[];if(r.forEach(f=>c.push({id:f.id,type:"Planification (Copie)",...f.data()})),i.forEach(f=>c.push({id:f.id,type:"Planification (Collaboratif)",...f.data()})),c.length===0){e.innerHTML=`<p class="text-gray-500">Vous n'avez aucun contenu partag√© par d'autres utilisateurs.</p>`;return}c.sort((f,g)=>(g.sharedAt?.seconds||g.lastUpdated?.seconds||0)-(f.sharedAt?.seconds||f.lastUpdated?.seconds||0)),e.innerHTML="";for(const f of c){const g=f.originalOwnerId||f.userId;if(!g)continue;const p=await Se(H(w,"users",g)),E=p.exists()?p.data().displayName:"Utilisateur inconnu";e.appendChild($a(f,E))}}catch(n){console.error("Erreur lors du chargement des partages re√ßus : ",n),e.innerHTML='<p class="text-red-500">Une erreur est survenue.</p>'}}}function $a(e,t){const n=document.createElement("div");n.className="bg-white rounded-lg p-4 flex justify-between items-center shadow-sm";const a=document.createElement("div"),r=document.createElement("p");r.className="font-bold text-gray-800";let i="";e.type.includes("Collaboratif")?i=' <span class="text-xs font-medium bg-blue-100 text-blue-800 px-2 py-1 rounded-full">Collab</span>':e.type.includes("Copie")&&(i=' <span class="text-xs font-medium bg-gray-200 text-gray-800 px-2 py-1 rounded-full">Copie</span>'),r.innerHTML=`${e.name}${i}`;const c=document.createElement("p");c.className="text-sm text-gray-500 mt-1";const f=e.sharedAt?new Date(e.sharedAt.seconds*1e3).toLocaleDateString("fr-FR"):e.lastUpdated?new Date(e.lastUpdated.seconds*1e3).toLocaleDateString("fr-FR"):"date inconnue";c.textContent=`Partag√© par ${t} le ${f}`,a.appendChild(r),a.appendChild(c),n.appendChild(a);const g=document.createElement("button");return g.className="btn btn-ghost text-red-500 btn-sm",g.innerHTML='<i class="fas fa-trash"></i>',g.title="Supprimer ce contenu partag√©",g.addEventListener("click",()=>Ha(e.id,e.type)),n.appendChild(g),n}async function Ha(e,t){if(confirm(`Voulez-vous vraiment supprimer cette ${t.toLowerCase()} partag√©e ?`))try{const n=t.startsWith("Planification")?"plans":"shopping_lists",a=H(w,n,e),r=await Se(a);r.exists()&&r.data().userId===Ie()?(await Fe(a),Ft()):(alert("Vous n'avez pas la permission de supprimer cet √©l√©ment ou il a d√©j√† √©t√© supprim√©."),Ft())}catch(n){console.error("Erreur de suppression: ",n),alert("Une erreur est survenue.")}}async function _n(){const e=document.getElementById("sent-shares-container"),t=Ie();if(!t||!e)return()=>{};e.innerHTML='<p class="text-gray-500">Chargement des partages envoy√©s...</p>';const n=J(w,"shares"),a=Le(n,le("senderId","==",t));return Ve(a,async r=>{if(r.empty){e.innerHTML=`<p class="text-gray-500">Vous n'avez envoy√© aucun partage.</p>`;return}const i=r.docs.sort((c,f)=>(f.data().createdAt?.seconds||0)-(c.data().createdAt?.seconds||0));e.innerHTML="";for(const c of i){const f=c.data();try{const g=await Se(H(w,"users",f.receiverId));if(g.exists()){const p=g.data();e.appendChild(Ra(f,p.displayName,c.id))}}catch(g){console.error("Could not load receiver for sent share",g)}}},r=>{console.error("Erreur lors du chargement des partages envoy√©s : ",r),e&&(e.innerHTML='<p class="text-red-500">Une erreur est survenue.</p>')})}function Ra(e,t,n){const a=document.createElement("div");a.className="bg-white rounded-lg p-4 flex justify-between items-center shadow-sm";const r=document.createElement("div"),i=document.createElement("p");i.className="font-bold text-gray-800";let c=[];e.plan&&c.push("Planification"),e.shoppingList&&c.push("Liste de courses"),i.textContent=c.join(" et ");const f=document.createElement("p");f.className="text-sm text-gray-500";const g=new Date(e.createdAt.seconds*1e3).toLocaleDateString("fr-FR");f.textContent=`Envoy√© √† ${t} le ${g}`,r.appendChild(i),r.appendChild(f),a.appendChild(r);const p=document.createElement("div");p.className="flex items-center space-x-4";const E=document.createElement("span");E.textContent=e.status;let I="bg-gray-200 text-gray-800";switch(e.status){case"accepted":I="bg-green-100 text-green-800";break;case"declined":I="bg-red-100 text-red-800";break;case"pending":I="bg-yellow-100 text-yellow-800";break}E.className=`text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full ${I}`,p.appendChild(E);const b=document.createElement("button");return b.className="btn btn-ghost text-red-500 btn-sm",b.innerHTML='<i class="fas fa-trash"></i>',b.title="Annuler le partage",b.addEventListener("click",()=>Aa(n)),p.appendChild(b),a.appendChild(p),a}async function Aa(e){if(confirm("Voulez-vous vraiment annuler ce partage ? L'autre utilisateur ne le verra plus."))try{await Fe(H(w,"shares",e)),_n()}catch(t){console.error("Erreur lors de la suppression du partage: ",t),alert("Une erreur est survenue.")}}const ja=Object.freeze(Object.defineProperty({__proto__:null,default:Pa},Symbol.toStringTag,{value:"Module"})),Ge=un();let ot=null,qe=null,rn=[],on=[],ln={};function qa(){const e=document.getElementById("shopping-mode-container"),t=document.getElementById("shopping-mode-plan-select"),n=document.getElementById("shopping-mode-back-btn");n&&n.addEventListener("click",()=>{window.location.hash="#menu";const g=document.querySelector('button[data-path="menu"]');g&&g.click()});async function a(){try{on=(await Ee(J(Ge,"ingredients"))).docs.map(p=>({id:p.id,...p.data()}))}catch(g){console.error("Error fetching ingredients",g)}try{rn=(await Ee(J(Ge,"recipes"))).docs.map(p=>({id:p.id,...p.data()}))}catch(g){console.error("Error fetching recipes",g)}Vt(g=>{if(!t)return;if(t.innerHTML="",g.length===0){e.innerHTML='<p class="text-center p-4">Aucun plan trouv√©.</p>';return}g.forEach(E=>{const I=document.createElement("option");I.value=E.id,I.textContent=E.name,t.appendChild(I)});const p=localStorage.getItem("lastActivePlanId");p&&g.some(E=>E.id===p)?(t.value=p,r(p)):g.length>0&&r(g[0].id),t.addEventListener("change",E=>{const I=E.target.value;localStorage.setItem("lastActivePlanId",I),r(I)})})}function r(g){ot&&(ot(),ot=null);const p=H(Ge,"plans",g);ot=Ve(p,E=>{E.exists()?(qe={id:E.id,...E.data()},ln=qe.checkedItems||{},i()):e.innerHTML='<p class="text-center p-4 text-red-500">Plan introuvable.</p>'})}function i(){if(!qe||!e)return;const{active:g,deleted:p}=f(qe);if(e.innerHTML="",g.length===0&&p.length===0){e.innerHTML='<p class="text-center p-10 text-gray-500">Votre liste de courses est vide pour ce plan.</p>';return}const E=g.reduce((A,ae)=>{const D=ae.category||"Inconnue";return A[D]||(A[D]=[]),A[D].push(ae),A},{});Object.keys(E).sort((A,ae)=>A==="Inconnue"?1:ae==="Inconnue"?-1:A.localeCompare(ae)).forEach(A=>{const ae=document.createElement("h3");ae.className="font-bold text-lg text-gray-700 mt-6 mb-3 border-b border-gray-200 pb-1 sticky top-0 bg-white z-10",ae.textContent=A,e.appendChild(ae);const D=document.createElement("ul");D.className="space-y-3",E[A].sort((k,S)=>k.name.localeCompare(S.name)).forEach(k=>{const S=`${k.name}_${k.unit||""}`,j=ln[S]||!1,Q=document.createElement("li");Q.className=`flex flex-col p-3 rounded-lg transition-colors duration-200 ${j?"bg-gray-100":"bg-white shadow-sm border border-gray-100"}`;const oe=document.createElement("div");oe.className="flex items-center w-full";const ne=document.createElement("input");ne.type="checkbox",ne.className="form-checkbox h-6 w-6 text-tomato rounded-full border-gray-300 focus:ring-tomato cursor-pointer transition duration-150 ease-in-out",ne.checked=j;const X=document.createElement("div");X.className="ml-3 flex-grow cursor-pointer select-none";const re=Number.isInteger(k.totalQuantity)?k.totalQuantity:parseFloat(k.totalQuantity.toFixed(2)),ee=document.createElement("span");ee.className=`font-medium text-base ${j?"line-through text-gray-400":"text-gray-800"}`,ee.textContent=k.name;const pe=document.createElement("span");pe.className=`ml-2 font-bold text-base ${j?"text-gray-400":"text-gray-800"}`,pe.textContent=` - ${re} ${k.unit||""}`.trim(),X.appendChild(ee),X.appendChild(pe);const Te=()=>{const R=!ne.checked;ne.checked=R,c(S,R,Q,ne,ee,pe)};if(ne.addEventListener("change",R=>{c(S,R.target.checked,Q,ne,ee,pe)}),X.addEventListener("click",Te),oe.appendChild(ne),oe.appendChild(X),Q.appendChild(oe),k.sources&&k.sources.length>0){const R=document.createElement("div");R.className="mt-2 ml-9 text-xs text-gray-500 space-y-1";const T=k.sources.reduce((O,z)=>{const Y=`${z.recipeName} (${z.day} ${z.time})`;return O[Y]||(O[Y]=0),O[Y]+=z.quantity,O},{});for(const O in T){const z=document.createElement("div");z.textContent=`‚Ü≥ ${O}`,R.appendChild(z)}Q.appendChild(R)}D.appendChild(Q)}),e.appendChild(D)});const b=document.getElementById("shopping-mode-trash-btn");document.getElementById("shopping-mode-trash-count");const B=document.getElementById("shopping-trash-modal"),U=document.getElementById("shopping-trash-list"),l=document.getElementById("close-shopping-trash-modal"),N=document.getElementById("shopping-empty-trash-btn");if(b&&b.classList.add("hidden"),B&&l&&(l.onclick=()=>B.classList.add("hidden"),B.addEventListener("click",A=>{A.target===B&&B.classList.add("hidden")})),p&&p.length>0){if(N){N.classList.remove("hidden");const A=N.cloneNode(!0);N.parentNode.replaceChild(A,N),A.addEventListener("click",async()=>{if(!qe||!confirm("Tout supprimer d√©finitivement ?"))return;const ae=H(Ge,"plans",qe.id),D=p.map(k=>`${k.name}_${k.unit||""}`);try{await lt(()=>import("./firebase-config-CV1YP_xo.js").then(k=>k.F),[]).then(k=>{k.updateDoc(ae,{hiddenTrashItems:k.arrayUnion(...D),lastUpdated:new Date})}),B.classList.add("hidden")}catch(k){console.error("Erreur vidage corbeille:",k)}})}if(U){U.innerHTML="";const A=document.createElement("ul");A.className="space-y-3",p.forEach(ae=>{const D=document.createElement("li");D.className="flex items-center p-3 rounded-lg bg-gray-100 shadow-inner justify-between";const k=document.createElement("div");k.className="flex-grow ml-2 overflow-hidden";const S=document.createElement("span");S.className="font-medium text-base text-gray-500 line-through block truncate",S.textContent=ae.name,k.appendChild(S);const j=document.createElement("div");j.className="flex items-center space-x-2 flex-shrink-0";const Q=document.createElement("button");Q.className="text-blue-600 hover:text-blue-800 font-medium text-sm px-3 py-1 border border-blue-300 rounded-full hover:bg-blue-50 transition-colors",Q.innerHTML='<i class="fas fa-undo"></i>',Q.addEventListener("click",async()=>{if(!qe)return;const ne=H(Ge,"plans",qe.id);try{await lt(()=>import("./firebase-config-CV1YP_xo.js").then(X=>X.F),[]).then(async X=>{await X.runTransaction(Ge,async re=>{const ee=await re.get(ne);if(!ee.exists())return;const Te=(ee.data().manualItems||[]).filter(R=>!(R.name.toLowerCase()===ae.name.toLowerCase()&&R.unit===ae.unit));re.update(ne,{manualItems:Te,lastUpdated:new Date})}),p.length<=1&&B.classList.add("hidden")})}catch(X){console.error("Erreur lors de la restauration :",X)}});const oe=document.createElement("button");oe.className="text-gray-400 hover:text-red-600 font-medium text-sm px-2 py-1",oe.innerHTML='<i class="fas fa-times text-lg"></i>',oe.addEventListener("click",async()=>{if(!qe)return;const ne=H(Ge,"plans",qe.id),X=`${ae.name}_${ae.unit||""}`;try{await lt(()=>import("./firebase-config-CV1YP_xo.js").then(re=>re.F),[]).then(re=>{re.updateDoc(ne,{hiddenTrashItems:re.arrayUnion(X),lastUpdated:new Date})}),p.length<=1&&B.classList.add("hidden")}catch(re){console.error("Erreur suppression d√©finitive:",re)}}),j.appendChild(Q),j.appendChild(oe),D.appendChild(k),D.appendChild(j),A.appendChild(D)}),U.appendChild(A)}}else U&&(U.innerHTML='<p class="text-center text-gray-500 italic py-4">La corbeille est vide.</p>'),N&&N.classList.add("hidden")}function c(g,p,E,I,b,B){if(!qe)return;p?(E.classList.remove("bg-white","shadow-sm","border","border-gray-100"),E.classList.add("bg-gray-100"),b.classList.add("line-through","text-gray-400"),b.classList.remove("text-gray-800"),B.classList.add("text-gray-400"),B.classList.remove("text-gray-800")):(E.classList.add("bg-white","shadow-sm","border","border-gray-100"),E.classList.remove("bg-gray-100"),b.classList.remove("line-through","text-gray-400"),b.classList.add("text-gray-800"),B.classList.remove("text-gray-400"),B.classList.add("text-gray-800"));const U=H(Ge,"plans",qe.id),l={};l[`checkedItems.${g}`]=p,l.lastUpdated=new Date,lt(()=>import("./firebase-config-CV1YP_xo.js").then(N=>N.F),[]).then(N=>{N.updateDoc(U,l)}).catch(N=>{console.error("Error updating checked item:",N)})}function f(g){const p=new Map;(g.manualItems||[]).forEach(l=>{const N=`${l.name.trim().toLowerCase()}_${l.unit||""}`;p.set(N,{name:l.name.trim(),totalQuantity:l.totalQuantity,unit:l.unit,category:l.category||"Inconnue"})});const I=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];if(g.weeks)for(const l in g.weeks){const N=g.weeks[l],A=N.menuData||{},ae=N.servingsData||{};for(const D in A){const k=A[D];if(!Array.isArray(k))continue;const[S,j]=D.split("-"),Q=`${S}-${j}`,oe=parseInt(ae[Q]||g.defaultNumPeople||1,10);k.forEach(ne=>{const X=rn.find(ee=>ee.id===ne.id)||ne;if(!X||!X.ingredients)return;const re=X.servings||1;X.ingredients.forEach(ee=>{if(!ee.name||!ee.quantity)return;const pe=on.find(te=>te.name.toLowerCase()===ee.name.toLowerCase()),Te=pe?pe.category:"Inconnue",R=parseFloat(String(ee.quantity).replace(",","."));if(isNaN(R))return;const O=R/re*oe,z=ee.unit||"",Y=`${ee.name.trim().toLowerCase()}_${z}`;if(p.has(Y)){const te=p.get(Y);te.totalQuantity+=O,te.sources||(te.sources=[]),te.sources.push({recipeName:X.name,day:I[parseInt(S,10)],time:j==="lunch"?"Midi":"Soir",quantity:O})}else p.set(Y,{name:ee.name.trim(),totalQuantity:O,unit:z,category:Te,sources:[{recipeName:X.name,day:I[parseInt(S,10)],time:j==="lunch"?"Midi":"Soir",quantity:O}]})})})}}const b=[],B=[],U=g.hiddenTrashItems||[];return p.forEach(l=>{if(l.totalQuantity>0)b.push(l);else if(l.totalQuantity<=0&&l.sources&&l.sources.length>0){const N=`${l.name}_${l.unit||""}`;U.includes(N)||B.push(l)}}),{active:b,deleted:B}}return a(),()=>{ot&&ot()}}const Ua=Object.freeze(Object.defineProperty({__proto__:null,default:qa},Symbol.toStringTag,{value:"Module"}));function Fa(){const e=localStorage.getItem("selectedPlanId"),t=document.getElementById("plan-view-name"),n=document.getElementById("meal-plan-grid"),a=document.getElementById("close-view-plan-btn");if(a&&a.addEventListener("click",()=>{localStorage.removeItem("selectedPlanId"),ct("plans")}),!e)return t&&(t.textContent="Aucune sauvegarde s√©lectionn√©e"),n&&(n.innerHTML=`<p class="text-center text-red-500">Erreur : Aucun ID de sauvegarde trouv√©. Veuillez retourner √† la page 'Mes Plans Sauvegard√©s' et en s√©lectionner une.</p>`),()=>{};async function r(){try{const i=H(w,"plan_saves",e),c=await Se(i);if(!c.exists())throw new Error("Sauvegarde non trouv√©e");const f=c.data(),g=f.planData;if(!g)throw new Error("Les donn√©es du plan sauvegard√© sont corrompues ou manquantes.");t&&(t.textContent=`Vue de : ${f.name}`),Oa(n,g)}catch(i){console.error("Error fetching save:",i),t&&(t.textContent="Erreur"),n&&(n.innerHTML=`<p class="text-center text-red-500">${i.message}</p>`)}}return r(),()=>{localStorage.removeItem("selectedPlanId")}}function Oa(e,t){if(!e)return;e.innerHTML="";const n=Object.keys(t.weeks||{}).sort((a,r)=>parseInt(a)-parseInt(r));if(n.length===0){e.innerHTML='<p class="text-center text-gray-500 p-10 col-span-full">Ce plan est vide.</p>';return}n.forEach(a=>{const r=t.weeks[a],i=document.createElement("h3");i.className="text-lg font-bold text-gray-700 mt-6 mb-2 col-span-full",i.textContent=`Semaine ${a}`,e.appendChild(i);const c=document.createElement("div");za(c,r,t.startDay,t.defaultNumPeople),e.appendChild(c)})}function za(e,t,n,a){const r=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"],i=r.indexOf(n||"Lundi"),c=[...r.slice(i),...r.slice(0,i)],f=t.menuData||{},g=t.servingsData||{},p=t.remarksData||{};c.forEach(E=>{const I=r.indexOf(E),b=document.createElement("div");b.className="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] items-stretch border-b border-gray-300";const B=document.createElement("div");B.className="font-bold p-2 flex items-center justify-center bg-gray-100 text-sm border-r border-gray-300",B.textContent=E.toUpperCase(),b.appendChild(B),["lunch","dinner"].forEach(U=>{const l=`${I}-${U}`,N=g[l]||a||1,A=document.createElement("div");A.className="border-r border-gray-300 flex items-center justify-center",A.innerHTML=`<div class="text-center"><i class="fas fa-users fa-xs mb-1"></i><br>${N}</div>`,b.appendChild(A);for(let ae=0;ae<5;ae++){const D=`${I}-${U}-${ae}`,k=document.createElement("div");if(k.className="meal-slot p-1 min-h-[50px] border-r border-gray-300",ae===4)k.textContent=p[D]||"",k.classList.add("text-xs","italic","text-gray-600");else{const S=f[D];Array.isArray(S)&&S.length>0&&S.forEach(j=>{const Q=document.createElement("div");Q.className="p-1 bg-white rounded shadow-sm text-center text-xs font-medium",Q.textContent=j.name,k.appendChild(Q)})}b.appendChild(k)}}),e.appendChild(b)})}const Va=Object.freeze(Object.defineProperty({__proto__:null,default:Fa},Symbol.toStringTag,{value:"Module"})),dn=document.querySelector("main"),Qa={menu:{html:`
        <div class="flex flex-col md:flex-row md:space-x-2">

            <!-- Left Column: Meal Planner -->
            <div class="w-full md:w-5/6">
                <section id="meal-planning-section" aria-labelledby="meal-planning-heading" class="mb-8 md:mb-12">
                                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                                        <h2 id="meal-planning-heading" class="text-xl md:text-2xl font-bold text-gray-800">Planification des repas</h2>
                                        <div class="mt-3 md:mt-0 flex items-center space-x-2 md:space-x-3 plan-actions">
                                            <button id="generate-plan-ai-btn" class="btn btn-primary btn-sm">
                                                <i class="fas fa-robot mr-1 md:mr-2"></i> IA Semaine
                                            </button>
                                            <button id="clear-menu-btn" class="btn btn-outline btn-sm text-red-800 hover:bg-red-100">
                                                <i class="fas fa-trash-alt mr-1 md:mr-2"></i> Vider le menu
                                            </button>
                                            <button id="export-plan-pdf-btn" class="btn btn-outline btn-sm">
                                                <i class="fas fa-file-pdf mr-1 md:mr-2"></i> Exporter Plan (PDF)
                                            </button>
                                            <button id="share-plan-btn" class="btn btn-secondary btn-sm">
                                                <i class="fas fa-share-alt mr-1 md:mr-2"></i> Partager
                                            </button>
                                            <button id="save-plan-btn" class="btn btn-secondary btn-sm">
                                                <i class="fas fa-save mr-1 md:mr-2"></i> Sauvegarder Plan
                                            </button>
                                        </div>
                                    </div>
                            
                                    <!-- Week Navigation & Plan Selector -->
                                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 space-y-3 md:space-y-0">
                                        <!-- Week Navigation -->
                                        <div class="flex justify-between items-center bg-white p-2 md:p-3 rounded-lg shadow-sm">
                                            <button id="prev-week-btn" class="btn btn-ghost btn-sm" aria-label="Semaine pr√©c√©dente">
                                                <i class="fas fa-chevron-left mr-1 md:mr-2"></i> Pr√©c.
                                            </button>
                                            <div id="current-week-display" class="text-gray-700 font-medium text-sm md:text-base text-center mx-4">Semaine X</div>
                                            <button id="next-week-btn" class="btn btn-ghost btn-sm" aria-label="Semaine suivante">
                                                Suiv. <i class="fas fa-chevron-right ml-1 md:ml-2"></i>
                                            </button>
                                        </div>
                                        <!-- Plan Selector -->
                                        <div class="flex flex-wrap items-center justify-center gap-2 bg-white p-3 rounded-lg shadow-sm">
                                            <label for="plan-select" class="text-sm font-medium text-gray-700">Plan affich√©:</label>
                                            <select id="plan-select" class="rounded-md border-gray-300 shadow-sm focus:border-tomato focus:ring focus:ring-tomato focus:ring-opacity-50 text-sm py-1">
                                                <!-- Options will be generated by JS -->
                                            </select>
                                            <button id="create-plan-btn" class="btn btn-primary btn-sm" title="Cr√©er un nouveau plan">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                            <button id="rename-plan-btn" class="btn btn-ghost text-blue-500 hover:bg-blue-100 btn-sm" title="Renommer le plan s√©lectionn√©">
                                                <i class="fas fa-pencil-alt"></i>
                                            </button>
                                            <button id="history-plan-btn" class="btn btn-ghost text-purple-500 hover:bg-purple-100 btn-sm" title="Historique des modifications">
                                                <i class="fas fa-history"></i>
                                            </button>
                                            <button id="leave-plan-btn" class="btn btn-ghost text-yellow-600 hover:bg-yellow-100 btn-sm" title="Quitter le plan collaboratif">
                                                <i class="fas fa-door-open"></i>
                                            </button>
                                            <button id="delete-plan-btn" class="btn btn-ghost text-red-500 hover:bg-red-100 btn-sm" title="Supprimer le plan s√©lectionn√©">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            <button id="invite-participant-btn" class="btn btn-ghost text-green-500 hover:bg-green-100 btn-sm hidden" title="Inviter un participant">
                                                <i class="fas fa-user-plus"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Collaborators Bar -->
                                    <div id="collaborators-bar" class="flex items-center space-x-2 mb-4 hidden">
                                        <!-- Avatars will be injected here -->
                                    </div>

                                    <!-- Activity Labels -->
                                    <div id="activity-labels-container" class="text-sm text-gray-600 mb-4 h-6">
                                        <!-- e.g., 'Sophie is adding a recipe...' -->
                                    </div>
                            
                                            <!-- Settings Section -->
                                            <div class="inline-flex items-center space-x-6 bg-white p-3 rounded-lg shadow-sm mb-4">                                        <div>
                                            <label for="start-day-select" class="text-sm font-medium text-gray-700">D√©but de semaine:</label>
                                            <select id="start-day-select" class="rounded-md border-gray-300 shadow-sm focus:border-tomato focus:ring-tomato text-sm py-1">
                                                <option>Lundi</option>
                                                <option>Mardi</option>
                                                <option>Mercredi</option>
                                                <option>Jeudi</option>
                                                <option>Vendredi</option>
                                                <option>Samedi</option>
                                                <option>Dimanche</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="default-servings-input" class="text-sm font-medium text-gray-700">Personnes par d√©faut:</label>
                                            <div id="default-servings-control" class="mt-1"></div>
                                        </div>
                                    </div>                    <!-- Responsive Meal Plan Grid -->
<div class="bg-white rounded-xl shadow-md p-4">
                        <!-- Desktop Grid (Visible on large screens) -->
                        <div id="desktop-plan-container" class="hidden lg:block">
                            <div id="meal-plan-grid-layout">
                                <!-- Header -->
                                <div class="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] gap-1 text-center mb-1">
                                    <div class="p-2"></div> <!-- Empty corner -->
                                    <div class="p-2 rounded-t-lg bg-amber-100 text-amber-800 font-bold col-span-6">MIDI</div>
                                    <div class="p-2 rounded-t-lg bg-stone-200 text-stone-800 font-bold col-span-6">SOIR</div>
                                    
                                    <div class="p-1"></div> <!-- Empty under day name -->
                                    <div class="p-1 text-xs font-semibold"><i class="fas fa-users"></i></div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Entr√©e</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Plat</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Accomp.</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Dessert</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Remarque</div>

                                    <div class="p-1 text-xs font-semibold"><i class="fas fa-users"></i></div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Entr√©e</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Plat</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Accomp.</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Dessert</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Remarque</div>
                                </div>
                                <!-- Rows generated by JS -->
                                <div id="meal-plan-grid" class="space-y-1">
                                    <div class="p-10 text-center text-gray-500 italic col-span-full">Chargement du planning...</div>
                                </div>
                            </div>
                        </div>

                        <!-- Mobile Accordion (Visible on small screens) -->
                        <div id="mobile-meal-plan" class="lg:hidden space-y-2">
                            <!-- Mobile content will be generated by JS here -->
                             <div class="p-10 text-center text-gray-500 italic col-span-full">Chargement du planning...</div>
                        </div>
                    </div>
                                    </section>


                                </div>
                    
                                <!-- Right Column: Shopping List -->
                                <div class="w-full md:w-1/6">
                                    <section id="shopping-list-section" aria-labelledby="shopping-list-heading" class="mb-8 md:mb-12 md:sticky md:top-24">
                                        <div class="bg-white rounded-xl shadow-md p-4 md:p-6">
                                            <div class="flex justify-between items-center mb-4">
                                        <h2 class="text-2xl font-bold text-gray-800">Liste de courses</h2>
                                        <button id="open-trash-btn" class="btn btn-ghost btn-sm text-gray-500 hover:text-gray-700 ml-2">
                                            <i class="fas fa-trash-alt text-lg"></i> <span id="trash-count" class="bg-gray-200 text-xs px-1.5 py-0.5 rounded-full ml-1">0</span>
                                        </button>
                                    </div>
                                    <div class="flex justify-end space-x-2 mb-4">
                                        <button id="import-list-btn" class="btn btn-secondary btn-sm">
                                                    <i class="fas fa-download mr-2"></i>Importer une liste
                                                </button>
                                                <div id="export-buttons-container" class="flex space-x-2">
                                                    <button id="export-txt-btn" class="btn btn-outline btn-sm">
                                                        <i class="fas fa-file-alt mr-2"></i>TXT
                                                    </button>
                                                    <button id="export-pdf-btn" class="btn btn-outline btn-sm">
                                                        <i class="fas fa-file-pdf mr-2"></i>PDF
                                                    </button>
                                                </div>
                                            </div>
                    
                                            <!-- Shopping List Container -->
                                            <div id="shopping-list-container" class="mb-4 max-h-[70vh] overflow-y-auto pr-2">                            <ul id="shopping-list" class="space-y-2 text-sm">
                                <!-- Les articles de la liste de courses seront g√©n√©r√©s ici -->
                            </ul>
                        </div>

                        <!-- Add Item Input -->
                        <div class="mt-4 flex items-stretch">
                            <div class="relative flex-grow">
                                <input type="text" id="add-item-input" placeholder="Chercher ou ajouter..." class="w-full border border-gray-300 rounded-l-lg px-2 py-1 text-xs focus:outline-none focus:ring-2 focus:ring-tomato focus:border-transparent">
                                <div id="add-item-results" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto bottom-full mb-2"></div>
                            </div>
                            <button id="add-item-btn" class="btn btn-primary rounded-l-none -ml-px btn-xs" aria-label="Ajouter l'article">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>

                         <!-- AI Shopping Tips Placeholder -->
                        <div id="ai-shopping-tip" class="mt-6 bg-avocado bg-opacity-10 rounded-lg p-3 hidden">
                            <div class="flex items-start">
                                 <div class="w-8 h-8 bg-avocado bg-opacity-20 rounded-full flex items-center justify-center mr-3 shrink-0">
                                    <i class="fas fa-lightbulb text-avocado"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-avocado mb-1 text-sm">Astuce √âconomique</h4>
                                    <p id="ai-shopping-tip-text" class="text-sm text-gray-700">...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <!-- Shared Plans Modal -->
        <div id="shared-plans-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-6xl max-h-[90vh] overflow-y-auto relative">
                <button id="close-shared-plans-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" aria-label="Fermer">
                    <i class="fas fa-times text-xl"></i>
                </button>
                <h3 id="shared-plans-modal-title" class="text-2xl font-bold mb-6">Plans partag√©s pour la Semaine X</h3>
                <div id="shared-plans-modal-container" class="space-y-6">
                    <!-- Shared plans will be loaded here -->
                </div>
            </div>
        </div>
        `,script:"./script.js"},recipes:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Recettes</h2>
            <button id="add-recipe-btn" class="btn btn-primary">
                <i class="fas fa-plus mr-2"></i> Ajouter une recette
            </button>
        </div>

        <!-- Search Bar -->
        <div class="mb-6">
            <input type="text" id="search-bar" placeholder="Rechercher une recette..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-tomato focus:border-tomato">
        </div>

        <!-- Tabs Navigation -->
        <div id="category-tabs" class="mb-6 border-b border-gray-200 flex space-x-4 flex-nowrap overflow-x-auto pb-2">
            <!-- Tabs will be generated by recipes.js here -->
        </div>

        <!-- Recipe List Container -->
        <div id="recipe-list-container">
            <!-- Recipes for the selected tab will be loaded here -->
        </div>

        <!-- Reconstructed Recipe Form Modal -->
        <div id="recipe-form-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-3xl max-h-[90vh] overflow-y-auto relative">
                <button id="close-recipe-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" aria-label="Fermer">
                    <i class="fas fa-times text-xl"></i>
                </button>
                <h3 id="recipe-modal-title" class="text-2xl font-bold mb-6">Ajouter/Modifier une recette</h3>
                <form id="recipe-form" class="space-y-4">
                    <input type="hidden" id="recipe-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label for="recipe-name" class="block text-sm font-medium text-gray-700">Nom de la recette</label>
                            <input type="text" id="recipe-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                        </div>
                        <div>
                            <label for="recipe-category" class="block text-sm font-medium text-gray-700">Cat√©gorie</label>
                            <select id="recipe-category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                                <option>ENTREE</option>
                                <option>PLAT</option>
                                <option>ACCOMPAGNEMENT</option>
                                <option>DESSERT</option>
                            </select>
                        </div>
                        <div>
                            <label for="recipe-servings" class="block text-sm font-medium text-gray-700">Nombre de personnes</label>
                            <input type="number" id="recipe-servings" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" min="1">
                        </div>
                        <div>
                            <label for="recipe-prep-time" class="block text-sm font-medium text-gray-700">Temps de pr√©paration (min)</label>
                            <input type="number" id="recipe-prep-time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" min="0">
                        </div>
                         <div>
                            <label for="recipe-difficulty" class="block text-sm font-medium text-gray-700">Difficult√©</label>
                            <select id="recipe-difficulty" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                <option>Tr√®s facile</option>
                                <option>Facile</option>
                                <option>Moyen</option>
                                <option>Difficile</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-lg font-medium text-gray-800 mb-2">Ingr√©dients</h4>
                        <div id="ingredients-list" class="space-y-2"></div>
                        <button type="button" id="add-ingredient-btn" class="btn btn-outline btn-sm mt-2">
                            <i class="fas fa-plus mr-2"></i> Ajouter un ingr√©dient
                        </button>
                    </div>
                    <div>
                        <label for="recipe-steps" class="block text-lg font-medium text-gray-800">Pr√©paration</label>
                        <textarea id="recipe-steps" rows="8" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                    </div>
                    <div class="flex justify-end space-x-4 pt-4">
                        <button type="button" id="cancel-recipe-btn" class="btn btn-ghost">Annuler</button>
                        <button type="submit" id="save-recipe-btn" class="btn btn-primary">Sauvegarder</button>
                    </div>
                </form>
            </div>
        </div>
        `,script:"./recipes.js"},ingredients:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Ingr√©dients</h2>
            <div class="flex space-x-2">
                <button id="manage-categories-btn" class="btn btn-outline">
                    <i class="fas fa-tags mr-2"></i> G√©rer les cat√©gories
                </button>
                <button id="add-ingredient-btn" class="btn btn-primary">
                    <i class="fas fa-plus mr-2"></i> Ajouter un ingr√©dient
                </button>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="mb-6">
            <input type="text" id="search-bar" placeholder="Rechercher un ingr√©dient..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-tomato focus:border-tomato">
        </div>

        <!-- Tabs Navigation -->
        <div id="category-tabs" class="mb-6 border-b border-gray-200 flex space-x-4 flex-nowrap overflow-x-auto pb-2">
            <!-- Tabs will be generated by ingredients.js here -->
        </div>

        <!-- Ingredient List Container -->
        <div id="ingredients-list-container">
            <p class="text-center text-gray-500 p-10">Chargement des ingr√©dients...</p>
        </div>

        <!-- Ingredient Form Modal -->
        <div id="ingredient-form-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-md relative">
                <button id="close-ingredient-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
                <h3 id="ingredient-modal-title" class="text-lg font-bold mb-4">Ajouter un Ingr√©dient</h3>
                <form id="ingredient-form" class="space-y-4">
                    <input type="hidden" id="ingredient-id">
                    <div>
                        <label for="ingredient-name" class="block text-sm font-medium text-gray-700">Nom</label>
                        <input type="text" id="ingredient-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                    </div>
                    <div>
                        <label for="ingredient-unit" class="block text-sm font-medium text-gray-700">Unit√© par d√©faut</label>
                        <select id="ingredient-unit" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select>
                    </div>
                    <div>
                        <label for="ingredient-category" class="block text-sm font-medium text-gray-700">Cat√©gorie</label>
                        <select id="ingredient-category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></select>
                    </div>
                    <div>
                        <label for="ingredient-image-url" class="block text-sm font-medium text-gray-700">URL de l'image</label>
                        <input type="text" id="ingredient-image-url" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="Laisser vide pour une image al√©atoire">
                    </div>
                    <div class="flex justify-end space-x-4 pt-2">
                        <button type="button" id="cancel-ingredient-btn" class="btn btn-ghost">Annuler</button>
                        <button type="submit" id="save-ingredient-btn" class="btn btn-primary">Sauvegarder</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Category Management Modal -->
        <div id="category-management-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-lg relative">
                <h3 class="text-lg font-bold mb-4">G√©rer les cat√©gories d'ingr√©dients</h3>
                <form id="add-category-form" class="flex items-center space-x-2 mb-4">
                    <input type="text" id="new-category-name" placeholder="Nom de la nouvelle cat√©gorie" class="flex-grow mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                    <button type="submit" class="btn btn-secondary">Ajouter</button>
                </form>
                <div id="category-list" class="max-h-64 overflow-y-auto border rounded-lg p-2"></div>
                <div class="flex justify-end space-x-4 mt-4">
                     <button type="button" id="close-category-modal" class="btn btn-ghost">Annuler</button>
                    <button type="button" id="done-category-modal-btn" class="btn btn-primary">Termin√©</button>
                </div>
            </div>
        </div>
        `,script:"./ingredients.js"},lists:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Listes de Courses</h2>
            <button id="add-list-btn" class="btn btn-primary">
                <i class="fas fa-plus mr-2"></i> Cr√©er une liste
            </button>
        </div>

        <!-- Search Bar -->
        <div class="mb-6">
            <input type="text" id="search-bar" placeholder="Rechercher une liste..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-tomato focus:border-tomato">
        </div>

        <!-- Lists Container -->
        <div id="lists-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

        <div class="mt-12">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6">Listes Partag√©es</h2>
            <div id="shared-lists-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Les listes partag√©es seront charg√©es ici par JS -->
            </div>
        </div>

        <!-- List Form Modal -->
        <div id="list-form-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-start justify-center z-[100] hidden pt-20">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-3xl min-h-[75vh] max-h-[90vh] overflow-y-auto relative">
                <button id="close-list-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10"><i class="fas fa-times text-xl"></i></button>
                <h3 id="list-modal-title" class="text-lg font-bold mb-4">Cr√©er une liste</h3>
                <form id="list-form" class="space-y-4 pb-20">
                    <input type="hidden" id="list-id">
                    <div>
                        <label for="list-name" class="block text-sm font-medium text-gray-700">Nom de la liste</label>
                        <input type="text" id="list-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                    </div>
                    <div>
                        <h4 class="text-md font-medium text-gray-800 mb-2">Ingr√©dients</h4>
                        <div id="ingredients-list" class="space-y-2"></div>
                        <button type="button" id="add-ingredient-btn" class="btn btn-outline btn-sm mt-2">
                            <i class="fas fa-plus mr-2"></i> Ajouter un ingr√©dient
                        </button>
                    </div>
                </form>
                <div class="absolute bottom-0 left-0 right-0 px-6 py-4 bg-white/95 backdrop-blur-sm border-t border-gray-200 flex justify-end space-x-4">
                    <button type="button" id="cancel-list-btn" class="btn btn-ghost">Annuler</button>
                    <button type="submit" form="list-form" id="save-list-btn" class="btn btn-primary">Sauvegarder la liste</button>
                </div>
            </div>
        </div>
        `,script:"./lists.js"},friends:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Amis</h2>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="md:col-span-2 space-y-8">
                <div>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Liste d'amis</h3>
                    <div id="friends-list-container" class="space-y-4">
                        <!-- La liste d'amis sera charg√©e ici -->
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Demandes envoy√©es en attente</h3>
                    <div id="pending-requests-container" class="space-y-4">
                        <!-- Les demandes envoy√©es en attente seront charg√©es ici -->
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Demandes rejet√©es</h3>
                    <div id="declined-requests-container" class="space-y-4">
                        <!-- Les demandes rejet√©es seront charg√©es ici -->
                    </div>
                </div>
            </div>
            <div>
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Rechercher un ami</h3>
                    <div class="mb-4">
                        <div class="flex items-center space-x-2">
                            <input type="text" id="search-friends-input" placeholder="Nom ou email..." class="flex-grow p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-tomato focus:border-tomato">
                            <button id="search-friends-btn" class="btn btn-primary"><i class="fas fa-search"></i></button>
                        </div>
                        <div id="search-results-container" class="mt-2 space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>
        `,script:"./friends.js"},shared:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Partages</h2>
        </div>

        <div class="space-y-12">
            <div>
                <h3 class="text-xl font-bold text-gray-700 border-b pb-2 mb-4">Partages Re√ßus</h3>
                <div id="received-shares-container" class="space-y-4">
                    <!-- L'historique des partages accept√©s sera charg√© ici -->
                </div>
            </div>
            <div>
                <h3 class="text-xl font-bold text-gray-700 border-b pb-2 mb-4">Mes Partages Envoy√©s</h3>
                <div id="sent-shares-container" class="space-y-4">
                    <!-- L'historique des partages envoy√©s sera charg√© ici -->
                </div>
            </div>
        </div>
        `,script:"./shared.js"},plans:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Plans Sauvegard√©s</h2>
        </div>
        <div id="all-plans-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- La liste des plans sera charg√©e ici -->
            <p class="text-center text-gray-500 p-10 col-span-full">Chargement de vos plans...</p>
        </div>
        `,script:"./all-plans.js"},"view-plan":{html:`
        <section aria-labelledby="meal-planning-heading" class="mb-8 md:mb-12">
            <div class="flex justify-between items-center mb-4">
                <h2 id="plan-view-name" class="text-xl md:text-2xl font-bold text-gray-800">Chargement du plan...</h2>
                <button id="close-view-plan-btn" class="btn btn-outline">
                    <i class="fas fa-times mr-2"></i> Fermer et voir mes plans
                </button>
            </div>
            <div class="bg-white rounded-xl shadow-md p-4">
                <div id="meal-plan-grid-layout">
                    <!-- Header -->
                    <div class="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] gap-1 text-center mb-1">
                        <div class="p-2"></div> <!-- Empty corner -->
                        <div class="p-2 rounded-t-lg bg-amber-100 text-amber-800 font-bold col-span-6">MIDI</div>
                        <div class="p-2 rounded-t-lg bg-stone-200 text-stone-800 font-bold col-span-6">SOIR</div>
                        <div class="p-1"></div> <!-- Empty under day name -->
                        <div class="p-1 text-xs font-semibold"><i class="fas fa-users"></i></div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Entr√©e</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Plat</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Accomp.</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Dessert</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Remarque</div>
                        <div class="p-1 text-xs font-semibold"><i class="fas fa-users"></i></div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Entr√©e</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Plat</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Accomp.</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Dessert</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Remarque</div>
                    </div>
                    <!-- Rows generated by JS -->
                    <div id="meal-plan-grid" class="space-y-1">
                        <div class="p-10 text-center text-gray-500 italic col-span-full">Chargement de la planification...</div>
                    </div>
                </div>
            </div>
        </section>
        `,script:"./view-plan.js"},"shopping-mode":{html:`
        <div class="max-w-4xl mx-auto min-h-screen pb-20 md:pb-0 relative px-4">
            <div class="sticky top-0 bg-white z-20 pt-4 pb-3">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center space-x-3">
                        <button id="shopping-mode-back-btn" class="text-gray-600 hover:text-tomato">
                            <i class="fas fa-arrow-left text-xl"></i>
                        </button>
                        <h2 class="text-2xl font-bold text-gray-800">Faire les courses</h2>
                    </div>
                    <button id="shopping-mode-trash-btn" class="text-gray-500 hover:text-gray-700 relative hidden p-2">
                        <i class="fas fa-trash-alt text-lg"></i>
                        <span id="shopping-mode-trash-count" class="absolute top-0 right-0 bg-red-500 text-white text-[10px] px-1 rounded-full">0</span>
                    </button>
                </div>
                <div class="flex justify-start items-center mb-4">
                    <label for="shopping-mode-plan-select" class="text-sm font-medium text-gray-700 mr-2">Plan:</label>
                    <select id="shopping-mode-plan-select" class="text-sm border-gray-300 rounded-md shadow-sm focus:ring-tomato focus:border-tomato font-medium text-gray-700 bg-white pr-8">
                        <option>Chargement...</option>
                    </select>
                </div>
            </div>
            
            <div id="shopping-mode-container" class="p-4 -mt-4">
                <p class="text-center text-gray-500 mt-10">Chargement de la liste...</p>
            </div>

            <!-- Shopping Mode Trash Modal -->
            <div id="shopping-trash-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden" role="dialog">
                <div class="bg-white rounded-xl p-5 w-11/12 max-w-md relative max-h-[80vh] flex flex-col">
                    <button id="close-shopping-trash-modal" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 p-2">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                    <div class="flex justify-between items-center mb-4 pr-8">
                        <h3 class="text-lg font-bold text-gray-800"><i class="fas fa-trash-alt mr-2"></i> Corbeille</h3>
                        <button id="shopping-empty-trash-btn" class="text-sm text-red-500 hover:text-red-700 font-medium hover:underline hidden">
                            Vider
                        </button>
                    </div>
                    <div id="shopping-trash-list" class="flex-grow overflow-y-auto pr-1">
                        <!-- Deleted items will be generated here -->
                    </div>
                </div>
            </div>
        </div>
        `,script:"./shopping-mode.js"}},Wa=Object.assign({"./all-plans.js":Zn,"./auth.js":Gn,"./firebase-config.js":Wn,"./form-handler.js":ea,"./friends.js":ia,"./ingredients.js":la,"./lists.js":ma,"./main.js":Jn,"./notifications.js":ka,"./plans.js":va,"./presence.js":Ba,"./recipes.js":Ma,"./script.js":_a,"./shared.js":ja,"./sharing.js":ca,"./shopping-mode.js":Ua,"./view-plan.js":Va});let xt=null;async function ct(e){typeof xt=="function"&&(xt(),xt=null);const t=Qa[e];if(t&&dn){if(dn.innerHTML=t.html,t.script){const n=Wa[t.script];n?n.default&&typeof n.default=="function"&&(xt=n.default()):console.error(`Module not found for path: ${t.script}`)}}else console.error(`Route not found: ${e}`)}function Ja(){const e=Re();if(e){const n=document.getElementById("user-display-name");n&&(n.textContent=e.displayName||e.email)}const t=document.querySelectorAll(".nav-btn");t.forEach(n=>{n.addEventListener("click",a=>{const r=a.currentTarget.dataset.path;ct(r),t.forEach(i=>{i.classList.remove("bg-tomato","text-white"),i.classList.add("bg-white","text-tomato")}),a.currentTarget.classList.add("bg-tomato","text-white"),a.currentTarget.classList.remove("bg-white","text-tomato")})}),ct("menu"),Nn()}document.addEventListener("DOMContentLoaded",()=>{pn().then(b=>{b&&Ja()});const e=document.getElementById("profile-btn"),t=document.getElementById("profile-menu");e&&t&&(e.addEventListener("click",b=>{b.stopPropagation(),t.classList.toggle("hidden");const B=!t.classList.contains("hidden");e.setAttribute("aria-expanded",B)}),document.addEventListener("click",b=>{!(t.contains(b.target)||e.contains(b.target))&&!t.classList.contains("hidden")&&(t.classList.add("hidden"),e.setAttribute("aria-expanded","false"))}));const n=document.getElementById("settings-link"),a=document.getElementById("settings-modal"),r=document.getElementById("close-settings-modal"),i=document.getElementById("dark-mode-toggle"),c=b=>{b==="dark"?(document.documentElement.classList.add("dark"),i&&(i.checked=!0)):(document.documentElement.classList.remove("dark"),i&&(i.checked=!1))},f=localStorage.getItem("theme");f?c(f):window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?c("dark"):c("light"),n&&a&&n.addEventListener("click",b=>{b.preventDefault(),a.classList.remove("hidden")}),r&&a&&r.addEventListener("click",()=>{a.classList.add("hidden")}),a&&a.addEventListener("click",b=>{b.target===a&&a.classList.add("hidden")}),i&&i.addEventListener("change",()=>{const b=i.checked?"dark":"light";localStorage.setItem("theme",b),c(b)});const g=document.getElementById("mobile-menu-btn"),p=document.getElementById("mobile-menu"),E=document.querySelectorAll(".nav-btn-mobile");g&&p&&g.addEventListener("click",()=>{p.classList.toggle("hidden")});const I=document.getElementById("profile-btn-mobile");I&&a&&I.addEventListener("click",()=>{a.classList.remove("hidden"),p&&p.classList.add("hidden")}),E.forEach(b=>{b.addEventListener("click",B=>{const U=B.currentTarget.dataset.path;ct(U),p&&p.classList.add("hidden")})})});
