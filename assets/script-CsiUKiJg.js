const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/main-CPC2Lv91.js","assets/firebase-config-9gANoKOS.js","assets/firebase-config-DuwEdJQT.css"])))=>i.map(i=>d[i]);
import{e as gt,i as yt,b as ht,s as Ee,h as vt,g as fe,j as Te,_ as He,a as xt,k as Et,p as bt}from"./main-CPC2Lv91.js";import{r as be,l as Ae,m as Lt,n as Ct,p as It,t as wt,v as St,x as Ue,d as k,o as Bt,c as ae,g as ce,b as Q,j as Fe,q as Le,y as Re,w as je,i as Mt,z as kt,A as Oe,s as Dt,f as Nt,u as $t}from"./firebase-config-9gANoKOS.js";import{r as de,t as Pt}from"./recipes-CvIRsqX_.js";import{o as Tt,a as Ht}from"./sharing-JwcufOfh.js";import{ingredientModalManager as At}from"./ingredient-modal-Bs8bmd4e.js";let K=null,se=null;function Ft(i,re){if(!be||!i)return;const Y=gt();if(!Y)return;const D=Ae(be,`plans_presence/${i}`);K=Ae(be,`plans_presence/${i}/${Y.uid}`);const N={displayName:Y.displayName||Y.email,photoURL:Y.photoURL,status:"idle",last_seen:Ue()};Lt(K).remove(),Ct(K,N),se&&se(),se=It(D,v=>{const H=v.val()||{};typeof re=="function"&&re(H)})}function Rt(){K&&(St(K),K=null),se&&(se(),se=null)}function Ce(i){K&&wt(K,{status:i,last_seen:Ue()})}function zt(){const i={mealPlanGrid:document.getElementById("meal-plan-grid"),currentWeekDisplay:document.getElementById("current-week-display"),prevWeekBtn:document.getElementById("prev-week-btn"),nextWeekBtn:document.getElementById("next-week-btn"),clearMenuBtn:document.getElementById("clear-menu-btn"),shoppingListContainer:document.getElementById("shopping-list"),startDaySelect:document.getElementById("start-day-select"),defaultServingsControl:document.getElementById("default-servings-control"),mealSelectModal:document.getElementById("meal-select-modal"),closeMealSelectModalBtn:document.getElementById("close-meal-select-modal"),mealSelectModalTitle:document.getElementById("meal-select-modal-title"),mealSelectList:document.getElementById("meal-select-list"),recipeFormModal:document.getElementById("edit-recipe-form-modal"),closeRecipeModalBtn:document.getElementById("close-edit-recipe-modal"),cancelRecipeBtn:document.getElementById("edit-cancel-recipe-btn"),recipeForm:document.getElementById("edit-recipe-form"),addItemInput:document.getElementById("add-item-input"),addItemBtn:document.getElementById("add-item-btn"),addItemResults:document.getElementById("add-item-results"),importListBtn:document.getElementById("import-list-btn"),importListModal:document.getElementById("import-list-modal"),closeImportListModalBtn:document.getElementById("close-import-list-modal"),importListContainer:document.getElementById("import-list-container"),exportTxtBtn:document.getElementById("export-txt-btn"),exportPdfBtn:document.getElementById("export-pdf-btn"),exportPlanPdfBtn:document.getElementById("export-plan-pdf-btn"),sharePlanBtn:document.getElementById("share-plan-btn"),planSelect:document.getElementById("plan-select"),inviteParticipantBtn:document.getElementById("invite-participant-btn"),historyPlanBtn:document.getElementById("history-plan-btn"),planHistoryModal:document.getElementById("plan-history-modal"),closePlanHistoryModalBtn:document.getElementById("close-plan-history-modal"),planHistoryList:document.getElementById("plan-history-list"),savePlanBtn:document.getElementById("save-plan-btn"),openTrashBtn:document.getElementById("open-trash-btn"),trashCount:document.getElementById("trash-count"),trashModal:document.getElementById("trash-modal"),closeTrashModalBtn:document.getElementById("close-trash-modal"),trashListContainer:document.getElementById("trash-list-container"),emptyTrashBtn:document.getElementById("empty-trash-btn"),smartPlanBtn:document.getElementById("smart-plan-btn"),archivePlanBtn:document.getElementById("archive-plan-btn")};function re(t,a){const n=document.createElement("div");n.className="flex items-center space-x-2";const r=document.createElement("button");r.className="btn btn-outline btn-xs",r.textContent="-";const e=document.createElement("span");e.className="font-medium text-center w-6",e.textContent=t;const o=document.createElement("button");return o.className="btn btn-outline btn-xs",o.textContent="+",r.addEventListener("click",()=>{let l=parseInt(e.textContent,10);l>1&&(l--,e.textContent=l,a(l))}),o.addEventListener("click",()=>{let l=parseInt(e.textContent,10);l++,e.textContent=l,a(l)}),n.appendChild(r),n.appendChild(e),n.appendChild(o),n}function Y(t,a,n,r=!1){const e=document.createElement("div");e.className="flex flex-col items-center justify-center h-full";const o=document.createElement("button");o.className="text-gray-600 hover:bg-gray-100 p-0 h-4 flex items-center justify-center w-full rounded-md",o.innerHTML='<i class="fas fa-plus"></i>',o.disabled=r;const l=document.createElement("span");l.className="font-medium text-center text-sm my-1",l.textContent=t;const s=document.createElement("button");return s.className="text-gray-600 hover:bg-gray-100 p-0 h-4 flex items-center justify-center w-full rounded-md",s.innerHTML='<i class="fas fa-minus"></i>',s.disabled=r,a&&(o.classList.add("text-white"),l.classList.add("text-white"),s.classList.add("text-white")),r||(o.addEventListener("click",()=>{let c=parseInt(l.textContent,10);c++,l.textContent=c,n(c)}),s.addEventListener("click",()=>{let c=parseInt(l.textContent,10);c>1&&(c--,l.textContent=c,n(c))})),e.appendChild(o),e.appendChild(l),e.appendChild(s),e}de.setActivityUpdater(Ce),de.setOnSaveCallback(async()=>{});let D=1,N="Lundi",v={},H={},P={};const _=[];let X=null,z=[],ee=[],R=1,te=null,ge=[],d=null;const U=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];function ue(t){return t?t.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase():""}function qe(t){return t?t.replace(/\./g,"_"):""}async function Ie(){if(k)try{ee=(await ce(ae(k,"ingredients"))).docs.map(a=>({id:a.id,...a.data()})),ee.sort((a,n)=>a.name.localeCompare(n.name))}catch(t){console.error("Erreur lors de la récupération des ingrédients: ",t)}}function we(){if(!d)v={},H={},P={},R=1,N="Lundi";else{const t=d.weeks?d.weeks[D]||{}:{};v=t.menuData||{},H=t.servingsData||{},P=t.remarksData||{},R=d.defaultNumPeople||1,N=d.startDay||"Lundi"}if(i.startDaySelect&&(i.startDaySelect.value=N),i.defaultServingsControl){i.defaultServingsControl.innerHTML="";const t=re(R,async a=>{R=a,d&&await V({defaultNumPeople:a},`a changé le nombre de personnes par défaut à ${a}`)});i.defaultServingsControl.appendChild(t)}dt(),oe(i.mealPlanGrid,{menuData:v,servingsData:H,remarksData:P,defaultNumPeople:R,startDay:N},!1),me(document.getElementById("mobile-meal-plan"),{menuData:v,servingsData:H,remarksData:P,defaultNumPeople:R,startDay:N},!1),ie()}async function V(t,a){if(!d)return;await Te(d.id,d,a);const n=Q(k,"plans",d.id);try{await $t(n,{...t,lastUpdated:new Date})}catch(r){console.error("Error updating plan:",r),alert("Une erreur de sauvegarde est survenue.")}}function ye(){i.planHistoryModal.classList.add("hidden")}async function _e(t){if(d&&confirm("Voulez-vous vraiment restaurer cette version ? L'état actuel sera sauvegardé dans l'historique avant la restauration."))try{const a=Q(k,"plans",d.id,"history",t),n=await Fe(a);if(!n.exists())throw new Error("Version de l'historique non trouvée.");const r=n.data().planState;await Te(d.id,d);const e=Q(k,"plans",d.id);await Dt(e,r),ye()}catch(a){console.error("Erreur lors du rollback :",a)}}async function ze(t,a){if(d&&confirm("Êtes-vous sûr de vouloir supprimer définitivement cette entrée de l'historique ?"))try{const n=Q(k,"plans",d.id,"history",t);await Nt(n),a.remove()}catch(n){console.error("Erreur lors de la suppression de l'historique :",n),alert("Une erreur est survenue lors de la suppression.")}}async function Ve(){if(d){i.planHistoryList.innerHTML="<p>Chargement de l'historique...</p>",i.planHistoryModal.classList.remove("hidden");try{const t=ae(k,"plans",d.id,"history"),a=Le(t,Re("timestamp","desc")),n=await ce(a);if(i.planHistoryList.innerHTML="",n.empty){i.planHistoryList.innerHTML="<p>Aucun historique pour ce plan.</p>";return}n.forEach(r=>{const e=r.data(),o=document.createElement("div");o.className="p-3 border-b flex justify-between items-center";const l=document.createElement("div"),s=e.timestamp?.toDate().toLocaleString("fr-FR")||"Date inconnue",c=e.description||"Modification diverse",u=e.modifiedByName||"Inconnu";l.innerHTML=`
                    <p class="font-medium">${u} ${c}</p>
                    <p class="text-sm text-gray-500">${s}</p>
                `;const m=document.createElement("div");m.className="flex items-center space-x-2";const p=document.createElement("button");p.className="btn btn-secondary btn-sm",p.textContent="Revenir à cette version",p.addEventListener("click",()=>_e(r.id));const f=document.createElement("button");f.className="text-red-500 hover:bg-red-100 text-sm px-3 py-1 rounded-md",f.innerHTML='<i class="fas fa-times"></i>',f.title="Supprimer cette version",f.addEventListener("click",g=>{g.stopPropagation(),ze(r.id,o)}),m.appendChild(p),m.appendChild(f),o.appendChild(l),o.appendChild(m),i.planHistoryList.appendChild(o)})}catch(t){console.error("Erreur de chargement de l'historique:",t),i.planHistoryList.innerHTML=`<p class="text-red-500">Impossible de charger l'historique.</p>`}}}async function Qe(){if(!d)return alert("Veuillez d'abord sélectionner un menu.");if(Object.keys(v).length>0){if(confirm(`Un menu existe déjà. Voulez-vous créer un NOUVEAU menu pour cette suggestion ?
(OK = Nouveau menu, Annuler = Écraser l'actuel)`)){const n=prompt("Nom du nouveau menu :",`Menu Intelligent - ${new Date().toLocaleDateString("fr-FR")}`);if(!n)return;i.smartPlanBtn.disabled=!0,i.smartPlanBtn.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i> Création du menu...';const r=await vt(n);if(!r){i.smartPlanBtn.disabled=!1,i.smartPlanBtn.innerHTML='<i class="fas fa-magic mr-1 md:mr-2"></i> Menu Intelligent';return}const e={id:r,name:n,userId:fe(),weeks:{},isOwner:!0};ge.push(e),i.planSelect.value=r,xe()}else if(!confirm("Voulez-vous vraiment ÉCRASER le menu actuel ?"))return}i.smartPlanBtn.disabled=!0;const t=i.smartPlanBtn.innerHTML;i.smartPlanBtn.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i> Chef Gusto réfléchit...';try{const n=(await ce(ae(k,"recipes"))).docs.map(g=>({id:g.id,...g.data()})),r=fe(),e=await ce(Le(ae(k,"plans"),je("userId","==",r),Re("lastUpdated","desc"))),o=[];e.docs.slice(0,3).forEach(g=>{const y=g.data();y.weeks&&Object.values(y.weeks).forEach(x=>{x.menuData&&Object.values(x.menuData).forEach(h=>{h.MIDI&&o.push(h.MIDI),h.SOIR&&o.push(h.SOIR)})})});const s=await Mt(kt,"suggestMenu")({recipes:n,history:[...new Set(o)],season:Ee.getCurrentSeason()}),c=s.data.menu,u=s.data.description,m={Lundi:0,Mardi:1,Mercredi:2,Jeudi:3,Vendredi:4,Samedi:5,Dimanche:6},p=JSON.parse(JSON.stringify(v));for(const[g,y]of Object.entries(c)){const x=m[g];if(x===void 0)continue;const h=(E,w)=>{const C=`${x}-${w==="MIDI"?"lunch":"dinner"}-1`;if(E){const B=n.find(A=>A.name===E);B?p[C]=[{id:B.id}]:console.warn(`Recipe not found for Smart Plan: ${E}`)}else delete p[C]};h(y.MIDI,"MIDI"),h(y.SOIR,"SOIR")}await V({[`weeks.${D}.menuData`]:p},u||"Génération Smart Plan par l'IA"),v=p,oe(i.mealPlanGrid,{menuData:v,servingsData:H,remarksData:P,defaultNumPeople:R,startDay:N},!1);const f=document.getElementById("mobile-meal-plan");f&&me(f,{menuData:v,servingsData:H,remarksData:P,defaultNumPeople:R,startDay:N},!1),ie(),alert(u||"Menu généré avec succès !")}catch(a){console.error("Smart Plan error:",a),alert("Erreur lors de la génération : "+a.message)}finally{i.smartPlanBtn.disabled=!1,i.smartPlanBtn.innerHTML=t}}async function Ge(){if(!d){alert("Veuillez d'abord sélectionner un plan.");return}if(confirm(`Voulez-vous vraiment vider le menu de la semaine ${D} pour le plan "${d.name}" ?`)){v={},H={},P={},oe(i.mealPlanGrid,{menuData:v,servingsData:H,remarksData:P,defaultNumPeople:R,startDay:N},!1);const t=document.getElementById("mobile-meal-plan");t&&me(t,{menuData:v,servingsData:H,remarksData:P,defaultNumPeople:R,startDay:N},!1),await V({[`weeks.${D}.menuData`]:{},[`weeks.${D}.servingsData`]:{},[`weeks.${D}.remarksData`]:{}},"a vidé le menu de la semaine"),ie()}}function me(t,a,n=!1){if(!t)return;const r=a.menuData||{},e=a.servingsData||{},o=a.remarksData||{},l=a.defaultNumPeople||1,s=a.startDay||"Lundi";t.innerHTML="";const c=document.createDocumentFragment(),u=U.indexOf(s);[...U.slice(u),...U.slice(0,u)].forEach(p=>{const f=U.indexOf(p),g=document.createElement("div");g.className="bg-blue-100 border border-blue-300 rounded-xl shadow-md p-4 mb-4";const y=document.createElement("h3");y.className="text-xl font-bold text-gray-800 dark:text-gray-800 mb-3",y.textContent=p.toUpperCase(),g.appendChild(y);const x=document.createElement("div");x.className="space-y-4",["lunch","dinner"].forEach(h=>{const E=document.createElement("div");E.className=`border-t pt-3 ${h==="lunch"?"bg-amber-50":"bg-stone-100"} rounded-lg p-2`;const w=document.createElement("div");w.className="flex justify-between items-center mb-2";const C=document.createElement("h4");if(C.className="text-lg font-semibold text-tomato",C.textContent=h==="lunch"?"Midi":"Soir",w.appendChild(C),!n){const S=`${f}-${h}`,I=e[S]||l,b=re(I,L=>{Pe(S,L)});w.appendChild(b)}E.appendChild(w);const B=document.createElement("div");B.className="space-y-2";let A=!1;const $=["Entrée","Plat","Accompagnement","Dessert","Remarque"];for(let S=0;S<$.length;S++){const I=$[S],b=`${f}-${h}-${S}`,L=r[b],T=document.createElement("div");T.className="mb-2";const j=document.createElement("h5");if(j.className="text-md font-semibold text-gray-700 mb-1",j.textContent=I,T.appendChild(j),I==="Remarque")T.appendChild(Ne(b,o,n));else{const M=document.createElement("div");if(M.className="space-y-1",Array.isArray(L)&&L.length>0&&(A=!0,L.forEach((F,G)=>{const J=z.find(O=>O.id===F.id);if(J){const O=ke(J,b,G,n);if(O.classList.remove("bg-white","shadow-sm"),O.classList.add("bg-emerald-200","border","border-emerald-400"),!n){const q=O.querySelector(".edit-meal-btn"),ne=O.querySelector(".delete-meal-btn");q&&q.classList.remove("hidden"),ne&&ne.classList.remove("hidden")}M.appendChild(O)}})),n)A||(M.innerHTML='<p class="text-sm text-gray-500 italic">Aucun plat prévu.</p>');else{const F=document.createElement("button");F.className="btn btn-outline btn-sm w-full mt-2",F.innerHTML=`<i class="fas fa-plus mr-2"></i> Ajouter une ${I.toLowerCase()}`,F.addEventListener("click",()=>{Me(b)}),M.appendChild(F)}T.appendChild(M)}B.appendChild(T)}E.appendChild(B),x.appendChild(E)}),g.appendChild(x),c.appendChild(g)}),t.appendChild(c)}function oe(t,a,n=!1){if(!t)return;const r=a.menuData||{},e=a.servingsData||{},o=a.remarksData||{},l=a.defaultNumPeople||1,s=a.startDay||"Lundi",c=document.createDocumentFragment(),u=["lunch","dinner"],m=5,p=U.indexOf(s);[...U.slice(p),...U.slice(0,p)].forEach(g=>{const y=U.indexOf(g),x=document.createElement("div");x.className="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] items-stretch border-b border-gray-300";const h=document.createElement("div");h.className="font-bold p-2 flex items-center justify-center bg-gray-100 dark:bg-gray-100 text-sm border-r border-gray-300 text-gray-800 dark:text-gray-800",h.textContent=g.toUpperCase(),x.appendChild(h),u.forEach(E=>{const w=`${y}-${E}`,C=e[w]||l,B=e.hasOwnProperty(w),A=document.createElement("div"),$=Y(C,B,I=>{Pe(w,I)},n);let S="border-r border-gray-300 flex items-center justify-center transition-colors duration-300";B?S+=" bg-tomato":S+=E==="lunch"?" bg-amber-50":" bg-stone-100",A.className=S,A.appendChild($),x.appendChild(A);for(let I=0;I<m;I++){const b=`${y}-${E}-${I}`,L=r[b],T=document.createElement("div"),j=le(b);let M="meal-slot p-1 min-h-[70px] flex flex-col justify-start border-r border-gray-300";if(M+=E==="lunch"?" bg-amber-50":" bg-stone-100",T.className=M,T.dataset.slotId=b,j==="Remarque")T.appendChild(Ne(b,o,n));else if(Array.isArray(L)&&L.length>0){const F=document.createElement("div");F.className="w-full",L.forEach((G,J)=>{const O=z.find(q=>q.id===G.id);if(O)F.appendChild(ke(O,b,J,n));else{const q=document.createElement("div");q.className="p-1 bg-red-100 text-red-700 rounded shadow-sm text-center text-xs font-medium",q.textContent="Recette supprimée",F.appendChild(q)}}),T.appendChild(F),n||T.appendChild(De(b,!0))}else n||T.appendChild(De(b,!1));x.appendChild(T)}}),c.appendChild(x)}),t.innerHTML="",t.appendChild(c),n||it()}async function Je(){const t=fe();if(!k||!t)return[];try{const a=Le(ae(k,"shopping_lists"),je("userId","==",t));return(await ce(a)).docs.map(o=>({id:o.id,...o.data()})).filter(o=>o.isShared!==!0)}catch(a){return console.error("Erreur de chargement des listes de courses sauvegardées: ",a),[]}}async function We(){const t=await Je();if(i.importListContainer.innerHTML="",t.length===0){i.importListContainer.innerHTML='<p class="text-center text-gray-500">Aucune liste sauvegardée.</p>';return}t.forEach(a=>{const n=document.createElement("button");n.className="w-full text-left p-2 hover:bg-gray-100 rounded-lg transition-colors duration-150",n.textContent=a.name,n.addEventListener("click",()=>{confirm(`Voulez-vous vraiment importer les ingrédients de la liste "${a.name}" ?`)&&(a.ingredients.forEach(r=>{const e=parseFloat(String(r.quantity).replace(",","."))||0;Z(r.name,e,r.unit)}),he())}),i.importListContainer.appendChild(n)}),i.importListModal.classList.remove("hidden")}function he(){i.importListModal.classList.add("hidden")}function Ke(){i.addItemInput?.addEventListener("input",()=>{const t=i.addItemInput.value.toLowerCase(),a=i.addItemResults;if(a.innerHTML="",!t){a.classList.add("hidden");return}let n=ee.filter(e=>e.name.toLowerCase().includes(t));n.forEach(e=>e.seasonScore=Ee.getIngredientScore(e)),n.sort((e,o)=>o.seasonScore!==e.seasonScore?o.seasonScore-e.seasonScore:e.name.localeCompare(o.name)),n.forEach(e=>{const o=document.createElement("div");o.className="p-2 hover:bg-gray-100 cursor-pointer flex justify-between items-center";const l=document.createElement("span");if(l.textContent=e.name,o.appendChild(l),Ee.config.mode!=="disabled"){if(e.seasonScore===2){const s=document.createElement("span");s.className="text-[10px] bg-green-100 text-green-700 px-1.5 py-0.5 rounded-full border border-green-200 ml-2 whitespace-nowrap",s.textContent="De saison",o.appendChild(s)}else if(e.seasonScore===0){const s=document.createElement("span");s.className="text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded-full border border-gray-200 ml-2 whitespace-nowrap",s.textContent="Hors saison",o.appendChild(s),o.classList.add("opacity-75")}}o.addEventListener("click",()=>{Z(e.name,1,e.unit),i.addItemInput.value="",a.classList.add("hidden")}),a.appendChild(o)});const r=document.createElement("div");r.className="p-2 bg-green-50 hover:bg-green-200 cursor-pointer font-bold text-green-700",r.textContent=`+ Créer "${i.addItemInput.value}"`,r.addEventListener("click",()=>{const e=i.addItemInput.value;At.open(e,async()=>{await Ie();const o=ee.find(s=>s.name===e),l=o?o.unit:"";Z(e,1,l),i.addItemInput.value="",a.classList.add("hidden")})}),a.appendChild(r),a.classList.remove("hidden")}),i.addItemBtn?.addEventListener("click",()=>{const t=i.addItemInput.value;t&&(Z(t,1,""),i.addItemInput.value="",i.addItemResults.classList.add("hidden"))}),document.addEventListener("click",t=>{i.addItemInput&&!i.addItemInput.contains(t.target)&&!i.addItemResults.contains(t.target)&&i.addItemResults.classList.add("hidden")})}function Ye(){if(_.length===0){alert("La liste de courses est vide.");return}const t=_.reduce((e,o)=>{const l=o.category||"Inconnue";return e[l]||(e[l]=[]),e[l].push(o),e},{}),a=Object.keys(t).sort((e,o)=>e==="Inconnue"?1:o==="Inconnue"?-1:e.localeCompare(o));let n=`Liste de courses - GustoPlan

`;a.forEach(e=>{n+=`--- ${e.toUpperCase()} ---
`,t[e].sort((l,s)=>l.name.localeCompare(s.name)).forEach(l=>{let c=`${Number.isInteger(l.totalQuantity)?l.totalQuantity:parseFloat(l.totalQuantity.toFixed(2))} ${l.unit||""} ${l.name}`;if(l.sources&&l.sources.length>0){const u=l.sources.reduce((p,f)=>{const g=f.servings?` - ${f.servings} pers.`:"",y=`${f.recipeName} (${f.day} ${f.time})${g}`;return p[y]||(p[y]=0),p[y]+=f.quantity,p},{}),m=Object.keys(u).join(" / ");c+=` *** ${m} ***`}n+=c+`
`}),n+=`
`});const r=new Blob([n],{type:"text/plain;charset=utf-8"});saveAs(r,"liste-de-courses.txt")}function Xe(){if(_.length===0){alert("La liste de courses est vide.");return}const{jsPDF:t}=window.jspdf,a=new t,n=_.reduce((c,u)=>{const m=u.category||"Inconnue";return c[m]||(c[m]=[]),c[m].push(u),c},{}),r=Object.keys(n).sort((c,u)=>c==="Inconnue"?1:u==="Inconnue"?-1:c.localeCompare(u));a.setFontSize(18),a.text("Liste de courses - GustoPlan",14,22);let e=35;const o=a.internal.pageSize.height,l=20,s=()=>{e>o-l&&(a.addPage(),e=20)};r.forEach(c=>{s(),a.setFontSize(14),a.setFont(void 0,"bold"),a.text(`--- ${c.toUpperCase()} ---`,14,e),e+=8,a.setFont(void 0,"normal"),n[c].sort((m,p)=>m.name.localeCompare(p.name)).forEach(m=>{s(),a.setFontSize(12);const p=Number.isInteger(m.totalQuantity)?m.totalQuantity:parseFloat(m.totalQuantity.toFixed(2));if(a.text(`${p} ${m.unit||""} ${m.name}`,14,e),e+=6,m.sources&&m.sources.length>0){const f=m.sources.reduce((g,y)=>{const x=y.servings?` - ${y.servings} pers.`:"",h=`${y.recipeName} (${y.day} ${y.time})${x}`;return g[h]||(g[h]=0),g[h]+=y.quantity,g},{});a.setFontSize(9),a.setTextColor(100);for(const g in f)s(),a.text(`  * ${g}`,18,e),e+=5;a.setTextColor(0)}e+=2}),e+=5}),a.save("liste-de-courses.pdf")}async function Ze(){if(!d){alert("Veuillez sélectionner un menu à exporter.");return}const t=document.getElementById("loading-overlay");t&&t.classList.remove("hidden");try{const{jsPDF:a}=window.jspdf,n=new a,r=Q(k,"plans",d.id),e=await Fe(r),o=e.exists()?e.data():null;if(!o||!o.weeks){alert("Ce menu est vide et ne peut pas être exporté.");return}n.setFontSize(18),n.text(`Menu de Repas : ${o.name}`,14,20);const l=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"],s={0:"E",1:"P",2:"A",3:"D"},c=Object.keys(o.weeks).sort((m,p)=>parseInt(m)-parseInt(p));let u=!0;for(const m of c){const f=o.weeks[m].menuData||{};if(Object.keys(f).length===0)continue;const g=[["Jour","Midi","Soir"]],y=[],x=l.indexOf(o.startDay||"Lundi"),h=[...l.slice(x),...l.slice(0,x)];for(const w of h){const C=l.indexOf(w);let B=[],A=[];for(const $ of["lunch","dinner"])for(const S in s){const I=`${C}-${$}-${S}`;f[I]&&Array.isArray(f[I])&&f[I].forEach(b=>{const L=`[${s[S]}] ${b.name}`;$==="lunch"?B.push(L):A.push(L)})}y.push([w,B.join(`
`)||"-",A.join(`
`)||"-"])}n.setFontSize(14);const E=u?30:n.autoTable.previous.finalY+20;n.text(`Semaine ${m}`,14,E-5),n.autoTable({startY:E,head:g,body:y,theme:"grid",styles:{cellPadding:2,fontSize:8,valign:"middle"},headStyles:{fillColor:[41,128,185],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[245,245,245]}}),u=!1}n.save(`menu_${o.name.replace(/ /g,"_")}.pdf`)}catch(a){console.error("Erreur lors de la génération du PDF du plan :",a),alert("Une erreur est survenue lors de la création du PDF.")}finally{t&&t.classList.add("hidden")}}async function Z(t,a,n,r=!1){if(!d)return alert("Veuillez sélectionner un menu.");const e=Q(k,"plans",d.id);try{await Oe(k,async o=>{const l=await o.get(e);if(!l.exists())throw"Le menu n'existe plus.";const s=l.data().manualItems||[],c=`${t.trim().toLowerCase()}_${n||""}`,u=s.findIndex(p=>`${p.name.trim().toLowerCase()}_${p.unit||""}`===c);if(u>-1)s[u].totalQuantity+=a;else{const p=ee.find(f=>f.name.toLowerCase()===t.trim().toLowerCase());s.push({name:t.trim(),totalQuantity:a,unit:n,source:"manual",category:p?.category||"Inconnue"})}const m=s;o.update(e,{manualItems:m,lastUpdated:new Date})})}catch(o){console.error("Erreur transactionnelle lors de l'ajustement de l'ingrédient: ",o),alert("Une erreur de synchronisation est survenue. Veuillez réessayer.")}}function Se(t){const a=t?t.toLowerCase():"";return a.includes("g")||a.includes("ml")?10:1}function et(t){if(i.openTrashBtn&&(i.openTrashBtn.classList.remove("hidden"),i.trashCount&&(i.trashCount.textContent=t.length,t.length>0?(i.trashCount.classList.remove("bg-gray-200"),i.trashCount.classList.add("bg-red-500","text-white")):(i.trashCount.classList.add("bg-gray-200"),i.trashCount.classList.remove("bg-red-500","text-white")))),t&&t.length>0){if(i.emptyTrashBtn){i.emptyTrashBtn.classList.remove("hidden");const a=i.emptyTrashBtn.cloneNode(!0);i.emptyTrashBtn.parentNode.replaceChild(a,i.emptyTrashBtn),i.emptyTrashBtn=a,i.emptyTrashBtn.addEventListener("click",async()=>{if(!d||!confirm("Voulez-vous supprimer définitivement tous les éléments de la corbeille ?"))return;const n=Q(k,"plans",d.id),r=t.map(e=>`${e.name}_${e.unit||""}`);try{await He(()=>import("./main-CPC2Lv91.js").then(e=>e.l),__vite__mapDeps([0,1,2])).then(e=>{e.updateDoc(n,{hiddenTrashItems:e.arrayUnion(...r),lastUpdated:new Date})}),i.trashModal.classList.add("hidden"),i.trashModal.style.display=""}catch(e){console.error("Erreur vidage corbeille:",e)}})}if(i.trashListContainer){i.trashListContainer.innerHTML="";const a=document.createElement("ul");a.className="space-y-2",t.forEach(n=>{const r=document.createElement("li");r.className="p-2 rounded bg-gray-100 flex justify-between items-center group";const e=document.createElement("span");e.className="text-sm text-gray-500 line-through",e.textContent=n.name,r.appendChild(e);const o=document.createElement("div");o.className="flex items-center space-x-2";const l=document.createElement("button");l.className="btn btn-xs btn-outline text-blue-600 hover:bg-blue-50 border-blue-300",l.innerHTML='<i class="fas fa-undo mr-1"></i> Restaurer',l.addEventListener("click",async()=>{if(!d)return;const c=Q(k,"plans",d.id);try{await Oe(k,async u=>{const m=await u.get(c);if(!m.exists())return;const p=m.data().manualItems||[],f=p.findIndex(g=>g.name.toLowerCase()===n.name.toLowerCase()&&g.unit===n.unit);f>-1&&(n.source==="manual"?p[f].totalQuantity=1:p.splice(f,1)),u.update(c,{manualItems:p,lastUpdated:new Date})}),t.length<=1&&(i.trashModal.classList.add("hidden"),i.trashModal.style.display="")}catch(u){console.error("Erreur lors de la restauration :",u)}});const s=document.createElement("button");s.className="text-gray-400 hover:text-red-600 text-xs p-1 rounded-md",s.title="Supprimer définitivement",s.innerHTML='<i class="fas fa-times"></i>',s.addEventListener("click",async()=>{if(!d)return;const c=Q(k,"plans",d.id),u=`${n.name}_${n.unit||""}`;try{await He(()=>import("./main-CPC2Lv91.js").then(m=>m.l),__vite__mapDeps([0,1,2])).then(m=>{m.updateDoc(c,{hiddenTrashItems:m.arrayUnion(u),lastUpdated:new Date})}),t.length<=1&&(i.trashModal.classList.add("hidden"),i.trashModal.style.display="")}catch(m){console.error("Erreur suppression définitive:",m)}}),o.appendChild(l),o.appendChild(s),r.appendChild(o),a.appendChild(r)}),i.trashListContainer.appendChild(a)}}else i.trashListContainer&&(i.trashListContainer.innerHTML='<p class="text-center text-gray-500 italic py-4">La corbeille est vide.</p>'),i.emptyTrashBtn&&i.emptyTrashBtn.classList.add("hidden")}function Be(t=[]){et(t);const a=i.shoppingListContainer;if(!a)return;if(a.innerHTML="",_.length===0&&t.length===0){a.innerHTML='<p class="text-center text-gray-500 italic py-4">Votre liste de courses est vide.</p>';return}const n=d?d.checkedItems||{}:{},r=_.reduce((o,l)=>{const s=l.category||"Inconnue";return o[s]||(o[s]=[]),o[s].push(l),o},{});Object.keys(r).sort((o,l)=>o==="Inconnue"?1:l==="Inconnue"?-1:o.localeCompare(l)).forEach(o=>{const l=document.createElement("h4");l.className="text-sm font-bold text-stone-800 bg-stone-200 mt-4 mb-2 px-3 py-1 rounded-md",l.textContent=o,a.appendChild(l);const s=document.createElement("ul");s.className="space-y-2",r[o].sort((u,m)=>u.name.localeCompare(m.name)).forEach(u=>{const m=`${u.name}_${u.unit||""}`,p=qe(m),f=n.hasOwnProperty(p)?n[p]:n[m]||!1,g=document.createElement("li");let y="p-2 rounded";u.hasManualEntry===!0||u.source==="manual"?(g.style.backgroundColor="#ffedd5",y+=" bg-orange-100"):y+=" bg-gray-50",g.className=y;const h=document.createElement("div");h.className="flex justify-between items-center";const E=document.createElement("div");if(E.className="flex-grow flex items-center",f){const L=document.createElement("i");L.className="fas fa-check mr-2 bg-green-500 text-white rounded-full p-1 flex items-center justify-center w-5 h-5",E.appendChild(L)}const w=document.createElement("span");w.className="text-sm font-medium transition-all duration-200",f&&w.classList.add("line-through","text-gray-400"),w.textContent=u.name,E.appendChild(w),h.appendChild(E);const C=document.createElement("div");C.className="flex items-center space-x-2 mx-2";const B=document.createElement("span");B.className="font-medium w-20 text-center text-sm",f&&B.classList.add("text-gray-400");const A=Number.isInteger(u.totalQuantity)?u.totalQuantity:parseFloat(u.totalQuantity.toFixed(2));B.textContent=`${A} ${u.unit||""}`.trim();const $=document.createElement("div");$.className="flex flex-col";const S=document.createElement("button");S.className="btn btn-outline btn-xs rounded-b-none",S.textContent="+",S.addEventListener("click",async()=>{const L=Se(u.unit);await Z(u.name,L,u.unit)});const I=document.createElement("button");I.className="btn btn-outline btn-xs rounded-t-none -mt-px",I.textContent="-",I.addEventListener("click",async()=>{const L=Se(u.unit);await Z(u.name,-L,u.unit)}),$.appendChild(S),$.appendChild(I),C.appendChild(B),C.appendChild($),h.appendChild(C);const b=document.createElement("button");if(b.className="delete-item-btn text-red-500 hover:text-red-700",b.innerHTML='<i class="fas fa-trash-alt"></i>',b.addEventListener("click",()=>{Z(u.name,-u.totalQuantity,u.unit,!0)}),h.appendChild(b),g.appendChild(h),u.sources&&u.sources.length>0){const L=document.createElement("div");L.className="p-2 mt-1 ml-4 rounded-md bg-stone-100";const T=u.sources.reduce((j,M)=>{const F=M.servings?` - ${M.servings} pers.`:"",G=`${M.recipeName} (${M.day} ${M.time})${F}`;return j[G]||(j[G]=0),j[G]+=M.quantity,j},{});for(const j in T){const M=document.createElement("span");M.className="block text-xs text-gray-500",M.textContent=`↳ ${j}`,L.appendChild(M)}g.appendChild(L)}s.appendChild(g)}),a.appendChild(s)})}async function ie(){if(!d){_.length=0,Be();return}const t=d.manualItems?JSON.parse(JSON.stringify(d.manualItems)):[],a=new Map(t.map(s=>{const c=`${s.name.trim().toLowerCase()}_${s.unit||""}`;return s.hasManualEntry=!0,[c,s]})),n=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];if(d.weeks)for(const s in d.weeks){const c=d.weeks[s],u=c.menuData||{},m=c.servingsData||{};for(const p in u){const f=u[p];if(!Array.isArray(f))continue;const[g,y]=p.split("-"),x=parseInt(g,10),h=n[x]||"Jour inconnu",E=y==="lunch"?"midi":"soir",w=`${x}-${y}`,C=parseInt(m[w]||d.defaultNumPeople,10);for(const B of f){const $=z.find(I=>I.id===B.id)||B;if(!$||!Array.isArray($.ingredients))continue;const S=$.servings||1;S<=0||$.ingredients.forEach(I=>{const{name:b,quantity:L,unit:T}=I;if(!b||!L)return;const j=ee.find(W=>W.name.toLowerCase()===b.trim().toLowerCase()),M=j?j.category:"Inconnue",F=parseFloat(String(L).replace(",","."));if(isNaN(F))return;const J=F/S*C,O=T||"",q=`${b.trim().toLowerCase()}_${O}`,ne={recipeName:$.name,day:`${h} (S${s})`,time:E,quantity:J,servings:C};if(a.has(q)){const W=a.get(q);W.totalQuantity+=J,W.source==="manual"&&(W.source="mixed"),Array.isArray(W.sources)?W.sources.push(ne):W.sources=[ne]}else a.set(q,{name:b.trim(),totalQuantity:J,unit:O,source:"plan",category:M,sources:[ne]})})}}}const r=Array.from(a.values()),e=d.hiddenTrashItems||[],o=r.filter(s=>s.totalQuantity>0).sort((s,c)=>s.name.localeCompare(c.name)),l=r.filter(s=>{const c=`${s.name}_${s.unit||""}`;return s.totalQuantity<=0&&(s.source==="manual"||s.sources&&s.sources.length>0)&&!e.includes(c)}).sort((s,c)=>s.name.localeCompare(c.name));_.length=0,_.push(...o),Be(l)}function Me(t){const a=le(t);if(!a||!i.mealSelectModal)return;i.mealSelectModalTitle.textContent=`Sélectionner : ${a}`,i.mealSelectList.innerHTML="";const n=document.createElement("input");n.type="text",n.placeholder="Rechercher dans la catégorie...",n.className="w-full p-2 mb-4 border border-gray-300 rounded-lg",i.mealSelectList.appendChild(n);const r=ue(a),e=z.filter(s=>ue(s.category)===r).sort((s,c)=>{const u=s.isFavorite?1:0,m=c.isFavorite?1:0;return m!==u?m-u:s.name.localeCompare(c.name)}),o=document.createElement("div");o.className="space-y-1 max-h-80 overflow-y-auto",i.mealSelectList.appendChild(o);function l(s=""){o.innerHTML="";const c=s.toLowerCase(),u=e.filter(m=>m.name.toLowerCase().includes(c));u.length===0?o.innerHTML='<p class="text-gray-500 p-4">Aucun plat ne correspond à votre recherche.</p>':u.forEach(m=>{const p=document.createElement("button");p.className="w-full text-left p-2 hover:bg-gray-100 rounded-lg transition-colors duration-150";const f=document.createElement("p");f.className="font-medium text-gray-800 text-sm",m.isFavorite?f.innerHTML=`${m.name} <i class="fas fa-heart text-red-500 ml-2"></i>`:f.textContent=m.name,p.appendChild(f),p.addEventListener("click",()=>{lt(t,m),pe()}),o.appendChild(p)})}n.addEventListener("input",s=>l(s.target.value)),l(),i.mealSelectModal.classList.remove("hidden"),n.focus()}function pe(){i.mealSelectModal&&i.mealSelectModal.classList.add("hidden")}function tt(t){X=t.target.closest(".meal-card");const a=X.closest(".meal-slot").dataset.slotId;t.dataTransfer.setData("text/plain",a),setTimeout(()=>{X&&(X.style.opacity="0.5")},0)}function nt(){X&&(X.style.opacity="1",X=null)}function at(t){t.preventDefault();const a=t.target.closest(".meal-slot");a&&le(a.dataset.slotId)!=="Remarque"&&a.classList.add("bg-gray-200")}function st(t){const a=t.target.closest(".meal-slot");a&&a.classList.remove("bg-gray-200")}async function rt(t){t.preventDefault();const a=t.dataTransfer.getData("text/plain"),n=t.target.closest(".meal-slot");if(n){n.classList.remove("bg-gray-200");const r=n.dataset.slotId,e=le(r);if(e==="Remarque")return;if(a&&r&&a!==r){const o=v[a],l=le(a);if(ue(l)!==ue(e)){alert(`Action impossible : un(e) "${l}" ne peut pas aller dans la catégorie "${e}".`);return}const s=v[r];v[r]=o,s?v[a]=s:delete v[a],oe(i.mealPlanGrid,{menuData:v,servingsData:H,remarksData:P,defaultNumPeople:R,startDay:N},!1),await V({[`weeks.${D}.menuData`]:v},"a déplacé un plat"),await ie()}}}function le(t){switch(t.split("-")[2]){case"0":return"Entrée";case"1":return"Plat";case"2":return"Accompagnement";case"3":return"Dessert";case"4":return"Remarque";default:return""}}function ke(t,a,n,r=!1){const e=document.createElement("div");if(e.className="meal-card p-1 flex flex-col items-center bg-white rounded shadow-sm text-center relative w-full mb-1",r||(e.classList.add("cursor-grab"),e.draggable=!0),!r){const c=document.createElement("button");c.className="absolute -top-2 -right-1 text-base",c.innerHTML='<i class="fas fa-heart"></i>',t.isFavorite?c.classList.add("text-red-500"):c.classList.add("text-gray-300","hover:text-red-400"),c.addEventListener("click",u=>{u.stopPropagation(),Pt(t.id,t.isFavorite)}),c.addEventListener("mousedown",u=>u.stopPropagation()),e.appendChild(c)}const o=document.createElement("span");if(o.className="text-xs font-medium p-1 break-words w-full text-gray-800 dark:text-gray-800",o.textContent=t.name,e.appendChild(o),!r){const c=document.createElement("div");c.className="absolute top-0 left-0 flex";const u=document.createElement("button");u.className="edit-meal-btn text-gray-600 hover:text-gray-800 hidden px-1 py-0.5",u.innerHTML='<i class="fas fa-pencil-alt fa-xs"></i>',u.title="Modifier la recette",u.addEventListener("click",p=>{p.stopPropagation();const f=z.find(g=>g.id===t.id);de.openForm(f||t,"Modifier la recette")}),u.addEventListener("mousedown",p=>p.stopPropagation()),c.appendChild(u);const m=document.createElement("button");m.className="delete-meal-btn text-red-700 hover:text-red-900 hidden px-1 py-0.5",m.innerHTML='<i class="fas fa-times-circle fa-xs"></i>',m.title="Retirer du menu",m.addEventListener("click",p=>{p.stopPropagation(),ct(a,n)}),m.addEventListener("mousedown",p=>p.stopPropagation()),c.appendChild(m),e.appendChild(c),e.addEventListener("mouseenter",()=>{u.classList.remove("hidden"),m.classList.remove("hidden")}),e.addEventListener("mouseleave",()=>{u.classList.add("hidden"),m.classList.add("hidden")})}const l=document.createElement("div");l.className="absolute bottom-1 right-1";const s=document.createElement("button");return s.className="info-meal-btn bg-gray-500 text-white hover:bg-gray-600 rounded w-3 h-3 flex items-center justify-center shadow-sm",s.innerHTML='<i class="fas fa-plus fa-xs"></i>',s.title="Plus d'infos",s.dataset.slotId=a,s.dataset.mealIndex=n,s.addEventListener("mousedown",c=>c.stopPropagation()),l.appendChild(s),e.appendChild(l),e}function ot(t,a){if(document.querySelectorAll(".planner-ingredient-tooltip").forEach(l=>l.remove()),te===t){t.classList.remove("info-open"),t.innerHTML='<i class="fas fa-plus fa-xs"></i>',te=null;return}te&&(te.classList.remove("info-open"),te.innerHTML='<i class="fas fa-plus fa-xs"></i>'),t.classList.add("info-open"),t.innerHTML='<i class="fas fa-times fa-xs"></i>',te=t;const n=document.createElement("div");if(n.className="planner-ingredient-tooltip z-50 w-64 p-3 bg-white border border-gray-200 rounded-lg shadow-lg text-left text-sm",a.ingredients&&a.ingredients.length>0){if(a.servings&&a.servings>0){const c=document.createElement("p");c.className="mb-2 text-sm text-gray-600 flex items-center",c.innerHTML=`<i class="fas fa-users mr-2"></i> Pour ${a.servings} ${a.servings>1?"personnes":"personne"}`,n.appendChild(c)}const l=document.createElement("h4");l.className="font-bold mb-2 text-gray-800",l.textContent="Ingrédients :",n.appendChild(l);const s=document.createElement("ul");s.className="space-y-1 text-gray-600",a.ingredients.forEach(c=>{const u=document.createElement("li");u.textContent=`• ${c.quantity||""} ${c.unit||""} ${c.name}`.trim(),s.appendChild(u)}),n.appendChild(s)}else n.textContent="Aucun ingrédient spécifié pour cette recette.";document.body.appendChild(n);const r=t.closest(".meal-card").getBoundingClientRect(),e=n.getBoundingClientRect();if(window.innerWidth<768){n.style.width="90vw",n.style.maxWidth="320px";const l=n.getBoundingClientRect();let s=r.bottom+10,c=(window.innerWidth-l.width)/2;s+l.height>window.innerHeight&&(s=r.top-l.height-10),n.style.top=`${s}px`,n.style.left=`${c}px`}else{let l=r.right+10;l+e.width>window.innerWidth&&(l=r.left-e.width-10);let s=r.top;s+e.height>window.innerHeight&&(s=r.bottom-e.height),s<10&&(s=10),n.style.left=`${l}px`,n.style.top=`${s}px`}n.style.position="fixed"}function De(t,a=!1){const n=document.createElement("div"),r=document.createElement("button");return a?(n.className="w-full flex justify-center pt-1",r.className="add-more-meal-btn text-gray-400 hover:text-green-500 transition-colors duration-150",r.innerHTML='<i class="fas fa-plus-circle"></i>',r.title="Ajouter une autre recette"):(n.className="flex items-center justify-center h-full",r.className="add-meal-btn text-green-500 hover:text-green-700 transition-transform duration-150 hover:scale-125",r.innerHTML='<i class="fas fa-plus-circle text-lg"></i>'),r.addEventListener("click",()=>Me(t)),n.appendChild(r),n}function Ne(t,a,n=!1){if(n){const e=document.createElement("p");return e.className="w-full h-full p-1 text-xs text-gray-700",e.textContent=a[t]||"",e}const r=document.createElement("textarea");return r.className="w-full h-full p-1 text-xs bg-white border-0 rounded focus:outline-none focus:ring-1 focus:ring-tomato resize-none",r.placeholder="Remarque...",r.value=P[t]||"",r.dataset.slotId=t,r.addEventListener("change",e=>{const o=e.target.value;o?P[t]=o:delete P[t];const[l,s]=t.split("-"),m=`a modifié la remarque pour ${U[parseInt(l,10)]} ${s==="lunch"?"midi":"soir"}`;V({[`weeks.${D}.remarksData`]:P},m)}),r.addEventListener("focus",e=>{Ce({type:"editing_remark",fieldId:t})}),r.addEventListener("blur",e=>{Ce("idle")}),r}function it(){document.querySelectorAll(".meal-card").forEach(t=>{t.addEventListener("dragstart",tt),t.addEventListener("dragend",nt)}),document.querySelectorAll(".meal-slot").forEach(t=>{t.addEventListener("dragover",at),t.addEventListener("dragleave",st),t.addEventListener("drop",rt)})}async function lt(t,a){const n=JSON.parse(JSON.stringify(v)),r=n[t],e={id:a.id};Array.isArray(r)?r.push(e):n[t]=[e];const[o,l]=t.split("-"),s=U[parseInt(o,10)],c=l==="lunch"?"midi":"soir",u=`a ajouté '${a.name}' à ${s} ${c}`;await V({[`weeks.${D}.menuData`]:n},u),pe()}async function ct(t,a){if(!d||!v[t]||!Array.isArray(v[t]))return;const n=v[t][a],r=JSON.parse(JSON.stringify(v));r[t].splice(a,1),r[t].length===0&&delete r[t];const[e,o]=t.split("-"),l=U[parseInt(e,10)],s=o==="lunch"?"midi":"soir",c=`a supprimé '${n.name}' de ${l} ${s}`;await V({[`weeks.${D}.menuData`]:r},c)}function $e(t){t>=1&&t<=52&&(D=t,we())}function dt(){i.currentWeekDisplay&&(i.currentWeekDisplay.textContent=`Semaine ${D}`)}function ut(){i.prevWeekBtn?.addEventListener("click",()=>$e(D-1)),i.nextWeekBtn?.addEventListener("click",()=>$e(D+1)),i.clearMenuBtn?.addEventListener("click",Ge),i.startDaySelect?.addEventListener("change",async n=>{N=n.target.value,d&&await V({startDay:N},`a changé le premier jour de la semaine à '${N}'`)}),i.planSelect?.addEventListener("change",xe),i.closeMealSelectModalBtn?.addEventListener("click",pe),i.mealSelectModal?.addEventListener("click",n=>{n.target===i.mealSelectModal&&pe()}),i.closeRecipeModalBtn?.addEventListener("click",()=>de.closeForm()),i.cancelRecipeBtn?.addEventListener("click",()=>de.closeForm()),i.importListBtn?.addEventListener("click",We),i.closeImportListModalBtn?.addEventListener("click",he),i.importListModal?.addEventListener("click",n=>{n.target===i.importListModal&&he()}),i.exportTxtBtn?.addEventListener("click",Ye),i.exportPdfBtn?.addEventListener("click",Xe),i.exportPlanPdfBtn?.addEventListener("click",Ze);const t=n=>{const r=n.target.closest(".info-meal-btn");if(r){const e=r.dataset.slotId,o=parseInt(r.dataset.mealIndex,10);if(e&&!isNaN(o)){const l=v[e]?.[o];if(l&&l.id){const s=z.find(c=>c.id===l.id);s&&ot(r,s)}}}};i.mealPlanGrid?.addEventListener("click",t),document.getElementById("mobile-meal-plan")?.addEventListener("click",t),i.sharePlanBtn?.addEventListener("click",()=>{if(!d){alert("Veuillez sélectionner un menu à partager.");return}Tt({plan:d})}),i.inviteParticipantBtn?.addEventListener("click",()=>{if(!d){alert("Veuillez sélectionner un menu pour inviter des participants.");return}Ht(d)}),i.historyPlanBtn?.addEventListener("click",Ve),i.closePlanHistoryModalBtn?.addEventListener("click",ye),i.smartPlanBtn?.addEventListener("click",Qe),i.archivePlanBtn?.addEventListener("click",async()=>{const n=d&&d.isOwner?"Voulez-vous archiver ce menu ? Il sera masqué pour vous mais restera accessible par Chef Gusto pour ses recommandations.":"Voulez-vous masquer ce menu collaboratif de votre liste ? Il restera accessible aux autres membres et Chef Gusto pourra toujours s'y référer.";d&&confirm(n)&&(await xt(d.id,!0),alert("Menu masqué/archivé avec succès."))}),i.planHistoryModal?.addEventListener("click",n=>{n.target===i.planHistoryModal&&ye()}),document.addEventListener("click",n=>{if(n.target.closest("#open-trash-btn")){console.log("DEBUG: Trash button clicked");let e=document.getElementById("trash-modal");!e&&i&&i.trashModal&&(e=i.trashModal),e?(e.parentNode!==document.body&&(console.log("DEBUG: Hoisting trash modal to body"),document.body.appendChild(e)),e.classList.remove("hidden"),e.style.display="flex",e.style.zIndex="9999",e.style.position="fixed",e.style.inset="0",console.log("DEBUG: Trash modal forced open")):(console.error("DEBUG: Trash modal element NOT FOUND"),alert("Erreur: Impossible de trouver la fenêtre de corbeille."))}}),document.addEventListener("click",n=>{const r=n.target.closest("#close-trash-modal"),e=document.getElementById("trash-modal");e&&!e.classList.contains("hidden")&&(r||n.target===e)&&(console.log("DEBUG: Closing trash modal"),e.classList.add("hidden"),e.style.display="",e.style.zIndex="",e.style.position="",e.style.inset="")}),i.savePlanBtn?.addEventListener("click",async()=>{if(!d){alert("Veuillez sélectionner un menu de travail avant de sauvegarder.");return}const n=document.getElementById("save-plan-as-modal"),r=document.getElementById("save-plan-as-form"),e=document.getElementById("save-plan-name"),o=document.getElementById("cancel-save-plan-as-btn"),l=document.getElementById("close-save-plan-as-modal"),s=new Date().toLocaleDateString("fr-FR"),c=d.weeks?Object.keys(d.weeks).filter(f=>d.weeks[f]&&Object.keys(d.weeks[f].menuData||{}).length>0).length:0,u=c>1?`${c} semaines`:`${c} semaine`;e.value=`${d.name} (${u}) - ${s}`,n.classList.remove("hidden");const m=async f=>{f.preventDefault();const g=e.value;if(!g)return;d.weeks||(d.weeks={}),d.weeks[D]={menuData:v,servingsData:H,remarksData:P},d.startDay=N,d.defaultNumPeople=R;const y=JSON.parse(JSON.stringify(d));if(y.weeks)for(const x in y.weeks){const h=y.weeks[x];if(h&&h.menuData)for(const E in h.menuData){const w=h.menuData[E];Array.isArray(w)&&(h.menuData[E]=w.map(C=>C&&C.id&&z.find(A=>A.id===C.id)||C))}}await Et(g,y),n.classList.add("hidden"),r.removeEventListener("submit",m)},p=()=>{n.classList.add("hidden"),r.removeEventListener("submit",m)};r.addEventListener("submit",m,{once:!0}),o.addEventListener("click",p,{once:!0}),l.addEventListener("click",p,{once:!0})})}function mt(t=""){return t.split(" ").map(r=>r[0]).join("").substring(0,2).toUpperCase()}function ve(t=[],a={}){const n=document.getElementById("collaborators-bar"),r=document.getElementById("activity-labels-container"),e=document.getElementById("name-tooltip");if(!n||!e||!r)return;if(n.innerHTML="",r.innerHTML="",document.querySelectorAll(".remark-lock-overlay").forEach(s=>s.remove()),document.querySelectorAll("textarea[data-slot-id]").forEach(s=>{s.disabled=!1}),t.length<=1&&Object.keys(a).length<=1){n.classList.add("hidden");return}let o="";const l=fe();t.forEach(s=>{if(!s)return;const c=a.hasOwnProperty(s.uid),u=a[s.uid]||{},m=document.createElement("div");m.className="w-8 h-8 rounded-full flex items-center justify-center bg-gray-300 text-white font-bold text-xs ring-2 ring-white cursor-pointer transition-all duration-300";const p=c?"(présent)":"(absent)";if(m.dataset.name=`${s.displayName||"Inconnu"} ${p}`,s.photoURL?m.innerHTML=`<img src="${s.photoURL}" alt="${s.displayName}" class="w-full h-full rounded-full object-cover">`:m.textContent=mt(s.displayName),c||m.classList.add("grayscale","opacity-50"),m.addEventListener("mouseenter",f=>{e.textContent=f.currentTarget.dataset.name,e.classList.remove("hidden");const g=f.currentTarget.getBoundingClientRect();e.style.left=`${g.left+g.width/2-e.offsetWidth/2}px`,e.style.top=`${g.top-e.offsetHeight-5}px`}),m.addEventListener("mouseleave",()=>{e.classList.add("hidden")}),n.appendChild(m),c&&s.uid!==l){const f=u.status;if(typeof f=="object"&&f.type==="editing_remark"){const g=document.querySelector(`textarea[data-slot-id="${f.fieldId}"]`);if(g){g.disabled=!0;const y=document.createElement("div");y.className="remark-lock-overlay absolute inset-0 bg-gray-400 bg-opacity-25 flex items-center justify-center text-xs text-white font-bold",y.innerHTML=`<i class="fas fa-lock mr-1"></i> ${s.displayName} écrit...`,g.parentElement&&(g.parentElement.classList.add("relative"),g.parentElement.appendChild(y))}}else if(typeof f=="string"&&f!=="idle"){let g="";switch(f){case"editing_recipe":g="modifie une recette...";break}g&&(o+=`<span class="italic mr-4">${s.displayName} ${g}</span>`)}}}),r.innerHTML=o,n.classList.remove("hidden")}function xe(){Rt();const t=i.planSelect.value;t&&localStorage.setItem("lastActivePlanId",t),d=ge.find(s=>s.id===t)||null;const a=document.getElementById("delete-plan-btn"),n=document.getElementById("rename-plan-btn"),r=document.getElementById("leave-plan-btn"),e=document.getElementById("invite-participant-btn"),o=document.getElementById("history-plan-btn"),l=document.getElementById("archive-plan-btn");if(a&&(a.style.display=d&&d.isOwner?"inline-flex":"none"),n&&(n.style.display=d&&d.isOwner?"inline-flex":"none"),o&&(o.style.display=d&&d.isOwner?"inline-flex":"none"),l&&(l.style.display=d?"inline-flex":"none"),r&&(r.style.display=d&&!d.isOwner?"inline-flex":"none"),e){const s=d&&(d.type==="collaborative"||d.collaborators&&d.collaborators.length>0);e.style.display=d&&d.isOwner&&s?"inline-flex":"none"}d&&d.participants&&d.participants.length>1?(ve(d.participants,{}),Ft(d.id,s=>{ve(d.participants,s)})):ve([],{}),d&&(d.manualItems=d.manualItems||[]),we()}async function Pe(t,a){if(!d)return;const n=JSON.parse(JSON.stringify(H));a===R?delete n[t]:n[t]=a;const[r,e]=t.split("-"),s=`a changé le nombre de personnes pour ${U[parseInt(r,10)]} ${e==="lunch"?"midi":"soir"} à ${a}`;await V({[`weeks.${D}.servingsData`]:n},s)}async function pt(){if(!k)return;const t=yt();ut(),Ke(),await Ie();const a=Bt(ae(k,"recipes"),r=>{if(console.log("Recipe data updated from listener."),z=r.docs.map(e=>{const o=e.data();return{id:e.id,...o,imageUrl:o.imageUrl||""}}),d){for(const e in v){const o=v[e];if(Array.isArray(o)){const l=o.map(s=>{if(s&&s.id){const c=z.find(u=>u.id===s.id);return c?{...c}:s}return s});v[e]=l}}oe(i.mealPlanGrid,{menuData:v,servingsData:H,remarksData:P,defaultNumPeople:R,startDay:N},!1),me(document.getElementById("mobile-meal-plan"),{menuData:v,servingsData:H,remarksData:P,defaultNumPeople:R,startDay:N},!1),ie()}}),n=ht(r=>{ge=r,bt(r);const e=localStorage.getItem("selectedPlanId"),o=localStorage.getItem("lastActivePlanId");e&&r.some(l=>l.id===e)?(i.planSelect.value=e,localStorage.removeItem("selectedPlanId")):o&&r.some(l=>l.id===o)&&(i.planSelect.value=o),xe()});return()=>{n(),a(),t()}}const ft=pt();return async()=>{const t=await ft;typeof t=="function"&&t()}}export{zt as default};
