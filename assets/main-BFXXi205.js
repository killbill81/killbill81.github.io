import{o as de,s as V,a as _,d as h,b,u as C,c as le,e as k,q as D,w as S,f as H,g as $,h as U,i as W,j as ce,k as ue}from"./firebase-config-DZVz6goz.js";const X=document.querySelector("main"),me={menu:{html:`
        <div class="flex flex-col md:flex-row md:space-x-2">

            <!-- Left Column: Meal Planner -->
            <div class="w-full md:w-5/6">
                <section id="meal-planning-section" aria-labelledby="meal-planning-heading" class="mb-8 md:mb-12">
                                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                                        <h2 id="meal-planning-heading" class="text-xl md:text-2xl font-bold text-foreground">Menu de la semaine</h2>
                                        <div class="mt-3 md:mt-0 flex items-center space-x-2 md:space-x-3 plan-actions">
                                            <button id="smart-plan-btn" class="btn btn-primary btn-sm" title="Générer un menu hebdomadaire intelligent avec l'IA">
                                                <i class="fas fa-magic mr-1 md:mr-2"></i> Menu Intelligent
                                            </button>
                                            <button id="clear-menu-btn" class="btn btn-outline btn-sm text-red-800 hover:bg-red-100">
                                                <i class="fas fa-trash-alt mr-1 md:mr-2"></i> Vider le menu
                                            </button>
                                            <button id="export-plan-pdf-btn" class="btn btn-outline btn-sm">
                                                <i class="fas fa-file-pdf mr-1 md:mr-2"></i> Exporter Menu (PDF)
                                            </button>
                                            <button id="share-plan-btn" class="btn btn-secondary btn-sm">
                                                <i class="fas fa-share-alt mr-1 md:mr-2"></i> Partager
                                            </button>
                                            <button id="save-plan-btn" class="btn btn-secondary btn-sm">
                                                <i class="fas fa-save mr-1 md:mr-2"></i> Sauvegarder Menu
                                            </button>
                                        </div>
                                    </div>
                            
                                    <!-- Week Navigation & Menu Selector -->
                                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 space-y-3 md:space-y-0">
                                        <!-- Week Navigation -->
                                        <div class="flex justify-between items-center bg-card text-card-foreground border border-border p-2 md:p-3 rounded-lg shadow-sm">
                                            <button id="prev-week-btn" class="p-2 rounded-md hover:bg-gray-100 text-muted-foreground hover:text-tomato transition-colors" aria-label="Semaine précédente">
                                                <i class="fas fa-chevron-left mr-1 md:mr-2"></i> Préc.
                                            </button>
                                            <div id="current-week-display" class="text-gray-700 font-medium text-sm md:text-base text-center mx-4">Semaine X</div>
                                            <button id="next-week-btn" class="p-2 rounded-md hover:bg-gray-100 text-muted-foreground hover:text-tomato transition-colors" aria-label="Semaine suivante">
                                                Suiv. <i class="fas fa-chevron-right ml-1 md:ml-2"></i>
                                            </button>
                                        </div>
                                        <!-- Plan Selector -->
                                        <div class="flex flex-wrap items-center justify-center gap-2 bg-card text-card-foreground border border-border p-3 rounded-lg shadow-sm">
                                            <label for="plan-select" class="text-sm font-medium text-gray-700">Menu affiché:</label>
                                            <select id="plan-select" class="rounded-md border-gray-300 shadow-sm focus:border-tomato focus:ring focus:ring-tomato focus:ring-opacity-50 text-sm py-1">
                                                <!-- Options will be generated by JS -->
                                            </select>
                                            <button id="create-plan-btn" class="btn btn-primary btn-sm" title="Créer un nouveau menu">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                            <button id="rename-plan-btn" class="text-blue-500 hover:bg-blue-100 text-sm px-3 py-1 rounded-md" title="Renommer le menu sélectionné">
                                                <i class="fas fa-pencil-alt"></i>
                                            </button>
                                            <button id="history-plan-btn" class="text-purple-500 hover:bg-purple-100 text-sm px-3 py-1 rounded-md" title="Historique des modifications">
                                                <i class="fas fa-history"></i>
                                            </button>
                                            <button id="archive-plan-btn" class="text-gray-500 hover:bg-gray-100 text-sm px-3 py-1 rounded-md" title="Archiver le menu (le masquer sans le supprimer)">
                                                <i class="fas fa-archive"></i>
                                            </button>
                                            <button id="leave-plan-btn" class="text-yellow-600 hover:bg-yellow-100 text-sm px-3 py-1 rounded-md" title="Quitter le menu collaboratif">
                                                <i class="fas fa-door-open"></i>
                                            </button>
                                            <button id="delete-plan-btn" class="text-red-500 hover:bg-red-100 text-sm px-3 py-1 rounded-md" title="Supprimer le menu sélectionné">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            <button id="invite-participant-btn" class="text-green-500 hover:bg-green-100 text-sm px-3 py-1 rounded-md hidden" title="Inviter un participant">
                                                <i class="fas fa-user-plus"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Collaborators Bar -->
                                    <div id="collaborators-bar" class="flex items-center space-x-2 mb-4 hidden">
                                        <!-- Avatars will be injected here -->
                                    </div>

                                    <!-- Activity Labels -->
                                    <div id="activity-labels-container" class="text-sm text-muted-foreground mb-4 h-6">
                                        <!-- e.g., 'Sophie is adding a recipe...' -->
                                    </div>
                            
                                            <!-- Settings Section -->
                                            <div class="inline-flex items-center space-x-6 bg-card text-card-foreground border border-border p-3 rounded-lg shadow-sm mb-4">                                        <div>
                                            <label for="start-day-select" class="text-sm font-medium text-gray-700">Début de semaine:</label>
                                            <select id="start-day-select" class="rounded-md border-gray-300 shadow-sm focus:border-tomato focus:ring-tomato text-sm py-1">
                                                <option>Lundi</option>
                                                <option>Mardi</option>
                                                <option>Mercredi</option>
                                                <option>Jeudi</option>
                                                <option>Vendredi</option>
                                                <option>Samedi</option>
                                                <option>Dimanche</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="default-servings-input" class="text-sm font-medium text-gray-700">Personnes par défaut:</label>
                                            <div id="default-servings-control" class="mt-1"></div>
                                        </div>
                                    </div>                    <!-- Responsive Meal Plan Grid -->
<div class="bg-card text-card-foreground rounded-xl shadow-md border border-border p-4">
                        <!-- Desktop Grid (Visible on large screens) -->
                        <div id="desktop-plan-container" class="hidden lg:block">
                            <div id="meal-plan-grid-layout">
                                <!-- Header -->
                                <div class="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] gap-1 text-center mb-1">
                                    <div class="p-2"></div> <!-- Empty corner -->
                                    <div class="p-2 rounded-t-lg bg-amber-100 text-amber-800 font-bold col-span-6">MIDI</div>
                                    <div class="p-2 rounded-t-lg bg-stone-200 text-stone-800 font-bold col-span-6">SOIR</div>
                                    
                                    <div class="p-1"></div> <!-- Empty under day name -->
                                    <div class="p-1 text-xs font-semibold"><i class="fas fa-users"></i></div>
                                    <div class="p-1 text-xs font-semibold text-muted-foreground">Entrée</div>
                                    <div class="p-1 text-xs font-semibold text-muted-foreground">Plat</div>
                                    <div class="p-1 text-xs font-semibold text-muted-foreground">Accomp.</div>
                                    <div class="p-1 text-xs font-semibold text-muted-foreground">Dessert</div>
                                    <div class="p-1 text-xs font-semibold text-muted-foreground">Remarque</div>

                                    <div class="p-1 text-xs font-semibold"><i class="fas fa-users"></i></div>
                                    <div class="p-1 text-xs font-semibold text-muted-foreground">Entrée</div>
                                    <div class="p-1 text-xs font-semibold text-muted-foreground">Plat</div>
                                    <div class="p-1 text-xs font-semibold text-muted-foreground">Accomp.</div>
                                    <div class="p-1 text-xs font-semibold text-muted-foreground">Dessert</div>
                                    <div class="p-1 text-xs font-semibold text-muted-foreground">Remarque</div>
                                </div>
                                <!-- Rows generated by JS -->
                                <div id="meal-plan-grid" class="space-y-1">
                                    <div class="p-10 text-center text-muted-foreground italic col-span-full">Chargement du planning...</div>
                                </div>
                            </div>
                        </div>

                        <!-- Mobile Accordion (Visible on small screens) -->
                        <div id="mobile-meal-plan" class="lg:hidden space-y-2">
                            <!-- Mobile content will be generated by JS here -->
                             <div class="p-10 text-center text-muted-foreground italic col-span-full">Chargement du planning...</div>
                        </div>
                    </div>
                                    </section>


                                </div>
                    
                                <!-- Right Column: Shopping List -->
                                <div class="w-full md:w-1/6">
                                    <section id="shopping-list-section" aria-labelledby="shopping-list-heading" class="mb-8 md:mb-12 md:sticky md:top-24">
                                        <div class="bg-card text-card-foreground rounded-xl shadow-md border border-border p-4 md:p-6">
                                            <div class="flex justify-between items-center mb-4">
                                        <h2 class="text-2xl font-bold text-foreground">Liste de courses</h2>
                                        <button id="open-trash-btn" class="flex items-center justify-center p-2 rounded-md hover:bg-gray-100 text-muted-foreground hover:text-gray-700 ml-2 transition-colors">
                                            <i class="fas fa-trash-alt text-lg"></i> <span id="trash-count" class="bg-gray-200 text-xs px-1.5 py-0.5 rounded-full ml-1">0</span>
                                        </button>
                                    </div>
                                    <div class="flex justify-end space-x-2 mb-4">
                                        <button id="import-list-btn" class="btn btn-secondary btn-sm">
                                                    <i class="fas fa-download mr-2"></i>Importer une liste
                                                </button>
                                                <div id="export-buttons-container" class="flex space-x-2">
                                                    <button id="export-txt-btn" class="btn btn-outline btn-sm">
                                                        <i class="fas fa-file-alt mr-2"></i>TXT
                                                    </button>
                                                    <button id="export-pdf-btn" class="btn btn-outline btn-sm">
                                                        <i class="fas fa-file-pdf mr-2"></i>PDF
                                                    </button>
                                                </div>
                                            </div>
                    
                                            <!-- Shopping List Container -->
                                            <div id="shopping-list-container" class="mb-4 max-h-[70vh] overflow-y-auto pr-2">                            <ul id="shopping-list" class="space-y-2 text-sm">
                                <!-- Les articles de la liste de courses seront générés ici -->
                            </ul>
                        </div>

                        <!-- Add Item Input -->
                        <div class="mt-4 flex items-stretch">
                            <div class="relative flex-grow">
                                <input type="text" id="add-item-input" placeholder="Chercher ou ajouter..." class="w-full border border-gray-300 rounded-l-lg px-2 py-1 text-xs focus:outline-none focus:ring-2 focus:ring-tomato focus:border-transparent">
                                <div id="add-item-results" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto bottom-full mb-2"></div>
                            </div>
                            <button id="add-item-btn" class="btn btn-primary rounded-l-none -ml-px btn-xs" aria-label="Ajouter l'article">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>

                         <!-- AI Shopping Tips Placeholder -->
                        <div id="ai-shopping-tip" class="mt-6 bg-avocado bg-opacity-10 rounded-lg p-3 hidden">
                            <div class="flex items-start">
                                 <div class="w-8 h-8 bg-avocado bg-opacity-20 rounded-full flex items-center justify-center mr-3 shrink-0">
                                    <i class="fas fa-lightbulb text-avocado"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-avocado mb-1 text-sm">Astuce Économique</h4>
                                    <p id="ai-shopping-tip-text" class="text-sm text-gray-700">...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <!-- Shared Plans Modal -->
        <div id="shared-plans-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-6xl max-h-[90vh] overflow-y-auto relative">
                <button id="close-shared-plans-modal" class="absolute top-4 right-4 text-gray-400 hover:text-muted-foreground" aria-label="Fermer">
                    <i class="fas fa-times text-xl"></i>
                </button>
                <h3 id="shared-plans-modal-title" class="text-2xl font-bold mb-6">Menus partagés pour la Semaine X</h3>
                <div id="shared-plans-modal-container" class="space-y-6">
                    <!-- Shared plans will be loaded here -->
                </div>
            </div>
        </div>
        `,script:"./script.js"},recipes:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-foreground">Mes Recettes</h2>
            <button id="add-recipe-btn" class="btn btn-primary">
                <i class="fas fa-plus mr-2"></i> Ajouter une recette
            </button>
        </div>

        <!-- Search Bar -->
        <div class="mb-6">
            <input type="text" id="search-bar" placeholder="Rechercher une recette..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-tomato focus:border-tomato">
        </div>

        <!-- Tabs Navigation -->
        <div id="category-tabs" class="mb-6 border-b border-gray-200 flex space-x-4 flex-nowrap overflow-x-auto pb-2">
            <!-- Tabs will be generated by recipes.js here -->
        </div>

        <!-- Recipe List Container -->
        <div id="recipe-list-container">
            <!-- Recipes for the selected tab will be loaded here -->
        </div>

        <!-- Reconstructed Recipe Form Modal -->
        <div id="recipe-form-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-3xl max-h-[90vh] overflow-y-auto relative">
                <button id="close-recipe-modal" class="absolute top-4 right-4 text-gray-400 hover:text-muted-foreground" aria-label="Fermer">
                    <i class="fas fa-times text-xl"></i>
                </button>
                <h3 id="recipe-modal-title" class="text-2xl font-bold mb-6">Ajouter/Modifier une recette</h3>
                <form id="recipe-form" class="space-y-4">
                    <input type="hidden" id="recipe-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label for="recipe-name" class="block text-sm font-medium text-gray-700">Nom de la recette</label>
                            <input type="text" id="recipe-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                        </div>
                        <div>
                            <label for="recipe-category" class="block text-sm font-medium text-gray-700">Catégorie</label>
                            <select id="recipe-category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                                <option>ENTREE</option>
                                <option>PLAT</option>
                                <option>ACCOMPAGNEMENT</option>
                                <option>DESSERT</option>
                            </select>
                        </div>
                        <div>
                            <label for="recipe-servings" class="block text-sm font-medium text-gray-700">Nombre de personnes</label>
                            <input type="number" id="recipe-servings" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" min="1">
                        </div>
                        <div>
                            <label for="recipe-prep-time" class="block text-sm font-medium text-gray-700">Temps de préparation (min)</label>
                            <input type="number" id="recipe-prep-time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" min="0">
                        </div>
                         <div>
                            <label for="recipe-difficulty" class="block text-sm font-medium text-gray-700">Difficulté</label>
                            <select id="recipe-difficulty" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                <option>Très facile</option>
                                <option>Facile</option>
                                <option>Moyen</option>
                                <option>Difficile</option>
                            </select>
                        </div>

                    </div>
                    <div>
                        <h4 class="text-lg font-medium text-foreground mb-2">Ingrédients</h4>
                        <div id="ingredients-list" class="space-y-2"></div>
                        <button type="button" id="add-ingredient-btn" class="btn btn-outline btn-sm mt-2">
                            <i class="fas fa-plus mr-2"></i> Ajouter un ingrédient
                        </button>
                    </div>
                    <div>
                        <label for="recipe-steps" class="block text-lg font-medium text-foreground">Préparation</label>
                        <textarea id="recipe-steps" rows="8" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                    </div>
                    <div class="flex justify-end space-x-4 pt-4">
                        <button type="button" id="cancel-recipe-btn" class="text-gray-700 hover:bg-gray-100 px-4 py-2 rounded-md">Annuler</button>
                        <button type="submit" id="save-recipe-btn" class="btn btn-primary">Sauvegarder</button>
                    </div>
                </form>
            </div>
        </div>
        `,script:"./recipes.js"},ingredients:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-foreground">Mes Ingrédients</h2>
            <div class="flex space-x-2">
                <button id="audit-ingredients-btn" class="btn btn-secondary">
                    <i class="fas fa-stethoscope mr-2"></i> Audit Qualité IA
                </button>
                <button id="manage-categories-btn" class="btn btn-outline">
                    <i class="fas fa-tags mr-2"></i> Gérer les catégories
                </button>
                <button id="add-ingredient-btn" class="btn btn-primary">
                    <i class="fas fa-plus mr-2"></i> Ajouter un ingrédient
                </button>
            </div>
        </div>

        <!-- Audit Results Modal -->
        <div id="audit-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-[150] hidden">
            <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-11/12 max-w-4xl max-h-[90vh] overflow-y-auto relative border border-gray-200 dark:border-gray-700 shadow-2xl">
                <h3 class="text-2xl font-bold mb-4 text-gray-900 dark:text-white">Audit de qualité des ingrédients</h3>
                <p class="text-gray-700 dark:text-gray-300 mb-6">L'IA a analysé vos ingrédients pour suggérer des unités et catégories standards. Cela facilitera la création des listes de courses.</p>
                
                <div class="overflow-x-auto border border-gray-200 dark:border-gray-700 rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-100 dark:bg-gray-700/50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 dark:text-gray-400 uppercase tracking-wider">Ingrédient</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 dark:text-gray-400 uppercase tracking-wider">Actuel</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 dark:text-gray-400 uppercase tracking-wider">Suggéré</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 dark:text-gray-400 uppercase tracking-wider">Raison</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-600 dark:text-gray-400 uppercase tracking-wider">Appliquer</th>
                            </tr>
                        </thead>
                        <tbody id="audit-results-list" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            <!-- Rows injected by JS -->
                        </tbody>
                    </table>
                </div>

                <div class="flex justify-end space-x-4 mt-8 sticky bottom-0 bg-white dark:bg-gray-800 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <button id="close-audit-modal" class="px-5 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg font-medium transition-colors">Annuler</button>
                    <button id="apply-audit-btn" class="btn btn-primary px-6 py-2">Enregistrer les sélectionnés</button>
                </div>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="mb-6">
            <input type="text" id="search-bar" placeholder="Rechercher un ingrédient..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-tomato focus:border-tomato">
        </div>

        <!-- Tabs Navigation -->
        <div id="category-tabs" class="mb-6 border-b border-gray-200 flex space-x-4 flex-nowrap overflow-x-auto pb-2">
            <!-- Tabs will be generated by ingredients.js here -->
        </div>

        <!-- Ingredient List Container -->
        <div id="ingredients-list-container">
            <p class="text-center text-muted-foreground p-10">Chargement des ingrédients...</p>
        </div>


        <!-- Category Management Modal -->
        <div id="category-management-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-lg relative">
                <h3 class="text-lg font-bold mb-4">Gérer les catégories d'ingrédients</h3>
                <form id="add-category-form" class="flex items-center space-x-2 mb-4">
                    <input type="text" id="new-category-name" placeholder="Nom de la nouvelle catégorie" class="flex-grow mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                    <button type="submit" class="btn btn-secondary">Ajouter</button>
                </form>
                <div id="category-list" class="max-h-64 overflow-y-auto border rounded-lg p-2"></div>
                <div class="flex justify-end space-x-4 mt-4">
                     <button type="button" id="close-category-modal" class="text-gray-700 hover:bg-gray-100 px-4 py-2 rounded-md">Annuler</button>
                    <button type="button" id="done-category-modal-btn" class="btn btn-primary">Terminé</button>
                </div>
            </div>
        </div>
        `,script:"./ingredients.js"},lists:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-foreground">Mes Listes de Courses</h2>
            <button id="add-list-btn" class="btn btn-primary">
                <i class="fas fa-plus mr-2"></i> Créer une liste
            </button>
            <button id="generate-seasonal-list-btn" class="btn btn-secondary ml-2">
                <i class="fas fa-magic mr-2"></i> Générer par saison
            </button>
        </div>

        <!-- Search Bar -->
        <div class="mb-6">
            <input type="text" id="search-bar" placeholder="Rechercher une liste..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-tomato focus:border-tomato">
        </div>

        <!-- Lists Container -->
        <div id="lists-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

        <div class="mt-12">
            <h2 class="text-2xl md:text-3xl font-bold text-foreground mb-6">Listes Partagées</h2>
            <div id="shared-lists-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Les listes partagées seront chargées ici par JS -->
            </div>
        </div>

        <!-- List Form Modal -->
        <div id="list-form-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-start justify-center z-[100] hidden pt-20">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-3xl min-h-[75vh] max-h-[90vh] overflow-y-auto relative">
                <button id="close-list-modal" class="absolute top-4 right-4 text-gray-400 hover:text-muted-foreground z-10"><i class="fas fa-times text-xl"></i></button>
                <h3 id="list-modal-title" class="text-lg font-bold mb-4">Créer une liste</h3>
                <form id="list-form" class="space-y-4 pb-20">
                    <input type="hidden" id="list-id">
                    <div>
                        <label for="list-name" class="block text-sm font-medium text-gray-700">Nom de la liste</label>
                        <input type="text" id="list-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                    </div>
                    <div>
                        <h4 class="text-md font-medium text-foreground mb-2">Ingrédients</h4>
                        <div id="ingredients-list" class="space-y-2"></div>
                        <button type="button" id="add-ingredient-btn" class="btn btn-outline btn-sm mt-2">
                            <i class="fas fa-plus mr-2"></i> Ajouter un ingrédient
                        </button>
                    </div>
                </form>
                <div class="absolute bottom-0 left-0 right-0 px-6 py-4 bg-white/95 backdrop-blur-sm border-t border-gray-200 flex justify-end space-x-4">
                    <button type="button" id="cancel-list-btn" class="text-gray-700 hover:bg-gray-100 px-4 py-2 rounded-md">Annuler</button>
                    <button type="submit" form="list-form" id="save-list-btn" class="btn btn-primary">Sauvegarder la liste</button>
                </div>
            </div>
        </div>
        `,script:"./lists.js"},shared:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-foreground">Mes Partages</h2>
        </div>

        <div class="space-y-12">
            <div>
                <h3 class="text-xl font-bold text-gray-700 border-b pb-2 mb-4">Partages Reçus</h3>
                <div id="received-shares-container" class="space-y-4">
                    <!-- L'historique des partages acceptés sera chargé ici -->
                </div>
            </div>
            <div>
                <h3 class="text-xl font-bold text-gray-700 border-b pb-2 mb-4">Mes Partages Envoyés</h3>
                <div id="sent-shares-container" class="space-y-4">
                    <!-- L'historique des partages envoyés sera chargé ici -->
                </div>
            </div>
        </div>
        `,script:"./shared.js"},plans:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-foreground">Mes Plans Sauvegardés</h2>
        </div>
        <div id="all-plans-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12">
            <!-- La liste des plans sera chargée ici -->
            <p class="text-center text-muted-foreground p-10 col-span-full">Chargement de vos plans...</p>
        </div>

        <div class="border-t border-gray-200 pt-8">
            <h2 class="text-2xl font-bold text-foreground mb-6">Menus Archivés</h2>
            <div id="archived-plans-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Les plans archivés seront chargés ici -->
                <p class="text-center text-muted-foreground p-10 col-span-full">Chargement de vos archives...</p>
            </div>
        </div>
        `,script:"./all-plans.js"},"view-plan":{html:`
        <section aria-labelledby="meal-planning-heading" class="mb-8 md:mb-12">
            <div class="flex justify-between items-center mb-4">
                <h2 id="plan-view-name" class="text-xl md:text-2xl font-bold text-foreground">Chargement du plan...</h2>
                <button id="close-view-plan-btn" class="btn btn-outline">
                    <i class="fas fa-times mr-2"></i> Fermer et voir mes plans
                </button>
            </div>
            <div class="bg-card text-card-foreground rounded-xl shadow-md border border-border p-4">
                <div id="meal-plan-grid-layout">
                    <!-- Header -->
                    <div class="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] gap-1 text-center mb-1">
                        <div class="p-2"></div> <!-- Empty corner -->
                        <div class="p-2 rounded-t-lg bg-amber-100 text-amber-800 font-bold col-span-6">MIDI</div>
                        <div class="p-2 rounded-t-lg bg-stone-200 text-stone-800 font-bold col-span-6">SOIR</div>
                        <div class="p-1"></div> <!-- Empty under day name -->
                        <div class="p-1 text-xs font-semibold"><i class="fas fa-users"></i></div>
                        <div class="p-1 text-xs font-semibold text-muted-foreground">Entrée</div>
                        <div class="p-1 text-xs font-semibold text-muted-foreground">Plat</div>
                        <div class="p-1 text-xs font-semibold text-muted-foreground">Accomp.</div>
                        <div class="p-1 text-xs font-semibold text-muted-foreground">Dessert</div>
                        <div class="p-1 text-xs font-semibold text-muted-foreground">Remarque</div>
                        <div class="p-1 text-xs font-semibold"><i class="fas fa-users"></i></div>
                        <div class="p-1 text-xs font-semibold text-muted-foreground">Entrée</div>
                        <div class="p-1 text-xs font-semibold text-muted-foreground">Plat</div>
                        <div class="p-1 text-xs font-semibold text-muted-foreground">Accomp.</div>
                        <div class="p-1 text-xs font-semibold text-muted-foreground">Dessert</div>
                        <div class="p-1 text-xs font-semibold text-muted-foreground">Remarque</div>
                    </div>
                    <!-- Rows generated by JS -->
                    <div id="meal-plan-grid" class="space-y-1">
                        <div class="p-10 text-center text-muted-foreground italic col-span-full">Chargement de la planification...</div>
                    </div>
                </div>
            </div>
        </section>
        `,script:"./view-plan.js"},"ai-suggestions":{html:`
        <div class="max-w-4xl mx-auto p-4 md:p-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                <div>
                    <h2 class="text-3xl font-bold text-gray-900 leading-tight">Mon Profil Chef IA</h2>
                    <p class="text-gray-500 mt-1">Découvrez vos habitudes et recevez des conseils personnalisés.</p>
                </div>
                <button id="refresh-ai-btn" class="btn btn-secondary shadow-sm hover:shadow-md transition-all">
                    <i class="fas fa-sync-alt mr-2"></i> Actualiser mon analyse
                </button>
            </div>

            <div id="ai-profile-container" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Statistiques Clés -->
                <div class="lg:col-span-2 space-y-6">
                    <div id="ai-stats-grid" class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <!-- Injected by JS -->
                    </div>
                    
                    <div id="ai-debug-wrapper" class="hidden">
                        <div class="bg-gray-900 rounded-xl p-4 shadow-inner mb-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-[10px] font-mono text-gray-500 uppercase tracking-wider">Diagnostics Techniques</span>
                                <button id="close-debug-btn" class="text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
                            </div>
                            <div id="ai-debug-info" class="text-green-400 text-[10px] font-mono overflow-x-auto max-h-60 space-y-1">
                                <!-- JS Injected -->
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-comment-alt-dots text-tomato mr-2"></i> Analyse du Chef Gusto
                        </h3>
                        <div id="ai-summary-text" class="text-gray-600 leading-relaxed min-h-[100px] flex items-center justify-center bg-gray-50 rounded-xl p-4 italic">
                            Cliquez sur "Actualiser" pour générer un résumé de vos habitudes alimentaires.
                        </div>
                    </div>
                </div>

                <!-- Recettes Favorites -->
                <div class="space-y-6">
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 h-full">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-heart text-red-500 mr-2"></i> Vos Incontournables
                        </h3>
                        <ul id="ai-top-recipes" class="space-y-3">
                            <!-- Injected by JS -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        `,script:"./ai-suggestions.js"},"shopping-mode":{html:`
        <div class="max-w-4xl mx-auto min-h-screen pb-20 md:pb-0 relative px-4">
            <div class="sticky top-0 bg-background z-20 pt-4 pb-3">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center space-x-3">
                        <button id="shopping-mode-back-btn" class="text-muted-foreground hover:text-tomato">
                            <i class="fas fa-arrow-left text-xl"></i>
                        </button>
                        <h2 class="text-2xl font-bold text-foreground">Faire les courses</h2>
                    </div>
                </div>
                <div class="flex justify-start items-center mb-4">
                    <label for="shopping-mode-plan-select" class="text-sm font-medium text-gray-700 mr-2">Menu:</label>
                    <select id="shopping-mode-plan-select" class="text-sm border-gray-300 rounded-md shadow-sm focus:ring-tomato focus:border-tomato font-medium text-gray-700 bg-white pr-8">
                        <option>Chargement...</option>
                    </select>
                </div>
            </div>
            
            <div id="shopping-mode-container" class="p-4 -mt-4">
                <p class="text-center text-muted-foreground mt-10">Chargement de la liste...</p>
            </div>
        </div>
        `,script:"./shopping-mode.js"}};let P=null;async function O(n){typeof P=="function"&&(P(),P=null);const e=me[n];if(e&&X){if(X.innerHTML=e.html,e.script)try{const i=await import(`${e.script}?v=${Date.now()}`);i.default&&typeof i.default=="function"&&(P=i.default())}catch(t){console.error(`Error loading module ${e.script}:`,t)}}else console.error(`Route not found: ${n}`)}let F=null;function pe(){return new Promise(n=>{de(_,e=>{if(F=e,e){console.log("User is logged in:",e.uid);const t=document.getElementById("logout-btn"),i=document.getElementById("profile-btn");t&&t.classList.remove("hidden"),i&&i.classList.remove("hidden"),t&&!t.hasAttribute("data-listener-attached")&&(t.addEventListener("click",()=>{V(_).catch(l=>{console.error("Sign Out Error",l)})}),t.setAttribute("data-listener-attached","true"));const s=document.getElementById("logout-btn-mobile");s&&!s.hasAttribute("data-listener-attached")&&(s.addEventListener("click",()=>{V(_).catch(l=>{console.error("Sign Out Error",l)})}),s.setAttribute("data-listener-attached","true")),n(e)}else{console.log("User not logged in. Redirecting to login.html");const t=window.location.origin+"/login.html";window.location.href!==t&&(window.location.href=t),n(null)}})})}function z(){return F?F.uid:null}function R(){return F}async function be(n){try{const e=h(b,"friend_requests",n);await C(e,{status:"accepted"})}catch(e){throw console.error("Erreur lors de l'acceptation de la demande d'ami: ",e),e}}async function ge(n,e){if(!(!n||!e))try{const t=h(b,"plans",n);await C(t,{collaborators:le(e),type:"collaborative"})}catch(t){console.error("Error adding collaborator: ",t)}}console.log("DEBUG: Loading notifications.js module");let Q=[],Z=[],ee=()=>{},te=()=>{};const o={btn:null,btnMobile:null,badge:null,badgeMobile:null,dropdown:null,list:null};async function fe(n,e,t){const i=z();if(i)try{const s=h(b,"shares",n);if(await C(s,{status:"accepted"}),e.plan){const l=t.displayName||"Inconnu",r=`Copie de "${e.plan.name}" (de ${l})`,c={...e.plan,userId:i,name:r,isShared:!0,originalOwnerId:e.senderId,sharedAt:new Date,collaborators:[]};delete c.id,await U(k(b,"plans"),c)}e.shoppingList&&await U(k(b,"shopping_lists"),{name:`${e.shoppingList.name} (de ${t.displayName})`,ingredients:e.shoppingList.ingredients,userId:i,isShared:!0,originalOwner:t.uid,sharedAt:new Date})}catch(s){console.error("Erreur lors de l'acceptation du partage : ",s),alert("Une erreur est survenue.")}}async function xe(n,e){const t=z();if(!(!t||!e||!e.planId))try{await ge(e.planId,t);const i=h(b,"shares",n);await C(i,{status:"accepted"})}catch(i){console.error("Erreur lors de l'acceptation de l'invitation : ",i),alert("Une erreur est survenue.")}}async function K(n){try{const e=h(b,"shares",n);await C(e,{status:"declined"})}catch(e){console.error("Erreur lors du refus du partage : ",e),alert("Une erreur est survenue.")}}async function ve(n){try{await be(n)}catch{alert("Erreur lors de l'acceptation.")}}function se(){if(!o.list)return;const n=[...Q,...Z];n.sort((t,i)=>i.createdAt.toMillis()-t.createdAt.toMillis());const e=t=>{t&&(n.length>0?(t.textContent=n.length,t.classList.remove("hidden")):t.classList.add("hidden"))};e(o.badge),e(o.badgeMobile),o.list.innerHTML="",n.length===0?o.list.innerHTML='<p class="text-gray-500 text-center p-4">Aucune nouvelle notification.</p>':n.forEach(t=>{const i=he(t);o.list.appendChild(i)})}function he(n){const e=document.createElement("div");e.className="p-3 border-b border-gray-100 hover:bg-gray-50";const t=document.createElement("p");t.className="text-sm font-medium text-gray-800";const i=document.createElement("p");i.className="text-xs text-gray-500 mb-3";const s=document.createElement("div");s.className="flex space-x-2 justify-end";const l=n.data.type||n.type;if(l==="collaborative_plan_invite"){t.textContent="Invitation à collaborer",i.textContent=`${n.sender.displayName} vous invite à modifier son plan "${n.data.planName}".`;const r=I("Accepter","btn-secondary",p=>{p.target.textContent="...",p.target.disabled=!0,xe(n.id,n.data)}),c=I("Refuser","text-red-500 hover:bg-red-50 px-3 py-1 rounded-md",p=>{p.target.disabled=!0,K(n.id)});s.append(r,c)}else if(l==="share"){t.textContent=`Partage de ${n.sender.displayName||n.sender.email}`;let r=[];n.data.plan&&r.push("planification"),n.data.shoppingList&&r.push("liste de courses"),i.textContent=`Contenu : ${r.join(" et ")}`;const c=I("Accepter","btn-secondary",v=>{v.target.textContent="...",v.target.disabled=!0,fe(n.id,n.data,n.sender)}),p=I("Refuser","text-red-500 hover:bg-red-50 px-3 py-1 rounded-md",v=>{v.target.disabled=!0,K(n.id)});s.append(c,p)}else if(l==="friend_request"){t.textContent="Invitation d'ami",i.textContent=`${n.sender.displayName||n.sender.email} vous a envoyé une invitation.`;const r=I("Accepter","btn-secondary",p=>{p.target.textContent="...",p.target.disabled=!0,ve(n.id)}),c=I("Refuser","text-red-500 hover:bg-red-50 px-3 py-1 rounded-md",p=>{});s.append(r,c)}return e.append(t,i,s),e}function I(n,e,t){const i=document.createElement("button");return i.className=`btn btn-xs ${e}`,i.textContent=n,i.addEventListener("click",s=>{s.stopPropagation(),t(s)}),i}function ye(n){const e=k(b,"shares"),t=D(e,S("receiverId","==",n),S("status","==","pending"));ee=H(t,async i=>{const s=[];for(const l of i.docs){const r=l.data(),c=await $(h(b,"users",r.senderId));c.exists()&&s.push({type:r.type||"share",id:l.id,data:r,sender:c.data(),createdAt:r.createdAt})}Q=s,se()},i=>{console.error("Erreur d'écoute des partages:",i)})}function we(n){const e=k(b,"friend_requests"),t=D(e,S("receiverId","==",n),S("status","==","pending"));te=H(t,async i=>{const s=[];for(const l of i.docs){const r=l.data(),c=await $(h(b,"users",r.senderId));c.exists()&&s.push({type:"friend_request",id:l.id,data:r,sender:c.data(),createdAt:r.createdAt})}Z=s,se()},i=>{console.error("Erreur d'écoute des invitations d'amis:",i)})}function Ee(){if(console.log("DEBUG: initNotifications called"),o.btn=document.getElementById("notifications-btn"),o.btnMobile=document.getElementById("notifications-btn-mobile"),o.badge=document.getElementById("notifications-badge"),o.badgeMobile=document.getElementById("notifications-badge-mobile"),o.dropdown=document.getElementById("notifications-dropdown"),o.list=document.getElementById("notifications-list"),console.log("DEBUG: Notification elements found:",{btn:!!o.btn,btnMobile:!!o.btnMobile,dropdown:!!o.dropdown}),!o.btn||!o.dropdown)return;const n=z();if(!n)return;ee(),te(),ye(n),we(n);const e=o.btn.cloneNode(!0);if(o.btn.parentNode.replaceChild(e,o.btn),o.btn=e,o.badge=document.getElementById("notifications-badge"),o.btnMobile){const i=o.btnMobile.cloneNode(!0);o.btnMobile.parentNode.replaceChild(i,o.btnMobile),o.btnMobile=i,o.badgeMobile=document.getElementById("notifications-badge-mobile")}const t=i=>{console.log("Notification click detected"),i.stopPropagation();const s=document.getElementById("notifications-dropdown");if(!s)return;if(s.classList.contains("hidden")){s.classList.remove("hidden"),document.body.appendChild(s);const r=window.innerWidth<768,p=(r?o.btnMobile:o.btn).getBoundingClientRect();Object.assign(s.style,{display:"block",position:"fixed",zIndex:"10000",top:`${p.bottom+8}px`,maxHeight:"80vh"}),r?Object.assign(s.style,{left:"50%",transform:"translateX(-50%)",width:"95vw",right:"auto"}):Object.assign(s.style,{left:"auto",right:`${window.innerWidth-p.right}px`,transform:"none",width:"20rem"})}else s.classList.add("hidden"),s.style.cssText=""};o.btn.addEventListener("click",t),o.btnMobile&&o.btnMobile.addEventListener("click",t),document.addEventListener("click",i=>{const s=document.getElementById("notifications-dropdown");s&&!s.classList.contains("hidden")&&(o.btn.contains(i.target)||o.btnMobile&&o.btnMobile.contains(i.target)||s.contains(i.target)||(s.classList.add("hidden"),s.style.cssText=""))})}class ke{constructor(){this.config={mode:"auto",forcedSeason:"Printemps",offSeasonBehavior:"last",recipeRules:{prioritizeSeasonal:!0,allowPartial:!0,warnOffSeason:!0},listRules:{limitSuggestions:!0,allowManualAdd:!0}},this.STORAGE_KEY="gustoplan_season_config",this.loadConfig()}loadConfig(){const e=localStorage.getItem(this.STORAGE_KEY);if(e)try{const t=JSON.parse(e);this.config={...this.config,...t,recipeRules:{...this.config.recipeRules,...t.recipeRules||{}},listRules:{...this.config.listRules,...t.listRules||{}}}}catch(t){console.error("Failed to parse seasonality config",t)}}saveConfig(){localStorage.setItem(this.STORAGE_KEY,JSON.stringify(this.config)),window.dispatchEvent(new CustomEvent("seasonality-config-changed",{detail:this.config}))}updateConfig(e){this.config={...this.config,...e},this.saveConfig()}getCurrentSeason(){if(this.config.mode==="disabled")return null;if(this.config.mode==="forced")return this.config.forcedSeason;const e=new Date().getMonth();return e===11||e===0||e===1?"Hiver":e>=2&&e<=4?"Printemps":e>=5&&e<=7?"Eté":e>=8&&e<=10?"Automne":"Printemps"}isMonthInSeason(e,t){return!0}getIngredientScore(e){if(this.config.mode==="disabled")return 2;if(this.getMonthsForCurrentDate(),!e.months||e.months.length===0){if(e.seasons&&e.seasons.length>0){const s=this.getCurrentSeason();return e.seasons.includes(s)?2:0}return 2}const t=this.getTargetMonthsForSeason(this.getCurrentSeason());return e.months.some(s=>t.includes(s))?2:0}getRecipeScore(e){if(this.config.mode==="disabled")return 2;const t=this.getCurrentSeason(),i=this.getTargetMonthsForSeason(t);let s=null;return e.months&&e.months.length>0?s=e.months.some(r=>i.includes(r))?2:0:e.seasons&&e.seasons.length>0&&(s=e.seasons.includes(t)?2:0),s!==null?s:2}getTargetMonthsForSeason(e){return{Printemps:["Mars","Avril","Mai"],Eté:["Juin","Juillet","Août"],Automne:["Septembre","Octobre","Novembre"],Hiver:["Décembre","Janvier","Février"]}[e]||[]}getMonthsForCurrentDate(){const e=["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"],t=new Date().getMonth();return[e[t]]}}const Y=new ke;function Se(){const n=document.getElementsByName("season-mode"),e=document.getElementById("forced-season-selector"),t=document.getElementById("forced-season-select"),i=document.getElementById("off-season-behavior"),s=document.getElementById("rule-prioritize-seasonal"),l=document.getElementById("rule-warn-off-season"),r=document.getElementById("settings-modal"),c=document.getElementById("close-settings-modal"),p=document.getElementById("header-settings-btn"),v=document.getElementById("save-settings-btn"),y=document.getElementById("settings-friends-list"),u=document.getElementById("settings-friends-search-input"),B=document.getElementById("settings-friends-search-btn"),w=document.getElementById("settings-friends-search-results");let d={},g=null;function x(){r&&(d={...Y.config},oe(d),r.classList.remove("hidden"),ne())}function E(){r&&r.classList.add("hidden"),g&&(g(),g=null)}function M(){Y.updateConfig(d),E()}p&&p.addEventListener("click",x),c&&c.addEventListener("click",E),v&&v.addEventListener("click",M),r&&r.addEventListener("click",a=>{a.target===r&&E()}),B&&B.addEventListener("click",()=>J(u.value)),u&&u.addEventListener("keyup",a=>{a.key==="Enter"&&J(u.value)});async function ne(){const a=R()?.uid;if(!a||!y)return;y.innerHTML='<p class="text-xs text-center text-gray-500 py-4"><i class="fas fa-spinner fa-spin mr-2"></i>Chargement des amis...</p>';const m=h(b,"users",a);g=H(m,async f=>{if(!f.exists())return;const A=f.data().friends||[];if(y.innerHTML="",A.length===0){y.innerHTML=`
                    <div class="text-center py-6 bg-gray-50 dark:bg-gray-700/30 rounded-xl border border-dashed border-gray-200 dark:border-gray-600">
                        <i class="fas fa-user-friends text-gray-300 text-2xl mb-2 block"></i>
                        <p class="text-xs text-gray-400">Aucun ami pour le moment</p>
                    </div>`;return}for(const j of A)try{const L=await $(h(b,"users",j));L.exists()&&y.appendChild(ie(L.data()))}catch(L){console.error("Erreur de chargement d'un ami",L)}})}function ie(a){const m=document.createElement("div");m.className="flex items-center justify-between p-2 bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 rounded-lg shadow-sm",m.innerHTML=`
            <div class="flex items-center">
                <img src="${a.photoURL||"https://placehold.co/32"}" class="w-8 h-8 rounded-full mr-2 object-cover">
                <div class="leading-tight">
                    <p class="text-xs font-bold text-gray-800 dark:text-gray-200">${a.displayName}</p>
                    <p class="text-[10px] text-gray-400">${a.email}</p>
                </div>
            </div>
        `;const f=document.createElement("button");return f.className="text-gray-400 hover:text-red-500 p-1.5 transition-colors",f.innerHTML='<i class="fas fa-user-minus"></i>',f.onclick=()=>ae(a.uid),m.appendChild(f),m}async function ae(a){const m=R()?.uid;if(!(!m||!confirm("Retirer cet ami ?")))try{await C(h(b,"users",m),{friends:ce(a)})}catch{alert("Erreur lors de la suppression")}}async function J(a){if(!a||!w)return;const m=R()?.uid;w.innerHTML='<p class="text-[10px] text-center text-gray-500"><i class="fas fa-spinner fa-spin mr-1"></i>Recherche...</p>';try{const f=a.toLowerCase(),A=D(k(b,"users"),S("email","==",f)),j=await W(A);if(w.innerHTML="",j.empty){w.innerHTML='<p class="text-[10px] text-center text-gray-400 italic">Aucun utilisateur trouvé par email</p>';return}j.forEach(L=>{const N=L.data();if(N.uid===m)return;const T=document.createElement("div");T.className="flex items-center justify-between p-2 bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 rounded-lg shadow-sm",T.innerHTML=`
                    <div class="flex items-center">
                        <img src="${N.photoURL||"https://placehold.co/24"}" class="w-6 h-6 rounded-full mr-2">
                        <span class="text-xs font-medium text-gray-700 dark:text-gray-300 truncate max-w-[120px]">${N.displayName}</span>
                    </div>
                `;const q=document.createElement("button");q.className="bg-tomato/10 hover:bg-tomato text-tomato hover:text-white px-2 py-1 rounded text-[10px] font-bold transition-all",q.textContent="Ajouter",q.onclick=()=>re(N.uid),T.appendChild(q),w.appendChild(T)})}catch{w.innerHTML='<p class="text-[10px] text-red-500 text-center">Erreur de recherche</p>'}}async function re(a){const m=R()?.uid;if(m)try{const f=D(k(b,"friend_requests"),S("senderId","==",m),S("receiverId","==",a));if(!(await W(f)).empty)return alert("Demande déjà envoyée");await U(k(b,"friend_requests"),{senderId:m,receiverId:a,status:"pending",createdAt:ue()}),alert("Demande envoyée !"),w.innerHTML="",u.value=""}catch{alert("Erreur d'envoi")}}function oe(a){Array.from(n).forEach(m=>{m.value===a.mode&&(m.checked=!0)}),G(a.mode),a.forcedSeason&&(t.value=a.forcedSeason),a.offSeasonBehavior&&(i.value=a.offSeasonBehavior),s&&(s.checked=a.recipeRules?.prioritizeSeasonal||!1),l&&(l.checked=a.recipeRules?.warnOffSeason||!1)}Array.from(n).forEach(a=>{a.addEventListener("change",m=>{d.mode=m.target.value,G(m.target.value)})}),t.addEventListener("change",a=>{d.forcedSeason=a.target.value}),i.addEventListener("change",a=>{d.offSeasonBehavior=a.target.value}),s&&s.addEventListener("change",a=>{d.recipeRules={...d.recipeRules,prioritizeSeasonal:a.target.checked}}),l&&l.addEventListener("change",a=>{d.recipeRules={...d.recipeRules,warnOffSeason:a.target.checked}});function G(a){a==="forced"?e.classList.remove("hidden"):e.classList.add("hidden")}}function Me(){const n=R();if(n){const t=document.getElementById("user-display-name");t&&(t.textContent=n.displayName||n.email)}const e=document.querySelectorAll(".nav-btn");e.forEach(t=>{t.addEventListener("click",i=>{const s=i.currentTarget.dataset.path;O(s),e.forEach(l=>{l.classList.remove("bg-tomato","text-white"),l.classList.add("bg-white","text-tomato")}),i.currentTarget.classList.add("bg-tomato","text-white"),i.currentTarget.classList.remove("bg-white","text-tomato")})}),O("menu"),console.log("DEBUG: Calling initNotifications..."),Ee(),Se()}document.addEventListener("DOMContentLoaded",()=>{pe().then(d=>{d&&Me()});const n=document.getElementById("profile-btn"),e=document.getElementById("profile-menu"),t=document.getElementById("user-display-name");if(n&&e){const d=g=>{g.stopPropagation(),e.classList.toggle("hidden");const x=!e.classList.contains("hidden");n.setAttribute("aria-expanded",x)};n.addEventListener("click",d),t&&(t.addEventListener("click",d),t.style.cursor="pointer"),document.addEventListener("click",g=>{!(e.contains(g.target)||n.contains(g.target)||t&&t.contains(g.target))&&!e.classList.contains("hidden")&&(e.classList.add("hidden"),n.setAttribute("aria-expanded","false"))})}const i=document.getElementById("settings-link"),s=document.getElementById("settings-modal"),l=document.getElementById("close-settings-modal"),r=document.getElementById("dark-mode-toggle"),c=d=>{d==="dark"?(document.documentElement.classList.add("dark"),r&&(r.checked=!0)):(document.documentElement.classList.remove("dark"),r&&(r.checked=!1))},p=localStorage.getItem("theme");p?c(p):window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?c("dark"):c("light"),i&&s&&i.addEventListener("click",d=>{d.preventDefault(),s.classList.remove("hidden")}),l&&s&&l.addEventListener("click",()=>{s.classList.add("hidden")}),s&&s.addEventListener("click",d=>{d.target===s&&s.classList.add("hidden")}),r&&r.addEventListener("change",()=>{const d=r.checked?"dark":"light";localStorage.setItem("theme",d),c(d)});const v=document.getElementById("mobile-menu-btn"),y=document.getElementById("mobile-menu");let u=null;v&&y?(console.log("Mobile menu initialized (Overlay Mode)"),v.addEventListener("click",d=>{d.stopPropagation(),u?(u.remove(),u=null):(u=document.createElement("div"),u.id="mobile-menu-overlay-container",u.innerHTML=y.innerHTML,Object.assign(u.style,{position:"fixed",top:"60px",left:"0",width:"100%",backgroundColor:"#3D405B",zIndex:"10000",boxShadow:"0 4px 6px rgba(0,0,0,0.1)",padding:"1rem",display:"block"}),u.addEventListener("click",g=>{const x=g.target.closest("button");if(!x)return;const E=x.dataset.path;if(E)console.log("Overlay: Navigating directly to",E),O(E);else if(x.id==="profile-btn-mobile")console.log("Overlay: Opening settings"),s&&s.classList.remove("hidden");else{let M=null;x.id&&(M=document.getElementById(x.id)),M?(console.log("Overlay: Delegating click to original:",M),M.click()):console.warn("Overlay: No action found for",x)}u&&(u.remove(),u=null)}),document.body.appendChild(u))}),document.addEventListener("click",d=>{u&&!u.contains(d.target)&&!v.contains(d.target)&&(u.remove(),u=null)})):console.warn("Mobile menu elements missing");const B=document.getElementById("profile-btn-mobile");B&&s&&B.addEventListener("click",()=>{s.classList.remove("hidden")}),document.querySelectorAll(".nav-btn-mobile").forEach(d=>{d.addEventListener("click",g=>{const x=g.currentTarget.dataset.path;O(x)})})});
