const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/main-BGm1g1S0.js","assets/firebase-config-CDPbqvnt.js","assets/login-T7ppBFTz.css"])))=>i.map(i=>d[i]);
import{b as mt,i as pt,a as ft,s as Pe,g as ye,_ as Te,c as yt,p as ht}from"./main-BGm1g1S0.js";import{r as he,j as He,k as gt,l as vt,m as xt,n as Lt,p as Et,t as je,d as B,o as bt,c as oe,b as Ct,g as ge,a as Q,h as Fe,q as Ae,v as It,x as Re,s as wt,f as kt,u as Bt,w as Mt}from"./firebase-config-CDPbqvnt.js";import{R as St,t as Dt}from"./recipes-uktjmjHd.js";import{o as Nt,a as $t}from"./sharing-DASuy-ML.js";let K=null,ne=null;function Pt(l,ae){if(!he||!l)return;const Y=mt();if(!Y)return;const $=He(he,`plans_presence/${l}`);K=He(he,`plans_presence/${l}/${Y.uid}`);const T={displayName:Y.displayName||Y.email,photoURL:Y.photoURL,status:"idle",last_seen:je()};gt(K).remove(),vt(K,T),ne&&ne(),ne=xt($,g=>{const R=g.val()||{};typeof ae=="function"&&ae(R)})}function Tt(){K&&(Et(K),K=null),ne&&(ne(),ne=null)}function ve(l){K&&Lt(K,{status:l,last_seen:je()})}let G=null;function jt(){const l={mealPlanGrid:document.getElementById("meal-plan-grid"),currentWeekDisplay:document.getElementById("current-week-display"),prevWeekBtn:document.getElementById("prev-week-btn"),nextWeekBtn:document.getElementById("next-week-btn"),clearMenuBtn:document.getElementById("clear-menu-btn"),shoppingListContainer:document.getElementById("shopping-list"),startDaySelect:document.getElementById("start-day-select"),defaultServingsControl:document.getElementById("default-servings-control"),mealSelectModal:document.getElementById("meal-select-modal"),closeMealSelectModalBtn:document.getElementById("close-meal-select-modal"),mealSelectModalTitle:document.getElementById("meal-select-modal-title"),mealSelectList:document.getElementById("meal-select-list"),recipeFormModal:document.getElementById("edit-recipe-form-modal"),closeRecipeModalBtn:document.getElementById("close-edit-recipe-modal"),cancelRecipeBtn:document.getElementById("edit-cancel-recipe-btn"),recipeForm:document.getElementById("edit-recipe-form"),addItemInput:document.getElementById("add-item-input"),addItemBtn:document.getElementById("add-item-btn"),addItemResults:document.getElementById("add-item-results"),importListBtn:document.getElementById("import-list-btn"),importListModal:document.getElementById("import-list-modal"),closeImportListModalBtn:document.getElementById("close-import-list-modal"),importListContainer:document.getElementById("import-list-container"),exportTxtBtn:document.getElementById("export-txt-btn"),exportPdfBtn:document.getElementById("export-pdf-btn"),exportPlanPdfBtn:document.getElementById("export-plan-pdf-btn"),sharePlanBtn:document.getElementById("share-plan-btn"),planSelect:document.getElementById("plan-select"),inviteParticipantBtn:document.getElementById("invite-participant-btn"),historyPlanBtn:document.getElementById("history-plan-btn"),planHistoryModal:document.getElementById("plan-history-modal"),closePlanHistoryModalBtn:document.getElementById("close-plan-history-modal"),planHistoryList:document.getElementById("plan-history-list"),savePlanBtn:document.getElementById("save-plan-btn"),openTrashBtn:document.getElementById("open-trash-btn"),trashCount:document.getElementById("trash-count"),trashModal:document.getElementById("trash-modal"),closeTrashModalBtn:document.getElementById("close-trash-modal"),trashListContainer:document.getElementById("trash-list-container"),emptyTrashBtn:document.getElementById("empty-trash-btn")};function ae(e,t){const n=document.createElement("div");n.className="flex items-center space-x-2";const r=document.createElement("button");r.className="btn btn-outline btn-xs",r.textContent="-";const a=document.createElement("span");a.className="font-medium text-center w-6",a.textContent=e;const i=document.createElement("button");return i.className="btn btn-outline btn-xs",i.textContent="+",r.addEventListener("click",()=>{let o=parseInt(a.textContent,10);o>1&&(o--,a.textContent=o,t(o))}),i.addEventListener("click",()=>{let o=parseInt(a.textContent,10);o++,a.textContent=o,t(o)}),n.appendChild(r),n.appendChild(a),n.appendChild(i),n}function Y(e,t,n,r=!1){const a=document.createElement("div");a.className="flex flex-col items-center justify-center h-full";const i=document.createElement("button");i.className="text-gray-600 hover:bg-gray-100 p-0 h-4 flex items-center justify-center w-full rounded-md",i.innerHTML='<i class="fas fa-plus"></i>',i.disabled=r;const o=document.createElement("span");o.className="font-medium text-center text-sm my-1",o.textContent=e;const s=document.createElement("button");return s.className="text-gray-600 hover:bg-gray-100 p-0 h-4 flex items-center justify-center w-full rounded-md",s.innerHTML='<i class="fas fa-minus"></i>',s.disabled=r,t&&(i.classList.add("text-white"),o.classList.add("text-white"),s.classList.add("text-white")),r||(i.addEventListener("click",()=>{let c=parseInt(o.textContent,10);c++,o.textContent=c,n(c)}),s.addEventListener("click",()=>{let c=parseInt(o.textContent,10);c>1&&(c--,o.textContent=c,n(c))})),a.appendChild(i),a.appendChild(o),a.appendChild(s),a}G&&G.destroy(),G=new St(B,"edit-recipe-form-modal","edit-recipe-form","edit-recipe-modal-title","edit-recipe-id","edit-recipe-name","edit-recipe-category","edit-recipe-servings","edit-recipe-prep-time","edit-recipe-difficulty","edit-recipe-steps","edit-ingredients-list","edit-add-ingredient-btn","edit-save-recipe-btn","close-edit-recipe-modal","edit-cancel-recipe-btn"),G.setActivityUpdater(ve),G.setOnSaveCallback(async()=>{});let $=1,T="Lundi",g={},R={},F={};const O=[];let X=null,z=[],se=[],j=1,ee=null,xe=[],m=null;const _=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];function ie(e){return e?e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase():""}function qe(e){return e?e.replace(/\./g,"_"):""}async function _e(e){const t=document.getElementById("unit-select-modal"),n=document.getElementById("unit-modal-title"),r=document.getElementById("unit-modal-list"),a=document.getElementById("unit-modal-cancel");return n.textContent=`Choisir une unité pour "${e}"`,r.innerHTML="",new Promise((i,o)=>{const s=["g","kg","ml","l","pièce(s)","c.à.s.","c.à.c.","pincée(s)"],c=u=>{t.classList.add("hidden"),i(u)};s.forEach(u=>{const p=document.createElement("button");p.className="btn btn-outline",p.textContent=u,p.addEventListener("click",()=>c(u)),r.appendChild(p)});const d=()=>{t.classList.add("hidden"),o()};a.addEventListener("click",d,{once:!0}),t.addEventListener("click",u=>{u.target===t&&d()},{once:!0}),t.classList.remove("hidden")})}async function Le(){if(B)try{se=(await ge(oe(B,"ingredients"))).docs.map(t=>({id:t.id,...t.data()})),se.sort((t,n)=>t.name.localeCompare(n.name))}catch(e){console.error("Erreur lors de la récupération des ingrédients: ",e)}}function Ee(){if(!m)g={},R={},F={},j=1,T="Lundi";else{const e=m.weeks?m.weeks[$]||{}:{};g=e.menuData||{},R=e.servingsData||{},F=e.remarksData||{},j=m.defaultNumPeople||1,T=m.startDay||"Lundi"}if(l.startDaySelect&&(l.startDaySelect.value=T),l.defaultServingsControl){l.defaultServingsControl.innerHTML="";const e=ae(j,async t=>{j=t,m&&await V({defaultNumPeople:t},`a changé le nombre de personnes par défaut à ${t}`)});l.defaultServingsControl.appendChild(e)}it(),le(l.mealPlanGrid,{menuData:g,servingsData:R,remarksData:F,defaultNumPeople:j,startDay:T},!1),be(document.getElementById("mobile-meal-plan"),{menuData:g,servingsData:R,remarksData:F,defaultNumPeople:j,startDay:T},!1),ce()}async function V(e,t){if(!m)return;await Pe(m.id,m,t);const n=Q(B,"plans",m.id);try{await Bt(n,{...e,lastUpdated:new Date})}catch(r){console.error("Error updating plan:",r),alert("Une erreur de sauvegarde est survenue.")}}function me(){l.planHistoryModal.classList.add("hidden")}async function Ue(e){if(m&&confirm("Voulez-vous vraiment restaurer cette version ? L'état actuel sera sauvegardé dans l'historique avant la restauration."))try{const t=Q(B,"plans",m.id,"history",e),n=await Fe(t);if(!n.exists())throw new Error("Version de l'historique non trouvée.");const r=n.data().planState;await Pe(m.id,m);const a=Q(B,"plans",m.id);await wt(a,r),me()}catch(t){console.error("Erreur lors du rollback :",t)}}async function Oe(e,t){if(m&&confirm("Êtes-vous sûr de vouloir supprimer définitivement cette entrée de l'historique ?"))try{const n=Q(B,"plans",m.id,"history",e);await kt(n),t.remove()}catch(n){console.error("Erreur lors de la suppression de l'historique :",n),alert("Une erreur est survenue lors de la suppression.")}}async function ze(){if(m){l.planHistoryList.innerHTML="<p>Chargement de l'historique...</p>",l.planHistoryModal.classList.remove("hidden");try{const e=oe(B,"plans",m.id,"history"),t=Ae(e,It("timestamp","desc")),n=await ge(t);if(l.planHistoryList.innerHTML="",n.empty){l.planHistoryList.innerHTML="<p>Aucun historique pour ce plan.</p>";return}n.forEach(r=>{const a=r.data(),i=document.createElement("div");i.className="p-3 border-b flex justify-between items-center";const o=document.createElement("div"),s=a.timestamp?.toDate().toLocaleString("fr-FR")||"Date inconnue",c=a.description||"Modification diverse",d=a.modifiedByName||"Inconnu";o.innerHTML=`
                    <p class="font-medium">${d} ${c}</p>
                    <p class="text-sm text-gray-500">${s}</p>
                `;const u=document.createElement("div");u.className="flex items-center space-x-2";const p=document.createElement("button");p.className="btn btn-secondary btn-sm",p.textContent="Revenir à cette version",p.addEventListener("click",()=>Ue(r.id));const f=document.createElement("button");f.className="text-red-500 hover:bg-red-100 text-sm px-3 py-1 rounded-md",f.innerHTML='<i class="fas fa-times"></i>',f.title="Supprimer cette version",f.addEventListener("click",y=>{y.stopPropagation(),Oe(r.id,i)}),u.appendChild(p),u.appendChild(f),i.appendChild(o),i.appendChild(u),l.planHistoryList.appendChild(i)})}catch(e){console.error("Erreur de chargement de l'historique:",e),l.planHistoryList.innerHTML=`<p class="text-red-500">Impossible de charger l'historique.</p>`}}}function be(e,t,n=!1){if(!e)return;const r=t.menuData||{},a=t.servingsData||{},i=t.remarksData||{},o=t.defaultNumPeople||1,s=t.startDay||"Lundi";e.innerHTML="";const c=document.createDocumentFragment(),d=_.indexOf(s);[..._.slice(d),..._.slice(0,d)].forEach(p=>{const f=_.indexOf(p),y=document.createElement("div");y.className="bg-blue-100 border border-blue-300 rounded-xl shadow-md p-4 mb-4";const h=document.createElement("h3");h.className="text-xl font-bold text-gray-800 mb-3",h.textContent=p.toUpperCase(),y.appendChild(h);const b=document.createElement("div");b.className="space-y-4",["lunch","dinner"].forEach(L=>{const C=document.createElement("div");C.className=`border-t pt-3 ${L==="lunch"?"bg-amber-50":"bg-stone-100"} rounded-lg p-2`;const w=document.createElement("div");w.className="flex justify-between items-center mb-2";const k=document.createElement("h4");if(k.className="text-lg font-semibold text-tomato",k.textContent=L==="lunch"?"Midi":"Soir",w.appendChild(k),!n){const I=`${f}-${L}`,E=a[I]||o,v=ae(E,x=>{$e(I,x)});w.appendChild(v)}C.appendChild(w);const S=document.createElement("div");S.className="space-y-2";let A=!1;const D=["Entrée","Plat","Accompagnement","Dessert","Remarque"];for(let I=0;I<D.length;I++){const E=D[I],v=`${f}-${L}-${I}`,x=r[v],P=document.createElement("div");P.className="mb-2";const H=document.createElement("h5");if(H.className="text-md font-semibold text-gray-700 mb-1",H.textContent=E,P.appendChild(H),E==="Remarque")P.appendChild(Me(v,i,n));else{const M=document.createElement("div");if(M.className="space-y-1",Array.isArray(x)&&x.length>0&&(A=!0,x.forEach((N,ue)=>{const W=z.find(q=>q.id===N.id);if(W){const q=ke(W,v,ue,n);if(q.classList.remove("bg-white","shadow-sm"),q.classList.add("bg-emerald-200","border","border-emerald-400"),!n){const U=q.querySelector(".edit-meal-btn"),te=q.querySelector(".delete-meal-btn");U&&U.classList.remove("hidden"),te&&te.classList.remove("hidden")}M.appendChild(q)}})),n)A||(M.innerHTML='<p class="text-sm text-gray-500 italic">Aucun plat prévu.</p>');else{const N=document.createElement("button");N.className="btn btn-outline btn-sm w-full mt-2",N.innerHTML=`<i class="fas fa-plus mr-2"></i> Ajouter une ${E.toLowerCase()}`,N.addEventListener("click",()=>{we(v)}),M.appendChild(N)}P.appendChild(M)}S.appendChild(P)}C.appendChild(S),b.appendChild(C)}),y.appendChild(b),c.appendChild(y)}),e.appendChild(c)}function le(e,t,n=!1){if(!e)return;const r=t.menuData||{},a=t.servingsData||{},i=t.remarksData||{},o=t.defaultNumPeople||1,s=t.startDay||"Lundi",c=document.createDocumentFragment(),d=["lunch","dinner"],u=5,p=_.indexOf(s);[..._.slice(p),..._.slice(0,p)].forEach(y=>{const h=_.indexOf(y),b=document.createElement("div");b.className="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] items-stretch border-b border-gray-300";const L=document.createElement("div");L.className="font-bold p-2 flex items-center justify-center bg-gray-100 text-sm border-r border-gray-300",L.textContent=y.toUpperCase(),b.appendChild(L),d.forEach(C=>{const w=`${h}-${C}`,k=a[w]||o,S=a.hasOwnProperty(w),A=document.createElement("div"),D=Y(k,S,E=>{$e(w,E)},n);let I="border-r border-gray-300 flex items-center justify-center transition-colors duration-300";S?I+=" bg-tomato":I+=C==="lunch"?" bg-amber-50":" bg-stone-100",A.className=I,A.appendChild(D),b.appendChild(A);for(let E=0;E<u;E++){const v=`${h}-${C}-${E}`,x=r[v],P=document.createElement("div"),H=re(v);let M="meal-slot p-1 min-h-[70px] flex flex-col justify-start border-r border-gray-300";if(M+=C==="lunch"?" bg-amber-50":" bg-stone-100",P.className=M,P.dataset.slotId=v,H==="Remarque")P.appendChild(Me(v,i,n));else if(Array.isArray(x)&&x.length>0){const N=document.createElement("div");N.className="w-full",x.forEach((ue,W)=>{const q=z.find(U=>U.id===ue.id);if(q)N.appendChild(ke(q,v,W,n));else{const U=document.createElement("div");U.className="p-1 bg-red-100 text-red-700 rounded shadow-sm text-center text-xs font-medium",U.textContent="Recette supprimée",N.appendChild(U)}}),P.appendChild(N),n||P.appendChild(Be(v,!0))}else n||P.appendChild(Be(v,!1));b.appendChild(P)}}),c.appendChild(b)}),e.innerHTML="",e.appendChild(c),n||st()}async function Qe(){const e=ye();if(!B||!e)return[];try{const t=Ae(oe(B,"shopping_lists"),Mt("userId","==",e));return(await ge(t)).docs.map(i=>({id:i.id,...i.data()})).filter(i=>i.isShared!==!0)}catch(t){return console.error("Erreur de chargement des listes de courses sauvegardées: ",t),[]}}async function Ve(){const e=await Qe();if(l.importListContainer.innerHTML="",e.length===0){l.importListContainer.innerHTML='<p class="text-center text-gray-500">Aucune liste sauvegardée.</p>';return}e.forEach(t=>{const n=document.createElement("button");n.className="w-full text-left p-2 hover:bg-gray-100 rounded-lg transition-colors duration-150",n.textContent=t.name,n.addEventListener("click",()=>{confirm(`Voulez-vous vraiment importer les ingrédients de la liste "${t.name}" ?`)&&(t.ingredients.forEach(r=>{const a=parseFloat(String(r.quantity).replace(",","."))||0;Z(r.name,a,r.unit)}),pe())}),l.importListContainer.appendChild(n)}),l.importListModal.classList.remove("hidden")}function pe(){l.importListModal.classList.add("hidden")}function We(){l.addItemInput?.addEventListener("input",()=>{const e=l.addItemInput.value.toLowerCase(),t=l.addItemResults;if(t.innerHTML="",!e){t.classList.add("hidden");return}se.filter(a=>a.name.toLowerCase().includes(e)).forEach(a=>{const i=document.createElement("div");i.className="p-2 hover:bg-gray-100 cursor-pointer",i.textContent=a.name,i.addEventListener("click",()=>{Z(a.name,1,a.unit),l.addItemInput.value="",t.classList.add("hidden")}),t.appendChild(i)});const r=document.createElement("div");r.className="p-2 bg-green-50 hover:bg-green-200 cursor-pointer font-bold text-green-700",r.textContent=`+ Créer "${l.addItemInput.value}"`,r.addEventListener("click",async()=>{const a=l.addItemInput.value;try{const i=await _e(a);await Ct(oe(B,"ingredients"),{name:a,unit:i}),await Le(),Z(a,1,i),l.addItemInput.value="",t.classList.add("hidden")}catch{}}),t.appendChild(r),t.classList.remove("hidden")}),l.addItemBtn?.addEventListener("click",()=>{const e=l.addItemInput.value;e&&(Z(e,1,""),l.addItemInput.value="",l.addItemResults.classList.add("hidden"))}),document.addEventListener("click",e=>{l.addItemInput&&!l.addItemInput.contains(e.target)&&!l.addItemResults.contains(e.target)&&l.addItemResults.classList.add("hidden")})}function Je(){if(O.length===0){alert("La liste de courses est vide.");return}const e=O.reduce((a,i)=>{const o=i.category||"Inconnue";return a[o]||(a[o]=[]),a[o].push(i),a},{}),t=Object.keys(e).sort((a,i)=>a==="Inconnue"?1:i==="Inconnue"?-1:a.localeCompare(i));let n=`Liste de courses - GustoPlan

`;t.forEach(a=>{n+=`--- ${a.toUpperCase()} ---
`,e[a].sort((o,s)=>o.name.localeCompare(s.name)).forEach(o=>{let c=`${Number.isInteger(o.totalQuantity)?o.totalQuantity:parseFloat(o.totalQuantity.toFixed(2))} ${o.unit||""} ${o.name}`;if(o.sources&&o.sources.length>0){const d=o.sources.reduce((p,f)=>{const y=`${f.recipeName} (${f.day} ${f.time})`;return p[y]||(p[y]=0),p[y]+=f.quantity,p},{}),u=Object.keys(d).join(" / ");c+=` *** ${u} ***`}n+=c+`
`}),n+=`
`});const r=new Blob([n],{type:"text/plain;charset=utf-8"});saveAs(r,"liste-de-courses.txt")}function Ge(){if(O.length===0){alert("La liste de courses est vide.");return}const{jsPDF:e}=window.jspdf,t=new e,n=O.reduce((c,d)=>{const u=d.category||"Inconnue";return c[u]||(c[u]=[]),c[u].push(d),c},{}),r=Object.keys(n).sort((c,d)=>c==="Inconnue"?1:d==="Inconnue"?-1:c.localeCompare(d));t.setFontSize(18),t.text("Liste de courses - GustoPlan",14,22);let a=35;const i=t.internal.pageSize.height,o=20,s=()=>{a>i-o&&(t.addPage(),a=20)};r.forEach(c=>{s(),t.setFontSize(14),t.setFont(void 0,"bold"),t.text(`--- ${c.toUpperCase()} ---`,14,a),a+=8,t.setFont(void 0,"normal"),n[c].sort((u,p)=>u.name.localeCompare(p.name)).forEach(u=>{s(),t.setFontSize(12);const p=Number.isInteger(u.totalQuantity)?u.totalQuantity:parseFloat(u.totalQuantity.toFixed(2));if(t.text(`${p} ${u.unit||""} ${u.name}`,14,a),a+=6,u.sources&&u.sources.length>0){const f=u.sources.reduce((y,h)=>{const b=`${h.recipeName} (${h.day} ${h.time})`;return y[b]||(y[b]=0),y[b]+=h.quantity,y},{});t.setFontSize(9),t.setTextColor(100);for(const y in f)s(),t.text(`  * ${y}`,18,a),a+=5;t.setTextColor(0)}a+=2}),a+=5}),t.save("liste-de-courses.pdf")}async function Ke(){if(!m){alert("Veuillez sélectionner un plan à exporter.");return}const e=document.getElementById("loading-overlay");e&&e.classList.remove("hidden");try{const{jsPDF:t}=window.jspdf,n=new t,r=Q(B,"plans",m.id),a=await Fe(r),i=a.exists()?a.data():null;if(!i||!i.weeks){alert("Ce plan est vide et ne peut pas être exporté.");return}n.setFontSize(18),n.text(`Plan de Repas: ${i.name}`,14,20);const o=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"],s={0:"E",1:"P",2:"A",3:"D"},c=Object.keys(i.weeks).sort((u,p)=>parseInt(u)-parseInt(p));let d=!0;for(const u of c){const f=i.weeks[u].menuData||{};if(Object.keys(f).length===0)continue;const y=[["Jour","Midi","Soir"]],h=[],b=o.indexOf(i.startDay||"Lundi"),L=[...o.slice(b),...o.slice(0,b)];for(const w of L){const k=o.indexOf(w);let S=[],A=[];for(const D of["lunch","dinner"])for(const I in s){const E=`${k}-${D}-${I}`;f[E]&&Array.isArray(f[E])&&f[E].forEach(v=>{const x=`[${s[I]}] ${v.name}`;D==="lunch"?S.push(x):A.push(x)})}h.push([w,S.join(`
`)||"-",A.join(`
`)||"-"])}n.setFontSize(14);const C=d?30:n.autoTable.previous.finalY+20;n.text(`Semaine ${u}`,14,C-5),n.autoTable({startY:C,head:y,body:h,theme:"grid",styles:{cellPadding:2,fontSize:8,valign:"middle"},headStyles:{fillColor:[41,128,185],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[245,245,245]}}),d=!1}n.save(`plan_${i.name.replace(/ /g,"_")}.pdf`)}catch(t){console.error("Erreur lors de la génération du PDF du plan :",t),alert("Une erreur est survenue lors de la création du PDF.")}finally{e&&e.classList.add("hidden")}}async function Z(e,t,n,r=!1){if(!m)return alert("Veuillez sélectionner un plan.");const a=Q(B,"plans",m.id);try{await Re(B,async i=>{const o=await i.get(a);if(!o.exists())throw"Le plan n'existe plus.";const s=o.data().manualItems||[],c=`${e.trim().toLowerCase()}_${n||""}`,d=s.findIndex(p=>`${p.name.trim().toLowerCase()}_${p.unit||""}`===c);if(d>-1)s[d].totalQuantity+=t;else{const p=se.find(f=>f.name.toLowerCase()===e.trim().toLowerCase());s.push({name:e.trim(),totalQuantity:t,unit:n,source:"manual",category:p?.category||"Inconnue"})}const u=s.filter(p=>p.totalQuantity!==0);i.update(a,{manualItems:u,lastUpdated:new Date})})}catch(i){console.error("Erreur transactionnelle lors de l'ajustement de l'ingrédient: ",i),alert("Une erreur de synchronisation est survenue. Veuillez réessayer.")}}function Ce(e){const t=e?e.toLowerCase():"";return t.includes("g")||t.includes("ml")?10:1}function Ye(e){if(l.openTrashBtn&&(l.openTrashBtn.classList.remove("hidden"),l.trashCount&&(l.trashCount.textContent=e.length,e.length>0?(l.trashCount.classList.remove("bg-gray-200"),l.trashCount.classList.add("bg-red-500","text-white")):(l.trashCount.classList.add("bg-gray-200"),l.trashCount.classList.remove("bg-red-500","text-white")))),e&&e.length>0){if(l.emptyTrashBtn){l.emptyTrashBtn.classList.remove("hidden");const t=l.emptyTrashBtn.cloneNode(!0);l.emptyTrashBtn.parentNode.replaceChild(t,l.emptyTrashBtn),l.emptyTrashBtn=t,l.emptyTrashBtn.addEventListener("click",async()=>{if(!m||!confirm("Voulez-vous supprimer définitivement tous les éléments de la corbeille ?"))return;const n=Q(B,"plans",m.id),r=e.map(a=>`${a.name}_${a.unit||""}`);try{await Te(()=>import("./main-BGm1g1S0.js").then(a=>a.d),__vite__mapDeps([0,1,2])).then(a=>{a.updateDoc(n,{hiddenTrashItems:a.arrayUnion(...r),lastUpdated:new Date})}),l.trashModal.classList.add("hidden")}catch(a){console.error("Erreur vidage corbeille:",a)}})}if(l.trashListContainer){l.trashListContainer.innerHTML="";const t=document.createElement("ul");t.className="space-y-2",e.forEach(n=>{const r=document.createElement("li");r.className="p-2 rounded bg-gray-100 flex justify-between items-center group";const a=document.createElement("span");a.className="text-sm text-gray-500 line-through",a.textContent=n.name,r.appendChild(a);const i=document.createElement("div");i.className="flex items-center space-x-2";const o=document.createElement("button");o.className="btn btn-xs btn-outline text-blue-600 hover:bg-blue-50 border-blue-300",o.innerHTML='<i class="fas fa-undo mr-1"></i> Restaurer',o.addEventListener("click",async()=>{if(!m)return;const c=Q(B,"plans",m.id);try{await Re(B,async d=>{const u=await d.get(c);if(!u.exists())return;const f=(u.data().manualItems||[]).filter(y=>!(y.name.toLowerCase()===n.name.toLowerCase()&&y.unit===n.unit));d.update(c,{manualItems:f,lastUpdated:new Date})}),e.length<=1&&l.trashModal.classList.add("hidden")}catch(d){console.error("Erreur lors de la restauration :",d)}});const s=document.createElement("button");s.className="text-gray-400 hover:text-red-600 text-xs p-1 rounded-md",s.title="Supprimer définitivement",s.innerHTML='<i class="fas fa-times"></i>',s.addEventListener("click",async()=>{if(!m)return;const c=Q(B,"plans",m.id),d=`${n.name}_${n.unit||""}`;try{await Te(()=>import("./main-BGm1g1S0.js").then(u=>u.d),__vite__mapDeps([0,1,2])).then(u=>{u.updateDoc(c,{hiddenTrashItems:u.arrayUnion(d),lastUpdated:new Date})}),e.length<=1&&l.trashModal.classList.add("hidden")}catch(u){console.error("Erreur suppression définitive:",u)}}),i.appendChild(o),i.appendChild(s),r.appendChild(i),t.appendChild(r)}),l.trashListContainer.appendChild(t)}}else l.trashListContainer&&(l.trashListContainer.innerHTML='<p class="text-center text-gray-500 italic py-4">La corbeille est vide.</p>'),l.emptyTrashBtn&&l.emptyTrashBtn.classList.add("hidden")}function Ie(e=[]){Ye(e);const t=l.shoppingListContainer;if(!t)return;if(t.innerHTML="",O.length===0&&e.length===0){t.innerHTML='<p class="text-center text-gray-500 italic py-4">Votre liste de courses est vide.</p>';return}const n=m?m.checkedItems||{}:{},r=O.reduce((i,o)=>{const s=o.category||"Inconnue";return i[s]||(i[s]=[]),i[s].push(o),i},{});Object.keys(r).sort((i,o)=>i==="Inconnue"?1:o==="Inconnue"?-1:i.localeCompare(o)).forEach(i=>{const o=document.createElement("h4");o.className="text-sm font-bold text-stone-800 bg-stone-200 mt-4 mb-2 px-3 py-1 rounded-md",o.textContent=i,t.appendChild(o);const s=document.createElement("ul");s.className="space-y-2",r[i].sort((d,u)=>d.name.localeCompare(u.name)).forEach(d=>{const u=`${d.name}_${d.unit||""}`,p=qe(u),f=n.hasOwnProperty(p)?n[p]:n[u]||!1,y=document.createElement("li");let h="p-2 rounded";d.hasManualEntry===!0||d.source==="manual"?(y.style.backgroundColor="#ffedd5",h+=" bg-orange-100"):h+=" bg-gray-50",y.className=h;const L=document.createElement("div");L.className="flex justify-between items-center";const C=document.createElement("div");if(C.className="flex-grow flex items-center",f){const x=document.createElement("i");x.className="fas fa-check mr-2 bg-green-500 text-white rounded-full p-1 flex items-center justify-center w-5 h-5",C.appendChild(x)}const w=document.createElement("span");w.className="text-sm font-medium transition-all duration-200",f&&w.classList.add("line-through","text-gray-400"),w.textContent=d.name,C.appendChild(w),L.appendChild(C);const k=document.createElement("div");k.className="flex items-center space-x-2 mx-2";const S=document.createElement("span");S.className="font-medium w-20 text-center text-sm",f&&S.classList.add("text-gray-400");const A=Number.isInteger(d.totalQuantity)?d.totalQuantity:parseFloat(d.totalQuantity.toFixed(2));S.textContent=`${A} ${d.unit||""}`.trim();const D=document.createElement("div");D.className="flex flex-col";const I=document.createElement("button");I.className="btn btn-outline btn-xs rounded-b-none",I.textContent="+",I.addEventListener("click",async()=>{const x=Ce(d.unit);await Z(d.name,x,d.unit)});const E=document.createElement("button");E.className="btn btn-outline btn-xs rounded-t-none -mt-px",E.textContent="-",E.addEventListener("click",async()=>{const x=Ce(d.unit);await Z(d.name,-x,d.unit)}),D.appendChild(I),D.appendChild(E),k.appendChild(S),k.appendChild(D),L.appendChild(k);const v=document.createElement("button");if(v.className="delete-item-btn text-red-500 hover:text-red-700",v.innerHTML='<i class="fas fa-trash-alt"></i>',v.addEventListener("click",()=>{Z(d.name,-d.totalQuantity,d.unit,!0)}),L.appendChild(v),y.appendChild(L),d.sources&&d.sources.length>0){const x=document.createElement("div");x.className="p-2 mt-1 ml-4 rounded-md bg-stone-100";const P=d.sources.reduce((H,M)=>{const N=`${M.recipeName} (${M.day} ${M.time})`;return H[N]||(H[N]=0),H[N]+=M.quantity,H},{});for(const H in P){const M=document.createElement("span");M.className="block text-xs text-gray-500",M.textContent=`↳ ${H}`,x.appendChild(M)}y.appendChild(x)}s.appendChild(y)}),t.appendChild(s)})}async function ce(){if(!m){O.length=0,Ie();return}const e=m.manualItems?JSON.parse(JSON.stringify(m.manualItems)):[],t=new Map(e.map(s=>{const c=`${s.name.trim().toLowerCase()}_${s.unit||""}`;return s.hasManualEntry=!0,[c,s]})),n=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];if(m.weeks)for(const s in m.weeks){const c=m.weeks[s],d=c.menuData||{},u=c.servingsData||{};for(const p in d){const f=d[p];if(!Array.isArray(f))continue;const[y,h]=p.split("-"),b=parseInt(y,10),L=n[b]||"Jour inconnu",C=h==="lunch"?"midi":"soir",w=`${b}-${h}`,k=parseInt(u[w]||m.defaultNumPeople,10);for(const S of f){const D=z.find(E=>E.id===S.id)||S;if(!D||!Array.isArray(D.ingredients))continue;const I=D.servings||1;I<=0||D.ingredients.forEach(E=>{const{name:v,quantity:x,unit:P}=E;if(!v||!x)return;const H=se.find(J=>J.name.toLowerCase()===v.trim().toLowerCase()),M=H?H.category:"Inconnue",N=parseFloat(String(x).replace(",","."));if(isNaN(N))return;const W=N/I*k,q=P||"",U=`${v.trim().toLowerCase()}_${q}`,te={recipeName:D.name,day:`${L} (S${s})`,time:C,quantity:W};if(t.has(U)){const J=t.get(U);J.totalQuantity+=W,J.source==="manual"&&(J.source="mixed"),Array.isArray(J.sources)?J.sources.push(te):J.sources=[te]}else t.set(U,{name:v.trim(),totalQuantity:W,unit:q,source:"plan",category:M,sources:[te]})})}}}const r=Array.from(t.values()),a=m.hiddenTrashItems||[],i=r.filter(s=>s.totalQuantity>0).sort((s,c)=>s.name.localeCompare(c.name)),o=r.filter(s=>{const c=`${s.name}_${s.unit||""}`;return s.totalQuantity<=0&&s.sources&&s.sources.length>0&&!a.includes(c)}).sort((s,c)=>s.name.localeCompare(c.name));O.length=0,O.push(...i),Ie(o)}function we(e){const t=re(e);if(!t||!l.mealSelectModal)return;l.mealSelectModalTitle.textContent=`Sélectionner : ${t}`,l.mealSelectList.innerHTML="";const n=document.createElement("input");n.type="text",n.placeholder="Rechercher dans la catégorie...",n.className="w-full p-2 mb-4 border border-gray-300 rounded-lg",l.mealSelectList.appendChild(n);const r=ie(t),a=z.filter(s=>ie(s.category)===r).sort((s,c)=>{const d=s.isFavorite?1:0,u=c.isFavorite?1:0;return u!==d?u-d:s.name.localeCompare(c.name)}),i=document.createElement("div");i.className="space-y-1 max-h-80 overflow-y-auto",l.mealSelectList.appendChild(i);function o(s=""){i.innerHTML="";const c=s.toLowerCase(),d=a.filter(u=>u.name.toLowerCase().includes(c));d.length===0?i.innerHTML='<p class="text-gray-500 p-4">Aucun plat ne correspond à votre recherche.</p>':d.forEach(u=>{const p=document.createElement("button");p.className="w-full text-left p-2 hover:bg-gray-100 rounded-lg transition-colors duration-150";const f=document.createElement("p");f.className="font-medium text-gray-800 text-sm",u.isFavorite?f.innerHTML=`${u.name} <i class="fas fa-heart text-red-500 ml-2"></i>`:f.textContent=u.name,p.appendChild(f),p.addEventListener("click",()=>{rt(e,u),de()}),i.appendChild(p)})}n.addEventListener("input",s=>o(s.target.value)),o(),l.mealSelectModal.classList.remove("hidden"),n.focus()}function de(){l.mealSelectModal&&l.mealSelectModal.classList.add("hidden")}function Xe(e){X=e.target.closest(".meal-card");const t=X.closest(".meal-slot").dataset.slotId;e.dataTransfer.setData("text/plain",t),setTimeout(()=>{X&&(X.style.opacity="0.5")},0)}function Ze(){X&&(X.style.opacity="1",X=null)}function et(e){e.preventDefault();const t=e.target.closest(".meal-slot");t&&re(t.dataset.slotId)!=="Remarque"&&t.classList.add("bg-gray-200")}function tt(e){const t=e.target.closest(".meal-slot");t&&t.classList.remove("bg-gray-200")}async function nt(e){e.preventDefault();const t=e.dataTransfer.getData("text/plain"),n=e.target.closest(".meal-slot");if(n){n.classList.remove("bg-gray-200");const r=n.dataset.slotId,a=re(r);if(a==="Remarque")return;if(t&&r&&t!==r){const i=g[t],o=re(t);if(ie(o)!==ie(a)){alert(`Action impossible : un(e) "${o}" ne peut pas aller dans la catégorie "${a}".`);return}const s=g[r];g[r]=i,s?g[t]=s:delete g[t],le(l.mealPlanGrid,{menuData:g,servingsData:R,remarksData:F,defaultNumPeople:j,startDay:T},!1),await V({[`weeks.${$}.menuData`]:g},"a déplacé un plat"),await ce()}}}function re(e){switch(e.split("-")[2]){case"0":return"Entrée";case"1":return"Plat";case"2":return"Accompagnement";case"3":return"Dessert";case"4":return"Remarque";default:return""}}function ke(e,t,n,r=!1){const a=document.createElement("div");if(a.className="meal-card p-1 flex flex-col items-center bg-white rounded shadow-sm text-center relative w-full mb-1",r||(a.classList.add("cursor-grab"),a.draggable=!0),!r){const c=document.createElement("button");c.className="absolute -top-2 -right-1 text-base",c.innerHTML='<i class="fas fa-heart"></i>',e.isFavorite?c.classList.add("text-red-500"):c.classList.add("text-gray-300","hover:text-red-400"),c.addEventListener("click",d=>{d.stopPropagation(),Dt(e.id,e.isFavorite)}),c.addEventListener("mousedown",d=>d.stopPropagation()),a.appendChild(c)}const i=document.createElement("span");if(i.className="text-xs font-medium p-1 break-words w-full",i.textContent=e.name,a.appendChild(i),!r){const c=document.createElement("div");c.className="absolute top-0 left-0 flex";const d=document.createElement("button");d.className="edit-meal-btn text-gray-600 hover:text-gray-800 hidden px-1 py-0.5",d.innerHTML='<i class="fas fa-pencil-alt fa-xs"></i>',d.title="Modifier la recette",d.addEventListener("click",p=>{p.stopPropagation();const f=z.find(y=>y.id===e.id);G.openForm(f||e,"Modifier la recette")}),d.addEventListener("mousedown",p=>p.stopPropagation()),c.appendChild(d);const u=document.createElement("button");u.className="delete-meal-btn text-red-700 hover:text-red-900 hidden px-1 py-0.5",u.innerHTML='<i class="fas fa-times-circle fa-xs"></i>',u.title="Retirer du planning",u.addEventListener("click",p=>{p.stopPropagation(),ot(t,n)}),u.addEventListener("mousedown",p=>p.stopPropagation()),c.appendChild(u),a.appendChild(c),a.addEventListener("mouseenter",()=>{d.classList.remove("hidden"),u.classList.remove("hidden")}),a.addEventListener("mouseleave",()=>{d.classList.add("hidden"),u.classList.add("hidden")})}const o=document.createElement("div");o.className="absolute bottom-1 right-1";const s=document.createElement("button");return s.className="info-meal-btn bg-gray-500 text-white hover:bg-gray-600 rounded w-3 h-3 flex items-center justify-center shadow-sm",s.innerHTML='<i class="fas fa-plus fa-xs"></i>',s.title="Plus d'infos",s.dataset.slotId=t,s.dataset.mealIndex=n,s.addEventListener("mousedown",c=>c.stopPropagation()),o.appendChild(s),a.appendChild(o),a}function at(e,t){if(document.querySelectorAll(".planner-ingredient-tooltip").forEach(o=>o.remove()),ee===e){e.classList.remove("info-open"),e.innerHTML='<i class="fas fa-plus fa-xs"></i>',ee=null;return}ee&&(ee.classList.remove("info-open"),ee.innerHTML='<i class="fas fa-plus fa-xs"></i>'),e.classList.add("info-open"),e.innerHTML='<i class="fas fa-times fa-xs"></i>',ee=e;const n=document.createElement("div");if(n.className="planner-ingredient-tooltip z-50 w-64 p-3 bg-white border border-gray-200 rounded-lg shadow-lg text-left text-sm",t.ingredients&&t.ingredients.length>0){if(t.servings&&t.servings>0){const c=document.createElement("p");c.className="mb-2 text-sm text-gray-600 flex items-center",c.innerHTML=`<i class="fas fa-users mr-2"></i> Pour ${t.servings} ${t.servings>1?"personnes":"personne"}`,n.appendChild(c)}const o=document.createElement("h4");o.className="font-bold mb-2 text-gray-800",o.textContent="Ingrédients :",n.appendChild(o);const s=document.createElement("ul");s.className="space-y-1 text-gray-600",t.ingredients.forEach(c=>{const d=document.createElement("li");d.textContent=`• ${c.quantity||""} ${c.unit||""} ${c.name}`.trim(),s.appendChild(d)}),n.appendChild(s)}else n.textContent="Aucun ingrédient spécifié pour cette recette.";document.body.appendChild(n);const r=e.closest(".meal-card").getBoundingClientRect(),a=n.getBoundingClientRect();if(window.innerWidth<768){n.style.width="90vw",n.style.maxWidth="320px";const o=n.getBoundingClientRect();let s=r.bottom+10,c=(window.innerWidth-o.width)/2;s+o.height>window.innerHeight&&(s=r.top-o.height-10),n.style.top=`${s}px`,n.style.left=`${c}px`}else{let o=r.right+10;o+a.width>window.innerWidth&&(o=r.left-a.width-10);let s=r.top;s+a.height>window.innerHeight&&(s=r.bottom-a.height),s<10&&(s=10),n.style.left=`${o}px`,n.style.top=`${s}px`}n.style.position="fixed"}function Be(e,t=!1){const n=document.createElement("div"),r=document.createElement("button");return t?(n.className="w-full flex justify-center pt-1",r.className="add-more-meal-btn text-gray-400 hover:text-green-500 transition-colors duration-150",r.innerHTML='<i class="fas fa-plus-circle"></i>',r.title="Ajouter une autre recette"):(n.className="flex items-center justify-center h-full",r.className="add-meal-btn text-green-500 hover:text-green-700 transition-transform duration-150 hover:scale-125",r.innerHTML='<i class="fas fa-plus-circle text-lg"></i>'),r.addEventListener("click",()=>we(e)),n.appendChild(r),n}function Me(e,t,n=!1){if(n){const a=document.createElement("p");return a.className="w-full h-full p-1 text-xs text-gray-700",a.textContent=t[e]||"",a}const r=document.createElement("textarea");return r.className="w-full h-full p-1 text-xs bg-white border-0 rounded focus:outline-none focus:ring-1 focus:ring-tomato resize-none",r.placeholder="Remarque...",r.value=F[e]||"",r.dataset.slotId=e,r.addEventListener("change",a=>{const i=a.target.value;i?F[e]=i:delete F[e];const[o,s]=e.split("-"),u=`a modifié la remarque pour ${_[parseInt(o,10)]} ${s==="lunch"?"midi":"soir"}`;V({[`weeks.${$}.remarksData`]:F},u)}),r.addEventListener("focus",a=>{ve({type:"editing_remark",fieldId:e})}),r.addEventListener("blur",a=>{ve("idle")}),r}function st(){document.querySelectorAll(".meal-card").forEach(e=>{e.addEventListener("dragstart",Xe),e.addEventListener("dragend",Ze)}),document.querySelectorAll(".meal-slot").forEach(e=>{e.addEventListener("dragover",et),e.addEventListener("dragleave",tt),e.addEventListener("drop",nt)})}async function rt(e,t){const n=JSON.parse(JSON.stringify(g)),r=n[e],a={id:t.id};Array.isArray(r)?r.push(a):n[e]=[a];const[i,o]=e.split("-"),s=_[parseInt(i,10)],c=o==="lunch"?"midi":"soir",d=`a ajouté '${t.name}' à ${s} ${c}`;await V({[`weeks.${$}.menuData`]:n},d),de()}async function ot(e,t){if(!m||!g[e]||!Array.isArray(g[e]))return;const n=g[e][t],r=JSON.parse(JSON.stringify(g));r[e].splice(t,1),r[e].length===0&&delete r[e];const[a,i]=e.split("-"),o=_[parseInt(a,10)],s=i==="lunch"?"midi":"soir",c=`a supprimé '${n.name}' de ${o} ${s}`;await V({[`weeks.${$}.menuData`]:r},c)}async function Se(){if(confirm("Voulez-vous vraiment vider le menu de cette semaine ?")){const e={id:availablePlans.length>0?availablePlans[0].id:`${ye()}_semaine-${$}`,name:availablePlans.length>0?availablePlans[0].name:"Mon plan",menuData:{},servingsData:{},remarksData:{},defaultNumPeople:j,startDay:T,lastUpdated:new Date};loadPlan(e),availablePlans.length>0?availablePlans[0]=e:availablePlans.push(e),await V({[`weeks.${$}`]:{menuData:{},servingsData:{},remarksData:{}}},`a vidé le menu de la semaine ${$}`)}}function De(e){e>=1&&e<=52&&($=e,Ee())}function it(){l.currentWeekDisplay&&(l.currentWeekDisplay.textContent=`Semaine ${$}`)}function lt(){l.prevWeekBtn?.addEventListener("click",()=>De($-1)),l.nextWeekBtn?.addEventListener("click",()=>De($+1)),l.clearMenuBtn?.addEventListener("click",Se),l.startDaySelect?.addEventListener("change",async n=>{T=n.target.value,m&&await V({startDay:T},`a changé le premier jour de la semaine à '${T}'`)}),l.planSelect?.addEventListener("change",Ne),l.closeMealSelectModalBtn?.addEventListener("click",de),l.mealSelectModal?.addEventListener("click",n=>{n.target===l.mealSelectModal&&de()}),l.closeRecipeModalBtn?.addEventListener("click",()=>G.closeForm()),l.cancelRecipeBtn?.addEventListener("click",()=>G.closeForm()),l.importListBtn?.addEventListener("click",Ve),l.closeImportListModalBtn?.addEventListener("click",pe),l.importListModal?.addEventListener("click",n=>{n.target===l.importListModal&&pe()}),l.exportTxtBtn?.addEventListener("click",Je),l.exportPdfBtn?.addEventListener("click",Ge),l.exportPlanPdfBtn?.addEventListener("click",Ke);const e=n=>{const r=n.target.closest(".info-meal-btn");if(r){const a=r.dataset.slotId,i=parseInt(r.dataset.mealIndex,10);if(a&&!isNaN(i)){const o=g[a]?.[i];if(o&&o.id){const s=z.find(c=>c.id===o.id);s&&at(r,s)}}}};l.mealPlanGrid?.addEventListener("click",e),document.getElementById("mobile-meal-plan")?.addEventListener("click",e),l.sharePlanBtn?.addEventListener("click",()=>{if(!m){alert("Veuillez sélectionner un plan à partager.");return}Nt({plan:m})}),l.inviteParticipantBtn?.addEventListener("click",()=>{if(!m){alert("Veuillez sélectionner un plan pour inviter des participants.");return}$t(m)}),l.historyPlanBtn?.addEventListener("click",ze),l.closePlanHistoryModalBtn?.addEventListener("click",me),l.planHistoryModal?.addEventListener("click",n=>{n.target===l.planHistoryModal&&me()}),l.openTrashBtn?.addEventListener("click",()=>{l.trashModal.classList.remove("hidden")}),l.closeTrashModalBtn?.addEventListener("click",()=>{l.trashModal.classList.add("hidden")}),l.trashModal?.addEventListener("click",n=>{n.target===l.trashModal&&l.trashModal.classList.add("hidden")}),l.savePlanBtn?.addEventListener("click",async()=>{if(!m){alert("Veuillez sélectionner un plan de travail avant de sauvegarder.");return}const n=document.getElementById("save-plan-as-modal"),r=document.getElementById("save-plan-as-form"),a=document.getElementById("save-plan-name"),i=document.getElementById("cancel-save-plan-as-btn"),o=document.getElementById("close-save-plan-as-modal"),s=new Date().toLocaleDateString("fr-FR"),c=m.weeks?Object.keys(m.weeks).filter(f=>m.weeks[f]&&Object.keys(m.weeks[f].menuData||{}).length>0).length:0,d=c>1?`${c} semaines`:`${c} semaine`;a.value=`${m.name} (${d}) - ${s}`,n.classList.remove("hidden");const u=async f=>{f.preventDefault();const y=a.value;if(!y)return;m.weeks||(m.weeks={}),m.weeks[$]={menuData:g,servingsData:R,remarksData:F},m.startDay=T,m.defaultNumPeople=j;const h=JSON.parse(JSON.stringify(m));if(h.weeks)for(const b in h.weeks){const L=h.weeks[b];if(L&&L.menuData)for(const C in L.menuData){const w=L.menuData[C];Array.isArray(w)&&(L.menuData[C]=w.map(k=>k&&k.id&&z.find(A=>A.id===k.id)||k))}}await yt(y,h),n.classList.add("hidden"),r.removeEventListener("submit",u)},p=()=>{n.classList.add("hidden"),r.removeEventListener("submit",u)};r.addEventListener("submit",u,{once:!0}),i.addEventListener("click",p,{once:!0}),o.addEventListener("click",p,{once:!0})})}function ct(e=""){return e.split(" ").map(r=>r[0]).join("").substring(0,2).toUpperCase()}function fe(e=[],t={}){const n=document.getElementById("collaborators-bar"),r=document.getElementById("activity-labels-container"),a=document.getElementById("name-tooltip");if(!n||!a||!r)return;if(n.innerHTML="",r.innerHTML="",document.querySelectorAll(".remark-lock-overlay").forEach(s=>s.remove()),document.querySelectorAll("textarea[data-slot-id]").forEach(s=>{s.disabled=!1}),e.length<=1&&Object.keys(t).length<=1){n.classList.add("hidden");return}let i="";const o=ye();e.forEach(s=>{if(!s)return;const c=t.hasOwnProperty(s.uid),d=t[s.uid]||{},u=document.createElement("div");u.className="w-8 h-8 rounded-full flex items-center justify-center bg-gray-300 text-white font-bold text-xs ring-2 ring-white cursor-pointer transition-all duration-300";const p=c?"(présent)":"(absent)";if(u.dataset.name=`${s.displayName||"Inconnu"} ${p}`,s.photoURL?u.innerHTML=`<img src="${s.photoURL}" alt="${s.displayName}" class="w-full h-full rounded-full object-cover">`:u.textContent=ct(s.displayName),c||u.classList.add("grayscale","opacity-50"),u.addEventListener("mouseenter",f=>{a.textContent=f.currentTarget.dataset.name,a.classList.remove("hidden");const y=f.currentTarget.getBoundingClientRect();a.style.left=`${y.left+y.width/2-a.offsetWidth/2}px`,a.style.top=`${y.top-a.offsetHeight-5}px`}),u.addEventListener("mouseleave",()=>{a.classList.add("hidden")}),n.appendChild(u),c&&s.uid!==o){const f=d.status;if(typeof f=="object"&&f.type==="editing_remark"){const y=document.querySelector(`textarea[data-slot-id="${f.fieldId}"]`);if(y){y.disabled=!0;const h=document.createElement("div");h.className="remark-lock-overlay absolute inset-0 bg-gray-400 bg-opacity-25 flex items-center justify-center text-xs text-white font-bold",h.innerHTML=`<i class="fas fa-lock mr-1"></i> ${s.displayName} écrit...`,y.parentElement&&(y.parentElement.classList.add("relative"),y.parentElement.appendChild(h))}}else if(typeof f=="string"&&f!=="idle"){let y="";switch(f){case"editing_recipe":y="modifie une recette...";break}y&&(i+=`<span class="italic mr-4">${s.displayName} ${y}</span>`)}}}),r.innerHTML=i,n.classList.remove("hidden")}function Ne(){Tt();const e=l.planSelect.value;e&&localStorage.setItem("lastActivePlanId",e),m=xe.find(o=>o.id===e)||null;const t=document.getElementById("delete-plan-btn"),n=document.getElementById("rename-plan-btn"),r=document.getElementById("leave-plan-btn"),a=document.getElementById("invite-participant-btn"),i=document.getElementById("history-plan-btn");if(t&&(t.style.display=m&&m.isOwner?"inline-flex":"none"),n&&(n.style.display=m&&m.isOwner?"inline-flex":"none"),i&&(i.style.display=m&&m.isOwner?"inline-flex":"none"),r&&(r.style.display=m&&!m.isOwner?"inline-flex":"none"),a){const o=m&&(m.type==="collaborative"||m.collaborators&&m.collaborators.length>0);a.style.display=m&&m.isOwner&&o?"inline-flex":"none"}m&&m.participants&&m.participants.length>1?(fe(m.participants,{}),Pt(m.id,o=>{fe(m.participants,o)})):fe([],{}),m&&(m.manualItems=m.manualItems||[]),Ee()}async function $e(e,t){if(!m)return;const n=JSON.parse(JSON.stringify(R));t===j?delete n[e]:n[e]=t;const[r,a]=e.split("-"),s=`a changé le nombre de personnes pour ${_[parseInt(r,10)]} ${a==="lunch"?"midi":"soir"} à ${t}`;await V({[`weeks.${$}.servingsData`]:n},s)}async function dt(){if(!B)return;const e=pt();lt(),We(),await Le();const t=bt(oe(B,"recipes"),r=>{if(console.log("Recipe data updated from listener."),z=r.docs.map(a=>{const i=a.data();return{id:a.id,...i,imageUrl:i.imageUrl||""}}),m){for(const a in g){const i=g[a];if(Array.isArray(i)){const o=i.map(s=>{if(s&&s.id){const c=z.find(d=>d.id===s.id);return c?{...c}:s}return s});g[a]=o}}le(l.mealPlanGrid,{menuData:g,servingsData:R,remarksData:F,defaultNumPeople:j,startDay:T},!1),be(document.getElementById("mobile-meal-plan"),{menuData:g,servingsData:R,remarksData:F,defaultNumPeople:j,startDay:T},!1),ce()}}),n=ft(r=>{xe=r,ht(r);const a=localStorage.getItem("selectedPlanId"),i=localStorage.getItem("lastActivePlanId");a&&r.some(o=>o.id===a)?(l.planSelect.value=a,localStorage.removeItem("selectedPlanId")):i&&r.some(o=>o.id===i)&&(l.planSelect.value=i),Ne()});return()=>{n(),t(),e()}}const ut=dt();return async()=>{const e=await ut;typeof e=="function"&&e()}}export{jt as default};
