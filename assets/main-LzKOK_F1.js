import{o as Rn,s as an,a as _t,q as ke,w as ue,c as Y,d as w,b as Je,e as q,g as Pe,h as Ce,u as je,i as ze,j as He,k as xt,l as gn,m as Bt,n as sn,p as hn,r as qn,t as $t,v as rn,x as Un,y as On,z as Fn,A as zn,B as Vn,C as vn,D as Qn,E as on,_ as Wn}from"./firebase-config-CV1YP_xo.js";let Mt=null;function Gt(){return new Promise(e=>{Rn(_t,t=>{if(Mt=t,t){console.log("User is logged in:",t.uid);const n=document.getElementById("logout-btn"),a=document.getElementById("profile-btn");n&&n.classList.remove("hidden"),a&&a.classList.remove("hidden"),n&&!n.hasAttribute("data-listener-attached")&&(n.addEventListener("click",()=>{an(_t).catch(r=>{console.error("Sign Out Error",r)})}),n.setAttribute("data-listener-attached","true"));const o=document.getElementById("logout-btn-mobile");o&&!o.hasAttribute("data-listener-attached")&&(o.addEventListener("click",()=>{an(_t).catch(r=>{console.error("Sign Out Error",r)})}),o.setAttribute("data-listener-attached","true")),e(t)}else{console.log("User not logged in. Redirecting to login.html");const n=window.location.origin+"/login.html";window.location.href!==n&&(window.location.href=n),e(null)}})})}function De(){return Mt?Mt.uid:null}function Re(){return Mt}const Jn=Object.freeze(Object.defineProperty({__proto__:null,getCurrentUser:Re,getCurrentUserId:De,protectPage:Gt},Symbol.toStringTag,{value:"Module"}));async function Gn(e){if(confirm("Voulez-vous charger cette sauvegarde ? Attention, cela √©crasera la planification de la semaine correspondante dans votre plan de travail actuel."))try{const t=De();if(!t)throw new Error("Utilisateur non trouv√©");const n=q(w,"plan_saves",e),a=await Pe(n);if(!a.exists())throw new Error("Sauvegarde non trouv√©e.");const o=a.data(),r=o.weekData.weekNumber,d=ke(Y(w,"plans"),ue("userId","==",t)),h=await Ce(d);if(h.empty)throw new Error("Aucun plan de travail trouv√© pour y charger la sauvegarde.");const x=h.docs[0],g=q(w,"plans",x.id);await je(g,{[`weeks.${r}`]:o.weekData}),localStorage.setItem("selectedPlanId",x.id),Ve("menu")}catch(t){console.error("Erreur lors du chargement de la sauvegarde:",t),alert(t.message)}}async function Kn(e){if(confirm("√ätes-vous s√ªr de vouloir supprimer cette sauvegarde ? Cette action est d√©finitive."))try{await ze(q(w,"plan_saves",e))}catch(t){console.error("Erreur lors de la suppression de la sauvegarde:",t),alert("La suppression a √©chou√©.")}}function Yn(){const e=document.getElementById("all-plans-list"),t=De();if(!t||!e)return e.innerHTML="<p>Erreur de chargement.</p>",()=>{};const n=ke(Y(w,"plan_saves"),ue("userId","==",t)),a=Je(n,o=>{if(e.innerHTML="",o.empty){e.innerHTML=`<p class="text-center text-gray-500 p-10 col-span-full">Vous n'avez aucune sauvegarde.</p>`;return}const r=o.docs.map(d=>({id:d.id,...d.data()}));r.sort((d,h)=>h.savedAt.toMillis()-d.savedAt.toMillis()),r.forEach(d=>{const h=document.createElement("div");h.className="bg-white rounded-xl shadow-md p-4 flex flex-col justify-between";const x=d.savedAt?.toDate().toLocaleString("fr-FR")||"Date inconnue",g=d.planData;let c="Plan vide ou sans donn√©es.";if(g&&g.weeks){const S=Object.keys(g.weeks).length;S>0&&(c=`Contient ${S} semaine(s).`)}const L=document.createElement("div");L.innerHTML=`
                <h3 class="text-lg font-bold text-gray-800 mb-2">${d.name}</h3>
                <p class="text-sm text-gray-500">Sauvegard√© le : ${x}</p>
                <p class="text-sm text-gray-600 mt-2">${c}</p>
            `;const m=document.createElement("div");m.className="mt-4 pt-4 border-t border-gray-200 flex items-center justify-end space-x-2";const M=document.createElement("button");M.className="btn btn-secondary btn-sm",M.textContent="Voir",M.addEventListener("click",()=>{localStorage.setItem("selectedPlanId",d.id),Ve("view-plan")});const N=document.createElement("button");N.className="btn btn-primary btn-sm",N.textContent="Charger",N.addEventListener("click",()=>Gn(d.id)),N.style.display="none";const i=document.createElement("button");i.className="text-red-500 hover:bg-red-100 text-sm px-3 py-1 rounded-md",i.innerHTML='<i class="fas fa-trash"></i>',i.title="Supprimer la sauvegarde",i.addEventListener("click",()=>Kn(d.id)),m.appendChild(i),m.appendChild(M),m.appendChild(N),h.appendChild(L),h.appendChild(m),e.appendChild(h)})});return()=>{a()}}const Xn=Object.freeze(Object.defineProperty({__proto__:null,default:Yn},Symbol.toStringTag,{value:"Module"}));class Kt{constructor(t,n,a,o,r,d,h,x,g,c,L,m,M,N,i,S){this.db=t,this.modal=document.getElementById(n),this.form=document.getElementById(a),this.modalTitle=document.getElementById(o),this.recipeIdInput=document.getElementById(r),this.recipeNameInput=document.getElementById(d),this.recipeCategoryInput=document.getElementById(h),this.recipeServingsInput=document.getElementById(x),this.recipePrepTimeInput=document.getElementById(g),this.recipeDifficultyInput=document.getElementById(c),this.recipeImageUrlInput=document.getElementById("edit-recipe-image-url"),this.recipeStepsTextarea=document.getElementById(L),this.ingredientsListDiv=document.getElementById(m),this.addIngredientBtn=document.getElementById(M),this.saveRecipeBtn=document.getElementById(N),this.closeButton=document.getElementById(i),this.cancelButton=document.getElementById(S),this.masterIngredientList=[],this.activityUpdater=null,this.boundAddIngredient=()=>this.addIngredientInput(void 0,this.form.ingredients),this.boundCloseForm=()=>this.closeForm(),this.boundHandleSubmit=K=>this.handleSubmit(K),this.addIngredientBtn.addEventListener("click",this.boundAddIngredient),this.closeButton.addEventListener("click",this.boundCloseForm),this.cancelButton.addEventListener("click",this.boundCloseForm),this.saveRecipeBtn.addEventListener("click",this.boundHandleSubmit)}setActivityUpdater(t){this.activityUpdater=t}destroy(){this.addIngredientBtn.removeEventListener("click",this.boundAddIngredient),this.closeButton.removeEventListener("click",this.boundCloseForm),this.cancelButton.removeEventListener("click",this.boundCloseForm),this.saveRecipeBtn.removeEventListener("click",this.boundHandleSubmit)}async openForm(t=null,n="Ajouter une recette"){this.activityUpdater&&this.activityUpdater("editing_recipe"),await this.fetchMasterIngredients(),console.log("openForm called with recipe:",t,"and title:",n),this.form.reset(),this.ingredientsListDiv.innerHTML="",this.modalTitle.textContent=n;const a=[];if(this.form.ingredients=a,t){this.recipeIdInput.value=t.id||"",this.recipeNameInput.value=t.name||"";const o=t.category||"Plat";for(const r of this.recipeCategoryInput.options)if(r.value.toLowerCase()===o.toLowerCase()){r.selected=!0;break}this.recipeServingsInput.value=parseInt(t.servings)||"",this.recipePrepTimeInput.value=parseInt(t.prepTime)||"",this.recipeDifficultyInput.value=t.difficulty||"Moyen",this.recipeImageUrlInput.value=t.imageUrl||"",this.recipeStepsTextarea.value=t.steps||"",t.ingredients&&t.ingredients.length>0?t.ingredients.forEach(r=>this.addIngredientInput({...r},a)):this.addIngredientInput(void 0,a)}else this.recipeIdInput.value="",this.addIngredientInput(void 0,a);this.modal.classList.remove("hidden")}closeForm(){this.activityUpdater&&this.activityUpdater("idle"),this.modal.classList.add("hidden")}async fetchMasterIngredients(){if(this.masterIngredientList=[],!!this.db)try{const t=await Ce(Y(this.db,"ingredients"));this.masterIngredientList=t.docs.map(n=>({id:n.id,...n.data()})),this.masterIngredientList.sort((n,a)=>n.name.localeCompare(a.name))}catch(t){console.error("Erreur lors de la r√©cup√©ration de la liste des ingr√©dients: ",t),alert("Impossible de charger la liste des ingr√©dients de base. La recherche ne fonctionnera pas.")}}addIngredientInput(t={quantity:"",name:"",unit:""},n){const a=document.createElement("div");a.className="relative flex items-stretch space-x-2 ingredient-row";const o={...t};n.push(o);const r=n.length-1,d=document.createElement("input");d.type="text",d.className="ingredient-quantity mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm",d.placeholder="Qt√©",d.value=o.quantity,d.addEventListener("change",m=>{n[r].quantity=m.target.value});const h=document.createElement("input");h.type="text",h.className="ingredient-unit mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm bg-gray-100",h.placeholder="Unit√©",h.readOnly=!0,h.value=o.unit||"";const x=document.createElement("div");x.className="relative w-1/2";const g=document.createElement("input");g.type="text",g.className="ingredient-name mt-1 block w-full rounded-md border-gray-300 shadow-sm",g.placeholder="Chercher un ingr√©dient...",g.value=o.name,x.appendChild(g);const c=document.createElement("div");c.className="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto",x.appendChild(c),g.addEventListener("input",()=>{const m=g.value.toLowerCase();if(!m){c.classList.add("hidden");return}const M=this.masterIngredientList.filter(i=>i.name.toLowerCase().includes(m));c.innerHTML="",M.forEach(i=>{const S=document.createElement("div");S.className="p-2 ingredient-search-item cursor-pointer",S.textContent=i.name,S.addEventListener("click",()=>{g.value=i.name,h.value=i.unit,c.classList.add("hidden"),n[r].name=i.name,n[r].unit=i.unit,n[r].id=i.id}),c.appendChild(S)});const N=document.createElement("div");N.className="p-2 bg-blue-50 hover:bg-blue-200 cursor-pointer font-bold text-blue-700",N.textContent=`+ Cr√©er "${g.value}"`,N.addEventListener("click",async()=>{const i=g.value,S="pi√®ce(s)";try{const K=await He(Y(this.db,"ingredients"),{name:i,unit:S});await this.fetchMasterIngredients(),g.value=i,h.value=S,c.classList.add("hidden"),n[r].name=i,n[r].unit=S,n[r].id=K.id}catch(K){console.error("Erreur d'ajout d'ingr√©dient",K),alert("L'ingr√©dient n'a pas pu √™tre cr√©√©.")}}),c.appendChild(N),c.classList.remove("hidden")});const L=document.createElement("button");L.type="button",L.className="text-red-500 hover:bg-red-50 text-sm px-3 py-1 rounded-md mt-1",L.innerHTML='<i class="fas fa-trash"></i>',L.addEventListener("click",()=>{a.remove(),n[r]=null}),a.appendChild(x),a.appendChild(d),a.appendChild(h),a.appendChild(L),this.ingredientsListDiv.appendChild(a)}async handleSubmit(t){t.preventDefault(),this.saveRecipeBtn.disabled=!0,this.saveRecipeBtn.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i> Sauvegarde...',console.log("Ingredients array from form before filter:",this.form.ingredients);const n=this.form.ingredients.filter(r=>r!==null&&r.quantity&&r.name);console.log("Ingredients array after filter:",n);const a={name:this.recipeNameInput.value,category:this.recipeCategoryInput.value,servings:parseInt(this.recipeServingsInput.value)||0,prepTime:parseInt(this.recipePrepTimeInput.value)||0,difficulty:this.recipeDifficultyInput.value,steps:this.recipeStepsTextarea.value,ingredients:n,imageUrl:this.recipeImageUrlInput.value||`https://tse2.mm.bing.net/th?q=${encodeURIComponent(this.recipeNameInput.value)}%20recette&w=400&h=300&c=7&rs=1&p=0`};console.log("Recipe data being sent to Firebase:",a);const o=this.recipeIdInput.value;try{o?await xt(q(this.db,"recipes",o),a):await He(Y(this.db,"recipes"),a),this.closeForm(),console.log("Recipe saved successfully!"),this.onSaveCallback&&this.onSaveCallback()}catch(r){console.error("Erreur de sauvegarde: ",r),alert("Une erreur est survenue lors de la sauvegarde.")}finally{this.saveRecipeBtn.disabled=!1,this.saveRecipeBtn.textContent="Sauvegarder"}}setOnSaveCallback(t){this.onSaveCallback=t}}const Zn=Object.freeze(Object.defineProperty({__proto__:null,RecipeFormHandler:Kt},Symbol.toStringTag,{value:"Module"}));let Ft=()=>{};function ea(){const e=document.getElementById("search-friends-input");return document.getElementById("search-friends-btn").addEventListener("click",()=>ln(e.value)),e.addEventListener("keyup",n=>{n.key==="Enter"&&ln(e.value)}),ta(),yn(),()=>{Ft&&Ft()}}async function ta(){const e=document.getElementById("friends-list-container"),t=Re()?.uid;if(!t||!e)return;e.innerHTML='<p class="text-gray-500">Chargement...</p>';const n=q(w,"users",t);Ft=Je(n,async a=>{if(!a.exists()){e.innerHTML='<p class="text-red-500">Erreur: Utilisateur non trouv√©.</p>';return}const o=a.data().friends||[];if(e.innerHTML="",o.length===0){e.innerHTML=`<p class="text-gray-500">Vous n'avez pas encore d'amis. Utilisez la recherche pour en ajouter.</p>`;return}for(const r of o)try{const d=await Pe(q(w,"users",r));d.exists()&&e.appendChild(na(d.data()))}catch(d){console.error("Erreur de chargement d'un ami",d)}})}function na(e){const t=document.createElement("div");t.className="bg-card text-card-foreground p-3 rounded-lg flex items-center justify-between shadow-sm border border-border";const n=document.createElement("div");n.className="flex items-center",n.innerHTML=`
        <img src="${e.photoURL||"https://placehold.co/40"}" 
             alt="Avatar" 
             class="w-10 h-10 rounded-full mr-3 object-cover bg-muted"
             onerror="this.onerror=null; this.src='https://placehold.co/40?text=${e.displayName?e.displayName.charAt(0).toUpperCase():"?"}';">
        <div>
            <p class="font-bold">${e.displayName}</p>
            <p class="text-sm text-muted-foreground">${e.email}</p>
        </div>
    `;const a=document.createElement("button");return a.className="text-red-500 hover:bg-red-50 text-sm px-3 py-1 rounded-md",a.innerHTML='<i class="fas fa-user-times"></i>',a.title="Retirer cet ami",a.addEventListener("click",()=>aa(e.uid)),t.appendChild(n),t.appendChild(a),t}async function aa(e){const t=Re()?.uid;if(!t||!e){console.error("Impossible de supprimer l'ami : ID utilisateur ou ID ami manquant.");return}if(!confirm("Voulez-vous vraiment retirer cet ami ? Cette action est unilat√©rale."))return;console.log(`Tentative de suppression de l'ami ${e} pour l'utilisateur ${t}`);const n=q(w,"users",t);try{await je(n,{friends:gn(e)}),console.log("Ami supprim√© avec succ√®s de la base de donn√©es.")}catch(a){console.error("Erreur lors de la suppression de l'ami: ",a),alert("Une erreur est survenue.")}}async function ln(e){const t=document.getElementById("search-results-container"),n=Re()?.uid;if(!(!e||!t)){t.innerHTML='<p class="text-gray-500">Recherche en cours...</p>';try{const a=e.toLowerCase(),o=a+"Ô£ø",r=ke(Y(w,"users"),ue("displayName_lowercase",">=",a),ue("displayName_lowercase","<",o)),d=ke(Y(w,"users"),ue("email","==",a)),[h,x]=await Promise.all([Ce(r),Ce(d)]),g=new Map;if(h.forEach(c=>g.set(c.id,c.data())),x.forEach(c=>g.set(c.id,c.data())),t.innerHTML="",g.size===0){t.innerHTML='<p class="text-gray-500">Aucun utilisateur trouv√©.</p>';return}g.forEach(c=>{if(c.uid===n)return;const L=document.createElement("div");L.className="bg-gray-50 p-2 rounded-lg flex items-center justify-between",L.innerHTML=`
                <div class="flex items-center">
                    <img src="${c.photoURL||"https://placehold.co/32"}" class="w-8 h-8 rounded-full mr-2">
                    <span class="font-medium text-sm">${c.displayName} (${c.email})</span>
                </div>
            `;const m=document.createElement("button");m.className="btn btn-secondary btn-xs",m.innerHTML='<i class="fas fa-user-plus"></i>',m.addEventListener("click",()=>sa(c.uid)),L.appendChild(m),t.appendChild(L)})}catch(a){console.error("Erreur de recherche: ",a),t.innerHTML='<p class="text-red-500">Erreur de recherche.</p>'}}}async function sa(e){const t=Re()?.uid;if(!t||t===e)return;const n=ke(Y(w,"friend_requests"),ue("senderId","==",t),ue("receiverId","==",e)),a=ke(Y(w,"friend_requests"),ue("senderId","==",e),ue("receiverId","==",t)),[o,r]=await Promise.all([Ce(n),Ce(a)]);if(!o.empty||!r.empty)return alert("Une demande d'ami existe d√©j√† avec cet utilisateur.");if((await Pe(q(w,"users",t))).data()?.friends?.includes(e))return alert("Vous √™tes d√©j√† ami avec cet utilisateur.");try{await He(Y(w,"friend_requests"),{senderId:t,receiverId:e,status:"pending",createdAt:Bt()}),alert("Demande d'ami envoy√©e !")}catch(h){console.error("Erreur lors de l'envoi de la demande d'ami: ",h),alert("Une erreur est survenue.")}}async function yn(){const e=document.getElementById("pending-requests-container"),t=document.getElementById("declined-requests-container"),n=Re()?.uid;if(!(!n||!e||!t)){e.innerHTML='<p class="text-gray-500">Chargement...</p>',t.innerHTML='<p class="text-gray-500">Chargement...</p>';try{const a=ke(Y(w,"friend_requests"),ue("senderId","==",n)),o=await Ce(a),r=[],d=[];for(const h of o.docs){const x={id:h.id,...h.data()},g=await Pe(q(w,"users",x.receiverId));g.exists()&&(x.receiver=g.data()),x.status==="pending"?r.push(x):x.status==="declined"&&d.push(x)}e.innerHTML="",r.length>0?r.forEach(h=>e.appendChild(dn(h))):e.innerHTML='<p class="text-gray-500">Aucune demande en attente.</p>',t.innerHTML="",d.length>0?d.forEach(h=>t.appendChild(dn(h))):t.innerHTML='<p class="text-gray-500">Aucune demande rejet√©e.</p>'}catch(a){console.error("Erreur lors du chargement des demandes envoy√©es: ",a),e.innerHTML='<p class="text-red-500">Erreur de chargement.</p>',t.innerHTML='<p class="text-red-500">Erreur de chargement.</p>'}}}function dn(e){const t=document.createElement("div");t.className="bg-card text-card-foreground p-3 rounded-lg flex items-center justify-between shadow-sm border border-border";const n=e.receiver,a=document.createElement("div");a.className="flex items-center",a.innerHTML=`
        <img src="${n?.photoURL||"https://placehold.co/40"}" 
             alt="Avatar" 
             class="w-10 h-10 rounded-full mr-3 object-cover bg-muted"
             onerror="this.onerror=null; this.src='https://placehold.co/40?text=${n?.displayName?n.displayName.charAt(0).toUpperCase():"?"}';">
        <div>
            <p class="font-bold">${n?.displayName||"Utilisateur inconnu"}</p>
            <p class="text-sm text-muted-foreground">Statut : <span class="font-medium">${e.status}</span></p>
        </div>
    `;const o=document.createElement("button");return o.className="text-red-500 hover:bg-red-50 text-sm px-3 py-1 rounded-md",o.innerHTML='<i class="fas fa-times-circle"></i>',o.title="Annuler la demande",o.addEventListener("click",async()=>{confirm("Voulez-vous vraiment annuler cette demande ?")&&(await ze(q(w,"friend_requests",e.id)),yn())}),t.appendChild(a),t.appendChild(o),t}async function bn(e){try{const t=q(w,"friend_requests",e);await je(t,{status:"accepted"})}catch(t){throw console.error("Erreur lors de l'acceptation de la demande d'ami: ",t),t}}async function ra(e){try{const t=q(w,"friend_requests",e);await je(t,{status:"declined"})}catch(t){throw console.error("Erreur lors du refus de la demande d'ami: ",t),t}}const oa=Object.freeze(Object.defineProperty({__proto__:null,acceptFriendRequest:bn,declineFriendRequest:ra,default:ea},Symbol.toStringTag,{value:"Module"}));function ia(){const e=document.getElementById("ingredients-list-container"),t=document.getElementById("add-ingredient-btn"),n=document.getElementById("category-tabs"),a=document.getElementById("search-bar"),o=document.getElementById("ingredient-form-modal"),r=document.getElementById("ingredient-modal-title"),d=document.getElementById("close-ingredient-modal"),h=document.getElementById("cancel-ingredient-btn"),x=document.getElementById("ingredient-form"),g=document.getElementById("ingredient-id"),c=document.getElementById("ingredient-name"),L=document.getElementById("ingredient-unit"),m=document.getElementById("ingredient-category"),M=document.getElementById("manage-categories-btn"),N=document.getElementById("category-management-modal"),i=document.getElementById("close-category-modal"),S=document.getElementById("done-category-modal-btn"),K=document.getElementById("add-category-form"),ve=document.getElementById("new-category-name"),W=document.getElementById("category-list");let J=[],_=[],I="",T="",X=null;const U=["g","kg","ml","l","pi√®ce(s)","c.√†.s.","c.√†.c.","pinc√©e(s)"];async function G(){await ae(),await Q()}async function ae(){if(w)try{_=(await Ce(Y(w,"ingredient_categories"))).docs.map(z=>({id:z.id,...z.data()})),_.sort((z,O)=>z.name.localeCompare(O.name))}catch(A){console.error("Erreur lors de la r√©cup√©ration des cat√©gories: ",A)}}async function Q(){if(w)try{J=(await Ce(Y(w,"ingredients"))).docs.map(z=>({id:z.id,...z.data()})),le(),ce()}catch(A){console.error("Erreur de chargement des ingr√©dients: ",A)}}function se(A=null){x.reset(),L.innerHTML="",U.forEach(ie=>{const xe=document.createElement("option");xe.value=ie,xe.textContent=ie,L.appendChild(xe)});const z=_.map(ie=>ie.name),O=[...new Set(J.map(ie=>ie.category).filter(Boolean))],D=[...new Set([...z,...O])];D.sort((ie,xe)=>ie.localeCompare(xe.name)),m.innerHTML="",D.forEach(ie=>{const xe=document.createElement("option");xe.value=ie,xe.textContent=ie,m.appendChild(xe)}),A?(r.textContent="Modifier l'ingr√©dient",g.value=A.id,c.value=A.name,L.value=A.unit||"",m.value=A.category||(D.length>0?D[0]:""),document.getElementById("ingredient-image-url").value=A.imageUrl||""):(r.textContent="Ajouter un ingr√©dient",g.value="",L.value=U[0],m.value=I||(D.length>0?D[0]:""));const te=A?A.seasons||[]:[];["Printemps","Et√©","Automne","Hiver"].forEach(ie=>{const xe=`season-${ie.toLowerCase().replace("√©","e")}`,Ge=document.getElementById(xe);Ge&&(Ge.checked=te.includes(ie))}),o.classList.remove("hidden")}function me(){o.classList.add("hidden")}async function H(A){A.preventDefault();const z=g.value,O=[];["Printemps","Et√©","Automne","Hiver"].forEach(te=>{const ie=`season-${te.toLowerCase().replace("√©","e")}`,xe=document.getElementById(ie);xe&&xe.checked&&O.push(te)});const D={name:c.value,unit:L.value,category:m.value,seasons:O,imageUrl:document.getElementById("ingredient-image-url").value||`https://tse2.mm.bing.net/th?q=${encodeURIComponent(c.value)}%20ingredient&w=400&h=300&c=7&rs=1&p=0`};if(!D.name||!D.category){alert("Le nom et la cat√©gorie sont requis.");return}try{z?await xt(q(w,"ingredients",z),D):await He(Y(w,"ingredients"),D),me(),await Q()}catch(te){console.error("Erreur de sauvegarde de l'ingr√©dient: ",te)}}function B(){V(),N.classList.remove("hidden")}function j(){N.classList.add("hidden")}function V(){if(W.innerHTML="",_.length===0){W.innerHTML='<p class="text-gray-500">Aucune cat√©gorie d√©finie.</p>';return}_.forEach(A=>{const z=document.createElement("div");z.className="flex items-center justify-between p-2 border-b";const O=document.createElement("span");O.textContent=A.name,z.appendChild(O);const D=document.createElement("div");D.className="flex space-x-2";const te=document.createElement("button");te.className="text-blue-500 hover:bg-blue-50 text-xs px-2 py-1 rounded-md",te.innerHTML='<i class="fas fa-edit"></i>',te.addEventListener("click",()=>$(A)),D.appendChild(te);const ie=document.createElement("button");ie.className="text-red-500 hover:bg-red-50 text-xs px-2 py-1 rounded-md",ie.innerHTML='<i class="fas fa-trash"></i>',ie.addEventListener("click",()=>de(A)),D.appendChild(ie),z.appendChild(D),W.appendChild(z)})}async function oe(A){A.preventDefault();const z=ve.value.trim();if(z&&!_.find(O=>O.name.toLowerCase()===z.toLowerCase()))try{await He(Y(w,"ingredient_categories"),{name:z}),ve.value="",await ae(),V(),le()}catch(O){console.error("Erreur d'ajout de cat√©gorie: ",O)}else alert("Cette cat√©gorie existe d√©j√† ou le nom est invalide.")}async function $(A){const z=A.name,O=prompt(`Entrez le nouveau nom pour la cat√©gorie "${z}":`,z);if(O&&O.trim()!==""&&O!==z)try{await xt(q(w,"ingredient_categories",A.id),{name:O});const D=ke(Y(w,"ingredients"),ue("category","==",z)),te=await Ce(D),ie=sn(w);te.forEach(xe=>{ie.update(xe.ref,{category:O})}),await ie.commit(),await G(),V()}catch(D){console.error("Erreur de renommage: ",D)}}async function de(A){if(confirm(`√ätes-vous s√ªr de vouloir supprimer la cat√©gorie "${A.name}"?

Tous les ingr√©dients associ√©s seront d√©plac√©s vers la cat√©gorie "Inconnue".`))try{await ze(q(w,"ingredient_categories",A.id));const z=ke(Y(w,"ingredients"),ue("category","==",A.name)),O=await Ce(z),D=sn(w);O.forEach(te=>{D.update(te.ref,{category:"Inconnue"})}),await D.commit(),I="",await G(),V()}catch(z){console.error("Erreur de suppression: ",z)}}function le(){n.innerHTML="";const A=_.map(D=>D.name),z=[...new Set(J.map(D=>D.category||"Inconnue"))];let O=[...new Set([...A,...z])];O.sort((D,te)=>D.localeCompare(te)),O.includes("Inconnue")&&(O=O.filter(D=>D!=="Inconnue"),O.push("Inconnue")),O.length===0&&J.length>0&&O.push("Inconnue"),!I&&O.length>0&&(I=O[0]),O.forEach(D=>{const te=document.createElement("button"),ie=D===I;te.className=`px-4 py-2 text-sm font-medium rounded-t-lg ${ie?"bg-tomato text-white":"text-gray-500 hover:text-tomato"}`,te.textContent=D,te.addEventListener("click",()=>Z(D)),n.appendChild(te)})}function Z(A){I=A,le(),ce()}function ce(){e.innerHTML="";const A=I||(_.length>0?_[0].name:"Inconnue");let z=J.filter(D=>(D.category||"Inconnue")===A);if(T){const D=T.toLowerCase();z=z.filter(te=>te.name.toLowerCase().includes(D))}if(z.length===0){e.innerHTML='<p class="text-center text-gray-500 p-10">Aucun ingr√©dient dans cette cat√©gorie.</p>';return}z.sort((D,te)=>D.name.localeCompare(te.name,"fr",{sensitivity:"base"}));const O=document.createElement("div");O.className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4",z.forEach(D=>{const te=document.createElement("div");if(te.className="p-3 bg-white shadow-sm rounded-lg flex flex-col items-start space-y-2",D.imageUrl){const Qe=document.createElement("img");Qe.src=D.imageUrl,Qe.alt=D.name,Qe.className="w-full h-24 object-cover rounded-md mb-2",te.appendChild(Qe)}const ie=document.createElement("div");ie.className="flex-grow w-full flex justify-between items-center";const xe=document.createElement("span");xe.className="font-medium text-gray-800",xe.textContent=D.name;const Ge=document.createElement("span");if(Ge.className="text-gray-500 text-sm bg-gray-100 px-2 py-1 rounded-full",Ge.textContent=D.unit,ie.appendChild(xe),ie.appendChild(Ge),te.appendChild(ie),D.seasons&&D.seasons.length>0){const Qe=document.createElement("div");Qe.className="w-full flex flex-wrap gap-1 mt-1 px-1";const Dt={Printemps:"üå∏",Et√©:"‚òÄÔ∏è",Automne:"üçÇ",Hiver:"‚ùÑÔ∏è"},ft=["Printemps","Et√©","Automne","Hiver"];D.seasons.sort((Ke,Ye)=>ft.indexOf(Ke)-ft.indexOf(Ye)).forEach(Ke=>{const Ye=document.createElement("span");Ye.textContent=`${Dt[Ke]||""} ${Ke}`,Ye.title=Ke,Ye.className="text-[10px] text-gray-600 bg-gray-100 px-1.5 py-0.5 rounded-full border border-gray-200 whitespace-nowrap",Qe.appendChild(Ye)}),te.appendChild(Qe)}const at=document.createElement("div");at.className="w-full flex justify-end items-center space-x-2 border-t pt-2 mt-2";const st=document.createElement("button");st.className="text-blue-500 hover:bg-blue-50 text-xs px-2 py-1 rounded-md",st.innerHTML='<i class="fas fa-edit"></i>',st.addEventListener("click",()=>se(D));const it=document.createElement("button");it.className="text-red-500 hover:bg-red-50 text-xs px-2 py-1 rounded-md",it.innerHTML='<i class="fas fa-trash-alt"></i>',it.addEventListener("click",()=>pe(D.id,D.name)),at.appendChild(st),at.appendChild(it),te.appendChild(at),O.appendChild(te)}),e.appendChild(O)}async function pe(A,z){if(confirm(`√ätes-vous s√ªr de vouloir supprimer l'ingr√©dient "${z}" ?`))try{await ze(q(w,"ingredients",A)),await Q()}catch(O){console.error("Erreur de suppression de l'ingr√©dient: ",O)}}a.addEventListener("input",A=>{const z=A.target.value.toLowerCase();if(!T&&z&&(X=I),T=z,T){const O=J.find(D=>D.name.toLowerCase().includes(T));O&&(I=O.category||"Inconnue")}else X&&(I=X,X=null);le(),ce()}),t.addEventListener("click",()=>se()),d.addEventListener("click",me),h.addEventListener("click",me),x.addEventListener("submit",H),M.addEventListener("click",B),i.addEventListener("click",j),S.addEventListener("click",j),K.addEventListener("submit",oe),G()}const la=Object.freeze(Object.defineProperty({__proto__:null,default:ia},Symbol.toStringTag,{value:"Module"})),ne={modal:document.getElementById("share-modal"),closeBtn:document.getElementById("close-share-modal"),title:document.getElementById("share-modal-title"),friendsList:document.getElementById("share-friends-list"),sharePlanCheckbox:document.getElementById("share-planning-checkbox"),shareShoppingListCheckbox:document.getElementById("share-shopping-list-checkbox"),confirmBtn:document.getElementById("confirm-share-btn")};let We={};function Tt(){ne.modal.classList.add("hidden");const e=document.getElementById("share-mode-selection");e&&e.classList.remove("hidden"),ne.confirmBtn.textContent="Envoyer le partage";const t=ne.confirmBtn.cloneNode(!0);ne.confirmBtn.parentNode&&(ne.confirmBtn.parentNode.replaceChild(t,ne.confirmBtn),ne.confirmBtn=t,t.addEventListener("click",xn))}async function xn(){const e=De();if(!e||!We.plan)return;const t=Array.from(ne.friendsList.querySelectorAll('input[type="checkbox"]:checked')).map(a=>a.value),n=document.querySelector('input[name="share-mode"]:checked')?.value;if(t.length===0){alert("Veuillez s√©lectionner au moins un ami.");return}if(!n){alert("Veuillez s√©lectionner un mode de partage.");return}ne.confirmBtn.disabled=!0,ne.confirmBtn.textContent="Envoi en cours...";try{const a=Y(w,"shares");let o={};n==="collaborate"?o={senderId:e,createdAt:new Date,type:"collaborative_plan_invite",planId:We.plan.id,planName:We.plan.name}:o={senderId:e,createdAt:new Date,type:"share",plan:{name:We.plan.name,weeks:We.plan.weeks||{},manualItems:We.plan.manualItems||[],defaultNumPeople:We.plan.defaultNumPeople||1,startDay:We.plan.startDay||"Lundi"}};for(const r of t)await He(a,{...o,receiverId:r,status:"pending"});Tt(),alert("Partage envoy√© avec succ√®s !")}catch(a){console.error("Erreur lors de l'envoi du partage : ",a),alert("Une erreur est survenue lors de l'envoi du partage.")}finally{ne.confirmBtn.disabled=!1,ne.confirmBtn.textContent="Envoyer le partage"}}async function Yt(e={}){const{plan:t}=e;if(!t){alert("Aucun plan s√©lectionn√© √† partager.");return}We={plan:t},ne.title.textContent=`Partager le plan "${t.name}"`,ne.friendsList.innerHTML='<p class="text-gray-500">Chargement des amis...</p>',ne.modal.classList.remove("hidden");const n=De();if(n)try{const a=await Pe(q(w,"users",n));if(a.exists()){const r=a.data().friends||[];if(r.length===0){ne.friendsList.innerHTML=`<p class="text-gray-500">Vous n'avez pas d'amis √† qui partager.</p>`;return}ne.friendsList.innerHTML="";for(const d of r){const h=await Pe(q(w,"users",d));if(h.exists()){const x=h.data(),g=document.createElement("label");g.className="flex items-center p-2 hover:bg-gray-100 rounded-lg cursor-pointer";const c=document.createElement("input");c.type="checkbox",c.value=x.uid,c.className="form-checkbox h-5 w-5 text-tomato rounded focus:ring-tomato",g.appendChild(c);const L=document.createElement("img");L.src=x.photoURL||"https://placehold.co/40x40",L.alt=x.displayName,L.className="w-8 h-8 rounded-full ml-3 mr-3",g.appendChild(L);const m=document.createElement("span");m.className="font-medium",m.textContent=x.displayName||x.email,g.appendChild(m),ne.friendsList.appendChild(g)}}}}catch(a){console.error("Erreur lors du chargement des amis pour le partage : ",a),ne.friendsList.innerHTML='<p class="text-red-500">Une erreur est survenue.</p>'}}async function da(e){const t=De();if(!t||!e)return;const n=Array.from(ne.friendsList.querySelectorAll('input[type="checkbox"]:checked:not(:disabled)')).map(a=>a.value);if(n.length===0){alert("Veuillez s√©lectionner au moins un ami √† inviter.");return}ne.confirmBtn.disabled=!0,ne.confirmBtn.textContent="Envoi en cours...";try{const a=await Pe(q(w,"plans",e));if(!a.exists())throw new Error("Plan not found");const o=a.data().name,r=Y(w,"shares"),d={senderId:t,createdAt:new Date,type:"collaborative_plan_invite",planId:e,planName:o};for(const h of n)await He(r,{...d,receiverId:h,status:"pending"});Tt(),alert("Invitation(s) envoy√©e(s) avec succ√®s !")}catch(a){console.error("Erreur lors de l'envoi de l'invitation : ",a),alert("Une erreur est survenue lors de l'envoi de l'invitation.")}finally{ne.confirmBtn.disabled=!1}}async function En(e){if(!e||!e.id){alert("Plan non valide pour l'invitation.");return}We={plan:e},ne.title.textContent=`Inviter √† collaborer sur "${e.name}"`;const t=document.getElementById("share-mode-selection");t&&t.classList.add("hidden"),ne.friendsList.innerHTML='<p class="text-gray-500">Chargement des amis...</p>',ne.modal.classList.remove("hidden");const n=De();if(!n)return;try{const o=await Pe(q(w,"users",n));if(o.exists()){const d=o.data().friends||[],h=[e.userId,...e.collaborators||[]];if(d.length===0){ne.friendsList.innerHTML=`<p class="text-gray-500">Vous n'avez pas d'amis √† inviter.</p>`;return}ne.friendsList.innerHTML="";for(const x of d){const g=await Pe(q(w,"users",x));if(g.exists()){const c=g.data(),L=h.includes(c.uid),m=document.createElement("label");m.className=`flex items-center p-2 rounded-lg ${L?"opacity-50 cursor-not-allowed":"hover:bg-gray-100 cursor-pointer"}`;const M=document.createElement("input");M.type="checkbox",M.value=c.uid,M.className="form-checkbox h-5 w-5 text-tomato rounded focus:ring-tomato",L&&(M.disabled=!0,M.checked=!0),m.appendChild(M);const N=document.createElement("img");N.src=c.photoURL||"https://placehold.co/40x40",N.alt=c.displayName,N.className="w-8 h-8 rounded-full ml-3 mr-3",m.appendChild(N);const i=document.createElement("span");if(i.className="font-medium",i.textContent=c.displayName||c.email,L){const S=document.createElement("span");S.className="text-xs text-gray-400 ml-2",S.textContent="(d√©j√† membre)",i.appendChild(S)}m.appendChild(i),ne.friendsList.appendChild(m)}}}}catch(o){console.error("Erreur lors du chargement des amis pour l'invitation : ",o),ne.friendsList.innerHTML='<p class="text-red-500">Une erreur est survenue.</p>'}ne.confirmBtn.textContent="Envoyer l'invitation";const a=ne.confirmBtn.cloneNode(!0);ne.confirmBtn.parentNode.replaceChild(a,ne.confirmBtn),ne.confirmBtn=a,a.addEventListener("click",()=>da(e.id))}ne.closeBtn?.addEventListener("click",Tt);ne.modal?.addEventListener("click",e=>{e.target===ne.modal&&Tt()});ne.confirmBtn?.addEventListener("click",xn);const ca=Object.freeze(Object.defineProperty({__proto__:null,openInviteParticipantModal:En,openShareModal:Yt},Symbol.toStringTag,{value:"Module"}));function ua(){const e=document.getElementById("search-bar"),t=document.getElementById("lists-container"),n=document.getElementById("add-list-btn"),a=document.getElementById("shared-lists-container"),o=document.getElementById("list-form-modal"),r=document.getElementById("list-modal-title"),d=document.getElementById("close-list-modal"),h=document.getElementById("cancel-list-btn"),x=document.getElementById("list-form"),g=document.getElementById("list-id"),c=document.getElementById("list-name"),L=document.getElementById("ingredients-list"),m=document.getElementById("add-ingredient-btn"),M=document.getElementById("save-list-btn");let N=[],i="",S=[],K=[];async function ve(){await W(),await J(),await _()}async function W(){if(w)try{S=(await Ce(Y(w,"ingredients"))).docs.map(B=>({id:B.id,...B.data()})),S.sort((B,j)=>B.name.localeCompare(j.name))}catch(H){console.error("Erreur lors de la r√©cup√©ration de la liste des ingr√©dients: ",H)}}async function J(){const H=De();if(!(!w||!H))try{const B=ke(Y(w,"shopping_lists"),ue("userId","==",H));N=(await Ce(B)).docs.map(V=>({id:V.id,...V.data()})).filter(V=>V.isShared!==!0),G()}catch(B){console.error("Erreur de chargement des listes: ",B)}}async function _(){const H=De();if(!(!w||!H)){console.log(`Recherche de listes partag√©es pour userId: ${H}`);try{const B=ke(Y(w,"shopping_lists"),ue("userId","==",H),ue("isShared","==",!0)),j=await Ce(B);console.log(`Trouv√© ${j.size} liste(s) partag√©e(s).`);const V=j.docs.map(oe=>({id:oe.id,...oe.data()}));ae(V)}catch(B){console.error("Erreur de chargement des listes partag√©es: ",B)}}}async function I(H=null){await W(),x.reset(),L.innerHTML="",K=[],H?(r.textContent="Modifier la liste",g.value=H.id,c.value=H.name,H.ingredients&&H.ingredients.length>0?H.ingredients.forEach(B=>U(B)):U()):(r.textContent="Cr√©er une liste",g.value="",U()),o.classList.remove("hidden")}function T(){o.classList.add("hidden")}async function X(H){H.preventDefault(),M.disabled=!0;const B=De();if(!B){alert("Erreur : utilisateur non connect√©."),M.disabled=!1;return}const j=K.filter($=>$&&$.name&&$.quantity),V={name:c.value,ingredients:j,userId:B};if(!V.name){alert("Le nom de la liste est requis."),M.disabled=!1;return}const oe=g.value;try{oe?await xt(q(w,"shopping_lists",oe),V):await He(Y(w,"shopping_lists"),V),T(),await J()}catch($){console.error("Erreur de sauvegarde de la liste: ",$)}finally{M.disabled=!1}}function U(H={quantity:"",name:"",unit:""}){const B=document.createElement("div");B.className="relative flex items-stretch space-x-2 ingredient-row";const j={...H};K.push(j);const V=K.length-1,oe=document.createElement("input");oe.type="text",oe.className="ingredient-quantity mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm",oe.placeholder="Qt√©",oe.value=j.quantity,oe.addEventListener("change",pe=>{K[V].quantity=pe.target.value});const $=document.createElement("input");$.type="text",$.className="ingredient-unit mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm bg-gray-100",$.placeholder="Unit√©",$.readOnly=!0,$.value=j.unit||"";const de=document.createElement("div");de.className="relative w-1/2";const le=document.createElement("input");le.type="text",le.className="ingredient-name mt-1 block w-full rounded-md border-gray-300 shadow-sm",le.placeholder="Chercher un ingr√©dient...",le.value=j.name,de.appendChild(le);const Z=document.createElement("div");Z.className="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto",de.appendChild(Z),le.addEventListener("input",()=>{const pe=le.value.toLowerCase();if(!pe){Z.classList.add("hidden");return}const A=S.filter(O=>O.name.toLowerCase().includes(pe));Z.innerHTML="",A.forEach(O=>{const D=document.createElement("div");D.className="p-2 ingredient-search-item cursor-pointer",D.textContent=O.name,D.addEventListener("click",()=>{le.value=O.name,$.value=O.unit,Z.classList.add("hidden"),K[V].name=O.name,K[V].unit=O.unit,K[V].id=O.id}),Z.appendChild(D)});const z=document.createElement("div");z.className="p-2 bg-blue-50 hover:bg-blue-200 cursor-pointer font-bold text-blue-700",z.textContent=`+ Cr√©er "${le.value}"`,z.addEventListener("click",async()=>{const O=le.value,D="pi√®ce(s)";try{const te=await He(Y(w,"ingredients"),{name:O,unit:D,category:"Inconnue"});await W(),le.value=O,$.value=D,Z.classList.add("hidden"),K[V].name=O,K[V].unit=D,K[V].id=te.id}catch(te){console.error("Erreur d'ajout d'ingr√©dient",te),alert("L'ingr√©dient n'a pas pu √™tre cr√©√©.")}}),Z.appendChild(z),Z.classList.remove("hidden")});const ce=document.createElement("button");ce.type="button",ce.className="text-red-500 hover:bg-red-50 text-sm px-3 py-1 rounded-md mt-1",ce.innerHTML='<i class="fas fa-trash"></i>',ce.addEventListener("click",()=>{B.remove(),K[V]=null}),B.appendChild(de),B.appendChild(oe),B.appendChild($),B.appendChild(ce),L.appendChild(B)}function G(){t.innerHTML="";let H=N;if(i){const B=i.toLowerCase();H=N.filter(j=>j.name.toLowerCase().includes(B))}if(H.length===0){t.innerHTML='<p class="text-center text-gray-500 p-10 col-span-full">Aucune liste de courses trouv√©e.</p>';return}H.sort((B,j)=>B.name.localeCompare(j.name)),H.forEach(B=>{const j=document.createElement("div");j.className="bg-white rounded-lg shadow-md p-4 flex flex-col";const V=document.createElement("div");V.className="flex justify-between items-start border-b pb-2 mb-2";const oe=document.createElement("h4");oe.className="text-lg font-bold text-gray-800",oe.textContent=B.name,V.appendChild(oe);const $=document.createElement("div");$.className="flex space-x-2";const de=document.createElement("button");de.className="text-blue-500 hover:bg-blue-50 text-sm px-3 py-1 rounded-md",de.innerHTML='<i class="fas fa-edit"></i>',de.addEventListener("click",()=>I(B)),$.appendChild(de);const le=document.createElement("button");le.className="text-green-500 hover:bg-green-50 text-sm px-3 py-1 rounded-md",le.innerHTML='<i class="fas fa-share-alt"></i>',le.addEventListener("click",()=>Yt({})),$.appendChild(le);const Z=document.createElement("button");Z.className="text-red-500 hover:bg-red-50 text-sm px-3 py-1 rounded-md",Z.innerHTML='<i class="fas fa-trash"></i>',Z.addEventListener("click",()=>Q(B.id,B.name)),$.appendChild(Z),V.appendChild($);const ce=document.createElement("ul");ce.className="space-y-1 text-sm text-gray-600 flex-grow",B.ingredients&&B.ingredients.length>0?B.ingredients.forEach(pe=>{const A=document.createElement("li");A.textContent=`${pe.quantity} ${pe.unit||""} - ${pe.name}`.trim(),ce.appendChild(A)}):ce.innerHTML='<li class="italic text-gray-400">Cette liste est vide.</li>',j.appendChild(V),j.appendChild(ce),t.appendChild(j)})}function ae(H){if(a.innerHTML="",H.length===0){a.innerHTML='<p class="text-center text-gray-500 p-10 col-span-full">Aucune liste de courses partag√©e trouv√©e.</p>';return}H.sort((B,j)=>B.name.localeCompare(j.name)),H.forEach(B=>{const j=document.createElement("div");j.className="bg-white rounded-lg shadow-md p-4 flex flex-col";const V=document.createElement("div");V.className="flex justify-between items-start border-b pb-2 mb-2";const oe=document.createElement("h4");oe.className="text-lg font-bold text-gray-800",oe.textContent=B.name,V.appendChild(oe);const $=document.createElement("div");$.className="flex space-x-2";const de=document.createElement("button");de.className="btn btn-secondary btn-sm",de.innerHTML='<i class="fas fa-copy mr-2"></i> Copier dans mes listes',de.title="Copier cette liste dans vos listes personnelles",de.addEventListener("click",()=>me(B.id)),$.appendChild(de);const le=document.createElement("button");le.className="text-red-500 hover:bg-red-50 text-sm px-3 py-1 rounded-md",le.innerHTML='<i class="fas fa-trash"></i>',le.title="Supprimer cette liste partag√©e",le.addEventListener("click",()=>se(B.id,B.name)),$.appendChild(le),V.appendChild($);const Z=document.createElement("ul");Z.className="space-y-1 text-sm text-gray-600 flex-grow",B.ingredients&&B.ingredients.length>0?B.ingredients.forEach(ce=>{const pe=document.createElement("li");pe.textContent=`${ce.quantity} ${ce.unit||""} - ${ce.name}`.trim(),Z.appendChild(pe)}):Z.innerHTML='<li class="italic text-gray-400">Cette liste est vide.</li>',j.appendChild(V),j.appendChild(Z),a.appendChild(j)})}async function Q(H,B){if(confirm(`√ätes-vous s√ªr de vouloir supprimer la liste "${B}" ?`))try{await ze(q(w,"shopping_lists",H)),await J()}catch(j){console.error("Erreur de suppression de la liste: ",j)}}async function se(H,B){if(confirm(`√ätes-vous s√ªr de vouloir supprimer la liste partag√©e "${B}" ?`))try{await ze(q(w,"shopping_lists",H)),await _()}catch(j){console.error("Erreur de suppression de la liste partag√©e: ",j),alert("Une erreur est survenue.")}}async function me(H){if(confirm("Voulez-vous vraiment copier cette liste dans vos listes personnelles ? Elle ne sera plus consid√©r√©e comme une liste partag√©e."))try{const B=q(w,"shopping_lists",H);await je(B,{isShared:!1}),await ve()}catch(B){console.error("Erreur lors de la copie de la liste: ",B),alert("Une erreur est survenue.")}}e.addEventListener("input",H=>{i=H.target.value,G()}),n.addEventListener("click",()=>I()),d.addEventListener("click",T),h.addEventListener("click",T),x.addEventListener("submit",X),m.addEventListener("click",()=>U()),w&&ve()}const ma=Object.freeze(Object.defineProperty({__proto__:null,default:ua},Symbol.toStringTag,{value:"Module"})),Fe=hn();let Et,Ht,At,yt,Le,wt,jt,Rt,bt,ot,Lt,qt,Ut,zt,Vt,St=null,Nt=null;function Qt(){Et&&Et.classList.remove("hidden")}function ht(){Et&&Et.classList.add("hidden"),yt&&yt.reset()}function wn(e,t){Nt=e,ot&&(ot.value=t),wt&&wt.classList.remove("hidden"),ot&&ot.focus()}function vt(){Nt=null,wt&&wt.classList.add("hidden"),bt&&bt.reset()}function Ln(e,t){St=e,zt&&(zt.textContent="Confirmer la suppression"),Vt&&(Vt.textContent=`√ätes-vous s√ªr de vouloir supprimer le plan "${t}" ? Cette action est irr√©versible.`),Lt&&Lt.classList.remove("hidden")}function Ot(){St=null,Lt&&Lt.classList.add("hidden")}async function pa(e){const t=Re();if(t)try{await He(Y(Fe,"plans"),{userId:t.uid,name:e,type:"personal",weeks:{},manualItems:[],checkedItems:{},defaultNumPeople:1,startDay:"Lundi",lastUpdated:new Date}),ht()}catch(n){console.error("Error creating plan: ",n),alert("Erreur lors de la cr√©ation du plan.")}}async function fa(e,t){if(!(!e||!t))try{const n=q(Fe,"plans",e);await je(n,{name:t}),vt()}catch(n){console.error("Error renaming plan: ",n),alert("Erreur lors du renommage du plan.")}}async function ga(e){const t=Re()?.uid;if(!(!e||!t)&&confirm("Voulez-vous vraiment quitter ce plan partag√© ? Il n'appara√Ætra plus dans votre liste."))try{const n=q(Fe,"plans",e);await je(n,{collaborators:gn(t)})}catch(n){console.error("Erreur pour quitter le plan: ",n),alert("Une erreur est survenue.")}}async function ha(e){if(e)try{await ze(q(Fe,"plans",e))}catch(t){console.error("Error deleting plan: ",t),alert("Erreur lors de la suppression du plan.")}}function Xt(e){const t=Re();if(!t)return()=>{};let n=new Map;const a=()=>{e(Array.from(n.values()).sort((g,c)=>g.name.localeCompare(c.name)))},o=async g=>{const L=[g.userId,...g.collaborators||[]].map(M=>Pe(q(Fe,"users",M)));return(await Promise.all(L)).map(M=>M.exists()?M.data():{uid:M.id,displayName:"Inconnu"})},r=ke(Y(Fe,"plans"),ue("userId","==",t.uid)),d=Je(r,async g=>{const L=g.docChanges().map(async m=>{if(m.type==="removed")n.delete(m.doc.id);else{const M=m.doc.data(),N=await o(M);n.set(m.doc.id,{id:m.doc.id,...M,isOwner:!0,participants:N})}});await Promise.all(L),a()}),h=ke(Y(Fe,"plans"),ue("collaborators","array-contains",t.uid)),x=Je(h,async g=>{const L=g.docChanges().map(async m=>{if(m.type==="removed")n.delete(m.doc.id);else{const M=m.doc.data(),N=await o(M),i=N.find(S=>S.uid===M.userId);n.set(m.doc.id,{id:m.doc.id,...M,isOwner:!1,ownerName:i?.displayName||"Inconnu",participants:N})}});await Promise.all(L),a()});return()=>{d(),x()}}function Cn(e){if(!Le)return;const t=Le.value;if(Le.innerHTML="",e.length===0){const n=document.createElement("option");n.value="",n.textContent="Aucun plan personnel",n.disabled=!0,Le.appendChild(n);return}e.forEach(n=>{const a=document.createElement("option");a.value=n.id;let o=n.name;n.collaborators&&n.collaborators.length>0&&(n.isOwner?o=`üëë ${n.name} [Collab]`:o=`üë• ${n.name} [Collab] (de ${n.ownerName})`),a.textContent=o,Le.appendChild(a)}),t&&Le.querySelector(`option[value="${t}"]`)?Le.value=t:Le.selectedIndex=0}function In(){Et=document.getElementById("create-plan-modal"),Ht=document.getElementById("close-create-plan-modal"),At=document.getElementById("cancel-create-plan-btn"),yt=document.getElementById("create-plan-form"),Le=document.getElementById("plan-select"),wt=document.getElementById("rename-plan-modal"),jt=document.getElementById("close-rename-plan-modal"),Rt=document.getElementById("cancel-rename-plan-btn"),bt=document.getElementById("rename-plan-form"),ot=document.getElementById("new-plan-name"),Lt=document.getElementById("delete-confirm-modal"),qt=document.getElementById("cancel-delete-btn"),Ut=document.getElementById("confirm-delete-btn"),zt=document.getElementById("delete-confirm-title"),Vt=document.getElementById("delete-confirm-message");const e=document.getElementById("create-plan-btn"),t=document.getElementById("rename-plan-btn"),n=document.getElementById("leave-plan-btn"),a=document.getElementById("delete-plan-btn"),o=c=>{c.preventDefault();const L=document.getElementById("plan-name");L&&L.value&&pa(L.value)},r=c=>{c.preventDefault(),Nt&&ot.value&&fa(Nt,ot.value)},d=()=>{St&&ha(St).then(()=>{Ot()})},h=()=>{if(Le&&Le.value){const c=Le.options[Le.selectedIndex];wn(Le.value,c.text)}else alert("Veuillez s√©lectionner un plan √† renommer.")},x=()=>{Le&&Le.value?ga(Le.value):alert("Veuillez s√©lectionner un plan.")},g=()=>{if(Le&&Le.value){const c=Le.options[Le.selectedIndex].text;Ln(Le.value,c)}else alert("Veuillez s√©lectionner un plan √† supprimer.")};return e?.addEventListener("click",Qt),t?.addEventListener("click",h),n?.addEventListener("click",x),a?.addEventListener("click",g),Ht?.addEventListener("click",ht),At?.addEventListener("click",ht),yt?.addEventListener("submit",o),jt?.addEventListener("click",vt),Rt?.addEventListener("click",vt),bt?.addEventListener("submit",r),qt?.addEventListener("click",Ot),Ut?.addEventListener("click",d),()=>{e?.removeEventListener("click",Qt),t?.removeEventListener("click",h),n?.removeEventListener("click",x),a?.removeEventListener("click",g),Ht?.removeEventListener("click",ht),At?.removeEventListener("click",ht),yt?.removeEventListener("submit",o),jt?.removeEventListener("click",vt),Rt?.removeEventListener("click",vt),bt?.removeEventListener("submit",r),qt?.removeEventListener("click",Ot),Ut?.removeEventListener("click",d)}}async function va(e,t){if(!(!e||!t))try{const n=q(Fe,"plans",e);await je(n,{collaborators:qn(t),type:"collaborative"})}catch(n){console.error("Error adding collaborator: ",n)}}async function Wt(e,t,n="Modification diverse"){if(!e||!t)return;const a=Re();if(a)try{const o=Y(Fe,"plans",e,"history"),r=JSON.parse(JSON.stringify(t));await He(o,{planState:r,timestamp:Bt(),modifiedBy:a.uid,modifiedByName:a.displayName||a.email,description:n})}catch(o){console.error("Error saving history:",o)}}async function kn(e,t){const n=Re();if(!(!n||!e||!t))try{const a=Y(Fe,"plan_saves"),o=ke(a,ue("userId","==",n.uid),ue("name","==",e)),r=await Ce(o);if(r.empty)await He(a,{userId:n.uid,name:e,savedAt:Bt(),planData:t});else{const d=r.docs[0].id,h=q(Fe,"plan_saves",d);await je(h,{planData:t,savedAt:Bt()})}}catch(a){console.error("Error saving or updating plan save:",a),alert("Erreur lors de la sauvegarde.")}}async function ya(e,t,n){if(!e||!t||!n)return;const a=q(Fe,"plans",e);try{await je(a,{[`weeks.${t}`]:n,lastUpdated:new Date}),console.log(`Week ${t} of plan ${e} saved successfully.`)}catch(o){console.error("Error saving plan week:",o),alert("Erreur lors de la sauvegarde du plan.")}}const ba=Object.freeze(Object.defineProperty({__proto__:null,addCollaborator:va,getUserPlans:Xt,initPlanManagement:In,openCreatePlanModal:Qt,openDeleteConfirmModal:Ln,openRenamePlanModal:wn,populatePlanSelector:Cn,saveHistory:Wt,saveOrUpdatePlanSaveByName:kn,savePlanWeek:ya},Symbol.toStringTag,{value:"Module"}));let Bn=[],Mn=[],Sn=()=>{},Nn=()=>{};const re={btn:null,btnMobile:null,badge:null,badgeMobile:null,dropdown:null,list:null};async function xa(e,t,n){const a=De();if(a)try{const o=q(w,"shares",e);if(await je(o,{status:"accepted"}),t.plan){const r=n.displayName||"Inconnu",d=`Copie de "${t.plan.name}" (de ${r})`,h={...t.plan,userId:a,name:d,isShared:!0,originalOwnerId:t.senderId,sharedAt:new Date,collaborators:[]};delete h.id,await He(Y(w,"plans"),h)}t.shoppingList&&await He(Y(w,"shopping_lists"),{name:`${t.shoppingList.name} (de ${n.displayName})`,ingredients:t.shoppingList.ingredients,userId:a,isShared:!0,originalOwner:n.uid,sharedAt:new Date})}catch(o){console.error("Erreur lors de l'acceptation du partage : ",o),alert("Une erreur est survenue.")}}async function cn(e){try{const t=q(w,"shares",e);await je(t,{status:"declined"})}catch(t){console.error("Erreur lors du refus du partage : ",t),alert("Une erreur est survenue.")}}async function Ea(e){try{await bn(e)}catch{alert("Erreur lors de l'acceptation.")}}function Tn(){if(!re.list)return;const e=[...Bn,...Mn];e.sort((n,a)=>a.createdAt.toMillis()-n.createdAt.toMillis());const t=n=>{n&&(e.length>0?(n.textContent=e.length,n.classList.remove("hidden")):n.classList.add("hidden"))};t(re.badge),t(re.badgeMobile),re.list.innerHTML="",e.length===0?re.list.innerHTML='<p class="text-gray-500 text-center p-4">Aucune nouvelle notification.</p>':e.forEach(n=>{const a=wa(n);re.list.appendChild(a)})}function wa(e){const t=document.createElement("div");t.className="p-3 border-b border-gray-100 hover:bg-gray-50";const n=document.createElement("p");n.className="text-sm font-medium text-gray-800";const a=document.createElement("p");a.className="text-xs text-gray-500 mb-3";const o=document.createElement("div");o.className="flex space-x-2 justify-end";const r=e.data.type||e.type;if(r==="collaborative_plan_invite"){n.textContent="Invitation √† collaborer",a.textContent=`${e.sender.displayName} vous invite √† modifier son plan "${e.data.planName}".`;const d=gt("Refuser","text-red-500 hover:bg-red-50 px-3 py-1 rounded-md",h=>{h.target.disabled=!0,cn(e.id)});o.append(acceptBtn,d)}else if(r==="share"){n.textContent=`Partage de ${e.sender.displayName||e.sender.email}`;let d=[];e.data.plan&&d.push("planification"),e.data.shoppingList&&d.push("liste de courses"),a.textContent=`Contenu : ${d.join(" et ")}`;const h=gt("Accepter","btn-secondary",g=>{g.target.textContent="...",g.target.disabled=!0,xa(e.id,e.data,e.sender)}),x=gt("Refuser","text-red-500 hover:bg-red-50 px-3 py-1 rounded-md",g=>{g.target.disabled=!0,cn(e.id)});o.append(h,x)}else if(r==="friend_request"){n.textContent="Invitation d'ami",a.textContent=`${e.sender.displayName||e.sender.email} vous a envoy√© une invitation.`;const d=gt("Accepter","btn-secondary",x=>{x.target.textContent="...",x.target.disabled=!0,Ea(e.id)}),h=gt("Refuser","text-red-500 hover:bg-red-50 px-3 py-1 rounded-md",x=>{});o.append(d,h)}return t.append(n,a,o),t}function gt(e,t,n){const a=document.createElement("button");return a.className=`btn btn-xs ${t}`,a.textContent=e,a.addEventListener("click",o=>{o.stopPropagation(),n(o)}),a}function La(e){const t=Y(w,"shares"),n=ke(t,ue("receiverId","==",e),ue("status","==","pending"));Sn=Je(n,async a=>{const o=[];for(const r of a.docs){const d=r.data(),h=await Pe(q(w,"users",d.senderId));h.exists()&&o.push({type:d.type||"share",id:r.id,data:d,sender:h.data(),createdAt:d.createdAt})}Bn=o,Tn()},a=>{console.error("Erreur d'√©coute des partages:",a)})}function Ca(e){const t=Y(w,"friend_requests"),n=ke(t,ue("receiverId","==",e),ue("status","==","pending"));Nn=Je(n,async a=>{const o=[];for(const r of a.docs){const d=r.data(),h=await Pe(q(w,"users",d.senderId));h.exists()&&o.push({type:"friend_request",id:r.id,data:d,sender:h.data(),createdAt:d.createdAt})}Mn=o,Tn()},a=>{console.error("Erreur d'√©coute des invitations d'amis:",a)})}function Zt(){if(re.btn=document.getElementById("notifications-btn"),re.btnMobile=document.getElementById("notifications-btn-mobile"),re.badge=document.getElementById("notifications-badge"),re.badgeMobile=document.getElementById("notifications-badge-mobile"),re.dropdown=document.getElementById("notifications-dropdown"),re.list=document.getElementById("notifications-list"),!re.btn||!re.dropdown)return;const e=De();if(!e)return;Sn(),Nn(),La(e),Ca(e);const t=n=>{if(n.stopPropagation(),!re.dropdown.classList.toggle("hidden")){const o=window.innerWidth<768,r=o?re.btnMobile:re.btn;if(!r)return;const d=r.getBoundingClientRect();re.dropdown.style.position="fixed",o?(re.dropdown.style.top=`${d.bottom+8}px`,re.dropdown.style.left="50%",re.dropdown.style.transform="translateX(-50%)",re.dropdown.style.width="95vw",re.dropdown.style.right="auto"):(re.dropdown.style.top=`${d.bottom+8}px`,re.dropdown.style.left="auto",re.dropdown.style.right=`${window.innerWidth-d.right}px`,re.dropdown.style.transform="none",re.dropdown.style.width="20rem")}};re.btn.addEventListener("click",t),re.btnMobile&&re.btnMobile.addEventListener("click",t),document.addEventListener("click",n=>{re.dropdown&&!re.dropdown.classList.contains("hidden")&&(re.btn.contains(n.target)||re.btnMobile&&re.btnMobile.contains(n.target)||re.dropdown.contains(n.target)||re.dropdown.classList.add("hidden"))})}const Ia=Object.freeze(Object.defineProperty({__proto__:null,initNotifications:Zt},Symbol.toStringTag,{value:"Module"}));function ka(){const e=Re();if(e){const n=document.getElementById("user-display-name");n&&(n.textContent=e.displayName||e.email)}const t=document.querySelectorAll(".nav-btn");t.forEach(n=>{n.addEventListener("click",a=>{const o=a.currentTarget.dataset.path;Ve(o),t.forEach(r=>{r.classList.remove("bg-tomato","text-white"),r.classList.add("bg-white","text-tomato")}),a.currentTarget.classList.add("bg-tomato","text-white"),a.currentTarget.classList.remove("bg-white","text-tomato")})}),Ve("menu"),Zt()}document.addEventListener("DOMContentLoaded",()=>{Gt().then(m=>{m&&ka()});const e=document.getElementById("profile-btn"),t=document.getElementById("profile-menu");e&&t&&(e.addEventListener("click",m=>{m.stopPropagation(),t.classList.toggle("hidden");const M=!t.classList.contains("hidden");e.setAttribute("aria-expanded",M)}),document.addEventListener("click",m=>{!(t.contains(m.target)||e.contains(m.target))&&!t.classList.contains("hidden")&&(t.classList.add("hidden"),e.setAttribute("aria-expanded","false"))}));const n=document.getElementById("settings-link"),a=document.getElementById("settings-modal"),o=document.getElementById("close-settings-modal"),r=document.getElementById("dark-mode-toggle"),d=m=>{m==="dark"?(document.documentElement.classList.add("dark"),r&&(r.checked=!0)):(document.documentElement.classList.remove("dark"),r&&(r.checked=!1))},h=localStorage.getItem("theme");h?d(h):window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?d("dark"):d("light"),n&&a&&n.addEventListener("click",m=>{m.preventDefault(),a.classList.remove("hidden")}),o&&a&&o.addEventListener("click",()=>{a.classList.add("hidden")}),a&&a.addEventListener("click",m=>{m.target===a&&a.classList.add("hidden")}),r&&r.addEventListener("change",()=>{const m=r.checked?"dark":"light";localStorage.setItem("theme",m),d(m)});const x=document.getElementById("mobile-menu-btn"),g=document.getElementById("mobile-menu");let c=null;x&&g?(console.log("Mobile menu initialized (Overlay Mode)"),x.addEventListener("click",m=>{m.stopPropagation(),c?(c.remove(),c=null):(c=document.createElement("div"),c.id="mobile-menu-overlay-container",c.innerHTML=g.innerHTML,Object.assign(c.style,{position:"fixed",top:"60px",left:"0",width:"100%",backgroundColor:"#3D405B",zIndex:"10000",boxShadow:"0 4px 6px rgba(0,0,0,0.1)",padding:"1rem",display:"block"}),c.addEventListener("click",M=>{const N=M.target.closest("button");if(!N)return;const i=N.dataset.path;if(i)console.log("Overlay: Navigating directly to",i),Ve(i);else if(N.id==="profile-btn-mobile")console.log("Overlay: Opening settings"),a&&a.classList.remove("hidden");else{let S=null;N.id&&(S=document.getElementById(N.id)),S?(console.log("Overlay: Delegating click to original:",S),S.click()):console.warn("Overlay: No action found for",N)}c&&(c.remove(),c=null)}),document.body.appendChild(c))}),document.addEventListener("click",m=>{c&&!c.contains(m.target)&&!x.contains(m.target)&&(c.remove(),c=null)})):console.warn("Mobile menu elements missing");const L=document.getElementById("profile-btn-mobile");L&&a&&L.addEventListener("click",()=>{a.classList.remove("hidden")}),mobileNavButtons.forEach(m=>{m.addEventListener("click",M=>{const N=M.currentTarget.dataset.path;Ve(N)})})});const Ba=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"}));let nt=null,pt=null;function Dn(e,t){if(!$t||!e)return;const n=Re();if(!n)return;const a=rn($t,`plans_presence/${e}`);nt=rn($t,`plans_presence/${e}/${n.uid}`);const o={displayName:n.displayName||n.email,photoURL:n.photoURL,status:"idle",last_seen:vn()};Un(nt).remove(),On(nt,o),pt&&pt(),pt=Fn(a,r=>{const d=r.val()||{};typeof t=="function"&&t(d)})}function Pn(){nt&&(zn(nt),nt=null),pt&&(pt(),pt=null)}function kt(e){nt&&Vn(nt,{status:e,last_seen:vn()})}const Ma=Object.freeze(Object.defineProperty({__proto__:null,connectToPresenceChannel:Dn,disconnectFromPresenceChannel:Pn,updateUserActivity:kt},Symbol.toStringTag,{value:"Module"}));let dt=null;async function en(e,t){if(!e)return;const n=q(w,"recipes",e);try{await je(n,{isFavorite:!t})}catch(a){console.error("Error toggling favorite status:",a)}}function Sa(){const e=document.getElementById("search-bar"),t=document.getElementById("category-tabs"),n=document.getElementById("recipe-list-container"),a=document.getElementById("add-recipe-btn");dt&&dt.destroy(),dt=new Kt(w,"edit-recipe-form-modal","edit-recipe-form","edit-recipe-modal-title","edit-recipe-id","edit-recipe-name","edit-recipe-category","edit-recipe-servings","edit-recipe-prep-time","edit-recipe-difficulty","edit-recipe-steps","edit-ingredients-list","edit-add-ingredient-btn","edit-save-recipe-btn","close-edit-recipe-modal","edit-cancel-recipe-btn"),dt.setOnSaveCallback(()=>{});let o=[],r="",d="",h=null;const x=["Entr√©e","Plat","Accompagnement","Dessert"],g={PLAT:"bg-orange-100",DESSERT:"bg-amber-100",ENTREE:"bg-lime-100",ACCOMPAGNEMENT:"bg-stone-200","PETIT-DEJEUNER":"bg-orange-100",BOISSON:"bg-cyan-100",SAUCE:"bg-red-100"},c={PLAT:"text-orange-800",DESSERT:"text-amber-800",ENTREE:"text-lime-800",ACCOMPAGNEMENT:"text-stone-800","PETIT-DEJEUNER":"text-orange-800",BOISSON:"text-cyan-800",SAUCE:"text-red-800"},L="bg-gray-100",m="text-gray-800";function M(){return w?Je(Y(w,"recipes"),J=>{console.log("Recipe data updated on /recipes page from listener."),o=J.docs.map(_=>({id:_.id,..._.data()})),i(),S()},J=>{console.error("Erreur lors de l'√©coute des recettes: ",J)}):()=>{}}function N(W){r=W,i(),S()}function i(){if(!t)return;t.innerHTML="";const J=[...new Set(o.map(_=>_.category||"Non class√©"))].sort((_,I)=>{const T=G=>{const ae=G.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();for(let Q=0;Q<x.length;Q++)if(x[Q].normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()===ae)return Q;return-1},X=T(_),U=T(I);return X>-1&&U>-1?X-U:X>-1?-1:U>-1?1:_.localeCompare(I)});!r&&J.length>0&&(r=J[0]),J.forEach(_=>{const I=document.createElement("button"),T=_.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toUpperCase();if(_===r){const U=g[T]||L,G=c[T]||m;I.className=`px-4 py-2 text-sm font-bold rounded-t-lg ${U} ${G}`}else I.className="px-4 py-2 text-sm font-medium text-gray-500 hover:text-tomato";I.textContent=_,I.addEventListener("click",()=>N(_)),t.appendChild(I)})}function S(){if(!n)return;n.innerHTML="";let W=o.filter(_=>(_.category||"Non class√©")===r);if(d){const _=d.toLowerCase();W=W.filter(I=>I.name.toLowerCase().includes(_))}if(W.sort((_,I)=>_.name.localeCompare(I.name)),W.length===0){n.innerHTML='<p class="text-gray-500 text-center p-10">Aucune recette trouv√©e.</p>';return}const J=document.createElement("div");J.className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4",W.forEach(_=>{J.appendChild(K(_))}),n.appendChild(J)}function K(W){const J=document.createElement("div");if(J.className="bg-white dark:bg-gray-800 shadow-md rounded-lg flex flex-col p-3",W.imageUrl){const se=document.createElement("img");se.src=W.imageUrl,se.alt=W.name,se.className="w-full h-24 object-cover rounded-md mb-2",J.appendChild(se)}const _=document.createElement("div");_.className="w-full flex justify-between items-start";const I=document.createElement("h4");I.className="font-bold text-gray-800 dark:text-gray-200 pr-2",I.textContent=W.name,I.title=W.name,_.appendChild(I);const T=document.createElement("button");T.className="text-lg flex-shrink-0",T.innerHTML='<i class="fas fa-heart"></i>',W.isFavorite?T.classList.add("text-red-500"):T.classList.add("text-gray-300","dark:text-gray-500","hover:text-red-400"),T.addEventListener("click",se=>{se.stopPropagation(),en(W.id,W.isFavorite)}),_.appendChild(T),J.appendChild(_);const X=document.createElement("p");X.className="text-sm text-gray-600 dark:text-gray-400 mt-1 w-full",X.textContent=`${W.difficulty||""} - Pour ${W.servings||"?"} pers.`,J.appendChild(X);const U=document.createElement("div");U.className="flex-grow",J.appendChild(U);const G=document.createElement("div");G.className="w-full flex justify-end items-center space-x-2 border-t dark:border-gray-700 pt-2 mt-2";const ae=document.createElement("button");ae.className="text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/50 text-sm px-3 py-1 rounded-md",ae.innerHTML='<i class="fas fa-edit"></i>',ae.title="Modifier",ae.addEventListener("click",()=>dt.openForm(W,"Modifier la recette")),G.appendChild(ae);const Q=document.createElement("button");return Q.className="text-red-500 hover:bg-red-50 dark:hover:bg-red-900/50 text-sm px-3 py-1 rounded-md",Q.innerHTML='<i class="fas fa-trash-alt"></i>',Q.title="Supprimer",Q.addEventListener("click",()=>ve(W.id,W.name)),G.appendChild(Q),J.appendChild(G),J}async function ve(W,J){if(confirm(`√ätes-vous s√ªr de vouloir supprimer la recette "${J}" ?`))try{await ze(q(w,"recipes",W)),fetchAllRecipes()}catch(_){console.error("Erreur lors de la suppression: ",_)}}if(a.addEventListener("click",()=>dt.openForm(null,"Ajouter une recette")),e.addEventListener("input",W=>{const J=W.target.value;if(!d&&J&&(h=r),d=J,d){const _=d.toLowerCase(),I=o.find(T=>T.name.toLowerCase().includes(_));I&&(r=I.category||"Non class√©")}else h&&(r=h,h=null);i(),S()}),w)return M()}const Na=Object.freeze(Object.defineProperty({__proto__:null,default:Sa,toggleFavoriteStatus:en},Symbol.toStringTag,{value:"Module"})),Ta="modulepreload",Da=function(e){return"/"+e},un={},mt=function(t,n,a){let o=Promise.resolve();if(n&&n.length>0){let x=function(g){return Promise.all(g.map(c=>Promise.resolve(c).then(L=>({status:"fulfilled",value:L}),L=>({status:"rejected",reason:L}))))};document.getElementsByTagName("link");const d=document.querySelector("meta[property=csp-nonce]"),h=d?.nonce||d?.getAttribute("nonce");o=x(n.map(g=>{if(g=Da(g),g in un)return;un[g]=!0;const c=g.endsWith(".css"),L=c?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${g}"]${L}`))return;const m=document.createElement("link");if(m.rel=c?"stylesheet":Ta,c||(m.as="script"),m.crossOrigin="",m.href=g,h&&m.setAttribute("nonce",h),document.head.appendChild(m),c)return new Promise((M,N)=>{m.addEventListener("load",M),m.addEventListener("error",()=>N(new Error(`Unable to preload CSS for ${g}`)))})}))}function r(d){const h=new Event("vite:preloadError",{cancelable:!0});if(h.payload=d,window.dispatchEvent(h),!h.defaultPrevented)throw d}return o.then(d=>{for(const h of d||[])h.status==="rejected"&&r(h.reason);return t().catch(r)})};let et=null;function Pa(){const e={mealPlanGrid:document.getElementById("meal-plan-grid"),currentWeekDisplay:document.getElementById("current-week-display"),prevWeekBtn:document.getElementById("prev-week-btn"),nextWeekBtn:document.getElementById("next-week-btn"),clearMenuBtn:document.getElementById("clear-menu-btn"),shoppingListContainer:document.getElementById("shopping-list"),startDaySelect:document.getElementById("start-day-select"),defaultServingsControl:document.getElementById("default-servings-control"),mealSelectModal:document.getElementById("meal-select-modal"),closeMealSelectModalBtn:document.getElementById("close-meal-select-modal"),mealSelectModalTitle:document.getElementById("meal-select-modal-title"),mealSelectList:document.getElementById("meal-select-list"),recipeFormModal:document.getElementById("edit-recipe-form-modal"),closeRecipeModalBtn:document.getElementById("close-edit-recipe-modal"),cancelRecipeBtn:document.getElementById("edit-cancel-recipe-btn"),recipeForm:document.getElementById("edit-recipe-form"),addItemInput:document.getElementById("add-item-input"),addItemBtn:document.getElementById("add-item-btn"),addItemResults:document.getElementById("add-item-results"),importListBtn:document.getElementById("import-list-btn"),importListModal:document.getElementById("import-list-modal"),closeImportListModalBtn:document.getElementById("close-import-list-modal"),importListContainer:document.getElementById("import-list-container"),exportTxtBtn:document.getElementById("export-txt-btn"),exportPdfBtn:document.getElementById("export-pdf-btn"),exportPlanPdfBtn:document.getElementById("export-plan-pdf-btn"),sharePlanBtn:document.getElementById("share-plan-btn"),planSelect:document.getElementById("plan-select"),inviteParticipantBtn:document.getElementById("invite-participant-btn"),historyPlanBtn:document.getElementById("history-plan-btn"),planHistoryModal:document.getElementById("plan-history-modal"),closePlanHistoryModalBtn:document.getElementById("close-plan-history-modal"),planHistoryList:document.getElementById("plan-history-list"),savePlanBtn:document.getElementById("save-plan-btn"),openTrashBtn:document.getElementById("open-trash-btn"),trashCount:document.getElementById("trash-count"),trashModal:document.getElementById("trash-modal"),closeTrashModalBtn:document.getElementById("close-trash-modal"),trashListContainer:document.getElementById("trash-list-container"),emptyTrashBtn:document.getElementById("empty-trash-btn")};function t(s,l){const u=document.createElement("div");u.className="flex items-center space-x-2";const b=document.createElement("button");b.className="btn btn-outline btn-xs",b.textContent="-";const p=document.createElement("span");p.className="font-medium text-center w-6",p.textContent=s;const y=document.createElement("button");return y.className="btn btn-outline btn-xs",y.textContent="+",b.addEventListener("click",()=>{let v=parseInt(p.textContent,10);v>1&&(v--,p.textContent=v,l(v))}),y.addEventListener("click",()=>{let v=parseInt(p.textContent,10);v++,p.textContent=v,l(v)}),u.appendChild(b),u.appendChild(p),u.appendChild(y),u}function n(s,l,u,b=!1){const p=document.createElement("div");p.className="flex flex-col items-center justify-center h-full";const y=document.createElement("button");y.className="text-gray-600 hover:bg-gray-100 p-0 h-4 flex items-center justify-center w-full rounded-md",y.innerHTML='<i class="fas fa-plus"></i>',y.disabled=b;const v=document.createElement("span");v.className="font-medium text-center text-sm my-1",v.textContent=s;const f=document.createElement("button");return f.className="text-gray-600 hover:bg-gray-100 p-0 h-4 flex items-center justify-center w-full rounded-md",f.innerHTML='<i class="fas fa-minus"></i>',f.disabled=b,l&&(y.classList.add("text-white"),v.classList.add("text-white"),f.classList.add("text-white")),b||(y.addEventListener("click",()=>{let E=parseInt(v.textContent,10);E++,v.textContent=E,u(E)}),f.addEventListener("click",()=>{let E=parseInt(v.textContent,10);E>1&&(E--,v.textContent=E,u(E))})),p.appendChild(y),p.appendChild(v),p.appendChild(f),p}et&&et.destroy(),et=new Kt(w,"edit-recipe-form-modal","edit-recipe-form","edit-recipe-modal-title","edit-recipe-id","edit-recipe-name","edit-recipe-category","edit-recipe-servings","edit-recipe-prep-time","edit-recipe-difficulty","edit-recipe-steps","edit-ingredients-list","edit-add-ingredient-btn","edit-save-recipe-btn","close-edit-recipe-modal","edit-cancel-recipe-btn"),et.setActivityUpdater(kt),et.setOnSaveCallback(async()=>{});let a=1,o="Lundi",r={},d={},h={};const x=[];let g=null,c=[],L=[],m=1,M=null,N=[],i=null;const S=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];function K(s){return s?s.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase():""}function ve(s){return s?s.replace(/\./g,"_"):""}async function W(s){const l=document.getElementById("unit-select-modal"),u=document.getElementById("unit-modal-title"),b=document.getElementById("unit-modal-list"),p=document.getElementById("unit-modal-cancel");return u.textContent=`Choisir une unit√© pour "${s}"`,b.innerHTML="",new Promise((y,v)=>{const f=["g","kg","ml","l","pi√®ce(s)","c.√†.s.","c.√†.c.","pinc√©e(s)"],E=k=>{l.classList.add("hidden"),y(k)};f.forEach(k=>{const P=document.createElement("button");P.className="btn btn-outline",P.textContent=k,P.addEventListener("click",()=>E(k)),b.appendChild(P)});const C=()=>{l.classList.add("hidden"),v()};p.addEventListener("click",C,{once:!0}),l.addEventListener("click",k=>{k.target===l&&C()},{once:!0}),l.classList.remove("hidden")})}async function J(){if(w)try{L=(await Ce(Y(w,"ingredients"))).docs.map(l=>({id:l.id,...l.data()})),L.sort((l,u)=>l.name.localeCompare(u.name))}catch(s){console.error("Erreur lors de la r√©cup√©ration des ingr√©dients: ",s)}}function _(){if(!i)r={},d={},h={},m=1,o="Lundi";else{const s=i.weeks?i.weeks[a]||{}:{};r=s.menuData||{},d=s.servingsData||{},h=s.remarksData||{},m=i.defaultNumPeople||1,o=i.startDay||"Lundi"}if(e.startDaySelect&&(e.startDaySelect.value=o),e.defaultServingsControl){e.defaultServingsControl.innerHTML="";const s=t(m,async l=>{m=l,i&&await I({defaultNumPeople:l},`a chang√© le nombre de personnes par d√©faut √† ${l}`)});e.defaultServingsControl.appendChild(s)}Ye(),Q(e.mealPlanGrid,{menuData:r,servingsData:d,remarksData:h,defaultNumPeople:m,startDay:o},!1),ae(document.getElementById("mobile-meal-plan"),{menuData:r,servingsData:d,remarksData:h,defaultNumPeople:m,startDay:o},!1),Z()}async function I(s,l){if(!i)return;await Wt(i.id,i,l);const u=q(w,"plans",i.id);try{await je(u,{...s,lastUpdated:new Date})}catch(b){console.error("Error updating plan:",b),alert("Une erreur de sauvegarde est survenue.")}}function T(){e.planHistoryModal.classList.add("hidden")}async function X(s){if(i&&confirm("Voulez-vous vraiment restaurer cette version ? L'√©tat actuel sera sauvegard√© dans l'historique avant la restauration."))try{const l=q(w,"plans",i.id,"history",s),u=await Pe(l);if(!u.exists())throw new Error("Version de l'historique non trouv√©e.");const b=u.data().planState;await Wt(i.id,i);const p=q(w,"plans",i.id);await xt(p,b),T()}catch(l){console.error("Erreur lors du rollback :",l)}}async function U(s,l){if(i&&confirm("√ätes-vous s√ªr de vouloir supprimer d√©finitivement cette entr√©e de l'historique ?"))try{const u=q(w,"plans",i.id,"history",s);await ze(u),l.remove()}catch(u){console.error("Erreur lors de la suppression de l'historique :",u),alert("Une erreur est survenue lors de la suppression.")}}async function G(){if(i){e.planHistoryList.innerHTML="<p>Chargement de l'historique...</p>",e.planHistoryModal.classList.remove("hidden");try{const s=Y(w,"plans",i.id,"history"),l=ke(s,Qn("timestamp","desc")),u=await Ce(l);if(e.planHistoryList.innerHTML="",u.empty){e.planHistoryList.innerHTML="<p>Aucun historique pour ce plan.</p>";return}u.forEach(b=>{const p=b.data(),y=document.createElement("div");y.className="p-3 border-b flex justify-between items-center";const v=document.createElement("div"),f=p.timestamp?.toDate().toLocaleString("fr-FR")||"Date inconnue",E=p.description||"Modification diverse",C=p.modifiedByName||"Inconnu";v.innerHTML=`
                    <p class="font-medium">${C} ${E}</p>
                    <p class="text-sm text-gray-500">${f}</p>
                `;const k=document.createElement("div");k.className="flex items-center space-x-2";const P=document.createElement("button");P.className="btn btn-secondary btn-sm",P.textContent="Revenir √† cette version",P.addEventListener("click",()=>X(b.id));const R=document.createElement("button");R.className="text-red-500 hover:bg-red-100 text-sm px-3 py-1 rounded-md",R.innerHTML='<i class="fas fa-times"></i>',R.title="Supprimer cette version",R.addEventListener("click",F=>{F.stopPropagation(),U(b.id,y)}),k.appendChild(P),k.appendChild(R),y.appendChild(v),y.appendChild(k),e.planHistoryList.appendChild(y)})}catch(s){console.error("Erreur de chargement de l'historique:",s),e.planHistoryList.innerHTML=`<p class="text-red-500">Impossible de charger l'historique.</p>`}}}function ae(s,l,u=!1){if(!s)return;const b=l.menuData||{},p=l.servingsData||{},y=l.remarksData||{},v=l.defaultNumPeople||1,f=l.startDay||"Lundi";s.innerHTML="";const E=document.createDocumentFragment(),C=S.indexOf(f);[...S.slice(C),...S.slice(0,C)].forEach(P=>{const R=S.indexOf(P),F=document.createElement("div");F.className="bg-blue-100 border border-blue-300 rounded-xl shadow-md p-4 mb-4";const ee=document.createElement("h3");ee.className="text-xl font-bold text-gray-800 mb-3",ee.textContent=P.toUpperCase(),F.appendChild(ee);const Ee=document.createElement("div");Ee.className="space-y-4",["lunch","dinner"].forEach(fe=>{const ye=document.createElement("div");ye.className=`border-t pt-3 ${fe==="lunch"?"bg-amber-50":"bg-stone-100"} rounded-lg p-2`;const Ie=document.createElement("div");Ie.className="flex justify-between items-center mb-2";const Be=document.createElement("h4");if(Be.className="text-lg font-semibold text-tomato",Be.textContent=fe==="lunch"?"Midi":"Soir",Ie.appendChild(Be),!u){const we=`${R}-${fe}`,be=p[we]||v,ge=t(be,he=>{nn(we,he)});Ie.appendChild(ge)}ye.appendChild(Ie);const Se=document.createElement("div");Se.className="space-y-2";let Ae=!1;const Ne=["Entr√©e","Plat","Accompagnement","Dessert","Remarque"];for(let we=0;we<Ne.length;we++){const be=Ne[we],ge=`${R}-${fe}-${we}`,he=b[ge],_e=document.createElement("div");_e.className="mb-2";const $e=document.createElement("h5");if($e.className="text-md font-semibold text-gray-700 mb-1",$e.textContent=be,_e.appendChild($e),be==="Remarque")_e.appendChild(st(ge,y,u));else{const Me=document.createElement("div");if(Me.className="space-y-1",Array.isArray(he)&&he.length>0&&(Ae=!0,he.forEach((Te,Ct)=>{const Xe=c.find(qe=>qe.id===Te.id);if(Xe){const qe=xe(Xe,ge,Ct,u);if(qe.classList.remove("bg-white","shadow-sm"),qe.classList.add("bg-emerald-200","border","border-emerald-400"),!u){const Ue=qe.querySelector(".edit-meal-btn"),lt=qe.querySelector(".delete-meal-btn");Ue&&Ue.classList.remove("hidden"),lt&&lt.classList.remove("hidden")}Me.appendChild(qe)}})),u)Ae||(Me.innerHTML='<p class="text-sm text-gray-500 italic">Aucun plat pr√©vu.</p>');else{const Te=document.createElement("button");Te.className="btn btn-outline btn-sm w-full mt-2",Te.innerHTML=`<i class="fas fa-plus mr-2"></i> Ajouter une ${be.toLowerCase()}`,Te.addEventListener("click",()=>{ce(ge)}),Me.appendChild(Te)}_e.appendChild(Me)}Se.appendChild(_e)}ye.appendChild(Se),Ee.appendChild(ye)}),F.appendChild(Ee),E.appendChild(F)}),s.appendChild(E)}function Q(s,l,u=!1){if(!s)return;const b=l.menuData||{},p=l.servingsData||{},y=l.remarksData||{},v=l.defaultNumPeople||1,f=l.startDay||"Lundi",E=document.createDocumentFragment(),C=["lunch","dinner"],k=5,P=S.indexOf(f);[...S.slice(P),...S.slice(0,P)].forEach(F=>{const ee=S.indexOf(F),Ee=document.createElement("div");Ee.className="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] items-stretch border-b border-gray-300";const fe=document.createElement("div");fe.className="font-bold p-2 flex items-center justify-center bg-gray-100 text-sm border-r border-gray-300",fe.textContent=F.toUpperCase(),Ee.appendChild(fe),C.forEach(ye=>{const Ie=`${ee}-${ye}`,Be=p[Ie]||v,Se=p.hasOwnProperty(Ie),Ae=document.createElement("div"),Ne=n(Be,Se,be=>{nn(Ie,be)},u);let we="border-r border-gray-300 flex items-center justify-center transition-colors duration-300";Se?we+=" bg-tomato":we+=ye==="lunch"?" bg-amber-50":" bg-stone-100",Ae.className=we,Ae.appendChild(Ne),Ee.appendChild(Ae);for(let be=0;be<k;be++){const ge=`${ee}-${ye}-${be}`,he=b[ge],_e=document.createElement("div"),$e=ie(ge);let Me="meal-slot p-1 min-h-[70px] flex flex-col justify-start border-r border-gray-300";if(Me+=ye==="lunch"?" bg-amber-50":" bg-stone-100",_e.className=Me,_e.dataset.slotId=ge,$e==="Remarque")_e.appendChild(st(ge,y,u));else if(Array.isArray(he)&&he.length>0){const Te=document.createElement("div");Te.className="w-full",he.forEach((Ct,Xe)=>{const qe=c.find(Ue=>Ue.id===Ct.id);if(qe)Te.appendChild(xe(qe,ge,Xe,u));else{const Ue=document.createElement("div");Ue.className="p-1 bg-red-100 text-red-700 rounded shadow-sm text-center text-xs font-medium",Ue.textContent="Recette supprim√©e",Te.appendChild(Ue)}}),_e.appendChild(Te),u||_e.appendChild(at(ge,!0))}else u||_e.appendChild(at(ge,!1));Ee.appendChild(_e)}}),E.appendChild(Ee)}),s.innerHTML="",s.appendChild(E),u||it()}async function se(){const s=De();if(!w||!s)return[];try{const l=ke(Y(w,"shopping_lists"),ue("userId","==",s));return(await Ce(l)).docs.map(y=>({id:y.id,...y.data()})).filter(y=>y.isShared!==!0)}catch(l){return console.error("Erreur de chargement des listes de courses sauvegard√©es: ",l),[]}}async function me(){const s=await se();if(e.importListContainer.innerHTML="",s.length===0){e.importListContainer.innerHTML='<p class="text-center text-gray-500">Aucune liste sauvegard√©e.</p>';return}s.forEach(l=>{const u=document.createElement("button");u.className="w-full text-left p-2 hover:bg-gray-100 rounded-lg transition-colors duration-150",u.textContent=l.name,u.addEventListener("click",()=>{confirm(`Voulez-vous vraiment importer les ingr√©dients de la liste "${l.name}" ?`)&&(l.ingredients.forEach(b=>{const p=parseFloat(String(b.quantity).replace(",","."))||0;$(b.name,p,b.unit)}),H())}),e.importListContainer.appendChild(u)}),e.importListModal.classList.remove("hidden")}function H(){e.importListModal.classList.add("hidden")}function B(){e.addItemInput?.addEventListener("input",()=>{const s=e.addItemInput.value.toLowerCase(),l=e.addItemResults;if(l.innerHTML="",!s){l.classList.add("hidden");return}L.filter(p=>p.name.toLowerCase().includes(s)).forEach(p=>{const y=document.createElement("div");y.className="p-2 hover:bg-gray-100 cursor-pointer",y.textContent=p.name,y.addEventListener("click",()=>{$(p.name,1,p.unit),e.addItemInput.value="",l.classList.add("hidden")}),l.appendChild(y)});const b=document.createElement("div");b.className="p-2 bg-green-50 hover:bg-green-200 cursor-pointer font-bold text-green-700",b.textContent=`+ Cr√©er "${e.addItemInput.value}"`,b.addEventListener("click",async()=>{const p=e.addItemInput.value;try{const y=await W(p);await He(Y(w,"ingredients"),{name:p,unit:y}),await J(),$(p,1,y),e.addItemInput.value="",l.classList.add("hidden")}catch{}}),l.appendChild(b),l.classList.remove("hidden")}),e.addItemBtn?.addEventListener("click",()=>{const s=e.addItemInput.value;s&&($(s,1,""),e.addItemInput.value="",e.addItemResults.classList.add("hidden"))}),document.addEventListener("click",s=>{e.addItemInput&&!e.addItemInput.contains(s.target)&&!e.addItemResults.contains(s.target)&&e.addItemResults.classList.add("hidden")})}function j(){if(x.length===0){alert("La liste de courses est vide.");return}const s=x.reduce((p,y)=>{const v=y.category||"Inconnue";return p[v]||(p[v]=[]),p[v].push(y),p},{}),l=Object.keys(s).sort((p,y)=>p==="Inconnue"?1:y==="Inconnue"?-1:p.localeCompare(y));let u=`Liste de courses - GustoPlan

`;l.forEach(p=>{u+=`--- ${p.toUpperCase()} ---
`,s[p].sort((v,f)=>v.name.localeCompare(f.name)).forEach(v=>{let E=`${Number.isInteger(v.totalQuantity)?v.totalQuantity:parseFloat(v.totalQuantity.toFixed(2))} ${v.unit||""} ${v.name}`;if(v.sources&&v.sources.length>0){const C=v.sources.reduce((P,R)=>{const F=`${R.recipeName} (${R.day} ${R.time})`;return P[F]||(P[F]=0),P[F]+=R.quantity,P},{}),k=Object.keys(C).join(" / ");E+=` *** ${k} ***`}u+=E+`
`}),u+=`
`});const b=new Blob([u],{type:"text/plain;charset=utf-8"});saveAs(b,"liste-de-courses.txt")}function V(){if(x.length===0){alert("La liste de courses est vide.");return}const{jsPDF:s}=window.jspdf,l=new s,u=x.reduce((E,C)=>{const k=C.category||"Inconnue";return E[k]||(E[k]=[]),E[k].push(C),E},{}),b=Object.keys(u).sort((E,C)=>E==="Inconnue"?1:C==="Inconnue"?-1:E.localeCompare(C));l.setFontSize(18),l.text("Liste de courses - GustoPlan",14,22);let p=35;const y=l.internal.pageSize.height,v=20,f=()=>{p>y-v&&(l.addPage(),p=20)};b.forEach(E=>{f(),l.setFontSize(14),l.setFont(void 0,"bold"),l.text(`--- ${E.toUpperCase()} ---`,14,p),p+=8,l.setFont(void 0,"normal"),u[E].sort((k,P)=>k.name.localeCompare(P.name)).forEach(k=>{f(),l.setFontSize(12);const P=Number.isInteger(k.totalQuantity)?k.totalQuantity:parseFloat(k.totalQuantity.toFixed(2));if(l.text(`${P} ${k.unit||""} ${k.name}`,14,p),p+=6,k.sources&&k.sources.length>0){const R=k.sources.reduce((F,ee)=>{const Ee=`${ee.recipeName} (${ee.day} ${ee.time})`;return F[Ee]||(F[Ee]=0),F[Ee]+=ee.quantity,F},{});l.setFontSize(9),l.setTextColor(100);for(const F in R)f(),l.text(`  * ${F}`,18,p),p+=5;l.setTextColor(0)}p+=2}),p+=5}),l.save("liste-de-courses.pdf")}async function oe(){if(!i){alert("Veuillez s√©lectionner un plan √† exporter.");return}const s=document.getElementById("loading-overlay");s&&s.classList.remove("hidden");try{const{jsPDF:l}=window.jspdf,u=new l,b=q(w,"plans",i.id),p=await Pe(b),y=p.exists()?p.data():null;if(!y||!y.weeks){alert("Ce plan est vide et ne peut pas √™tre export√©.");return}u.setFontSize(18),u.text(`Plan de Repas: ${y.name}`,14,20);const v=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"],f={0:"E",1:"P",2:"A",3:"D"},E=Object.keys(y.weeks).sort((k,P)=>parseInt(k)-parseInt(P));let C=!0;for(const k of E){const R=y.weeks[k].menuData||{};if(Object.keys(R).length===0)continue;const F=[["Jour","Midi","Soir"]],ee=[],Ee=v.indexOf(y.startDay||"Lundi"),fe=[...v.slice(Ee),...v.slice(0,Ee)];for(const Ie of fe){const Be=v.indexOf(Ie);let Se=[],Ae=[];for(const Ne of["lunch","dinner"])for(const we in f){const be=`${Be}-${Ne}-${we}`;R[be]&&Array.isArray(R[be])&&R[be].forEach(ge=>{const he=`[${f[we]}] ${ge.name}`;Ne==="lunch"?Se.push(he):Ae.push(he)})}ee.push([Ie,Se.join(`
`)||"-",Ae.join(`
`)||"-"])}u.setFontSize(14);const ye=C?30:u.autoTable.previous.finalY+20;u.text(`Semaine ${k}`,14,ye-5),u.autoTable({startY:ye,head:F,body:ee,theme:"grid",styles:{cellPadding:2,fontSize:8,valign:"middle"},headStyles:{fillColor:[41,128,185],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[245,245,245]}}),C=!1}u.save(`plan_${y.name.replace(/ /g,"_")}.pdf`)}catch(l){console.error("Erreur lors de la g√©n√©ration du PDF du plan :",l),alert("Une erreur est survenue lors de la cr√©ation du PDF.")}finally{s&&s.classList.add("hidden")}}async function $(s,l,u,b=!1){if(!i)return alert("Veuillez s√©lectionner un plan.");const p=q(w,"plans",i.id);try{await on(w,async y=>{const v=await y.get(p);if(!v.exists())throw"Le plan n'existe plus.";const f=v.data().manualItems||[],E=`${s.trim().toLowerCase()}_${u||""}`,C=f.findIndex(P=>`${P.name.trim().toLowerCase()}_${P.unit||""}`===E);if(C>-1)f[C].totalQuantity+=l;else{const P=L.find(R=>R.name.toLowerCase()===s.trim().toLowerCase());f.push({name:s.trim(),totalQuantity:l,unit:u,source:"manual",category:P?.category||"Inconnue"})}const k=f.filter(P=>P.totalQuantity!==0);y.update(p,{manualItems:k,lastUpdated:new Date})})}catch(y){console.error("Erreur transactionnelle lors de l'ajustement de l'ingr√©dient: ",y),alert("Une erreur de synchronisation est survenue. Veuillez r√©essayer.")}}function de(s){const l=s?s.toLowerCase():"";return l.includes("g")||l.includes("ml")?10:1}function le(s=[]){const l=e.shoppingListContainer;if(!l)return;if(l.innerHTML="",x.length===0&&s.length===0){l.innerHTML='<p class="text-center text-gray-500 italic py-4">Votre liste de courses est vide.</p>';return}const u=i?i.checkedItems||{}:{},b=x.reduce((y,v)=>{const f=v.category||"Inconnue";return y[f]||(y[f]=[]),y[f].push(v),y},{});if(Object.keys(b).sort((y,v)=>y==="Inconnue"?1:v==="Inconnue"?-1:y.localeCompare(v)).forEach(y=>{const v=document.createElement("h4");v.className="text-sm font-bold text-stone-800 bg-stone-200 mt-4 mb-2 px-3 py-1 rounded-md",v.textContent=y,l.appendChild(v);const f=document.createElement("ul");f.className="space-y-2",b[y].sort((C,k)=>C.name.localeCompare(k.name)).forEach(C=>{const k=`${C.name}_${C.unit||""}`,P=ve(k),R=u.hasOwnProperty(P)?u[P]:u[k]||!1,F=document.createElement("li");let ee="p-2 rounded";C.hasManualEntry===!0||C.source==="manual"?(F.style.backgroundColor="#ffedd5",ee+=" bg-orange-100"):ee+=" bg-gray-50",F.className=ee;const fe=document.createElement("div");fe.className="flex justify-between items-center";const ye=document.createElement("div");if(ye.className="flex-grow flex items-center",R){const he=document.createElement("i");he.className="fas fa-check mr-2 bg-green-500 text-white rounded-full p-1 flex items-center justify-center w-5 h-5",ye.appendChild(he)}const Ie=document.createElement("span");Ie.className="text-sm font-medium transition-all duration-200",R&&Ie.classList.add("line-through","text-gray-400"),Ie.textContent=C.name,ye.appendChild(Ie),fe.appendChild(ye);const Be=document.createElement("div");Be.className="flex items-center space-x-2 mx-2";const Se=document.createElement("span");Se.className="font-medium w-20 text-center text-sm",R&&Se.classList.add("text-gray-400");const Ae=Number.isInteger(C.totalQuantity)?C.totalQuantity:parseFloat(C.totalQuantity.toFixed(2));Se.textContent=`${Ae} ${C.unit||""}`.trim();const Ne=document.createElement("div");Ne.className="flex flex-col";const we=document.createElement("button");we.className="btn btn-outline btn-xs rounded-b-none",we.textContent="+",we.addEventListener("click",async()=>{const he=de(C.unit);await $(C.name,he,C.unit)});const be=document.createElement("button");be.className="btn btn-outline btn-xs rounded-t-none -mt-px",be.textContent="-",be.addEventListener("click",async()=>{const he=de(C.unit);await $(C.name,-he,C.unit)}),Ne.appendChild(we),Ne.appendChild(be),Be.appendChild(Se),Be.appendChild(Ne),fe.appendChild(Be);const ge=document.createElement("button");if(ge.className="delete-item-btn text-red-500 hover:text-red-700",ge.innerHTML='<i class="fas fa-trash-alt"></i>',ge.addEventListener("click",()=>{$(C.name,-C.totalQuantity,C.unit,!0)}),fe.appendChild(ge),F.appendChild(fe),C.sources&&C.sources.length>0){const he=document.createElement("div");he.className="p-2 mt-1 ml-4 rounded-md bg-stone-100";const _e=C.sources.reduce(($e,Me)=>{const Te=`${Me.recipeName} (${Me.day} ${Me.time})`;return $e[Te]||($e[Te]=0),$e[Te]+=Me.quantity,$e},{});for(const $e in _e){const Me=document.createElement("span");Me.className="block text-xs text-gray-500",Me.textContent=`‚Ü≥ ${$e}`,he.appendChild(Me)}F.appendChild(he)}f.appendChild(F)}),l.appendChild(f)}),e.openTrashBtn&&(e.openTrashBtn.classList.remove("hidden"),e.trashCount&&(e.trashCount.textContent=s.length,s.length>0?(e.trashCount.classList.remove("bg-gray-200"),e.trashCount.classList.add("bg-red-500","text-white")):(e.trashCount.classList.add("bg-gray-200"),e.trashCount.classList.remove("bg-red-500","text-white")))),s&&s.length>0){if(e.emptyTrashBtn){e.emptyTrashBtn.classList.remove("hidden");const y=e.emptyTrashBtn.cloneNode(!0);e.emptyTrashBtn.parentNode.replaceChild(y,e.emptyTrashBtn),e.emptyTrashBtn=y,e.emptyTrashBtn.addEventListener("click",async()=>{if(!i||!confirm("Voulez-vous supprimer d√©finitivement tous les √©l√©ments de la corbeille ?"))return;const v=q(w,"plans",i.id),f=s.map(E=>`${E.name}_${E.unit||""}`);try{await mt(()=>import("./firebase-config-CV1YP_xo.js").then(E=>E.F),[]).then(E=>{E.updateDoc(v,{hiddenTrashItems:E.arrayUnion(...f),lastUpdated:new Date})}),e.trashModal.classList.add("hidden")}catch(E){console.error("Erreur vidage corbeille:",E)}})}if(e.trashListContainer){e.trashListContainer.innerHTML="";const y=document.createElement("ul");y.className="space-y-2",s.forEach(v=>{const f=document.createElement("li");f.className="p-2 rounded bg-gray-100 flex justify-between items-center group";const E=document.createElement("span");E.className="text-sm text-gray-500 line-through",E.textContent=v.name,f.appendChild(E);const C=document.createElement("div");C.className="flex items-center space-x-2";const k=document.createElement("button");k.className="btn btn-xs btn-outline text-blue-600 hover:bg-blue-50 border-blue-300",k.innerHTML='<i class="fas fa-undo mr-1"></i> Restaurer',k.addEventListener("click",async()=>{if(!i)return;const R=q(w,"plans",i.id);try{await on(w,async F=>{const ee=await F.get(R);if(!ee.exists())return;const fe=(ee.data().manualItems||[]).filter(ye=>!(ye.name.toLowerCase()===v.name.toLowerCase()&&ye.unit===v.unit));F.update(R,{manualItems:fe,lastUpdated:new Date})}),s.length<=1&&e.trashModal.classList.add("hidden")}catch(F){console.error("Erreur lors de la restauration :",F)}});const P=document.createElement("button");P.className="text-gray-400 hover:text-red-600 text-xs p-1 rounded-md",P.title="Supprimer d√©finitivement",P.innerHTML='<i class="fas fa-times"></i>',P.addEventListener("click",async()=>{if(!i)return;const R=q(w,"plans",i.id),F=`${v.name}_${v.unit||""}`;try{await mt(()=>import("./firebase-config-CV1YP_xo.js").then(ee=>ee.F),[]).then(ee=>{ee.updateDoc(R,{hiddenTrashItems:ee.arrayUnion(F),lastUpdated:new Date})}),s.length<=1&&e.trashModal.classList.add("hidden")}catch(ee){console.error("Erreur suppression d√©finitive:",ee)}}),C.appendChild(k),C.appendChild(P),f.appendChild(C),y.appendChild(f)}),e.trashListContainer.appendChild(y)}}else e.trashListContainer&&(e.trashListContainer.innerHTML='<p class="text-center text-gray-500 italic py-4">La corbeille est vide.</p>'),e.emptyTrashBtn&&e.emptyTrashBtn.classList.add("hidden")}async function Z(){if(!i){x.length=0,le();return}const s=i.manualItems?JSON.parse(JSON.stringify(i.manualItems)):[],l=new Map(s.map(f=>{const E=`${f.name.trim().toLowerCase()}_${f.unit||""}`;return f.hasManualEntry=!0,[E,f]})),u=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];if(i.weeks)for(const f in i.weeks){const E=i.weeks[f],C=E.menuData||{},k=E.servingsData||{};for(const P in C){const R=C[P];if(!Array.isArray(R))continue;const[F,ee]=P.split("-"),Ee=parseInt(F,10),fe=u[Ee]||"Jour inconnu",ye=ee==="lunch"?"midi":"soir",Ie=`${Ee}-${ee}`,Be=parseInt(k[Ie]||i.defaultNumPeople,10);for(const Se of R){const Ne=c.find(be=>be.id===Se.id)||Se;if(!Ne||!Array.isArray(Ne.ingredients))continue;const we=Ne.servings||1;we<=0||Ne.ingredients.forEach(be=>{const{name:ge,quantity:he,unit:_e}=be;if(!ge||!he)return;const $e=L.find(Ze=>Ze.name.toLowerCase()===ge.trim().toLowerCase()),Me=$e?$e.category:"Inconnue",Te=parseFloat(String(he).replace(",","."));if(isNaN(Te))return;const Xe=Te/we*Be,qe=_e||"",Ue=`${ge.trim().toLowerCase()}_${qe}`,lt={recipeName:Ne.name,day:`${fe} (S${f})`,time:ye,quantity:Xe};if(l.has(Ue)){const Ze=l.get(Ue);Ze.totalQuantity+=Xe,Ze.source==="manual"&&(Ze.source="mixed"),Array.isArray(Ze.sources)?Ze.sources.push(lt):Ze.sources=[lt]}else l.set(Ue,{name:ge.trim(),totalQuantity:Xe,unit:qe,source:"plan",category:Me,sources:[lt]})})}}}const b=Array.from(l.values()),p=i.hiddenTrashItems||[],y=b.filter(f=>f.totalQuantity>0).sort((f,E)=>f.name.localeCompare(E.name)),v=b.filter(f=>{const E=`${f.name}_${f.unit||""}`;return f.totalQuantity<=0&&f.sources&&f.sources.length>0&&!p.includes(E)}).sort((f,E)=>f.name.localeCompare(E.name));x.length=0,x.push(...y),le(v)}function ce(s){const l=ie(s);if(!l||!e.mealSelectModal)return;e.mealSelectModalTitle.textContent=`S√©lectionner : ${l}`,e.mealSelectList.innerHTML="";const u=document.createElement("input");u.type="text",u.placeholder="Rechercher dans la cat√©gorie...",u.className="w-full p-2 mb-4 border border-gray-300 rounded-lg",e.mealSelectList.appendChild(u);const b=K(l),p=c.filter(f=>K(f.category)===b).sort((f,E)=>{const C=f.isFavorite?1:0,k=E.isFavorite?1:0;return k!==C?k-C:f.name.localeCompare(E.name)}),y=document.createElement("div");y.className="space-y-1 max-h-80 overflow-y-auto",e.mealSelectList.appendChild(y);function v(f=""){y.innerHTML="";const E=f.toLowerCase(),C=p.filter(k=>k.name.toLowerCase().includes(E));C.length===0?y.innerHTML='<p class="text-gray-500 p-4">Aucun plat ne correspond √† votre recherche.</p>':C.forEach(k=>{const P=document.createElement("button");P.className="w-full text-left p-2 hover:bg-gray-100 rounded-lg transition-colors duration-150";const R=document.createElement("p");R.className="font-medium text-gray-800 text-sm",k.isFavorite?R.innerHTML=`${k.name} <i class="fas fa-heart text-red-500 ml-2"></i>`:R.textContent=k.name,P.appendChild(R),P.addEventListener("click",()=>{Qe(s,k),pe()}),y.appendChild(P)})}u.addEventListener("input",f=>v(f.target.value)),v(),e.mealSelectModal.classList.remove("hidden"),u.focus()}function pe(){e.mealSelectModal&&e.mealSelectModal.classList.add("hidden")}function A(s){g=s.target.closest(".meal-card");const l=g.closest(".meal-slot").dataset.slotId;s.dataTransfer.setData("text/plain",l),setTimeout(()=>{g&&(g.style.opacity="0.5")},0)}function z(){g&&(g.style.opacity="1",g=null)}function O(s){s.preventDefault();const l=s.target.closest(".meal-slot");l&&ie(l.dataset.slotId)!=="Remarque"&&l.classList.add("bg-gray-200")}function D(s){const l=s.target.closest(".meal-slot");l&&l.classList.remove("bg-gray-200")}async function te(s){s.preventDefault();const l=s.dataTransfer.getData("text/plain"),u=s.target.closest(".meal-slot");if(u){u.classList.remove("bg-gray-200");const b=u.dataset.slotId,p=ie(b);if(p==="Remarque")return;if(l&&b&&l!==b){const y=r[l],v=ie(l);if(K(v)!==K(p)){alert(`Action impossible : un(e) "${v}" ne peut pas aller dans la cat√©gorie "${p}".`);return}const f=r[b];r[b]=y,f?r[l]=f:delete r[l],Q(e.mealPlanGrid,{menuData:r,servingsData:d,remarksData:h,defaultNumPeople:m,startDay:o},!1),await I({[`weeks.${a}.menuData`]:r},"a d√©plac√© un plat"),await Z()}}}function ie(s){switch(s.split("-")[2]){case"0":return"Entr√©e";case"1":return"Plat";case"2":return"Accompagnement";case"3":return"Dessert";case"4":return"Remarque";default:return""}}function xe(s,l,u,b=!1){const p=document.createElement("div");if(p.className="meal-card p-1 flex flex-col items-center bg-white rounded shadow-sm text-center relative w-full mb-1",b||(p.classList.add("cursor-grab"),p.draggable=!0),!b){const E=document.createElement("button");E.className="absolute -top-2 -right-1 text-base",E.innerHTML='<i class="fas fa-heart"></i>',s.isFavorite?E.classList.add("text-red-500"):E.classList.add("text-gray-300","hover:text-red-400"),E.addEventListener("click",C=>{C.stopPropagation(),en(s.id,s.isFavorite)}),E.addEventListener("mousedown",C=>C.stopPropagation()),p.appendChild(E)}const y=document.createElement("span");if(y.className="text-xs font-medium p-1 break-words w-full",y.textContent=s.name,p.appendChild(y),!b){const E=document.createElement("div");E.className="absolute top-0 left-0 flex";const C=document.createElement("button");C.className="edit-meal-btn text-gray-600 hover:text-gray-800 hidden px-1 py-0.5",C.innerHTML='<i class="fas fa-pencil-alt fa-xs"></i>',C.title="Modifier la recette",C.addEventListener("click",P=>{P.stopPropagation();const R=c.find(F=>F.id===s.id);et.openForm(R||s,"Modifier la recette")}),C.addEventListener("mousedown",P=>P.stopPropagation()),E.appendChild(C);const k=document.createElement("button");k.className="delete-meal-btn text-red-700 hover:text-red-900 hidden px-1 py-0.5",k.innerHTML='<i class="fas fa-times-circle fa-xs"></i>',k.title="Retirer du planning",k.addEventListener("click",P=>{P.stopPropagation(),Dt(l,u)}),k.addEventListener("mousedown",P=>P.stopPropagation()),E.appendChild(k),p.appendChild(E),p.addEventListener("mouseenter",()=>{C.classList.remove("hidden"),k.classList.remove("hidden")}),p.addEventListener("mouseleave",()=>{C.classList.add("hidden"),k.classList.add("hidden")})}const v=document.createElement("div");v.className="absolute bottom-1 right-1";const f=document.createElement("button");return f.className="info-meal-btn bg-gray-500 text-white hover:bg-gray-600 rounded w-3 h-3 flex items-center justify-center shadow-sm",f.innerHTML='<i class="fas fa-plus fa-xs"></i>',f.title="Plus d'infos",f.dataset.slotId=l,f.dataset.mealIndex=u,f.addEventListener("mousedown",E=>E.stopPropagation()),v.appendChild(f),p.appendChild(v),p}function Ge(s,l){if(document.querySelectorAll(".planner-ingredient-tooltip").forEach(v=>v.remove()),M===s){s.classList.remove("info-open"),s.innerHTML='<i class="fas fa-plus fa-xs"></i>',M=null;return}M&&(M.classList.remove("info-open"),M.innerHTML='<i class="fas fa-plus fa-xs"></i>'),s.classList.add("info-open"),s.innerHTML='<i class="fas fa-times fa-xs"></i>',M=s;const u=document.createElement("div");if(u.className="planner-ingredient-tooltip z-50 w-64 p-3 bg-white border border-gray-200 rounded-lg shadow-lg text-left text-sm",l.ingredients&&l.ingredients.length>0){if(l.servings&&l.servings>0){const E=document.createElement("p");E.className="mb-2 text-sm text-gray-600 flex items-center",E.innerHTML=`<i class="fas fa-users mr-2"></i> Pour ${l.servings} ${l.servings>1?"personnes":"personne"}`,u.appendChild(E)}const v=document.createElement("h4");v.className="font-bold mb-2 text-gray-800",v.textContent="Ingr√©dients :",u.appendChild(v);const f=document.createElement("ul");f.className="space-y-1 text-gray-600",l.ingredients.forEach(E=>{const C=document.createElement("li");C.textContent=`‚Ä¢ ${E.quantity||""} ${E.unit||""} ${E.name}`.trim(),f.appendChild(C)}),u.appendChild(f)}else u.textContent="Aucun ingr√©dient sp√©cifi√© pour cette recette.";document.body.appendChild(u);const b=s.closest(".meal-card").getBoundingClientRect(),p=u.getBoundingClientRect();if(window.innerWidth<768){u.style.width="90vw",u.style.maxWidth="320px";const v=u.getBoundingClientRect();let f=b.bottom+10,E=(window.innerWidth-v.width)/2;f+v.height>window.innerHeight&&(f=b.top-v.height-10),u.style.top=`${f}px`,u.style.left=`${E}px`}else{let v=b.right+10;v+p.width>window.innerWidth&&(v=b.left-p.width-10);let f=b.top;f+p.height>window.innerHeight&&(f=b.bottom-p.height),f<10&&(f=10),u.style.left=`${v}px`,u.style.top=`${f}px`}u.style.position="fixed"}function at(s,l=!1){const u=document.createElement("div"),b=document.createElement("button");return l?(u.className="w-full flex justify-center pt-1",b.className="add-more-meal-btn text-gray-400 hover:text-green-500 transition-colors duration-150",b.innerHTML='<i class="fas fa-plus-circle"></i>',b.title="Ajouter une autre recette"):(u.className="flex items-center justify-center h-full",b.className="add-meal-btn text-green-500 hover:text-green-700 transition-transform duration-150 hover:scale-125",b.innerHTML='<i class="fas fa-plus-circle text-lg"></i>'),b.addEventListener("click",()=>ce(s)),u.appendChild(b),u}function st(s,l,u=!1){if(u){const p=document.createElement("p");return p.className="w-full h-full p-1 text-xs text-gray-700",p.textContent=l[s]||"",p}const b=document.createElement("textarea");return b.className="w-full h-full p-1 text-xs bg-white border-0 rounded focus:outline-none focus:ring-1 focus:ring-tomato resize-none",b.placeholder="Remarque...",b.value=h[s]||"",b.dataset.slotId=s,b.addEventListener("change",p=>{const y=p.target.value;y?h[s]=y:delete h[s];const[v,f]=s.split("-"),k=`a modifi√© la remarque pour ${S[parseInt(v,10)]} ${f==="lunch"?"midi":"soir"}`;I({[`weeks.${a}.remarksData`]:h},k)}),b.addEventListener("focus",p=>{kt({type:"editing_remark",fieldId:s})}),b.addEventListener("blur",p=>{kt("idle")}),b}function it(){document.querySelectorAll(".meal-card").forEach(s=>{s.addEventListener("dragstart",A),s.addEventListener("dragend",z)}),document.querySelectorAll(".meal-slot").forEach(s=>{s.addEventListener("dragover",O),s.addEventListener("dragleave",D),s.addEventListener("drop",te)})}async function Qe(s,l){const u=JSON.parse(JSON.stringify(r)),b=u[s],p={id:l.id};Array.isArray(b)?b.push(p):u[s]=[p];const[y,v]=s.split("-"),f=S[parseInt(y,10)],E=v==="lunch"?"midi":"soir",C=`a ajout√© '${l.name}' √† ${f} ${E}`;await I({[`weeks.${a}.menuData`]:u},C),pe()}async function Dt(s,l){if(!i||!r[s]||!Array.isArray(r[s]))return;const u=r[s][l],b=JSON.parse(JSON.stringify(r));b[s].splice(l,1),b[s].length===0&&delete b[s];const[p,y]=s.split("-"),v=S[parseInt(p,10)],f=y==="lunch"?"midi":"soir",E=`a supprim√© '${u.name}' de ${v} ${f}`;await I({[`weeks.${a}.menuData`]:b},E)}async function ft(){if(confirm("Voulez-vous vraiment vider le menu de cette semaine ?")){const s={id:availablePlans.length>0?availablePlans[0].id:`${De()}_semaine-${a}`,name:availablePlans.length>0?availablePlans[0].name:"Mon plan",menuData:{},servingsData:{},remarksData:{},defaultNumPeople:m,startDay:o,lastUpdated:new Date};loadPlan(s),availablePlans.length>0?availablePlans[0]=s:availablePlans.push(s),await I({[`weeks.${a}`]:{menuData:{},servingsData:{},remarksData:{}}},`a vid√© le menu de la semaine ${a}`)}}function Ke(s){s>=1&&s<=52&&(a=s,_())}function Ye(){e.currentWeekDisplay&&(e.currentWeekDisplay.textContent=`Semaine ${a}`)}function $n(){e.prevWeekBtn?.addEventListener("click",()=>Ke(a-1)),e.nextWeekBtn?.addEventListener("click",()=>Ke(a+1)),e.clearMenuBtn?.addEventListener("click",ft),e.startDaySelect?.addEventListener("change",async u=>{o=u.target.value,i&&await I({startDay:o},`a chang√© le premier jour de la semaine √† '${o}'`)}),e.planSelect?.addEventListener("change",tn),e.closeMealSelectModalBtn?.addEventListener("click",pe),e.mealSelectModal?.addEventListener("click",u=>{u.target===e.mealSelectModal&&pe()}),e.closeRecipeModalBtn?.addEventListener("click",()=>et.closeForm()),e.cancelRecipeBtn?.addEventListener("click",()=>et.closeForm()),e.importListBtn?.addEventListener("click",me),e.closeImportListModalBtn?.addEventListener("click",H),e.importListModal?.addEventListener("click",u=>{u.target===e.importListModal&&H()}),e.exportTxtBtn?.addEventListener("click",j),e.exportPdfBtn?.addEventListener("click",V),e.exportPlanPdfBtn?.addEventListener("click",oe);const s=u=>{const b=u.target.closest(".info-meal-btn");if(b){const p=b.dataset.slotId,y=parseInt(b.dataset.mealIndex,10);if(p&&!isNaN(y)){const v=r[p]?.[y];if(v&&v.id){const f=c.find(E=>E.id===v.id);f&&Ge(b,f)}}}};e.mealPlanGrid?.addEventListener("click",s),document.getElementById("mobile-meal-plan")?.addEventListener("click",s),e.sharePlanBtn?.addEventListener("click",()=>{if(!i){alert("Veuillez s√©lectionner un plan √† partager.");return}Yt({plan:i})}),e.inviteParticipantBtn?.addEventListener("click",()=>{if(!i){alert("Veuillez s√©lectionner un plan pour inviter des participants.");return}En(i)}),e.historyPlanBtn?.addEventListener("click",G),e.closePlanHistoryModalBtn?.addEventListener("click",T),e.planHistoryModal?.addEventListener("click",u=>{u.target===e.planHistoryModal&&T()}),e.openTrashBtn?.addEventListener("click",()=>{e.trashModal.classList.remove("hidden")}),e.closeTrashModalBtn?.addEventListener("click",()=>{e.trashModal.classList.add("hidden")}),e.trashModal?.addEventListener("click",u=>{u.target===e.trashModal&&e.trashModal.classList.add("hidden")}),e.savePlanBtn?.addEventListener("click",async()=>{if(!i){alert("Veuillez s√©lectionner un plan de travail avant de sauvegarder.");return}const u=document.getElementById("save-plan-as-modal"),b=document.getElementById("save-plan-as-form"),p=document.getElementById("save-plan-name"),y=document.getElementById("cancel-save-plan-as-btn"),v=document.getElementById("close-save-plan-as-modal"),f=new Date().toLocaleDateString("fr-FR"),E=i.weeks?Object.keys(i.weeks).filter(R=>i.weeks[R]&&Object.keys(i.weeks[R].menuData||{}).length>0).length:0,C=E>1?`${E} semaines`:`${E} semaine`;p.value=`${i.name} (${C}) - ${f}`,u.classList.remove("hidden");const k=async R=>{R.preventDefault();const F=p.value;if(!F)return;i.weeks||(i.weeks={}),i.weeks[a]={menuData:r,servingsData:d,remarksData:h},i.startDay=o,i.defaultNumPeople=m;const ee=JSON.parse(JSON.stringify(i));if(ee.weeks)for(const Ee in ee.weeks){const fe=ee.weeks[Ee];if(fe&&fe.menuData)for(const ye in fe.menuData){const Ie=fe.menuData[ye];Array.isArray(Ie)&&(fe.menuData[ye]=Ie.map(Be=>Be&&Be.id&&c.find(Ae=>Ae.id===Be.id)||Be))}}await kn(F,ee),u.classList.add("hidden"),b.removeEventListener("submit",k)},P=()=>{u.classList.add("hidden"),b.removeEventListener("submit",k)};b.addEventListener("submit",k,{once:!0}),y.addEventListener("click",P,{once:!0}),v.addEventListener("click",P,{once:!0})})}function Hn(s=""){return s.split(" ").map(b=>b[0]).join("").substring(0,2).toUpperCase()}function Pt(s=[],l={}){const u=document.getElementById("collaborators-bar"),b=document.getElementById("activity-labels-container"),p=document.getElementById("name-tooltip");if(!u||!p||!b)return;if(u.innerHTML="",b.innerHTML="",document.querySelectorAll(".remark-lock-overlay").forEach(f=>f.remove()),document.querySelectorAll("textarea[data-slot-id]").forEach(f=>{f.disabled=!1}),s.length<=1&&Object.keys(l).length<=1){u.classList.add("hidden");return}let y="";const v=De();s.forEach(f=>{if(!f)return;const E=l.hasOwnProperty(f.uid),C=l[f.uid]||{},k=document.createElement("div");k.className="w-8 h-8 rounded-full flex items-center justify-center bg-gray-300 text-white font-bold text-xs ring-2 ring-white cursor-pointer transition-all duration-300";const P=E?"(pr√©sent)":"(absent)";if(k.dataset.name=`${f.displayName||"Inconnu"} ${P}`,f.photoURL?k.innerHTML=`<img src="${f.photoURL}" alt="${f.displayName}" class="w-full h-full rounded-full object-cover">`:k.textContent=Hn(f.displayName),E||k.classList.add("grayscale","opacity-50"),k.addEventListener("mouseenter",R=>{p.textContent=R.currentTarget.dataset.name,p.classList.remove("hidden");const F=R.currentTarget.getBoundingClientRect();p.style.left=`${F.left+F.width/2-p.offsetWidth/2}px`,p.style.top=`${F.top-p.offsetHeight-5}px`}),k.addEventListener("mouseleave",()=>{p.classList.add("hidden")}),u.appendChild(k),E&&f.uid!==v){const R=C.status;if(typeof R=="object"&&R.type==="editing_remark"){const F=document.querySelector(`textarea[data-slot-id="${R.fieldId}"]`);if(F){F.disabled=!0;const ee=document.createElement("div");ee.className="remark-lock-overlay absolute inset-0 bg-gray-400 bg-opacity-25 flex items-center justify-center text-xs text-white font-bold",ee.innerHTML=`<i class="fas fa-lock mr-1"></i> ${f.displayName} √©crit...`,F.parentElement&&(F.parentElement.classList.add("relative"),F.parentElement.appendChild(ee))}}else if(typeof R=="string"&&R!=="idle"){let F="";switch(R){case"editing_recipe":F="modifie une recette...";break}F&&(y+=`<span class="italic mr-4">${f.displayName} ${F}</span>`)}}}),b.innerHTML=y,u.classList.remove("hidden")}function tn(){Pn();const s=e.planSelect.value;s&&localStorage.setItem("lastActivePlanId",s),i=N.find(v=>v.id===s)||null;const l=document.getElementById("delete-plan-btn"),u=document.getElementById("rename-plan-btn"),b=document.getElementById("leave-plan-btn"),p=document.getElementById("invite-participant-btn"),y=document.getElementById("history-plan-btn");if(l&&(l.style.display=i&&i.isOwner?"inline-flex":"none"),u&&(u.style.display=i&&i.isOwner?"inline-flex":"none"),y&&(y.style.display=i&&i.isOwner?"inline-flex":"none"),b&&(b.style.display=i&&!i.isOwner?"inline-flex":"none"),p){const v=i&&(i.type==="collaborative"||i.collaborators&&i.collaborators.length>0);p.style.display=i&&i.isOwner&&v?"inline-flex":"none"}i&&i.participants&&i.participants.length>1?(Pt(i.participants,{}),Dn(i.id,v=>{Pt(i.participants,v)})):Pt([],{}),i&&(i.manualItems=i.manualItems||[]),_()}async function nn(s,l){if(!i)return;const u=JSON.parse(JSON.stringify(d));l===m?delete u[s]:u[s]=l;const[b,p]=s.split("-"),f=`a chang√© le nombre de personnes pour ${S[parseInt(b,10)]} ${p==="lunch"?"midi":"soir"} √† ${l}`;await I({[`weeks.${a}.servingsData`]:u},f)}async function An(){if(!w)return;const s=In();$n(),B(),await J();const l=Je(Y(w,"recipes"),b=>{if(console.log("Recipe data updated from listener."),c=b.docs.map(p=>{const y=p.data();return{id:p.id,...y,imageUrl:y.imageUrl||""}}),i){for(const p in r){const y=r[p];if(Array.isArray(y)){const v=y.map(f=>{if(f&&f.id){const E=c.find(C=>C.id===f.id);return E?{...E}:f}return f});r[p]=v}}Q(e.mealPlanGrid,{menuData:r,servingsData:d,remarksData:h,defaultNumPeople:m,startDay:o},!1),ae(document.getElementById("mobile-meal-plan"),{menuData:r,servingsData:d,remarksData:h,defaultNumPeople:m,startDay:o},!1),Z()}}),u=Xt(b=>{N=b,Cn(b);const p=localStorage.getItem("selectedPlanId"),y=localStorage.getItem("lastActivePlanId");p&&b.some(v=>v.id===p)?(e.planSelect.value=p,localStorage.removeItem("selectedPlanId")):y&&b.some(v=>v.id===y)&&(e.planSelect.value=y),tn()});return()=>{u(),l(),s()}}const jn=An();return async()=>{const s=await jn;typeof s=="function"&&s()}}const _a=Object.freeze(Object.defineProperty({__proto__:null,default:Pa},Symbol.toStringTag,{value:"Module"}));function $a(){const e=_n();return Jt(),()=>{typeof e=="function"&&e()}}async function Jt(){const e=document.getElementById("received-shares-container"),t=De();if(!(!t||!e)){e.innerHTML='<p class="text-gray-500">Chargement des partages re√ßus...</p>';try{const n=ke(Y(w,"plans"),ue("userId","==",t),ue("isShared","==",!0)),a=ke(Y(w,"plans"),ue("collaborators","array-contains",t)),[o,r]=await Promise.all([Ce(n),Ce(a)]);let d=[];if(o.forEach(h=>d.push({id:h.id,type:"Planification (Copie)",...h.data()})),r.forEach(h=>d.push({id:h.id,type:"Planification (Collaboratif)",...h.data()})),d.length===0){e.innerHTML=`<p class="text-gray-500">Vous n'avez aucun contenu partag√© par d'autres utilisateurs.</p>`;return}d.sort((h,x)=>(x.sharedAt?.seconds||x.lastUpdated?.seconds||0)-(h.sharedAt?.seconds||h.lastUpdated?.seconds||0)),e.innerHTML="";for(const h of d){const x=h.originalOwnerId||h.userId;if(!x)continue;const g=await Pe(q(w,"users",x)),c=g.exists()?g.data().displayName:"Utilisateur inconnu";e.appendChild(Ha(h,c))}}catch(n){console.error("Erreur lors du chargement des partages re√ßus : ",n),e.innerHTML='<p class="text-red-500">Une erreur est survenue.</p>'}}}function Ha(e,t){const n=document.createElement("div");n.className="bg-white rounded-lg p-4 flex justify-between items-center shadow-sm";const a=document.createElement("div"),o=document.createElement("p");o.className="font-bold text-gray-800";let r="";e.type.includes("Collaboratif")?r=' <span class="text-xs font-medium bg-blue-100 text-blue-800 px-2 py-1 rounded-full">Collab</span>':e.type.includes("Copie")&&(r=' <span class="text-xs font-medium bg-gray-200 text-gray-800 px-2 py-1 rounded-full">Copie</span>'),o.innerHTML=`${e.name}${r}`;const d=document.createElement("p");d.className="text-sm text-gray-500 mt-1";const h=e.sharedAt?new Date(e.sharedAt.seconds*1e3).toLocaleDateString("fr-FR"):e.lastUpdated?new Date(e.lastUpdated.seconds*1e3).toLocaleDateString("fr-FR"):"date inconnue";d.textContent=`Partag√© par ${t} le ${h}`,a.appendChild(o),a.appendChild(d),n.appendChild(a);const x=document.createElement("button");return x.className="text-red-500 hover:bg-red-50 text-sm px-3 py-1 rounded-md",x.addEventListener("click",()=>Aa(e.id,e.type)),n.appendChild(x),n}async function Aa(e,t){if(confirm(`Voulez-vous vraiment supprimer cette ${t.toLowerCase()} partag√©e ?`))try{const n=t.startsWith("Planification")?"plans":"shopping_lists",a=q(w,n,e),o=await Pe(a);o.exists()&&o.data().userId===De()?(await ze(a),Jt()):(alert("Vous n'avez pas la permission de supprimer cet √©l√©ment ou il a d√©j√† √©t√© supprim√©."),Jt())}catch(n){console.error("Erreur de suppression: ",n),alert("Une erreur est survenue.")}}async function _n(){const e=document.getElementById("sent-shares-container"),t=De();if(!t||!e)return()=>{};e.innerHTML='<p class="text-gray-500">Chargement des partages envoy√©s...</p>';const n=Y(w,"shares"),a=ke(n,ue("senderId","==",t));return Je(a,async o=>{if(o.empty){e.innerHTML=`<p class="text-gray-500">Vous n'avez envoy√© aucun partage.</p>`;return}const r=o.docs.sort((d,h)=>(h.data().createdAt?.seconds||0)-(d.data().createdAt?.seconds||0));e.innerHTML="";for(const d of r){const h=d.data();try{const x=await Pe(q(w,"users",h.receiverId));if(x.exists()){const g=x.data();e.appendChild(ja(h,g.displayName,d.id))}}catch(x){console.error("Could not load receiver for sent share",x)}}},o=>{console.error("Erreur lors du chargement des partages envoy√©s : ",o),e&&(e.innerHTML='<p class="text-red-500">Une erreur est survenue.</p>')})}function ja(e,t,n){const a=document.createElement("div");a.className="bg-white rounded-lg p-4 flex justify-between items-center shadow-sm";const o=document.createElement("div"),r=document.createElement("p");r.className="font-bold text-gray-800";let d=[];e.plan&&d.push("Planification"),e.shoppingList&&d.push("Liste de courses"),r.textContent=d.join(" et ");const h=document.createElement("p");h.className="text-sm text-gray-500";const x=new Date(e.createdAt.seconds*1e3).toLocaleDateString("fr-FR");h.textContent=`Envoy√© √† ${t} le ${x}`,o.appendChild(r),o.appendChild(h),a.appendChild(o);const g=document.createElement("div");g.className="flex items-center space-x-4";const c=document.createElement("span");c.textContent=e.status;let L="bg-gray-200 text-gray-800";switch(e.status){case"accepted":L="bg-green-100 text-green-800";break;case"declined":L="bg-red-100 text-red-800";break;case"pending":L="bg-yellow-100 text-yellow-800";break}c.className=`text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full ${L}`,g.appendChild(c);const m=document.createElement("button");return m.className="text-red-500 hover:bg-red-50 text-sm px-3 py-1 rounded-md",m.innerHTML='<i class="fas fa-trash"></i>',m.title="Annuler le partage",m.addEventListener("click",()=>Ra(n)),g.appendChild(m),a.appendChild(g),a}async function Ra(e){if(confirm("Voulez-vous vraiment annuler ce partage ? L'autre utilisateur ne le verra plus."))try{await ze(q(w,"shares",e)),_n()}catch(t){console.error("Erreur lors de la suppression du partage: ",t),alert("Une erreur est survenue.")}}const qa=Object.freeze(Object.defineProperty({__proto__:null,default:$a},Symbol.toStringTag,{value:"Module"})),tt=hn();let ct=null,Oe=null,mn=[],pn=[],rt={};function ut(e){return e?e.replace(/\./g,"_"):""}function Ua(){const e=document.getElementById("shopping-mode-container"),t=document.getElementById("shopping-mode-plan-select"),n=document.createElement("button");n.id="scroll-to-top-btn",n.className="hidden fixed bottom-20 right-5 bg-tomato text-white rounded-full w-12 h-12 shadow-lg z-50",n.innerHTML='<i class="fas fa-arrow-up"></i>',document.body.appendChild(n),window.addEventListener("scroll",()=>{window.pageYOffset>200?n.classList.remove("hidden"):n.classList.add("hidden")}),n.addEventListener("click",()=>{window.scrollTo({top:0,behavior:"smooth"})});async function a(){try{pn=(await Ce(Y(tt,"ingredients"))).docs.map(g=>({id:g.id,...g.data()}))}catch(x){console.error("Error fetching ingredients",x)}try{mn=(await Ce(Y(tt,"recipes"))).docs.map(g=>({id:g.id,...g.data()}))}catch(x){console.error("Error fetching recipes",x)}Xt(x=>{if(!t)return;if(t.innerHTML="",x.length===0){e.innerHTML='<p class="text-center p-4">Aucun plan trouv√©.</p>';return}x.forEach(c=>{const L=document.createElement("option");L.value=c.id,L.textContent=c.name,t.appendChild(L)});const g=localStorage.getItem("lastActivePlanId");g&&x.some(c=>c.id===g)?(t.value=g,o(g)):x.length>0&&o(x[0].id),t.addEventListener("change",c=>{const L=c.target.value;localStorage.setItem("lastActivePlanId",L),o(L)})})}function o(x){ct&&(ct(),ct=null);const g=q(tt,"plans",x);ct=Je(g,c=>{c.exists()?(Oe={id:c.id,...c.data()},rt=Oe.checkedItems||{},r()):e.innerHTML='<p class="text-center p-4 text-red-500">Plan introuvable.</p>'})}function r(){if(!Oe||!e)return;const{active:x,deleted:g}=h(Oe);e.innerHTML="";const c=[],L=[];if(x.forEach(I=>{const T=`${I.name}_${I.unit||""}`,X=ut(T);(rt.hasOwnProperty(X)?rt[X]:rt[T]||!1)?L.push(I):c.push(I)}),c.length===0&&L.length===0){e.innerHTML='<p class="text-center p-10 text-gray-500">Votre liste de courses est vide pour ce plan.</p>';return}const m=c.reduce((I,T)=>{const X=T.category||"Inconnue";return I[X]||(I[X]=[]),I[X].push(T),I},{}),M=Object.keys(m).sort((I,T)=>I==="Inconnue"?1:T==="Inconnue"?-1:I.localeCompare(T)),N=document.createElement("div");N.id="shopping-category-tabs",N.className="flex overflow-x-auto space-x-2 py-2 bg-white z-20 mb-4",e.appendChild(N);const i=I=>"category-"+I.replace(/[^a-zA-Z0-9]/g,"-").toLowerCase();if(M.forEach(I=>{const T=document.createElement("button");T.className="btn btn-sm btn-outline flex-shrink-0",T.textContent=I,T.onclick=()=>{const X=document.getElementById(i(I));if(X){const U=document.querySelector("header"),G=U?U.offsetHeight:0,Q=X.getBoundingClientRect().top+window.pageYOffset-G-40;window.scrollTo({top:Q,behavior:"smooth"})}},N.appendChild(T)}),M.forEach(I=>{const T=document.createElement("h3");T.className="font-bold text-lg text-gray-700 mt-6 mb-3 border-b border-gray-200 pb-1 sticky top-0 bg-white z-10",T.textContent=I,T.id=i(I),e.appendChild(T);const X=document.createElement("ul");X.className="space-y-3",m[I].sort((U,G)=>U.name.localeCompare(G.name)).forEach(U=>{const G=`${U.name}_${U.unit||""}`,ae=ut(G),Q=rt.hasOwnProperty(ae)?rt[ae]:rt[G]||!1,se=U.hasManualEntry===!0||!U.sources||U.sources.length===0,me=document.createElement("li");se&&(me.dataset.isManual="true",me.style.backgroundColor="#ffedd5");const H=Q?"bg-gray-100":se?"bg-orange-100 shadow-sm border border-orange-200":"bg-white shadow-sm border border-gray-100";me.className=`flex flex-col p-3 rounded-lg transition-colors duration-200 ${H}`;const B=document.createElement("div");B.className="flex items-center w-full";const j=document.createElement("input");j.type="checkbox",j.className="form-checkbox h-6 w-6 text-tomato rounded-full border-gray-300 focus:ring-tomato cursor-pointer transition duration-150 ease-in-out",j.checked=Q;const V=document.createElement("div");V.className="ml-3 flex-grow cursor-pointer select-none";const oe=Number.isInteger(U.totalQuantity)?U.totalQuantity:parseFloat(U.totalQuantity.toFixed(2)),$=document.createElement("span");$.className=`font-medium text-base ${Q?"line-through text-gray-400":"text-gray-800"}`,$.textContent=U.name;const de=document.createElement("span");de.className=`ml-2 font-bold text-base ${Q?"text-gray-400":"text-gray-800"}`,de.textContent=` - ${oe} ${U.unit||""}`.trim(),V.appendChild($),V.appendChild(de);const le=()=>{const Z=!j.checked;j.checked=Z,d(ae,Z,me,j,$,de)};if(j.addEventListener("change",Z=>{d(ae,Z.target.checked,me,j,$,de)}),V.addEventListener("click",le),B.appendChild(j),B.appendChild(V),me.appendChild(B),U.sources&&U.sources.length>0){const Z=document.createElement("div");Z.className="mt-2 ml-9 text-xs text-gray-500 space-y-1";const ce=U.sources.reduce((pe,A)=>{const z=`${A.recipeName} (${A.day} ${A.time})`;return pe[z]||(pe[z]=0),pe[z]+=A.quantity,pe},{});for(const pe in ce){const A=document.createElement("div");A.textContent=`‚Ü≥ ${pe}`,Z.appendChild(A)}me.appendChild(Z)}X.appendChild(me)}),e.appendChild(X)}),L.length>0){const I=document.createElement("div");I.className="my-8 border-t-2 border-dashed border-gray-300 pt-4 text-center";const T=document.createElement("h3");T.className="text-lg font-semibold text-gray-500",T.textContent="Articles coch√©s",I.appendChild(T),e.appendChild(I);const X=L.reduce((G,ae)=>{const Q=ae.category||"Inconnue";return G[Q]||(G[Q]=[]),G[Q].push(ae),G},{});Object.keys(X).sort((G,ae)=>G==="Inconnue"?1:ae==="Inconnue"?-1:G.localeCompare(ae)).forEach(G=>{const ae=document.createElement("h3");ae.className="font-bold text-lg text-gray-700 mt-6 mb-3 border-b border-gray-200 pb-1",ae.textContent=G,e.appendChild(ae);const Q=document.createElement("ul");Q.className="space-y-3",X[G].sort((se,me)=>se.name.localeCompare(me.name)).forEach(se=>{const me=`${se.name}_${se.unit||""}`,H=ut(me),B=!0,j=se.hasManualEntry===!0||!se.sources||se.sources.length===0,V=document.createElement("li");j&&(V.dataset.isManual="true"),V.className="flex flex-col p-3 rounded-lg transition-colors duration-200 bg-gray-100";const oe=document.createElement("div");oe.className="flex items-center w-full";const $=document.createElement("input");$.type="checkbox",$.className="form-checkbox h-6 w-6 text-tomato rounded-full border-gray-300 focus:ring-tomato cursor-pointer transition duration-150 ease-in-out",$.checked=B;const de=document.createElement("div");de.className="ml-3 flex-grow cursor-pointer select-none";const le=Number.isInteger(se.totalQuantity)?se.totalQuantity:parseFloat(se.totalQuantity.toFixed(2)),Z=document.createElement("span");Z.className="font-medium text-base line-through text-gray-400",Z.textContent=se.name;const ce=document.createElement("span");ce.className="ml-2 font-bold text-base text-gray-400",ce.textContent=` - ${le} ${se.unit||""}`.trim(),de.appendChild(Z),de.appendChild(ce);const pe=()=>{const A=!$.checked;$.checked=A,d(H,A,V,$,Z,ce)};$.addEventListener("change",A=>{d(H,A.target.checked,V,$,Z,ce)}),de.addEventListener("click",pe),oe.appendChild($),oe.appendChild(de),V.appendChild(oe),Q.appendChild(V)}),e.appendChild(Q)})}const S=document.getElementById("shopping-mode-trash-btn"),K=document.getElementById("shopping-mode-trash-count"),ve=document.getElementById("shopping-trash-modal"),W=document.getElementById("shopping-trash-list"),J=document.getElementById("close-shopping-trash-modal"),_=document.getElementById("shopping-empty-trash-btn");if(S&&(g&&g.length>0?(S.classList.remove("hidden"),K&&(K.textContent=g.length)):S.classList.add("hidden")),ve&&J&&(J.onclick=()=>ve.classList.add("hidden"),ve.addEventListener("click",I=>{I.target===ve&&ve.classList.add("hidden")})),g&&g.length>0){if(_){_.classList.remove("hidden");const I=_.cloneNode(!0);_.parentNode.replaceChild(I,_),I.addEventListener("click",async()=>{if(!Oe||!confirm("Tout supprimer d√©finitivement ?"))return;const T=q(tt,"plans",Oe.id),X=g.map(U=>ut(`${U.name}_${U.unit||""}`));try{await mt(()=>import("./firebase-config-CV1YP_xo.js").then(U=>U.F),[]).then(U=>{U.updateDoc(T,{hiddenTrashItems:U.arrayUnion(...X),lastUpdated:new Date})}),ve.classList.add("hidden")}catch(U){console.error("Erreur vidage corbeille:",U)}})}if(W){W.innerHTML="";const I=document.createElement("ul");I.className="space-y-3",g.forEach(T=>{const X=document.createElement("li");X.className="flex items-center p-3 rounded-lg bg-gray-100 shadow-inner justify-between";const U=document.createElement("div");U.className="flex-grow ml-2 overflow-hidden";const G=document.createElement("span");G.className="font-medium text-base text-gray-500 line-through block truncate",G.textContent=T.name,U.appendChild(G);const ae=document.createElement("div");ae.className="flex items-center space-x-2 flex-shrink-0";const Q=document.createElement("button");Q.className="text-blue-600 hover:text-blue-800 font-medium text-sm px-3 py-1 border border-blue-300 rounded-full hover:bg-blue-50 transition-colors",Q.innerHTML='<i class="fas fa-undo"></i>',Q.addEventListener("click",async()=>{if(!Oe)return;const me=q(tt,"plans",Oe.id);try{await mt(()=>import("./firebase-config-CV1YP_xo.js").then(H=>H.F),[]).then(async H=>{await H.runTransaction(tt,async B=>{const j=await B.get(me);if(!j.exists())return;const oe=(j.data().manualItems||[]).filter($=>!($.name.toLowerCase()===T.name.toLowerCase()&&$.unit===T.unit));B.update(me,{manualItems:oe,lastUpdated:new Date})}),g.length<=1&&ve.classList.add("hidden")})}catch(H){console.error("Erreur lors de la restauration :",H)}});const se=document.createElement("button");se.className="text-gray-400 hover:text-red-600 font-medium text-sm px-2 py-1",se.innerHTML='<i class="fas fa-times text-lg"></i>',se.addEventListener("click",async()=>{if(!Oe)return;const me=q(tt,"plans",Oe.id),H=ut(`${T.name}_${T.unit||""}`);try{await mt(()=>import("./firebase-config-CV1YP_xo.js").then(B=>B.F),[]).then(B=>{B.updateDoc(me,{hiddenTrashItems:B.arrayUnion(H),lastUpdated:new Date})}),g.length<=1&&ve.classList.add("hidden")}catch(B){console.error("Erreur suppression d√©finitive:",B)}}),ae.appendChild(Q),ae.appendChild(se),X.appendChild(U),X.appendChild(ae),I.appendChild(X)}),W.appendChild(I)}}else W&&(W.innerHTML='<p class="text-center text-gray-500 italic py-4">La corbeille est vide.</p>'),_&&_.classList.add("hidden")}function d(x,g,c,L,m,M){if(!Oe)return;const N=c.dataset.isManual==="true";g?(c.classList.remove("bg-white","bg-orange-100","shadow-sm","border","border-gray-100","border-orange-200"),c.classList.add("bg-gray-100"),c.style.backgroundColor="",m.classList.add("line-through","text-gray-400"),m.classList.remove("text-gray-800"),M.classList.add("text-gray-400"),M.classList.remove("text-gray-800")):(c.classList.remove("bg-gray-100"),N?(c.classList.add("bg-orange-100","shadow-sm","border","border-orange-200"),c.style.backgroundColor="#ffedd5"):(c.classList.add("bg-white","shadow-sm","border","border-gray-100"),c.style.backgroundColor=""),m.classList.remove("line-through","text-gray-400"),m.classList.add("text-gray-800"),M.classList.remove("text-gray-400"),M.classList.add("text-gray-800"));const i=q(tt,"plans",Oe.id),S={};S[`checkedItems.${x}`]=g,S.lastUpdated=new Date,mt(()=>import("./firebase-config-CV1YP_xo.js").then(K=>K.F),[]).then(K=>{K.updateDoc(i,S)}).catch(K=>{console.error("Error updating checked item:",K)})}function h(x){const g=new Map;(x.manualItems||[]).forEach(i=>{const S=`${i.name.trim().toLowerCase()}_${i.unit||""}`;g.set(S,{name:i.name.trim(),totalQuantity:i.totalQuantity,unit:i.unit,category:i.category||"Inconnue",hasManualEntry:!0})});const L=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];if(x.weeks)for(const i in x.weeks){const S=x.weeks[i],K=S.menuData||{},ve=S.servingsData||{};for(const W in K){const J=K[W];if(!Array.isArray(J))continue;const[_,I]=W.split("-"),T=`${_}-${I}`,X=parseInt(ve[T]||x.defaultNumPeople||1,10);J.forEach(U=>{const G=mn.find(Q=>Q.id===U.id)||U;if(!G||!G.ingredients)return;const ae=G.servings||1;G.ingredients.forEach(Q=>{if(!Q.name||!Q.quantity)return;const se=pn.find($=>$.name.toLowerCase()===Q.name.toLowerCase()),me=se?se.category:"Inconnue",H=parseFloat(String(Q.quantity).replace(",","."));if(isNaN(H))return;const j=H/ae*X,V=Q.unit||"",oe=`${Q.name.trim().toLowerCase()}_${V}`;if(g.has(oe)){const $=g.get(oe);$.totalQuantity+=j,$.sources||($.sources=[]),$.sources.push({recipeName:G.name,day:L[parseInt(_,10)],time:I==="lunch"?"Midi":"Soir",quantity:j})}else g.set(oe,{name:Q.name.trim(),totalQuantity:j,unit:V,category:me,sources:[{recipeName:G.name,day:L[parseInt(_,10)],time:I==="lunch"?"Midi":"Soir",quantity:j}]})})})}}const m=[],M=[],N=x.hiddenTrashItems||[];return g.forEach(i=>{if(i.totalQuantity>0)m.push(i);else if(i.totalQuantity<=0&&i.sources&&i.sources.length>0){const S=`${i.name}_${i.unit||""}`,K=ut(S);!N.includes(K)&&!N.includes(S)&&M.push(i)}}),{active:m,deleted:M}}return a(),()=>{ct&&ct()}}const Oa=Object.freeze(Object.defineProperty({__proto__:null,default:Ua},Symbol.toStringTag,{value:"Module"}));function Fa(){const e=localStorage.getItem("selectedPlanId"),t=document.getElementById("plan-view-name"),n=document.getElementById("meal-plan-grid"),a=document.getElementById("close-view-plan-btn");if(a&&a.addEventListener("click",()=>{localStorage.removeItem("selectedPlanId"),Ve("plans")}),!e)return t&&(t.textContent="Aucune sauvegarde s√©lectionn√©e"),n&&(n.innerHTML=`<p class="text-center text-red-500">Erreur : Aucun ID de sauvegarde trouv√©. Veuillez retourner √† la page 'Mes Plans Sauvegard√©s' et en s√©lectionner une.</p>`),()=>{};async function o(){try{const r=q(w,"plan_saves",e),d=await Pe(r);if(!d.exists())throw new Error("Sauvegarde non trouv√©e");const h=d.data(),x=h.planData;if(!x)throw new Error("Les donn√©es du plan sauvegard√© sont corrompues ou manquantes.");t&&(t.textContent=`Vue de : ${h.name}`),za(n,x)}catch(r){console.error("Error fetching save:",r),t&&(t.textContent="Erreur"),n&&(n.innerHTML=`<p class="text-center text-red-500">${r.message}</p>`)}}return o(),()=>{localStorage.removeItem("selectedPlanId")}}function za(e,t){if(!e)return;e.innerHTML="";const n=Object.keys(t.weeks||{}).sort((a,o)=>parseInt(a)-parseInt(o));if(n.length===0){e.innerHTML='<p class="text-center text-gray-500 p-10 col-span-full">Ce plan est vide.</p>';return}n.forEach(a=>{const o=t.weeks[a],r=document.createElement("h3");r.className="text-lg font-bold text-gray-700 mt-6 mb-2 col-span-full",r.textContent=`Semaine ${a}`,e.appendChild(r);const d=document.createElement("div");Va(d,o,t.startDay,t.defaultNumPeople),e.appendChild(d)})}function Va(e,t,n,a){const o=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"],r=o.indexOf(n||"Lundi"),d=[...o.slice(r),...o.slice(0,r)],h=t.menuData||{},x=t.servingsData||{},g=t.remarksData||{};d.forEach(c=>{const L=o.indexOf(c),m=document.createElement("div");m.className="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] items-stretch border-b border-gray-300";const M=document.createElement("div");M.className="font-bold p-2 flex items-center justify-center bg-gray-100 text-sm border-r border-gray-300",M.textContent=c.toUpperCase(),m.appendChild(M),["lunch","dinner"].forEach(N=>{const i=`${L}-${N}`,S=x[i]||a||1,K=document.createElement("div");K.className="border-r border-gray-300 flex items-center justify-center",K.innerHTML=`<div class="text-center"><i class="fas fa-users fa-xs mb-1"></i><br>${S}</div>`,m.appendChild(K);for(let ve=0;ve<5;ve++){const W=`${L}-${N}-${ve}`,J=document.createElement("div");if(J.className="meal-slot p-1 min-h-[50px] border-r border-gray-300",ve===4)J.textContent=g[W]||"",J.classList.add("text-xs","italic","text-gray-600");else{const _=h[W];Array.isArray(_)&&_.length>0&&_.forEach(I=>{const T=document.createElement("div");T.className="p-1 bg-white rounded shadow-sm text-center text-xs font-medium",T.textContent=I.name,J.appendChild(T)})}m.appendChild(J)}}),e.appendChild(m)})}const Qa=Object.freeze(Object.defineProperty({__proto__:null,default:Fa},Symbol.toStringTag,{value:"Module"})),fn=document.querySelector("main"),Wa={menu:{html:`
        <div class="flex flex-col md:flex-row md:space-x-2">

            <!-- Left Column: Meal Planner -->
            <div class="w-full md:w-5/6">
                <section id="meal-planning-section" aria-labelledby="meal-planning-heading" class="mb-8 md:mb-12">
                                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                                        <h2 id="meal-planning-heading" class="text-xl md:text-2xl font-bold text-foreground">Planification des repas</h2>
                                        <div class="mt-3 md:mt-0 flex items-center space-x-2 md:space-x-3 plan-actions">
                                            <button id="generate-plan-ai-btn" class="btn btn-primary btn-sm">
                                                <i class="fas fa-robot mr-1 md:mr-2"></i> IA Semaine
                                            </button>
                                            <button id="clear-menu-btn" class="btn btn-outline btn-sm text-red-800 hover:bg-red-100">
                                                <i class="fas fa-trash-alt mr-1 md:mr-2"></i> Vider le menu
                                            </button>
                                            <button id="export-plan-pdf-btn" class="btn btn-outline btn-sm">
                                                <i class="fas fa-file-pdf mr-1 md:mr-2"></i> Exporter Plan (PDF)
                                            </button>
                                            <button id="share-plan-btn" class="btn btn-secondary btn-sm">
                                                <i class="fas fa-share-alt mr-1 md:mr-2"></i> Partager
                                            </button>
                                            <button id="save-plan-btn" class="btn btn-secondary btn-sm">
                                                <i class="fas fa-save mr-1 md:mr-2"></i> Sauvegarder Plan
                                            </button>
                                        </div>
                                    </div>
                            
                                    <!-- Week Navigation & Plan Selector -->
                                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 space-y-3 md:space-y-0">
                                        <!-- Week Navigation -->
                                        <div class="flex justify-between items-center bg-card text-card-foreground border border-border p-2 md:p-3 rounded-lg shadow-sm">
                                            <button id="prev-week-btn" class="p-2 rounded-md hover:bg-gray-100 text-muted-foreground hover:text-tomato transition-colors" aria-label="Semaine pr√©c√©dente">
                                                <i class="fas fa-chevron-left mr-1 md:mr-2"></i> Pr√©c.
                                            </button>
                                            <div id="current-week-display" class="text-gray-700 font-medium text-sm md:text-base text-center mx-4">Semaine X</div>
                                            <button id="next-week-btn" class="p-2 rounded-md hover:bg-gray-100 text-muted-foreground hover:text-tomato transition-colors" aria-label="Semaine suivante">
                                                Suiv. <i class="fas fa-chevron-right ml-1 md:ml-2"></i>
                                            </button>
                                        </div>
                                        <!-- Plan Selector -->
                                        <div class="flex flex-wrap items-center justify-center gap-2 bg-card text-card-foreground border border-border p-3 rounded-lg shadow-sm">
                                            <label for="plan-select" class="text-sm font-medium text-gray-700">Plan affich√©:</label>
                                            <select id="plan-select" class="rounded-md border-gray-300 shadow-sm focus:border-tomato focus:ring focus:ring-tomato focus:ring-opacity-50 text-sm py-1">
                                                <!-- Options will be generated by JS -->
                                            </select>
                                            <button id="create-plan-btn" class="btn btn-primary btn-sm" title="Cr√©er un nouveau plan">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                            <button id="rename-plan-btn" class="text-blue-500 hover:bg-blue-100 text-sm px-3 py-1 rounded-md" title="Renommer le plan s√©lectionn√©">
                                                <i class="fas fa-pencil-alt"></i>
                                            </button>
                                            <button id="history-plan-btn" class="text-purple-500 hover:bg-purple-100 text-sm px-3 py-1 rounded-md" title="Historique des modifications">
                                                <i class="fas fa-history"></i>
                                            </button>
                                            <button id="leave-plan-btn" class="text-yellow-600 hover:bg-yellow-100 text-sm px-3 py-1 rounded-md" title="Quitter le plan collaboratif">
                                                <i class="fas fa-door-open"></i>
                                            </button>
                                            <button id="delete-plan-btn" class="text-red-500 hover:bg-red-100 text-sm px-3 py-1 rounded-md" title="Supprimer le plan s√©lectionn√©">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            <button id="invite-participant-btn" class="text-green-500 hover:bg-green-100 text-sm px-3 py-1 rounded-md hidden" title="Inviter un participant">
                                                <i class="fas fa-user-plus"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Collaborators Bar -->
                                    <div id="collaborators-bar" class="flex items-center space-x-2 mb-4 hidden">
                                        <!-- Avatars will be injected here -->
                                    </div>

                                    <!-- Activity Labels -->
                                    <div id="activity-labels-container" class="text-sm text-muted-foreground mb-4 h-6">
                                        <!-- e.g., 'Sophie is adding a recipe...' -->
                                    </div>
                            
                                            <!-- Settings Section -->
                                            <div class="inline-flex items-center space-x-6 bg-card text-card-foreground border border-border p-3 rounded-lg shadow-sm mb-4">                                        <div>
                                            <label for="start-day-select" class="text-sm font-medium text-gray-700">D√©but de semaine:</label>
                                            <select id="start-day-select" class="rounded-md border-gray-300 shadow-sm focus:border-tomato focus:ring-tomato text-sm py-1">
                                                <option>Lundi</option>
                                                <option>Mardi</option>
                                                <option>Mercredi</option>
                                                <option>Jeudi</option>
                                                <option>Vendredi</option>
                                                <option>Samedi</option>
                                                <option>Dimanche</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="default-servings-input" class="text-sm font-medium text-gray-700">Personnes par d√©faut:</label>
                                            <div id="default-servings-control" class="mt-1"></div>
                                        </div>
                                    </div>                    <!-- Responsive Meal Plan Grid -->
<div class="bg-card text-card-foreground rounded-xl shadow-md border border-border p-4">
                        <!-- Desktop Grid (Visible on large screens) -->
                        <div id="desktop-plan-container" class="hidden lg:block">
                            <div id="meal-plan-grid-layout">
                                <!-- Header -->
                                <div class="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] gap-1 text-center mb-1">
                                    <div class="p-2"></div> <!-- Empty corner -->
                                    <div class="p-2 rounded-t-lg bg-amber-100 text-amber-800 font-bold col-span-6">MIDI</div>
                                    <div class="p-2 rounded-t-lg bg-stone-200 text-stone-800 font-bold col-span-6">SOIR</div>
                                    
                                    <div class="p-1"></div> <!-- Empty under day name -->
                                    <div class="p-1 text-xs font-semibold"><i class="fas fa-users"></i></div>
                                    <div class="p-1 text-xs font-semibold text-muted-foreground">Entr√©e</div>
                                    <div class="p-1 text-xs font-semibold text-muted-foreground">Plat</div>
                                    <div class="p-1 text-xs font-semibold text-muted-foreground">Accomp.</div>
                                    <div class="p-1 text-xs font-semibold text-muted-foreground">Dessert</div>
                                    <div class="p-1 text-xs font-semibold text-muted-foreground">Remarque</div>

                                    <div class="p-1 text-xs font-semibold"><i class="fas fa-users"></i></div>
                                    <div class="p-1 text-xs font-semibold text-muted-foreground">Entr√©e</div>
                                    <div class="p-1 text-xs font-semibold text-muted-foreground">Plat</div>
                                    <div class="p-1 text-xs font-semibold text-muted-foreground">Accomp.</div>
                                    <div class="p-1 text-xs font-semibold text-muted-foreground">Dessert</div>
                                    <div class="p-1 text-xs font-semibold text-muted-foreground">Remarque</div>
                                </div>
                                <!-- Rows generated by JS -->
                                <div id="meal-plan-grid" class="space-y-1">
                                    <div class="p-10 text-center text-muted-foreground italic col-span-full">Chargement du planning...</div>
                                </div>
                            </div>
                        </div>

                        <!-- Mobile Accordion (Visible on small screens) -->
                        <div id="mobile-meal-plan" class="lg:hidden space-y-2">
                            <!-- Mobile content will be generated by JS here -->
                             <div class="p-10 text-center text-muted-foreground italic col-span-full">Chargement du planning...</div>
                        </div>
                    </div>
                                    </section>


                                </div>
                    
                                <!-- Right Column: Shopping List -->
                                <div class="w-full md:w-1/6">
                                    <section id="shopping-list-section" aria-labelledby="shopping-list-heading" class="mb-8 md:mb-12 md:sticky md:top-24">
                                        <div class="bg-card text-card-foreground rounded-xl shadow-md border border-border p-4 md:p-6">
                                            <div class="flex justify-between items-center mb-4">
                                        <h2 class="text-2xl font-bold text-foreground">Liste de courses</h2>
                                        <button id="open-trash-btn" class="flex items-center justify-center p-2 rounded-md hover:bg-gray-100 text-muted-foreground hover:text-gray-700 ml-2 transition-colors">
                                            <i class="fas fa-trash-alt text-lg"></i> <span id="trash-count" class="bg-gray-200 text-xs px-1.5 py-0.5 rounded-full ml-1">0</span>
                                        </button>
                                    </div>
                                    <div class="flex justify-end space-x-2 mb-4">
                                        <button id="import-list-btn" class="btn btn-secondary btn-sm">
                                                    <i class="fas fa-download mr-2"></i>Importer une liste
                                                </button>
                                                <div id="export-buttons-container" class="flex space-x-2">
                                                    <button id="export-txt-btn" class="btn btn-outline btn-sm">
                                                        <i class="fas fa-file-alt mr-2"></i>TXT
                                                    </button>
                                                    <button id="export-pdf-btn" class="btn btn-outline btn-sm">
                                                        <i class="fas fa-file-pdf mr-2"></i>PDF
                                                    </button>
                                                </div>
                                            </div>
                    
                                            <!-- Shopping List Container -->
                                            <div id="shopping-list-container" class="mb-4 max-h-[70vh] overflow-y-auto pr-2">                            <ul id="shopping-list" class="space-y-2 text-sm">
                                <!-- Les articles de la liste de courses seront g√©n√©r√©s ici -->
                            </ul>
                        </div>

                        <!-- Add Item Input -->
                        <div class="mt-4 flex items-stretch">
                            <div class="relative flex-grow">
                                <input type="text" id="add-item-input" placeholder="Chercher ou ajouter..." class="w-full border border-gray-300 rounded-l-lg px-2 py-1 text-xs focus:outline-none focus:ring-2 focus:ring-tomato focus:border-transparent">
                                <div id="add-item-results" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto bottom-full mb-2"></div>
                            </div>
                            <button id="add-item-btn" class="btn btn-primary rounded-l-none -ml-px btn-xs" aria-label="Ajouter l'article">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>

                         <!-- AI Shopping Tips Placeholder -->
                        <div id="ai-shopping-tip" class="mt-6 bg-avocado bg-opacity-10 rounded-lg p-3 hidden">
                            <div class="flex items-start">
                                 <div class="w-8 h-8 bg-avocado bg-opacity-20 rounded-full flex items-center justify-center mr-3 shrink-0">
                                    <i class="fas fa-lightbulb text-avocado"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-avocado mb-1 text-sm">Astuce √âconomique</h4>
                                    <p id="ai-shopping-tip-text" class="text-sm text-gray-700">...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <!-- Shared Plans Modal -->
        <div id="shared-plans-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-6xl max-h-[90vh] overflow-y-auto relative">
                <button id="close-shared-plans-modal" class="absolute top-4 right-4 text-gray-400 hover:text-muted-foreground" aria-label="Fermer">
                    <i class="fas fa-times text-xl"></i>
                </button>
                <h3 id="shared-plans-modal-title" class="text-2xl font-bold mb-6">Plans partag√©s pour la Semaine X</h3>
                <div id="shared-plans-modal-container" class="space-y-6">
                    <!-- Shared plans will be loaded here -->
                </div>
            </div>
        </div>
        `,script:"./script.js"},recipes:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-foreground">Mes Recettes</h2>
            <button id="add-recipe-btn" class="btn btn-primary">
                <i class="fas fa-plus mr-2"></i> Ajouter une recette
            </button>
        </div>

        <!-- Search Bar -->
        <div class="mb-6">
            <input type="text" id="search-bar" placeholder="Rechercher une recette..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-tomato focus:border-tomato">
        </div>

        <!-- Tabs Navigation -->
        <div id="category-tabs" class="mb-6 border-b border-gray-200 flex space-x-4 flex-nowrap overflow-x-auto pb-2">
            <!-- Tabs will be generated by recipes.js here -->
        </div>

        <!-- Recipe List Container -->
        <div id="recipe-list-container">
            <!-- Recipes for the selected tab will be loaded here -->
        </div>

        <!-- Reconstructed Recipe Form Modal -->
        <div id="recipe-form-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-3xl max-h-[90vh] overflow-y-auto relative">
                <button id="close-recipe-modal" class="absolute top-4 right-4 text-gray-400 hover:text-muted-foreground" aria-label="Fermer">
                    <i class="fas fa-times text-xl"></i>
                </button>
                <h3 id="recipe-modal-title" class="text-2xl font-bold mb-6">Ajouter/Modifier une recette</h3>
                <form id="recipe-form" class="space-y-4">
                    <input type="hidden" id="recipe-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label for="recipe-name" class="block text-sm font-medium text-gray-700">Nom de la recette</label>
                            <input type="text" id="recipe-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                        </div>
                        <div>
                            <label for="recipe-category" class="block text-sm font-medium text-gray-700">Cat√©gorie</label>
                            <select id="recipe-category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                                <option>ENTREE</option>
                                <option>PLAT</option>
                                <option>ACCOMPAGNEMENT</option>
                                <option>DESSERT</option>
                            </select>
                        </div>
                        <div>
                            <label for="recipe-servings" class="block text-sm font-medium text-gray-700">Nombre de personnes</label>
                            <input type="number" id="recipe-servings" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" min="1">
                        </div>
                        <div>
                            <label for="recipe-prep-time" class="block text-sm font-medium text-gray-700">Temps de pr√©paration (min)</label>
                            <input type="number" id="recipe-prep-time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" min="0">
                        </div>
                         <div>
                            <label for="recipe-difficulty" class="block text-sm font-medium text-gray-700">Difficult√©</label>
                            <select id="recipe-difficulty" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                <option>Tr√®s facile</option>
                                <option>Facile</option>
                                <option>Moyen</option>
                                <option>Difficile</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-lg font-medium text-foreground mb-2">Ingr√©dients</h4>
                        <div id="ingredients-list" class="space-y-2"></div>
                        <button type="button" id="add-ingredient-btn" class="btn btn-outline btn-sm mt-2">
                            <i class="fas fa-plus mr-2"></i> Ajouter un ingr√©dient
                        </button>
                    </div>
                    <div>
                        <label for="recipe-steps" class="block text-lg font-medium text-foreground">Pr√©paration</label>
                        <textarea id="recipe-steps" rows="8" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                    </div>
                    <div class="flex justify-end space-x-4 pt-4">
                        <button type="button" id="cancel-recipe-btn" class="text-gray-700 hover:bg-gray-100 px-4 py-2 rounded-md">Annuler</button>
                        <button type="submit" id="save-recipe-btn" class="btn btn-primary">Sauvegarder</button>
                    </div>
                </form>
            </div>
        </div>
        `,script:"./recipes.js"},ingredients:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-foreground">Mes Ingr√©dients</h2>
            <div class="flex space-x-2">
                <button id="manage-categories-btn" class="btn btn-outline">
                    <i class="fas fa-tags mr-2"></i> G√©rer les cat√©gories
                </button>
                <button id="add-ingredient-btn" class="btn btn-primary">
                    <i class="fas fa-plus mr-2"></i> Ajouter un ingr√©dient
                </button>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="mb-6">
            <input type="text" id="search-bar" placeholder="Rechercher un ingr√©dient..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-tomato focus:border-tomato">
        </div>

        <!-- Tabs Navigation -->
        <div id="category-tabs" class="mb-6 border-b border-gray-200 flex space-x-4 flex-nowrap overflow-x-auto pb-2">
            <!-- Tabs will be generated by ingredients.js here -->
        </div>

        <!-- Ingredient List Container -->
        <div id="ingredients-list-container">
            <p class="text-center text-muted-foreground p-10">Chargement des ingr√©dients...</p>
        </div>

        <!-- Ingredient Form Modal -->
        <div id="ingredient-form-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-md relative">
                <button id="close-ingredient-modal" class="absolute top-4 right-4 text-gray-400 hover:text-muted-foreground"><i class="fas fa-times text-xl"></i></button>
                <h3 id="ingredient-modal-title" class="text-lg font-bold mb-4">Ajouter un Ingr√©dient</h3>
                <form id="ingredient-form" class="space-y-4">
                    <input type="hidden" id="ingredient-id">
                    <div>
                        <label for="ingredient-name" class="block text-sm font-medium text-gray-700">Nom</label>
                        <input type="text" id="ingredient-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                    </div>
                    <div>
                        <label for="ingredient-unit" class="block text-sm font-medium text-gray-700">Unit√© par d√©faut</label>
                        <select id="ingredient-unit" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select>
                    </div>
                    <div>
                        <label for="ingredient-category" class="block text-sm font-medium text-gray-700">Cat√©gorie</label>
                        <select id="ingredient-category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Saisonnalit√© (Optionnel)</label>
                        <div class="flex flex-wrap gap-2">
                            <label class="flex items-center space-x-2 cursor-pointer bg-green-50 px-2 py-1 rounded-md border border-green-200">
                                <input type="checkbox" id="season-printemps" value="Printemps" class="form-checkbox h-4 w-4 text-green-600 focus:ring-green-500">
                                <span class="text-sm text-green-800">Printemps üå∏</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer bg-yellow-50 px-2 py-1 rounded-md border border-yellow-200">
                                <input type="checkbox" id="season-ete" value="Et√©" class="form-checkbox h-4 w-4 text-yellow-600 focus:ring-yellow-500">
                                <span class="text-sm text-yellow-800">Et√© ‚òÄÔ∏è</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer bg-orange-50 px-2 py-1 rounded-md border border-orange-200">
                                <input type="checkbox" id="season-automne" value="Automne" class="form-checkbox h-4 w-4 text-orange-600 focus:ring-orange-500">
                                <span class="text-sm text-orange-800">Automne üçÇ</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer bg-blue-50 px-2 py-1 rounded-md border border-blue-200">
                                <input type="checkbox" id="season-hiver" value="Hiver" class="form-checkbox h-4 w-4 text-blue-600 focus:ring-blue-500">
                                <span class="text-sm text-blue-800">Hiver ‚ùÑÔ∏è</span>
                            </label>
                        </div>
                    </div>
                    <div>
                        <label for="ingredient-image-url" class="block text-sm font-medium text-gray-700">URL de l'image</label>
                        <input type="text" id="ingredient-image-url" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="Laisser vide pour une image al√©atoire">
                    </div>
                    <div class="flex justify-end space-x-4 pt-2">
                        <button type="button" id="cancel-ingredient-btn" class="text-gray-700 hover:bg-gray-100 px-4 py-2 rounded-md">Annuler</button>
                        <button type="submit" id="save-ingredient-btn" class="btn btn-primary">Sauvegarder</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Category Management Modal -->
        <div id="category-management-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-lg relative">
                <h3 class="text-lg font-bold mb-4">G√©rer les cat√©gories d'ingr√©dients</h3>
                <form id="add-category-form" class="flex items-center space-x-2 mb-4">
                    <input type="text" id="new-category-name" placeholder="Nom de la nouvelle cat√©gorie" class="flex-grow mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                    <button type="submit" class="btn btn-secondary">Ajouter</button>
                </form>
                <div id="category-list" class="max-h-64 overflow-y-auto border rounded-lg p-2"></div>
                <div class="flex justify-end space-x-4 mt-4">
                     <button type="button" id="close-category-modal" class="text-gray-700 hover:bg-gray-100 px-4 py-2 rounded-md">Annuler</button>
                    <button type="button" id="done-category-modal-btn" class="btn btn-primary">Termin√©</button>
                </div>
            </div>
        </div>
        `,script:"./ingredients.js"},lists:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-foreground">Mes Listes de Courses</h2>
            <button id="add-list-btn" class="btn btn-primary">
                <i class="fas fa-plus mr-2"></i> Cr√©er une liste
            </button>
        </div>

        <!-- Search Bar -->
        <div class="mb-6">
            <input type="text" id="search-bar" placeholder="Rechercher une liste..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-tomato focus:border-tomato">
        </div>

        <!-- Lists Container -->
        <div id="lists-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

        <div class="mt-12">
            <h2 class="text-2xl md:text-3xl font-bold text-foreground mb-6">Listes Partag√©es</h2>
            <div id="shared-lists-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Les listes partag√©es seront charg√©es ici par JS -->
            </div>
        </div>

        <!-- List Form Modal -->
        <div id="list-form-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-start justify-center z-[100] hidden pt-20">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-3xl min-h-[75vh] max-h-[90vh] overflow-y-auto relative">
                <button id="close-list-modal" class="absolute top-4 right-4 text-gray-400 hover:text-muted-foreground z-10"><i class="fas fa-times text-xl"></i></button>
                <h3 id="list-modal-title" class="text-lg font-bold mb-4">Cr√©er une liste</h3>
                <form id="list-form" class="space-y-4 pb-20">
                    <input type="hidden" id="list-id">
                    <div>
                        <label for="list-name" class="block text-sm font-medium text-gray-700">Nom de la liste</label>
                        <input type="text" id="list-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                    </div>
                    <div>
                        <h4 class="text-md font-medium text-foreground mb-2">Ingr√©dients</h4>
                        <div id="ingredients-list" class="space-y-2"></div>
                        <button type="button" id="add-ingredient-btn" class="btn btn-outline btn-sm mt-2">
                            <i class="fas fa-plus mr-2"></i> Ajouter un ingr√©dient
                        </button>
                    </div>
                </form>
                <div class="absolute bottom-0 left-0 right-0 px-6 py-4 bg-white/95 backdrop-blur-sm border-t border-gray-200 flex justify-end space-x-4">
                    <button type="button" id="cancel-list-btn" class="text-gray-700 hover:bg-gray-100 px-4 py-2 rounded-md">Annuler</button>
                    <button type="submit" form="list-form" id="save-list-btn" class="btn btn-primary">Sauvegarder la liste</button>
                </div>
            </div>
        </div>
        `,script:"./lists.js"},friends:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-foreground">Mes Amis</h2>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="md:col-span-2 space-y-8">
                <div>
                    <h3 class="text-xl font-bold text-foreground mb-4">Liste d'amis</h3>
                    <div id="friends-list-container" class="space-y-4">
                        <!-- La liste d'amis sera charg√©e ici -->
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-foreground mb-4">Demandes envoy√©es en attente</h3>
                    <div id="pending-requests-container" class="space-y-4">
                        <!-- Les demandes envoy√©es en attente seront charg√©es ici -->
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-foreground mb-4">Demandes rejet√©es</h3>
                    <div id="declined-requests-container" class="space-y-4">
                        <!-- Les demandes rejet√©es seront charg√©es ici -->
                    </div>
                </div>
            </div>
            <div>
                <div class="bg-card text-card-foreground rounded-xl shadow-md border border-border p-6">
                    <h3 class="text-xl font-bold text-foreground mb-4">Rechercher un ami</h3>
                    <div class="mb-4">
                        <div class="flex items-center space-x-2">
                            <input type="text" id="search-friends-input" placeholder="Nom ou email..." class="flex-grow p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-tomato focus:border-tomato">
                            <button id="search-friends-btn" class="btn btn-primary"><i class="fas fa-search"></i></button>
                        </div>
                        <div id="search-results-container" class="mt-2 space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>
        `,script:"./friends.js"},shared:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-foreground">Mes Partages</h2>
        </div>

        <div class="space-y-12">
            <div>
                <h3 class="text-xl font-bold text-gray-700 border-b pb-2 mb-4">Partages Re√ßus</h3>
                <div id="received-shares-container" class="space-y-4">
                    <!-- L'historique des partages accept√©s sera charg√© ici -->
                </div>
            </div>
            <div>
                <h3 class="text-xl font-bold text-gray-700 border-b pb-2 mb-4">Mes Partages Envoy√©s</h3>
                <div id="sent-shares-container" class="space-y-4">
                    <!-- L'historique des partages envoy√©s sera charg√© ici -->
                </div>
            </div>
        </div>
        `,script:"./shared.js"},plans:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-foreground">Mes Plans Sauvegard√©s</h2>
        </div>
        <div id="all-plans-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- La liste des plans sera charg√©e ici -->
            <p class="text-center text-muted-foreground p-10 col-span-full">Chargement de vos plans...</p>
        </div>
        `,script:"./all-plans.js"},"view-plan":{html:`
        <section aria-labelledby="meal-planning-heading" class="mb-8 md:mb-12">
            <div class="flex justify-between items-center mb-4">
                <h2 id="plan-view-name" class="text-xl md:text-2xl font-bold text-foreground">Chargement du plan...</h2>
                <button id="close-view-plan-btn" class="btn btn-outline">
                    <i class="fas fa-times mr-2"></i> Fermer et voir mes plans
                </button>
            </div>
            <div class="bg-card text-card-foreground rounded-xl shadow-md border border-border p-4">
                <div id="meal-plan-grid-layout">
                    <!-- Header -->
                    <div class="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] gap-1 text-center mb-1">
                        <div class="p-2"></div> <!-- Empty corner -->
                        <div class="p-2 rounded-t-lg bg-amber-100 text-amber-800 font-bold col-span-6">MIDI</div>
                        <div class="p-2 rounded-t-lg bg-stone-200 text-stone-800 font-bold col-span-6">SOIR</div>
                        <div class="p-1"></div> <!-- Empty under day name -->
                        <div class="p-1 text-xs font-semibold"><i class="fas fa-users"></i></div>
                        <div class="p-1 text-xs font-semibold text-muted-foreground">Entr√©e</div>
                        <div class="p-1 text-xs font-semibold text-muted-foreground">Plat</div>
                        <div class="p-1 text-xs font-semibold text-muted-foreground">Accomp.</div>
                        <div class="p-1 text-xs font-semibold text-muted-foreground">Dessert</div>
                        <div class="p-1 text-xs font-semibold text-muted-foreground">Remarque</div>
                        <div class="p-1 text-xs font-semibold"><i class="fas fa-users"></i></div>
                        <div class="p-1 text-xs font-semibold text-muted-foreground">Entr√©e</div>
                        <div class="p-1 text-xs font-semibold text-muted-foreground">Plat</div>
                        <div class="p-1 text-xs font-semibold text-muted-foreground">Accomp.</div>
                        <div class="p-1 text-xs font-semibold text-muted-foreground">Dessert</div>
                        <div class="p-1 text-xs font-semibold text-muted-foreground">Remarque</div>
                    </div>
                    <!-- Rows generated by JS -->
                    <div id="meal-plan-grid" class="space-y-1">
                        <div class="p-10 text-center text-muted-foreground italic col-span-full">Chargement de la planification...</div>
                    </div>
                </div>
            </div>
        </section>
        `,script:"./view-plan.js"},"shopping-mode":{html:`
        <div class="max-w-4xl mx-auto min-h-screen pb-20 md:pb-0 relative px-4">
            <div class="sticky top-0 bg-background z-20 pt-4 pb-3">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center space-x-3">
                        <button id="shopping-mode-back-btn" class="text-muted-foreground hover:text-tomato">
                            <i class="fas fa-arrow-left text-xl"></i>
                        </button>
                        <h2 class="text-2xl font-bold text-foreground">Faire les courses</h2>
                    </div>
                    <button id="shopping-mode-trash-btn" class="text-muted-foreground hover:text-gray-700 relative hidden p-2">
                        <i class="fas fa-trash-alt text-lg"></i>
                        <span id="shopping-mode-trash-count" class="absolute top-0 right-0 bg-red-500 text-white text-[10px] px-1 rounded-full">0</span>
                    </button>
                </div>
                <div class="flex justify-start items-center mb-4">
                    <label for="shopping-mode-plan-select" class="text-sm font-medium text-gray-700 mr-2">Plan:</label>
                    <select id="shopping-mode-plan-select" class="text-sm border-gray-300 rounded-md shadow-sm focus:ring-tomato focus:border-tomato font-medium text-gray-700 bg-white pr-8">
                        <option>Chargement...</option>
                    </select>
                </div>
            </div>
            
            <div id="shopping-mode-container" class="p-4 -mt-4">
                <p class="text-center text-muted-foreground mt-10">Chargement de la liste...</p>
            </div>

            <!-- Shopping Mode Trash Modal -->
            <div id="shopping-trash-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden" role="dialog">
                <div class="bg-white rounded-xl p-5 w-11/12 max-w-md relative max-h-[80vh] flex flex-col">
                    <button id="close-shopping-trash-modal" class="absolute top-3 right-3 text-gray-400 hover:text-muted-foreground p-2">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                    <div class="flex justify-between items-center mb-4 pr-8">
                        <h3 class="text-lg font-bold text-foreground"><i class="fas fa-trash-alt mr-2"></i> Corbeille</h3>
                        <button id="shopping-empty-trash-btn" class="text-sm text-red-500 hover:text-red-700 font-medium hover:underline hidden">
                            Vider
                        </button>
                    </div>
                    <div id="shopping-trash-list" class="flex-grow overflow-y-auto pr-1">
                        <!-- Deleted items will be generated here -->
                    </div>
                </div>
            </div>
        </div>
        `,script:"./shopping-mode.js"}},Ja=Object.assign({"./all-plans.js":Xn,"./auth.js":Jn,"./firebase-config.js":Wn,"./form-handler.js":Zn,"./friends.js":oa,"./ingredients.js":la,"./lists.js":ma,"./main.js":Ba,"./notifications.js":Ia,"./plans.js":ba,"./presence.js":Ma,"./recipes.js":Na,"./script.js":_a,"./shared.js":qa,"./sharing.js":ca,"./shopping-mode.js":Oa,"./view-plan.js":Qa});let It=null;async function Ve(e){typeof It=="function"&&(It(),It=null);const t=Wa[e];if(t&&fn){if(fn.innerHTML=t.html,t.script){const n=Ja[t.script];n?n.default&&typeof n.default=="function"&&(It=n.default()):console.error(`Module not found for path: ${t.script}`)}}else console.error(`Route not found: ${e}`)}function Ga(){const e=Re();if(e){const n=document.getElementById("user-display-name");n&&(n.textContent=e.displayName||e.email)}const t=document.querySelectorAll(".nav-btn");t.forEach(n=>{n.addEventListener("click",a=>{const o=a.currentTarget.dataset.path;Ve(o),t.forEach(r=>{r.classList.remove("bg-tomato","text-white"),r.classList.add("bg-white","text-tomato")}),a.currentTarget.classList.add("bg-tomato","text-white"),a.currentTarget.classList.remove("bg-white","text-tomato")})}),Ve("menu"),Zt()}document.addEventListener("DOMContentLoaded",()=>{Gt().then(m=>{m&&Ga()});const e=document.getElementById("profile-btn"),t=document.getElementById("profile-menu");e&&t&&(e.addEventListener("click",m=>{m.stopPropagation(),t.classList.toggle("hidden");const M=!t.classList.contains("hidden");e.setAttribute("aria-expanded",M)}),document.addEventListener("click",m=>{!(t.contains(m.target)||e.contains(m.target))&&!t.classList.contains("hidden")&&(t.classList.add("hidden"),e.setAttribute("aria-expanded","false"))}));const n=document.getElementById("settings-link"),a=document.getElementById("settings-modal"),o=document.getElementById("close-settings-modal"),r=document.getElementById("dark-mode-toggle"),d=m=>{m==="dark"?(document.documentElement.classList.add("dark"),r&&(r.checked=!0)):(document.documentElement.classList.remove("dark"),r&&(r.checked=!1))},h=localStorage.getItem("theme");h?d(h):window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?d("dark"):d("light"),n&&a&&n.addEventListener("click",m=>{m.preventDefault(),a.classList.remove("hidden")}),o&&a&&o.addEventListener("click",()=>{a.classList.add("hidden")}),a&&a.addEventListener("click",m=>{m.target===a&&a.classList.add("hidden")}),r&&r.addEventListener("change",()=>{const m=r.checked?"dark":"light";localStorage.setItem("theme",m),d(m)});const x=document.getElementById("mobile-menu-btn"),g=document.getElementById("mobile-menu");let c=null;x&&g?(console.log("Mobile menu initialized (Overlay Mode)"),x.addEventListener("click",m=>{m.stopPropagation(),c?(c.remove(),c=null):(c=document.createElement("div"),c.id="mobile-menu-overlay-container",c.innerHTML=g.innerHTML,Object.assign(c.style,{position:"fixed",top:"60px",left:"0",width:"100%",backgroundColor:"#3D405B",zIndex:"10000",boxShadow:"0 4px 6px rgba(0,0,0,0.1)",padding:"1rem",display:"block"}),c.addEventListener("click",M=>{const N=M.target.closest("button");if(!N)return;const i=N.dataset.path;if(i)console.log("Overlay: Navigating directly to",i),Ve(i);else if(N.id==="profile-btn-mobile")console.log("Overlay: Opening settings"),a&&a.classList.remove("hidden");else{let S=null;N.id&&(S=document.getElementById(N.id)),S?(console.log("Overlay: Delegating click to original:",S),S.click()):console.warn("Overlay: No action found for",N)}c&&(c.remove(),c=null)}),document.body.appendChild(c))}),document.addEventListener("click",m=>{c&&!c.contains(m.target)&&!x.contains(m.target)&&(c.remove(),c=null)})):console.warn("Mobile menu elements missing");const L=document.getElementById("profile-btn-mobile");L&&a&&L.addEventListener("click",()=>{a.classList.remove("hidden")}),mobileNavButtons.forEach(m=>{m.addEventListener("click",M=>{const N=M.currentTarget.dataset.path;Ve(N)})})});
