const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/main-DOZ5ZINl.js","assets/firebase-config-CPJ13vib.js","assets/firebase-config-DVv8XtdB.css"])))=>i.map(i=>d[i]);
import{_ as G,g as Z,b as ce}from"./main-DOZ5ZINl.js";import{b as O,o as ie,g as X,c as ee,k as le,j as de}from"./firebase-config-CPJ13vib.js";const T=le();let A=null,C=null,te=[],ne=[],H={},Q=[];const ue={"fruits & légumes":"fa-carrot","produits laitiers":"fa-cheese",fromagerie:"fa-cheese",boucherie:"fa-drumstick-bite",viande:"fa-drumstick-bite",poissonnerie:"fa-fish",poisson:"fa-fish",épicerie:"fa-box",boissons:"fa-wine-glass",boulangerie:"fa-bread-slice",pain:"fa-bread-slice",dph:"fa-soap",hygiène:"fa-soap",surgelés:"fa-snowflake",entrée:"fa-utensils",plat:"fa-concierge-bell",accompagnement:"fa-plate-wheat",dessert:"fa-ice-cream",inconnue:"fa-question"};function R(x){return x?x.replace(/\./g,"_"):""}function he(){let x=document.getElementById("shopping-mode-container");const q=document.getElementById("shopping-mode-plan-select"),Y=document.getElementById("shopping-mode-trash-btn"),F=document.getElementById("shopping-trash-modal");let V=null;function J(r){console.log(`[DEBUG] updateTrashUI called with ${r?r.length:"null"} items`);const o=document.getElementById("shopping-mode-trash-btn"),n=document.getElementById("shopping-mode-trash-count"),p=document.getElementById("shopping-trash-modal"),f=document.getElementById("shopping-trash-list"),y=document.getElementById("close-shopping-trash-modal"),u=document.getElementById("shopping-empty-trash-btn");if(o&&(r&&r.length>0?(o.classList.remove("hidden"),n&&(n.textContent=r.length)):(o.classList.add("hidden"),n&&(n.textContent="0"))),p&&y&&(y.onclick=()=>p.classList.add("hidden"),p.onclick=s=>{s.target===p&&p.classList.add("hidden")}),r&&r.length>0){if(u){u.classList.remove("hidden");const s=u.cloneNode(!0);u.parentNode.replaceChild(s,u),s.addEventListener("click",async()=>{if(!C||!confirm("Tout supprimer définitivement ?"))return;const h=O(T,"plans",C.id),g=r.map(v=>R(`${v.name}_${v.unit||""}`));try{await G(()=>import("./main-DOZ5ZINl.js").then(v=>v.l),__vite__mapDeps([0,1,2])).then(v=>{v.updateDoc(h,{hiddenTrashItems:v.arrayUnion(...g),lastUpdated:new Date})}),p.classList.add("hidden")}catch(v){console.error("Erreur vidage corbeille:",v)}})}if(f){f.innerHTML="";const s=document.createElement("ul");s.className="space-y-3",r.forEach(h=>{const g=document.createElement("li");g.className="flex items-center p-3 rounded-lg bg-gray-100 shadow-inner justify-between";const v=document.createElement("div");v.className="flex-grow ml-2 overflow-hidden";const M=document.createElement("span");M.className="font-medium text-base text-gray-500 line-through block truncate",M.textContent=h.name,v.appendChild(M);const e=document.createElement("div");e.className="flex items-center space-x-2 flex-shrink-0";const t=document.createElement("button");t.className="text-blue-600 hover:text-blue-800 font-medium text-sm px-3 py-1 border border-blue-300 rounded-full hover:bg-blue-50 transition-colors",t.innerHTML='<i class="fas fa-undo"></i>',t.addEventListener("click",async()=>{if(!C)return;const a=O(T,"plans",C.id);try{await G(()=>import("./main-DOZ5ZINl.js").then(i=>i.l),__vite__mapDeps([0,1,2])).then(async i=>{await i.runTransaction(T,async l=>{const m=await l.get(a);if(!m.exists())return;const d=(m.data().manualItems||[]).filter($=>!($.name.toLowerCase()===h.name.toLowerCase()&&$.unit===h.unit));l.update(a,{manualItems:d,lastUpdated:new Date})}),r.length<=1&&p.classList.add("hidden")})}catch(i){console.error(i)}});const c=document.createElement("button");c.className="text-gray-400 hover:text-red-600 font-medium text-sm px-2 py-1",c.innerHTML='<i class="fas fa-times text-lg"></i>',c.addEventListener("click",async()=>{if(!C)return;const a=O(T,"plans",C.id),i=R(`${h.name}_${h.unit||""}`);try{await G(()=>import("./main-DOZ5ZINl.js").then(l=>l.l),__vite__mapDeps([0,1,2])).then(l=>{l.updateDoc(a,{hiddenTrashItems:l.arrayUnion(i),lastUpdated:new Date})}),r.length<=1&&p.classList.add("hidden")}catch(l){console.error(l)}}),e.appendChild(t),e.appendChild(c),g.appendChild(v),g.appendChild(e),s.appendChild(g)}),f.appendChild(s)}}else f&&(f.innerHTML='<p class="text-center text-gray-500 italic py-4">La corbeille est vide.</p>'),u&&u.classList.add("hidden")}function ae(){console.log("[DEBUG] Resetting UI and State"),C=null,x&&(x.innerHTML='<div class="flex justify-center p-10"><i class="fas fa-spinner fa-spin text-tomato text-2xl"></i></div>'),F&&F.classList.add("hidden"),J([])}Y&&F&&Y.addEventListener("click",()=>{F.classList.remove("hidden")});function j(r){console.log(`[DEBUG] loadPlan called for: ${r}`),V=r,A&&(console.log("[DEBUG] Unsubscribing from previous plan"),A(),A=null),ae();const o=O(T,"plans",r);A=ie(o,n=>{if(console.log(`[DEBUG] Snapshot received for doc: ${n.id}`),V!==r){console.warn(`[DEBUG] Ignored snapshot for ${r} because active is ${V}`);return}n.exists()?(console.log(`[DEBUG] Plan data found for ID: ${n.id}`),C={id:n.id,...n.data()},H=C.checkedItems||{},W()):(console.log("[DEBUG] Plan not found"),x&&(x.innerHTML='<p class="text-center p-4 text-red-500">Menu introuvable.</p>'))})}function W(){if(!C||!x){console.log("[DEBUG] renderShoppingList aborted: missing plan or container");return}console.log(`[DEBUG] Rendering shopping list for menu: ${C.name} (${C.id})`);const{active:r,deleted:o}=se(C);console.log(`[DEBUG] Computed deletedItems: ${o.length} items`),J(o),x.innerHTML="";const n=[],p=[];if(r.forEach(e=>{const t=`${e.name}_${e.unit||""}`,c=R(t);(H.hasOwnProperty(c)?H[c]:H[t]||!1)?p.push(e):n.push(e)}),n.length===0&&p.length===0){x.innerHTML='<p class="text-center p-10 text-gray-500">Votre liste de courses est vide pour ce menu.</p>';return}const f=n.reduce((e,t)=>{const c=t.category||"Inconnue";return e[c]||(e[c]=[]),e[c].push(t),e},{}),y=Object.keys(f).sort((e,t)=>{if(Q&&Q.length>0){const c=Q.indexOf(e),a=Q.indexOf(t);if(c!==-1&&a!==-1)return c-a;if(c!==-1)return-1;if(a!==-1)return 1}return e==="Inconnue"?1:t==="Inconnue"?-1:e.localeCompare(t)}),u=document.createElement("div");u.className="sticky top-0 z-30 glass-header px-4 mb-4";const s=document.createElement("div");s.id="shopping-category-tabs",s.className="flex overflow-x-auto space-x-3 py-3 items-center",u.appendChild(s),x.appendChild(u);const h=e=>"category-"+e.replace(/[^a-zA-Z0-9]/g,"-").toLowerCase(),g={};y.forEach(e=>{const t=document.createElement("button");t.className="category-tab btn-outline flex-shrink-0";const c=ue[e.toLowerCase()]||"fa-tag";t.innerHTML=`<i class="fas ${c}"></i> <span>${e}</span>`,t.onclick=()=>{const a=document.getElementById(h(e));if(a){const i=document.querySelector("header"),l=i?i.offsetHeight:0,m=u.offsetHeight,d=a.getBoundingClientRect().top+window.pageYOffset-l-m-10;window.scrollTo({top:d,behavior:"smooth"})}},s.appendChild(t),g[e]=t,t.dataset.categoryName=e}),window.Sortable&&new Sortable(s,{animation:150,ghostClass:"opacity-50",onEnd:async()=>{const e=Array.from(s.querySelectorAll(".category-tab")).map(c=>c.dataset.categoryName);console.log("[DEBUG] New category order:",e),Q=e;const t=Z();if(t){const c=O(T,"users",t);try{await G(()=>import("./main-DOZ5ZINl.js").then(a=>a.l),__vite__mapDeps([0,1,2])).then(a=>{a.updateDoc(c,{shoppingCategoryOrder:e,lastUpdated:new Date})})}catch(a){console.error("Error saving category order",a)}}W()}});const v={root:null,rootMargin:"-10% 0px -80% 0px",threshold:0},M=new IntersectionObserver(e=>{e.forEach(t=>{if(t.isIntersecting){const c=t.target.dataset.categoryName;Object.values(g).forEach(i=>i.classList.remove("category-tab-active"));const a=g[c];a&&(a.classList.add("category-tab-active"),a.scrollIntoView({behavior:"smooth",block:"nearest",inline:"center"}))}})},v);if(y.forEach(e=>{const t=document.createElement("h3");t.className="font-bold text-lg text-gray-700 mt-6 mb-3 border-b border-gray-200 pb-1 scroll-mt-24",t.textContent=e,t.id=h(e),t.dataset.categoryName=e,x.appendChild(t),M.observe(t);const c=document.createElement("ul");c.className="space-y-3",f[e].sort((a,i)=>a.name.localeCompare(i.name)).forEach(a=>{const i=`${a.name}_${a.unit||""}`,l=R(i),m=H.hasOwnProperty(l)?H[l]:H[i]||!1,b=a.hasManualEntry===!0||!a.sources||a.sources.length===0,d=document.createElement("li");b&&(d.dataset.isManual="true",d.style.backgroundColor="#ffedd5");const $=m?"bg-gray-100":b?"bg-orange-100 shadow-sm border border-orange-200":"bg-white shadow-sm border border-gray-100";d.className=`flex flex-col p-3 rounded-lg transition-colors duration-200 ${$}`;const U=document.createElement("div");U.className="flex items-center w-full";const L=document.createElement("input");L.type="checkbox",L.className="form-checkbox h-6 w-6 text-tomato rounded-full border-gray-300 focus:ring-tomato cursor-pointer transition duration-150 ease-in-out",L.checked=m;const N=document.createElement("div");N.className="ml-3 flex-grow cursor-pointer select-none";const D=Number.isInteger(a.totalQuantity)?a.totalQuantity:parseFloat(a.totalQuantity.toFixed(2)),E=document.createElement("span");E.className=`font-medium text-base ${m?"line-through text-gray-400":"text-gray-800"}`,E.textContent=a.name;const w=document.createElement("span");w.className=`ml-2 font-bold text-base ${m?"text-gray-400":"text-gray-800"}`,w.textContent=` - ${D} ${a.unit||""}`.trim(),N.appendChild(E),N.appendChild(w);const _=()=>{const k=!L.checked;L.checked=k,z(l,k,d,L,E,w)};if(L.addEventListener("change",k=>{z(l,k.target.checked,d,L,E,w)}),N.addEventListener("click",_),U.appendChild(L),U.appendChild(N),d.appendChild(U),a.sources&&a.sources.length>0){const k=document.createElement("div");k.className="mt-2 ml-9 text-xs text-gray-500 space-y-1";const S=a.sources.reduce((P,I)=>{const re=I.servings?` - ${I.servings} pers.`:"",K=`${I.recipeName} (${I.day} ${I.time})${re}`;return P[K]||(P[K]=0),P[K]+=I.quantity,P},{});for(const P in S){const I=document.createElement("div");I.textContent=`↳ ${P}`,k.appendChild(I)}d.appendChild(k)}c.appendChild(d)}),x.appendChild(c)}),p.length>0){const e=document.createElement("div");e.className="my-8 border-t-2 border-dashed border-gray-300 pt-4 text-center";const t=document.createElement("h3");t.className="text-lg font-semibold text-gray-500",t.textContent="Articles cochés",e.appendChild(t),x.appendChild(e);const c=p.reduce((i,l)=>{const m=l.category||"Inconnue";return i[m]||(i[m]=[]),i[m].push(l),i},{});Object.keys(c).sort((i,l)=>i==="Inconnue"?1:l==="Inconnue"?-1:i.localeCompare(l)).forEach(i=>{const l=document.createElement("h3");l.className="font-bold text-lg text-gray-700 mt-6 mb-3 border-b border-gray-200 pb-1",l.textContent=i,x.appendChild(l);const m=document.createElement("ul");m.className="space-y-3",c[i].sort((b,d)=>b.name.localeCompare(d.name)).forEach(b=>{const d=`${b.name}_${b.unit||""}`,$=R(d),U=!0,L=b.hasManualEntry===!0||!b.sources||b.sources.length===0,N=document.createElement("li");L&&(N.dataset.isManual="true"),N.className="flex flex-col p-3 rounded-lg transition-colors duration-200 bg-gray-100";const D=document.createElement("div");D.className="flex items-center w-full";const E=document.createElement("input");E.type="checkbox",E.className="form-checkbox h-6 w-6 text-tomato rounded-full border-gray-300 focus:ring-tomato cursor-pointer transition duration-150 ease-in-out",E.checked=U;const w=document.createElement("div");w.className="ml-3 flex-grow cursor-pointer select-none";const _=Number.isInteger(b.totalQuantity)?b.totalQuantity:parseFloat(b.totalQuantity.toFixed(2)),k=document.createElement("span");k.className="font-medium text-base line-through text-gray-400",k.textContent=b.name;const S=document.createElement("span");S.className="ml-2 font-bold text-base text-gray-400",S.textContent=` - ${_} ${b.unit||""}`.trim(),w.appendChild(k),w.appendChild(S);const P=()=>{const I=!E.checked;E.checked=I,z($,I,N,E,k,S)};E.addEventListener("change",I=>{z($,I.target.checked,N,E,k,S)}),w.addEventListener("click",P),D.appendChild(E),D.appendChild(w),N.appendChild(D),m.appendChild(N)}),x.appendChild(m)})}}function z(r,o,n,p,f,y){if(!C)return;const u=n.dataset.isManual==="true";o?(n.classList.remove("bg-white","bg-orange-100","shadow-sm","border","border-gray-100","border-orange-200"),n.classList.add("bg-gray-100"),n.style.backgroundColor="",f.classList.add("line-through","text-gray-400"),f.classList.remove("text-gray-800"),y.classList.add("text-gray-400"),y.classList.remove("text-gray-800")):(n.classList.remove("bg-gray-100"),u?(n.classList.add("bg-orange-100","shadow-sm","border","border-orange-200"),n.style.backgroundColor="#ffedd5"):(n.classList.add("bg-white","shadow-sm","border","border-gray-100"),n.style.backgroundColor=""),f.classList.remove("line-through","text-gray-400"),f.classList.add("text-gray-800"),y.classList.remove("text-gray-400"),y.classList.add("text-gray-800"));const s=O(T,"plans",C.id),h={};h[`checkedItems.${r}`]=o,h.lastUpdated=new Date,G(()=>import("./main-DOZ5ZINl.js").then(g=>g.l),__vite__mapDeps([0,1,2])).then(g=>{g.updateDoc(s,h)}).catch(g=>{console.error("Error updating checked item:",g)})}function se(r){const o=new Map;(r.manualItems||[]).forEach(s=>{const h=`${s.name.trim().toLowerCase()}_${s.unit||""}`;o.set(h,{name:s.name.trim(),totalQuantity:s.totalQuantity,unit:s.unit,category:s.category||"Inconnue",hasManualEntry:!0})});const p=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];if(r.weeks)for(const s in r.weeks){const h=r.weeks[s],g=h.menuData||{},v=h.servingsData||{};for(const M in g){const e=g[M];if(!Array.isArray(e))continue;const[t,c]=M.split("-"),a=`${t}-${c}`,i=parseInt(v[a]||r.defaultNumPeople||1,10);e.forEach(l=>{const m=te.find(d=>d.id===l.id)||l;if(!m||!m.ingredients)return;const b=m.servings||1;m.ingredients.forEach(d=>{if(!d.name||!d.quantity)return;const $=ne.find(_=>_.name.toLowerCase()===d.name.toLowerCase()),U=$?$.category:"Inconnue",L=parseFloat(String(d.quantity).replace(",","."));if(isNaN(L))return;const D=L/b*i,E=d.unit||"",w=`${d.name.trim().toLowerCase()}_${E}`;if(o.has(w)){const _=o.get(w);_.totalQuantity+=D,_.sources||(_.sources=[]),_.sources.push({recipeName:m.name,day:p[parseInt(t,10)],time:c==="lunch"?"Midi":"Soir",quantity:D,servings:i})}else o.set(w,{name:d.name.trim(),totalQuantity:D,unit:E,category:U,sources:[{recipeName:m.name,day:p[parseInt(t,10)],time:c==="lunch"?"Midi":"Soir",quantity:D,servings:i}]})})})}}const f=[],y=[],u=r.hiddenTrashItems||[];return o.forEach(s=>{if(s.totalQuantity>0)f.push(s);else if(s.totalQuantity<=0&&s.sources&&s.sources.length>0){const h=`${s.name}_${s.unit||""}`,g=R(h);!u.includes(g)&&!u.includes(h)&&y.push(s)}}),{active:f,deleted:y}}const B=document.createElement("button");if(B.id="scroll-to-top-btn",B.className="hidden fixed bottom-20 right-5 bg-tomato text-white rounded-full w-12 h-12 shadow-lg z-50",B.innerHTML='<i class="fas fa-arrow-up"></i>',document.body.appendChild(B),window.addEventListener("scroll",()=>{window.pageYOffset>200?B.classList.remove("hidden"):B.classList.add("hidden")}),B.addEventListener("click",()=>{window.scrollTo({top:0,behavior:"smooth"})}),q){const r=q.cloneNode(!0);q.parentNode.replaceChild(r,q),r.addEventListener("change",o=>{const n=o.target.value;localStorage.setItem("lastActivePlanId",n),j(n)})}async function oe(){const r=Z();if(r)try{const o=await de(O(T,"users",r));o.exists()&&(Q=o.data().shoppingCategoryOrder||[])}catch(o){console.error("Error fetching user preferences",o)}try{ne=(await X(ee(T,"ingredients"))).docs.map(n=>({id:n.id,...n.data()}))}catch(o){console.error("Error fetching ingredients",o)}try{te=(await X(ee(T,"recipes"))).docs.map(n=>({id:n.id,...n.data()}))}catch(o){console.error("Error fetching recipes",o)}ce(o=>{const n=document.getElementById("shopping-mode-plan-select");if(!n)return;const p=n.value;if(n.innerHTML="",o.length===0){x&&(x.innerHTML='<p class="text-center p-4">Aucun menu trouvé.</p>');return}o.forEach(u=>{const s=document.createElement("option");s.value=u.id,s.textContent=u.name,n.appendChild(s)});const f=localStorage.getItem("lastActivePlanId");let y=null;f&&o.some(u=>u.id===f)?y=f:o.length>0&&(y=o[0].id),y&&(p&&o.some(u=>u.id===p)?(n.value=p,C||j(p)):(n.value=y,j(y)))})}return oe(),()=>{A&&A(),B&&B.remove()}}export{he as default};
