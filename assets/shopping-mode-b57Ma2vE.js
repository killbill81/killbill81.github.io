const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/main-CHmAcSO8.js","assets/firebase-config-CDPbqvnt.js","assets/login-DXK05PeN.css"])))=>i.map(i=>d[i]);
import{_ as G,a as ee}from"./main-CHmAcSO8.js";import{a as U,o as te,g as V,c as K,i as ne}from"./firebase-config-CDPbqvnt.js";const _=ne();let M=null,w=null,j=[],Y=[],T={};function P(E){return E?E.replace(/\./g,"_"):""}function se(){let E=document.getElementById("shopping-mode-container");const S=document.getElementById("shopping-mode-plan-select"),F=document.getElementById("shopping-mode-trash-btn"),H=document.getElementById("shopping-trash-modal");let O=null;function q(t){console.log(`[DEBUG] updateTrashUI called with ${t?t.length:"null"} items`);const o=document.getElementById("shopping-mode-trash-btn"),a=document.getElementById("shopping-mode-trash-count"),g=document.getElementById("shopping-trash-modal"),m=document.getElementById("shopping-trash-list"),y=document.getElementById("close-shopping-trash-modal"),f=document.getElementById("shopping-empty-trash-btn");if(o&&(t&&t.length>0?(o.classList.remove("hidden"),a&&(a.textContent=t.length)):(o.classList.add("hidden"),a&&(a.textContent="0"))),g&&y&&(y.onclick=()=>g.classList.add("hidden"),g.onclick=r=>{r.target===g&&g.classList.add("hidden")}),t&&t.length>0){if(f){f.classList.remove("hidden");const r=f.cloneNode(!0);f.parentNode.replaceChild(r,f),r.addEventListener("click",async()=>{if(!w||!confirm("Tout supprimer définitivement ?"))return;const e=U(_,"plans",w.id),n=t.map(s=>P(`${s.name}_${s.unit||""}`));try{await G(()=>import("./main-CHmAcSO8.js").then(s=>s.d),__vite__mapDeps([0,1,2])).then(s=>{s.updateDoc(e,{hiddenTrashItems:s.arrayUnion(...n),lastUpdated:new Date})}),g.classList.add("hidden")}catch(s){console.error("Erreur vidage corbeille:",s)}})}if(m){m.innerHTML="";const r=document.createElement("ul");r.className="space-y-3",t.forEach(e=>{const n=document.createElement("li");n.className="flex items-center p-3 rounded-lg bg-gray-100 shadow-inner justify-between";const s=document.createElement("div");s.className="flex-grow ml-2 overflow-hidden";const c=document.createElement("span");c.className="font-medium text-base text-gray-500 line-through block truncate",c.textContent=e.name,s.appendChild(c);const i=document.createElement("div");i.className="flex items-center space-x-2 flex-shrink-0";const l=document.createElement("button");l.className="text-blue-600 hover:text-blue-800 font-medium text-sm px-3 py-1 border border-blue-300 rounded-full hover:bg-blue-50 transition-colors",l.innerHTML='<i class="fas fa-undo"></i>',l.addEventListener("click",async()=>{if(!w)return;const p=U(_,"plans",w.id);try{await G(()=>import("./main-CHmAcSO8.js").then(h=>h.d),__vite__mapDeps([0,1,2])).then(async h=>{await h.runTransaction(_,async v=>{const L=await v.get(p);if(!L.exists())return;const d=(L.data().manualItems||[]).filter(N=>!(N.name.toLowerCase()===e.name.toLowerCase()&&N.unit===e.unit));v.update(p,{manualItems:d,lastUpdated:new Date})}),t.length<=1&&g.classList.add("hidden")})}catch(h){console.error(h)}});const u=document.createElement("button");u.className="text-gray-400 hover:text-red-600 font-medium text-sm px-2 py-1",u.innerHTML='<i class="fas fa-times text-lg"></i>',u.addEventListener("click",async()=>{if(!w)return;const p=U(_,"plans",w.id),h=P(`${e.name}_${e.unit||""}`);try{await G(()=>import("./main-CHmAcSO8.js").then(v=>v.d),__vite__mapDeps([0,1,2])).then(v=>{v.updateDoc(p,{hiddenTrashItems:v.arrayUnion(h),lastUpdated:new Date})}),t.length<=1&&g.classList.add("hidden")}catch(v){console.error(v)}}),i.appendChild(l),i.appendChild(u),n.appendChild(s),n.appendChild(i),r.appendChild(n)}),m.appendChild(r)}}else m&&(m.innerHTML='<p class="text-center text-gray-500 italic py-4">La corbeille est vide.</p>'),f&&f.classList.add("hidden")}function J(){console.log("[DEBUG] Resetting UI and State"),w=null,E&&(E.innerHTML='<div class="flex justify-center p-10"><i class="fas fa-spinner fa-spin text-tomato text-2xl"></i></div>'),H&&H.classList.add("hidden"),q([])}F&&H&&F.addEventListener("click",()=>{H.classList.remove("hidden")});function R(t){console.log(`[DEBUG] loadPlan called for: ${t}`),O=t,M&&(console.log("[DEBUG] Unsubscribing from previous plan"),M(),M=null),J();const o=U(_,"plans",t);M=te(o,a=>{if(console.log(`[DEBUG] Snapshot received for doc: ${a.id}`),O!==t){console.warn(`[DEBUG] Ignored snapshot for ${t} because active is ${O}`);return}a.exists()?(console.log(`[DEBUG] Plan data found for ID: ${a.id}`),w={id:a.id,...a.data()},T=w.checkedItems||{},Z()):(console.log("[DEBUG] Plan not found"),E&&(E.innerHTML='<p class="text-center p-4 text-red-500">Plan introuvable.</p>'))})}function Z(){if(!w||!E){console.log("[DEBUG] renderShoppingList aborted: missing plan or container");return}console.log(`[DEBUG] Rendering shopping list for plan: ${w.name} (${w.id})`);const{active:t,deleted:o}=W(w);console.log(`[DEBUG] Computed deletedItems: ${o.length} items`),q(o),E.innerHTML="";const a=[],g=[];if(t.forEach(e=>{const n=`${e.name}_${e.unit||""}`,s=P(n);(T.hasOwnProperty(s)?T[s]:T[n]||!1)?g.push(e):a.push(e)}),a.length===0&&g.length===0){E.innerHTML='<p class="text-center p-10 text-gray-500">Votre liste de courses est vide pour ce plan.</p>';return}const m=a.reduce((e,n)=>{const s=n.category||"Inconnue";return e[s]||(e[s]=[]),e[s].push(n),e},{}),y=Object.keys(m).sort((e,n)=>e==="Inconnue"?1:n==="Inconnue"?-1:e.localeCompare(n)),f=document.createElement("div");f.id="shopping-category-tabs",f.className="flex overflow-x-auto space-x-2 py-2 bg-white z-20 mb-4",E.appendChild(f);const r=e=>"category-"+e.replace(/[^a-zA-Z0-9]/g,"-").toLowerCase();if(y.forEach(e=>{const n=document.createElement("button");n.className="btn btn-sm btn-outline flex-shrink-0",n.textContent=e,n.onclick=()=>{const s=document.getElementById(r(e));if(s){const c=document.querySelector("header"),i=c?c.offsetHeight:0,u=s.getBoundingClientRect().top+window.pageYOffset-i-40;window.scrollTo({top:u,behavior:"smooth"})}},f.appendChild(n)}),y.forEach(e=>{const n=document.createElement("h3");n.className="font-bold text-lg text-gray-700 mt-6 mb-3 border-b border-gray-200 pb-1 sticky top-0 bg-white z-10",n.textContent=e,n.id=r(e),E.appendChild(n);const s=document.createElement("ul");s.className="space-y-3",m[e].sort((c,i)=>c.name.localeCompare(i.name)).forEach(c=>{const i=`${c.name}_${c.unit||""}`,l=P(i),u=T.hasOwnProperty(l)?T[l]:T[i]||!1,p=c.hasManualEntry===!0||!c.sources||c.sources.length===0,h=document.createElement("li");p&&(h.dataset.isManual="true",h.style.backgroundColor="#ffedd5");const v=u?"bg-gray-100":p?"bg-orange-100 shadow-sm border border-orange-200":"bg-white shadow-sm border border-gray-100";h.className=`flex flex-col p-3 rounded-lg transition-colors duration-200 ${v}`;const L=document.createElement("div");L.className="flex items-center w-full";const k=document.createElement("input");k.type="checkbox",k.className="form-checkbox h-6 w-6 text-tomato rounded-full border-gray-300 focus:ring-tomato cursor-pointer transition duration-150 ease-in-out",k.checked=u;const d=document.createElement("div");d.className="ml-3 flex-grow cursor-pointer select-none";const N=Number.isInteger(c.totalQuantity)?c.totalQuantity:parseFloat(c.totalQuantity.toFixed(2)),C=document.createElement("span");C.className=`font-medium text-base ${u?"line-through text-gray-400":"text-gray-800"}`,C.textContent=c.name;const I=document.createElement("span");I.className=`ml-2 font-bold text-base ${u?"text-gray-400":"text-gray-800"}`,I.textContent=` - ${N} ${c.unit||""}`.trim(),d.appendChild(C),d.appendChild(I);const A=()=>{const b=!k.checked;k.checked=b,Q(l,b,h,k,C,I)};if(k.addEventListener("change",b=>{Q(l,b.target.checked,h,k,C,I)}),d.addEventListener("click",A),L.appendChild(k),L.appendChild(d),h.appendChild(L),c.sources&&c.sources.length>0){const b=document.createElement("div");b.className="mt-2 ml-9 text-xs text-gray-500 space-y-1";const $=c.sources.reduce((D,x)=>{const z=`${x.recipeName} (${x.day} ${x.time})`;return D[z]||(D[z]=0),D[z]+=x.quantity,D},{});for(const D in $){const x=document.createElement("div");x.textContent=`↳ ${D}`,b.appendChild(x)}h.appendChild(b)}s.appendChild(h)}),E.appendChild(s)}),g.length>0){const e=document.createElement("div");e.className="my-8 border-t-2 border-dashed border-gray-300 pt-4 text-center";const n=document.createElement("h3");n.className="text-lg font-semibold text-gray-500",n.textContent="Articles cochés",e.appendChild(n),E.appendChild(e);const s=g.reduce((i,l)=>{const u=l.category||"Inconnue";return i[u]||(i[u]=[]),i[u].push(l),i},{});Object.keys(s).sort((i,l)=>i==="Inconnue"?1:l==="Inconnue"?-1:i.localeCompare(l)).forEach(i=>{const l=document.createElement("h3");l.className="font-bold text-lg text-gray-700 mt-6 mb-3 border-b border-gray-200 pb-1",l.textContent=i,E.appendChild(l);const u=document.createElement("ul");u.className="space-y-3",s[i].sort((p,h)=>p.name.localeCompare(h.name)).forEach(p=>{const h=`${p.name}_${p.unit||""}`,v=P(h),L=!0,k=p.hasManualEntry===!0||!p.sources||p.sources.length===0,d=document.createElement("li");k&&(d.dataset.isManual="true"),d.className="flex flex-col p-3 rounded-lg transition-colors duration-200 bg-gray-100";const N=document.createElement("div");N.className="flex items-center w-full";const C=document.createElement("input");C.type="checkbox",C.className="form-checkbox h-6 w-6 text-tomato rounded-full border-gray-300 focus:ring-tomato cursor-pointer transition duration-150 ease-in-out",C.checked=L;const I=document.createElement("div");I.className="ml-3 flex-grow cursor-pointer select-none";const A=Number.isInteger(p.totalQuantity)?p.totalQuantity:parseFloat(p.totalQuantity.toFixed(2)),b=document.createElement("span");b.className="font-medium text-base line-through text-gray-400",b.textContent=p.name;const $=document.createElement("span");$.className="ml-2 font-bold text-base text-gray-400",$.textContent=` - ${A} ${p.unit||""}`.trim(),I.appendChild(b),I.appendChild($);const D=()=>{const x=!C.checked;C.checked=x,Q(v,x,d,C,b,$)};C.addEventListener("change",x=>{Q(v,x.target.checked,d,C,b,$)}),I.addEventListener("click",D),N.appendChild(C),N.appendChild(I),d.appendChild(N),u.appendChild(d)}),E.appendChild(u)})}}function Q(t,o,a,g,m,y){if(!w)return;const f=a.dataset.isManual==="true";o?(a.classList.remove("bg-white","bg-orange-100","shadow-sm","border","border-gray-100","border-orange-200"),a.classList.add("bg-gray-100"),a.style.backgroundColor="",m.classList.add("line-through","text-gray-400"),m.classList.remove("text-gray-800"),y.classList.add("text-gray-400"),y.classList.remove("text-gray-800")):(a.classList.remove("bg-gray-100"),f?(a.classList.add("bg-orange-100","shadow-sm","border","border-orange-200"),a.style.backgroundColor="#ffedd5"):(a.classList.add("bg-white","shadow-sm","border","border-gray-100"),a.style.backgroundColor=""),m.classList.remove("line-through","text-gray-400"),m.classList.add("text-gray-800"),y.classList.remove("text-gray-400"),y.classList.add("text-gray-800"));const r=U(_,"plans",w.id),e={};e[`checkedItems.${t}`]=o,e.lastUpdated=new Date,G(()=>import("./main-CHmAcSO8.js").then(n=>n.d),__vite__mapDeps([0,1,2])).then(n=>{n.updateDoc(r,e)}).catch(n=>{console.error("Error updating checked item:",n)})}function W(t){const o=new Map;(t.manualItems||[]).forEach(r=>{const e=`${r.name.trim().toLowerCase()}_${r.unit||""}`;o.set(e,{name:r.name.trim(),totalQuantity:r.totalQuantity,unit:r.unit,category:r.category||"Inconnue",hasManualEntry:!0})});const g=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];if(t.weeks)for(const r in t.weeks){const e=t.weeks[r],n=e.menuData||{},s=e.servingsData||{};for(const c in n){const i=n[c];if(!Array.isArray(i))continue;const[l,u]=c.split("-"),p=`${l}-${u}`,h=parseInt(s[p]||t.defaultNumPeople||1,10);i.forEach(v=>{const L=j.find(d=>d.id===v.id)||v;if(!L||!L.ingredients)return;const k=L.servings||1;L.ingredients.forEach(d=>{if(!d.name||!d.quantity)return;const N=Y.find(x=>x.name.toLowerCase()===d.name.toLowerCase()),C=N?N.category:"Inconnue",I=parseFloat(String(d.quantity).replace(",","."));if(isNaN(I))return;const b=I/k*h,$=d.unit||"",D=`${d.name.trim().toLowerCase()}_${$}`;if(o.has(D)){const x=o.get(D);x.totalQuantity+=b,x.sources||(x.sources=[]),x.sources.push({recipeName:L.name,day:g[parseInt(l,10)],time:u==="lunch"?"Midi":"Soir",quantity:b})}else o.set(D,{name:d.name.trim(),totalQuantity:b,unit:$,category:C,sources:[{recipeName:L.name,day:g[parseInt(l,10)],time:u==="lunch"?"Midi":"Soir",quantity:b}]})})})}}const m=[],y=[],f=t.hiddenTrashItems||[];return o.forEach(r=>{if(r.totalQuantity>0)m.push(r);else if(r.totalQuantity<=0&&r.sources&&r.sources.length>0){const e=`${r.name}_${r.unit||""}`,n=P(e);!f.includes(n)&&!f.includes(e)&&y.push(r)}}),{active:m,deleted:y}}const B=document.createElement("button");if(B.id="scroll-to-top-btn",B.className="hidden fixed bottom-20 right-5 bg-tomato text-white rounded-full w-12 h-12 shadow-lg z-50",B.innerHTML='<i class="fas fa-arrow-up"></i>',document.body.appendChild(B),window.addEventListener("scroll",()=>{window.pageYOffset>200?B.classList.remove("hidden"):B.classList.add("hidden")}),B.addEventListener("click",()=>{window.scrollTo({top:0,behavior:"smooth"})}),S){const t=S.cloneNode(!0);S.parentNode.replaceChild(t,S),t.addEventListener("change",o=>{const a=o.target.value;localStorage.setItem("lastActivePlanId",a),R(a)})}async function X(){try{Y=(await V(K(_,"ingredients"))).docs.map(o=>({id:o.id,...o.data()}))}catch(t){console.error("Error fetching ingredients",t)}try{j=(await V(K(_,"recipes"))).docs.map(o=>({id:o.id,...o.data()}))}catch(t){console.error("Error fetching recipes",t)}ee(t=>{const o=document.getElementById("shopping-mode-plan-select");if(!o)return;const a=o.value;if(o.innerHTML="",t.length===0){E&&(E.innerHTML='<p class="text-center p-4">Aucun plan trouvé.</p>');return}t.forEach(y=>{const f=document.createElement("option");f.value=y.id,f.textContent=y.name,o.appendChild(f)});const g=localStorage.getItem("lastActivePlanId");let m=null;g&&t.some(y=>y.id===g)?m=g:t.length>0&&(m=t[0].id),m&&(a&&t.some(y=>y.id===a)?(o.value=a,w||R(a)):(o.value=m,R(m)))})}return X(),()=>{M&&M(),B&&B.remove()}}export{se as default};
