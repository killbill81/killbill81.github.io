const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/main-BTlwZg5-.js","assets/firebase-config-CDPbqvnt.js","assets/login-DFQTpNfm.css"])))=>i.map(i=>d[i]);
import{b as ut,i as mt,a as pt,s as Pe,g as ye,_ as Te,c as ft,p as yt}from"./main-BTlwZg5-.js";import{r as he,j as He,k as ht,l as gt,m as vt,n as xt,p as Lt,t as je,d as B,o as Et,c as oe,b as bt,g as ge,a as Q,h as Fe,q as Ae,v as Ct,x as Re,s as It,f as wt,u as kt,w as Bt}from"./firebase-config-CDPbqvnt.js";import{R as Mt,t as St}from"./recipes-CUqsB9D2.js";import{o as Dt,a as Nt}from"./sharing-DdOVYPMD.js";let K=null,ne=null;function $t(l,ae){if(!he||!l)return;const Y=ut();if(!Y)return;const $=He(he,`plans_presence/${l}`);K=He(he,`plans_presence/${l}/${Y.uid}`);const T={displayName:Y.displayName||Y.email,photoURL:Y.photoURL,status:"idle",last_seen:je()};ht(K).remove(),gt(K,T),ne&&ne(),ne=vt($,g=>{const R=g.val()||{};typeof ae=="function"&&ae(R)})}function Pt(){K&&(Lt(K),K=null),ne&&(ne(),ne=null)}function ve(l){K&&xt(K,{status:l,last_seen:je()})}let G=null;function Rt(){const l={mealPlanGrid:document.getElementById("meal-plan-grid"),currentWeekDisplay:document.getElementById("current-week-display"),prevWeekBtn:document.getElementById("prev-week-btn"),nextWeekBtn:document.getElementById("next-week-btn"),clearMenuBtn:document.getElementById("clear-menu-btn"),shoppingListContainer:document.getElementById("shopping-list"),startDaySelect:document.getElementById("start-day-select"),defaultServingsControl:document.getElementById("default-servings-control"),mealSelectModal:document.getElementById("meal-select-modal"),closeMealSelectModalBtn:document.getElementById("close-meal-select-modal"),mealSelectModalTitle:document.getElementById("meal-select-modal-title"),mealSelectList:document.getElementById("meal-select-list"),recipeFormModal:document.getElementById("edit-recipe-form-modal"),closeRecipeModalBtn:document.getElementById("close-edit-recipe-modal"),cancelRecipeBtn:document.getElementById("edit-cancel-recipe-btn"),recipeForm:document.getElementById("edit-recipe-form"),addItemInput:document.getElementById("add-item-input"),addItemBtn:document.getElementById("add-item-btn"),addItemResults:document.getElementById("add-item-results"),importListBtn:document.getElementById("import-list-btn"),importListModal:document.getElementById("import-list-modal"),closeImportListModalBtn:document.getElementById("close-import-list-modal"),importListContainer:document.getElementById("import-list-container"),exportTxtBtn:document.getElementById("export-txt-btn"),exportPdfBtn:document.getElementById("export-pdf-btn"),exportPlanPdfBtn:document.getElementById("export-plan-pdf-btn"),sharePlanBtn:document.getElementById("share-plan-btn"),planSelect:document.getElementById("plan-select"),inviteParticipantBtn:document.getElementById("invite-participant-btn"),historyPlanBtn:document.getElementById("history-plan-btn"),planHistoryModal:document.getElementById("plan-history-modal"),closePlanHistoryModalBtn:document.getElementById("close-plan-history-modal"),planHistoryList:document.getElementById("plan-history-list"),savePlanBtn:document.getElementById("save-plan-btn"),openTrashBtn:document.getElementById("open-trash-btn"),trashCount:document.getElementById("trash-count"),trashModal:document.getElementById("trash-modal"),closeTrashModalBtn:document.getElementById("close-trash-modal"),trashListContainer:document.getElementById("trash-list-container"),emptyTrashBtn:document.getElementById("empty-trash-btn")};function ae(e,t){const n=document.createElement("div");n.className="flex items-center space-x-2";const i=document.createElement("button");i.className="btn btn-outline btn-xs",i.textContent="-";const a=document.createElement("span");a.className="font-medium text-center w-6",a.textContent=e;const o=document.createElement("button");return o.className="btn btn-outline btn-xs",o.textContent="+",i.addEventListener("click",()=>{let r=parseInt(a.textContent,10);r>1&&(r--,a.textContent=r,t(r))}),o.addEventListener("click",()=>{let r=parseInt(a.textContent,10);r++,a.textContent=r,t(r)}),n.appendChild(i),n.appendChild(a),n.appendChild(o),n}function Y(e,t,n,i=!1){const a=document.createElement("div");a.className="flex flex-col items-center justify-center h-full";const o=document.createElement("button");o.className="text-gray-600 hover:bg-gray-100 p-0 h-4 flex items-center justify-center w-full rounded-md",o.innerHTML='<i class="fas fa-plus"></i>',o.disabled=i;const r=document.createElement("span");r.className="font-medium text-center text-sm my-1",r.textContent=e;const s=document.createElement("button");return s.className="text-gray-600 hover:bg-gray-100 p-0 h-4 flex items-center justify-center w-full rounded-md",s.innerHTML='<i class="fas fa-minus"></i>',s.disabled=i,t&&(o.classList.add("text-white"),r.classList.add("text-white"),s.classList.add("text-white")),i||(o.addEventListener("click",()=>{let c=parseInt(r.textContent,10);c++,r.textContent=c,n(c)}),s.addEventListener("click",()=>{let c=parseInt(r.textContent,10);c>1&&(c--,r.textContent=c,n(c))})),a.appendChild(o),a.appendChild(r),a.appendChild(s),a}G&&G.destroy(),G=new Mt(B,"edit-recipe-form-modal","edit-recipe-form","edit-recipe-modal-title","edit-recipe-id","edit-recipe-name","edit-recipe-category","edit-recipe-servings","edit-recipe-prep-time","edit-recipe-difficulty","edit-recipe-steps","edit-ingredients-list","edit-add-ingredient-btn","edit-save-recipe-btn","close-edit-recipe-modal","edit-cancel-recipe-btn"),G.setActivityUpdater(ve),G.setOnSaveCallback(async()=>{});let $=1,T="Lundi",g={},R={},F={};const O=[];let X=null,z=[],se=[],j=1,ee=null,xe=[],u=null;const _=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];function ie(e){return e?e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase():""}function qe(e){return e?e.replace(/\./g,"_"):""}async function _e(e){const t=document.getElementById("unit-select-modal"),n=document.getElementById("unit-modal-title"),i=document.getElementById("unit-modal-list"),a=document.getElementById("unit-modal-cancel");return n.textContent=`Choisir une unité pour "${e}"`,i.innerHTML="",new Promise((o,r)=>{const s=["g","kg","ml","l","pièce(s)","c.à.s.","c.à.c.","pincée(s)"],c=m=>{t.classList.add("hidden"),o(m)};s.forEach(m=>{const p=document.createElement("button");p.className="btn btn-outline",p.textContent=m,p.addEventListener("click",()=>c(m)),i.appendChild(p)});const d=()=>{t.classList.add("hidden"),r()};a.addEventListener("click",d,{once:!0}),t.addEventListener("click",m=>{m.target===t&&d()},{once:!0}),t.classList.remove("hidden")})}async function Le(){if(B)try{se=(await ge(oe(B,"ingredients"))).docs.map(t=>({id:t.id,...t.data()})),se.sort((t,n)=>t.name.localeCompare(n.name))}catch(e){console.error("Erreur lors de la récupération des ingrédients: ",e)}}function Ee(){if(!u)g={},R={},F={},j=1,T="Lundi";else{const e=u.weeks?u.weeks[$]||{}:{};g=e.menuData||{},R=e.servingsData||{},F=e.remarksData||{},j=u.defaultNumPeople||1,T=u.startDay||"Lundi"}if(l.startDaySelect&&(l.startDaySelect.value=T),l.defaultServingsControl){l.defaultServingsControl.innerHTML="";const e=ae(j,async t=>{j=t,u&&await V({defaultNumPeople:t},`a changé le nombre de personnes par défaut à ${t}`)});l.defaultServingsControl.appendChild(e)}ot(),le(l.mealPlanGrid,{menuData:g,servingsData:R,remarksData:F,defaultNumPeople:j,startDay:T},!1),be(document.getElementById("mobile-meal-plan"),{menuData:g,servingsData:R,remarksData:F,defaultNumPeople:j,startDay:T},!1),ce()}async function V(e,t){if(!u)return;await Pe(u.id,u,t);const n=Q(B,"plans",u.id);try{await kt(n,{...e,lastUpdated:new Date})}catch(i){console.error("Error updating plan:",i),alert("Une erreur de sauvegarde est survenue.")}}function me(){l.planHistoryModal.classList.add("hidden")}async function Ue(e){if(u&&confirm("Voulez-vous vraiment restaurer cette version ? L'état actuel sera sauvegardé dans l'historique avant la restauration."))try{const t=Q(B,"plans",u.id,"history",e),n=await Fe(t);if(!n.exists())throw new Error("Version de l'historique non trouvée.");const i=n.data().planState;await Pe(u.id,u);const a=Q(B,"plans",u.id);await It(a,i),me()}catch(t){console.error("Erreur lors du rollback :",t)}}async function Oe(e,t){if(u&&confirm("Êtes-vous sûr de vouloir supprimer définitivement cette entrée de l'historique ?"))try{const n=Q(B,"plans",u.id,"history",e);await wt(n),t.remove()}catch(n){console.error("Erreur lors de la suppression de l'historique :",n),alert("Une erreur est survenue lors de la suppression.")}}async function ze(){if(u){l.planHistoryList.innerHTML="<p>Chargement de l'historique...</p>",l.planHistoryModal.classList.remove("hidden");try{const e=oe(B,"plans",u.id,"history"),t=Ae(e,Ct("timestamp","desc")),n=await ge(t);if(l.planHistoryList.innerHTML="",n.empty){l.planHistoryList.innerHTML="<p>Aucun historique pour ce plan.</p>";return}n.forEach(i=>{const a=i.data(),o=document.createElement("div");o.className="p-3 border-b flex justify-between items-center";const r=document.createElement("div"),s=a.timestamp?.toDate().toLocaleString("fr-FR")||"Date inconnue",c=a.description||"Modification diverse",d=a.modifiedByName||"Inconnu";r.innerHTML=`
                    <p class="font-medium">${d} ${c}</p>
                    <p class="text-sm text-gray-500">${s}</p>
                `;const m=document.createElement("div");m.className="flex items-center space-x-2";const p=document.createElement("button");p.className="btn btn-secondary btn-sm",p.textContent="Revenir à cette version",p.addEventListener("click",()=>Ue(i.id));const f=document.createElement("button");f.className="text-red-500 hover:bg-red-100 text-sm px-3 py-1 rounded-md",f.innerHTML='<i class="fas fa-times"></i>',f.title="Supprimer cette version",f.addEventListener("click",y=>{y.stopPropagation(),Oe(i.id,o)}),m.appendChild(p),m.appendChild(f),o.appendChild(r),o.appendChild(m),l.planHistoryList.appendChild(o)})}catch(e){console.error("Erreur de chargement de l'historique:",e),l.planHistoryList.innerHTML=`<p class="text-red-500">Impossible de charger l'historique.</p>`}}}function be(e,t,n=!1){if(!e)return;const i=t.menuData||{},a=t.servingsData||{},o=t.remarksData||{},r=t.defaultNumPeople||1,s=t.startDay||"Lundi";e.innerHTML="";const c=document.createDocumentFragment(),d=_.indexOf(s);[..._.slice(d),..._.slice(0,d)].forEach(p=>{const f=_.indexOf(p),y=document.createElement("div");y.className="bg-blue-100 border border-blue-300 rounded-xl shadow-md p-4 mb-4";const h=document.createElement("h3");h.className="text-xl font-bold text-gray-800 mb-3",h.textContent=p.toUpperCase(),y.appendChild(h);const C=document.createElement("div");C.className="space-y-4",["lunch","dinner"].forEach(v=>{const E=document.createElement("div");E.className=`border-t pt-3 ${v==="lunch"?"bg-amber-50":"bg-stone-100"} rounded-lg p-2`;const w=document.createElement("div");w.className="flex justify-between items-center mb-2";const k=document.createElement("h4");if(k.className="text-lg font-semibold text-tomato",k.textContent=v==="lunch"?"Midi":"Soir",w.appendChild(k),!n){const I=`${f}-${v}`,b=a[I]||r,x=ae(b,L=>{$e(I,L)});w.appendChild(x)}E.appendChild(w);const S=document.createElement("div");S.className="space-y-2";let A=!1;const D=["Entrée","Plat","Accompagnement","Dessert","Remarque"];for(let I=0;I<D.length;I++){const b=D[I],x=`${f}-${v}-${I}`,L=i[x],P=document.createElement("div");P.className="mb-2";const H=document.createElement("h5");if(H.className="text-md font-semibold text-gray-700 mb-1",H.textContent=b,P.appendChild(H),b==="Remarque")P.appendChild(Me(x,o,n));else{const M=document.createElement("div");if(M.className="space-y-1",Array.isArray(L)&&L.length>0&&(A=!0,L.forEach((N,ue)=>{const W=z.find(q=>q.id===N.id);if(W){const q=ke(W,x,ue,n);if(q.classList.remove("bg-white","shadow-sm"),q.classList.add("bg-emerald-200","border","border-emerald-400"),!n){const U=q.querySelector(".edit-meal-btn"),te=q.querySelector(".delete-meal-btn");U&&U.classList.remove("hidden"),te&&te.classList.remove("hidden")}M.appendChild(q)}})),n)A||(M.innerHTML='<p class="text-sm text-gray-500 italic">Aucun plat prévu.</p>');else{const N=document.createElement("button");N.className="btn btn-outline btn-sm w-full mt-2",N.innerHTML=`<i class="fas fa-plus mr-2"></i> Ajouter une ${b.toLowerCase()}`,N.addEventListener("click",()=>{we(x)}),M.appendChild(N)}P.appendChild(M)}S.appendChild(P)}E.appendChild(S),C.appendChild(E)}),y.appendChild(C),c.appendChild(y)}),e.appendChild(c)}function le(e,t,n=!1){if(!e)return;const i=t.menuData||{},a=t.servingsData||{},o=t.remarksData||{},r=t.defaultNumPeople||1,s=t.startDay||"Lundi",c=document.createDocumentFragment(),d=["lunch","dinner"],m=5,p=_.indexOf(s);[..._.slice(p),..._.slice(0,p)].forEach(y=>{const h=_.indexOf(y),C=document.createElement("div");C.className="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] items-stretch border-b border-gray-300";const v=document.createElement("div");v.className="font-bold p-2 flex items-center justify-center bg-gray-100 text-sm border-r border-gray-300",v.textContent=y.toUpperCase(),C.appendChild(v),d.forEach(E=>{const w=`${h}-${E}`,k=a[w]||r,S=a.hasOwnProperty(w),A=document.createElement("div"),D=Y(k,S,b=>{$e(w,b)},n);let I="border-r border-gray-300 flex items-center justify-center transition-colors duration-300";S?I+=" bg-tomato":I+=E==="lunch"?" bg-amber-50":" bg-stone-100",A.className=I,A.appendChild(D),C.appendChild(A);for(let b=0;b<m;b++){const x=`${h}-${E}-${b}`,L=i[x],P=document.createElement("div"),H=re(x);let M="meal-slot p-1 min-h-[70px] flex flex-col justify-start border-r border-gray-300";if(M+=E==="lunch"?" bg-amber-50":" bg-stone-100",P.className=M,P.dataset.slotId=x,H==="Remarque")P.appendChild(Me(x,o,n));else if(Array.isArray(L)&&L.length>0){const N=document.createElement("div");N.className="w-full",L.forEach((ue,W)=>{const q=z.find(U=>U.id===ue.id);if(q)N.appendChild(ke(q,x,W,n));else{const U=document.createElement("div");U.className="p-1 bg-red-100 text-red-700 rounded shadow-sm text-center text-xs font-medium",U.textContent="Recette supprimée",N.appendChild(U)}}),P.appendChild(N),n||P.appendChild(Be(x,!0))}else n||P.appendChild(Be(x,!1));C.appendChild(P)}}),c.appendChild(C)}),e.innerHTML="",e.appendChild(c),n||at()}async function Qe(){const e=ye();if(!B||!e)return[];try{const t=Ae(oe(B,"shopping_lists"),Bt("userId","==",e));return(await ge(t)).docs.map(o=>({id:o.id,...o.data()})).filter(o=>o.isShared!==!0)}catch(t){return console.error("Erreur de chargement des listes de courses sauvegardées: ",t),[]}}async function Ve(){const e=await Qe();if(l.importListContainer.innerHTML="",e.length===0){l.importListContainer.innerHTML='<p class="text-center text-gray-500">Aucune liste sauvegardée.</p>';return}e.forEach(t=>{const n=document.createElement("button");n.className="w-full text-left p-2 hover:bg-gray-100 rounded-lg transition-colors duration-150",n.textContent=t.name,n.addEventListener("click",()=>{confirm(`Voulez-vous vraiment importer les ingrédients de la liste "${t.name}" ?`)&&(t.ingredients.forEach(i=>{const a=parseFloat(String(i.quantity).replace(",","."))||0;Z(i.name,a,i.unit)}),pe())}),l.importListContainer.appendChild(n)}),l.importListModal.classList.remove("hidden")}function pe(){l.importListModal.classList.add("hidden")}function We(){l.addItemInput?.addEventListener("input",()=>{const e=l.addItemInput.value.toLowerCase(),t=l.addItemResults;if(t.innerHTML="",!e){t.classList.add("hidden");return}se.filter(a=>a.name.toLowerCase().includes(e)).forEach(a=>{const o=document.createElement("div");o.className="p-2 hover:bg-gray-100 cursor-pointer",o.textContent=a.name,o.addEventListener("click",()=>{Z(a.name,1,a.unit),l.addItemInput.value="",t.classList.add("hidden")}),t.appendChild(o)});const i=document.createElement("div");i.className="p-2 bg-green-50 hover:bg-green-200 cursor-pointer font-bold text-green-700",i.textContent=`+ Créer "${l.addItemInput.value}"`,i.addEventListener("click",async()=>{const a=l.addItemInput.value;try{const o=await _e(a);await bt(oe(B,"ingredients"),{name:a,unit:o}),await Le(),Z(a,1,o),l.addItemInput.value="",t.classList.add("hidden")}catch{}}),t.appendChild(i),t.classList.remove("hidden")}),l.addItemBtn?.addEventListener("click",()=>{const e=l.addItemInput.value;e&&(Z(e,1,""),l.addItemInput.value="",l.addItemResults.classList.add("hidden"))}),document.addEventListener("click",e=>{l.addItemInput&&!l.addItemInput.contains(e.target)&&!l.addItemResults.contains(e.target)&&l.addItemResults.classList.add("hidden")})}function Je(){if(O.length===0){alert("La liste de courses est vide.");return}const e=O.reduce((a,o)=>{const r=o.category||"Inconnue";return a[r]||(a[r]=[]),a[r].push(o),a},{}),t=Object.keys(e).sort((a,o)=>a==="Inconnue"?1:o==="Inconnue"?-1:a.localeCompare(o));let n=`Liste de courses - GustoPlan

`;t.forEach(a=>{n+=`--- ${a.toUpperCase()} ---
`,e[a].sort((r,s)=>r.name.localeCompare(s.name)).forEach(r=>{let c=`${Number.isInteger(r.totalQuantity)?r.totalQuantity:parseFloat(r.totalQuantity.toFixed(2))} ${r.unit||""} ${r.name}`;if(r.sources&&r.sources.length>0){const d=r.sources.reduce((p,f)=>{const y=`${f.recipeName} (${f.day} ${f.time})`;return p[y]||(p[y]=0),p[y]+=f.quantity,p},{}),m=Object.keys(d).join(" / ");c+=` *** ${m} ***`}n+=c+`
`}),n+=`
`});const i=new Blob([n],{type:"text/plain;charset=utf-8"});saveAs(i,"liste-de-courses.txt")}function Ge(){if(O.length===0){alert("La liste de courses est vide.");return}const{jsPDF:e}=window.jspdf,t=new e,n=O.reduce((c,d)=>{const m=d.category||"Inconnue";return c[m]||(c[m]=[]),c[m].push(d),c},{}),i=Object.keys(n).sort((c,d)=>c==="Inconnue"?1:d==="Inconnue"?-1:c.localeCompare(d));t.setFontSize(18),t.text("Liste de courses - GustoPlan",14,22);let a=35;const o=t.internal.pageSize.height,r=20,s=()=>{a>o-r&&(t.addPage(),a=20)};i.forEach(c=>{s(),t.setFontSize(14),t.setFont(void 0,"bold"),t.text(`--- ${c.toUpperCase()} ---`,14,a),a+=8,t.setFont(void 0,"normal"),n[c].sort((m,p)=>m.name.localeCompare(p.name)).forEach(m=>{s(),t.setFontSize(12);const p=Number.isInteger(m.totalQuantity)?m.totalQuantity:parseFloat(m.totalQuantity.toFixed(2));if(t.text(`${p} ${m.unit||""} ${m.name}`,14,a),a+=6,m.sources&&m.sources.length>0){const f=m.sources.reduce((y,h)=>{const C=`${h.recipeName} (${h.day} ${h.time})`;return y[C]||(y[C]=0),y[C]+=h.quantity,y},{});t.setFontSize(9),t.setTextColor(100);for(const y in f)s(),t.text(`  * ${y}`,18,a),a+=5;t.setTextColor(0)}a+=2}),a+=5}),t.save("liste-de-courses.pdf")}async function Ke(){if(!u){alert("Veuillez sélectionner un plan à exporter.");return}const e=document.getElementById("loading-overlay");e&&e.classList.remove("hidden");try{const{jsPDF:t}=window.jspdf,n=new t,i=Q(B,"plans",u.id),a=await Fe(i),o=a.exists()?a.data():null;if(!o||!o.weeks){alert("Ce plan est vide et ne peut pas être exporté.");return}n.setFontSize(18),n.text(`Plan de Repas: ${o.name}`,14,20);const r=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"],s={0:"E",1:"P",2:"A",3:"D"},c=Object.keys(o.weeks).sort((m,p)=>parseInt(m)-parseInt(p));let d=!0;for(const m of c){const f=o.weeks[m].menuData||{};if(Object.keys(f).length===0)continue;const y=[["Jour","Midi","Soir"]],h=[],C=r.indexOf(o.startDay||"Lundi"),v=[...r.slice(C),...r.slice(0,C)];for(const w of v){const k=r.indexOf(w);let S=[],A=[];for(const D of["lunch","dinner"])for(const I in s){const b=`${k}-${D}-${I}`;f[b]&&Array.isArray(f[b])&&f[b].forEach(x=>{const L=`[${s[I]}] ${x.name}`;D==="lunch"?S.push(L):A.push(L)})}h.push([w,S.join(`
`)||"-",A.join(`
`)||"-"])}n.setFontSize(14);const E=d?30:n.autoTable.previous.finalY+20;n.text(`Semaine ${m}`,14,E-5),n.autoTable({startY:E,head:y,body:h,theme:"grid",styles:{cellPadding:2,fontSize:8,valign:"middle"},headStyles:{fillColor:[41,128,185],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[245,245,245]}}),d=!1}n.save(`plan_${o.name.replace(/ /g,"_")}.pdf`)}catch(t){console.error("Erreur lors de la génération du PDF du plan :",t),alert("Une erreur est survenue lors de la création du PDF.")}finally{e&&e.classList.add("hidden")}}async function Z(e,t,n,i=!1){if(!u)return alert("Veuillez sélectionner un plan.");const a=Q(B,"plans",u.id);try{await Re(B,async o=>{const r=await o.get(a);if(!r.exists())throw"Le plan n'existe plus.";const s=r.data().manualItems||[],c=`${e.trim().toLowerCase()}_${n||""}`,d=s.findIndex(p=>`${p.name.trim().toLowerCase()}_${p.unit||""}`===c);if(d>-1)s[d].totalQuantity+=t;else{const p=se.find(f=>f.name.toLowerCase()===e.trim().toLowerCase());s.push({name:e.trim(),totalQuantity:t,unit:n,source:"manual",category:p?.category||"Inconnue"})}const m=s.filter(p=>p.totalQuantity!==0);o.update(a,{manualItems:m,lastUpdated:new Date})})}catch(o){console.error("Erreur transactionnelle lors de l'ajustement de l'ingrédient: ",o),alert("Une erreur de synchronisation est survenue. Veuillez réessayer.")}}function Ce(e){const t=e?e.toLowerCase():"";return t.includes("g")||t.includes("ml")?10:1}function Ie(e=[]){const t=l.shoppingListContainer;if(!t)return;if(t.innerHTML="",O.length===0&&e.length===0){t.innerHTML='<p class="text-center text-gray-500 italic py-4">Votre liste de courses est vide.</p>';return}const n=u?u.checkedItems||{}:{},i=O.reduce((o,r)=>{const s=r.category||"Inconnue";return o[s]||(o[s]=[]),o[s].push(r),o},{});if(Object.keys(i).sort((o,r)=>o==="Inconnue"?1:r==="Inconnue"?-1:o.localeCompare(r)).forEach(o=>{const r=document.createElement("h4");r.className="text-sm font-bold text-stone-800 bg-stone-200 mt-4 mb-2 px-3 py-1 rounded-md",r.textContent=o,t.appendChild(r);const s=document.createElement("ul");s.className="space-y-2",i[o].sort((d,m)=>d.name.localeCompare(m.name)).forEach(d=>{const m=`${d.name}_${d.unit||""}`,p=qe(m),f=n.hasOwnProperty(p)?n[p]:n[m]||!1,y=document.createElement("li");let h="p-2 rounded";d.hasManualEntry===!0||d.source==="manual"?(y.style.backgroundColor="#ffedd5",h+=" bg-orange-100"):h+=" bg-gray-50",y.className=h;const v=document.createElement("div");v.className="flex justify-between items-center";const E=document.createElement("div");if(E.className="flex-grow flex items-center",f){const L=document.createElement("i");L.className="fas fa-check mr-2 bg-green-500 text-white rounded-full p-1 flex items-center justify-center w-5 h-5",E.appendChild(L)}const w=document.createElement("span");w.className="text-sm font-medium transition-all duration-200",f&&w.classList.add("line-through","text-gray-400"),w.textContent=d.name,E.appendChild(w),v.appendChild(E);const k=document.createElement("div");k.className="flex items-center space-x-2 mx-2";const S=document.createElement("span");S.className="font-medium w-20 text-center text-sm",f&&S.classList.add("text-gray-400");const A=Number.isInteger(d.totalQuantity)?d.totalQuantity:parseFloat(d.totalQuantity.toFixed(2));S.textContent=`${A} ${d.unit||""}`.trim();const D=document.createElement("div");D.className="flex flex-col";const I=document.createElement("button");I.className="btn btn-outline btn-xs rounded-b-none",I.textContent="+",I.addEventListener("click",async()=>{const L=Ce(d.unit);await Z(d.name,L,d.unit)});const b=document.createElement("button");b.className="btn btn-outline btn-xs rounded-t-none -mt-px",b.textContent="-",b.addEventListener("click",async()=>{const L=Ce(d.unit);await Z(d.name,-L,d.unit)}),D.appendChild(I),D.appendChild(b),k.appendChild(S),k.appendChild(D),v.appendChild(k);const x=document.createElement("button");if(x.className="delete-item-btn text-red-500 hover:text-red-700",x.innerHTML='<i class="fas fa-trash-alt"></i>',x.addEventListener("click",()=>{Z(d.name,-d.totalQuantity,d.unit,!0)}),v.appendChild(x),y.appendChild(v),d.sources&&d.sources.length>0){const L=document.createElement("div");L.className="p-2 mt-1 ml-4 rounded-md bg-stone-100";const P=d.sources.reduce((H,M)=>{const N=`${M.recipeName} (${M.day} ${M.time})`;return H[N]||(H[N]=0),H[N]+=M.quantity,H},{});for(const H in P){const M=document.createElement("span");M.className="block text-xs text-gray-500",M.textContent=`↳ ${H}`,L.appendChild(M)}y.appendChild(L)}s.appendChild(y)}),t.appendChild(s)}),l.openTrashBtn&&(l.openTrashBtn.classList.remove("hidden"),l.trashCount&&(l.trashCount.textContent=e.length,e.length>0?(l.trashCount.classList.remove("bg-gray-200"),l.trashCount.classList.add("bg-red-500","text-white")):(l.trashCount.classList.add("bg-gray-200"),l.trashCount.classList.remove("bg-red-500","text-white")))),e&&e.length>0){if(l.emptyTrashBtn){l.emptyTrashBtn.classList.remove("hidden");const o=l.emptyTrashBtn.cloneNode(!0);l.emptyTrashBtn.parentNode.replaceChild(o,l.emptyTrashBtn),l.emptyTrashBtn=o,l.emptyTrashBtn.addEventListener("click",async()=>{if(!u||!confirm("Voulez-vous supprimer définitivement tous les éléments de la corbeille ?"))return;const r=Q(B,"plans",u.id),s=e.map(c=>`${c.name}_${c.unit||""}`);try{await Te(()=>import("./main-BTlwZg5-.js").then(c=>c.d),__vite__mapDeps([0,1,2])).then(c=>{c.updateDoc(r,{hiddenTrashItems:c.arrayUnion(...s),lastUpdated:new Date})}),l.trashModal.classList.add("hidden")}catch(c){console.error("Erreur vidage corbeille:",c)}})}if(l.trashListContainer){l.trashListContainer.innerHTML="";const o=document.createElement("ul");o.className="space-y-2",e.forEach(r=>{const s=document.createElement("li");s.className="p-2 rounded bg-gray-100 flex justify-between items-center group";const c=document.createElement("span");c.className="text-sm text-gray-500 line-through",c.textContent=r.name,s.appendChild(c);const d=document.createElement("div");d.className="flex items-center space-x-2";const m=document.createElement("button");m.className="btn btn-xs btn-outline text-blue-600 hover:bg-blue-50 border-blue-300",m.innerHTML='<i class="fas fa-undo mr-1"></i> Restaurer',m.addEventListener("click",async()=>{if(!u)return;const f=Q(B,"plans",u.id);try{await Re(B,async y=>{const h=await y.get(f);if(!h.exists())return;const v=(h.data().manualItems||[]).filter(E=>!(E.name.toLowerCase()===r.name.toLowerCase()&&E.unit===r.unit));y.update(f,{manualItems:v,lastUpdated:new Date})}),e.length<=1&&l.trashModal.classList.add("hidden")}catch(y){console.error("Erreur lors de la restauration :",y)}});const p=document.createElement("button");p.className="text-gray-400 hover:text-red-600 text-xs p-1 rounded-md",p.title="Supprimer définitivement",p.innerHTML='<i class="fas fa-times"></i>',p.addEventListener("click",async()=>{if(!u)return;const f=Q(B,"plans",u.id),y=`${r.name}_${r.unit||""}`;try{await Te(()=>import("./main-BTlwZg5-.js").then(h=>h.d),__vite__mapDeps([0,1,2])).then(h=>{h.updateDoc(f,{hiddenTrashItems:h.arrayUnion(y),lastUpdated:new Date})}),e.length<=1&&l.trashModal.classList.add("hidden")}catch(h){console.error("Erreur suppression définitive:",h)}}),d.appendChild(m),d.appendChild(p),s.appendChild(d),o.appendChild(s)}),l.trashListContainer.appendChild(o)}}else l.trashListContainer&&(l.trashListContainer.innerHTML='<p class="text-center text-gray-500 italic py-4">La corbeille est vide.</p>'),l.emptyTrashBtn&&l.emptyTrashBtn.classList.add("hidden")}async function ce(){if(!u){O.length=0,Ie();return}const e=u.manualItems?JSON.parse(JSON.stringify(u.manualItems)):[],t=new Map(e.map(s=>{const c=`${s.name.trim().toLowerCase()}_${s.unit||""}`;return s.hasManualEntry=!0,[c,s]})),n=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];if(u.weeks)for(const s in u.weeks){const c=u.weeks[s],d=c.menuData||{},m=c.servingsData||{};for(const p in d){const f=d[p];if(!Array.isArray(f))continue;const[y,h]=p.split("-"),C=parseInt(y,10),v=n[C]||"Jour inconnu",E=h==="lunch"?"midi":"soir",w=`${C}-${h}`,k=parseInt(m[w]||u.defaultNumPeople,10);for(const S of f){const D=z.find(b=>b.id===S.id)||S;if(!D||!Array.isArray(D.ingredients))continue;const I=D.servings||1;I<=0||D.ingredients.forEach(b=>{const{name:x,quantity:L,unit:P}=b;if(!x||!L)return;const H=se.find(J=>J.name.toLowerCase()===x.trim().toLowerCase()),M=H?H.category:"Inconnue",N=parseFloat(String(L).replace(",","."));if(isNaN(N))return;const W=N/I*k,q=P||"",U=`${x.trim().toLowerCase()}_${q}`,te={recipeName:D.name,day:`${v} (S${s})`,time:E,quantity:W};if(t.has(U)){const J=t.get(U);J.totalQuantity+=W,J.source==="manual"&&(J.source="mixed"),Array.isArray(J.sources)?J.sources.push(te):J.sources=[te]}else t.set(U,{name:x.trim(),totalQuantity:W,unit:q,source:"plan",category:M,sources:[te]})})}}}const i=Array.from(t.values()),a=u.hiddenTrashItems||[],o=i.filter(s=>s.totalQuantity>0).sort((s,c)=>s.name.localeCompare(c.name)),r=i.filter(s=>{const c=`${s.name}_${s.unit||""}`;return s.totalQuantity<=0&&s.sources&&s.sources.length>0&&!a.includes(c)}).sort((s,c)=>s.name.localeCompare(c.name));O.length=0,O.push(...o),Ie(r)}function we(e){const t=re(e);if(!t||!l.mealSelectModal)return;l.mealSelectModalTitle.textContent=`Sélectionner : ${t}`,l.mealSelectList.innerHTML="";const n=document.createElement("input");n.type="text",n.placeholder="Rechercher dans la catégorie...",n.className="w-full p-2 mb-4 border border-gray-300 rounded-lg",l.mealSelectList.appendChild(n);const i=ie(t),a=z.filter(s=>ie(s.category)===i).sort((s,c)=>{const d=s.isFavorite?1:0,m=c.isFavorite?1:0;return m!==d?m-d:s.name.localeCompare(c.name)}),o=document.createElement("div");o.className="space-y-1 max-h-80 overflow-y-auto",l.mealSelectList.appendChild(o);function r(s=""){o.innerHTML="";const c=s.toLowerCase(),d=a.filter(m=>m.name.toLowerCase().includes(c));d.length===0?o.innerHTML='<p class="text-gray-500 p-4">Aucun plat ne correspond à votre recherche.</p>':d.forEach(m=>{const p=document.createElement("button");p.className="w-full text-left p-2 hover:bg-gray-100 rounded-lg transition-colors duration-150";const f=document.createElement("p");f.className="font-medium text-gray-800 text-sm",m.isFavorite?f.innerHTML=`${m.name} <i class="fas fa-heart text-red-500 ml-2"></i>`:f.textContent=m.name,p.appendChild(f),p.addEventListener("click",()=>{st(e,m),de()}),o.appendChild(p)})}n.addEventListener("input",s=>r(s.target.value)),r(),l.mealSelectModal.classList.remove("hidden"),n.focus()}function de(){l.mealSelectModal&&l.mealSelectModal.classList.add("hidden")}function Ye(e){X=e.target.closest(".meal-card");const t=X.closest(".meal-slot").dataset.slotId;e.dataTransfer.setData("text/plain",t),setTimeout(()=>{X&&(X.style.opacity="0.5")},0)}function Xe(){X&&(X.style.opacity="1",X=null)}function Ze(e){e.preventDefault();const t=e.target.closest(".meal-slot");t&&re(t.dataset.slotId)!=="Remarque"&&t.classList.add("bg-gray-200")}function et(e){const t=e.target.closest(".meal-slot");t&&t.classList.remove("bg-gray-200")}async function tt(e){e.preventDefault();const t=e.dataTransfer.getData("text/plain"),n=e.target.closest(".meal-slot");if(n){n.classList.remove("bg-gray-200");const i=n.dataset.slotId,a=re(i);if(a==="Remarque")return;if(t&&i&&t!==i){const o=g[t],r=re(t);if(ie(r)!==ie(a)){alert(`Action impossible : un(e) "${r}" ne peut pas aller dans la catégorie "${a}".`);return}const s=g[i];g[i]=o,s?g[t]=s:delete g[t],le(l.mealPlanGrid,{menuData:g,servingsData:R,remarksData:F,defaultNumPeople:j,startDay:T},!1),await V({[`weeks.${$}.menuData`]:g},"a déplacé un plat"),await ce()}}}function re(e){switch(e.split("-")[2]){case"0":return"Entrée";case"1":return"Plat";case"2":return"Accompagnement";case"3":return"Dessert";case"4":return"Remarque";default:return""}}function ke(e,t,n,i=!1){const a=document.createElement("div");if(a.className="meal-card p-1 flex flex-col items-center bg-white rounded shadow-sm text-center relative w-full mb-1",i||(a.classList.add("cursor-grab"),a.draggable=!0),!i){const c=document.createElement("button");c.className="absolute -top-2 -right-1 text-base",c.innerHTML='<i class="fas fa-heart"></i>',e.isFavorite?c.classList.add("text-red-500"):c.classList.add("text-gray-300","hover:text-red-400"),c.addEventListener("click",d=>{d.stopPropagation(),St(e.id,e.isFavorite)}),c.addEventListener("mousedown",d=>d.stopPropagation()),a.appendChild(c)}const o=document.createElement("span");if(o.className="text-xs font-medium p-1 break-words w-full",o.textContent=e.name,a.appendChild(o),!i){const c=document.createElement("div");c.className="absolute top-0 left-0 flex";const d=document.createElement("button");d.className="edit-meal-btn text-gray-600 hover:text-gray-800 hidden px-1 py-0.5",d.innerHTML='<i class="fas fa-pencil-alt fa-xs"></i>',d.title="Modifier la recette",d.addEventListener("click",p=>{p.stopPropagation();const f=z.find(y=>y.id===e.id);G.openForm(f||e,"Modifier la recette")}),d.addEventListener("mousedown",p=>p.stopPropagation()),c.appendChild(d);const m=document.createElement("button");m.className="delete-meal-btn text-red-700 hover:text-red-900 hidden px-1 py-0.5",m.innerHTML='<i class="fas fa-times-circle fa-xs"></i>',m.title="Retirer du planning",m.addEventListener("click",p=>{p.stopPropagation(),rt(t,n)}),m.addEventListener("mousedown",p=>p.stopPropagation()),c.appendChild(m),a.appendChild(c),a.addEventListener("mouseenter",()=>{d.classList.remove("hidden"),m.classList.remove("hidden")}),a.addEventListener("mouseleave",()=>{d.classList.add("hidden"),m.classList.add("hidden")})}const r=document.createElement("div");r.className="absolute bottom-1 right-1";const s=document.createElement("button");return s.className="info-meal-btn bg-gray-500 text-white hover:bg-gray-600 rounded w-3 h-3 flex items-center justify-center shadow-sm",s.innerHTML='<i class="fas fa-plus fa-xs"></i>',s.title="Plus d'infos",s.dataset.slotId=t,s.dataset.mealIndex=n,s.addEventListener("mousedown",c=>c.stopPropagation()),r.appendChild(s),a.appendChild(r),a}function nt(e,t){if(document.querySelectorAll(".planner-ingredient-tooltip").forEach(r=>r.remove()),ee===e){e.classList.remove("info-open"),e.innerHTML='<i class="fas fa-plus fa-xs"></i>',ee=null;return}ee&&(ee.classList.remove("info-open"),ee.innerHTML='<i class="fas fa-plus fa-xs"></i>'),e.classList.add("info-open"),e.innerHTML='<i class="fas fa-times fa-xs"></i>',ee=e;const n=document.createElement("div");if(n.className="planner-ingredient-tooltip z-50 w-64 p-3 bg-white border border-gray-200 rounded-lg shadow-lg text-left text-sm",t.ingredients&&t.ingredients.length>0){if(t.servings&&t.servings>0){const c=document.createElement("p");c.className="mb-2 text-sm text-gray-600 flex items-center",c.innerHTML=`<i class="fas fa-users mr-2"></i> Pour ${t.servings} ${t.servings>1?"personnes":"personne"}`,n.appendChild(c)}const r=document.createElement("h4");r.className="font-bold mb-2 text-gray-800",r.textContent="Ingrédients :",n.appendChild(r);const s=document.createElement("ul");s.className="space-y-1 text-gray-600",t.ingredients.forEach(c=>{const d=document.createElement("li");d.textContent=`• ${c.quantity||""} ${c.unit||""} ${c.name}`.trim(),s.appendChild(d)}),n.appendChild(s)}else n.textContent="Aucun ingrédient spécifié pour cette recette.";document.body.appendChild(n);const i=e.closest(".meal-card").getBoundingClientRect(),a=n.getBoundingClientRect();if(window.innerWidth<768){n.style.width="90vw",n.style.maxWidth="320px";const r=n.getBoundingClientRect();let s=i.bottom+10,c=(window.innerWidth-r.width)/2;s+r.height>window.innerHeight&&(s=i.top-r.height-10),n.style.top=`${s}px`,n.style.left=`${c}px`}else{let r=i.right+10;r+a.width>window.innerWidth&&(r=i.left-a.width-10);let s=i.top;s+a.height>window.innerHeight&&(s=i.bottom-a.height),s<10&&(s=10),n.style.left=`${r}px`,n.style.top=`${s}px`}n.style.position="fixed"}function Be(e,t=!1){const n=document.createElement("div"),i=document.createElement("button");return t?(n.className="w-full flex justify-center pt-1",i.className="add-more-meal-btn text-gray-400 hover:text-green-500 transition-colors duration-150",i.innerHTML='<i class="fas fa-plus-circle"></i>',i.title="Ajouter une autre recette"):(n.className="flex items-center justify-center h-full",i.className="add-meal-btn text-green-500 hover:text-green-700 transition-transform duration-150 hover:scale-125",i.innerHTML='<i class="fas fa-plus-circle text-lg"></i>'),i.addEventListener("click",()=>we(e)),n.appendChild(i),n}function Me(e,t,n=!1){if(n){const a=document.createElement("p");return a.className="w-full h-full p-1 text-xs text-gray-700",a.textContent=t[e]||"",a}const i=document.createElement("textarea");return i.className="w-full h-full p-1 text-xs bg-white border-0 rounded focus:outline-none focus:ring-1 focus:ring-tomato resize-none",i.placeholder="Remarque...",i.value=F[e]||"",i.dataset.slotId=e,i.addEventListener("change",a=>{const o=a.target.value;o?F[e]=o:delete F[e];const[r,s]=e.split("-"),m=`a modifié la remarque pour ${_[parseInt(r,10)]} ${s==="lunch"?"midi":"soir"}`;V({[`weeks.${$}.remarksData`]:F},m)}),i.addEventListener("focus",a=>{ve({type:"editing_remark",fieldId:e})}),i.addEventListener("blur",a=>{ve("idle")}),i}function at(){document.querySelectorAll(".meal-card").forEach(e=>{e.addEventListener("dragstart",Ye),e.addEventListener("dragend",Xe)}),document.querySelectorAll(".meal-slot").forEach(e=>{e.addEventListener("dragover",Ze),e.addEventListener("dragleave",et),e.addEventListener("drop",tt)})}async function st(e,t){const n=JSON.parse(JSON.stringify(g)),i=n[e],a={id:t.id};Array.isArray(i)?i.push(a):n[e]=[a];const[o,r]=e.split("-"),s=_[parseInt(o,10)],c=r==="lunch"?"midi":"soir",d=`a ajouté '${t.name}' à ${s} ${c}`;await V({[`weeks.${$}.menuData`]:n},d),de()}async function rt(e,t){if(!u||!g[e]||!Array.isArray(g[e]))return;const n=g[e][t],i=JSON.parse(JSON.stringify(g));i[e].splice(t,1),i[e].length===0&&delete i[e];const[a,o]=e.split("-"),r=_[parseInt(a,10)],s=o==="lunch"?"midi":"soir",c=`a supprimé '${n.name}' de ${r} ${s}`;await V({[`weeks.${$}.menuData`]:i},c)}async function Se(){if(confirm("Voulez-vous vraiment vider le menu de cette semaine ?")){const e={id:availablePlans.length>0?availablePlans[0].id:`${ye()}_semaine-${$}`,name:availablePlans.length>0?availablePlans[0].name:"Mon plan",menuData:{},servingsData:{},remarksData:{},defaultNumPeople:j,startDay:T,lastUpdated:new Date};loadPlan(e),availablePlans.length>0?availablePlans[0]=e:availablePlans.push(e),await V({[`weeks.${$}`]:{menuData:{},servingsData:{},remarksData:{}}},`a vidé le menu de la semaine ${$}`)}}function De(e){e>=1&&e<=52&&($=e,Ee())}function ot(){l.currentWeekDisplay&&(l.currentWeekDisplay.textContent=`Semaine ${$}`)}function it(){l.prevWeekBtn?.addEventListener("click",()=>De($-1)),l.nextWeekBtn?.addEventListener("click",()=>De($+1)),l.clearMenuBtn?.addEventListener("click",Se),l.startDaySelect?.addEventListener("change",async n=>{T=n.target.value,u&&await V({startDay:T},`a changé le premier jour de la semaine à '${T}'`)}),l.planSelect?.addEventListener("change",Ne),l.closeMealSelectModalBtn?.addEventListener("click",de),l.mealSelectModal?.addEventListener("click",n=>{n.target===l.mealSelectModal&&de()}),l.closeRecipeModalBtn?.addEventListener("click",()=>G.closeForm()),l.cancelRecipeBtn?.addEventListener("click",()=>G.closeForm()),l.importListBtn?.addEventListener("click",Ve),l.closeImportListModalBtn?.addEventListener("click",pe),l.importListModal?.addEventListener("click",n=>{n.target===l.importListModal&&pe()}),l.exportTxtBtn?.addEventListener("click",Je),l.exportPdfBtn?.addEventListener("click",Ge),l.exportPlanPdfBtn?.addEventListener("click",Ke);const e=n=>{const i=n.target.closest(".info-meal-btn");if(i){const a=i.dataset.slotId,o=parseInt(i.dataset.mealIndex,10);if(a&&!isNaN(o)){const r=g[a]?.[o];if(r&&r.id){const s=z.find(c=>c.id===r.id);s&&nt(i,s)}}}};l.mealPlanGrid?.addEventListener("click",e),document.getElementById("mobile-meal-plan")?.addEventListener("click",e),l.sharePlanBtn?.addEventListener("click",()=>{if(!u){alert("Veuillez sélectionner un plan à partager.");return}Dt({plan:u})}),l.inviteParticipantBtn?.addEventListener("click",()=>{if(!u){alert("Veuillez sélectionner un plan pour inviter des participants.");return}Nt(u)}),l.historyPlanBtn?.addEventListener("click",ze),l.closePlanHistoryModalBtn?.addEventListener("click",me),l.planHistoryModal?.addEventListener("click",n=>{n.target===l.planHistoryModal&&me()}),l.openTrashBtn?.addEventListener("click",()=>{l.trashModal.classList.remove("hidden")}),l.closeTrashModalBtn?.addEventListener("click",()=>{l.trashModal.classList.add("hidden")}),l.trashModal?.addEventListener("click",n=>{n.target===l.trashModal&&l.trashModal.classList.add("hidden")}),l.savePlanBtn?.addEventListener("click",async()=>{if(!u){alert("Veuillez sélectionner un plan de travail avant de sauvegarder.");return}const n=document.getElementById("save-plan-as-modal"),i=document.getElementById("save-plan-as-form"),a=document.getElementById("save-plan-name"),o=document.getElementById("cancel-save-plan-as-btn"),r=document.getElementById("close-save-plan-as-modal"),s=new Date().toLocaleDateString("fr-FR"),c=u.weeks?Object.keys(u.weeks).filter(f=>u.weeks[f]&&Object.keys(u.weeks[f].menuData||{}).length>0).length:0,d=c>1?`${c} semaines`:`${c} semaine`;a.value=`${u.name} (${d}) - ${s}`,n.classList.remove("hidden");const m=async f=>{f.preventDefault();const y=a.value;if(!y)return;u.weeks||(u.weeks={}),u.weeks[$]={menuData:g,servingsData:R,remarksData:F},u.startDay=T,u.defaultNumPeople=j;const h=JSON.parse(JSON.stringify(u));if(h.weeks)for(const C in h.weeks){const v=h.weeks[C];if(v&&v.menuData)for(const E in v.menuData){const w=v.menuData[E];Array.isArray(w)&&(v.menuData[E]=w.map(k=>k&&k.id&&z.find(A=>A.id===k.id)||k))}}await ft(y,h),n.classList.add("hidden"),i.removeEventListener("submit",m)},p=()=>{n.classList.add("hidden"),i.removeEventListener("submit",m)};i.addEventListener("submit",m,{once:!0}),o.addEventListener("click",p,{once:!0}),r.addEventListener("click",p,{once:!0})})}function lt(e=""){return e.split(" ").map(i=>i[0]).join("").substring(0,2).toUpperCase()}function fe(e=[],t={}){const n=document.getElementById("collaborators-bar"),i=document.getElementById("activity-labels-container"),a=document.getElementById("name-tooltip");if(!n||!a||!i)return;if(n.innerHTML="",i.innerHTML="",document.querySelectorAll(".remark-lock-overlay").forEach(s=>s.remove()),document.querySelectorAll("textarea[data-slot-id]").forEach(s=>{s.disabled=!1}),e.length<=1&&Object.keys(t).length<=1){n.classList.add("hidden");return}let o="";const r=ye();e.forEach(s=>{if(!s)return;const c=t.hasOwnProperty(s.uid),d=t[s.uid]||{},m=document.createElement("div");m.className="w-8 h-8 rounded-full flex items-center justify-center bg-gray-300 text-white font-bold text-xs ring-2 ring-white cursor-pointer transition-all duration-300";const p=c?"(présent)":"(absent)";if(m.dataset.name=`${s.displayName||"Inconnu"} ${p}`,s.photoURL?m.innerHTML=`<img src="${s.photoURL}" alt="${s.displayName}" class="w-full h-full rounded-full object-cover">`:m.textContent=lt(s.displayName),c||m.classList.add("grayscale","opacity-50"),m.addEventListener("mouseenter",f=>{a.textContent=f.currentTarget.dataset.name,a.classList.remove("hidden");const y=f.currentTarget.getBoundingClientRect();a.style.left=`${y.left+y.width/2-a.offsetWidth/2}px`,a.style.top=`${y.top-a.offsetHeight-5}px`}),m.addEventListener("mouseleave",()=>{a.classList.add("hidden")}),n.appendChild(m),c&&s.uid!==r){const f=d.status;if(typeof f=="object"&&f.type==="editing_remark"){const y=document.querySelector(`textarea[data-slot-id="${f.fieldId}"]`);if(y){y.disabled=!0;const h=document.createElement("div");h.className="remark-lock-overlay absolute inset-0 bg-gray-400 bg-opacity-25 flex items-center justify-center text-xs text-white font-bold",h.innerHTML=`<i class="fas fa-lock mr-1"></i> ${s.displayName} écrit...`,y.parentElement&&(y.parentElement.classList.add("relative"),y.parentElement.appendChild(h))}}else if(typeof f=="string"&&f!=="idle"){let y="";switch(f){case"editing_recipe":y="modifie une recette...";break}y&&(o+=`<span class="italic mr-4">${s.displayName} ${y}</span>`)}}}),i.innerHTML=o,n.classList.remove("hidden")}function Ne(){Pt();const e=l.planSelect.value;e&&localStorage.setItem("lastActivePlanId",e),u=xe.find(r=>r.id===e)||null;const t=document.getElementById("delete-plan-btn"),n=document.getElementById("rename-plan-btn"),i=document.getElementById("leave-plan-btn"),a=document.getElementById("invite-participant-btn"),o=document.getElementById("history-plan-btn");if(t&&(t.style.display=u&&u.isOwner?"inline-flex":"none"),n&&(n.style.display=u&&u.isOwner?"inline-flex":"none"),o&&(o.style.display=u&&u.isOwner?"inline-flex":"none"),i&&(i.style.display=u&&!u.isOwner?"inline-flex":"none"),a){const r=u&&(u.type==="collaborative"||u.collaborators&&u.collaborators.length>0);a.style.display=u&&u.isOwner&&r?"inline-flex":"none"}u&&u.participants&&u.participants.length>1?(fe(u.participants,{}),$t(u.id,r=>{fe(u.participants,r)})):fe([],{}),u&&(u.manualItems=u.manualItems||[]),Ee()}async function $e(e,t){if(!u)return;const n=JSON.parse(JSON.stringify(R));t===j?delete n[e]:n[e]=t;const[i,a]=e.split("-"),s=`a changé le nombre de personnes pour ${_[parseInt(i,10)]} ${a==="lunch"?"midi":"soir"} à ${t}`;await V({[`weeks.${$}.servingsData`]:n},s)}async function ct(){if(!B)return;const e=mt();it(),We(),await Le();const t=Et(oe(B,"recipes"),i=>{if(console.log("Recipe data updated from listener."),z=i.docs.map(a=>{const o=a.data();return{id:a.id,...o,imageUrl:o.imageUrl||""}}),u){for(const a in g){const o=g[a];if(Array.isArray(o)){const r=o.map(s=>{if(s&&s.id){const c=z.find(d=>d.id===s.id);return c?{...c}:s}return s});g[a]=r}}le(l.mealPlanGrid,{menuData:g,servingsData:R,remarksData:F,defaultNumPeople:j,startDay:T},!1),be(document.getElementById("mobile-meal-plan"),{menuData:g,servingsData:R,remarksData:F,defaultNumPeople:j,startDay:T},!1),ce()}}),n=pt(i=>{xe=i,yt(i);const a=localStorage.getItem("selectedPlanId"),o=localStorage.getItem("lastActivePlanId");a&&i.some(r=>r.id===a)?(l.planSelect.value=a,localStorage.removeItem("selectedPlanId")):o&&i.some(r=>r.id===o)&&(l.planSelect.value=o),Ne()});return()=>{n(),t(),e()}}const dt=ct();return async()=>{const e=await dt;typeof e=="function"&&e()}}export{Rt as default};
