const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/main-3FHrQZxb.js","assets/firebase-config-DVWBM_53.js","assets/firebase-config-X9jPWnzj.css"])))=>i.map(i=>d[i]);
import{_ as G,g as ee,b as le}from"./main-3FHrQZxb.js";import{b as O,o as de,g as te,c as ne,k as ue,j as me}from"./firebase-config-DVWBM_53.js";const B=ue();let Q=null,$=null,ae=[],se=[],A={},R=[];const ge={"fruits & légumes":"fa-carrot","produits laitiers":"fa-cheese",fromagerie:"fa-cheese",boucherie:"fa-drumstick-bite",viande:"fa-drumstick-bite",poissonnerie:"fa-fish",poisson:"fa-fish",épicerie:"fa-box",boissons:"fa-wine-glass",boulangerie:"fa-bread-slice",pain:"fa-bread-slice",dph:"fa-soap",hygiène:"fa-soap",surgelés:"fa-snowflake",entrée:"fa-utensils",plat:"fa-concierge-bell",accompagnement:"fa-plate-wheat",dessert:"fa-ice-cream",inconnue:"fa-question"};function q(k){return k?k.replace(/\./g,"_"):""}function fe(){let k=document.getElementById("shopping-mode-container");const j=document.getElementById("shopping-mode-plan-select"),Y=document.getElementById("shopping-mode-trash-btn"),V=document.getElementById("shopping-trash-modal");let z=null;function X(s){console.log(`[DEBUG] updateTrashUI called with ${s?s.length:"null"} items`);const n=document.getElementById("shopping-mode-trash-btn"),t=document.getElementById("shopping-mode-trash-count"),p=document.getElementById("shopping-trash-modal"),v=document.getElementById("shopping-trash-list"),C=document.getElementById("close-shopping-trash-modal"),g=document.getElementById("shopping-empty-trash-btn");if(n&&(s&&s.length>0?(n.classList.remove("hidden"),t&&(t.textContent=s.length)):(n.classList.add("hidden"),t&&(t.textContent="0"))),p&&C&&(C.onclick=()=>p.classList.add("hidden"),p.onclick=e=>{e.target===p&&p.classList.add("hidden")}),s&&s.length>0){if(g){g.classList.remove("hidden");const e=g.cloneNode(!0);g.parentNode.replaceChild(e,g),e.addEventListener("click",async()=>{if(!$||!confirm("Tout supprimer définitivement ?"))return;const u=O(B,"plans",$.id),h=s.map(N=>q(`${N.name}_${N.unit||""}`));try{await G(()=>import("./main-3FHrQZxb.js").then(N=>N.l),__vite__mapDeps([0,1,2])).then(N=>{N.updateDoc(u,{hiddenTrashItems:N.arrayUnion(...h),lastUpdated:new Date})}),p.classList.add("hidden")}catch(N){console.error("Erreur vidage corbeille:",N)}})}if(v){v.innerHTML="";const e=document.createElement("ul");e.className="space-y-3",s.forEach(u=>{const h=document.createElement("li");h.className="flex items-center p-3 rounded-lg bg-gray-100 shadow-inner justify-between";const N=document.createElement("div");N.className="flex-grow ml-2 overflow-hidden";const o=document.createElement("span");o.className="font-medium text-base text-gray-500 line-through block truncate",o.textContent=u.name,N.appendChild(o);const c=document.createElement("div");c.className="flex items-center space-x-2 flex-shrink-0";const i=document.createElement("button");i.className="text-blue-600 hover:text-blue-800 font-medium text-sm px-3 py-1 border border-blue-300 rounded-full hover:bg-blue-50 transition-colors",i.innerHTML='<i class="fas fa-undo"></i>',i.addEventListener("click",async()=>{if(!$)return;const m=O(B,"plans",$.id);try{await G(()=>import("./main-3FHrQZxb.js").then(d=>d.l),__vite__mapDeps([0,1,2])).then(async d=>{await d.runTransaction(B,async l=>{const r=await l.get(m);if(!r.exists())return;const y=(r.data().manualItems||[]).filter(E=>!(E.name.toLowerCase()===u.name.toLowerCase()&&E.unit===u.unit));l.update(m,{manualItems:y,lastUpdated:new Date})}),s.length<=1&&p.classList.add("hidden")})}catch(d){console.error(d)}});const a=document.createElement("button");a.className="text-gray-400 hover:text-red-600 font-medium text-sm px-2 py-1",a.innerHTML='<i class="fas fa-times text-lg"></i>',a.addEventListener("click",async()=>{if(!$)return;const m=O(B,"plans",$.id),d=q(`${u.name}_${u.unit||""}`);try{await G(()=>import("./main-3FHrQZxb.js").then(l=>l.l),__vite__mapDeps([0,1,2])).then(l=>{l.updateDoc(m,{hiddenTrashItems:l.arrayUnion(d),lastUpdated:new Date})}),s.length<=1&&p.classList.add("hidden")}catch(l){console.error(l)}}),c.appendChild(i),c.appendChild(a),h.appendChild(N),h.appendChild(c),e.appendChild(h)}),v.appendChild(e)}}else v&&(v.innerHTML='<p class="text-center text-gray-500 italic py-4">La corbeille est vide.</p>'),g&&g.classList.add("hidden")}function oe(){console.log("[DEBUG] Resetting UI and State"),$=null,k&&(k.innerHTML='<div class="flex justify-center p-10"><i class="fas fa-spinner fa-spin text-tomato text-2xl"></i></div>'),V&&V.classList.add("hidden"),X([])}Y&&V&&Y.addEventListener("click",()=>{V.classList.remove("hidden")});function K(s){console.log(`[DEBUG] loadPlan called for: ${s}`),z=s,Q&&(console.log("[DEBUG] Unsubscribing from previous plan"),Q(),Q=null),oe();const n=O(B,"plans",s);Q=de(n,t=>{if(console.log(`[DEBUG] Snapshot received for doc: ${t.id}`),z!==s){console.warn(`[DEBUG] Ignored snapshot for ${s} because active is ${z}`);return}t.exists()?(console.log(`[DEBUG] Plan data found for ID: ${t.id}`),$={id:t.id,...t.data()},A=$.checkedItems||{},Z()):(console.log("[DEBUG] Plan not found"),k&&(k.innerHTML='<p class="text-center p-4 text-red-500">Menu introuvable.</p>'))})}function Z(){if(!$||!k){console.log("[DEBUG] renderShoppingList aborted: missing plan or container");return}console.log(`[DEBUG] Rendering shopping list for menu: ${$.name} (${$.id})`);const{active:s,deleted:n}=re($);console.log(`[DEBUG] Computed deletedItems: ${n.length} items`),X(n),k.innerHTML="";const t=[],p=[];if(s.forEach(o=>{const c=`${o.name}_${o.unit||""}`,i=q(c);(A.hasOwnProperty(i)?A[i]:A[c]||!1)?p.push(o):t.push(o)}),t.length===0&&p.length===0){k.innerHTML='<p class="text-center p-10 text-gray-500">Votre liste de courses est vide pour ce menu.</p>';return}const v=t.reduce((o,c)=>{const i=c.category||"Inconnue";return o[i]||(o[i]=[]),o[i].push(c),o},{}),C=Object.keys(v).sort((o,c)=>{if(R&&R.length>0){const i=R.indexOf(o),a=R.indexOf(c);if(i!==-1&&a!==-1)return i-a;if(i!==-1)return-1;if(a!==-1)return 1}return o==="Inconnue"?1:c==="Inconnue"?-1:o.localeCompare(c)}),g=document.createElement("div");g.className="flex justify-end px-4 mb-4 space-x-2";const e=document.createElement("button");e.className="text-sm font-medium text-gray-500 bg-white hover:bg-gray-50 px-3 py-2 rounded-lg transition-colors flex items-center shadow-sm border border-gray-200",e.innerHTML='<i class="fas fa-lightbulb mr-2"></i> Écran',e.title="Garder l'écran allumé";let u=null;e.onclick=async()=>{if("wakeLock"in navigator)if(u)await u.release(),u=null,e.classList.remove("text-yellow-600","bg-yellow-50","border-yellow-200"),e.classList.add("text-gray-500","bg-white","border-gray-200"),e.innerHTML='<i class="fas fa-lightbulb mr-2"></i> Écran';else try{u=await navigator.wakeLock.request("screen"),e.classList.remove("text-gray-500","bg-white","border-gray-200"),e.classList.add("text-yellow-600","bg-yellow-50","border-yellow-200"),e.innerHTML='<i class="fas fa-lightbulb mr-2"></i> Actif',u.addEventListener("release",()=>{console.log("Wake Lock released"),u=null,e.classList.contains("text-gray-500")||(e.classList.remove("text-yellow-600","bg-yellow-50","border-yellow-200"),e.classList.add("text-gray-500","bg-white","border-gray-200"),e.innerHTML='<i class="fas fa-lightbulb mr-2"></i> Écran')})}catch(o){console.error(`${o.name}, ${o.message}`),alert("Impossible de garder l'écran allumé (Batterie faible ?)")}else alert("Votre navigateur ne supporte pas le verrouillage d'écran.")},document.addEventListener("visibilitychange",async()=>{if(u!==null&&document.visibilityState==="visible")try{u=await navigator.wakeLock.request("screen")}catch(o){console.error("Re-acquire wake lock failed",o),u=null,e.classList.remove("text-yellow-600","bg-yellow-50","border-yellow-200"),e.classList.add("text-gray-500","bg-white","border-gray-200"),e.innerHTML='<i class="fas fa-lightbulb mr-2"></i> Écran'}});const h=document.createElement("button");h.className="text-sm font-medium text-tomato bg-orange-50 hover:bg-orange-100 px-3 py-2 rounded-lg transition-colors flex items-center shadow-sm border border-orange-100",h.innerHTML='<i class="fas fa-sort mr-2"></i> Organiser',h.onclick=()=>N(C),g.appendChild(h),k.appendChild(g);function N(o){const c=document.createElement("div");c.className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[200] p-4";const i=document.createElement("div");i.className="bg-white rounded-xl w-full max-w-md max-h-[85vh] flex flex-col shadow-2xl overflow-hidden";const a=document.createElement("div");a.className="p-4 border-b flex justify-between items-center bg-gray-50",a.innerHTML='<h3 class="font-bold text-lg text-gray-800">Ordre des Rayons</h3>';const m=document.createElement("button");m.className="text-gray-400 hover:text-gray-600",m.innerHTML='<i class="fas fa-times text-xl"></i>',m.onclick=()=>c.remove(),a.appendChild(m),i.appendChild(a);const d=document.createElement("div");d.className="overflow-y-auto p-2 flex-grow bg-gray-50";const l=document.createElement("ul");l.className="space-y-2",o.forEach(E=>{const b=document.createElement("li");b.className="flex items-center p-3 bg-white border border-gray-200 rounded-lg shadow-sm cursor-grab active:cursor-grabbing hover:border-tomato transition-colors",b.dataset.category=E;const f=ge[E.toLowerCase()]||"fa-tag";b.innerHTML=`
                    <div class="text-gray-400 mr-3 cursor-grab"><i class="fas fa-grip-lines"></i></div>
                    <div class="w-8 h-8 rounded-full bg-orange-100 flex items-center justify-center mr-3 text-tomato">
                        <i class="fas ${f} text-sm"></i>
                    </div>
                    <span class="font-medium text-gray-700 flex-grow">${E}</span>
                `,l.appendChild(b)}),d.appendChild(l),i.appendChild(d);const r=document.createElement("div");r.className="p-4 border-t bg-white flex justify-end space-x-3";const w=document.createElement("button");w.className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg font-medium",w.textContent="Annuler",w.onclick=()=>c.remove();const y=document.createElement("button");y.className="px-6 py-2 bg-tomato text-white rounded-lg font-medium shadow-md hover:bg-tomato-dark transition-transform active:scale-95",y.innerHTML='<i class="fas fa-check mr-2"></i> Valider',y.onclick=async()=>{const E=Array.from(l.children).map(f=>f.dataset.category);console.log("[DEBUG] New manual category order:",E),R=E;const b=ee();if(b){const f=O(B,"users",b);try{await G(()=>import("./main-3FHrQZxb.js").then(T=>T.l),__vite__mapDeps([0,1,2])).then(T=>{T.updateDoc(f,{shoppingCategoryOrder:E,lastUpdated:new Date})})}catch(T){console.error("Error saving category order",T)}}c.remove(),Z()},r.appendChild(w),r.appendChild(y),i.appendChild(r),c.appendChild(i),document.body.appendChild(c),window.Sortable&&new Sortable(l,{animation:150,handle:".cursor-grab",ghostClass:"opacity-50",chosenClass:"bg-orange-50"})}if(C.forEach(o=>{const c=document.createElement("h3");c.className="font-bold text-lg text-gray-700 mt-6 mb-3 border-b border-gray-200 pb-1",c.textContent=o,k.appendChild(c);const i=document.createElement("ul");i.className="space-y-3",v[o].sort((a,m)=>a.name.localeCompare(m.name)).forEach(a=>{const m=`${a.name}_${a.unit||""}`,d=q(m),l=A.hasOwnProperty(d)?A[d]:A[m]||!1,r=a.hasManualEntry===!0||!a.sources||a.sources.length===0,w=document.createElement("li");r&&(w.dataset.isManual="true",w.style.backgroundColor="#ffedd5");const y=l?"bg-gray-100":r?"bg-orange-100 shadow-sm border border-orange-200":"bg-white shadow-sm border border-gray-100";w.className=`flex flex-col p-3 rounded-lg transition-colors duration-200 ${y}`;const E=document.createElement("div");E.className="flex items-center w-full";const b=document.createElement("input");b.type="checkbox",b.className="form-checkbox h-6 w-6 text-tomato rounded-full border-gray-300 focus:ring-tomato cursor-pointer transition duration-150 ease-in-out",b.checked=l;const f=document.createElement("div");f.className="ml-3 flex-grow cursor-pointer select-none";const T=Number.isInteger(a.totalQuantity)?a.totalQuantity:parseFloat(a.totalQuantity.toFixed(2)),L=document.createElement("span");L.className=`font-medium text-base ${l?"line-through text-gray-400":"text-gray-800"}`,L.textContent=a.name;const D=document.createElement("span");D.className=`ml-2 font-bold text-base ${l?"text-gray-400":"text-gray-800"}`,D.textContent=` - ${T} ${a.unit||""}`.trim(),f.appendChild(L),f.appendChild(D);const P=()=>{const x=!b.checked;b.checked=x,F(d,x,w,b,L,D)};if(b.addEventListener("change",x=>{F(d,x.target.checked,w,b,L,D)}),f.addEventListener("click",P),E.appendChild(b),E.appendChild(f),w.appendChild(E),a.sources&&a.sources.length>0){const x=document.createElement("div");x.className="mt-2 ml-9 text-xs text-gray-500 space-y-1";const H=a.sources.reduce((S,I)=>{const J=I.servings?` - ${I.servings} pers.`:"",M=`${I.recipeName} (${I.day} ${I.time})${J}`;return S[M]||(S[M]=0),S[M]+=I.quantity,S},{});for(const S in H){const I=document.createElement("div");I.textContent=`↳ ${S}`,x.appendChild(I)}w.appendChild(x)}i.appendChild(w)}),k.appendChild(i)}),p.length>0){const o=document.createElement("div");o.className="my-8 border-t-2 border-dashed border-gray-300 pt-4 text-center";const c=document.createElement("h3");c.className="text-lg font-semibold text-gray-500",c.textContent="Articles cochés",o.appendChild(c),k.appendChild(o);const i=p.reduce((m,d)=>{const l=d.category||"Inconnue";return m[l]||(m[l]=[]),m[l].push(d),m},{});Object.keys(i).sort((m,d)=>m==="Inconnue"?1:d==="Inconnue"?-1:m.localeCompare(d)).forEach(m=>{const d=document.createElement("h3");d.className="font-bold text-lg text-gray-700 mt-6 mb-3 border-b border-gray-200 pb-1",d.textContent=m,k.appendChild(d);const l=document.createElement("ul");l.className="space-y-3",i[m].sort((r,w)=>r.name.localeCompare(w.name)).forEach(r=>{const w=`${r.name}_${r.unit||""}`,y=q(w),E=!0,b=r.hasManualEntry===!0||!r.sources||r.sources.length===0,f=document.createElement("li");b&&(f.dataset.isManual="true"),f.className="flex flex-col p-3 rounded-lg transition-colors duration-200 bg-gray-100";const T=document.createElement("div");T.className="flex items-center w-full";const L=document.createElement("input");L.type="checkbox",L.className="form-checkbox h-6 w-6 text-tomato rounded-full border-gray-300 focus:ring-tomato cursor-pointer transition duration-150 ease-in-out",L.checked=E;const D=document.createElement("div");D.className="ml-3 flex-grow cursor-pointer select-none";const P=Number.isInteger(r.totalQuantity)?r.totalQuantity:parseFloat(r.totalQuantity.toFixed(2)),x=document.createElement("span");x.className="font-medium text-base line-through text-gray-400",x.textContent=r.name;const H=document.createElement("span");H.className="ml-2 font-bold text-base text-gray-400",H.textContent=` - ${P} ${r.unit||""}`.trim(),D.appendChild(x),D.appendChild(H);const S=()=>{const I=!L.checked;L.checked=I,F(y,I,f,L,x,H)};if(L.addEventListener("change",I=>{F(y,I.target.checked,f,L,x,H)}),D.addEventListener("click",S),T.appendChild(L),T.appendChild(D),f.appendChild(T),r.sources&&r.sources.length>0){const I=document.createElement("div");I.className="mt-2 ml-9 text-xs text-gray-400 space-y-1";const J=r.sources.reduce((M,U)=>{const ie=U.servings?` - ${U.servings} pers.`:"",W=`${U.recipeName} (${U.day} ${U.time})${ie}`;return M[W]||(M[W]=0),M[W]+=U.quantity,M},{});for(const M in J){const U=document.createElement("div");U.textContent=`↳ ${M}`,I.appendChild(U)}f.appendChild(I)}l.appendChild(f)}),k.appendChild(l)})}}function F(s,n,t,p,v,C){if(!$)return;const g=t.dataset.isManual==="true";n?(t.classList.remove("bg-white","bg-orange-100","shadow-sm","border","border-gray-100","border-orange-200"),t.classList.add("bg-gray-100"),t.style.backgroundColor="",v.classList.add("line-through","text-gray-400"),v.classList.remove("text-gray-800"),C.classList.add("text-gray-400"),C.classList.remove("text-gray-800")):(t.classList.remove("bg-gray-100"),g?(t.classList.add("bg-orange-100","shadow-sm","border","border-orange-200"),t.style.backgroundColor="#ffedd5"):(t.classList.add("bg-white","shadow-sm","border","border-gray-100"),t.style.backgroundColor=""),v.classList.remove("line-through","text-gray-400"),v.classList.add("text-gray-800"),C.classList.remove("text-gray-400"),C.classList.add("text-gray-800"));const e=O(B,"plans",$.id),u={};u[`checkedItems.${s}`]=n,u.lastUpdated=new Date,G(()=>import("./main-3FHrQZxb.js").then(h=>h.l),__vite__mapDeps([0,1,2])).then(h=>{h.updateDoc(e,u)}).catch(h=>{console.error("Error updating checked item:",h)})}function re(s){const n=new Map;(s.manualItems||[]).forEach(e=>{const u=`${e.name.trim().toLowerCase()}_${e.unit||""}`;n.set(u,{name:e.name.trim(),totalQuantity:e.totalQuantity,unit:e.unit,category:e.category||"Inconnue",hasManualEntry:!0})});const p=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];if(s.weeks)for(const e in s.weeks){const u=s.weeks[e],h=u.menuData||{},N=u.servingsData||{};for(const o in h){const c=h[o];if(!Array.isArray(c))continue;const[i,a]=o.split("-"),m=`${i}-${a}`,d=parseInt(N[m]||s.defaultNumPeople||1,10);c.forEach(l=>{const r=ae.find(y=>y.id===l.id)||l;if(!r||!r.ingredients)return;const w=r.servings||1;r.ingredients.forEach(y=>{if(!y.name||!y.quantity)return;const E=se.find(x=>x.name.toLowerCase()===y.name.toLowerCase()),b=E?E.category:"Inconnue",f=parseFloat(String(y.quantity).replace(",","."));if(isNaN(f))return;const L=f/w*d,D=y.unit||"",P=`${y.name.trim().toLowerCase()}_${D}`;if(n.has(P)){const x=n.get(P);x.totalQuantity+=L,x.sources||(x.sources=[]),x.sources.push({recipeName:r.name,day:p[parseInt(i,10)],time:a==="lunch"?"Midi":"Soir",quantity:L,servings:d})}else n.set(P,{name:y.name.trim(),totalQuantity:L,unit:D,category:b,sources:[{recipeName:r.name,day:p[parseInt(i,10)],time:a==="lunch"?"Midi":"Soir",quantity:L,servings:d}]})})})}}const v=[],C=[],g=s.hiddenTrashItems||[];return n.forEach(e=>{if(e.totalQuantity>0)v.push(e);else if(e.totalQuantity<=0&&e.sources&&e.sources.length>0){const u=`${e.name}_${e.unit||""}`,h=q(u);!g.includes(h)&&!g.includes(u)&&C.push(e)}}),{active:v,deleted:C}}const _=document.createElement("button");if(_.id="scroll-to-top-btn",_.className="hidden fixed bottom-20 right-5 bg-tomato text-white rounded-full w-12 h-12 shadow-lg z-50",_.innerHTML='<i class="fas fa-arrow-up"></i>',document.body.appendChild(_),window.addEventListener("scroll",()=>{window.pageYOffset>200?_.classList.remove("hidden"):_.classList.add("hidden")}),_.addEventListener("click",()=>{window.scrollTo({top:0,behavior:"smooth"})}),j){const s=j.cloneNode(!0);j.parentNode.replaceChild(s,j),s.addEventListener("change",n=>{const t=n.target.value;localStorage.setItem("lastActivePlanId",t),K(t)})}async function ce(){const s=ee();if(s)try{const n=await me(O(B,"users",s));n.exists()&&(R=n.data().shoppingCategoryOrder||[])}catch(n){console.error("Error fetching user preferences",n)}try{se=(await te(ne(B,"ingredients"))).docs.map(t=>({id:t.id,...t.data()}))}catch(n){console.error("Error fetching ingredients",n)}try{ae=(await te(ne(B,"recipes"))).docs.map(t=>({id:t.id,...t.data()}))}catch(n){console.error("Error fetching recipes",n)}le(n=>{const t=document.getElementById("shopping-mode-plan-select");if(!t)return;const p=t.value;if(t.innerHTML="",n.length===0){k&&(k.innerHTML='<p class="text-center p-4">Aucun menu trouvé.</p>');return}n.forEach(g=>{const e=document.createElement("option");e.value=g.id,e.textContent=g.name,t.appendChild(e)});const v=localStorage.getItem("lastActivePlanId");let C=null;v&&n.some(g=>g.id===v)?C=v:n.length>0&&(C=n[0].id),C&&(p&&n.some(g=>g.id===p)?(t.value=p,$||K(p)):(t.value=C,K(C)))})}return ce(),()=>{Q&&Q(),_&&_.remove()}}export{fe as default};
