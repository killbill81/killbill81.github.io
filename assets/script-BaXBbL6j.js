import{d as x,c as ee,g as se,b as ze,a as te,u as re,r as _e,h as ge,q as Oe,w as We}from"./main--zY2HtAH.js";import{RecipeFormHandler as Ve}from"./form-handler-xDDizNKw.js";import{openShareModal as Ge}from"./sharing-DxU2BjFu.js";import{initPlanManagement as Je,getUserPlans as Ke,populatePlanSelector as Xe}from"./plans-B7vTKjwb.js";let q=null;function nt(){const i={mealPlanGrid:document.getElementById("meal-plan-grid"),currentWeekDisplay:document.getElementById("current-week-display"),prevWeekBtn:document.getElementById("prev-week-btn"),nextWeekBtn:document.getElementById("next-week-btn"),clearMenuBtn:document.getElementById("clear-menu-btn"),shoppingListContainer:document.getElementById("shopping-list"),startDaySelect:document.getElementById("start-day-select"),defaultServingsControl:document.getElementById("default-servings-control"),mealSelectModal:document.getElementById("meal-select-modal"),closeMealSelectModalBtn:document.getElementById("close-meal-select-modal"),mealSelectModalTitle:document.getElementById("meal-select-modal-title"),mealSelectList:document.getElementById("meal-select-list"),recipeFormModal:document.getElementById("edit-recipe-form-modal"),closeRecipeModalBtn:document.getElementById("close-edit-recipe-modal"),cancelRecipeBtn:document.getElementById("edit-cancel-recipe-btn"),recipeForm:document.getElementById("edit-recipe-form"),addItemInput:document.getElementById("add-item-input"),addItemBtn:document.getElementById("add-item-btn"),addItemResults:document.getElementById("add-item-results"),importListBtn:document.getElementById("import-list-btn"),importListModal:document.getElementById("import-list-modal"),closeImportListModalBtn:document.getElementById("close-import-list-modal"),importListContainer:document.getElementById("import-list-container"),exportTxtBtn:document.getElementById("export-txt-btn"),exportPdfBtn:document.getElementById("export-pdf-btn"),sharePlanBtn:document.getElementById("share-plan-btn"),planSelect:document.getElementById("plan-select")};function ye(e,t){const s=document.createElement("div");s.className="flex items-center space-x-2";const a=document.createElement("button");a.className="btn btn-outline btn-xs",a.textContent="-";const n=document.createElement("span");n.className="font-medium text-center w-6",n.textContent=e;const r=document.createElement("button");return r.className="btn btn-outline btn-xs",r.textContent="+",a.addEventListener("click",()=>{let l=parseInt(n.textContent,10);l>1&&(l--,n.textContent=l,t(l))}),r.addEventListener("click",()=>{let l=parseInt(n.textContent,10);l++,n.textContent=l,t(l)}),s.appendChild(a),s.appendChild(n),s.appendChild(r),s}function he(e,t,s,a=!1){const n=document.createElement("div");n.className="flex flex-col items-center justify-center h-full";const r=document.createElement("button");r.className="btn btn-ghost btn-xs p-0 h-4 flex items-center justify-center w-full",r.innerHTML='<i class="fas fa-plus"></i>',r.disabled=a;const l=document.createElement("span");l.className="font-medium text-center text-sm my-1",l.textContent=e;const o=document.createElement("button");return o.className="btn btn-ghost btn-xs p-0 h-4 flex items-center justify-center w-full",o.innerHTML='<i class="fas fa-minus"></i>',o.disabled=a,t&&(r.classList.add("text-white"),l.classList.add("text-white"),o.classList.add("text-white")),a||(r.addEventListener("click",()=>{let d=parseInt(l.textContent,10);d++,l.textContent=d,s(d)}),o.addEventListener("click",()=>{let d=parseInt(l.textContent,10);d>1&&(d--,l.textContent=d,s(d))})),n.appendChild(r),n.appendChild(l),n.appendChild(o),n}q&&q.destroy(),q=new Ve(x,"edit-recipe-form-modal","edit-recipe-form","edit-recipe-modal-title","edit-recipe-id","edit-recipe-name","edit-recipe-category","edit-recipe-servings","edit-recipe-prep-time","edit-recipe-difficulty","edit-recipe-steps","edit-ingredients-list","edit-add-ingredient-btn","edit-save-recipe-btn","close-edit-recipe-modal","edit-cancel-recipe-btn"),q.setOnSaveCallback(async()=>{await ne();for(const e in g){const t=g[e];if(Array.isArray(t)){const s=t.map(a=>{if(a&&a.id){const n=_.find(r=>r.id===a.id);return n?{...n}:a}return a});g[e]=s}}U(i.mealPlanGrid,{menuData:g,servingsData:S,remarksData:b,defaultNumPeople:I,startDay:E},!1),await W()});let N=1,E="Lundi",g={},S={},b={};const P=[];let H=null,_=[],O=[],I=1,oe=[],p=null;function Y(e){return e?e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase():""}async function ve(e){const t=document.getElementById("unit-select-modal"),s=document.getElementById("unit-modal-title"),a=document.getElementById("unit-modal-list"),n=document.getElementById("unit-modal-cancel");return s.textContent=`Choisir une unité pour "${e}"`,a.innerHTML="",new Promise((r,l)=>{const o=["g","kg","ml","l","pièce(s)","c.à.s.","c.à.c.","pincée(s)"],d=c=>{t.classList.add("hidden"),r(c)};o.forEach(c=>{const u=document.createElement("button");u.className="btn btn-outline",u.textContent=c,u.addEventListener("click",()=>d(c)),a.appendChild(u)});const m=()=>{t.classList.add("hidden"),l()};n.addEventListener("click",m,{once:!0}),t.addEventListener("click",c=>{c.target===t&&m()},{once:!0}),t.classList.remove("hidden")})}async function le(){if(x)try{O=(await se(ee(x,"ingredients"))).docs.map(t=>({id:t.id,...t.data()})),O.sort((t,s)=>t.name.localeCompare(s.name))}catch(e){console.error("Erreur lors de la récupération des ingrédients: ",e)}}async function ne(){if(!x)return;const e=ee(x,"recipes");try{_=(await se(e)).docs.map(s=>({id:s.id,...s.data()}))}catch(t){console.error("Error loading available meals from Firebase:",t)}}function ie(){if(!p)g={},S={},b={},I=1,E="Lundi";else{const e=p.weeks?p.weeks[N]||{}:{};g=e.menuData||{},S=e.servingsData||{},b=e.remarksData||{},I=p.defaultNumPeople||1,E=p.startDay||"Lundi"}if(i.startDaySelect&&(i.startDaySelect.value=E),i.defaultServingsControl){i.defaultServingsControl.innerHTML="";const e=ye(I,async t=>{if(I=t,p){const s=te(x,"plans",p.id);await re(s,{defaultNumPeople:t,lastUpdated:new Date})}});i.defaultServingsControl.appendChild(e)}Ae(),U(i.mealPlanGrid,{menuData:g,servingsData:S,remarksData:b,defaultNumPeople:I,startDay:E},!1),W()}function U(e,t,s=!1){if(!e)return;const a=t.menuData||{},n=t.servingsData||{},r=t.remarksData||{},l=t.defaultNumPeople||1,o=t.startDay||"Lundi",d=document.createDocumentFragment(),m=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"],c=["lunch","dinner"],u=5,f=m.indexOf(o);[...m.slice(f),...m.slice(0,f)].forEach(M=>{const C=m.indexOf(M),w=document.createElement("div");w.className="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] items-stretch border-b border-gray-300";const B=document.createElement("div");B.className="font-bold p-2 flex items-center justify-center bg-gray-100 text-sm border-r border-gray-300",B.textContent=M.toUpperCase(),w.appendChild(B),c.forEach(k=>{const h=`${C}-${k}`,Q=n[h]||l,L=n.hasOwnProperty(h),v=document.createElement("div"),T=he(Q,L,F=>{qe(h,F)},s);let G="border-r border-gray-300 flex items-center justify-center transition-colors duration-300";L?G+=" bg-tomato":G+=k==="lunch"?" bg-amber-50":" bg-stone-100",v.className=G,v.appendChild(T),w.appendChild(v);for(let F=0;F<u;F++){const $=`${C}-${k}-${F}`,z=a[$],A=document.createElement("div"),J=V($);let K="meal-slot p-1 min-h-[70px] flex flex-col justify-start border-r border-gray-300";if(K+=k==="lunch"?" bg-amber-50":" bg-stone-100",A.className=K,A.dataset.slotId=$,J==="Remarque")A.appendChild(Pe($,r,s));else if(Array.isArray(z)&&z.length>0){const j=document.createElement("div");j.className="w-full",z.forEach((X,D)=>{j.appendChild(De(X,$,D,s))}),A.appendChild(j),s||A.appendChild(ue($,!0))}else s||A.appendChild(ue($,!1));w.appendChild(A)}}),d.appendChild(w)}),e.innerHTML="",e.appendChild(d),s||$e()}async function xe(){const e=ge();if(!x||!e)return[];try{const t=Oe(ee(x,"shopping_lists"),We("userId","==",e));return(await se(t)).docs.map(r=>({id:r.id,...r.data()})).filter(r=>r.isShared!==!0)}catch(t){return console.error("Erreur de chargement des listes de courses sauvegardées: ",t),[]}}async function Ce(){const e=await xe();if(i.importListContainer.innerHTML="",e.length===0){i.importListContainer.innerHTML='<p class="text-center text-gray-500">Aucune liste sauvegardée.</p>';return}e.forEach(t=>{const s=document.createElement("button");s.className="w-full text-left p-2 hover:bg-gray-100 rounded-lg transition-colors duration-150",s.textContent=t.name,s.addEventListener("click",()=>{confirm(`Voulez-vous vraiment importer les ingrédients de la liste "${t.name}" ?`)&&(t.ingredients.forEach(a=>{const n=parseFloat(String(a.quantity).replace(",","."))||0;R(a.name,n,a.unit)}),ae())}),i.importListContainer.appendChild(s)}),i.importListModal.classList.remove("hidden")}function ae(){i.importListModal.classList.add("hidden")}function Le(){i.addItemInput?.addEventListener("input",()=>{const e=i.addItemInput.value.toLowerCase(),t=i.addItemResults;if(t.innerHTML="",!e){t.classList.add("hidden");return}O.filter(n=>n.name.toLowerCase().includes(e)).forEach(n=>{const r=document.createElement("div");r.className="p-2 hover:bg-gray-100 cursor-pointer",r.textContent=n.name,r.addEventListener("click",()=>{R(n.name,1,n.unit),i.addItemInput.value="",t.classList.add("hidden")}),t.appendChild(r)});const a=document.createElement("div");a.className="p-2 bg-green-50 hover:bg-green-200 cursor-pointer font-bold text-green-700",a.textContent=`+ Créer "${i.addItemInput.value}"`,a.addEventListener("click",async()=>{const n=i.addItemInput.value;try{const r=await ve(n);await ze(ee(x,"ingredients"),{name:n,unit:r}),await le(),R(n,1,r),i.addItemInput.value="",t.classList.add("hidden")}catch{}}),t.appendChild(a),t.classList.remove("hidden")}),i.addItemBtn?.addEventListener("click",()=>{const e=i.addItemInput.value;e&&(R(e,1,""),i.addItemInput.value="",i.addItemResults.classList.add("hidden"))}),document.addEventListener("click",e=>{i.addItemInput&&!i.addItemInput.contains(e.target)&&!i.addItemResults.contains(e.target)&&i.addItemResults.classList.add("hidden")})}function Ee(){if(P.length===0){alert("La liste de courses est vide.");return}const e=P.reduce((n,r)=>{const l=r.category||"Inconnue";return n[l]||(n[l]=[]),n[l].push(r),n},{}),t=Object.keys(e).sort((n,r)=>n==="Inconnue"?1:r==="Inconnue"?-1:n.localeCompare(r));let s=`Liste de courses - GustoPlan

`;t.forEach(n=>{s+=`--- ${n.toUpperCase()} ---
`,e[n].sort((l,o)=>l.name.localeCompare(o.name)).forEach(l=>{let d=`${Number.isInteger(l.totalQuantity)?l.totalQuantity:parseFloat(l.totalQuantity.toFixed(2))} ${l.unit||""} ${l.name}`;if(l.sources&&l.sources.length>0){const m=l.sources.reduce((u,f)=>{const y=`${f.recipeName} (${f.day} ${f.time})`;return u[y]||(u[y]=0),u[y]+=f.quantity,u},{}),c=Object.keys(m).join(" / ");d+=` *** ${c} ***`}s+=d+`
`}),s+=`
`});const a=new Blob([s],{type:"text/plain;charset=utf-8"});saveAs(a,"liste-de-courses.txt")}function be(){if(P.length===0){alert("La liste de courses est vide.");return}const{jsPDF:e}=window.jspdf,t=new e,s=P.reduce((d,m)=>{const c=m.category||"Inconnue";return d[c]||(d[c]=[]),d[c].push(m),d},{}),a=Object.keys(s).sort((d,m)=>d==="Inconnue"?1:m==="Inconnue"?-1:d.localeCompare(m));t.setFontSize(18),t.text("Liste de courses - GustoPlan",14,22);let n=35;const r=t.internal.pageSize.height,l=20,o=()=>{n>r-l&&(t.addPage(),n=20)};a.forEach(d=>{o(),t.setFontSize(14),t.setFont(void 0,"bold"),t.text(`--- ${d.toUpperCase()} ---`,14,n),n+=8,t.setFont(void 0,"normal"),s[d].sort((c,u)=>c.name.localeCompare(u.name)).forEach(c=>{o(),t.setFontSize(12);const u=Number.isInteger(c.totalQuantity)?c.totalQuantity:parseFloat(c.totalQuantity.toFixed(2));if(t.text(`${u} ${c.unit||""} ${c.name}`,14,n),n+=6,c.sources&&c.sources.length>0){const f=c.sources.reduce((y,M)=>{const C=`${M.recipeName} (${M.day} ${M.time})`;return y[C]||(y[C]=0),y[C]+=M.quantity,y},{});t.setFontSize(9),t.setTextColor(100);for(const y in f)o(),t.text(`  * ${y}`,18,n),n+=5;t.setTextColor(0)}n+=2}),n+=5}),t.save("liste-de-courses.pdf")}async function R(e,t,s,a=!1){if(!p)return alert("Veuillez sélectionner un plan.");const n=te(x,"plans",p.id);try{await _e(x,async r=>{const l=await r.get(n);if(!l.exists())throw"Le plan n'existe plus.";const o=l.data().manualItems||[],d=`${e.trim().toLowerCase()}_${s||""}`,m=o.findIndex(u=>`${u.name.trim().toLowerCase()}_${u.unit||""}`===d);if(m>-1)o[m].totalQuantity+=t;else{const u=O.find(f=>f.name.toLowerCase()===e.trim().toLowerCase());o.push({name:e.trim(),totalQuantity:t,unit:s,source:"manual",category:u?u.category:"Inconnue"})}const c=o.filter(u=>u.totalQuantity!==0);r.update(n,{manualItems:c,lastUpdated:new Date})})}catch(r){console.error("Erreur transactionnelle lors de l'ajustement de l'ingrédient: ",r),alert("Une erreur de synchronisation est survenue. Veuillez réessayer.")}}function ce(e){const t=e?e.toLowerCase():"";return t.includes("g")||t.includes("ml")?10:1}function de(){const e=i.shoppingListContainer;if(!e)return;if(e.innerHTML="",P.length===0){e.innerHTML='<p class="text-center text-gray-500 italic py-4">Votre liste de courses est vide.</p>';return}const t=P.reduce((a,n)=>{const r=n.category||"Inconnue";return a[r]||(a[r]=[]),a[r].push(n),a},{});Object.keys(t).sort((a,n)=>a==="Inconnue"?1:n==="Inconnue"?-1:a.localeCompare(n)).forEach(a=>{const n=document.createElement("h4");n.className="text-sm font-bold text-stone-800 bg-stone-200 mt-4 mb-2 px-3 py-1 rounded-md",n.textContent=a,e.appendChild(n);const r=document.createElement("ul");r.className="space-y-2",t[a].sort((o,d)=>o.name.localeCompare(d.name)).forEach(o=>{const d=document.createElement("li");let m="p-2 rounded";d.className=m+(o.source==="manual"?" bg-lemon":" bg-gray-50");const c=document.createElement("div");c.className="flex justify-between items-center";const u=document.createElement("span");u.className="flex-grow text-sm font-medium",u.textContent=o.name,c.appendChild(u);const f=document.createElement("div");f.className="flex items-center space-x-2 mx-2";const y=document.createElement("span");y.className="font-medium w-20 text-center text-sm";const M=Number.isInteger(o.totalQuantity)?o.totalQuantity:parseFloat(o.totalQuantity.toFixed(2));y.textContent=`${M} ${o.unit||""}`.trim();const C=document.createElement("div");C.className="flex flex-col";const w=document.createElement("button");w.className="btn btn-outline btn-xs rounded-b-none",w.textContent="+",w.addEventListener("click",async()=>{const h=ce(o.unit);await R(o.name,h,o.unit)});const B=document.createElement("button");B.className="btn btn-outline btn-xs rounded-t-none -mt-px",B.textContent="-",B.addEventListener("click",async()=>{const h=ce(o.unit);await R(o.name,-h,o.unit)}),C.appendChild(w),C.appendChild(B),f.appendChild(y),f.appendChild(C),c.appendChild(f);const k=document.createElement("button");if(k.className="delete-item-btn text-red-500 hover:text-red-700",k.innerHTML='<i class="fas fa-trash-alt"></i>',k.addEventListener("click",()=>{R(o.name,-o.totalQuantity,o.unit,!0)}),c.appendChild(k),d.appendChild(c),o.sources&&o.sources.length>0){const h=document.createElement("div");h.className="p-2 mt-1 ml-4 rounded-md bg-stone-100";const Q=o.sources.reduce((L,v)=>{const T=`${v.recipeName} (${v.day} ${v.time})`;return L[T]||(L[T]=0),L[T]+=v.quantity,L},{});for(const L in Q){const v=document.createElement("span");v.className="block text-xs text-gray-500",v.textContent=`↳ ${L}`,h.appendChild(v)}d.appendChild(h)}r.appendChild(d)}),e.appendChild(r)})}async function W(){if(!p){P.length=0,de();return}const e=p.manualItems?JSON.parse(JSON.stringify(p.manualItems)):[],t=new Map(e.map(n=>[`${n.name.trim().toLowerCase()}_${n.unit||""}`,n])),s=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];if(p.weeks)for(const n in p.weeks){const r=p.weeks[n],l=r.menuData||{},o=r.servingsData||{};for(const d in l){const m=l[d];if(!Array.isArray(m))continue;const[c,u]=d.split("-"),f=parseInt(c,10),y=s[f]||"Jour inconnu",M=u==="lunch"?"midi":"soir",C=`${f}-${u}`,w=parseInt(o[C]||p.defaultNumPeople,10);for(const B of m){const h=_.find(L=>L.id===B.id)||B;if(!h||!Array.isArray(h.ingredients))continue;const Q=h.servings||1;Q<=0||h.ingredients.forEach(L=>{const{name:v,quantity:T,unit:G}=L;if(!v||!T)return;const F=O.find(D=>D.name.toLowerCase()===v.trim().toLowerCase()),$=F?F.category:"Inconnue",z=parseFloat(String(T).replace(",","."));if(isNaN(z))return;const J=z/Q*w,K=G||"",j=`${v.trim().toLowerCase()}_${K}`,X={recipeName:h.name,day:`${y} (S${n})`,time:M,quantity:J};if(t.has(j)){const D=t.get(j);D.totalQuantity+=J,D.source==="manual"&&(D.source="mixed"),Array.isArray(D.sources)?D.sources.push(X):D.sources=[X]}else t.set(j,{name:v.trim(),totalQuantity:J,unit:K,source:"plan",category:$,sources:[X]})})}}}const a=Array.from(t.values()).filter(n=>n.totalQuantity>0);P.length=0,P.push(...a.sort((n,r)=>n.name.localeCompare(r.name))),de()}function Ie(e){const t=V(e);if(!t||!i.mealSelectModal)return;i.mealSelectModalTitle.textContent=`Sélectionner : ${t}`,i.mealSelectList.innerHTML="";const s=document.createElement("input");s.type="text",s.placeholder="Rechercher dans la catégorie...",s.className="w-full p-2 mb-4 border border-gray-300 rounded-lg",i.mealSelectList.appendChild(s);const a=Y(t),n=_.filter(o=>Y(o.category)===a).sort((o,d)=>o.name.localeCompare(d.name)),r=document.createElement("div");r.className="space-y-1 max-h-80 overflow-y-auto",i.mealSelectList.appendChild(r);function l(o=""){r.innerHTML="";const d=o.toLowerCase(),m=n.filter(c=>c.name.toLowerCase().includes(d));m.length===0?r.innerHTML='<p class="text-gray-500 p-4">Aucun plat ne correspond à votre recherche.</p>':m.forEach(c=>{const u=document.createElement("button");u.className="w-full text-left p-2 hover:bg-gray-100 rounded-lg transition-colors duration-150";const f=document.createElement("p");f.className="font-medium text-gray-800 text-sm",f.textContent=c.name,u.appendChild(f),u.addEventListener("click",()=>{Te(e,c),Z()}),r.appendChild(u)})}s.addEventListener("input",o=>l(o.target.value)),l(),i.mealSelectModal.classList.remove("hidden"),s.focus()}function Z(){i.mealSelectModal&&i.mealSelectModal.classList.add("hidden")}function we(e){H=e.target.closest(".meal-card");const t=H.closest(".meal-slot").dataset.slotId;e.dataTransfer.setData("text/plain",t),setTimeout(()=>{H&&(H.style.opacity="0.5")},0)}function Se(){H&&(H.style.opacity="1",H=null)}function Me(e){e.preventDefault();const t=e.target.closest(".meal-slot");t&&V(t.dataset.slotId)!=="Remarque"&&t.classList.add("bg-gray-200")}function Be(e){const t=e.target.closest(".meal-slot");t&&t.classList.remove("bg-gray-200")}async function ke(e){e.preventDefault();const t=e.dataTransfer.getData("text/plain"),s=e.target.closest(".meal-slot");if(s){s.classList.remove("bg-gray-200");const a=s.dataset.slotId,n=V(a);if(n==="Remarque")return;if(t&&a&&t!==a){const r=g[t],l=V(t);if(Y(l)!==Y(n)){alert(`Action impossible : un(e) "${l}" ne peut pas aller dans la catégorie "${n}".`);return}const o=g[a];g[a]=r,o?g[t]=o:delete g[t],U(i.mealPlanGrid,{menuData:g,servingsData:S,remarksData:b,defaultNumPeople:I,startDay:E},!1),await saveCurrentPlan(),await W()}}}function V(e){switch(e.split("-")[2]){case"0":return"Entrée";case"1":return"Plat";case"2":return"Accompagnement";case"3":return"Dessert";case"4":return"Remarque";default:return""}}function De(e,t,s,a=!1){const n=document.createElement("div");n.className="meal-card p-1 flex flex-col items-center bg-white rounded shadow-sm text-center relative w-full mb-1",a||(n.classList.add("cursor-grab"),n.draggable=!0);const r=document.createElement("span");if(r.className="text-xs font-medium p-1 break-words w-full",r.textContent=e.name,n.appendChild(r),!a){const d=document.createElement("div");d.className="absolute top-0 left-0 flex";const m=document.createElement("button");m.className="edit-meal-btn text-gray-600 hover:text-gray-800 hidden px-1 py-0.5",m.innerHTML='<i class="fas fa-pencil-alt fa-xs"></i>',m.title="Modifier la recette",m.addEventListener("click",u=>{u.stopPropagation();const f=_.find(y=>y.id===e.id);q.openForm(f||e,"Modifier la recette")}),d.appendChild(m);const c=document.createElement("button");c.className="delete-meal-btn text-red-700 hover:text-red-900 hidden px-1 py-0.5",c.innerHTML='<i class="fas fa-times-circle fa-xs"></i>',c.title="Retirer du planning",c.addEventListener("click",u=>{u.stopPropagation(),Fe(t,s)}),d.appendChild(c),n.appendChild(d),n.addEventListener("mouseenter",()=>{m.classList.remove("hidden"),c.classList.remove("hidden")}),n.addEventListener("mouseleave",()=>{m.classList.add("hidden"),c.classList.add("hidden")})}const l=document.createElement("div");l.className="absolute bottom-1 right-1";const o=document.createElement("button");return o.className="info-meal-btn bg-gray-500 text-white hover:bg-gray-600 rounded w-3 h-3 flex items-center justify-center shadow-sm",o.innerHTML='<i class="fas fa-plus fa-xs"></i>',o.title="Plus d'infos",o.dataset.slotId=t,o.dataset.mealIndex=s,l.appendChild(o),n.appendChild(l),n}function Ne(e,t){const s=e.classList.contains("info-open");if(document.querySelectorAll(".planner-ingredient-tooltip").forEach(a=>a.remove()),document.querySelectorAll(".info-meal-btn").forEach(a=>{a.classList.remove("info-open"),a.innerHTML='<i class="fas fa-plus fa-xs"></i>'}),!s){e.innerHTML='<i class="fas fa-times fa-xs"></i>',e.classList.add("info-open");const a=document.createElement("div");if(a.className="planner-ingredient-tooltip z-50 w-64 p-3 bg-white border border-gray-200 rounded-lg shadow-lg text-left text-sm",t.ingredients&&t.ingredients.length>0){if(t.servings&&t.servings>0){const c=document.createElement("p");c.className="mb-2 text-sm text-gray-600 flex items-center",c.innerHTML=`<i class="fas fa-users mr-2"></i> Pour ${t.servings} ${t.servings>1?"personnes":"personne"}`,a.appendChild(c)}const d=document.createElement("h4");d.className="font-bold mb-2 text-gray-800",d.textContent="Ingrédients :",a.appendChild(d);const m=document.createElement("ul");m.className="space-y-1 text-gray-600",t.ingredients.forEach(c=>{const u=document.createElement("li");u.textContent=`• ${c.quantity||""} ${c.unit||""} ${c.name}`.trim(),m.appendChild(u)}),a.appendChild(m)}else a.textContent="Aucun ingrédient spécifié pour cette recette.";document.body.appendChild(a);const n=e.closest(".meal-card").getBoundingClientRect(),r=a.getBoundingClientRect();let l=n.right+10;l+r.width>window.innerWidth&&(l=n.left-r.width-10);let o=n.top;o+r.height>window.innerHeight&&(o=n.bottom-r.height),o<10&&(o=10),a.style.position="fixed",a.style.left=`${l}px`,a.style.top=`${o}px`}}function ue(e,t=!1){const s=document.createElement("div"),a=document.createElement("button");return t?(s.className="w-full flex justify-center pt-1",a.className="add-more-meal-btn text-gray-400 hover:text-green-500 transition-colors duration-150",a.innerHTML='<i class="fas fa-plus-circle"></i>',a.title="Ajouter une autre recette"):(s.className="flex items-center justify-center h-full",a.className="add-meal-btn text-green-500 hover:text-green-700 transition-transform duration-150 hover:scale-125",a.innerHTML='<i class="fas fa-plus-circle text-lg"></i>'),a.addEventListener("click",()=>Ie(e)),s.appendChild(a),s}function Pe(e,t,s=!1){if(s){const n=document.createElement("p");return n.className="w-full h-full p-1 text-xs text-gray-700",n.textContent=t[e]||"",n}const a=document.createElement("textarea");return a.className="w-full h-full p-1 text-xs bg-transparent border-0 rounded focus:outline-none focus:ring-1 focus:ring-tomato resize-none",a.placeholder="Remarque...",a.value=b[e]||"",a.addEventListener("change",n=>{const r=n.target.value;r?b[e]=r:delete b[e],saveCurrentPlan()}),a}function $e(){document.querySelectorAll(".meal-card").forEach(e=>{e.addEventListener("dragstart",we),e.addEventListener("dragend",Se)}),document.querySelectorAll(".meal-slot").forEach(e=>{e.addEventListener("dragover",Me),e.addEventListener("dragleave",Be),e.addEventListener("drop",ke)})}async function Te(e,t){const s=JSON.parse(JSON.stringify(g)),a=s[e];Array.isArray(a)?a.push({...t}):s[e]=[t];const n=te(x,"plans",p.id);try{await re(n,{[`weeks.${N}.menuData`]:s,lastUpdated:new Date}),Z()}catch(r){console.error("Erreur lors de l'ajout de la recette: ",r),alert("Une erreur est survenue.")}}async function Fe(e,t){if(!p||!g[e]||!Array.isArray(g[e]))return;const s=JSON.parse(JSON.stringify(g));s[e].splice(t,1),s[e].length===0&&delete s[e];const a=te(x,"plans",p.id);try{await re(a,{[`weeks.${N}.menuData`]:s,lastUpdated:new Date})}catch(n){console.error("Erreur lors de la suppression de la recette: ",n),alert("Une erreur est survenue.")}}async function me(){if(confirm("Voulez-vous vraiment vider le menu de cette semaine ?")){const e={id:availablePlans.length>0?availablePlans[0].id:`${ge()}_semaine-${N}`,name:availablePlans.length>0?availablePlans[0].name:"Mon plan",menuData:{},servingsData:{},remarksData:{},defaultNumPeople:I,startDay:E,lastUpdated:new Date};loadPlan(e),availablePlans.length>0?availablePlans[0]=e:availablePlans.push(e),await saveCurrentPlan()}}function pe(e){e>=1&&e<=52&&(N=e,ie())}function Ae(){i.currentWeekDisplay&&(i.currentWeekDisplay.textContent=`Semaine ${N}`)}function He(){i.prevWeekBtn?.addEventListener("click",()=>pe(N-1)),i.nextWeekBtn?.addEventListener("click",()=>pe(N+1)),i.clearMenuBtn?.addEventListener("click",me),i.startDaySelect?.addEventListener("change",e=>{E=e.target.value,p&&(p.startDay=E),U(i.mealPlanGrid,{menuData:g,servingsData:S,remarksData:b,defaultNumPeople:I,startDay:E},!1),saveCurrentPlan()}),i.planSelect?.addEventListener("change",fe),i.closeMealSelectModalBtn?.addEventListener("click",Z),i.mealSelectModal?.addEventListener("click",e=>{e.target===i.mealSelectModal&&Z()}),i.closeRecipeModalBtn?.addEventListener("click",()=>q.closeForm()),i.cancelRecipeBtn?.addEventListener("click",()=>q.closeForm()),i.importListBtn?.addEventListener("click",Ce),i.closeImportListModalBtn?.addEventListener("click",ae),i.importListModal?.addEventListener("click",e=>{e.target===i.importListModal&&ae()}),i.exportTxtBtn?.addEventListener("click",Ee),i.exportPdfBtn?.addEventListener("click",be),i.mealPlanGrid?.addEventListener("click",e=>{const t=e.target.closest(".info-meal-btn");if(t){const s=t.dataset.slotId,a=parseInt(t.dataset.mealIndex,10);if(s&&!isNaN(a)){const n=g[s]?.[a];n&&Ne(t,n)}}}),i.sharePlanBtn?.addEventListener("click",()=>{if(!p){alert("Veuillez sélectionner un plan à partager.");return}Ge({plan:p})})}function Re(e=""){return e.split(" ").map(a=>a[0]).join("").substring(0,2).toUpperCase()}function je(e=[]){const t=document.getElementById("collaborators-bar"),s=document.getElementById("name-tooltip");if(!(!t||!s)){if(t.innerHTML="",e.length<=1){t.classList.add("hidden");return}e.forEach(a=>{const n=document.createElement("div");n.className="w-8 h-8 rounded-full flex items-center justify-center bg-gray-300 text-white font-bold text-xs ring-2 ring-white cursor-pointer",n.dataset.name=a.displayName||"Inconnu",a.photoURL?n.innerHTML=`<img src="${a.photoURL}" alt="${a.displayName}" class="w-full h-full rounded-full object-cover">`:n.textContent=Re(a.displayName),n.addEventListener("mouseenter",r=>{s.textContent=r.currentTarget.dataset.name,s.classList.remove("hidden");const l=r.currentTarget.getBoundingClientRect();s.style.left=`${l.left+l.width/2-s.offsetWidth/2}px`,s.style.top=`${l.top-s.offsetHeight-5}px`}),n.addEventListener("mouseleave",()=>{s.classList.add("hidden")}),t.appendChild(n)}),t.classList.remove("hidden")}}function fe(){const e=i.planSelect.value;p=oe.find(n=>n.id===e)||null;const t=document.getElementById("delete-plan-btn"),s=document.getElementById("rename-plan-btn"),a=document.getElementById("leave-plan-btn");t&&(t.style.display=p&&p.isOwner?"inline-flex":"none"),s&&(s.style.display=p&&p.isOwner?"inline-flex":"none"),a&&(a.style.display=p&&!p.isOwner?"inline-flex":"none"),je(p?.participants),p&&(p.manualItems=p.manualItems||[]),ie()}async function qe(e,t){t===I?delete S[e]:S[e]=t,U(i.mealPlanGrid,{menuData:g,servingsData:S,remarksData:b,defaultNumPeople:I,startDay:E},!1),await saveCurrentPlan(),await W()}async function Ue(){return x?(Je(),He(),Le(),await le(),await ne(),await ne(),Ke(t=>{oe=t,Xe(t),fe()})):void 0}const Qe=Ue();return async()=>{const e=await Qe;typeof e=="function"&&e()}}export{nt as default};
