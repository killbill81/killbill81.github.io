const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/main-Ca5URGHw.js","assets/firebase-config-d8WEO_B0.js","assets/firebase-config-BniYt0Pb.css"])))=>i.map(i=>d[i]);
import{b as mt,i as pt,a as ft,s as Te,c as Pe,g as ye,_ as He,d as yt,p as gt}from"./main-Ca5URGHw.js";import{r as ge,j as Fe,k as ht,l as vt,m as xt,n as bt,p as Et,t as qe,d as M,o as Lt,c as ue,g as he,b as Q,h as Ae,q as Re,v as Ct,x as je,s as It,f as wt,u as kt,w as St}from"./firebase-config-d8WEO_B0.js";import{R as Mt,t as Bt}from"./recipes-Baj3fZnc.js";import{o as Dt,a as Nt}from"./sharing-CJ9u-m9G.js";import{ingredientModalManager as $t}from"./ingredient-modal-DDwFGodq.js";let K=null,ae=null;function Tt(l,se){if(!ge||!l)return;const Y=mt();if(!Y)return;const $=Fe(ge,`plans_presence/${l}`);K=Fe(ge,`plans_presence/${l}/${Y.uid}`);const P={displayName:Y.displayName||Y.email,photoURL:Y.photoURL,status:"idle",last_seen:qe()};ht(K).remove(),vt(K,P),ae&&ae(),ae=xt($,h=>{const R=h.val()||{};typeof se=="function"&&se(R)})}function Pt(){K&&(Et(K),K=null),ae&&(ae(),ae=null)}function ve(l){K&&bt(K,{status:l,last_seen:qe()})}let G=null;function qt(){const l={mealPlanGrid:document.getElementById("meal-plan-grid"),currentWeekDisplay:document.getElementById("current-week-display"),prevWeekBtn:document.getElementById("prev-week-btn"),nextWeekBtn:document.getElementById("next-week-btn"),clearMenuBtn:document.getElementById("clear-menu-btn"),shoppingListContainer:document.getElementById("shopping-list"),startDaySelect:document.getElementById("start-day-select"),defaultServingsControl:document.getElementById("default-servings-control"),mealSelectModal:document.getElementById("meal-select-modal"),closeMealSelectModalBtn:document.getElementById("close-meal-select-modal"),mealSelectModalTitle:document.getElementById("meal-select-modal-title"),mealSelectList:document.getElementById("meal-select-list"),recipeFormModal:document.getElementById("edit-recipe-form-modal"),closeRecipeModalBtn:document.getElementById("close-edit-recipe-modal"),cancelRecipeBtn:document.getElementById("edit-cancel-recipe-btn"),recipeForm:document.getElementById("edit-recipe-form"),addItemInput:document.getElementById("add-item-input"),addItemBtn:document.getElementById("add-item-btn"),addItemResults:document.getElementById("add-item-results"),importListBtn:document.getElementById("import-list-btn"),importListModal:document.getElementById("import-list-modal"),closeImportListModalBtn:document.getElementById("close-import-list-modal"),importListContainer:document.getElementById("import-list-container"),exportTxtBtn:document.getElementById("export-txt-btn"),exportPdfBtn:document.getElementById("export-pdf-btn"),exportPlanPdfBtn:document.getElementById("export-plan-pdf-btn"),sharePlanBtn:document.getElementById("share-plan-btn"),planSelect:document.getElementById("plan-select"),inviteParticipantBtn:document.getElementById("invite-participant-btn"),historyPlanBtn:document.getElementById("history-plan-btn"),planHistoryModal:document.getElementById("plan-history-modal"),closePlanHistoryModalBtn:document.getElementById("close-plan-history-modal"),planHistoryList:document.getElementById("plan-history-list"),savePlanBtn:document.getElementById("save-plan-btn"),openTrashBtn:document.getElementById("open-trash-btn"),trashCount:document.getElementById("trash-count"),trashModal:document.getElementById("trash-modal"),closeTrashModalBtn:document.getElementById("close-trash-modal"),trashListContainer:document.getElementById("trash-list-container"),emptyTrashBtn:document.getElementById("empty-trash-btn")};function se(e,n){const a=document.createElement("div");a.className="flex items-center space-x-2";const i=document.createElement("button");i.className="btn btn-outline btn-xs",i.textContent="-";const t=document.createElement("span");t.className="font-medium text-center w-6",t.textContent=e;const r=document.createElement("button");return r.className="btn btn-outline btn-xs",r.textContent="+",i.addEventListener("click",()=>{let o=parseInt(t.textContent,10);o>1&&(o--,t.textContent=o,n(o))}),r.addEventListener("click",()=>{let o=parseInt(t.textContent,10);o++,t.textContent=o,n(o)}),a.appendChild(i),a.appendChild(t),a.appendChild(r),a}function Y(e,n,a,i=!1){const t=document.createElement("div");t.className="flex flex-col items-center justify-center h-full";const r=document.createElement("button");r.className="text-gray-600 hover:bg-gray-100 p-0 h-4 flex items-center justify-center w-full rounded-md",r.innerHTML='<i class="fas fa-plus"></i>',r.disabled=i;const o=document.createElement("span");o.className="font-medium text-center text-sm my-1",o.textContent=e;const s=document.createElement("button");return s.className="text-gray-600 hover:bg-gray-100 p-0 h-4 flex items-center justify-center w-full rounded-md",s.innerHTML='<i class="fas fa-minus"></i>',s.disabled=i,n&&(r.classList.add("text-white"),o.classList.add("text-white"),s.classList.add("text-white")),i||(r.addEventListener("click",()=>{let c=parseInt(o.textContent,10);c++,o.textContent=c,a(c)}),s.addEventListener("click",()=>{let c=parseInt(o.textContent,10);c>1&&(c--,o.textContent=c,a(c))})),t.appendChild(r),t.appendChild(o),t.appendChild(s),t}G&&G.destroy(),G=new Mt(M,"edit-recipe-form-modal","edit-recipe-form","edit-recipe-modal-title","edit-recipe-id","edit-recipe-name","edit-recipe-category","edit-recipe-servings","edit-recipe-prep-time","edit-recipe-difficulty","edit-recipe-steps","edit-ingredients-list","edit-add-ingredient-btn","edit-save-recipe-btn","close-edit-recipe-modal","edit-cancel-recipe-btn"),G.setActivityUpdater(ve),G.setOnSaveCallback(async()=>{});let $=1,P="Lundi",h={},R={},F={};const O=[];let X=null,z=[],ee=[],j=1,te=null,xe=[],u=null;const _=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];function oe(e){return e?e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase():""}function _e(e){return e?e.replace(/\./g,"_"):""}async function be(){if(M)try{ee=(await he(ue(M,"ingredients"))).docs.map(n=>({id:n.id,...n.data()})),ee.sort((n,a)=>n.name.localeCompare(a.name))}catch(e){console.error("Erreur lors de la récupération des ingrédients: ",e)}}function Ee(){if(!u)h={},R={},F={},j=1,P="Lundi";else{const e=u.weeks?u.weeks[$]||{}:{};h=e.menuData||{},R=e.servingsData||{},F=e.remarksData||{},j=u.defaultNumPeople||1,P=u.startDay||"Lundi"}if(l.startDaySelect&&(l.startDaySelect.value=P),l.defaultServingsControl){l.defaultServingsControl.innerHTML="";const e=se(j,async n=>{j=n,u&&await V({defaultNumPeople:n},`a changé le nombre de personnes par défaut à ${n}`)});l.defaultServingsControl.appendChild(e)}it(),ie(l.mealPlanGrid,{menuData:h,servingsData:R,remarksData:F,defaultNumPeople:j,startDay:P},!1),Le(document.getElementById("mobile-meal-plan"),{menuData:h,servingsData:R,remarksData:F,defaultNumPeople:j,startDay:P},!1),le()}async function V(e,n){if(!u)return;await Pe(u.id,u,n);const a=Q(M,"plans",u.id);try{await kt(a,{...e,lastUpdated:new Date})}catch(i){console.error("Error updating plan:",i),alert("Une erreur de sauvegarde est survenue.")}}function me(){l.planHistoryModal.classList.add("hidden")}async function Ue(e){if(u&&confirm("Voulez-vous vraiment restaurer cette version ? L'état actuel sera sauvegardé dans l'historique avant la restauration."))try{const n=Q(M,"plans",u.id,"history",e),a=await Ae(n);if(!a.exists())throw new Error("Version de l'historique non trouvée.");const i=a.data().planState;await Pe(u.id,u);const t=Q(M,"plans",u.id);await It(t,i),me()}catch(n){console.error("Erreur lors du rollback :",n)}}async function Oe(e,n){if(u&&confirm("Êtes-vous sûr de vouloir supprimer définitivement cette entrée de l'historique ?"))try{const a=Q(M,"plans",u.id,"history",e);await wt(a),n.remove()}catch(a){console.error("Erreur lors de la suppression de l'historique :",a),alert("Une erreur est survenue lors de la suppression.")}}async function ze(){if(u){l.planHistoryList.innerHTML="<p>Chargement de l'historique...</p>",l.planHistoryModal.classList.remove("hidden");try{const e=ue(M,"plans",u.id,"history"),n=Re(e,Ct("timestamp","desc")),a=await he(n);if(l.planHistoryList.innerHTML="",a.empty){l.planHistoryList.innerHTML="<p>Aucun historique pour ce plan.</p>";return}a.forEach(i=>{const t=i.data(),r=document.createElement("div");r.className="p-3 border-b flex justify-between items-center";const o=document.createElement("div"),s=t.timestamp?.toDate().toLocaleString("fr-FR")||"Date inconnue",c=t.description||"Modification diverse",d=t.modifiedByName||"Inconnu";o.innerHTML=`
                    <p class="font-medium">${d} ${c}</p>
                    <p class="text-sm text-gray-500">${s}</p>
                `;const m=document.createElement("div");m.className="flex items-center space-x-2";const p=document.createElement("button");p.className="btn btn-secondary btn-sm",p.textContent="Revenir à cette version",p.addEventListener("click",()=>Ue(i.id));const f=document.createElement("button");f.className="text-red-500 hover:bg-red-100 text-sm px-3 py-1 rounded-md",f.innerHTML='<i class="fas fa-times"></i>',f.title="Supprimer cette version",f.addEventListener("click",y=>{y.stopPropagation(),Oe(i.id,r)}),m.appendChild(p),m.appendChild(f),r.appendChild(o),r.appendChild(m),l.planHistoryList.appendChild(r)})}catch(e){console.error("Erreur de chargement de l'historique:",e),l.planHistoryList.innerHTML=`<p class="text-red-500">Impossible de charger l'historique.</p>`}}}function Le(e,n,a=!1){if(!e)return;const i=n.menuData||{},t=n.servingsData||{},r=n.remarksData||{},o=n.defaultNumPeople||1,s=n.startDay||"Lundi";e.innerHTML="";const c=document.createDocumentFragment(),d=_.indexOf(s);[..._.slice(d),..._.slice(0,d)].forEach(p=>{const f=_.indexOf(p),y=document.createElement("div");y.className="bg-blue-100 border border-blue-300 rounded-xl shadow-md p-4 mb-4";const g=document.createElement("h3");g.className="text-xl font-bold text-gray-800 dark:text-gray-800 mb-3",g.textContent=p.toUpperCase(),y.appendChild(g);const L=document.createElement("div");L.className="space-y-4",["lunch","dinner"].forEach(b=>{const C=document.createElement("div");C.className=`border-t pt-3 ${b==="lunch"?"bg-amber-50":"bg-stone-100"} rounded-lg p-2`;const w=document.createElement("div");w.className="flex justify-between items-center mb-2";const k=document.createElement("h4");if(k.className="text-lg font-semibold text-tomato",k.textContent=b==="lunch"?"Midi":"Soir",w.appendChild(k),!a){const I=`${f}-${b}`,E=t[I]||o,v=se(E,x=>{$e(I,x)});w.appendChild(v)}C.appendChild(w);const B=document.createElement("div");B.className="space-y-2";let A=!1;const D=["Entrée","Plat","Accompagnement","Dessert","Remarque"];for(let I=0;I<D.length;I++){const E=D[I],v=`${f}-${b}-${I}`,x=i[v],T=document.createElement("div");T.className="mb-2";const H=document.createElement("h5");if(H.className="text-md font-semibold text-gray-700 mb-1",H.textContent=E,T.appendChild(H),E==="Remarque")T.appendChild(Me(v,r,a));else{const S=document.createElement("div");if(S.className="space-y-1",Array.isArray(x)&&x.length>0&&(A=!0,x.forEach((N,de)=>{const W=z.find(q=>q.id===N.id);if(W){const q=ke(W,v,de,a);if(q.classList.remove("bg-white","shadow-sm"),q.classList.add("bg-emerald-200","border","border-emerald-400"),!a){const U=q.querySelector(".edit-meal-btn"),ne=q.querySelector(".delete-meal-btn");U&&U.classList.remove("hidden"),ne&&ne.classList.remove("hidden")}S.appendChild(q)}})),a)A||(S.innerHTML='<p class="text-sm text-gray-500 italic">Aucun plat prévu.</p>');else{const N=document.createElement("button");N.className="btn btn-outline btn-sm w-full mt-2",N.innerHTML=`<i class="fas fa-plus mr-2"></i> Ajouter une ${E.toLowerCase()}`,N.addEventListener("click",()=>{we(v)}),S.appendChild(N)}T.appendChild(S)}B.appendChild(T)}C.appendChild(B),L.appendChild(C)}),y.appendChild(L),c.appendChild(y)}),e.appendChild(c)}function ie(e,n,a=!1){if(!e)return;const i=n.menuData||{},t=n.servingsData||{},r=n.remarksData||{},o=n.defaultNumPeople||1,s=n.startDay||"Lundi",c=document.createDocumentFragment(),d=["lunch","dinner"],m=5,p=_.indexOf(s);[..._.slice(p),..._.slice(0,p)].forEach(y=>{const g=_.indexOf(y),L=document.createElement("div");L.className="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] items-stretch border-b border-gray-300";const b=document.createElement("div");b.className="font-bold p-2 flex items-center justify-center bg-gray-100 dark:bg-gray-100 text-sm border-r border-gray-300 text-gray-800 dark:text-gray-800",b.textContent=y.toUpperCase(),L.appendChild(b),d.forEach(C=>{const w=`${g}-${C}`,k=t[w]||o,B=t.hasOwnProperty(w),A=document.createElement("div"),D=Y(k,B,E=>{$e(w,E)},a);let I="border-r border-gray-300 flex items-center justify-center transition-colors duration-300";B?I+=" bg-tomato":I+=C==="lunch"?" bg-amber-50":" bg-stone-100",A.className=I,A.appendChild(D),L.appendChild(A);for(let E=0;E<m;E++){const v=`${g}-${C}-${E}`,x=i[v],T=document.createElement("div"),H=re(v);let S="meal-slot p-1 min-h-[70px] flex flex-col justify-start border-r border-gray-300";if(S+=C==="lunch"?" bg-amber-50":" bg-stone-100",T.className=S,T.dataset.slotId=v,H==="Remarque")T.appendChild(Me(v,r,a));else if(Array.isArray(x)&&x.length>0){const N=document.createElement("div");N.className="w-full",x.forEach((de,W)=>{const q=z.find(U=>U.id===de.id);if(q)N.appendChild(ke(q,v,W,a));else{const U=document.createElement("div");U.className="p-1 bg-red-100 text-red-700 rounded shadow-sm text-center text-xs font-medium",U.textContent="Recette supprimée",N.appendChild(U)}}),T.appendChild(N),a||T.appendChild(Se(v,!0))}else a||T.appendChild(Se(v,!1));L.appendChild(T)}}),c.appendChild(L)}),e.innerHTML="",e.appendChild(c),a||st()}async function Qe(){const e=ye();if(!M||!e)return[];try{const n=Re(ue(M,"shopping_lists"),St("userId","==",e));return(await he(n)).docs.map(r=>({id:r.id,...r.data()})).filter(r=>r.isShared!==!0)}catch(n){return console.error("Erreur de chargement des listes de courses sauvegardées: ",n),[]}}async function Ve(){const e=await Qe();if(l.importListContainer.innerHTML="",e.length===0){l.importListContainer.innerHTML='<p class="text-center text-gray-500">Aucune liste sauvegardée.</p>';return}e.forEach(n=>{const a=document.createElement("button");a.className="w-full text-left p-2 hover:bg-gray-100 rounded-lg transition-colors duration-150",a.textContent=n.name,a.addEventListener("click",()=>{confirm(`Voulez-vous vraiment importer les ingrédients de la liste "${n.name}" ?`)&&(n.ingredients.forEach(i=>{const t=parseFloat(String(i.quantity).replace(",","."))||0;Z(i.name,t,i.unit)}),pe())}),l.importListContainer.appendChild(a)}),l.importListModal.classList.remove("hidden")}function pe(){l.importListModal.classList.add("hidden")}function We(){l.addItemInput?.addEventListener("input",()=>{const e=l.addItemInput.value.toLowerCase(),n=l.addItemResults;if(n.innerHTML="",!e){n.classList.add("hidden");return}let a=ee.filter(t=>t.name.toLowerCase().includes(e));a.forEach(t=>t.seasonScore=Te.getIngredientScore(t)),a.sort((t,r)=>r.seasonScore!==t.seasonScore?r.seasonScore-t.seasonScore:t.name.localeCompare(r.name)),a.forEach(t=>{const r=document.createElement("div");r.className="p-2 hover:bg-gray-100 cursor-pointer flex justify-between items-center";const o=document.createElement("span");if(o.textContent=t.name,r.appendChild(o),Te.config.mode!=="disabled"){if(t.seasonScore===2){const s=document.createElement("span");s.className="text-[10px] bg-green-100 text-green-700 px-1.5 py-0.5 rounded-full border border-green-200 ml-2 whitespace-nowrap",s.textContent="De saison",r.appendChild(s)}else if(t.seasonScore===0){const s=document.createElement("span");s.className="text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded-full border border-gray-200 ml-2 whitespace-nowrap",s.textContent="Hors saison",r.appendChild(s),r.classList.add("opacity-75")}}r.addEventListener("click",()=>{Z(t.name,1,t.unit),l.addItemInput.value="",n.classList.add("hidden")}),n.appendChild(r)});const i=document.createElement("div");i.className="p-2 bg-green-50 hover:bg-green-200 cursor-pointer font-bold text-green-700",i.textContent=`+ Créer "${l.addItemInput.value}"`,i.addEventListener("click",()=>{const t=l.addItemInput.value;$t.open(t,async()=>{await be();const r=ee.find(s=>s.name===t),o=r?r.unit:"";Z(t,1,o),l.addItemInput.value="",n.classList.add("hidden")})}),n.appendChild(i),n.classList.remove("hidden")}),l.addItemBtn?.addEventListener("click",()=>{const e=l.addItemInput.value;e&&(Z(e,1,""),l.addItemInput.value="",l.addItemResults.classList.add("hidden"))}),document.addEventListener("click",e=>{l.addItemInput&&!l.addItemInput.contains(e.target)&&!l.addItemResults.contains(e.target)&&l.addItemResults.classList.add("hidden")})}function Je(){if(O.length===0){alert("La liste de courses est vide.");return}const e=O.reduce((t,r)=>{const o=r.category||"Inconnue";return t[o]||(t[o]=[]),t[o].push(r),t},{}),n=Object.keys(e).sort((t,r)=>t==="Inconnue"?1:r==="Inconnue"?-1:t.localeCompare(r));let a=`Liste de courses - GustoPlan

`;n.forEach(t=>{a+=`--- ${t.toUpperCase()} ---
`,e[t].sort((o,s)=>o.name.localeCompare(s.name)).forEach(o=>{let c=`${Number.isInteger(o.totalQuantity)?o.totalQuantity:parseFloat(o.totalQuantity.toFixed(2))} ${o.unit||""} ${o.name}`;if(o.sources&&o.sources.length>0){const d=o.sources.reduce((p,f)=>{const y=`${f.recipeName} (${f.day} ${f.time})`;return p[y]||(p[y]=0),p[y]+=f.quantity,p},{}),m=Object.keys(d).join(" / ");c+=` *** ${m} ***`}a+=c+`
`}),a+=`
`});const i=new Blob([a],{type:"text/plain;charset=utf-8"});saveAs(i,"liste-de-courses.txt")}function Ge(){if(O.length===0){alert("La liste de courses est vide.");return}const{jsPDF:e}=window.jspdf,n=new e,a=O.reduce((c,d)=>{const m=d.category||"Inconnue";return c[m]||(c[m]=[]),c[m].push(d),c},{}),i=Object.keys(a).sort((c,d)=>c==="Inconnue"?1:d==="Inconnue"?-1:c.localeCompare(d));n.setFontSize(18),n.text("Liste de courses - GustoPlan",14,22);let t=35;const r=n.internal.pageSize.height,o=20,s=()=>{t>r-o&&(n.addPage(),t=20)};i.forEach(c=>{s(),n.setFontSize(14),n.setFont(void 0,"bold"),n.text(`--- ${c.toUpperCase()} ---`,14,t),t+=8,n.setFont(void 0,"normal"),a[c].sort((m,p)=>m.name.localeCompare(p.name)).forEach(m=>{s(),n.setFontSize(12);const p=Number.isInteger(m.totalQuantity)?m.totalQuantity:parseFloat(m.totalQuantity.toFixed(2));if(n.text(`${p} ${m.unit||""} ${m.name}`,14,t),t+=6,m.sources&&m.sources.length>0){const f=m.sources.reduce((y,g)=>{const L=`${g.recipeName} (${g.day} ${g.time})`;return y[L]||(y[L]=0),y[L]+=g.quantity,y},{});n.setFontSize(9),n.setTextColor(100);for(const y in f)s(),n.text(`  * ${y}`,18,t),t+=5;n.setTextColor(0)}t+=2}),t+=5}),n.save("liste-de-courses.pdf")}async function Ke(){if(!u){alert("Veuillez sélectionner un menu à exporter.");return}const e=document.getElementById("loading-overlay");e&&e.classList.remove("hidden");try{const{jsPDF:n}=window.jspdf,a=new n,i=Q(M,"plans",u.id),t=await Ae(i),r=t.exists()?t.data():null;if(!r||!r.weeks){alert("Ce menu est vide et ne peut pas être exporté.");return}a.setFontSize(18),a.text(`Menu de Repas : ${r.name}`,14,20);const o=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"],s={0:"E",1:"P",2:"A",3:"D"},c=Object.keys(r.weeks).sort((m,p)=>parseInt(m)-parseInt(p));let d=!0;for(const m of c){const f=r.weeks[m].menuData||{};if(Object.keys(f).length===0)continue;const y=[["Jour","Midi","Soir"]],g=[],L=o.indexOf(r.startDay||"Lundi"),b=[...o.slice(L),...o.slice(0,L)];for(const w of b){const k=o.indexOf(w);let B=[],A=[];for(const D of["lunch","dinner"])for(const I in s){const E=`${k}-${D}-${I}`;f[E]&&Array.isArray(f[E])&&f[E].forEach(v=>{const x=`[${s[I]}] ${v.name}`;D==="lunch"?B.push(x):A.push(x)})}g.push([w,B.join(`
`)||"-",A.join(`
`)||"-"])}a.setFontSize(14);const C=d?30:a.autoTable.previous.finalY+20;a.text(`Semaine ${m}`,14,C-5),a.autoTable({startY:C,head:y,body:g,theme:"grid",styles:{cellPadding:2,fontSize:8,valign:"middle"},headStyles:{fillColor:[41,128,185],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[245,245,245]}}),d=!1}a.save(`menu_${r.name.replace(/ /g,"_")}.pdf`)}catch(n){console.error("Erreur lors de la génération du PDF du plan :",n),alert("Une erreur est survenue lors de la création du PDF.")}finally{e&&e.classList.add("hidden")}}async function Z(e,n,a,i=!1){if(!u)return alert("Veuillez sélectionner un menu.");const t=Q(M,"plans",u.id);try{await je(M,async r=>{const o=await r.get(t);if(!o.exists())throw"Le menu n'existe plus.";const s=o.data().manualItems||[],c=`${e.trim().toLowerCase()}_${a||""}`,d=s.findIndex(p=>`${p.name.trim().toLowerCase()}_${p.unit||""}`===c);if(d>-1)s[d].totalQuantity+=n;else{const p=ee.find(f=>f.name.toLowerCase()===e.trim().toLowerCase());s.push({name:e.trim(),totalQuantity:n,unit:a,source:"manual",category:p?.category||"Inconnue"})}const m=s.filter(p=>p.totalQuantity!==0);r.update(t,{manualItems:m,lastUpdated:new Date})})}catch(r){console.error("Erreur transactionnelle lors de l'ajustement de l'ingrédient: ",r),alert("Une erreur de synchronisation est survenue. Veuillez réessayer.")}}function Ce(e){const n=e?e.toLowerCase():"";return n.includes("g")||n.includes("ml")?10:1}function Ye(e){if(l.openTrashBtn&&(l.openTrashBtn.classList.remove("hidden"),l.trashCount&&(l.trashCount.textContent=e.length,e.length>0?(l.trashCount.classList.remove("bg-gray-200"),l.trashCount.classList.add("bg-red-500","text-white")):(l.trashCount.classList.add("bg-gray-200"),l.trashCount.classList.remove("bg-red-500","text-white")))),e&&e.length>0){if(l.emptyTrashBtn){l.emptyTrashBtn.classList.remove("hidden");const n=l.emptyTrashBtn.cloneNode(!0);l.emptyTrashBtn.parentNode.replaceChild(n,l.emptyTrashBtn),l.emptyTrashBtn=n,l.emptyTrashBtn.addEventListener("click",async()=>{if(!u||!confirm("Voulez-vous supprimer définitivement tous les éléments de la corbeille ?"))return;const a=Q(M,"plans",u.id),i=e.map(t=>`${t.name}_${t.unit||""}`);try{await He(()=>import("./main-Ca5URGHw.js").then(t=>t.e),__vite__mapDeps([0,1,2])).then(t=>{t.updateDoc(a,{hiddenTrashItems:t.arrayUnion(...i),lastUpdated:new Date})}),l.trashModal.classList.add("hidden")}catch(t){console.error("Erreur vidage corbeille:",t)}})}if(l.trashListContainer){l.trashListContainer.innerHTML="";const n=document.createElement("ul");n.className="space-y-2",e.forEach(a=>{const i=document.createElement("li");i.className="p-2 rounded bg-gray-100 flex justify-between items-center group";const t=document.createElement("span");t.className="text-sm text-gray-500 line-through",t.textContent=a.name,i.appendChild(t);const r=document.createElement("div");r.className="flex items-center space-x-2";const o=document.createElement("button");o.className="btn btn-xs btn-outline text-blue-600 hover:bg-blue-50 border-blue-300",o.innerHTML='<i class="fas fa-undo mr-1"></i> Restaurer',o.addEventListener("click",async()=>{if(!u)return;const c=Q(M,"plans",u.id);try{await je(M,async d=>{const m=await d.get(c);if(!m.exists())return;const f=(m.data().manualItems||[]).filter(y=>!(y.name.toLowerCase()===a.name.toLowerCase()&&y.unit===a.unit));d.update(c,{manualItems:f,lastUpdated:new Date})}),e.length<=1&&l.trashModal.classList.add("hidden")}catch(d){console.error("Erreur lors de la restauration :",d)}});const s=document.createElement("button");s.className="text-gray-400 hover:text-red-600 text-xs p-1 rounded-md",s.title="Supprimer définitivement",s.innerHTML='<i class="fas fa-times"></i>',s.addEventListener("click",async()=>{if(!u)return;const c=Q(M,"plans",u.id),d=`${a.name}_${a.unit||""}`;try{await He(()=>import("./main-Ca5URGHw.js").then(m=>m.e),__vite__mapDeps([0,1,2])).then(m=>{m.updateDoc(c,{hiddenTrashItems:m.arrayUnion(d),lastUpdated:new Date})}),e.length<=1&&l.trashModal.classList.add("hidden")}catch(m){console.error("Erreur suppression définitive:",m)}}),r.appendChild(o),r.appendChild(s),i.appendChild(r),n.appendChild(i)}),l.trashListContainer.appendChild(n)}}else l.trashListContainer&&(l.trashListContainer.innerHTML='<p class="text-center text-gray-500 italic py-4">La corbeille est vide.</p>'),l.emptyTrashBtn&&l.emptyTrashBtn.classList.add("hidden")}function Ie(e=[]){Ye(e);const n=l.shoppingListContainer;if(!n)return;if(n.innerHTML="",O.length===0&&e.length===0){n.innerHTML='<p class="text-center text-gray-500 italic py-4">Votre liste de courses est vide.</p>';return}const a=u?u.checkedItems||{}:{},i=O.reduce((r,o)=>{const s=o.category||"Inconnue";return r[s]||(r[s]=[]),r[s].push(o),r},{});Object.keys(i).sort((r,o)=>r==="Inconnue"?1:o==="Inconnue"?-1:r.localeCompare(o)).forEach(r=>{const o=document.createElement("h4");o.className="text-sm font-bold text-stone-800 bg-stone-200 mt-4 mb-2 px-3 py-1 rounded-md",o.textContent=r,n.appendChild(o);const s=document.createElement("ul");s.className="space-y-2",i[r].sort((d,m)=>d.name.localeCompare(m.name)).forEach(d=>{const m=`${d.name}_${d.unit||""}`,p=_e(m),f=a.hasOwnProperty(p)?a[p]:a[m]||!1,y=document.createElement("li");let g="p-2 rounded";d.hasManualEntry===!0||d.source==="manual"?(y.style.backgroundColor="#ffedd5",g+=" bg-orange-100"):g+=" bg-gray-50",y.className=g;const b=document.createElement("div");b.className="flex justify-between items-center";const C=document.createElement("div");if(C.className="flex-grow flex items-center",f){const x=document.createElement("i");x.className="fas fa-check mr-2 bg-green-500 text-white rounded-full p-1 flex items-center justify-center w-5 h-5",C.appendChild(x)}const w=document.createElement("span");w.className="text-sm font-medium transition-all duration-200",f&&w.classList.add("line-through","text-gray-400"),w.textContent=d.name,C.appendChild(w),b.appendChild(C);const k=document.createElement("div");k.className="flex items-center space-x-2 mx-2";const B=document.createElement("span");B.className="font-medium w-20 text-center text-sm",f&&B.classList.add("text-gray-400");const A=Number.isInteger(d.totalQuantity)?d.totalQuantity:parseFloat(d.totalQuantity.toFixed(2));B.textContent=`${A} ${d.unit||""}`.trim();const D=document.createElement("div");D.className="flex flex-col";const I=document.createElement("button");I.className="btn btn-outline btn-xs rounded-b-none",I.textContent="+",I.addEventListener("click",async()=>{const x=Ce(d.unit);await Z(d.name,x,d.unit)});const E=document.createElement("button");E.className="btn btn-outline btn-xs rounded-t-none -mt-px",E.textContent="-",E.addEventListener("click",async()=>{const x=Ce(d.unit);await Z(d.name,-x,d.unit)}),D.appendChild(I),D.appendChild(E),k.appendChild(B),k.appendChild(D),b.appendChild(k);const v=document.createElement("button");if(v.className="delete-item-btn text-red-500 hover:text-red-700",v.innerHTML='<i class="fas fa-trash-alt"></i>',v.addEventListener("click",()=>{Z(d.name,-d.totalQuantity,d.unit,!0)}),b.appendChild(v),y.appendChild(b),d.sources&&d.sources.length>0){const x=document.createElement("div");x.className="p-2 mt-1 ml-4 rounded-md bg-stone-100";const T=d.sources.reduce((H,S)=>{const N=`${S.recipeName} (${S.day} ${S.time})`;return H[N]||(H[N]=0),H[N]+=S.quantity,H},{});for(const H in T){const S=document.createElement("span");S.className="block text-xs text-gray-500",S.textContent=`↳ ${H}`,x.appendChild(S)}y.appendChild(x)}s.appendChild(y)}),n.appendChild(s)})}async function le(){if(!u){O.length=0,Ie();return}const e=u.manualItems?JSON.parse(JSON.stringify(u.manualItems)):[],n=new Map(e.map(s=>{const c=`${s.name.trim().toLowerCase()}_${s.unit||""}`;return s.hasManualEntry=!0,[c,s]})),a=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];if(u.weeks)for(const s in u.weeks){const c=u.weeks[s],d=c.menuData||{},m=c.servingsData||{};for(const p in d){const f=d[p];if(!Array.isArray(f))continue;const[y,g]=p.split("-"),L=parseInt(y,10),b=a[L]||"Jour inconnu",C=g==="lunch"?"midi":"soir",w=`${L}-${g}`,k=parseInt(m[w]||u.defaultNumPeople,10);for(const B of f){const D=z.find(E=>E.id===B.id)||B;if(!D||!Array.isArray(D.ingredients))continue;const I=D.servings||1;I<=0||D.ingredients.forEach(E=>{const{name:v,quantity:x,unit:T}=E;if(!v||!x)return;const H=ee.find(J=>J.name.toLowerCase()===v.trim().toLowerCase()),S=H?H.category:"Inconnue",N=parseFloat(String(x).replace(",","."));if(isNaN(N))return;const W=N/I*k,q=T||"",U=`${v.trim().toLowerCase()}_${q}`,ne={recipeName:D.name,day:`${b} (S${s})`,time:C,quantity:W};if(n.has(U)){const J=n.get(U);J.totalQuantity+=W,J.source==="manual"&&(J.source="mixed"),Array.isArray(J.sources)?J.sources.push(ne):J.sources=[ne]}else n.set(U,{name:v.trim(),totalQuantity:W,unit:q,source:"plan",category:S,sources:[ne]})})}}}const i=Array.from(n.values()),t=u.hiddenTrashItems||[],r=i.filter(s=>s.totalQuantity>0).sort((s,c)=>s.name.localeCompare(c.name)),o=i.filter(s=>{const c=`${s.name}_${s.unit||""}`;return s.totalQuantity<=0&&s.sources&&s.sources.length>0&&!t.includes(c)}).sort((s,c)=>s.name.localeCompare(c.name));O.length=0,O.push(...r),Ie(o)}function we(e){const n=re(e);if(!n||!l.mealSelectModal)return;l.mealSelectModalTitle.textContent=`Sélectionner : ${n}`,l.mealSelectList.innerHTML="";const a=document.createElement("input");a.type="text",a.placeholder="Rechercher dans la catégorie...",a.className="w-full p-2 mb-4 border border-gray-300 rounded-lg",l.mealSelectList.appendChild(a);const i=oe(n),t=z.filter(s=>oe(s.category)===i).sort((s,c)=>{const d=s.isFavorite?1:0,m=c.isFavorite?1:0;return m!==d?m-d:s.name.localeCompare(c.name)}),r=document.createElement("div");r.className="space-y-1 max-h-80 overflow-y-auto",l.mealSelectList.appendChild(r);function o(s=""){r.innerHTML="";const c=s.toLowerCase(),d=t.filter(m=>m.name.toLowerCase().includes(c));d.length===0?r.innerHTML='<p class="text-gray-500 p-4">Aucun plat ne correspond à votre recherche.</p>':d.forEach(m=>{const p=document.createElement("button");p.className="w-full text-left p-2 hover:bg-gray-100 rounded-lg transition-colors duration-150";const f=document.createElement("p");f.className="font-medium text-gray-800 text-sm",m.isFavorite?f.innerHTML=`${m.name} <i class="fas fa-heart text-red-500 ml-2"></i>`:f.textContent=m.name,p.appendChild(f),p.addEventListener("click",()=>{rt(e,m),ce()}),r.appendChild(p)})}a.addEventListener("input",s=>o(s.target.value)),o(),l.mealSelectModal.classList.remove("hidden"),a.focus()}function ce(){l.mealSelectModal&&l.mealSelectModal.classList.add("hidden")}function Xe(e){X=e.target.closest(".meal-card");const n=X.closest(".meal-slot").dataset.slotId;e.dataTransfer.setData("text/plain",n),setTimeout(()=>{X&&(X.style.opacity="0.5")},0)}function Ze(){X&&(X.style.opacity="1",X=null)}function et(e){e.preventDefault();const n=e.target.closest(".meal-slot");n&&re(n.dataset.slotId)!=="Remarque"&&n.classList.add("bg-gray-200")}function tt(e){const n=e.target.closest(".meal-slot");n&&n.classList.remove("bg-gray-200")}async function nt(e){e.preventDefault();const n=e.dataTransfer.getData("text/plain"),a=e.target.closest(".meal-slot");if(a){a.classList.remove("bg-gray-200");const i=a.dataset.slotId,t=re(i);if(t==="Remarque")return;if(n&&i&&n!==i){const r=h[n],o=re(n);if(oe(o)!==oe(t)){alert(`Action impossible : un(e) "${o}" ne peut pas aller dans la catégorie "${t}".`);return}const s=h[i];h[i]=r,s?h[n]=s:delete h[n],ie(l.mealPlanGrid,{menuData:h,servingsData:R,remarksData:F,defaultNumPeople:j,startDay:P},!1),await V({[`weeks.${$}.menuData`]:h},"a déplacé un plat"),await le()}}}function re(e){switch(e.split("-")[2]){case"0":return"Entrée";case"1":return"Plat";case"2":return"Accompagnement";case"3":return"Dessert";case"4":return"Remarque";default:return""}}function ke(e,n,a,i=!1){const t=document.createElement("div");if(t.className="meal-card p-1 flex flex-col items-center bg-white rounded shadow-sm text-center relative w-full mb-1",i||(t.classList.add("cursor-grab"),t.draggable=!0),!i){const c=document.createElement("button");c.className="absolute -top-2 -right-1 text-base",c.innerHTML='<i class="fas fa-heart"></i>',e.isFavorite?c.classList.add("text-red-500"):c.classList.add("text-gray-300","hover:text-red-400"),c.addEventListener("click",d=>{d.stopPropagation(),Bt(e.id,e.isFavorite)}),c.addEventListener("mousedown",d=>d.stopPropagation()),t.appendChild(c)}const r=document.createElement("span");if(r.className="text-xs font-medium p-1 break-words w-full text-gray-800 dark:text-gray-800",r.textContent=e.name,t.appendChild(r),!i){const c=document.createElement("div");c.className="absolute top-0 left-0 flex";const d=document.createElement("button");d.className="edit-meal-btn text-gray-600 hover:text-gray-800 hidden px-1 py-0.5",d.innerHTML='<i class="fas fa-pencil-alt fa-xs"></i>',d.title="Modifier la recette",d.addEventListener("click",p=>{p.stopPropagation();const f=z.find(y=>y.id===e.id);G.openForm(f||e,"Modifier la recette")}),d.addEventListener("mousedown",p=>p.stopPropagation()),c.appendChild(d);const m=document.createElement("button");m.className="delete-meal-btn text-red-700 hover:text-red-900 hidden px-1 py-0.5",m.innerHTML='<i class="fas fa-times-circle fa-xs"></i>',m.title="Retirer du menu",m.addEventListener("click",p=>{p.stopPropagation(),ot(n,a)}),m.addEventListener("mousedown",p=>p.stopPropagation()),c.appendChild(m),t.appendChild(c),t.addEventListener("mouseenter",()=>{d.classList.remove("hidden"),m.classList.remove("hidden")}),t.addEventListener("mouseleave",()=>{d.classList.add("hidden"),m.classList.add("hidden")})}const o=document.createElement("div");o.className="absolute bottom-1 right-1";const s=document.createElement("button");return s.className="info-meal-btn bg-gray-500 text-white hover:bg-gray-600 rounded w-3 h-3 flex items-center justify-center shadow-sm",s.innerHTML='<i class="fas fa-plus fa-xs"></i>',s.title="Plus d'infos",s.dataset.slotId=n,s.dataset.mealIndex=a,s.addEventListener("mousedown",c=>c.stopPropagation()),o.appendChild(s),t.appendChild(o),t}function at(e,n){if(document.querySelectorAll(".planner-ingredient-tooltip").forEach(o=>o.remove()),te===e){e.classList.remove("info-open"),e.innerHTML='<i class="fas fa-plus fa-xs"></i>',te=null;return}te&&(te.classList.remove("info-open"),te.innerHTML='<i class="fas fa-plus fa-xs"></i>'),e.classList.add("info-open"),e.innerHTML='<i class="fas fa-times fa-xs"></i>',te=e;const a=document.createElement("div");if(a.className="planner-ingredient-tooltip z-50 w-64 p-3 bg-white border border-gray-200 rounded-lg shadow-lg text-left text-sm",n.ingredients&&n.ingredients.length>0){if(n.servings&&n.servings>0){const c=document.createElement("p");c.className="mb-2 text-sm text-gray-600 flex items-center",c.innerHTML=`<i class="fas fa-users mr-2"></i> Pour ${n.servings} ${n.servings>1?"personnes":"personne"}`,a.appendChild(c)}const o=document.createElement("h4");o.className="font-bold mb-2 text-gray-800",o.textContent="Ingrédients :",a.appendChild(o);const s=document.createElement("ul");s.className="space-y-1 text-gray-600",n.ingredients.forEach(c=>{const d=document.createElement("li");d.textContent=`• ${c.quantity||""} ${c.unit||""} ${c.name}`.trim(),s.appendChild(d)}),a.appendChild(s)}else a.textContent="Aucun ingrédient spécifié pour cette recette.";document.body.appendChild(a);const i=e.closest(".meal-card").getBoundingClientRect(),t=a.getBoundingClientRect();if(window.innerWidth<768){a.style.width="90vw",a.style.maxWidth="320px";const o=a.getBoundingClientRect();let s=i.bottom+10,c=(window.innerWidth-o.width)/2;s+o.height>window.innerHeight&&(s=i.top-o.height-10),a.style.top=`${s}px`,a.style.left=`${c}px`}else{let o=i.right+10;o+t.width>window.innerWidth&&(o=i.left-t.width-10);let s=i.top;s+t.height>window.innerHeight&&(s=i.bottom-t.height),s<10&&(s=10),a.style.left=`${o}px`,a.style.top=`${s}px`}a.style.position="fixed"}function Se(e,n=!1){const a=document.createElement("div"),i=document.createElement("button");return n?(a.className="w-full flex justify-center pt-1",i.className="add-more-meal-btn text-gray-400 hover:text-green-500 transition-colors duration-150",i.innerHTML='<i class="fas fa-plus-circle"></i>',i.title="Ajouter une autre recette"):(a.className="flex items-center justify-center h-full",i.className="add-meal-btn text-green-500 hover:text-green-700 transition-transform duration-150 hover:scale-125",i.innerHTML='<i class="fas fa-plus-circle text-lg"></i>'),i.addEventListener("click",()=>we(e)),a.appendChild(i),a}function Me(e,n,a=!1){if(a){const t=document.createElement("p");return t.className="w-full h-full p-1 text-xs text-gray-700",t.textContent=n[e]||"",t}const i=document.createElement("textarea");return i.className="w-full h-full p-1 text-xs bg-white border-0 rounded focus:outline-none focus:ring-1 focus:ring-tomato resize-none",i.placeholder="Remarque...",i.value=F[e]||"",i.dataset.slotId=e,i.addEventListener("change",t=>{const r=t.target.value;r?F[e]=r:delete F[e];const[o,s]=e.split("-"),m=`a modifié la remarque pour ${_[parseInt(o,10)]} ${s==="lunch"?"midi":"soir"}`;V({[`weeks.${$}.remarksData`]:F},m)}),i.addEventListener("focus",t=>{ve({type:"editing_remark",fieldId:e})}),i.addEventListener("blur",t=>{ve("idle")}),i}function st(){document.querySelectorAll(".meal-card").forEach(e=>{e.addEventListener("dragstart",Xe),e.addEventListener("dragend",Ze)}),document.querySelectorAll(".meal-slot").forEach(e=>{e.addEventListener("dragover",et),e.addEventListener("dragleave",tt),e.addEventListener("drop",nt)})}async function rt(e,n){const a=JSON.parse(JSON.stringify(h)),i=a[e],t={id:n.id};Array.isArray(i)?i.push(t):a[e]=[t];const[r,o]=e.split("-"),s=_[parseInt(r,10)],c=o==="lunch"?"midi":"soir",d=`a ajouté '${n.name}' à ${s} ${c}`;await V({[`weeks.${$}.menuData`]:a},d),ce()}async function ot(e,n){if(!u||!h[e]||!Array.isArray(h[e]))return;const a=h[e][n],i=JSON.parse(JSON.stringify(h));i[e].splice(n,1),i[e].length===0&&delete i[e];const[t,r]=e.split("-"),o=_[parseInt(t,10)],s=r==="lunch"?"midi":"soir",c=`a supprimé '${a.name}' de ${o} ${s}`;await V({[`weeks.${$}.menuData`]:i},c)}async function Be(){if(confirm("Voulez-vous vraiment vider le menu de cette semaine ?")){const e={id:availablePlans.length>0?availablePlans[0].id:`${ye()}_semaine-${$}`,name:availablePlans.length>0?availablePlans[0].name:"Mon menu",menuData:{},servingsData:{},remarksData:{},defaultNumPeople:j,startDay:P,lastUpdated:new Date};loadPlan(e),availablePlans.length>0?availablePlans[0]=e:availablePlans.push(e),await V({[`weeks.${$}`]:{menuData:{},servingsData:{},remarksData:{}}},`a vidé le menu de la semaine ${$}`)}}function De(e){e>=1&&e<=52&&($=e,Ee())}function it(){l.currentWeekDisplay&&(l.currentWeekDisplay.textContent=`Semaine ${$}`)}function lt(){l.prevWeekBtn?.addEventListener("click",()=>De($-1)),l.nextWeekBtn?.addEventListener("click",()=>De($+1)),l.clearMenuBtn?.addEventListener("click",Be),l.startDaySelect?.addEventListener("change",async a=>{P=a.target.value,u&&await V({startDay:P},`a changé le premier jour de la semaine à '${P}'`)}),l.planSelect?.addEventListener("change",Ne),l.closeMealSelectModalBtn?.addEventListener("click",ce),l.mealSelectModal?.addEventListener("click",a=>{a.target===l.mealSelectModal&&ce()}),l.closeRecipeModalBtn?.addEventListener("click",()=>G.closeForm()),l.cancelRecipeBtn?.addEventListener("click",()=>G.closeForm()),l.importListBtn?.addEventListener("click",Ve),l.closeImportListModalBtn?.addEventListener("click",pe),l.importListModal?.addEventListener("click",a=>{a.target===l.importListModal&&pe()}),l.exportTxtBtn?.addEventListener("click",Je),l.exportPdfBtn?.addEventListener("click",Ge),l.exportPlanPdfBtn?.addEventListener("click",Ke);const e=a=>{const i=a.target.closest(".info-meal-btn");if(i){const t=i.dataset.slotId,r=parseInt(i.dataset.mealIndex,10);if(t&&!isNaN(r)){const o=h[t]?.[r];if(o&&o.id){const s=z.find(c=>c.id===o.id);s&&at(i,s)}}}};l.mealPlanGrid?.addEventListener("click",e),document.getElementById("mobile-meal-plan")?.addEventListener("click",e),l.sharePlanBtn?.addEventListener("click",()=>{if(!u){alert("Veuillez sélectionner un menu à partager.");return}Dt({plan:u})}),l.inviteParticipantBtn?.addEventListener("click",()=>{if(!u){alert("Veuillez sélectionner un menu pour inviter des participants.");return}Nt(u)}),l.historyPlanBtn?.addEventListener("click",ze),l.closePlanHistoryModalBtn?.addEventListener("click",me),l.planHistoryModal?.addEventListener("click",a=>{a.target===l.planHistoryModal&&me()}),l.openTrashBtn?.addEventListener("click",()=>{l.trashModal.classList.remove("hidden")}),l.closeTrashModalBtn?.addEventListener("click",()=>{l.trashModal.classList.add("hidden")}),l.trashModal?.addEventListener("click",a=>{a.target===l.trashModal&&l.trashModal.classList.add("hidden")}),l.savePlanBtn?.addEventListener("click",async()=>{if(!u){alert("Veuillez sélectionner un menu de travail avant de sauvegarder.");return}const a=document.getElementById("save-plan-as-modal"),i=document.getElementById("save-plan-as-form"),t=document.getElementById("save-plan-name"),r=document.getElementById("cancel-save-plan-as-btn"),o=document.getElementById("close-save-plan-as-modal"),s=new Date().toLocaleDateString("fr-FR"),c=u.weeks?Object.keys(u.weeks).filter(f=>u.weeks[f]&&Object.keys(u.weeks[f].menuData||{}).length>0).length:0,d=c>1?`${c} semaines`:`${c} semaine`;t.value=`${u.name} (${d}) - ${s}`,a.classList.remove("hidden");const m=async f=>{f.preventDefault();const y=t.value;if(!y)return;u.weeks||(u.weeks={}),u.weeks[$]={menuData:h,servingsData:R,remarksData:F},u.startDay=P,u.defaultNumPeople=j;const g=JSON.parse(JSON.stringify(u));if(g.weeks)for(const L in g.weeks){const b=g.weeks[L];if(b&&b.menuData)for(const C in b.menuData){const w=b.menuData[C];Array.isArray(w)&&(b.menuData[C]=w.map(k=>k&&k.id&&z.find(A=>A.id===k.id)||k))}}await yt(y,g),a.classList.add("hidden"),i.removeEventListener("submit",m)},p=()=>{a.classList.add("hidden"),i.removeEventListener("submit",m)};i.addEventListener("submit",m,{once:!0}),r.addEventListener("click",p,{once:!0}),o.addEventListener("click",p,{once:!0})})}function ct(e=""){return e.split(" ").map(i=>i[0]).join("").substring(0,2).toUpperCase()}function fe(e=[],n={}){const a=document.getElementById("collaborators-bar"),i=document.getElementById("activity-labels-container"),t=document.getElementById("name-tooltip");if(!a||!t||!i)return;if(a.innerHTML="",i.innerHTML="",document.querySelectorAll(".remark-lock-overlay").forEach(s=>s.remove()),document.querySelectorAll("textarea[data-slot-id]").forEach(s=>{s.disabled=!1}),e.length<=1&&Object.keys(n).length<=1){a.classList.add("hidden");return}let r="";const o=ye();e.forEach(s=>{if(!s)return;const c=n.hasOwnProperty(s.uid),d=n[s.uid]||{},m=document.createElement("div");m.className="w-8 h-8 rounded-full flex items-center justify-center bg-gray-300 text-white font-bold text-xs ring-2 ring-white cursor-pointer transition-all duration-300";const p=c?"(présent)":"(absent)";if(m.dataset.name=`${s.displayName||"Inconnu"} ${p}`,s.photoURL?m.innerHTML=`<img src="${s.photoURL}" alt="${s.displayName}" class="w-full h-full rounded-full object-cover">`:m.textContent=ct(s.displayName),c||m.classList.add("grayscale","opacity-50"),m.addEventListener("mouseenter",f=>{t.textContent=f.currentTarget.dataset.name,t.classList.remove("hidden");const y=f.currentTarget.getBoundingClientRect();t.style.left=`${y.left+y.width/2-t.offsetWidth/2}px`,t.style.top=`${y.top-t.offsetHeight-5}px`}),m.addEventListener("mouseleave",()=>{t.classList.add("hidden")}),a.appendChild(m),c&&s.uid!==o){const f=d.status;if(typeof f=="object"&&f.type==="editing_remark"){const y=document.querySelector(`textarea[data-slot-id="${f.fieldId}"]`);if(y){y.disabled=!0;const g=document.createElement("div");g.className="remark-lock-overlay absolute inset-0 bg-gray-400 bg-opacity-25 flex items-center justify-center text-xs text-white font-bold",g.innerHTML=`<i class="fas fa-lock mr-1"></i> ${s.displayName} écrit...`,y.parentElement&&(y.parentElement.classList.add("relative"),y.parentElement.appendChild(g))}}else if(typeof f=="string"&&f!=="idle"){let y="";switch(f){case"editing_recipe":y="modifie une recette...";break}y&&(r+=`<span class="italic mr-4">${s.displayName} ${y}</span>`)}}}),i.innerHTML=r,a.classList.remove("hidden")}function Ne(){Pt();const e=l.planSelect.value;e&&localStorage.setItem("lastActivePlanId",e),u=xe.find(o=>o.id===e)||null;const n=document.getElementById("delete-plan-btn"),a=document.getElementById("rename-plan-btn"),i=document.getElementById("leave-plan-btn"),t=document.getElementById("invite-participant-btn"),r=document.getElementById("history-plan-btn");if(n&&(n.style.display=u&&u.isOwner?"inline-flex":"none"),a&&(a.style.display=u&&u.isOwner?"inline-flex":"none"),r&&(r.style.display=u&&u.isOwner?"inline-flex":"none"),i&&(i.style.display=u&&!u.isOwner?"inline-flex":"none"),t){const o=u&&(u.type==="collaborative"||u.collaborators&&u.collaborators.length>0);t.style.display=u&&u.isOwner&&o?"inline-flex":"none"}u&&u.participants&&u.participants.length>1?(fe(u.participants,{}),Tt(u.id,o=>{fe(u.participants,o)})):fe([],{}),u&&(u.manualItems=u.manualItems||[]),Ee()}async function $e(e,n){if(!u)return;const a=JSON.parse(JSON.stringify(R));n===j?delete a[e]:a[e]=n;const[i,t]=e.split("-"),s=`a changé le nombre de personnes pour ${_[parseInt(i,10)]} ${t==="lunch"?"midi":"soir"} à ${n}`;await V({[`weeks.${$}.servingsData`]:a},s)}async function dt(){if(!M)return;const e=pt();lt(),We(),await be();const n=Lt(ue(M,"recipes"),i=>{if(console.log("Recipe data updated from listener."),z=i.docs.map(t=>{const r=t.data();return{id:t.id,...r,imageUrl:r.imageUrl||""}}),u){for(const t in h){const r=h[t];if(Array.isArray(r)){const o=r.map(s=>{if(s&&s.id){const c=z.find(d=>d.id===s.id);return c?{...c}:s}return s});h[t]=o}}ie(l.mealPlanGrid,{menuData:h,servingsData:R,remarksData:F,defaultNumPeople:j,startDay:P},!1),Le(document.getElementById("mobile-meal-plan"),{menuData:h,servingsData:R,remarksData:F,defaultNumPeople:j,startDay:P},!1),le()}}),a=ft(i=>{xe=i,gt(i);const t=localStorage.getItem("selectedPlanId"),r=localStorage.getItem("lastActivePlanId");t&&i.some(o=>o.id===t)?(l.planSelect.value=t,localStorage.removeItem("selectedPlanId")):r&&i.some(o=>o.id===r)&&(l.planSelect.value=r),Ne()});return()=>{a(),n(),e()}}const ut=dt();return async()=>{const e=await ut;typeof e=="function"&&e()}}export{qt as default};
