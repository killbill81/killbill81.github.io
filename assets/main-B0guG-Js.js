import{o as bn,s as vn,a as _t,g as le,c as U,b as Ce,d as st,e as $,q as me,f as y,w as ee,u as Me,h as Ve,i as be,j as Ot,k as zt,l as _e,m as $t,n as xn,p as En,r as gt,t as Rt,v as Cn,x as wn,y as Ln,z as In,A as Bn,B as Vt,C as Sn,D as Nn,_ as Mn}from"./firebase-config-DS3K-luN.js";const kn=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"}));let ct=null;function Qt(){return new Promise(e=>{bn(_t,t=>{if(ct=t,t){console.log("User is logged in:",t.uid);const n=document.getElementById("logout-btn"),s=document.getElementById("profile-btn");n&&n.classList.remove("hidden"),s&&s.classList.remove("hidden"),n&&!n.hasAttribute("data-listener-attached")&&(n.addEventListener("click",()=>{vn(_t).catch(o=>{console.error("Sign Out Error",o)})}),n.setAttribute("data-listener-attached","true")),e(t)}else{console.log("User not logged in. Redirecting to login.html");const n=window.location.origin+"/login.html";window.location.href!==n&&(window.location.href=n),e(null)}})})}function ge(){return ct?ct.uid:null}function Se(){return ct}const Tn=Object.freeze(Object.defineProperty({__proto__:null,getCurrentUser:Se,getCurrentUserId:ge,protectPage:Qt},Symbol.toStringTag,{value:"Module"}));class Mt{constructor(t,n,s,o,d,g,p,v,x,L,N,w,O,f,j,G){this.db=t,this.modal=document.getElementById(n),this.form=document.getElementById(s),this.modalTitle=document.getElementById(o),this.recipeIdInput=document.getElementById(d),this.recipeNameInput=document.getElementById(g),this.recipeCategoryInput=document.getElementById(p),this.recipeServingsInput=document.getElementById(v),this.recipePrepTimeInput=document.getElementById(x),this.recipeDifficultyInput=document.getElementById(L),this.recipeStepsTextarea=document.getElementById(N),this.ingredientsListDiv=document.getElementById(w),this.addIngredientBtn=document.getElementById(O),this.saveRecipeBtn=document.getElementById(f),this.closeButton=document.getElementById(j),this.cancelButton=document.getElementById(G),this.masterIngredientList=[],this.activityUpdater=null,this.boundAddIngredient=()=>this.addIngredientInput(void 0,this.form.ingredients),this.boundCloseForm=()=>this.closeForm(),this.boundHandleSubmit=K=>this.handleSubmit(K),this.addIngredientBtn.addEventListener("click",this.boundAddIngredient),this.closeButton.addEventListener("click",this.boundCloseForm),this.cancelButton.addEventListener("click",this.boundCloseForm),this.saveRecipeBtn.addEventListener("click",this.boundHandleSubmit)}setActivityUpdater(t){this.activityUpdater=t}destroy(){this.addIngredientBtn.removeEventListener("click",this.boundAddIngredient),this.closeButton.removeEventListener("click",this.boundCloseForm),this.cancelButton.removeEventListener("click",this.boundCloseForm),this.saveRecipeBtn.removeEventListener("click",this.boundHandleSubmit)}async openForm(t=null,n="Ajouter une recette"){this.activityUpdater&&this.activityUpdater("editing_recipe"),await this.fetchMasterIngredients(),console.log("openForm called with recipe:",t,"and title:",n),this.form.reset(),this.ingredientsListDiv.innerHTML="",this.modalTitle.textContent=n;const s=[];if(this.form.ingredients=s,t){this.recipeIdInput.value=t.id||"",this.recipeNameInput.value=t.name||"";const o=t.category||"Plat";for(const d of this.recipeCategoryInput.options)if(d.value.toLowerCase()===o.toLowerCase()){d.selected=!0;break}this.recipeServingsInput.value=parseInt(t.servings)||"",this.recipePrepTimeInput.value=parseInt(t.prepTime)||"",this.recipeDifficultyInput.value=t.difficulty||"Moyen",this.recipeStepsTextarea.value=t.steps||"",t.ingredients&&t.ingredients.length>0?t.ingredients.forEach(d=>this.addIngredientInput({...d},s)):this.addIngredientInput(void 0,s)}else this.recipeIdInput.value="",this.addIngredientInput(void 0,s);this.modal.classList.remove("hidden")}closeForm(){this.activityUpdater&&this.activityUpdater("idle"),this.modal.classList.add("hidden")}async fetchMasterIngredients(){if(this.masterIngredientList=[],!!this.db)try{const t=await le(U(this.db,"ingredients"));this.masterIngredientList=t.docs.map(n=>({id:n.id,...n.data()})),this.masterIngredientList.sort((n,s)=>n.name.localeCompare(s.name))}catch(t){console.error("Erreur lors de la r√©cup√©ration de la liste des ingr√©dients: ",t),alert("Impossible de charger la liste des ingr√©dients de base. La recherche ne fonctionnera pas.")}}addIngredientInput(t={quantity:"",name:"",unit:""},n){const s=document.createElement("div");s.className="relative flex items-stretch space-x-2 ingredient-row";const o={...t};n.push(o);const d=n.length-1,g=document.createElement("input");g.type="text",g.className="ingredient-quantity mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm",g.placeholder="Qt√©",g.value=o.quantity,g.addEventListener("change",w=>{n[d].quantity=w.target.value});const p=document.createElement("input");p.type="text",p.className="ingredient-unit mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm bg-gray-100",p.placeholder="Unit√©",p.readOnly=!0,p.value=o.unit||"";const v=document.createElement("div");v.className="relative w-1/2";const x=document.createElement("input");x.type="text",x.className="ingredient-name mt-1 block w-full rounded-md border-gray-300 shadow-sm",x.placeholder="Chercher un ingr√©dient...",x.value=o.name,v.appendChild(x);const L=document.createElement("div");L.className="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto",v.appendChild(L),x.addEventListener("input",()=>{const w=x.value.toLowerCase();if(!w){L.classList.add("hidden");return}const O=this.masterIngredientList.filter(j=>j.name.toLowerCase().includes(w));L.innerHTML="",O.forEach(j=>{const G=document.createElement("div");G.className="p-2 hover:bg-tomato hover:text-white cursor-pointer",G.textContent=j.name,G.addEventListener("click",()=>{x.value=j.name,p.value=j.unit,L.classList.add("hidden"),n[d].name=j.name,n[d].unit=j.unit,n[d].id=j.id}),L.appendChild(G)});const f=document.createElement("div");f.className="p-2 bg-blue-50 hover:bg-blue-200 cursor-pointer font-bold text-blue-700",f.textContent=`+ Cr√©er "${x.value}"`,f.addEventListener("click",async()=>{const j=x.value,G="pi√®ce(s)";try{const K=await Ce(U(this.db,"ingredients"),{name:j,unit:G});await this.fetchMasterIngredients(),x.value=j,p.value=G,L.classList.add("hidden"),n[d].name=j,n[d].unit=G,n[d].id=K.id}catch(K){console.error("Erreur d'ajout d'ingr√©dient",K),alert("L'ingr√©dient n'a pas pu √™tre cr√©√©.")}}),L.appendChild(f),L.classList.remove("hidden")});const N=document.createElement("button");N.type="button",N.className="btn btn-ghost text-red-500 hover:bg-red-50 btn-sm mt-1",N.innerHTML='<i class="fas fa-trash"></i>',N.addEventListener("click",()=>{s.remove(),n[d]=null}),s.appendChild(v),s.appendChild(g),s.appendChild(p),s.appendChild(N),this.ingredientsListDiv.appendChild(s)}async handleSubmit(t){t.preventDefault(),this.saveRecipeBtn.disabled=!0,this.saveRecipeBtn.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i> Sauvegarde...',console.log("Ingredients array from form before filter:",this.form.ingredients);const n=this.form.ingredients.filter(d=>d!==null&&d.quantity&&d.name);console.log("Ingredients array after filter:",n);const s={name:this.recipeNameInput.value,category:this.recipeCategoryInput.value,servings:parseInt(this.recipeServingsInput.value)||0,prepTime:parseInt(this.recipePrepTimeInput.value)||0,difficulty:this.recipeDifficultyInput.value,steps:this.recipeStepsTextarea.value,ingredients:n,imageUrl:""};console.log("Recipe data being sent to Firebase:",s);const o=this.recipeIdInput.value;try{o?await st($(this.db,"recipes",o),s):await Ce(U(this.db,"recipes"),s),this.closeForm(),console.log("Recipe saved successfully!"),this.onSaveCallback&&this.onSaveCallback()}catch(d){console.error("Erreur de sauvegarde: ",d),alert("Une erreur est survenue lors de la sauvegarde.")}finally{this.saveRecipeBtn.disabled=!1,this.saveRecipeBtn.textContent="Sauvegarder"}}setOnSaveCallback(t){this.onSaveCallback=t}}const Dn=Object.freeze(Object.defineProperty({__proto__:null,RecipeFormHandler:Mt},Symbol.toStringTag,{value:"Module"}));let Ct=()=>{};function Pn(){const e=document.getElementById("search-friends-input");return document.getElementById("search-friends-btn").addEventListener("click",()=>Ht(e.value)),e.addEventListener("keyup",n=>{n.key==="Enter"&&Ht(e.value)}),_n(),Jt(),()=>{Ct&&Ct()}}async function _n(){const e=document.getElementById("friends-list-container"),t=Se()?.uid;if(!t||!e)return;e.innerHTML='<p class="text-gray-500">Chargement...</p>';const n=$(y,"users",t);Ct=Ve(n,async s=>{if(!s.exists()){e.innerHTML='<p class="text-red-500">Erreur: Utilisateur non trouv√©.</p>';return}const o=s.data().friends||[];if(e.innerHTML="",o.length===0){e.innerHTML=`<p class="text-gray-500">Vous n'avez pas encore d'amis. Utilisez la recherche pour en ajouter.</p>`;return}for(const d of o)try{const g=await be($(y,"users",d));g.exists()&&e.appendChild($n(g.data()))}catch(g){console.error("Erreur de chargement d'un ami",g)}})}function $n(e){const t=document.createElement("div");t.className="bg-white p-3 rounded-lg flex items-center justify-between shadow-sm";const n=document.createElement("div");n.className="flex items-center",n.innerHTML=`
        <img src="${e.photoURL||"https://placehold.co/40"}" alt="Avatar" class="w-10 h-10 rounded-full mr-3">
        <div>
            <p class="font-bold">${e.displayName}</p>
            <p class="text-sm text-gray-500">${e.email}</p>
        </div>
    `;const s=document.createElement("button");return s.className="btn btn-ghost text-red-500 btn-sm",s.innerHTML='<i class="fas fa-user-times"></i>',s.title="Retirer cet ami",s.addEventListener("click",()=>Rn(e.uid)),t.appendChild(n),t.appendChild(s),t}async function Rn(e){const t=Se()?.uid;if(!t||!e){console.error("Impossible de supprimer l'ami : ID utilisateur ou ID ami manquant.");return}if(!confirm("Voulez-vous vraiment retirer cet ami ? Cette action est unilat√©rale."))return;console.log(`Tentative de suppression de l'ami ${e} pour l'utilisateur ${t}`);const n=$(y,"users",t);try{await Me(n,{friends:Ot(e)}),console.log("Ami supprim√© avec succ√®s de la base de donn√©es.")}catch(s){console.error("Erreur lors de la suppression de l'ami: ",s),alert("Une erreur est survenue.")}}async function Ht(e){const t=document.getElementById("search-results-container"),n=Se()?.uid;if(!(!e||!t)){t.innerHTML='<p class="text-gray-500">Recherche en cours...</p>';try{const s=e.toLowerCase(),o=s+"Ô£ø",d=me(U(y,"users"),ee("displayName_lowercase",">=",s),ee("displayName_lowercase","<",o)),g=me(U(y,"users"),ee("email","==",s)),[p,v]=await Promise.all([le(d),le(g)]),x=new Map;if(p.forEach(L=>x.set(L.id,L.data())),v.forEach(L=>x.set(L.id,L.data())),t.innerHTML="",x.size===0){t.innerHTML='<p class="text-gray-500">Aucun utilisateur trouv√©.</p>';return}x.forEach(L=>{if(L.uid===n)return;const N=document.createElement("div");N.className="bg-gray-50 p-2 rounded-lg flex items-center justify-between",N.innerHTML=`
                <div class="flex items-center">
                    <img src="${L.photoURL||"https://placehold.co/32"}" class="w-8 h-8 rounded-full mr-2">
                    <span class="font-medium text-sm">${L.displayName} (${L.email})</span>
                </div>
            `;const w=document.createElement("button");w.className="btn btn-secondary btn-xs",w.innerHTML='<i class="fas fa-user-plus"></i>',w.addEventListener("click",()=>Hn(L.uid)),N.appendChild(w),t.appendChild(N)})}catch(s){console.error("Erreur de recherche: ",s),t.innerHTML='<p class="text-red-500">Erreur de recherche.</p>'}}}async function Hn(e){const t=Se()?.uid;if(!t||t===e)return;const n=me(U(y,"friend_requests"),ee("senderId","==",t),ee("receiverId","==",e)),s=me(U(y,"friend_requests"),ee("senderId","==",e),ee("receiverId","==",t)),[o,d]=await Promise.all([le(n),le(s)]);if(!o.empty||!d.empty)return alert("Une demande d'ami existe d√©j√† avec cet utilisateur.");if((await be($(y,"users",t))).data()?.friends?.includes(e))return alert("Vous √™tes d√©j√† ami avec cet utilisateur.");try{await Ce(U(y,"friend_requests"),{senderId:t,receiverId:e,status:"pending",createdAt:zt()}),alert("Demande d'ami envoy√©e !")}catch(p){console.error("Erreur lors de l'envoi de la demande d'ami: ",p),alert("Une erreur est survenue.")}}async function Jt(){const e=document.getElementById("pending-requests-container"),t=document.getElementById("declined-requests-container"),n=Se()?.uid;if(!(!n||!e||!t)){e.innerHTML='<p class="text-gray-500">Chargement...</p>',t.innerHTML='<p class="text-gray-500">Chargement...</p>';try{const s=me(U(y,"friend_requests"),ee("senderId","==",n)),o=await le(s),d=[],g=[];for(const p of o.docs){const v={id:p.id,...p.data()},x=await be($(y,"users",v.receiverId));x.exists()&&(v.receiver=x.data()),v.status==="pending"?d.push(v):v.status==="declined"&&g.push(v)}e.innerHTML="",d.length>0?d.forEach(p=>e.appendChild(jt(p))):e.innerHTML='<p class="text-gray-500">Aucune demande en attente.</p>',t.innerHTML="",g.length>0?g.forEach(p=>t.appendChild(jt(p))):t.innerHTML='<p class="text-gray-500">Aucune demande rejet√©e.</p>'}catch(s){console.error("Erreur lors du chargement des demandes envoy√©es: ",s),e.innerHTML='<p class="text-red-500">Erreur de chargement.</p>',t.innerHTML='<p class="text-red-500">Erreur de chargement.</p>'}}}function jt(e){const t=document.createElement("div");t.className="bg-white p-3 rounded-lg flex items-center justify-between shadow-sm";const n=e.receiver,s=document.createElement("div");s.className="flex items-center",s.innerHTML=`
        <img src="${n?.photoURL||"https://placehold.co/40"}" alt="Avatar" class="w-10 h-10 rounded-full mr-3">
        <div>
            <p class="font-bold">${n?.displayName||"Utilisateur inconnu"}</p>
            <p class="text-sm text-gray-500">Statut : <span class="font-medium">${e.status}</span></p>
        </div>
    `;const o=document.createElement("button");return o.className="btn btn-ghost text-red-500 btn-sm",o.innerHTML='<i class="fas fa-times-circle"></i>',o.title="Annuler la demande",o.addEventListener("click",async()=>{confirm("Voulez-vous vraiment annuler cette demande ?")&&(await _e($(y,"friend_requests",e.id)),Jt())}),t.appendChild(s),t.appendChild(o),t}async function Wt(e){try{const t=$(y,"friend_requests",e);await Me(t,{status:"accepted"})}catch(t){throw console.error("Erreur lors de l'acceptation de la demande d'ami: ",t),t}}async function Gt(e){try{const t=$(y,"friend_requests",e);await Me(t,{status:"declined"})}catch(t){throw console.error("Erreur lors du refus de la demande d'ami: ",t),t}}const jn=Object.freeze(Object.defineProperty({__proto__:null,acceptFriendRequest:Wt,declineFriendRequest:Gt,default:Pn},Symbol.toStringTag,{value:"Module"}));function qn(){const e=document.getElementById("ingredients-list-container"),t=document.getElementById("add-ingredient-btn"),n=document.getElementById("category-tabs"),s=document.getElementById("search-bar"),o=document.getElementById("ingredient-form-modal"),d=document.getElementById("ingredient-modal-title"),g=document.getElementById("close-ingredient-modal"),p=document.getElementById("cancel-ingredient-btn"),v=document.getElementById("ingredient-form"),x=document.getElementById("ingredient-id"),L=document.getElementById("ingredient-name"),N=document.getElementById("ingredient-unit"),w=document.getElementById("ingredient-category"),O=document.getElementById("manage-categories-btn"),f=document.getElementById("category-management-modal"),j=document.getElementById("close-category-modal"),G=document.getElementById("done-category-modal-btn"),K=document.getElementById("add-category-form"),ke=document.getElementById("new-category-name"),V=document.getElementById("category-list");let F=[],k=[],Q="",Z="",he=null;const te=["g","kg","ml","l","pi√®ce(s)","c.√†.s.","c.√†.c.","pinc√©e(s)"];async function de(){await Ee(),await ye()}async function Ee(){if(y)try{k=(await le(U(y,"ingredient_categories"))).docs.map(M=>({id:M.id,...M.data()})),k.sort((M,C)=>M.name.localeCompare(C.name))}catch(_){console.error("Erreur lors de la r√©cup√©ration des cat√©gories: ",_)}}async function ye(){if(y)try{F=(await le(U(y,"ingredients"))).docs.map(M=>({id:M.id,...M.data()})),W(),se()}catch(_){console.error("Erreur de chargement des ingr√©dients: ",_)}}function Ae(_=null){v.reset(),N.innerHTML="",te.forEach(R=>{const X=document.createElement("option");X.value=R,X.textContent=R,N.appendChild(X)});const M=k.map(R=>R.name),C=[...new Set(F.map(R=>R.category).filter(Boolean))],B=[...new Set([...M,...C])];B.sort((R,X)=>R.localeCompare(X.name)),w.innerHTML="",B.forEach(R=>{const X=document.createElement("option");X.value=R,X.textContent=R,w.appendChild(X)}),_?(d.textContent="Modifier l'ingr√©dient",x.value=_.id,L.value=_.name,N.value=_.unit||"",w.value=_.category||(B.length>0?B[0]:"")):(d.textContent="Ajouter un ingr√©dient",x.value="",N.value=te[0],w.value=Q||(B.length>0?B[0]:"")),o.classList.remove("hidden")}function Ue(){o.classList.add("hidden")}async function H(_){_.preventDefault();const M=x.value,C={name:L.value,unit:N.value,category:w.value};if(!C.name||!C.category){alert("Le nom et la cat√©gorie sont requis.");return}try{M?await st($(y,"ingredients",M),C):await Ce(U(y,"ingredients"),C),Ue(),await ye()}catch(B){console.error("Erreur de sauvegarde de l'ingr√©dient: ",B)}}function I(){z(),f.classList.remove("hidden")}function P(){f.classList.add("hidden")}function z(){if(V.innerHTML="",k.length===0){V.innerHTML='<p class="text-gray-500">Aucune cat√©gorie d√©finie.</p>';return}k.forEach(_=>{const M=document.createElement("div");M.className="flex items-center justify-between p-2 border-b";const C=document.createElement("span");C.textContent=_.name,M.appendChild(C);const B=document.createElement("div");B.className="flex space-x-2";const R=document.createElement("button");R.className="btn btn-ghost btn-xs text-blue-500",R.innerHTML='<i class="fas fa-edit"></i>',R.addEventListener("click",()=>J(_)),B.appendChild(R);const X=document.createElement("button");X.className="btn btn-ghost btn-xs text-red-500",X.innerHTML='<i class="fas fa-trash"></i>',X.addEventListener("click",()=>re(_)),B.appendChild(X),M.appendChild(B),V.appendChild(M)})}async function Y(_){_.preventDefault();const M=ke.value.trim();if(M&&!k.find(C=>C.name.toLowerCase()===M.toLowerCase()))try{await Ce(U(y,"ingredient_categories"),{name:M}),ke.value="",await Ee(),z(),W()}catch(C){console.error("Erreur d'ajout de cat√©gorie: ",C)}else alert("Cette cat√©gorie existe d√©j√† ou le nom est invalide.")}async function J(_){const M=_.name,C=prompt(`Entrez le nouveau nom pour la cat√©gorie "${M}":`,M);if(C&&C.trim()!==""&&C!==M)try{await st($(y,"ingredient_categories",_.id),{name:C});const B=me(U(y,"ingredients"),ee("category","==",M)),R=await le(B),X=$t(y);R.forEach(Fe=>{X.update(Fe.ref,{category:C})}),await X.commit(),await de(),z()}catch(B){console.error("Erreur de renommage: ",B)}}async function re(_){if(confirm(`√ätes-vous s√ªr de vouloir supprimer la cat√©gorie "${_.name}"?

Tous les ingr√©dients associ√©s seront d√©plac√©s vers la cat√©gorie "Inconnue".`))try{await _e($(y,"ingredient_categories",_.id));const M=me(U(y,"ingredients"),ee("category","==",_.name)),C=await le(M),B=$t(y);C.forEach(R=>{B.update(R.ref,{category:"Inconnue"})}),await B.commit(),Q="",await de(),z()}catch(M){console.error("Erreur de suppression: ",M)}}function W(){n.innerHTML="";const _=k.map(B=>B.name),M=[...new Set(F.map(B=>B.category||"Inconnue"))];let C=[...new Set([..._,...M])];C.sort((B,R)=>B.localeCompare(R)),C.includes("Inconnue")&&(C=C.filter(B=>B!=="Inconnue"),C.push("Inconnue")),C.length===0&&F.length>0&&C.push("Inconnue"),!Q&&C.length>0&&(Q=C[0]),C.forEach(B=>{const R=document.createElement("button"),X=B===Q;R.className=`px-4 py-2 text-sm font-medium rounded-t-lg ${X?"bg-tomato text-white":"text-gray-500 hover:text-tomato"}`,R.textContent=B,R.addEventListener("click",()=>ne(B)),n.appendChild(R)})}function ne(_){Q=_,W(),se()}function se(){e.innerHTML="";const _=Q||(k.length>0?k[0].name:"Inconnue");let M=F.filter(B=>(B.category||"Inconnue")===_);if(Z){const B=Z.toLowerCase();M=M.filter(R=>R.name.toLowerCase().includes(B))}if(M.length===0){e.innerHTML='<p class="text-center text-gray-500 p-10">Aucun ingr√©dient dans cette cat√©gorie.</p>';return}M.sort((B,R)=>B.name.localeCompare(R.name,"fr",{sensitivity:"base"}));const C=document.createElement("div");C.className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4",M.forEach(B=>{const R=document.createElement("div");R.className="p-3 bg-white shadow-sm rounded-lg flex flex-col items-start space-y-2";const X=document.createElement("div");X.className="flex-grow w-full flex justify-between items-center";const Fe=document.createElement("span");Fe.className="font-medium text-gray-800",Fe.textContent=B.name;const Ze=document.createElement("span");Ze.className="text-gray-500 text-sm bg-gray-100 px-2 py-1 rounded-full",Ze.textContent=B.unit,X.appendChild(Fe),X.appendChild(Ze);const Qe=document.createElement("div");Qe.className="w-full flex justify-end items-center space-x-2 border-t pt-2 mt-2";const Je=document.createElement("button");Je.className="btn btn-ghost btn-xs text-blue-500 hover:bg-blue-50",Je.innerHTML='<i class="fas fa-edit"></i>',Je.addEventListener("click",()=>Ae(B));const Oe=document.createElement("button");Oe.className="btn btn-ghost btn-xs text-red-500 hover:bg-red-50",Oe.innerHTML='<i class="fas fa-trash-alt"></i>',Oe.addEventListener("click",()=>ve(B.id,B.name)),Qe.appendChild(Je),Qe.appendChild(Oe),R.appendChild(X),R.appendChild(Qe),C.appendChild(R)}),e.appendChild(C)}async function ve(_,M){if(confirm(`√ätes-vous s√ªr de vouloir supprimer l'ingr√©dient "${M}" ?`))try{await _e($(y,"ingredients",_)),await ye()}catch(C){console.error("Erreur de suppression de l'ingr√©dient: ",C)}}s.addEventListener("input",_=>{const M=_.target.value.toLowerCase();if(!Z&&M&&(he=Q),Z=M,Z){const C=F.find(B=>B.name.toLowerCase().includes(Z));C&&(Q=C.category||"Inconnue")}else he&&(Q=he,he=null);W(),se()}),t.addEventListener("click",()=>Ae()),g.addEventListener("click",Ue),p.addEventListener("click",Ue),v.addEventListener("submit",H),O.addEventListener("click",I),j.addEventListener("click",P),G.addEventListener("click",P),K.addEventListener("submit",Y),de()}const An=Object.freeze(Object.defineProperty({__proto__:null,default:qn},Symbol.toStringTag,{value:"Module"})),A={modal:document.getElementById("share-modal"),closeBtn:document.getElementById("close-share-modal"),title:document.getElementById("share-modal-title"),friendsList:document.getElementById("share-friends-list"),sharePlanCheckbox:document.getElementById("share-planning-checkbox"),shareShoppingListCheckbox:document.getElementById("share-shopping-list-checkbox"),confirmBtn:document.getElementById("confirm-share-btn")};let Pe={};function pt(){A.modal.classList.add("hidden");const e=document.getElementById("share-mode-selection");e&&e.classList.remove("hidden"),A.confirmBtn.textContent="Envoyer le partage";const t=A.confirmBtn.cloneNode(!0);A.confirmBtn.parentNode&&(A.confirmBtn.parentNode.replaceChild(t,A.confirmBtn),A.confirmBtn=t,t.addEventListener("click",Xt))}async function Xt(){const e=ge();if(!e||!Pe.plan)return;const t=Array.from(A.friendsList.querySelectorAll('input[type="checkbox"]:checked')).map(s=>s.value),n=document.querySelector('input[name="share-mode"]:checked')?.value;if(t.length===0){alert("Veuillez s√©lectionner au moins un ami.");return}if(!n){alert("Veuillez s√©lectionner un mode de partage.");return}A.confirmBtn.disabled=!0,A.confirmBtn.textContent="Envoi en cours...";try{const s=U(y,"shares");let o={};n==="collaborate"?o={senderId:e,createdAt:new Date,type:"collaborative_plan_invite",planId:Pe.plan.id,planName:Pe.plan.name}:o={senderId:e,createdAt:new Date,type:"share",plan:{name:Pe.plan.name,weeks:Pe.plan.weeks||{},manualItems:Pe.plan.manualItems||[],defaultNumPeople:Pe.plan.defaultNumPeople||1,startDay:Pe.plan.startDay||"Lundi"}};for(const d of t)await Ce(s,{...o,receiverId:d,status:"pending"});pt(),alert("Partage envoy√© avec succ√®s !")}catch(s){console.error("Erreur lors de l'envoi du partage : ",s),alert("Une erreur est survenue lors de l'envoi du partage.")}finally{A.confirmBtn.disabled=!1,A.confirmBtn.textContent="Envoyer le partage"}}async function kt(e={}){const{plan:t}=e;if(!t){alert("Aucun plan s√©lectionn√© √† partager.");return}Pe={plan:t},A.title.textContent=`Partager le plan "${t.name}"`,A.friendsList.innerHTML='<p class="text-gray-500">Chargement des amis...</p>',A.modal.classList.remove("hidden");const n=ge();if(n)try{const s=await be($(y,"users",n));if(s.exists()){const d=s.data().friends||[];if(d.length===0){A.friendsList.innerHTML=`<p class="text-gray-500">Vous n'avez pas d'amis √† qui partager.</p>`;return}A.friendsList.innerHTML="";for(const g of d){const p=await be($(y,"users",g));if(p.exists()){const v=p.data(),x=document.createElement("label");x.className="flex items-center p-2 hover:bg-gray-100 rounded-lg cursor-pointer";const L=document.createElement("input");L.type="checkbox",L.value=v.uid,L.className="form-checkbox h-5 w-5 text-tomato rounded focus:ring-tomato",x.appendChild(L);const N=document.createElement("img");N.src=v.photoURL||"https://placehold.co/40x40",N.alt=v.displayName,N.className="w-8 h-8 rounded-full ml-3 mr-3",x.appendChild(N);const w=document.createElement("span");w.className="font-medium",w.textContent=v.displayName||v.email,x.appendChild(w),A.friendsList.appendChild(x)}}}}catch(s){console.error("Erreur lors du chargement des amis pour le partage : ",s),A.friendsList.innerHTML='<p class="text-red-500">Une erreur est survenue.</p>'}}async function Un(e){const t=ge();if(!t||!e)return;const n=Array.from(A.friendsList.querySelectorAll('input[type="checkbox"]:checked:not(:disabled)')).map(s=>s.value);if(n.length===0){alert("Veuillez s√©lectionner au moins un ami √† inviter.");return}A.confirmBtn.disabled=!0,A.confirmBtn.textContent="Envoi en cours...";try{const s=await be($(y,"plans",e));if(!s.exists())throw new Error("Plan not found");const o=s.data().name,d=U(y,"shares"),g={senderId:t,createdAt:new Date,type:"collaborative_plan_invite",planId:e,planName:o};for(const p of n)await Ce(d,{...g,receiverId:p,status:"pending"});pt(),alert("Invitation(s) envoy√©e(s) avec succ√®s !")}catch(s){console.error("Erreur lors de l'envoi de l'invitation : ",s),alert("Une erreur est survenue lors de l'envoi de l'invitation.")}finally{A.confirmBtn.disabled=!1}}async function Yt(e){if(!e||!e.id){alert("Plan non valide pour l'invitation.");return}Pe={plan:e},A.title.textContent=`Inviter √† collaborer sur "${e.name}"`;const t=document.getElementById("share-mode-selection");t&&t.classList.add("hidden"),A.friendsList.innerHTML='<p class="text-gray-500">Chargement des amis...</p>',A.modal.classList.remove("hidden");const n=ge();if(!n)return;try{const o=await be($(y,"users",n));if(o.exists()){const g=o.data().friends||[],p=[e.userId,...e.collaborators||[]];if(g.length===0){A.friendsList.innerHTML=`<p class="text-gray-500">Vous n'avez pas d'amis √† inviter.</p>`;return}A.friendsList.innerHTML="";for(const v of g){const x=await be($(y,"users",v));if(x.exists()){const L=x.data(),N=p.includes(L.uid),w=document.createElement("label");w.className=`flex items-center p-2 rounded-lg ${N?"opacity-50 cursor-not-allowed":"hover:bg-gray-100 cursor-pointer"}`;const O=document.createElement("input");O.type="checkbox",O.value=L.uid,O.className="form-checkbox h-5 w-5 text-tomato rounded focus:ring-tomato",N&&(O.disabled=!0,O.checked=!0),w.appendChild(O);const f=document.createElement("img");f.src=L.photoURL||"https://placehold.co/40x40",f.alt=L.displayName,f.className="w-8 h-8 rounded-full ml-3 mr-3",w.appendChild(f);const j=document.createElement("span");if(j.className="font-medium",j.textContent=L.displayName||L.email,N){const G=document.createElement("span");G.className="text-xs text-gray-400 ml-2",G.textContent="(d√©j√† membre)",j.appendChild(G)}w.appendChild(j),A.friendsList.appendChild(w)}}}}catch(o){console.error("Erreur lors du chargement des amis pour l'invitation : ",o),A.friendsList.innerHTML='<p class="text-red-500">Une erreur est survenue.</p>'}A.confirmBtn.textContent="Envoyer l'invitation";const s=A.confirmBtn.cloneNode(!0);A.confirmBtn.parentNode.replaceChild(s,A.confirmBtn),A.confirmBtn=s,s.addEventListener("click",()=>Un(e.id))}A.closeBtn?.addEventListener("click",pt);A.modal?.addEventListener("click",e=>{e.target===A.modal&&pt()});A.confirmBtn?.addEventListener("click",Xt);const Fn=Object.freeze(Object.defineProperty({__proto__:null,openInviteParticipantModal:Yt,openShareModal:kt},Symbol.toStringTag,{value:"Module"}));function On(){const e=document.getElementById("search-bar"),t=document.getElementById("lists-container"),n=document.getElementById("add-list-btn"),s=document.getElementById("shared-lists-container"),o=document.getElementById("list-form-modal"),d=document.getElementById("list-modal-title"),g=document.getElementById("close-list-modal"),p=document.getElementById("cancel-list-btn"),v=document.getElementById("list-form"),x=document.getElementById("list-id"),L=document.getElementById("list-name"),N=document.getElementById("ingredients-list"),w=document.getElementById("add-ingredient-btn"),O=document.getElementById("save-list-btn");let f=[],j="",G=[],K=[];async function ke(){await V(),await F(),await k()}async function V(){if(y)try{G=(await le(U(y,"ingredients"))).docs.map(I=>({id:I.id,...I.data()})),G.sort((I,P)=>I.name.localeCompare(P.name))}catch(H){console.error("Erreur lors de la r√©cup√©ration de la liste des ingr√©dients: ",H)}}async function F(){const H=ge();if(!(!y||!H))try{const I=me(U(y,"shopping_lists"),ee("userId","==",H));f=(await le(I)).docs.map(z=>({id:z.id,...z.data()})).filter(z=>z.isShared!==!0),de()}catch(I){console.error("Erreur de chargement des listes: ",I)}}async function k(){const H=ge();if(!(!y||!H)){console.log(`Recherche de listes partag√©es pour userId: ${H}`);try{const I=me(U(y,"shopping_lists"),ee("userId","==",H),ee("isShared","==",!0)),P=await le(I);console.log(`Trouv√© ${P.size} liste(s) partag√©e(s).`);const z=P.docs.map(Y=>({id:Y.id,...Y.data()}));Ee(z)}catch(I){console.error("Erreur de chargement des listes partag√©es: ",I)}}}async function Q(H=null){await V(),v.reset(),N.innerHTML="",K=[],H?(d.textContent="Modifier la liste",x.value=H.id,L.value=H.name,H.ingredients&&H.ingredients.length>0?H.ingredients.forEach(I=>te(I)):te()):(d.textContent="Cr√©er une liste",x.value="",te()),o.classList.remove("hidden")}function Z(){o.classList.add("hidden")}async function he(H){H.preventDefault(),O.disabled=!0;const I=ge();if(!I){alert("Erreur : utilisateur non connect√©."),O.disabled=!1;return}const P=K.filter(J=>J&&J.name&&J.quantity),z={name:L.value,ingredients:P,userId:I};if(!z.name){alert("Le nom de la liste est requis."),O.disabled=!1;return}const Y=x.value;try{Y?await st($(y,"shopping_lists",Y),z):await Ce(U(y,"shopping_lists"),z),Z(),await F()}catch(J){console.error("Erreur de sauvegarde de la liste: ",J)}finally{O.disabled=!1}}function te(H={quantity:"",name:"",unit:""}){const I=document.createElement("div");I.className="relative flex items-stretch space-x-2 ingredient-row";const P={...H};K.push(P);const z=K.length-1,Y=document.createElement("input");Y.type="text",Y.className="ingredient-quantity mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm",Y.placeholder="Qt√©",Y.value=P.quantity,Y.addEventListener("change",ve=>{K[z].quantity=ve.target.value});const J=document.createElement("input");J.type="text",J.className="ingredient-unit mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm bg-gray-100",J.placeholder="Unit√©",J.readOnly=!0,J.value=P.unit||"";const re=document.createElement("div");re.className="relative w-1/2";const W=document.createElement("input");W.type="text",W.className="ingredient-name mt-1 block w-full rounded-md border-gray-300 shadow-sm",W.placeholder="Chercher un ingr√©dient...",W.value=P.name,re.appendChild(W);const ne=document.createElement("div");ne.className="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto",re.appendChild(ne),W.addEventListener("input",()=>{const ve=W.value.toLowerCase();if(!ve){ne.classList.add("hidden");return}const _=G.filter(C=>C.name.toLowerCase().includes(ve));ne.innerHTML="",_.forEach(C=>{const B=document.createElement("div");B.className="p-2 hover:bg-tomato hover:text-white cursor-pointer",B.textContent=C.name,B.addEventListener("click",()=>{W.value=C.name,J.value=C.unit,ne.classList.add("hidden"),K[z].name=C.name,K[z].unit=C.unit,K[z].id=C.id}),ne.appendChild(B)});const M=document.createElement("div");M.className="p-2 bg-blue-50 hover:bg-blue-200 cursor-pointer font-bold text-blue-700",M.textContent=`+ Cr√©er "${W.value}"`,M.addEventListener("click",async()=>{const C=W.value,B="pi√®ce(s)";try{const R=await Ce(U(y,"ingredients"),{name:C,unit:B,category:"Inconnue"});await V(),W.value=C,J.value=B,ne.classList.add("hidden"),K[z].name=C,K[z].unit=B,K[z].id=R.id}catch(R){console.error("Erreur d'ajout d'ingr√©dient",R),alert("L'ingr√©dient n'a pas pu √™tre cr√©√©.")}}),ne.appendChild(M),ne.classList.remove("hidden")});const se=document.createElement("button");se.type="button",se.className="btn btn-ghost text-red-500 hover:bg-red-50 btn-sm mt-1",se.innerHTML='<i class="fas fa-trash"></i>',se.addEventListener("click",()=>{I.remove(),K[z]=null}),I.appendChild(re),I.appendChild(Y),I.appendChild(J),I.appendChild(se),N.appendChild(I)}function de(){t.innerHTML="";let H=f;if(j){const I=j.toLowerCase();H=f.filter(P=>P.name.toLowerCase().includes(I))}if(H.length===0){t.innerHTML='<p class="text-center text-gray-500 p-10 col-span-full">Aucune liste de courses trouv√©e.</p>';return}H.sort((I,P)=>I.name.localeCompare(P.name)),H.forEach(I=>{const P=document.createElement("div");P.className="bg-white rounded-lg shadow-md p-4 flex flex-col";const z=document.createElement("div");z.className="flex justify-between items-start border-b pb-2 mb-2";const Y=document.createElement("h4");Y.className="text-lg font-bold text-gray-800",Y.textContent=I.name,z.appendChild(Y);const J=document.createElement("div");J.className="flex space-x-2";const re=document.createElement("button");re.className="btn btn-ghost btn-sm text-blue-500",re.innerHTML='<i class="fas fa-edit"></i>',re.addEventListener("click",()=>Q(I)),J.appendChild(re);const W=document.createElement("button");W.className="btn btn-ghost btn-sm text-green-500",W.innerHTML='<i class="fas fa-share-alt"></i>',W.addEventListener("click",()=>kt({})),J.appendChild(W);const ne=document.createElement("button");ne.className="btn btn-ghost btn-sm text-red-500",ne.innerHTML='<i class="fas fa-trash"></i>',ne.addEventListener("click",()=>ye(I.id,I.name)),J.appendChild(ne),z.appendChild(J);const se=document.createElement("ul");se.className="space-y-1 text-sm text-gray-600 flex-grow",I.ingredients&&I.ingredients.length>0?I.ingredients.forEach(ve=>{const _=document.createElement("li");_.textContent=`${ve.quantity} ${ve.unit||""} - ${ve.name}`.trim(),se.appendChild(_)}):se.innerHTML='<li class="italic text-gray-400">Cette liste est vide.</li>',P.appendChild(z),P.appendChild(se),t.appendChild(P)})}function Ee(H){if(s.innerHTML="",H.length===0){s.innerHTML='<p class="text-center text-gray-500 p-10 col-span-full">Aucune liste de courses partag√©e trouv√©e.</p>';return}H.sort((I,P)=>I.name.localeCompare(P.name)),H.forEach(I=>{const P=document.createElement("div");P.className="bg-white rounded-lg shadow-md p-4 flex flex-col";const z=document.createElement("div");z.className="flex justify-between items-start border-b pb-2 mb-2";const Y=document.createElement("h4");Y.className="text-lg font-bold text-gray-800",Y.textContent=I.name,z.appendChild(Y);const J=document.createElement("div");J.className="flex space-x-2";const re=document.createElement("button");re.className="btn btn-secondary btn-sm",re.innerHTML='<i class="fas fa-copy mr-2"></i> Copier dans mes listes',re.title="Copier cette liste dans vos listes personnelles",re.addEventListener("click",()=>Ue(I.id)),J.appendChild(re);const W=document.createElement("button");W.className="btn btn-ghost btn-sm text-red-500",W.innerHTML='<i class="fas fa-trash"></i>',W.title="Supprimer cette liste partag√©e",W.addEventListener("click",()=>Ae(I.id,I.name)),J.appendChild(W),z.appendChild(J);const ne=document.createElement("ul");ne.className="space-y-1 text-sm text-gray-600 flex-grow",I.ingredients&&I.ingredients.length>0?I.ingredients.forEach(se=>{const ve=document.createElement("li");ve.textContent=`${se.quantity} ${se.unit||""} - ${se.name}`.trim(),ne.appendChild(ve)}):ne.innerHTML='<li class="italic text-gray-400">Cette liste est vide.</li>',P.appendChild(z),P.appendChild(ne),s.appendChild(P)})}async function ye(H,I){if(confirm(`√ätes-vous s√ªr de vouloir supprimer la liste "${I}" ?`))try{await _e($(y,"shopping_lists",H)),await F()}catch(P){console.error("Erreur de suppression de la liste: ",P)}}async function Ae(H,I){if(confirm(`√ätes-vous s√ªr de vouloir supprimer la liste partag√©e "${I}" ?`))try{await _e($(y,"shopping_lists",H)),await k()}catch(P){console.error("Erreur de suppression de la liste partag√©e: ",P),alert("Une erreur est survenue.")}}async function Ue(H){if(confirm("Voulez-vous vraiment copier cette liste dans vos listes personnelles ? Elle ne sera plus consid√©r√©e comme une liste partag√©e."))try{const I=$(y,"shopping_lists",H);await Me(I,{isShared:!1}),await ke()}catch(I){console.error("Erreur lors de la copie de la liste: ",I),alert("Une erreur est survenue.")}}e.addEventListener("input",H=>{j=H.target.value,de()}),n.addEventListener("click",()=>Q()),g.addEventListener("click",Z),p.addEventListener("click",Z),v.addEventListener("submit",he),w.addEventListener("click",()=>te()),y&&ke()}const zn=Object.freeze(Object.defineProperty({__proto__:null,default:On},Symbol.toStringTag,{value:"Module"})),$e=xn();let rt,ht,yt,nt,ae,it,bt,vt,at,ze,ot,xt,Et,wt,Lt,ut=null,mt=null;function Vn(){rt&&rt.classList.remove("hidden")}function It(){rt&&rt.classList.add("hidden"),nt&&nt.reset()}function Qn(e,t){mt=e,ze&&(ze.value=t),it&&it.classList.remove("hidden"),ze&&ze.focus()}function Bt(){mt=null,it&&it.classList.add("hidden"),at&&at.reset()}function Jn(e,t){ut=e,wt&&(wt.textContent="Confirmer la suppression"),Lt&&(Lt.textContent=`√ätes-vous s√ªr de vouloir supprimer le plan "${t}" ? Cette action est irr√©versible.`),ot&&ot.classList.remove("hidden")}function qt(){ut=null,ot&&ot.classList.add("hidden")}async function Wn(e){const t=Se();if(t)try{await Ce(U($e,"plans"),{userId:t.uid,name:e,type:"personal",weeks:{},manualItems:[],defaultNumPeople:1,startDay:"Lundi",lastUpdated:new Date}),It()}catch(n){console.error("Error creating plan: ",n),alert("Erreur lors de la cr√©ation du plan.")}}async function Gn(e,t){if(!(!e||!t))try{const n=$($e,"plans",e);await Me(n,{name:t}),Bt()}catch(n){console.error("Error renaming plan: ",n),alert("Erreur lors du renommage du plan.")}}async function Xn(e){const t=Se()?.uid;if(!(!e||!t)&&confirm("Voulez-vous vraiment quitter ce plan partag√© ? Il n'appara√Ætra plus dans votre liste."))try{const n=$($e,"plans",e);await Me(n,{collaborators:Ot(t)})}catch(n){console.error("Erreur pour quitter le plan: ",n),alert("Une erreur est survenue.")}}async function Yn(e){if(e)try{await _e($($e,"plans",e))}catch(t){console.error("Error deleting plan: ",t),alert("Erreur lors de la suppression du plan.")}}function Kt(e){const t=Se();if(!t)return()=>{};let n=new Map;const s=()=>{e(Array.from(n.values()).sort((x,L)=>x.name.localeCompare(L.name)))},o=async x=>{const N=[x.userId,...x.collaborators||[]].map(O=>be($($e,"users",O)));return(await Promise.all(N)).map(O=>O.exists()?O.data():{uid:O.id,displayName:"Inconnu"})},d=me(U($e,"plans"),ee("userId","==",t.uid)),g=Ve(d,async x=>{const N=x.docChanges().map(async w=>{if(w.type==="removed")n.delete(w.doc.id);else{const O=w.doc.data(),f=await o(O);n.set(w.doc.id,{id:w.doc.id,...O,isOwner:!0,participants:f})}});await Promise.all(N),s()}),p=me(U($e,"plans"),ee("collaborators","array-contains",t.uid)),v=Ve(p,async x=>{const N=x.docChanges().map(async w=>{if(w.type==="removed")n.delete(w.doc.id);else{const O=w.doc.data(),f=await o(O),j=f.find(G=>G.uid===O.userId);n.set(w.doc.id,{id:w.doc.id,...O,isOwner:!1,ownerName:j?.displayName||"Inconnu",participants:f})}});await Promise.all(N),s()});return()=>{g(),v()}}function Zt(e){if(!ae)return;const t=ae.value;if(ae.innerHTML="",e.length===0){const n=document.createElement("option");n.value="",n.textContent="Aucun plan personnel",n.disabled=!0,ae.appendChild(n);return}e.forEach(n=>{const s=document.createElement("option");s.value=n.id;let o=n.name;n.collaborators&&n.collaborators.length>0&&(n.isOwner?o=`üëë ${n.name} [Collab]`:o=`üë• ${n.name} [Collab] (de ${n.ownerName})`),s.textContent=o,ae.appendChild(s)}),t&&ae.querySelector(`option[value="${t}"]`)?ae.value=t:ae.selectedIndex=0}function en(){rt=document.getElementById("create-plan-modal"),ht=document.getElementById("close-create-plan-modal"),yt=document.getElementById("cancel-create-plan-btn"),nt=document.getElementById("create-plan-form"),ae=document.getElementById("plan-select"),it=document.getElementById("rename-plan-modal"),bt=document.getElementById("close-rename-plan-modal"),vt=document.getElementById("cancel-rename-plan-btn"),at=document.getElementById("rename-plan-form"),ze=document.getElementById("new-plan-name"),ot=document.getElementById("delete-confirm-modal"),xt=document.getElementById("cancel-delete-btn"),Et=document.getElementById("confirm-delete-btn"),wt=document.getElementById("delete-confirm-title"),Lt=document.getElementById("delete-confirm-message");const e=document.getElementById("create-plan-btn"),t=document.getElementById("rename-plan-btn"),n=document.getElementById("leave-plan-btn"),s=document.getElementById("delete-plan-btn");e&&e.addEventListener("click",Vn),t&&t.addEventListener("click",()=>{if(ae&&ae.value){const o=ae.options[ae.selectedIndex];Qn(ae.value,o.text)}else alert("Veuillez s√©lectionner un plan √† renommer.")}),n&&n.addEventListener("click",()=>{ae&&ae.value?Xn(ae.value):alert("Veuillez s√©lectionner un plan.")}),s&&s.addEventListener("click",()=>{if(ae&&ae.value){const o=ae.options[ae.selectedIndex].text;Jn(ae.value,o)}else alert("Veuillez s√©lectionner un plan √† supprimer.")}),ht&&ht.addEventListener("click",It),yt&&yt.addEventListener("click",It),nt&&nt.addEventListener("submit",o=>{o.preventDefault();const d=document.getElementById("plan-name");d&&d.value&&Wn(d.value)}),bt&&bt.addEventListener("click",Bt),vt&&vt.addEventListener("click",Bt),at&&at.addEventListener("submit",o=>{o.preventDefault(),mt&&ze.value&&Gn(mt,ze.value)}),xt&&xt.addEventListener("click",qt),Et&&Et.addEventListener("click",()=>{ut&&Yn(ut).then(()=>{qt()})})}async function tn(e,t){if(!(!e||!t))try{const n=$($e,"plans",e);await Me(n,{collaborators:En(t),type:"collaborative"})}catch(n){console.error("Error adding collaborator: ",n)}}async function St(e,t,n="Modification diverse"){if(!e||!t)return;const s=Se();if(s)try{const o=U($e,"plans",e,"history"),d=JSON.parse(JSON.stringify(t));await Ce(o,{planState:d,timestamp:zt(),modifiedBy:s.uid,modifiedByName:s.displayName||s.email,description:n})}catch(o){console.error("Error saving history:",o)}}const Kn=Object.freeze(Object.defineProperty({__proto__:null,addCollaborator:tn,getUserPlans:Kt,initPlanManagement:en,populatePlanSelector:Zt,saveHistory:St},Symbol.toStringTag,{value:"Module"}));let nn=[],an=[],sn=()=>{},rn=()=>{};const oe={btn:null,badge:null,dropdown:null,list:null};async function Zn(e,t,n){const s=ge();if(s)try{const o=$(y,"shares",e);if(await Me(o,{status:"accepted"}),t.plan){const d=n.displayName||"Inconnu",g=`Copie de "${t.plan.name}" (de ${d})`,p={...t.plan,userId:s,name:g,isShared:!0,originalOwnerId:t.senderId,sharedAt:new Date,collaborators:[]};delete p.id,await Ce(U(y,"plans"),p)}t.shoppingList&&await Ce(U(y,"shopping_lists"),{name:`${t.shoppingList.name} (de ${n.displayName})`,ingredients:t.shoppingList.ingredients,userId:s,isShared:!0,originalOwner:n.uid,sharedAt:new Date})}catch(o){console.error("Erreur lors de l'acceptation du partage : ",o),alert("Une erreur est survenue.")}}async function ea(e,t){const n=ge();if(!(!n||!t||!t.planId))try{await tn(t.planId,n);const s=$(y,"shares",e);await Me(s,{status:"accepted"})}catch(s){console.error("Erreur lors de l'acceptation de l'invitation : ",s),alert("Une erreur est survenue.")}}async function At(e){try{const t=$(y,"shares",e);await Me(t,{status:"declined"})}catch(t){console.error("Erreur lors du refus du partage : ",t),alert("Une erreur est survenue.")}}async function ta(e){try{await Wt(e)}catch{alert("Erreur lors de l'acceptation.")}}async function na(e){try{await Gt(e)}catch{alert("Erreur lors du refus.")}}function on(){if(!oe.list)return;const e=[...nn,...an];e.sort((t,n)=>n.createdAt.toMillis()-t.createdAt.toMillis()),e.length>0?(oe.badge.textContent=e.length,oe.badge.classList.remove("hidden")):oe.badge.classList.add("hidden"),oe.list.innerHTML="",e.length===0?oe.list.innerHTML='<p class="text-gray-500 text-center p-4">Aucune nouvelle notification.</p>':e.forEach(t=>{const n=aa(t);oe.list.appendChild(n)})}function aa(e){const t=document.createElement("div");t.className="p-3 border-b border-gray-100 hover:bg-gray-50";const n=document.createElement("p");n.className="text-sm font-medium text-gray-800";const s=document.createElement("p");s.className="text-xs text-gray-500 mb-3";const o=document.createElement("div");o.className="flex space-x-2 justify-end";const d=e.data.type||e.type;if(d==="collaborative_plan_invite"){n.textContent="Invitation √† collaborer",s.textContent=`${e.sender.displayName} vous invite √† modifier son plan "${e.data.planName}".`;const g=Xe("Accepter","btn-secondary",v=>{v.target.textContent="...",v.target.disabled=!0,ea(e.id,e.data)}),p=Xe("Refuser","btn-ghost text-red-500",v=>{v.target.disabled=!0,At(e.id)});o.append(g,p)}else if(d==="share"){n.textContent=`Partage de ${e.sender.displayName||e.sender.email}`;let g=[];e.data.plan&&g.push("planification"),e.data.shoppingList&&g.push("liste de courses"),s.textContent=`Contenu : ${g.join(" et ")}`;const p=Xe("Accepter","btn-secondary",x=>{x.target.textContent="...",x.target.disabled=!0,Zn(e.id,e.data,e.sender)}),v=Xe("Refuser","btn-ghost text-red-500",x=>{x.target.disabled=!0,At(e.id)});o.append(p,v)}else if(d==="friend_request"){n.textContent="Invitation d'ami",s.textContent=`${e.sender.displayName||e.sender.email} vous a envoy√© une invitation.`;const g=Xe("Accepter","btn-secondary",v=>{v.target.textContent="...",v.target.disabled=!0,ta(e.id)}),p=Xe("Refuser","btn-ghost text-red-500",v=>{v.target.disabled=!0,na(e.id)});o.append(g,p)}return t.append(n,s,o),t}function Xe(e,t,n){const s=document.createElement("button");return s.className=`btn btn-xs ${t}`,s.textContent=e,s.addEventListener("click",o=>{o.stopPropagation(),n(o)}),s}function sa(e){const t=U(y,"shares"),n=me(t,ee("receiverId","==",e),ee("status","==","pending"));sn=Ve(n,async s=>{const o=[];for(const d of s.docs){const g=d.data(),p=await be($(y,"users",g.senderId));p.exists()&&o.push({type:g.type||"share",id:d.id,data:g,sender:p.data(),createdAt:g.createdAt})}nn=o,on()},s=>{console.error("Erreur d'√©coute des partages:",s)})}function ra(e){const t=U(y,"friend_requests"),n=me(t,ee("receiverId","==",e),ee("status","==","pending"));rn=Ve(n,async s=>{const o=[];for(const d of s.docs){const g=d.data(),p=await be($(y,"users",g.senderId));p.exists()&&o.push({type:"friend_request",id:d.id,data:g,sender:p.data(),createdAt:g.createdAt})}an=o,on()},s=>{console.error("Erreur d'√©coute des invitations d'amis:",s)})}function ln(){if(oe.btn=document.getElementById("notifications-btn"),oe.badge=document.getElementById("notifications-badge"),oe.dropdown=document.getElementById("notifications-dropdown"),oe.list=document.getElementById("notifications-list"),!oe.btn)return;const e=ge();e&&(sn(),rn(),sa(e),ra(e),oe.btn.addEventListener("click",t=>{t.stopPropagation(),oe.dropdown.classList.toggle("hidden")}),document.addEventListener("click",t=>{oe.dropdown&&!oe.dropdown.classList.contains("hidden")&&!oe.btn.contains(t.target)&&!oe.dropdown.contains(t.target)&&oe.dropdown.classList.add("hidden")}))}const ia=Object.freeze(Object.defineProperty({__proto__:null,initNotifications:ln},Symbol.toStringTag,{value:"Module"}));let qe=null,Ke=null;function dn(e,t){if(!gt||!e)return;const n=Se();if(!n)return;const s=Rt(gt,`plans_presence/${e}`);qe=Rt(gt,`plans_presence/${e}/${n.uid}`);const o={displayName:n.displayName||n.email,photoURL:n.photoURL,status:"idle",last_seen:Vt()};Cn(qe).remove(),wn(qe,o),Ke&&Ke(),Ke=Ln(s,d=>{const g=d.val()||{};typeof t=="function"&&t(g)})}function cn(){qe&&(In(qe),qe=null),Ke&&(Ke(),Ke=null)}function dt(e){qe&&Bn(qe,{status:e,last_seen:Vt()})}const oa=Object.freeze(Object.defineProperty({__proto__:null,connectToPresenceChannel:dn,disconnectFromPresenceChannel:cn,updateUserActivity:dt},Symbol.toStringTag,{value:"Module"}));let Ye=null;function la(){const e=document.getElementById("search-bar"),t=document.getElementById("category-tabs"),n=document.getElementById("recipe-list-container"),s=document.getElementById("add-recipe-btn");Ye&&Ye.destroy(),Ye=new Mt(y,"recipe-form-modal","recipe-form","recipe-modal-title","recipe-id","recipe-name","recipe-category","recipe-servings","recipe-prep-time","recipe-difficulty","recipe-steps","ingredients-list","add-ingredient-btn","save-recipe-btn","close-recipe-modal","cancel-recipe-btn"),Ye.setOnSaveCallback(O);let o=[],d="",g="",p=null;const v=["Entr√©e","Plat","Accompagnement","Dessert"],x={PLAT:"bg-orange-100",DESSERT:"bg-amber-100",ENTREE:"bg-lime-100",ACCOMPAGNEMENT:"bg-stone-200","PETIT-DEJEUNER":"bg-orange-100",BOISSON:"bg-cyan-100",SAUCE:"bg-red-100"},L={PLAT:"text-orange-800",DESSERT:"text-amber-800",ENTREE:"text-lime-800",ACCOMPAGNEMENT:"text-stone-800","PETIT-DEJEUNER":"text-orange-800",BOISSON:"text-cyan-800",SAUCE:"text-red-800"},N="bg-gray-100",w="text-gray-800";async function O(){if(console.log("fetchAllRecipes called."),!!y)try{o=(await le(U(y,"recipes"))).docs.map(F=>({id:F.id,...F.data()})),console.log("Fetched recipes:",o),j(),G()}catch(V){console.error("Erreur lors de la r√©cup√©ration des recettes: ",V)}}function f(V){d=V,j(),G()}function j(){if(!t)return;t.innerHTML="";const F=[...new Set(o.map(k=>k.category||"Non class√©"))].sort((k,Q)=>{const Z=de=>{const Ee=de.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();for(let ye=0;ye<v.length;ye++)if(v[ye].normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()===Ee)return ye;return-1},he=Z(k),te=Z(Q);return he>-1&&te>-1?he-te:he>-1?-1:te>-1?1:k.localeCompare(Q)});!d&&F.length>0&&(d=F[0]),F.forEach(k=>{const Q=document.createElement("button"),Z=k.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toUpperCase();if(k===d){const te=x[Z]||N,de=L[Z]||w;Q.className=`px-4 py-2 text-sm font-bold rounded-t-lg ${te} ${de}`}else Q.className="px-4 py-2 text-sm font-medium text-gray-500 hover:text-tomato";Q.textContent=k,Q.addEventListener("click",()=>f(k)),t.appendChild(Q)})}function G(){if(!n)return;n.innerHTML="";let V=o.filter(k=>(k.category||"Non class√©")===d);if(g){const k=g.toLowerCase();V=V.filter(Q=>Q.name.toLowerCase().includes(k))}if(V.sort((k,Q)=>k.name.localeCompare(Q.name)),V.length===0){n.innerHTML='<p class="text-gray-500 text-center p-10">Aucune recette trouv√©e.</p>';return}const F=document.createElement("div");F.className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4",V.forEach(k=>{F.appendChild(K(k))}),n.appendChild(F)}function K(V){let F=N;if(V.category){const ye=V.category.normalize("NFD").replace(/[ÃÄ-ÕØ]/g,"").toUpperCase();F=x[ye]||N}const k=document.createElement("div");k.className=`rounded-lg shadow-sm flex flex-col p-2 ${F}`;const Q=document.createElement("h4");Q.className="text-sm font-bold text-gray-800 truncate",Q.textContent=V.name,Q.title=V.name,k.appendChild(Q);const Z=document.createElement("p");Z.className="text-xs text-gray-600 mt-1",Z.textContent=`${V.difficulty||""} - Pour ${V.servings||"?"} pers.`,k.appendChild(Z);const he=document.createElement("div");he.className="flex-grow",k.appendChild(he);const te=document.createElement("div");te.className="flex justify-end space-x-2 mt-2";const de=document.createElement("button");de.className="btn btn-outline btn-xs border-gray-400 hover:bg-gray-200",de.innerHTML='<i class="fas fa-edit"></i>',de.title="Modifier",de.addEventListener("click",()=>Ye.openForm(V,"Modifier la recette")),te.appendChild(de);const Ee=document.createElement("button");return Ee.className="btn btn-ghost text-red-700 hover:bg-red-100 btn-xs",Ee.innerHTML='<i class="fas fa-trash-alt"></i>',Ee.title="Supprimer",Ee.addEventListener("click",()=>ke(V.id,V.name)),te.appendChild(Ee),k.appendChild(te),k}async function ke(V,F){if(confirm(`√ätes-vous s√ªr de vouloir supprimer la recette "${F}" ?`))try{await _e($(y,"recipes",V)),O()}catch(k){console.error("Erreur lors de la suppression: ",k)}}s.addEventListener("click",()=>Ye.openForm(null,"Ajouter une recette")),e.addEventListener("input",V=>{const F=V.target.value;if(!g&&F&&(p=d),g=F,g){const k=g.toLowerCase(),Q=o.find(Z=>Z.name.toLowerCase().includes(k));Q&&(d=Q.category||"Non class√©")}else p&&(d=p,p=null);j(),G()}),y&&O()}const da=Object.freeze(Object.defineProperty({__proto__:null,default:la},Symbol.toStringTag,{value:"Module"}));let je=null;function ca(){const e={mealPlanGrid:document.getElementById("meal-plan-grid"),currentWeekDisplay:document.getElementById("current-week-display"),prevWeekBtn:document.getElementById("prev-week-btn"),nextWeekBtn:document.getElementById("next-week-btn"),clearMenuBtn:document.getElementById("clear-menu-btn"),shoppingListContainer:document.getElementById("shopping-list"),startDaySelect:document.getElementById("start-day-select"),defaultServingsControl:document.getElementById("default-servings-control"),mealSelectModal:document.getElementById("meal-select-modal"),closeMealSelectModalBtn:document.getElementById("close-meal-select-modal"),mealSelectModalTitle:document.getElementById("meal-select-modal-title"),mealSelectList:document.getElementById("meal-select-list"),recipeFormModal:document.getElementById("edit-recipe-form-modal"),closeRecipeModalBtn:document.getElementById("close-edit-recipe-modal"),cancelRecipeBtn:document.getElementById("edit-cancel-recipe-btn"),recipeForm:document.getElementById("edit-recipe-form"),addItemInput:document.getElementById("add-item-input"),addItemBtn:document.getElementById("add-item-btn"),addItemResults:document.getElementById("add-item-results"),importListBtn:document.getElementById("import-list-btn"),importListModal:document.getElementById("import-list-modal"),closeImportListModalBtn:document.getElementById("close-import-list-modal"),importListContainer:document.getElementById("import-list-container"),exportTxtBtn:document.getElementById("export-txt-btn"),exportPdfBtn:document.getElementById("export-pdf-btn"),exportPlanPdfBtn:document.getElementById("export-plan-pdf-btn"),sharePlanBtn:document.getElementById("share-plan-btn"),planSelect:document.getElementById("plan-select"),inviteParticipantBtn:document.getElementById("invite-participant-btn"),historyPlanBtn:document.getElementById("history-plan-btn"),planHistoryModal:document.getElementById("plan-history-modal"),closePlanHistoryModalBtn:document.getElementById("close-plan-history-modal"),planHistoryList:document.getElementById("plan-history-list")};function t(a,r){const c=document.createElement("div");c.className="flex items-center space-x-2";const l=document.createElement("button");l.className="btn btn-outline btn-xs",l.textContent="-";const i=document.createElement("span");i.className="font-medium text-center w-6",i.textContent=a;const u=document.createElement("button");return u.className="btn btn-outline btn-xs",u.textContent="+",l.addEventListener("click",()=>{let h=parseInt(i.textContent,10);h>1&&(h--,i.textContent=h,r(h))}),u.addEventListener("click",()=>{let h=parseInt(i.textContent,10);h++,i.textContent=h,r(h)}),c.appendChild(l),c.appendChild(i),c.appendChild(u),c}function n(a,r,c,l=!1){const i=document.createElement("div");i.className="flex flex-col items-center justify-center h-full";const u=document.createElement("button");u.className="btn btn-ghost btn-xs p-0 h-4 flex items-center justify-center w-full",u.innerHTML='<i class="fas fa-plus"></i>',u.disabled=l;const h=document.createElement("span");h.className="font-medium text-center text-sm my-1",h.textContent=a;const m=document.createElement("button");return m.className="btn btn-ghost btn-xs p-0 h-4 flex items-center justify-center w-full",m.innerHTML='<i class="fas fa-minus"></i>',m.disabled=l,r&&(u.classList.add("text-white"),h.classList.add("text-white"),m.classList.add("text-white")),l||(u.addEventListener("click",()=>{let E=parseInt(h.textContent,10);E++,h.textContent=E,c(E)}),m.addEventListener("click",()=>{let E=parseInt(h.textContent,10);E>1&&(E--,h.textContent=E,c(E))})),i.appendChild(u),i.appendChild(h),i.appendChild(m),i}je&&je.destroy(),je=new Mt(y,"edit-recipe-form-modal","edit-recipe-form","edit-recipe-modal-title","edit-recipe-id","edit-recipe-name","edit-recipe-category","edit-recipe-servings","edit-recipe-prep-time","edit-recipe-difficulty","edit-recipe-steps","edit-ingredients-list","edit-add-ingredient-btn","edit-save-recipe-btn","close-edit-recipe-modal","edit-cancel-recipe-btn"),je.setActivityUpdater(dt),je.setOnSaveCallback(async()=>{});let s=1,o="Lundi",d={},g={},p={};const v=[];let x=null,L=[],N=[],w=1,O=[],f=null;const j=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];function G(a){return a?a.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase():""}async function K(a){const r=document.getElementById("unit-select-modal"),c=document.getElementById("unit-modal-title"),l=document.getElementById("unit-modal-list"),i=document.getElementById("unit-modal-cancel");return c.textContent=`Choisir une unit√© pour "${a}"`,l.innerHTML="",new Promise((u,h)=>{const m=["g","kg","ml","l","pi√®ce(s)","c.√†.s.","c.√†.c.","pinc√©e(s)"],E=b=>{r.classList.add("hidden"),u(b)};m.forEach(b=>{const S=document.createElement("button");S.className="btn btn-outline",S.textContent=b,S.addEventListener("click",()=>E(b)),l.appendChild(S)});const T=()=>{r.classList.add("hidden"),h()};i.addEventListener("click",T,{once:!0}),r.addEventListener("click",b=>{b.target===r&&T()},{once:!0}),r.classList.remove("hidden")})}async function ke(){if(y)try{N=(await le(U(y,"ingredients"))).docs.map(r=>({id:r.id,...r.data()})),N.sort((r,c)=>r.name.localeCompare(c.name))}catch(a){console.error("Erreur lors de la r√©cup√©ration des ingr√©dients: ",a)}}function V(){if(!f)d={},g={},p={},w=1,o="Lundi";else{const a=f.weeks?f.weeks[s]||{}:{};d=a.menuData||{},g=a.servingsData||{},p=a.remarksData||{},w=f.defaultNumPeople||1,o=f.startDay||"Lundi"}if(e.startDaySelect&&(e.startDaySelect.value=o),e.defaultServingsControl){e.defaultServingsControl.innerHTML="";const a=t(w,async r=>{w=r,f&&await F({defaultNumPeople:r},`a chang√© le nombre de personnes par d√©faut √† ${r}`)});e.defaultServingsControl.appendChild(a)}mn(),te(e.mealPlanGrid,{menuData:d,servingsData:g,remarksData:p,defaultNumPeople:w,startDay:o},!1),J()}async function F(a,r){if(!f)return;await St(f.id,f,r);const c=$(y,"plans",f.id);try{await Me(c,{...a,lastUpdated:new Date})}catch(l){console.error("Error updating plan:",l),alert("Une erreur de sauvegarde est survenue.")}}function k(){e.planHistoryModal.classList.add("hidden")}async function Q(a){if(f&&confirm("Voulez-vous vraiment restaurer cette version ? L'√©tat actuel sera sauvegard√© dans l'historique avant la restauration."))try{const r=$(y,"plans",f.id,"history",a),c=await be(r);if(!c.exists())throw new Error("Version de l'historique non trouv√©e.");const l=c.data().planState;await St(f.id,f);const i=$(y,"plans",f.id);await st(i,l),k()}catch(r){console.error("Erreur lors du rollback :",r)}}async function Z(a,r){if(f&&confirm("√ätes-vous s√ªr de vouloir supprimer d√©finitivement cette entr√©e de l'historique ?"))try{const c=$(y,"plans",f.id,"history",a);await _e(c),r.remove()}catch(c){console.error("Erreur lors de la suppression de l'historique :",c),alert("Une erreur est survenue lors de la suppression.")}}async function he(){if(f){e.planHistoryList.innerHTML="<p>Chargement de l'historique...</p>",e.planHistoryModal.classList.remove("hidden");try{const a=U(y,"plans",f.id,"history"),r=me(a,Sn("timestamp","desc")),c=await le(r);if(e.planHistoryList.innerHTML="",c.empty){e.planHistoryList.innerHTML="<p>Aucun historique pour ce plan.</p>";return}c.forEach(l=>{const i=l.data(),u=document.createElement("div");u.className="p-3 border-b flex justify-between items-center";const h=document.createElement("div"),m=i.timestamp?.toDate().toLocaleString("fr-FR")||"Date inconnue",E=i.description||"Modification diverse",T=i.modifiedByName||"Inconnu";h.innerHTML=`
                    <p class="font-medium">${T} ${E}</p>
                    <p class="text-sm text-gray-500">${m}</p>
                `;const b=document.createElement("div");b.className="flex items-center space-x-2";const S=document.createElement("button");S.className="btn btn-secondary btn-sm",S.textContent="Revenir √† cette version",S.addEventListener("click",()=>Q(l.id));const D=document.createElement("button");D.className="btn btn-ghost text-red-500 hover:bg-red-100 btn-sm",D.innerHTML='<i class="fas fa-times"></i>',D.title="Supprimer cette version",D.addEventListener("click",q=>{q.stopPropagation(),Z(l.id,u)}),b.appendChild(S),b.appendChild(D),u.appendChild(h),u.appendChild(b),e.planHistoryList.appendChild(u)})}catch(a){console.error("Erreur de chargement de l'historique:",a),e.planHistoryList.innerHTML=`<p class="text-red-500">Impossible de charger l'historique.</p>`}}}function te(a,r,c=!1){if(!a)return;const l=r.menuData||{},i=r.servingsData||{},u=r.remarksData||{},h=r.defaultNumPeople||1,m=r.startDay||"Lundi",E=document.createDocumentFragment(),T=["lunch","dinner"],b=5,S=j.indexOf(m);[...j.slice(S),...j.slice(0,S)].forEach(q=>{const ce=j.indexOf(q),ie=document.createElement("div");ie.className="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] items-stretch border-b border-gray-300";const Le=document.createElement("div");Le.className="font-bold p-2 flex items-center justify-center bg-gray-100 text-sm border-r border-gray-300",Le.textContent=q.toUpperCase(),ie.appendChild(Le),T.forEach(xe=>{const Ie=`${ce}-${xe}`,pe=i[Ie]||h,Te=i.hasOwnProperty(Ie),fe=document.createElement("div"),ue=n(pe,Te,Ne=>{gn(Ie,Ne)},c);let we="border-r border-gray-300 flex items-center justify-center transition-colors duration-300";Te?we+=" bg-tomato":we+=xe==="lunch"?" bg-amber-50":" bg-stone-100",fe.className=we,fe.appendChild(ue),ie.appendChild(fe);for(let Ne=0;Ne<b;Ne++){const Be=`${ce}-${xe}-${Ne}`,Re=l[Be],De=document.createElement("div"),Pt=C(Be);let We="meal-slot p-1 min-h-[70px] flex flex-col justify-start border-r border-gray-300";if(We+=xe==="lunch"?" bg-amber-50":" bg-stone-100",De.className=We,De.dataset.slotId=Be,Pt==="Remarque")De.appendChild(Fe(Be,u,c));else if(Array.isArray(Re)&&Re.length>0){const Ge=document.createElement("div");Ge.className="w-full",Re.forEach((et,tt)=>{Ge.appendChild(B(et,Be,tt,c))}),De.appendChild(Ge),c||De.appendChild(X(Be,!0))}else c||De.appendChild(X(Be,!1));ie.appendChild(De)}}),E.appendChild(ie)}),a.innerHTML="",a.appendChild(E),c||Ze()}async function de(){const a=ge();if(!y||!a)return[];try{const r=me(U(y,"shopping_lists"),ee("userId","==",a));return(await le(r)).docs.map(u=>({id:u.id,...u.data()})).filter(u=>u.isShared!==!0)}catch(r){return console.error("Erreur de chargement des listes de courses sauvegard√©es: ",r),[]}}async function Ee(){const a=await de();if(e.importListContainer.innerHTML="",a.length===0){e.importListContainer.innerHTML='<p class="text-center text-gray-500">Aucune liste sauvegard√©e.</p>';return}a.forEach(r=>{const c=document.createElement("button");c.className="w-full text-left p-2 hover:bg-gray-100 rounded-lg transition-colors duration-150",c.textContent=r.name,c.addEventListener("click",()=>{confirm(`Voulez-vous vraiment importer les ingr√©dients de la liste "${r.name}" ?`)&&(r.ingredients.forEach(l=>{const i=parseFloat(String(l.quantity).replace(",","."))||0;P(l.name,i,l.unit)}),ye())}),e.importListContainer.appendChild(c)}),e.importListModal.classList.remove("hidden")}function ye(){e.importListModal.classList.add("hidden")}function Ae(){e.addItemInput?.addEventListener("input",()=>{const a=e.addItemInput.value.toLowerCase(),r=e.addItemResults;if(r.innerHTML="",!a){r.classList.add("hidden");return}N.filter(i=>i.name.toLowerCase().includes(a)).forEach(i=>{const u=document.createElement("div");u.className="p-2 hover:bg-gray-100 cursor-pointer",u.textContent=i.name,u.addEventListener("click",()=>{P(i.name,1,i.unit),e.addItemInput.value="",r.classList.add("hidden")}),r.appendChild(u)});const l=document.createElement("div");l.className="p-2 bg-green-50 hover:bg-green-200 cursor-pointer font-bold text-green-700",l.textContent=`+ Cr√©er "${e.addItemInput.value}"`,l.addEventListener("click",async()=>{const i=e.addItemInput.value;try{const u=await K(i);await Ce(U(y,"ingredients"),{name:i,unit:u}),await ke(),P(i,1,u),e.addItemInput.value="",r.classList.add("hidden")}catch{}}),r.appendChild(l),r.classList.remove("hidden")}),e.addItemBtn?.addEventListener("click",()=>{const a=e.addItemInput.value;a&&(P(a,1,""),e.addItemInput.value="",e.addItemResults.classList.add("hidden"))}),document.addEventListener("click",a=>{e.addItemInput&&!e.addItemInput.contains(a.target)&&!e.addItemResults.contains(a.target)&&e.addItemResults.classList.add("hidden")})}function Ue(){if(v.length===0){alert("La liste de courses est vide.");return}const a=v.reduce((i,u)=>{const h=u.category||"Inconnue";return i[h]||(i[h]=[]),i[h].push(u),i},{}),r=Object.keys(a).sort((i,u)=>i==="Inconnue"?1:u==="Inconnue"?-1:i.localeCompare(u));let c=`Liste de courses - GustoPlan

`;r.forEach(i=>{c+=`--- ${i.toUpperCase()} ---
`,a[i].sort((h,m)=>h.name.localeCompare(m.name)).forEach(h=>{let E=`${Number.isInteger(h.totalQuantity)?h.totalQuantity:parseFloat(h.totalQuantity.toFixed(2))} ${h.unit||""} ${h.name}`;if(h.sources&&h.sources.length>0){const T=h.sources.reduce((S,D)=>{const q=`${D.recipeName} (${D.day} ${D.time})`;return S[q]||(S[q]=0),S[q]+=D.quantity,S},{}),b=Object.keys(T).join(" / ");E+=` *** ${b} ***`}c+=E+`
`}),c+=`
`});const l=new Blob([c],{type:"text/plain;charset=utf-8"});saveAs(l,"liste-de-courses.txt")}function H(){if(v.length===0){alert("La liste de courses est vide.");return}const{jsPDF:a}=window.jspdf,r=new a,c=v.reduce((E,T)=>{const b=T.category||"Inconnue";return E[b]||(E[b]=[]),E[b].push(T),E},{}),l=Object.keys(c).sort((E,T)=>E==="Inconnue"?1:T==="Inconnue"?-1:E.localeCompare(T));r.setFontSize(18),r.text("Liste de courses - GustoPlan",14,22);let i=35;const u=r.internal.pageSize.height,h=20,m=()=>{i>u-h&&(r.addPage(),i=20)};l.forEach(E=>{m(),r.setFontSize(14),r.setFont(void 0,"bold"),r.text(`--- ${E.toUpperCase()} ---`,14,i),i+=8,r.setFont(void 0,"normal"),c[E].sort((b,S)=>b.name.localeCompare(S.name)).forEach(b=>{m(),r.setFontSize(12);const S=Number.isInteger(b.totalQuantity)?b.totalQuantity:parseFloat(b.totalQuantity.toFixed(2));if(r.text(`${S} ${b.unit||""} ${b.name}`,14,i),i+=6,b.sources&&b.sources.length>0){const D=b.sources.reduce((q,ce)=>{const ie=`${ce.recipeName} (${ce.day} ${ce.time})`;return q[ie]||(q[ie]=0),q[ie]+=ce.quantity,q},{});r.setFontSize(9),r.setTextColor(100);for(const q in D)m(),r.text(`  * ${q}`,18,i),i+=5;r.setTextColor(0)}i+=2}),i+=5}),r.save("liste-de-courses.pdf")}async function I(){if(!f){alert("Veuillez s√©lectionner un plan √† exporter.");return}const a=document.getElementById("loading-overlay");a&&a.classList.remove("hidden");try{const{jsPDF:r}=window.jspdf,c=new r,l=$(y,"plans",f.id),i=await be(l),u=i.exists()?i.data():null;if(!u||!u.weeks){alert("Ce plan est vide et ne peut pas √™tre export√©.");return}c.setFontSize(18),c.text(`Plan de Repas: ${u.name}`,14,20);const h=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"],m={0:"E",1:"P",2:"A",3:"D"},E=Object.keys(u.weeks).sort((b,S)=>parseInt(b)-parseInt(S));let T=!0;for(const b of E){const D=u.weeks[b].menuData||{};if(Object.keys(D).length===0)continue;const q=[["Jour","Midi","Soir"]],ce=[],ie=h.indexOf(u.startDay||"Lundi"),Le=[...h.slice(ie),...h.slice(0,ie)];for(const Ie of Le){const pe=h.indexOf(Ie);let Te=[],fe=[];for(const ue of["lunch","dinner"])for(const we in m){const Ne=`${pe}-${ue}-${we}`;D[Ne]&&Array.isArray(D[Ne])&&D[Ne].forEach(Be=>{const Re=`[${m[we]}] ${Be.name}`;ue==="lunch"?Te.push(Re):fe.push(Re)})}ce.push([Ie,Te.join(`
`)||"-",fe.join(`
`)||"-"])}c.setFontSize(14);const xe=T?30:c.autoTable.previous.finalY+20;c.text(`Semaine ${b}`,14,xe-5),c.autoTable({startY:xe,head:q,body:ce,theme:"grid",styles:{cellPadding:2,fontSize:8,valign:"middle"},headStyles:{fillColor:[41,128,185],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[245,245,245]}}),T=!1}c.save(`plan_${u.name.replace(/ /g,"_")}.pdf`)}catch(r){console.error("Erreur lors de la g√©n√©ration du PDF du plan :",r),alert("Une erreur est survenue lors de la cr√©ation du PDF.")}finally{a&&a.classList.add("hidden")}}async function P(a,r,c,l=!1){if(!f)return alert("Veuillez s√©lectionner un plan.");const i=$(y,"plans",f.id);try{await Nn(y,async u=>{const h=await u.get(i);if(!h.exists())throw"Le plan n'existe plus.";const m=h.data().manualItems||[],E=`${a.trim().toLowerCase()}_${c||""}`,T=m.findIndex(S=>`${S.name.trim().toLowerCase()}_${S.unit||""}`===E);if(T>-1)m[T].totalQuantity+=r;else{const S=N.find(D=>D.name.toLowerCase()===a.trim().toLowerCase());m.push({name:a.trim(),totalQuantity:r,unit:c,source:"manual",category:S?S.category:"Inconnue"})}const b=m.filter(S=>S.totalQuantity!==0);u.update(i,{manualItems:b,lastUpdated:new Date})})}catch(u){console.error("Erreur transactionnelle lors de l'ajustement de l'ingr√©dient: ",u),alert("Une erreur de synchronisation est survenue. Veuillez r√©essayer.")}}function z(a){const r=a?a.toLowerCase():"";return r.includes("g")||r.includes("ml")?10:1}function Y(){const a=e.shoppingListContainer;if(!a)return;if(a.innerHTML="",v.length===0){a.innerHTML='<p class="text-center text-gray-500 italic py-4">Votre liste de courses est vide.</p>';return}const r=v.reduce((l,i)=>{const u=i.category||"Inconnue";return l[u]||(l[u]=[]),l[u].push(i),l},{});Object.keys(r).sort((l,i)=>l==="Inconnue"?1:i==="Inconnue"?-1:l.localeCompare(i)).forEach(l=>{const i=document.createElement("h4");i.className="text-sm font-bold text-stone-800 bg-stone-200 mt-4 mb-2 px-3 py-1 rounded-md",i.textContent=l,a.appendChild(i);const u=document.createElement("ul");u.className="space-y-2",r[l].sort((m,E)=>m.name.localeCompare(E.name)).forEach(m=>{const E=document.createElement("li");let T="p-2 rounded";E.className=T+(m.source==="manual"?" bg-lemon":" bg-gray-50");const b=document.createElement("div");b.className="flex justify-between items-center";const S=document.createElement("span");S.className="flex-grow text-sm font-medium",S.textContent=m.name,b.appendChild(S);const D=document.createElement("div");D.className="flex items-center space-x-2 mx-2";const q=document.createElement("span");q.className="font-medium w-20 text-center text-sm";const ce=Number.isInteger(m.totalQuantity)?m.totalQuantity:parseFloat(m.totalQuantity.toFixed(2));q.textContent=`${ce} ${m.unit||""}`.trim();const ie=document.createElement("div");ie.className="flex flex-col";const Le=document.createElement("button");Le.className="btn btn-outline btn-xs rounded-b-none",Le.textContent="+",Le.addEventListener("click",async()=>{const pe=z(m.unit);await P(m.name,pe,m.unit)});const xe=document.createElement("button");xe.className="btn btn-outline btn-xs rounded-t-none -mt-px",xe.textContent="-",xe.addEventListener("click",async()=>{const pe=z(m.unit);await P(m.name,-pe,m.unit)}),ie.appendChild(Le),ie.appendChild(xe),D.appendChild(q),D.appendChild(ie),b.appendChild(D);const Ie=document.createElement("button");if(Ie.className="delete-item-btn text-red-500 hover:text-red-700",Ie.innerHTML='<i class="fas fa-trash-alt"></i>',Ie.addEventListener("click",()=>{P(m.name,-m.totalQuantity,m.unit,!0)}),b.appendChild(Ie),E.appendChild(b),m.sources&&m.sources.length>0){const pe=document.createElement("div");pe.className="p-2 mt-1 ml-4 rounded-md bg-stone-100";const Te=m.sources.reduce((fe,ue)=>{const we=`${ue.recipeName} (${ue.day} ${ue.time})`;return fe[we]||(fe[we]=0),fe[we]+=ue.quantity,fe},{});for(const fe in Te){const ue=document.createElement("span");ue.className="block text-xs text-gray-500",ue.textContent=`‚Ü≥ ${fe}`,pe.appendChild(ue)}E.appendChild(pe)}u.appendChild(E)}),a.appendChild(u)})}async function J(){if(!f){v.length=0,Y();return}const a=f.manualItems?JSON.parse(JSON.stringify(f.manualItems)):[],r=new Map(a.map(i=>[`${i.name.trim().toLowerCase()}_${i.unit||""}`,i])),c=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];if(f.weeks)for(const i in f.weeks){const u=f.weeks[i],h=u.menuData||{},m=u.servingsData||{};for(const E in h){const T=h[E];if(!Array.isArray(T))continue;const[b,S]=E.split("-"),D=parseInt(b,10),q=c[D]||"Jour inconnu",ce=S==="lunch"?"midi":"soir",ie=`${D}-${S}`,Le=parseInt(m[ie]||f.defaultNumPeople,10);for(const xe of T){const pe=L.find(fe=>fe.id===xe.id)||xe;if(!pe||!Array.isArray(pe.ingredients))continue;const Te=pe.servings||1;Te<=0||pe.ingredients.forEach(fe=>{const{name:ue,quantity:we,unit:Ne}=fe;if(!ue||!we)return;const Be=N.find(He=>He.name.toLowerCase()===ue.trim().toLowerCase()),Re=Be?Be.category:"Inconnue",De=parseFloat(String(we).replace(",","."));if(isNaN(De))return;const We=De/Te*Le,Ge=Ne||"",et=`${ue.trim().toLowerCase()}_${Ge}`,tt={recipeName:pe.name,day:`${q} (S${i})`,time:ce,quantity:We};if(r.has(et)){const He=r.get(et);He.totalQuantity+=We,He.source==="manual"&&(He.source="mixed"),Array.isArray(He.sources)?He.sources.push(tt):He.sources=[tt]}else r.set(et,{name:ue.trim(),totalQuantity:We,unit:Ge,source:"plan",category:Re,sources:[tt]})})}}}const l=Array.from(r.values()).filter(i=>i.totalQuantity>0);v.length=0,v.push(...l.sort((i,u)=>i.name.localeCompare(u.name))),Y()}function re(a){const r=C(a);if(!r||!e.mealSelectModal)return;e.mealSelectModalTitle.textContent=`S√©lectionner : ${r}`,e.mealSelectList.innerHTML="";const c=document.createElement("input");c.type="text",c.placeholder="Rechercher dans la cat√©gorie...",c.className="w-full p-2 mb-4 border border-gray-300 rounded-lg",e.mealSelectList.appendChild(c);const l=G(r),i=L.filter(m=>G(m.category)===l).sort((m,E)=>m.name.localeCompare(E.name)),u=document.createElement("div");u.className="space-y-1 max-h-80 overflow-y-auto",e.mealSelectList.appendChild(u);function h(m=""){u.innerHTML="";const E=m.toLowerCase(),T=i.filter(b=>b.name.toLowerCase().includes(E));T.length===0?u.innerHTML='<p class="text-gray-500 p-4">Aucun plat ne correspond √† votre recherche.</p>':T.forEach(b=>{const S=document.createElement("button");S.className="w-full text-left p-2 hover:bg-gray-100 rounded-lg transition-colors duration-150";const D=document.createElement("p");D.className="font-medium text-gray-800 text-sm",D.textContent=b.name,S.appendChild(D),S.addEventListener("click",()=>{Qe(a,b),W()}),u.appendChild(S)})}c.addEventListener("input",m=>h(m.target.value)),h(),e.mealSelectModal.classList.remove("hidden"),c.focus()}function W(){e.mealSelectModal&&e.mealSelectModal.classList.add("hidden")}function ne(a){x=a.target.closest(".meal-card");const r=x.closest(".meal-slot").dataset.slotId;a.dataTransfer.setData("text/plain",r),setTimeout(()=>{x&&(x.style.opacity="0.5")},0)}function se(){x&&(x.style.opacity="1",x=null)}function ve(a){a.preventDefault();const r=a.target.closest(".meal-slot");r&&C(r.dataset.slotId)!=="Remarque"&&r.classList.add("bg-gray-200")}function _(a){const r=a.target.closest(".meal-slot");r&&r.classList.remove("bg-gray-200")}async function M(a){a.preventDefault();const r=a.dataTransfer.getData("text/plain"),c=a.target.closest(".meal-slot");if(c){c.classList.remove("bg-gray-200");const l=c.dataset.slotId,i=C(l);if(i==="Remarque")return;if(r&&l&&r!==l){const u=d[r],h=C(r);if(G(h)!==G(i)){alert(`Action impossible : un(e) "${h}" ne peut pas aller dans la cat√©gorie "${i}".`);return}const m=d[l];d[l]=u,m?d[r]=m:delete d[r],te(e.mealPlanGrid,{menuData:d,servingsData:g,remarksData:p,defaultNumPeople:w,startDay:o},!1),await F({[`weeks.${s}.menuData`]:d},"a d√©plac√© un plat"),await J()}}}function C(a){switch(a.split("-")[2]){case"0":return"Entr√©e";case"1":return"Plat";case"2":return"Accompagnement";case"3":return"Dessert";case"4":return"Remarque";default:return""}}function B(a,r,c,l=!1){const i=document.createElement("div");i.className="meal-card p-1 flex flex-col items-center bg-white rounded shadow-sm text-center relative w-full mb-1",l||(i.classList.add("cursor-grab"),i.draggable=!0);const u=document.createElement("span");if(u.className="text-xs font-medium p-1 break-words w-full",u.textContent=a.name,i.appendChild(u),!l){const E=document.createElement("div");E.className="absolute top-0 left-0 flex";const T=document.createElement("button");T.className="edit-meal-btn text-gray-600 hover:text-gray-800 hidden px-1 py-0.5",T.innerHTML='<i class="fas fa-pencil-alt fa-xs"></i>',T.title="Modifier la recette",T.addEventListener("click",S=>{S.stopPropagation();const D=L.find(q=>q.id===a.id);je.openForm(D||a,"Modifier la recette")}),E.appendChild(T);const b=document.createElement("button");b.className="delete-meal-btn text-red-700 hover:text-red-900 hidden px-1 py-0.5",b.innerHTML='<i class="fas fa-times-circle fa-xs"></i>',b.title="Retirer du planning",b.addEventListener("click",S=>{S.stopPropagation(),Je(r,c)}),E.appendChild(b),i.appendChild(E),i.addEventListener("mouseenter",()=>{T.classList.remove("hidden"),b.classList.remove("hidden")}),i.addEventListener("mouseleave",()=>{T.classList.add("hidden"),b.classList.add("hidden")})}const h=document.createElement("div");h.className="absolute bottom-1 right-1";const m=document.createElement("button");return m.className="info-meal-btn bg-gray-500 text-white hover:bg-gray-600 rounded w-3 h-3 flex items-center justify-center shadow-sm",m.innerHTML='<i class="fas fa-plus fa-xs"></i>',m.title="Plus d'infos",m.dataset.slotId=r,m.dataset.mealIndex=c,h.appendChild(m),i.appendChild(h),i}function R(a,r){const c=a.classList.contains("info-open");if(document.querySelectorAll(".planner-ingredient-tooltip").forEach(l=>l.remove()),document.querySelectorAll(".info-meal-btn").forEach(l=>{l.classList.remove("info-open"),l.innerHTML='<i class="fas fa-plus fa-xs"></i>'}),!c){a.innerHTML='<i class="fas fa-times fa-xs"></i>',a.classList.add("info-open");const l=document.createElement("div");if(l.className="planner-ingredient-tooltip z-50 w-64 p-3 bg-white border border-gray-200 rounded-lg shadow-lg text-left text-sm",r.ingredients&&r.ingredients.length>0){if(r.servings&&r.servings>0){const b=document.createElement("p");b.className="mb-2 text-sm text-gray-600 flex items-center",b.innerHTML=`<i class="fas fa-users mr-2"></i> Pour ${r.servings} ${r.servings>1?"personnes":"personne"}`,l.appendChild(b)}const E=document.createElement("h4");E.className="font-bold mb-2 text-gray-800",E.textContent="Ingr√©dients :",l.appendChild(E);const T=document.createElement("ul");T.className="space-y-1 text-gray-600",r.ingredients.forEach(b=>{const S=document.createElement("li");S.textContent=`‚Ä¢ ${b.quantity||""} ${b.unit||""} ${b.name}`.trim(),T.appendChild(S)}),l.appendChild(T)}else l.textContent="Aucun ingr√©dient sp√©cifi√© pour cette recette.";document.body.appendChild(l);const i=a.closest(".meal-card").getBoundingClientRect(),u=l.getBoundingClientRect();let h=i.right+10;h+u.width>window.innerWidth&&(h=i.left-u.width-10);let m=i.top;m+u.height>window.innerHeight&&(m=i.bottom-u.height),m<10&&(m=10),l.style.position="fixed",l.style.left=`${h}px`,l.style.top=`${m}px`}}function X(a,r=!1){const c=document.createElement("div"),l=document.createElement("button");return r?(c.className="w-full flex justify-center pt-1",l.className="add-more-meal-btn text-gray-400 hover:text-green-500 transition-colors duration-150",l.innerHTML='<i class="fas fa-plus-circle"></i>',l.title="Ajouter une autre recette"):(c.className="flex items-center justify-center h-full",l.className="add-meal-btn text-green-500 hover:text-green-700 transition-transform duration-150 hover:scale-125",l.innerHTML='<i class="fas fa-plus-circle text-lg"></i>'),l.addEventListener("click",()=>re(a)),c.appendChild(l),c}function Fe(a,r,c=!1){if(c){const i=document.createElement("p");return i.className="w-full h-full p-1 text-xs text-gray-700",i.textContent=r[a]||"",i}const l=document.createElement("textarea");return l.className="w-full h-full p-1 text-xs bg-transparent border-0 rounded focus:outline-none focus:ring-1 focus:ring-tomato resize-none",l.placeholder="Remarque...",l.value=p[a]||"",l.dataset.slotId=a,l.addEventListener("change",i=>{const u=i.target.value;u?p[a]=u:delete p[a];const[h,m]=a.split("-"),b=`a modifi√© la remarque pour ${j[parseInt(h,10)]} ${m==="lunch"?"midi":"soir"}`;F({[`weeks.${s}.remarksData`]:p},b)}),l.addEventListener("focus",i=>{dt({type:"editing_remark",fieldId:a})}),l.addEventListener("blur",i=>{dt("idle")}),l}function Ze(){document.querySelectorAll(".meal-card").forEach(a=>{a.addEventListener("dragstart",ne),a.addEventListener("dragend",se)}),document.querySelectorAll(".meal-slot").forEach(a=>{a.addEventListener("dragover",ve),a.addEventListener("dragleave",_),a.addEventListener("drop",M)})}async function Qe(a,r){const c=JSON.parse(JSON.stringify(d)),l=c[a];Array.isArray(l)?l.push({...r}):c[a]=[r];const[i,u]=a.split("-"),h=j[parseInt(i,10)],m=u==="lunch"?"midi":"soir",E=`a ajout√© '${r.name}' √† ${h} ${m}`;await F({[`weeks.${s}.menuData`]:c},E),W()}async function Je(a,r){if(!f||!d[a]||!Array.isArray(d[a]))return;const c=d[a][r],l=JSON.parse(JSON.stringify(d));l[a].splice(r,1),l[a].length===0&&delete l[a];const[i,u]=a.split("-"),h=j[parseInt(i,10)],m=u==="lunch"?"midi":"soir",E=`a supprim√© '${c.name}' de ${h} ${m}`;await F({[`weeks.${s}.menuData`]:l},E)}async function Oe(){if(confirm("Voulez-vous vraiment vider le menu de cette semaine ?")){const a={id:availablePlans.length>0?availablePlans[0].id:`${ge()}_semaine-${s}`,name:availablePlans.length>0?availablePlans[0].name:"Mon plan",menuData:{},servingsData:{},remarksData:{},defaultNumPeople:w,startDay:o,lastUpdated:new Date};loadPlan(a),availablePlans.length>0?availablePlans[0]=a:availablePlans.push(a),await F({[`weeks.${s}`]:{menuData:{},servingsData:{},remarksData:{}}},`a vid√© le menu de la semaine ${s}`)}}function Tt(a){a>=1&&a<=52&&(s=a,V())}function mn(){e.currentWeekDisplay&&(e.currentWeekDisplay.textContent=`Semaine ${s}`)}function pn(){e.prevWeekBtn?.addEventListener("click",()=>Tt(s-1)),e.nextWeekBtn?.addEventListener("click",()=>Tt(s+1)),e.clearMenuBtn?.addEventListener("click",Oe),e.startDaySelect?.addEventListener("change",async a=>{o=a.target.value,f&&await F({startDay:o},`a chang√© le premier jour de la semaine √† '${o}'`)}),e.planSelect?.addEventListener("change",Dt),e.closeMealSelectModalBtn?.addEventListener("click",W),e.mealSelectModal?.addEventListener("click",a=>{a.target===e.mealSelectModal&&W()}),e.closeRecipeModalBtn?.addEventListener("click",()=>je.closeForm()),e.cancelRecipeBtn?.addEventListener("click",()=>je.closeForm()),e.importListBtn?.addEventListener("click",Ee),e.closeImportListModalBtn?.addEventListener("click",ye),e.importListModal?.addEventListener("click",a=>{a.target===e.importListModal&&ye()}),e.exportTxtBtn?.addEventListener("click",Ue),e.exportPdfBtn?.addEventListener("click",H),e.exportPlanPdfBtn?.addEventListener("click",I),e.mealPlanGrid?.addEventListener("click",a=>{const r=a.target.closest(".info-meal-btn");if(r){const c=r.dataset.slotId,l=parseInt(r.dataset.mealIndex,10);if(c&&!isNaN(l)){const i=d[c]?.[l];i&&R(r,i)}}}),e.sharePlanBtn?.addEventListener("click",()=>{if(!f){alert("Veuillez s√©lectionner un plan √† partager.");return}kt({plan:f})}),e.inviteParticipantBtn?.addEventListener("click",()=>{if(!f){alert("Veuillez s√©lectionner un plan pour inviter des participants.");return}Yt(f)}),e.historyPlanBtn?.addEventListener("click",he),e.closePlanHistoryModalBtn?.addEventListener("click",k),e.planHistoryModal?.addEventListener("click",a=>{a.target===e.planHistoryModal&&k()})}function fn(a=""){return a.split(" ").map(l=>l[0]).join("").substring(0,2).toUpperCase()}function ft(a=[],r={}){const c=document.getElementById("collaborators-bar"),l=document.getElementById("activity-labels-container"),i=document.getElementById("name-tooltip");if(!c||!i||!l)return;if(c.innerHTML="",l.innerHTML="",document.querySelectorAll(".remark-lock-overlay").forEach(m=>m.remove()),document.querySelectorAll("textarea[data-slot-id]").forEach(m=>{m.disabled=!1}),a.length<=1&&Object.keys(r).length<=1){c.classList.add("hidden");return}let u="";const h=ge();a.forEach(m=>{if(!m)return;const E=r.hasOwnProperty(m.uid),T=r[m.uid]||{},b=document.createElement("div");b.className="w-8 h-8 rounded-full flex items-center justify-center bg-gray-300 text-white font-bold text-xs ring-2 ring-white cursor-pointer transition-all duration-300";const S=E?"(pr√©sent)":"(absent)";if(b.dataset.name=`${m.displayName||"Inconnu"} ${S}`,m.photoURL?b.innerHTML=`<img src="${m.photoURL}" alt="${m.displayName}" class="w-full h-full rounded-full object-cover">`:b.textContent=fn(m.displayName),E||b.classList.add("grayscale","opacity-50"),b.addEventListener("mouseenter",D=>{i.textContent=D.currentTarget.dataset.name,i.classList.remove("hidden");const q=D.currentTarget.getBoundingClientRect();i.style.left=`${q.left+q.width/2-i.offsetWidth/2}px`,i.style.top=`${q.top-i.offsetHeight-5}px`}),b.addEventListener("mouseleave",()=>{i.classList.add("hidden")}),c.appendChild(b),E&&m.uid!==h){const D=T.status;if(typeof D=="object"&&D.type==="editing_remark"){const q=document.querySelector(`textarea[data-slot-id="${D.fieldId}"]`);if(q){q.disabled=!0;const ce=document.createElement("div");ce.className="remark-lock-overlay absolute inset-0 bg-gray-400 bg-opacity-25 flex items-center justify-center text-xs text-white font-bold",ce.innerHTML=`<i class="fas fa-lock mr-1"></i> ${m.displayName} √©crit...`,q.parentElement&&(q.parentElement.classList.add("relative"),q.parentElement.appendChild(ce))}}else if(typeof D=="string"&&D!=="idle"){let q="";switch(D){case"editing_recipe":q="modifie une recette...";break}q&&(u+=`<span class="italic mr-4">${m.displayName} ${q}</span>`)}}}),l.innerHTML=u,c.classList.remove("hidden")}function Dt(){cn();const a=e.planSelect.value;f=O.find(h=>h.id===a)||null;const r=document.getElementById("delete-plan-btn"),c=document.getElementById("rename-plan-btn"),l=document.getElementById("leave-plan-btn"),i=document.getElementById("invite-participant-btn"),u=document.getElementById("history-plan-btn");if(r&&(r.style.display=f&&f.isOwner?"inline-flex":"none"),c&&(c.style.display=f&&f.isOwner?"inline-flex":"none"),u&&(u.style.display=f&&f.isOwner?"inline-flex":"none"),l&&(l.style.display=f&&!f.isOwner?"inline-flex":"none"),i){const h=f&&(f.type==="collaborative"||f.collaborators&&f.collaborators.length>0);i.style.display=f&&f.isOwner&&h?"inline-flex":"none"}f&&f.participants&&f.participants.length>1?(ft(f.participants,{}),dn(f.id,h=>{ft(f.participants,h)})):ft([],{}),f&&(f.manualItems=f.manualItems||[]),V()}async function gn(a,r){if(!f)return;const c=JSON.parse(JSON.stringify(g));r===w?delete c[a]:c[a]=r;const[l,i]=a.split("-"),m=`a chang√© le nombre de personnes pour ${j[parseInt(l,10)]} ${i==="lunch"?"midi":"soir"} √† ${r}`;await F({[`weeks.${s}.servingsData`]:c},m)}async function hn(){if(!y)return;en(),pn(),Ae(),await ke();const a=Ve(U(y,"recipes"),c=>{if(console.log("Recipe data updated from listener."),L=c.docs.map(l=>({id:l.id,...l.data()})),f){for(const l in d){const i=d[l];if(Array.isArray(i)){const u=i.map(h=>{if(h&&h.id){const m=L.find(E=>E.id===h.id);return m?{...m}:h}return h});d[l]=u}}te(e.mealPlanGrid,{menuData:d,servingsData:g,remarksData:p,defaultNumPeople:w,startDay:o},!1),J()}}),r=Kt(c=>{O=c,Zt(c),Dt()});return()=>{r(),a()}}const yn=hn();return async()=>{const a=await yn;typeof a=="function"&&a()}}const ua=Object.freeze(Object.defineProperty({__proto__:null,default:ca},Symbol.toStringTag,{value:"Module"}));function ma(){const e=un();return Nt(),()=>{typeof e=="function"&&e()}}async function Nt(){const e=document.getElementById("received-shares-container"),t=ge();if(!(!t||!e)){e.innerHTML='<p class="text-gray-500">Chargement des partages re√ßus...</p>';try{const n=me(U(y,"plans"),ee("userId","==",t),ee("isShared","==",!0)),s=me(U(y,"plans"),ee("collaborators","array-contains",t)),[o,d]=await Promise.all([le(n),le(s)]);let g=[];if(o.forEach(p=>g.push({id:p.id,type:"Planification (Copie)",...p.data()})),d.forEach(p=>g.push({id:p.id,type:"Planification (Collaboratif)",...p.data()})),g.length===0){e.innerHTML=`<p class="text-gray-500">Vous n'avez aucun contenu partag√© par d'autres utilisateurs.</p>`;return}g.sort((p,v)=>(v.sharedAt?.seconds||v.lastUpdated?.seconds||0)-(p.sharedAt?.seconds||p.lastUpdated?.seconds||0)),e.innerHTML="";for(const p of g){const v=p.originalOwnerId||p.userId;if(!v)continue;const x=await be($(y,"users",v)),L=x.exists()?x.data().displayName:"Utilisateur inconnu";e.appendChild(pa(p,L))}}catch(n){console.error("Erreur lors du chargement des partages re√ßus : ",n),e.innerHTML='<p class="text-red-500">Une erreur est survenue.</p>'}}}function pa(e,t){const n=document.createElement("div");n.className="bg-white rounded-lg p-4 flex justify-between items-center shadow-sm";const s=document.createElement("div"),o=document.createElement("p");o.className="font-bold text-gray-800";let d="";e.type.includes("Collaboratif")?d=' <span class="text-xs font-medium bg-blue-100 text-blue-800 px-2 py-1 rounded-full">Collab</span>':e.type.includes("Copie")&&(d=' <span class="text-xs font-medium bg-gray-200 text-gray-800 px-2 py-1 rounded-full">Copie</span>'),o.innerHTML=`${e.name}${d}`;const g=document.createElement("p");g.className="text-sm text-gray-500 mt-1";const p=e.sharedAt?new Date(e.sharedAt.seconds*1e3).toLocaleDateString("fr-FR"):e.lastUpdated?new Date(e.lastUpdated.seconds*1e3).toLocaleDateString("fr-FR"):"date inconnue";g.textContent=`Partag√© par ${t} le ${p}`,s.appendChild(o),s.appendChild(g),n.appendChild(s);const v=document.createElement("button");return v.className="btn btn-ghost text-red-500 btn-sm",v.innerHTML='<i class="fas fa-trash"></i>',v.title="Supprimer ce contenu partag√©",v.addEventListener("click",()=>fa(e.id,e.type)),n.appendChild(v),n}async function fa(e,t){if(confirm(`Voulez-vous vraiment supprimer cette ${t.toLowerCase()} partag√©e ?`))try{const n=t.startsWith("Planification")?"plans":"shopping_lists",s=$(y,n,e),o=await be(s);o.exists()&&o.data().userId===ge()?(await _e(s),Nt()):(alert("Vous n'avez pas la permission de supprimer cet √©l√©ment ou il a d√©j√† √©t√© supprim√©."),Nt())}catch(n){console.error("Erreur de suppression: ",n),alert("Une erreur est survenue.")}}async function un(){const e=document.getElementById("sent-shares-container"),t=ge();if(!t||!e)return()=>{};e.innerHTML='<p class="text-gray-500">Chargement des partages envoy√©s...</p>';const n=U(y,"shares"),s=me(n,ee("senderId","==",t));return Ve(s,async o=>{if(o.empty){e.innerHTML=`<p class="text-gray-500">Vous n'avez envoy√© aucun partage.</p>`;return}const d=o.docs.sort((g,p)=>(p.data().createdAt?.seconds||0)-(g.data().createdAt?.seconds||0));e.innerHTML="";for(const g of d){const p=g.data();try{const v=await be($(y,"users",p.receiverId));if(v.exists()){const x=v.data();e.appendChild(ga(p,x.displayName,g.id))}}catch(v){console.error("Could not load receiver for sent share",v)}}},o=>{console.error("Erreur lors du chargement des partages envoy√©s : ",o),e&&(e.innerHTML='<p class="text-red-500">Une erreur est survenue.</p>')})}function ga(e,t,n){const s=document.createElement("div");s.className="bg-white rounded-lg p-4 flex justify-between items-center shadow-sm";const o=document.createElement("div"),d=document.createElement("p");d.className="font-bold text-gray-800";let g=[];e.plan&&g.push("Planification"),e.shoppingList&&g.push("Liste de courses"),d.textContent=g.join(" et ");const p=document.createElement("p");p.className="text-sm text-gray-500";const v=new Date(e.createdAt.seconds*1e3).toLocaleDateString("fr-FR");p.textContent=`Envoy√© √† ${t} le ${v}`,o.appendChild(d),o.appendChild(p),s.appendChild(o);const x=document.createElement("div");x.className="flex items-center space-x-4";const L=document.createElement("span");L.textContent=e.status;let N="bg-gray-200 text-gray-800";switch(e.status){case"accepted":N="bg-green-100 text-green-800";break;case"declined":N="bg-red-100 text-red-800";break;case"pending":N="bg-yellow-100 text-yellow-800";break}L.className=`text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full ${N}`,x.appendChild(L);const w=document.createElement("button");return w.className="btn btn-ghost text-red-500 btn-sm",w.innerHTML='<i class="fas fa-trash"></i>',w.title="Annuler le partage",w.addEventListener("click",()=>ha(n)),x.appendChild(w),s.appendChild(x),s}async function ha(e){if(confirm("Voulez-vous vraiment annuler ce partage ? L'autre utilisateur ne le verra plus."))try{await _e($(y,"shares",e)),un()}catch(t){console.error("Erreur lors de la suppression du partage: ",t),alert("Une erreur est survenue.")}}const ya=Object.freeze(Object.defineProperty({__proto__:null,default:ma},Symbol.toStringTag,{value:"Module"})),Ut=document.querySelector("main"),ba={menu:{html:`
        <div class="flex flex-col md:flex-row md:space-x-2">

            <!-- Left Column: Meal Planner -->
            <div class="w-full md:w-5/6">
                <section id="meal-planning-section" aria-labelledby="meal-planning-heading" class="mb-8 md:mb-12">
                                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                                        <h2 id="meal-planning-heading" class="text-xl md:text-2xl font-bold text-gray-800">Planification des repas</h2>
                                        <div class="mt-3 md:mt-0 flex items-center space-x-2 md:space-x-3">
                                            <button id="generate-plan-ai-btn" class="btn btn-primary btn-sm">
                                                <i class="fas fa-robot mr-1 md:mr-2"></i> IA Semaine
                                            </button>
                                            <button id="clear-menu-btn" class="btn btn-outline btn-sm text-red-800 hover:bg-red-100">
                                                <i class="fas fa-trash-alt mr-1 md:mr-2"></i> Vider le menu
                                            </button>
                                            <button id="export-plan-pdf-btn" class="btn btn-outline btn-sm">
                                                <i class="fas fa-file-pdf mr-1 md:mr-2"></i> Exporter Plan (PDF)
                                            </button>
                                            <button id="share-plan-btn" class="btn btn-secondary btn-sm">
                                                <i class="fas fa-share-alt mr-1 md:mr-2"></i> Partager
                                            </button>
                                        </div>
                                    </div>
                            
                                    <!-- Week Navigation & Plan Selector -->
                                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 space-y-3 md:space-y-0">
                                        <!-- Week Navigation -->
                                        <div class="flex justify-between items-center bg-white p-2 md:p-3 rounded-lg shadow-sm">
                                            <button id="prev-week-btn" class="btn btn-ghost btn-sm" aria-label="Semaine pr√©c√©dente">
                                                <i class="fas fa-chevron-left mr-1 md:mr-2"></i> Pr√©c.
                                            </button>
                                            <div id="current-week-display" class="text-gray-700 font-medium text-sm md:text-base text-center mx-4">Semaine X</div>
                                            <button id="next-week-btn" class="btn btn-ghost btn-sm" aria-label="Semaine suivante">
                                                Suiv. <i class="fas fa-chevron-right ml-1 md:ml-2"></i>
                                            </button>
                                        </div>
                                        <!-- Plan Selector -->
                                        <div class="flex items-center space-x-2 bg-white p-3 rounded-lg shadow-sm">
                                            <label for="plan-select" class="text-sm font-medium text-gray-700">Plan affich√©:</label>
                                            <select id="plan-select" class="rounded-md border-gray-300 shadow-sm focus:border-tomato focus:ring focus:ring-tomato focus:ring-opacity-50 text-sm py-1">
                                                <!-- Options will be generated by JS -->
                                            </select>
                                            <button id="create-plan-btn" class="btn btn-primary btn-sm" title="Cr√©er un nouveau plan">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                            <button id="rename-plan-btn" class="btn btn-ghost text-blue-500 hover:bg-blue-100 btn-sm" title="Renommer le plan s√©lectionn√©">
                                                <i class="fas fa-pencil-alt"></i>
                                            </button>
                                            <button id="leave-plan-btn" class="btn btn-ghost text-yellow-600 hover:bg-yellow-100 btn-sm" title="Quitter le plan collaboratif">
                                                <i class="fas fa-door-open"></i>
                                            </button>
                                            <button id="delete-plan-btn" class="btn btn-ghost text-red-500 hover:bg-red-100 btn-sm" title="Supprimer le plan s√©lectionn√©">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            <button id="invite-participant-btn" class="btn btn-ghost text-green-500 hover:bg-green-100 btn-sm hidden" title="Inviter un participant">
                                                <i class="fas fa-user-plus"></i>
                                            </button>
                                            <button id="history-plan-btn" class="btn btn-ghost text-purple-500 hover:bg-purple-100 btn-sm hidden" title="Historique du plan">
                                                <i class="fas fa-history"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Collaborators Bar -->
                                    <div id="collaborators-bar" class="flex items-center space-x-2 mb-4 hidden">
                                        <!-- Avatars will be injected here -->
                                    </div>

                                    <!-- Activity Labels -->
                                    <div id="activity-labels-container" class="text-sm text-gray-600 mb-4 h-6">
                                        <!-- e.g., 'Sophie is adding a recipe...' -->
                                    </div>
                            
                                            <!-- Settings Section -->
                                            <div class="inline-flex items-center space-x-6 bg-white p-3 rounded-lg shadow-sm mb-4">                                        <div>
                                            <label for="start-day-select" class="text-sm font-medium text-gray-700">D√©but de semaine:</label>
                                            <select id="start-day-select" class="rounded-md border-gray-300 shadow-sm focus:border-tomato focus:ring-tomato text-sm py-1">
                                                <option>Lundi</option>
                                                <option>Mardi</option>
                                                <option>Mercredi</option>
                                                <option>Jeudi</option>
                                                <option>Vendredi</option>
                                                <option>Samedi</option>
                                                <option>Dimanche</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="default-servings-input" class="text-sm font-medium text-gray-700">Personnes par d√©faut:</label>
                                            <div id="default-servings-control" class="mt-1"></div>
                                        </div>
                                    </div>                    <!-- Meal Plan Grid -->
                    <div class="bg-white rounded-xl shadow-md p-4 overflow-x-auto">
                        <div id="meal-plan-grid-layout" class="min-w-[1400px]">
                            <!-- Header -->
                            <div class="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] gap-1 text-center mb-1">
                                <div class="p-2"></div> <!-- Empty corner -->
                                <div class="p-2 rounded-t-lg bg-amber-100 text-amber-800 font-bold col-span-6">MIDI</div>
                                <div class="p-2 rounded-t-lg bg-stone-200 text-stone-800 font-bold col-span-6">SOIR</div>
                                
                                <div class="p-1"></div> <!-- Empty under day name -->
                                <div class="p-1 text-xs font-semibold"><i class="fas fa-users"></i></div>
                                <div class="p-1 text-xs font-semibold text-gray-600">Entr√©e</div>
                                <div class="p-1 text-xs font-semibold text-gray-600">Plat</div>
                                <div class="p-1 text-xs font-semibold text-gray-600">Accomp.</div>
                                <div class="p-1 text-xs font-semibold text-gray-600">Dessert</div>
                                <div class="p-1 text-xs font-semibold text-gray-600">Remarque</div>

                                <div class="p-1 text-xs font-semibold"><i class="fas fa-users"></i></div>
                                <div class="p-1 text-xs font-semibold text-gray-600">Entr√©e</div>
                                <div class="p-1 text-xs font-semibold text-gray-600">Plat</div>
                                <div class="p-1 text-xs font-semibold text-gray-600">Accomp.</div>
                                <div class="p-1 text-xs font-semibold text-gray-600">Dessert</div>
                                <div class="p-1 text-xs font-semibold text-gray-600">Remarque</div>
                            </div>
                            <!-- Rows generated by JS -->
                            <div id="meal-plan-grid" class="space-y-1">
                                <div class="p-10 text-center text-gray-500 italic col-span-full">Chargement du planning...</div>
                            </div>                                            </div>
                                        </div>
                                    </section>


                                </div>
                    
                                <!-- Right Column: Shopping List -->
                                <div class="w-full md:w-1/6">
                                    <section id="shopping-list-section" aria-labelledby="shopping-list-heading" class="mb-8 md:mb-12 md:sticky md:top-24">
                                        <div class="bg-white rounded-xl shadow-md p-4 md:p-6">
                                            <h2 id="shopping-list-heading" class="text-xl md:text-2xl font-bold text-gray-800 mb-4">Liste de courses</h2>
                                            <div class="flex justify-end space-x-2 mb-4">
                                                <button id="import-list-btn" class="btn btn-secondary btn-sm">
                                                    <i class="fas fa-download mr-2"></i>Importer une liste
                                                </button>
                                                <div id="export-buttons-container" class="flex space-x-2">
                                                    <button id="export-txt-btn" class="btn btn-outline btn-sm">
                                                        <i class="fas fa-file-alt mr-2"></i>TXT
                                                    </button>
                                                    <button id="export-pdf-btn" class="btn btn-outline btn-sm">
                                                        <i class="fas fa-file-pdf mr-2"></i>PDF
                                                    </button>
                                                </div>
                                            </div>
                    
                                            <!-- Shopping List Container -->
                                            <div id="shopping-list-container" class="mb-4 max-h-[70vh] overflow-y-auto pr-2">                            <ul id="shopping-list" class="space-y-2 text-sm">
                                <!-- Les articles de la liste de courses seront g√©n√©r√©s ici -->
                            </ul>
                        </div>

                        <!-- Add Item Input -->
                        <div class="mt-4 flex items-stretch">
                            <div class="relative flex-grow">
                                <input type="text" id="add-item-input" placeholder="Chercher ou ajouter..." class="w-full border border-gray-300 rounded-l-lg px-2 py-1 text-xs focus:outline-none focus:ring-2 focus:ring-tomato focus:border-transparent">
                                <div id="add-item-results" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto bottom-full mb-2"></div>
                            </div>
                            <button id="add-item-btn" class="btn btn-primary rounded-l-none -ml-px btn-xs" aria-label="Ajouter l'article">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>

                         <!-- AI Shopping Tips Placeholder -->
                        <div id="ai-shopping-tip" class="mt-6 bg-avocado bg-opacity-10 rounded-lg p-3 hidden">
                            <div class="flex items-start">
                                 <div class="w-8 h-8 bg-avocado bg-opacity-20 rounded-full flex items-center justify-center mr-3 shrink-0">
                                    <i class="fas fa-lightbulb text-avocado"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-avocado mb-1 text-sm">Astuce √âconomique</h4>
                                    <p id="ai-shopping-tip-text" class="text-sm text-gray-700">...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <!-- Shared Plans Modal -->
        <div id="shared-plans-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-6xl max-h-[90vh] overflow-y-auto relative">
                <button id="close-shared-plans-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" aria-label="Fermer">
                    <i class="fas fa-times text-xl"></i>
                </button>
                <h3 id="shared-plans-modal-title" class="text-2xl font-bold mb-6">Plans partag√©s pour la Semaine X</h3>
                <div id="shared-plans-modal-container" class="space-y-6">
                    <!-- Shared plans will be loaded here -->
                </div>
            </div>
        </div>
        `,script:"./script.js"},recipes:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Recettes</h2>
            <button id="add-recipe-btn" class="btn btn-primary">
                <i class="fas fa-plus mr-2"></i> Ajouter une recette
            </button>
        </div>

        <!-- Search Bar -->
        <div class="mb-6">
            <input type="text" id="search-bar" placeholder="Rechercher une recette..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-tomato focus:border-tomato">
        </div>

        <!-- Tabs Navigation -->
        <div id="category-tabs" class="mb-6 border-b border-gray-200 flex space-x-4 flex-nowrap overflow-x-auto pb-2">
            <!-- Tabs will be generated by recipes.js here -->
        </div>

        <!-- Recipe List Container -->
        <div id="recipe-list-container">
            <!-- Recipes for the selected tab will be loaded here -->
        </div>

        <!-- Reconstructed Recipe Form Modal -->
        <div id="recipe-form-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-3xl max-h-[90vh] overflow-y-auto relative">
                <button id="close-recipe-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" aria-label="Fermer">
                    <i class="fas fa-times text-xl"></i>
                </button>
                <h3 id="recipe-modal-title" class="text-2xl font-bold mb-6">Ajouter/Modifier une recette</h3>
                <form id="recipe-form" class="space-y-4">
                    <input type="hidden" id="recipe-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label for="recipe-name" class="block text-sm font-medium text-gray-700">Nom de la recette</label>
                            <input type="text" id="recipe-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                        </div>
                        <div>
                            <label for="recipe-category" class="block text-sm font-medium text-gray-700">Cat√©gorie</label>
                            <select id="recipe-category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                                <option>ENTREE</option>
                                <option>PLAT</option>
                                <option>ACCOMPAGNEMENT</option>
                                <option>DESSERT</option>
                            </select>
                        </div>
                        <div>
                            <label for="recipe-servings" class="block text-sm font-medium text-gray-700">Nombre de personnes</label>
                            <input type="number" id="recipe-servings" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" min="1">
                        </div>
                        <div>
                            <label for="recipe-prep-time" class="block text-sm font-medium text-gray-700">Temps de pr√©paration (min)</label>
                            <input type="number" id="recipe-prep-time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" min="0">
                        </div>
                         <div>
                            <label for="recipe-difficulty" class="block text-sm font-medium text-gray-700">Difficult√©</label>
                            <select id="recipe-difficulty" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                <option>Tr√®s facile</option>
                                <option>Facile</option>
                                <option>Moyen</option>
                                <option>Difficile</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-lg font-medium text-gray-800 mb-2">Ingr√©dients</h4>
                        <div id="ingredients-list" class="space-y-2"></div>
                        <button type="button" id="add-ingredient-btn" class="btn btn-outline btn-sm mt-2">
                            <i class="fas fa-plus mr-2"></i> Ajouter un ingr√©dient
                        </button>
                    </div>
                    <div>
                        <label for="recipe-steps" class="block text-lg font-medium text-gray-800">Pr√©paration</label>
                        <textarea id="recipe-steps" rows="8" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                    </div>
                    <div class="flex justify-end space-x-4 pt-4">
                        <button type="button" id="cancel-recipe-btn" class="btn btn-ghost">Annuler</button>
                        <button type="submit" id="save-recipe-btn" class="btn btn-primary">Sauvegarder</button>
                    </div>
                </form>
            </div>
        </div>
        `,script:"./recipes.js"},ingredients:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Ingr√©dients</h2>
            <div class="flex space-x-2">
                <button id="manage-categories-btn" class="btn btn-outline">
                    <i class="fas fa-tags mr-2"></i> G√©rer les cat√©gories
                </button>
                <button id="add-ingredient-btn" class="btn btn-primary">
                    <i class="fas fa-plus mr-2"></i> Ajouter un ingr√©dient
                </button>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="mb-6">
            <input type="text" id="search-bar" placeholder="Rechercher un ingr√©dient..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-tomato focus:border-tomato">
        </div>

        <!-- Tabs Navigation -->
        <div id="category-tabs" class="mb-6 border-b border-gray-200 flex space-x-4 flex-nowrap overflow-x-auto pb-2">
            <!-- Tabs will be generated by ingredients.js here -->
        </div>

        <!-- Ingredient List Container -->
        <div id="ingredients-list-container">
            <p class="text-center text-gray-500 p-10">Chargement des ingr√©dients...</p>
        </div>

        <!-- Ingredient Form Modal -->
        <div id="ingredient-form-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-md relative">
                <button id="close-ingredient-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
                <h3 id="ingredient-modal-title" class="text-lg font-bold mb-4">Ajouter un Ingr√©dient</h3>
                <form id="ingredient-form" class="space-y-4">
                    <input type="hidden" id="ingredient-id">
                    <div>
                        <label for="ingredient-name" class="block text-sm font-medium text-gray-700">Nom</label>
                        <input type="text" id="ingredient-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                    </div>
                    <div>
                        <label for="ingredient-unit" class="block text-sm font-medium text-gray-700">Unit√© par d√©faut</label>
                        <select id="ingredient-unit" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select>
                    </div>
                    <div>
                        <label for="ingredient-category" class="block text-sm font-medium text-gray-700">Cat√©gorie</label>
                        <select id="ingredient-category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></select>
                    </div>
                    <div class="flex justify-end space-x-4 pt-2">
                        <button type="button" id="cancel-ingredient-btn" class="btn btn-ghost">Annuler</button>
                        <button type="submit" id="save-ingredient-btn" class="btn btn-primary">Sauvegarder</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Category Management Modal -->
        <div id="category-management-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-lg relative">
                <h3 class="text-lg font-bold mb-4">G√©rer les cat√©gories d'ingr√©dients</h3>
                <form id="add-category-form" class="flex items-center space-x-2 mb-4">
                    <input type="text" id="new-category-name" placeholder="Nom de la nouvelle cat√©gorie" class="flex-grow mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                    <button type="submit" class="btn btn-secondary">Ajouter</button>
                </form>
                <div id="category-list" class="max-h-64 overflow-y-auto border rounded-lg p-2"></div>
                <div class="flex justify-end space-x-4 mt-4">
                     <button type="button" id="close-category-modal" class="btn btn-ghost">Annuler</button>
                    <button type="button" id="done-category-modal-btn" class="btn btn-primary">Termin√©</button>
                </div>
            </div>
        </div>
        `,script:"./ingredients.js"},lists:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Listes de Courses</h2>
            <button id="add-list-btn" class="btn btn-primary">
                <i class="fas fa-plus mr-2"></i> Cr√©er une liste
            </button>
        </div>

        <!-- Search Bar -->
        <div class="mb-6">
            <input type="text" id="search-bar" placeholder="Rechercher une liste..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-tomato focus:border-tomato">
        </div>

        <!-- Lists Container -->
        <div id="lists-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

        <div class="mt-12">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6">Listes Partag√©es</h2>
            <div id="shared-lists-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Les listes partag√©es seront charg√©es ici par JS -->
            </div>
        </div>

        <!-- List Form Modal -->
        <div id="list-form-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-start justify-center z-[100] hidden pt-20">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-3xl min-h-[75vh] max-h-[90vh] overflow-y-auto relative">
                <button id="close-list-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10"><i class="fas fa-times text-xl"></i></button>
                <h3 id="list-modal-title" class="text-lg font-bold mb-4">Cr√©er une liste</h3>
                <form id="list-form" class="space-y-4 pb-20">
                    <input type="hidden" id="list-id">
                    <div>
                        <label for="list-name" class="block text-sm font-medium text-gray-700">Nom de la liste</label>
                        <input type="text" id="list-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                    </div>
                    <div>
                        <h4 class="text-md font-medium text-gray-800 mb-2">Ingr√©dients</h4>
                        <div id="ingredients-list" class="space-y-2"></div>
                        <button type="button" id="add-ingredient-btn" class="btn btn-outline btn-sm mt-2">
                            <i class="fas fa-plus mr-2"></i> Ajouter un ingr√©dient
                        </button>
                    </div>
                </form>
                <div class="absolute bottom-0 left-0 right-0 px-6 py-4 bg-white/95 backdrop-blur-sm border-t border-gray-200 flex justify-end space-x-4">
                    <button type="button" id="cancel-list-btn" class="btn btn-ghost">Annuler</button>
                    <button type="submit" form="list-form" id="save-list-btn" class="btn btn-primary">Sauvegarder la liste</button>
                </div>
            </div>
        </div>
        `,script:"./lists.js"},friends:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Amis</h2>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="md:col-span-2 space-y-8">
                <div>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Liste d'amis</h3>
                    <div id="friends-list-container" class="space-y-4">
                        <!-- La liste d'amis sera charg√©e ici -->
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Demandes envoy√©es en attente</h3>
                    <div id="pending-requests-container" class="space-y-4">
                        <!-- Les demandes envoy√©es en attente seront charg√©es ici -->
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Demandes rejet√©es</h3>
                    <div id="declined-requests-container" class="space-y-4">
                        <!-- Les demandes rejet√©es seront charg√©es ici -->
                    </div>
                </div>
            </div>
            <div>
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Rechercher un ami</h3>
                    <div class="mb-4">
                        <div class="flex items-center space-x-2">
                            <input type="text" id="search-friends-input" placeholder="Nom ou email..." class="flex-grow p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-tomato focus:border-tomato">
                            <button id="search-friends-btn" class="btn btn-primary"><i class="fas fa-search"></i></button>
                        </div>
                        <div id="search-results-container" class="mt-2 space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>
        `,script:"./friends.js"},shared:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Partages</h2>
        </div>

        <div class="space-y-12">
            <div>
                <h3 class="text-xl font-bold text-gray-700 border-b pb-2 mb-4">Partages Re√ßus</h3>
                <div id="received-shares-container" class="space-y-4">
                    <!-- L'historique des partages accept√©s sera charg√© ici -->
                </div>
            </div>
            <div>
                <h3 class="text-xl font-bold text-gray-700 border-b pb-2 mb-4">Mes Partages Envoy√©s</h3>
                <div id="sent-shares-container" class="space-y-4">
                    <!-- L'historique des partages envoy√©s sera charg√© ici -->
                </div>
            </div>
        </div>
        `,script:"./shared.js"}},va=Object.assign({"./auth.js":Tn,"./firebase-config.js":Mn,"./form-handler.js":Dn,"./friends.js":jn,"./ingredients.js":An,"./lists.js":zn,"./main.js":kn,"./notifications.js":ia,"./plans.js":Kn,"./presence.js":oa,"./recipes.js":da,"./script.js":ua,"./shared.js":ya,"./sharing.js":Fn});let lt=null;async function Ft(e){typeof lt=="function"&&(lt(),lt=null);const t=ba[e];if(t&&Ut){if(Ut.innerHTML=t.html,t.script){const n=va[t.script];n?n.default&&typeof n.default=="function"&&(lt=n.default()):console.error(`Module not found for path: ${t.script}`)}}else console.error(`Route not found: ${e}`)}function xa(){const e=Se();if(e){const n=document.getElementById("user-display-name");n&&(n.textContent=e.displayName||e.email)}const t=document.querySelectorAll(".nav-btn");t.forEach(n=>{n.addEventListener("click",s=>{const o=s.currentTarget.dataset.path;Ft(o),t.forEach(d=>{d.classList.remove("bg-tomato","text-white"),d.classList.add("bg-white","text-tomato")}),s.currentTarget.classList.add("bg-tomato","text-white"),s.currentTarget.classList.remove("bg-white","text-tomato")})}),Ft("menu"),ln()}document.addEventListener("DOMContentLoaded",()=>{Qt().then(e=>{e&&xa()})});
