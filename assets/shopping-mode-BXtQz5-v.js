const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/main-Ca5URGHw.js","assets/firebase-config-d8WEO_B0.js","assets/firebase-config-BniYt0Pb.css"])))=>i.map(i=>d[i]);
import{_ as F,a as se}from"./main-Ca5URGHw.js";import{b as A,o as oe,g as J,c as W,i as re}from"./firebase-config-d8WEO_B0.js";const U=re();let O=null,C=null,Z=[],X=[],H={};const ce={"fruits & légumes":"fa-carrot","produits laitiers":"fa-cheese",fromagerie:"fa-cheese",boucherie:"fa-drumstick-bite",viande:"fa-drumstick-bite",poissonnerie:"fa-fish",poisson:"fa-fish",épicerie:"fa-box",boissons:"fa-wine-glass",boulangerie:"fa-bread-slice",pain:"fa-bread-slice",dph:"fa-soap",hygiène:"fa-soap",surgelés:"fa-snowflake",entrée:"fa-utensils",plat:"fa-concierge-bell",accompagnement:"fa-plate-wheat",dessert:"fa-ice-cream",inconnue:"fa-question"};function Q(x){return x?x.replace(/\./g,"_"):""}function de(){let x=document.getElementById("shopping-mode-container");const G=document.getElementById("shopping-mode-plan-select"),j=document.getElementById("shopping-mode-trash-btn"),R=document.getElementById("shopping-trash-modal");let z=null;function Y(e){console.log(`[DEBUG] updateTrashUI called with ${e?e.length:"null"} items`);const o=document.getElementById("shopping-mode-trash-btn"),a=document.getElementById("shopping-mode-trash-count"),h=document.getElementById("shopping-trash-modal"),m=document.getElementById("shopping-trash-list"),y=document.getElementById("close-shopping-trash-modal"),g=document.getElementById("shopping-empty-trash-btn");if(o&&(e&&e.length>0?(o.classList.remove("hidden"),a&&(a.textContent=e.length)):(o.classList.add("hidden"),a&&(a.textContent="0"))),h&&y&&(y.onclick=()=>h.classList.add("hidden"),h.onclick=s=>{s.target===h&&h.classList.add("hidden")}),e&&e.length>0){if(g){g.classList.remove("hidden");const s=g.cloneNode(!0);g.parentNode.replaceChild(s,g),s.addEventListener("click",async()=>{if(!C||!confirm("Tout supprimer définitivement ?"))return;const p=A(U,"plans",C.id),f=e.map(v=>Q(`${v.name}_${v.unit||""}`));try{await F(()=>import("./main-Ca5URGHw.js").then(v=>v.e),__vite__mapDeps([0,1,2])).then(v=>{v.updateDoc(p,{hiddenTrashItems:v.arrayUnion(...f),lastUpdated:new Date})}),h.classList.add("hidden")}catch(v){console.error("Erreur vidage corbeille:",v)}})}if(m){m.innerHTML="";const s=document.createElement("ul");s.className="space-y-3",e.forEach(p=>{const f=document.createElement("li");f.className="flex items-center p-3 rounded-lg bg-gray-100 shadow-inner justify-between";const v=document.createElement("div");v.className="flex-grow ml-2 overflow-hidden";const M=document.createElement("span");M.className="font-medium text-base text-gray-500 line-through block truncate",M.textContent=p.name,v.appendChild(M);const t=document.createElement("div");t.className="flex items-center space-x-2 flex-shrink-0";const n=document.createElement("button");n.className="text-blue-600 hover:text-blue-800 font-medium text-sm px-3 py-1 border border-blue-300 rounded-full hover:bg-blue-50 transition-colors",n.innerHTML='<i class="fas fa-undo"></i>',n.addEventListener("click",async()=>{if(!C)return;const r=A(U,"plans",C.id);try{await F(()=>import("./main-Ca5URGHw.js").then(c=>c.e),__vite__mapDeps([0,1,2])).then(async c=>{await c.runTransaction(U,async i=>{const u=await i.get(r);if(!u.exists())return;const d=(u.data().manualItems||[]).filter(D=>!(D.name.toLowerCase()===p.name.toLowerCase()&&D.unit===p.unit));i.update(r,{manualItems:d,lastUpdated:new Date})}),e.length<=1&&h.classList.add("hidden")})}catch(c){console.error(c)}});const l=document.createElement("button");l.className="text-gray-400 hover:text-red-600 font-medium text-sm px-2 py-1",l.innerHTML='<i class="fas fa-times text-lg"></i>',l.addEventListener("click",async()=>{if(!C)return;const r=A(U,"plans",C.id),c=Q(`${p.name}_${p.unit||""}`);try{await F(()=>import("./main-Ca5URGHw.js").then(i=>i.e),__vite__mapDeps([0,1,2])).then(i=>{i.updateDoc(r,{hiddenTrashItems:i.arrayUnion(c),lastUpdated:new Date})}),e.length<=1&&h.classList.add("hidden")}catch(i){console.error(i)}}),t.appendChild(n),t.appendChild(l),f.appendChild(v),f.appendChild(t),s.appendChild(f)}),m.appendChild(s)}}else m&&(m.innerHTML='<p class="text-center text-gray-500 italic py-4">La corbeille est vide.</p>'),g&&g.classList.add("hidden")}function ee(){console.log("[DEBUG] Resetting UI and State"),C=null,x&&(x.innerHTML='<div class="flex justify-center p-10"><i class="fas fa-spinner fa-spin text-tomato text-2xl"></i></div>'),R&&R.classList.add("hidden"),Y([])}j&&R&&j.addEventListener("click",()=>{R.classList.remove("hidden")});function V(e){console.log(`[DEBUG] loadPlan called for: ${e}`),z=e,O&&(console.log("[DEBUG] Unsubscribing from previous plan"),O(),O=null),ee();const o=A(U,"plans",e);O=oe(o,a=>{if(console.log(`[DEBUG] Snapshot received for doc: ${a.id}`),z!==e){console.warn(`[DEBUG] Ignored snapshot for ${e} because active is ${z}`);return}a.exists()?(console.log(`[DEBUG] Plan data found for ID: ${a.id}`),C={id:a.id,...a.data()},H=C.checkedItems||{},te()):(console.log("[DEBUG] Plan not found"),x&&(x.innerHTML='<p class="text-center p-4 text-red-500">Menu introuvable.</p>'))})}function te(){if(!C||!x){console.log("[DEBUG] renderShoppingList aborted: missing plan or container");return}console.log(`[DEBUG] Rendering shopping list for menu: ${C.name} (${C.id})`);const{active:e,deleted:o}=ne(C);console.log(`[DEBUG] Computed deletedItems: ${o.length} items`),Y(o),x.innerHTML="";const a=[],h=[];if(e.forEach(t=>{const n=`${t.name}_${t.unit||""}`,l=Q(n);(H.hasOwnProperty(l)?H[l]:H[n]||!1)?h.push(t):a.push(t)}),a.length===0&&h.length===0){x.innerHTML='<p class="text-center p-10 text-gray-500">Votre liste de courses est vide pour ce menu.</p>';return}const m=a.reduce((t,n)=>{const l=n.category||"Inconnue";return t[l]||(t[l]=[]),t[l].push(n),t},{}),y=Object.keys(m).sort((t,n)=>t==="Inconnue"?1:n==="Inconnue"?-1:t.localeCompare(n)),g=document.createElement("div");g.className="sticky top-0 z-30 glass-header px-4 mb-4";const s=document.createElement("div");s.id="shopping-category-tabs",s.className="flex overflow-x-auto space-x-3 py-3 items-center",g.appendChild(s),x.appendChild(g);const p=t=>"category-"+t.replace(/[^a-zA-Z0-9]/g,"-").toLowerCase(),f={};y.forEach(t=>{const n=document.createElement("button");n.className="category-tab btn-outline flex-shrink-0";const l=ce[t.toLowerCase()]||"fa-tag";n.innerHTML=`<i class="fas ${l}"></i> <span>${t}</span>`,n.onclick=()=>{const r=document.getElementById(p(t));if(r){const c=document.querySelector("header"),i=c?c.offsetHeight:0,u=g.offsetHeight,d=r.getBoundingClientRect().top+window.pageYOffset-i-u-10;window.scrollTo({top:d,behavior:"smooth"})}},s.appendChild(n),f[t]=n});const v={root:null,rootMargin:"-10% 0px -80% 0px",threshold:0},M=new IntersectionObserver(t=>{t.forEach(n=>{if(n.isIntersecting){const l=n.target.dataset.categoryName;Object.values(f).forEach(c=>c.classList.remove("category-tab-active"));const r=f[l];r&&(r.classList.add("category-tab-active"),r.scrollIntoView({behavior:"smooth",block:"nearest",inline:"center"}))}})},v);if(y.forEach(t=>{const n=document.createElement("h3");n.className="font-bold text-lg text-gray-700 mt-6 mb-3 border-b border-gray-200 pb-1 scroll-mt-24",n.textContent=t,n.id=p(t),n.dataset.categoryName=t,x.appendChild(n),M.observe(n);const l=document.createElement("ul");l.className="space-y-3",m[t].sort((r,c)=>r.name.localeCompare(c.name)).forEach(r=>{const c=`${r.name}_${r.unit||""}`,i=Q(c),u=H.hasOwnProperty(i)?H[i]:H[c]||!1,b=r.hasManualEntry===!0||!r.sources||r.sources.length===0,d=document.createElement("li");b&&(d.dataset.isManual="true",d.style.backgroundColor="#ffedd5");const D=u?"bg-gray-100":b?"bg-orange-100 shadow-sm border border-orange-200":"bg-white shadow-sm border border-gray-100";d.className=`flex flex-col p-3 rounded-lg transition-colors duration-200 ${D}`;const _=document.createElement("div");_.className="flex items-center w-full";const w=document.createElement("input");w.type="checkbox",w.className="form-checkbox h-6 w-6 text-tomato rounded-full border-gray-300 focus:ring-tomato cursor-pointer transition duration-150 ease-in-out",w.checked=u;const I=document.createElement("div");I.className="ml-3 flex-grow cursor-pointer select-none";const $=Number.isInteger(r.totalQuantity)?r.totalQuantity:parseFloat(r.totalQuantity.toFixed(2)),E=document.createElement("span");E.className=`font-medium text-base ${u?"line-through text-gray-400":"text-gray-800"}`,E.textContent=r.name;const L=document.createElement("span");L.className=`ml-2 font-bold text-base ${u?"text-gray-400":"text-gray-800"}`,L.textContent=` - ${$} ${r.unit||""}`.trim(),I.appendChild(E),I.appendChild(L);const T=()=>{const k=!w.checked;w.checked=k,q(i,k,d,w,E,L)};if(w.addEventListener("change",k=>{q(i,k.target.checked,d,w,E,L)}),I.addEventListener("click",T),_.appendChild(w),_.appendChild(I),d.appendChild(_),r.sources&&r.sources.length>0){const k=document.createElement("div");k.className="mt-2 ml-9 text-xs text-gray-500 space-y-1";const S=r.sources.reduce((P,N)=>{const K=`${N.recipeName} (${N.day} ${N.time})`;return P[K]||(P[K]=0),P[K]+=N.quantity,P},{});for(const P in S){const N=document.createElement("div");N.textContent=`↳ ${P}`,k.appendChild(N)}d.appendChild(k)}l.appendChild(d)}),x.appendChild(l)}),h.length>0){const t=document.createElement("div");t.className="my-8 border-t-2 border-dashed border-gray-300 pt-4 text-center";const n=document.createElement("h3");n.className="text-lg font-semibold text-gray-500",n.textContent="Articles cochés",t.appendChild(n),x.appendChild(t);const l=h.reduce((c,i)=>{const u=i.category||"Inconnue";return c[u]||(c[u]=[]),c[u].push(i),c},{});Object.keys(l).sort((c,i)=>c==="Inconnue"?1:i==="Inconnue"?-1:c.localeCompare(i)).forEach(c=>{const i=document.createElement("h3");i.className="font-bold text-lg text-gray-700 mt-6 mb-3 border-b border-gray-200 pb-1",i.textContent=c,x.appendChild(i);const u=document.createElement("ul");u.className="space-y-3",l[c].sort((b,d)=>b.name.localeCompare(d.name)).forEach(b=>{const d=`${b.name}_${b.unit||""}`,D=Q(d),_=!0,w=b.hasManualEntry===!0||!b.sources||b.sources.length===0,I=document.createElement("li");w&&(I.dataset.isManual="true"),I.className="flex flex-col p-3 rounded-lg transition-colors duration-200 bg-gray-100";const $=document.createElement("div");$.className="flex items-center w-full";const E=document.createElement("input");E.type="checkbox",E.className="form-checkbox h-6 w-6 text-tomato rounded-full border-gray-300 focus:ring-tomato cursor-pointer transition duration-150 ease-in-out",E.checked=_;const L=document.createElement("div");L.className="ml-3 flex-grow cursor-pointer select-none";const T=Number.isInteger(b.totalQuantity)?b.totalQuantity:parseFloat(b.totalQuantity.toFixed(2)),k=document.createElement("span");k.className="font-medium text-base line-through text-gray-400",k.textContent=b.name;const S=document.createElement("span");S.className="ml-2 font-bold text-base text-gray-400",S.textContent=` - ${T} ${b.unit||""}`.trim(),L.appendChild(k),L.appendChild(S);const P=()=>{const N=!E.checked;E.checked=N,q(D,N,I,E,k,S)};E.addEventListener("change",N=>{q(D,N.target.checked,I,E,k,S)}),L.addEventListener("click",P),$.appendChild(E),$.appendChild(L),I.appendChild($),u.appendChild(I)}),x.appendChild(u)})}}function q(e,o,a,h,m,y){if(!C)return;const g=a.dataset.isManual==="true";o?(a.classList.remove("bg-white","bg-orange-100","shadow-sm","border","border-gray-100","border-orange-200"),a.classList.add("bg-gray-100"),a.style.backgroundColor="",m.classList.add("line-through","text-gray-400"),m.classList.remove("text-gray-800"),y.classList.add("text-gray-400"),y.classList.remove("text-gray-800")):(a.classList.remove("bg-gray-100"),g?(a.classList.add("bg-orange-100","shadow-sm","border","border-orange-200"),a.style.backgroundColor="#ffedd5"):(a.classList.add("bg-white","shadow-sm","border","border-gray-100"),a.style.backgroundColor=""),m.classList.remove("line-through","text-gray-400"),m.classList.add("text-gray-800"),y.classList.remove("text-gray-400"),y.classList.add("text-gray-800"));const s=A(U,"plans",C.id),p={};p[`checkedItems.${e}`]=o,p.lastUpdated=new Date,F(()=>import("./main-Ca5URGHw.js").then(f=>f.e),__vite__mapDeps([0,1,2])).then(f=>{f.updateDoc(s,p)}).catch(f=>{console.error("Error updating checked item:",f)})}function ne(e){const o=new Map;(e.manualItems||[]).forEach(s=>{const p=`${s.name.trim().toLowerCase()}_${s.unit||""}`;o.set(p,{name:s.name.trim(),totalQuantity:s.totalQuantity,unit:s.unit,category:s.category||"Inconnue",hasManualEntry:!0})});const h=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];if(e.weeks)for(const s in e.weeks){const p=e.weeks[s],f=p.menuData||{},v=p.servingsData||{};for(const M in f){const t=f[M];if(!Array.isArray(t))continue;const[n,l]=M.split("-"),r=`${n}-${l}`,c=parseInt(v[r]||e.defaultNumPeople||1,10);t.forEach(i=>{const u=Z.find(d=>d.id===i.id)||i;if(!u||!u.ingredients)return;const b=u.servings||1;u.ingredients.forEach(d=>{if(!d.name||!d.quantity)return;const D=X.find(T=>T.name.toLowerCase()===d.name.toLowerCase()),_=D?D.category:"Inconnue",w=parseFloat(String(d.quantity).replace(",","."));if(isNaN(w))return;const $=w/b*c,E=d.unit||"",L=`${d.name.trim().toLowerCase()}_${E}`;if(o.has(L)){const T=o.get(L);T.totalQuantity+=$,T.sources||(T.sources=[]),T.sources.push({recipeName:u.name,day:h[parseInt(n,10)],time:l==="lunch"?"Midi":"Soir",quantity:$})}else o.set(L,{name:d.name.trim(),totalQuantity:$,unit:E,category:_,sources:[{recipeName:u.name,day:h[parseInt(n,10)],time:l==="lunch"?"Midi":"Soir",quantity:$}]})})})}}const m=[],y=[],g=e.hiddenTrashItems||[];return o.forEach(s=>{if(s.totalQuantity>0)m.push(s);else if(s.totalQuantity<=0&&s.sources&&s.sources.length>0){const p=`${s.name}_${s.unit||""}`,f=Q(p);!g.includes(f)&&!g.includes(p)&&y.push(s)}}),{active:m,deleted:y}}const B=document.createElement("button");if(B.id="scroll-to-top-btn",B.className="hidden fixed bottom-20 right-5 bg-tomato text-white rounded-full w-12 h-12 shadow-lg z-50",B.innerHTML='<i class="fas fa-arrow-up"></i>',document.body.appendChild(B),window.addEventListener("scroll",()=>{window.pageYOffset>200?B.classList.remove("hidden"):B.classList.add("hidden")}),B.addEventListener("click",()=>{window.scrollTo({top:0,behavior:"smooth"})}),G){const e=G.cloneNode(!0);G.parentNode.replaceChild(e,G),e.addEventListener("change",o=>{const a=o.target.value;localStorage.setItem("lastActivePlanId",a),V(a)})}async function ae(){try{X=(await J(W(U,"ingredients"))).docs.map(o=>({id:o.id,...o.data()}))}catch(e){console.error("Error fetching ingredients",e)}try{Z=(await J(W(U,"recipes"))).docs.map(o=>({id:o.id,...o.data()}))}catch(e){console.error("Error fetching recipes",e)}se(e=>{const o=document.getElementById("shopping-mode-plan-select");if(!o)return;const a=o.value;if(o.innerHTML="",e.length===0){x&&(x.innerHTML='<p class="text-center p-4">Aucun menu trouvé.</p>');return}e.forEach(y=>{const g=document.createElement("option");g.value=y.id,g.textContent=y.name,o.appendChild(g)});const h=localStorage.getItem("lastActivePlanId");let m=null;h&&e.some(y=>y.id===h)?m=h:e.length>0&&(m=e[0].id),m&&(a&&e.some(y=>y.id===a)?(o.value=a,C||V(a)):(o.value=m,V(m)))})}return ae(),()=>{O&&O(),B&&B.remove()}}export{de as default};
