import{g as d,c,d as l,s as h,b as u,a as m}from"./firebase-config-9gANoKOS.js";import{g}from"./main-CPC2Lv91.js";class p{constructor(){this.units=["g","kg","ml","l","pièce(s)","c.à.s.","c.à.c.","pincée(s)"],this.onSuccessCallback=null,this.bindElements(),this.init()}bindElements(){this.modal||(this.modal=document.getElementById("ingredient-form-modal"),this.modal&&this.modal.parentElement!==document.body&&(document.body.appendChild(this.modal),console.log("DEBUG: Hoisted ingredient-form-modal to body")),this.form=document.getElementById("ingredient-form"),this.title=document.getElementById("ingredient-modal-title"),this.idInput=document.getElementById("ingredient-id"),this.nameInput=document.getElementById("ingredient-name"),this.unitSelect=document.getElementById("ingredient-unit"),this.categorySelect=document.getElementById("ingredient-category"),this.imageUrlInput=document.getElementById("ingredient-image-url"),this.closeBtn=document.getElementById("close-ingredient-modal"),this.cancelBtn=document.getElementById("cancel-ingredient-btn"))}init(){this.eventsAttached=!1,this.attachEvents()}attachEvents(){!this.modal||this.eventsAttached||(this.closeBtn?.addEventListener("click",()=>this.close()),this.cancelBtn?.addEventListener("click",()=>this.close()),this.form?.addEventListener("submit",e=>this.handleSubmit(e)),this.setupSeasonalityBindings(),this.eventsAttached=!0)}setupSeasonalityBindings(){const e=this.modal.querySelectorAll(".season-checkbox"),o=this.modal.querySelectorAll(".month-checkbox");e.forEach(n=>{n.addEventListener("change",t=>{const i=t.target.value,s=t.target.checked;this.modal.querySelectorAll(`.month-checkbox[data-season="${i}"]`).forEach(r=>r.checked=s)})}),o.forEach(n=>{n.addEventListener("change",t=>{const i=t.target.dataset.season,s=this.modal.querySelector(`.season-checkbox[value="${i}"]`);if(t.target.checked)s&&(s.checked=!0);else{const a=this.modal.querySelectorAll(`.month-checkbox[data-season="${i}"]:checked`);s&&a.length===0&&(s.checked=!1)}})})}async open(e=null,o=null){console.log("DEBUG: IngredientModalManager.open called",{ingredientOrName:e});try{if(this.bindElements(),!this.form&&(console.error("Ingredient Modal elements not found!"),this.modal=document.getElementById("ingredient-form-modal"),this.form=document.getElementById("ingredient-form"),!this.form)){alert("Erreur système : Le formulaire d'ingrédient est introuvable dans la page.");return}this.eventsAttached||this.attachEvents(),this.onSuccessCallback=o,this.form.reset(),this.unitSelect.innerHTML="",this.units.forEach(n=>{const t=document.createElement("option");t.value=n,t.textContent=n,this.unitSelect.appendChild(t)}),this.populateCategories().catch(n=>{console.error("Non-blocking error in populateCategories:",n)}),typeof e=="string"?this.prepareNew(e):e&&typeof e=="object"?this.prepareEdit(e):this.prepareNew(),this.modal.classList.remove("hidden"),this.modal.style.display="flex",this.modal.classList.remove("hidden"),this.modal.style.display="flex",this.modal.style.zIndex="9999",this.modal.ariaHidden="false",console.log("DEBUG: IngredientModalManager modal shown (Hoisted + Display Flex)")}catch(n){console.error("CRITICAL ERROR in IngredientModalManager.open:",n),alert("Une erreur est survenue lors de l'ouverture du formulaire : "+n.message)}}async populateCategories(){try{const o=(await d(c(l,"ingredient_categories"))).docs.map(n=>n.data().name).sort();this.categorySelect.innerHTML="",o.forEach(n=>{const t=document.createElement("option");t.value=n,t.textContent=n,this.categorySelect.appendChild(t)})}catch(e){console.error("Error fetching categories for modal",e)}}prepareNew(e=""){this.title.textContent="Ajouter un ingrédient",this.idInput.value="",this.nameInput.value=e,this.unitSelect.value=this.units[0],this.modal.querySelectorAll('input[type="checkbox"]').forEach(o=>o.checked=!1)}prepareEdit(e){this.title.textContent="Modifier l'ingrédient",this.currentIngredientOwnerId=e.userId,this.idInput.value=e.id,this.nameInput.value=e.name,this.unitSelect.value=e.unit||"",this.categorySelect.value=e.category||"",this.imageUrlInput.value=e.imageUrl||"";const o=e.seasons||[],n=e.months||[];["Printemps","Eté","Automne","Hiver"].forEach(t=>{const i=`season-${t.toLowerCase().replace("é","e")}`,s=document.getElementById(i);s&&(s.checked=o.includes(t))}),this.modal.querySelectorAll(".month-checkbox").forEach(t=>{t.checked=n.includes(t.value)})}close(){this.modal.classList.add("hidden"),this.modal.style.display="",this.modal.style.zIndex="",this.modal.ariaHidden="true",console.log("DEBUG: IngredientModalManager closed and styles cleared")}async handleSubmit(e){e.preventDefault();const o=this.idInput.value,n=[];this.modal.querySelectorAll(".season-checkbox:checked").forEach(a=>{n.push(a.value)});const t=[];this.modal.querySelectorAll(".month-checkbox:checked").forEach(a=>{t.push(a.value)}),this.modal.querySelectorAll(".month-checkbox:checked").forEach(a=>{t.push(a.value)});const s={userId:this.currentIngredientOwnerId||g(),name:this.nameInput.value,unit:this.unitSelect.value,category:this.categorySelect.value,seasons:n,months:t,imageUrl:this.imageUrlInput.value||`https://tse2.mm.bing.net/th?q=${encodeURIComponent(this.nameInput.value)}%20ingredient&w=400&h=300&c=7&rs=1&p=0`};if(!s.name||!s.category){alert("Le nom et la catégorie sont requis.");return}try{o?await h(u(l,"ingredients",o),s):await m(c(l,"ingredients"),s),this.close(),this.onSuccessCallback&&await this.onSuccessCallback(s.name)}catch(a){console.error("Erreur de sauvegarde de l'ingrédient: ",a)}}}const I=new p;export{p as IngredientModalManager,I as ingredientModalManager};
