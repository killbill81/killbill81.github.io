import{o as Zt,s as en,a as Mt,g as ue,c as F,b as Le,d as ot,e as P,q as ge,f,w as ae,u as Ne,h as Je,i as Ie,j as tn,k as lt,l as Nt,m as yt,n as je,p as nn,r as an,_ as sn}from"./firebase-config-26u3hbUh.js";const rn=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"}));let dt=null;function jt(){return new Promise(e=>{Zt(Mt,t=>{if(dt=t,t){console.log("User is logged in:",t.uid);const n=document.getElementById("logout-btn"),r=document.getElementById("profile-btn");n&&n.classList.remove("hidden"),r&&r.classList.remove("hidden"),n&&!n.hasAttribute("data-listener-attached")&&(n.addEventListener("click",()=>{en(Mt).catch(o=>{console.error("Sign Out Error",o)})}),n.setAttribute("data-listener-attached","true")),e(t)}else{console.log("User not logged in. Redirecting to login.html");const n=window.location.origin+"/login.html";window.location.href!==n&&(window.location.href=n),e(null)}})})}function ye(){return dt?dt.uid:null}function Be(){return dt}const on=Object.freeze(Object.defineProperty({__proto__:null,getCurrentUser:Be,getCurrentUserId:ye,protectPage:jt},Symbol.toStringTag,{value:"Module"}));class It{constructor(t,n,r,o,l,m,c,g,b,D,k,L,O,E,z,X){this.db=t,this.modal=document.getElementById(n),this.form=document.getElementById(r),this.modalTitle=document.getElementById(o),this.recipeIdInput=document.getElementById(l),this.recipeNameInput=document.getElementById(m),this.recipeCategoryInput=document.getElementById(c),this.recipeServingsInput=document.getElementById(g),this.recipePrepTimeInput=document.getElementById(b),this.recipeDifficultyInput=document.getElementById(D),this.recipeStepsTextarea=document.getElementById(k),this.ingredientsListDiv=document.getElementById(L),this.addIngredientBtn=document.getElementById(O),this.saveRecipeBtn=document.getElementById(E),this.closeButton=document.getElementById(z),this.cancelButton=document.getElementById(X),this.masterIngredientList=[],this.boundAddIngredient=()=>this.addIngredientInput(void 0,this.form.ingredients),this.boundCloseForm=()=>this.closeForm(),this.boundHandleSubmit=W=>this.handleSubmit(W),this.addIngredientBtn.addEventListener("click",this.boundAddIngredient),this.closeButton.addEventListener("click",this.boundCloseForm),this.cancelButton.addEventListener("click",this.boundCloseForm),this.saveRecipeBtn.addEventListener("click",this.boundHandleSubmit)}destroy(){this.addIngredientBtn.removeEventListener("click",this.boundAddIngredient),this.closeButton.removeEventListener("click",this.boundCloseForm),this.cancelButton.removeEventListener("click",this.boundCloseForm),this.saveRecipeBtn.removeEventListener("click",this.boundHandleSubmit)}async openForm(t=null,n="Ajouter une recette"){await this.fetchMasterIngredients(),console.log("openForm called with recipe:",t,"and title:",n),this.form.reset(),this.ingredientsListDiv.innerHTML="",this.modalTitle.textContent=n;const r=[];if(this.form.ingredients=r,t){this.recipeIdInput.value=t.id||"",this.recipeNameInput.value=t.name||"";const o=t.category||"Plat";for(const l of this.recipeCategoryInput.options)if(l.value.toLowerCase()===o.toLowerCase()){l.selected=!0;break}this.recipeServingsInput.value=parseInt(t.servings)||"",this.recipePrepTimeInput.value=parseInt(t.prepTime)||"",this.recipeDifficultyInput.value=t.difficulty||"Moyen",this.recipeStepsTextarea.value=t.steps||"",t.ingredients&&t.ingredients.length>0?t.ingredients.forEach(l=>this.addIngredientInput({...l},r)):this.addIngredientInput(void 0,r)}else this.recipeIdInput.value="",this.addIngredientInput(void 0,r);this.modal.classList.remove("hidden")}closeForm(){this.modal.classList.add("hidden")}async fetchMasterIngredients(){if(this.masterIngredientList=[],!!this.db)try{const t=await ue(F(this.db,"ingredients"));this.masterIngredientList=t.docs.map(n=>({id:n.id,...n.data()})),this.masterIngredientList.sort((n,r)=>n.name.localeCompare(r.name))}catch(t){console.error("Erreur lors de la récupération de la liste des ingrédients: ",t),alert("Impossible de charger la liste des ingrédients de base. La recherche ne fonctionnera pas.")}}addIngredientInput(t={quantity:"",name:"",unit:""},n){const r=document.createElement("div");r.className="relative flex items-stretch space-x-2 ingredient-row";const o={...t};n.push(o);const l=n.length-1,m=document.createElement("input");m.type="text",m.className="ingredient-quantity mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm",m.placeholder="Qté",m.value=o.quantity,m.addEventListener("change",L=>{n[l].quantity=L.target.value});const c=document.createElement("input");c.type="text",c.className="ingredient-unit mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm bg-gray-100",c.placeholder="Unité",c.readOnly=!0,c.value=o.unit||"";const g=document.createElement("div");g.className="relative w-1/2";const b=document.createElement("input");b.type="text",b.className="ingredient-name mt-1 block w-full rounded-md border-gray-300 shadow-sm",b.placeholder="Chercher un ingrédient...",b.value=o.name,g.appendChild(b);const D=document.createElement("div");D.className="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto",g.appendChild(D),b.addEventListener("input",()=>{const L=b.value.toLowerCase();if(!L){D.classList.add("hidden");return}const O=this.masterIngredientList.filter(z=>z.name.toLowerCase().includes(L));D.innerHTML="",O.forEach(z=>{const X=document.createElement("div");X.className="p-2 hover:bg-tomato hover:text-white cursor-pointer",X.textContent=z.name,X.addEventListener("click",()=>{b.value=z.name,c.value=z.unit,D.classList.add("hidden"),n[l].name=z.name,n[l].unit=z.unit,n[l].id=z.id}),D.appendChild(X)});const E=document.createElement("div");E.className="p-2 bg-blue-50 hover:bg-blue-200 cursor-pointer font-bold text-blue-700",E.textContent=`+ Créer "${b.value}"`,E.addEventListener("click",async()=>{const z=b.value,X="pièce(s)";try{const W=await Le(F(this.db,"ingredients"),{name:z,unit:X});await this.fetchMasterIngredients(),b.value=z,c.value=X,D.classList.add("hidden"),n[l].name=z,n[l].unit=X,n[l].id=W.id}catch(W){console.error("Erreur d'ajout d'ingrédient",W),alert("L'ingrédient n'a pas pu être créé.")}}),D.appendChild(E),D.classList.remove("hidden")});const k=document.createElement("button");k.type="button",k.className="btn btn-ghost text-red-500 hover:bg-red-50 btn-sm mt-1",k.innerHTML='<i class="fas fa-trash"></i>',k.addEventListener("click",()=>{r.remove(),n[l]=null}),r.appendChild(g),r.appendChild(m),r.appendChild(c),r.appendChild(k),this.ingredientsListDiv.appendChild(r)}async handleSubmit(t){t.preventDefault(),this.saveRecipeBtn.disabled=!0,this.saveRecipeBtn.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i> Sauvegarde...',console.log("Ingredients array from form before filter:",this.form.ingredients);const n=this.form.ingredients.filter(l=>l!==null&&l.quantity&&l.name);console.log("Ingredients array after filter:",n);const r={name:this.recipeNameInput.value,category:this.recipeCategoryInput.value,servings:parseInt(this.recipeServingsInput.value)||0,prepTime:parseInt(this.recipePrepTimeInput.value)||0,difficulty:this.recipeDifficultyInput.value,steps:this.recipeStepsTextarea.value,ingredients:n,imageUrl:""};console.log("Recipe data being sent to Firebase:",r);const o=this.recipeIdInput.value;try{o?await ot(P(this.db,"recipes",o),r):await Le(F(this.db,"recipes"),r),this.closeForm(),console.log("Recipe saved successfully!"),this.onSaveCallback&&this.onSaveCallback()}catch(l){console.error("Erreur de sauvegarde: ",l),alert("Une erreur est survenue lors de la sauvegarde.")}finally{this.saveRecipeBtn.disabled=!1,this.saveRecipeBtn.textContent="Sauvegarder"}}setOnSaveCallback(t){this.onSaveCallback=t}}const ln=Object.freeze(Object.defineProperty({__proto__:null,RecipeFormHandler:It},Symbol.toStringTag,{value:"Module"}));let vt=()=>{};function dn(){const e=document.getElementById("search-friends-input");return document.getElementById("search-friends-btn").addEventListener("click",()=>kt(e.value)),e.addEventListener("keyup",n=>{n.key==="Enter"&&kt(e.value)}),cn(),$t(),()=>{vt&&vt()}}async function cn(){const e=document.getElementById("friends-list-container"),t=Be()?.uid;if(!t||!e)return;e.innerHTML='<p class="text-gray-500">Chargement...</p>';const n=P(f,"users",t);vt=Je(n,async r=>{if(!r.exists()){e.innerHTML='<p class="text-red-500">Erreur: Utilisateur non trouvé.</p>';return}const o=r.data().friends||[];if(e.innerHTML="",o.length===0){e.innerHTML=`<p class="text-gray-500">Vous n'avez pas encore d'amis. Utilisez la recherche pour en ajouter.</p>`;return}for(const l of o)try{const m=await Ie(P(f,"users",l));m.exists()&&e.appendChild(un(m.data()))}catch(m){console.error("Erreur de chargement d'un ami",m)}})}function un(e){const t=document.createElement("div");t.className="bg-white p-3 rounded-lg flex items-center justify-between shadow-sm";const n=document.createElement("div");n.className="flex items-center",n.innerHTML=`
        <img src="${e.photoURL||"https://placehold.co/40"}" alt="Avatar" class="w-10 h-10 rounded-full mr-3">
        <div>
            <p class="font-bold">${e.displayName}</p>
            <p class="text-sm text-gray-500">${e.email}</p>
        </div>
    `;const r=document.createElement("button");return r.className="btn btn-ghost text-red-500 btn-sm",r.innerHTML='<i class="fas fa-user-times"></i>',r.title="Retirer cet ami",r.addEventListener("click",()=>mn(e.uid)),t.appendChild(n),t.appendChild(r),t}async function mn(e){const t=Be()?.uid;if(!t||!e||!confirm("Voulez-vous vraiment retirer cet ami ?"))return;const n=P(f,"users",t),r=P(f,"users",e),o=lt(f);o.update(n,{friends:yt(e)}),o.update(r,{friends:yt(t)});try{await o.commit()}catch(l){console.error("Erreur lors de la suppression de l'ami: ",l),alert("Une erreur est survenue.")}}async function kt(e){const t=document.getElementById("search-results-container"),n=Be()?.uid;if(!(!e||!t)){t.innerHTML='<p class="text-gray-500">Recherche en cours...</p>';try{const r=e.toLowerCase(),o=ge(F(f,"users"),ae("keywords","array-contains",r)),l=await ue(o);if(t.innerHTML="",l.empty){t.innerHTML='<p class="text-gray-500">Aucun utilisateur trouvé.</p>';return}l.forEach(m=>{const c=m.data();if(c.uid===n)return;const g=document.createElement("div");g.className="bg-gray-50 p-2 rounded-lg flex items-center justify-between",g.innerHTML=`
                <div class="flex items-center">
                    <img src="${c.photoURL||"https://placehold.co/32"}" class="w-8 h-8 rounded-full mr-2">
                    <span class="font-medium text-sm">${c.displayName}</span>
                </div>
            `;const b=document.createElement("button");b.className="btn btn-secondary btn-xs",b.innerHTML='<i class="fas fa-user-plus"></i>',b.addEventListener("click",()=>pn(c.uid)),g.appendChild(b),t.appendChild(g)})}catch(r){console.error("Erreur de recherche: ",r),t.innerHTML='<p class="text-red-500">Erreur de recherche.</p>'}}}async function pn(e){const t=Be()?.uid;if(!t||t===e)return;const n=ge(F(f,"friend_requests"),ae("senderId","in",[t,e]),ae("receiverId","in",[t,e]));if(!(await ue(n)).empty)return alert("Une demande d'ami existe déjà avec cet utilisateur.");if((await Ie(P(f,"users",t))).data()?.friends?.includes(e))return alert("Vous êtes déjà ami avec cet utilisateur.");try{await addDoc(F(f,"friend_requests"),{senderId:t,receiverId:e,status:"pending",createdAt:tn()}),alert("Demande d'ami envoyée !")}catch(l){console.error("Erreur lors de l'envoi de la demande d'ami: ",l),alert("Une erreur est survenue.")}}async function $t(){const e=document.getElementById("pending-requests-container"),t=document.getElementById("declined-requests-container"),n=Be()?.uid;if(!(!n||!e||!t)){e.innerHTML='<p class="text-gray-500">Chargement...</p>',t.innerHTML='<p class="text-gray-500">Chargement...</p>';try{const r=ge(F(f,"friend_requests"),ae("senderId","==",n)),o=await ue(r),l=[],m=[];for(const c of o.docs){const g={id:c.id,...c.data()},b=await Ie(P(f,"users",g.receiverId));b.exists()&&(g.receiver=b.data()),g.status==="pending"?l.push(g):g.status==="declined"&&m.push(g)}e.innerHTML="",l.length>0?l.forEach(c=>e.appendChild(Tt(c))):e.innerHTML='<p class="text-gray-500">Aucune demande en attente.</p>',t.innerHTML="",m.length>0?m.forEach(c=>t.appendChild(Tt(c))):t.innerHTML='<p class="text-gray-500">Aucune demande rejetée.</p>'}catch(r){console.error("Erreur lors du chargement des demandes envoyées: ",r),e.innerHTML='<p class="text-red-500">Erreur de chargement.</p>',t.innerHTML='<p class="text-red-500">Erreur de chargement.</p>'}}}function Tt(e){const t=document.createElement("div");t.className="bg-white p-3 rounded-lg flex items-center justify-between shadow-sm";const n=e.receiver,r=document.createElement("div");r.className="flex items-center",r.innerHTML=`
        <img src="${n?.photoURL||"https://placehold.co/40"}" alt="Avatar" class="w-10 h-10 rounded-full mr-3">
        <div>
            <p class="font-bold">${n?.displayName||"Utilisateur inconnu"}</p>
            <p class="text-sm text-gray-500">Statut : <span class="font-medium">${e.status}</span></p>
        </div>
    `;const o=document.createElement("button");return o.className="btn btn-ghost text-red-500 btn-sm",o.innerHTML='<i class="fas fa-times-circle"></i>',o.title="Annuler la demande",o.addEventListener("click",async()=>{confirm("Voulez-vous vraiment annuler cette demande ?")&&(await deleteDoc(P(f,"friend_requests",e.id)),$t())}),t.appendChild(r),t.appendChild(o),t}async function At(e,t){const n=Be()?.uid;if(!n||!t)return;const r=P(f,"users",n),o=P(f,"users",t),l=P(f,"friend_requests",e),m=lt(f);m.update(r,{friends:Nt(t)}),m.update(o,{friends:Nt(n)}),m.delete(l);try{await m.commit()}catch(c){throw console.error("Erreur lors de l'acceptation de la demande d'ami: ",c),c}}async function qt(e){try{const t=P(f,"friend_requests",e);await Ne(t,{status:"declined"})}catch(t){throw console.error("Erreur lors du refus de la demande d'ami: ",t),t}}const fn=Object.freeze(Object.defineProperty({__proto__:null,acceptFriendRequest:At,declineFriendRequest:qt,default:dn},Symbol.toStringTag,{value:"Module"}));function gn(){const e=document.getElementById("ingredients-list-container"),t=document.getElementById("add-ingredient-btn"),n=document.getElementById("category-tabs"),r=document.getElementById("search-bar"),o=document.getElementById("ingredient-form-modal"),l=document.getElementById("ingredient-modal-title"),m=document.getElementById("close-ingredient-modal"),c=document.getElementById("cancel-ingredient-btn"),g=document.getElementById("ingredient-form"),b=document.getElementById("ingredient-id"),D=document.getElementById("ingredient-name"),k=document.getElementById("ingredient-unit"),L=document.getElementById("ingredient-category"),O=document.getElementById("manage-categories-btn"),E=document.getElementById("category-management-modal"),z=document.getElementById("close-category-modal"),X=document.getElementById("done-category-modal-btn"),W=document.getElementById("add-category-form"),xe=document.getElementById("new-category-name"),$=document.getElementById("category-list");let A=[],S=[],q="",G="",me=null;const ee=["g","kg","ml","l","pièce(s)","c.à.s.","c.à.c.","pincée(s)"];async function oe(){await te(),await fe()}async function te(){if(f)try{S=(await ue(F(f,"ingredient_categories"))).docs.map(B=>({id:B.id,...B.data()})),S.sort((B,x)=>B.name.localeCompare(x.name))}catch(M){console.error("Erreur lors de la récupération des catégories: ",M)}}async function fe(){if(f)try{A=(await ue(F(f,"ingredients"))).docs.map(B=>({id:B.id,...B.data()})),U(),ne()}catch(M){console.error("Erreur de chargement des ingrédients: ",M)}}function De(M=null){g.reset(),k.innerHTML="",ee.forEach(N=>{const Q=document.createElement("option");Q.value=N,Q.textContent=N,k.appendChild(Q)});const B=S.map(N=>N.name),x=[...new Set(A.map(N=>N.category).filter(Boolean))],C=[...new Set([...B,...x])];C.sort((N,Q)=>N.localeCompare(Q.name)),L.innerHTML="",C.forEach(N=>{const Q=document.createElement("option");Q.value=N,Q.textContent=N,L.appendChild(Q)}),M?(l.textContent="Modifier l'ingrédient",b.value=M.id,D.value=M.name,k.value=M.unit||"",L.value=M.category||(C.length>0?C[0]:"")):(l.textContent="Ajouter un ingrédient",b.value="",k.value=ee[0],L.value=q||(C.length>0?C[0]:"")),o.classList.remove("hidden")}function Ee(){o.classList.add("hidden")}async function _(M){M.preventDefault();const B=b.value,x={name:D.value,unit:k.value,category:L.value};if(!x.name||!x.category){alert("Le nom et la catégorie sont requis.");return}try{B?await ot(P(f,"ingredients",B),x):await Le(F(f,"ingredients"),x),Ee(),await fe()}catch(C){console.error("Erreur de sauvegarde de l'ingrédient: ",C)}}function v(){H(),E.classList.remove("hidden")}function j(){E.classList.add("hidden")}function H(){if($.innerHTML="",S.length===0){$.innerHTML='<p class="text-gray-500">Aucune catégorie définie.</p>';return}S.forEach(M=>{const B=document.createElement("div");B.className="flex items-center justify-between p-2 border-b";const x=document.createElement("span");x.textContent=M.name,B.appendChild(x);const C=document.createElement("div");C.className="flex space-x-2";const N=document.createElement("button");N.className="btn btn-ghost btn-xs text-blue-500",N.innerHTML='<i class="fas fa-edit"></i>',N.addEventListener("click",()=>V(M)),C.appendChild(N);const Q=document.createElement("button");Q.className="btn btn-ghost btn-xs text-red-500",Q.innerHTML='<i class="fas fa-trash"></i>',Q.addEventListener("click",()=>se(M)),C.appendChild(Q),B.appendChild(C),$.appendChild(B)})}async function K(M){M.preventDefault();const B=xe.value.trim();if(B&&!S.find(x=>x.name.toLowerCase()===B.toLowerCase()))try{await Le(F(f,"ingredient_categories"),{name:B}),xe.value="",await te(),H(),U()}catch(x){console.error("Erreur d'ajout de catégorie: ",x)}else alert("Cette catégorie existe déjà ou le nom est invalide.")}async function V(M){const B=M.name,x=prompt(`Entrez le nouveau nom pour la catégorie "${B}":`,B);if(x&&x.trim()!==""&&x!==B)try{await ot(P(f,"ingredient_categories",M.id),{name:x});const C=ge(F(f,"ingredients"),ae("category","==",B)),N=await ue(C),Q=lt(f);N.forEach($e=>{Q.update($e.ref,{category:x})}),await Q.commit(),await oe(),H()}catch(C){console.error("Erreur de renommage: ",C)}}async function se(M){if(confirm(`Êtes-vous sûr de vouloir supprimer la catégorie "${M.name}"?

Tous les ingrédients associés seront déplacés vers la catégorie "Inconnue".`))try{await je(P(f,"ingredient_categories",M.id));const B=ge(F(f,"ingredients"),ae("category","==",M.name)),x=await ue(B),C=lt(f);x.forEach(N=>{C.update(N.ref,{category:"Inconnue"})}),await C.commit(),q="",await oe(),H()}catch(B){console.error("Erreur de suppression: ",B)}}function U(){n.innerHTML="";const M=S.map(C=>C.name),B=[...new Set(A.map(C=>C.category||"Inconnue"))];let x=[...new Set([...M,...B])];x.sort((C,N)=>C.localeCompare(N)),x.includes("Inconnue")&&(x=x.filter(C=>C!=="Inconnue"),x.push("Inconnue")),x.length===0&&A.length>0&&x.push("Inconnue"),!q&&x.length>0&&(q=x[0]),x.forEach(C=>{const N=document.createElement("button"),Q=C===q;N.className=`px-4 py-2 text-sm font-medium rounded-t-lg ${Q?"bg-tomato text-white":"text-gray-500 hover:text-tomato"}`,N.textContent=C,N.addEventListener("click",()=>Y(C)),n.appendChild(N)})}function Y(M){q=M,U(),ne()}function ne(){e.innerHTML="";const M=q||(S.length>0?S[0].name:"Inconnue");let B=A.filter(C=>(C.category||"Inconnue")===M);if(G){const C=G.toLowerCase();B=B.filter(N=>N.name.toLowerCase().includes(C))}if(B.length===0){e.innerHTML='<p class="text-center text-gray-500 p-10">Aucun ingrédient dans cette catégorie.</p>';return}B.sort((C,N)=>C.name.localeCompare(N.name,"fr",{sensitivity:"base"}));const x=document.createElement("div");x.className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4",B.forEach(C=>{const N=document.createElement("div");N.className="p-3 bg-white shadow-sm rounded-lg flex flex-col items-start space-y-2";const Q=document.createElement("div");Q.className="flex-grow w-full flex justify-between items-center";const $e=document.createElement("span");$e.className="font-medium text-gray-800",$e.textContent=C.name;const Xe=document.createElement("span");Xe.className="text-gray-500 text-sm bg-gray-100 px-2 py-1 rounded-full",Xe.textContent=C.unit,Q.appendChild($e),Q.appendChild(Xe);const ze=document.createElement("div");ze.className="w-full flex justify-end items-center space-x-2 border-t pt-2 mt-2";const Oe=document.createElement("button");Oe.className="btn btn-ghost btn-xs text-blue-500 hover:bg-blue-50",Oe.innerHTML='<i class="fas fa-edit"></i>',Oe.addEventListener("click",()=>De(C));const Ae=document.createElement("button");Ae.className="btn btn-ghost btn-xs text-red-500 hover:bg-red-50",Ae.innerHTML='<i class="fas fa-trash-alt"></i>',Ae.addEventListener("click",()=>pe(C.id,C.name)),ze.appendChild(Oe),ze.appendChild(Ae),N.appendChild(Q),N.appendChild(ze),x.appendChild(N)}),e.appendChild(x)}async function pe(M,B){if(confirm(`Êtes-vous sûr de vouloir supprimer l'ingrédient "${B}" ?`))try{await je(P(f,"ingredients",M)),await fe()}catch(x){console.error("Erreur de suppression de l'ingrédient: ",x)}}r.addEventListener("input",M=>{const B=M.target.value.toLowerCase();if(!G&&B&&(me=q),G=B,G){const x=A.find(C=>C.name.toLowerCase().includes(G));x&&(q=x.category||"Inconnue")}else me&&(q=me,me=null);U(),ne()}),t.addEventListener("click",()=>De()),m.addEventListener("click",Ee),c.addEventListener("click",Ee),g.addEventListener("submit",_),O.addEventListener("click",v),z.addEventListener("click",j),X.addEventListener("click",j),W.addEventListener("submit",K),oe()}const hn=Object.freeze(Object.defineProperty({__proto__:null,default:gn},Symbol.toStringTag,{value:"Module"})),ce={modal:document.getElementById("share-modal"),closeBtn:document.getElementById("close-share-modal"),title:document.getElementById("share-modal-title"),friendsList:document.getElementById("share-friends-list"),sharePlanCheckbox:document.getElementById("share-planning-checkbox"),shareShoppingListCheckbox:document.getElementById("share-shopping-list-checkbox"),confirmBtn:document.getElementById("confirm-share-btn")};let Te={};function Bt(){ce.modal.classList.add("hidden")}async function bn(){const e=ye();if(!e||!Te.plan)return;const t=Array.from(ce.friendsList.querySelectorAll('input[type="checkbox"]:checked')).map(r=>r.value),n=document.querySelector('input[name="share-mode"]:checked')?.value;if(t.length===0){alert("Veuillez sélectionner au moins un ami.");return}if(!n){alert("Veuillez sélectionner un mode de partage.");return}ce.confirmBtn.disabled=!0,ce.confirmBtn.textContent="Envoi en cours...";try{const r=F(f,"shares");let o={};n==="collaborate"?o={senderId:e,createdAt:new Date,type:"collaborative_plan_invite",planId:Te.plan.id,planName:Te.plan.name}:o={senderId:e,createdAt:new Date,type:"share",plan:{name:Te.plan.name,weeks:Te.plan.weeks||{},manualItems:Te.plan.manualItems||[],defaultNumPeople:Te.plan.defaultNumPeople||1,startDay:Te.plan.startDay||"Lundi"}};for(const l of t)await Le(r,{...o,receiverId:l,status:"pending"});Bt(),alert("Partage envoyé avec succès !")}catch(r){console.error("Erreur lors de l'envoi du partage : ",r),alert("Une erreur est survenue lors de l'envoi du partage.")}finally{ce.confirmBtn.disabled=!1,ce.confirmBtn.textContent="Envoyer le partage"}}async function St(e={}){const{plan:t}=e;if(!t){alert("Aucun plan sélectionné à partager.");return}Te={plan:t},ce.title.textContent=`Partager le plan "${t.name}"`,ce.friendsList.innerHTML='<p class="text-gray-500">Chargement des amis...</p>',ce.modal.classList.remove("hidden");const n=ye();if(n)try{const r=await Ie(P(f,"users",n));if(r.exists()){const l=r.data().friends||[];if(l.length===0){ce.friendsList.innerHTML=`<p class="text-gray-500">Vous n'avez pas d'amis à qui partager.</p>`;return}ce.friendsList.innerHTML="";for(const m of l){const c=await Ie(P(f,"users",m));if(c.exists()){const g=c.data(),b=document.createElement("label");b.className="flex items-center p-2 hover:bg-gray-100 rounded-lg cursor-pointer";const D=document.createElement("input");D.type="checkbox",D.value=g.uid,D.className="form-checkbox h-5 w-5 text-tomato rounded focus:ring-tomato",b.appendChild(D);const k=document.createElement("img");k.src=g.photoURL||"https://placehold.co/40x40",k.alt=g.displayName,k.className="w-8 h-8 rounded-full ml-3 mr-3",b.appendChild(k);const L=document.createElement("span");L.className="font-medium",L.textContent=g.displayName||g.email,b.appendChild(L),ce.friendsList.appendChild(b)}}}}catch(r){console.error("Erreur lors du chargement des amis pour le partage : ",r),ce.friendsList.innerHTML='<p class="text-red-500">Une erreur est survenue.</p>'}}ce.closeBtn?.addEventListener("click",Bt);ce.modal?.addEventListener("click",e=>{e.target===ce.modal&&Bt()});ce.confirmBtn?.addEventListener("click",bn);const yn=Object.freeze(Object.defineProperty({__proto__:null,openShareModal:St},Symbol.toStringTag,{value:"Module"}));function vn(){const e=document.getElementById("search-bar"),t=document.getElementById("lists-container"),n=document.getElementById("add-list-btn"),r=document.getElementById("shared-lists-container"),o=document.getElementById("list-form-modal"),l=document.getElementById("list-modal-title"),m=document.getElementById("close-list-modal"),c=document.getElementById("cancel-list-btn"),g=document.getElementById("list-form"),b=document.getElementById("list-id"),D=document.getElementById("list-name"),k=document.getElementById("ingredients-list"),L=document.getElementById("add-ingredient-btn"),O=document.getElementById("save-list-btn");let E=[],z="",X=[],W=[];async function xe(){await $(),await A(),await S()}async function $(){if(f)try{X=(await ue(F(f,"ingredients"))).docs.map(v=>({id:v.id,...v.data()})),X.sort((v,j)=>v.name.localeCompare(j.name))}catch(_){console.error("Erreur lors de la récupération de la liste des ingrédients: ",_)}}async function A(){const _=ye();if(!(!f||!_))try{const v=ge(F(f,"shopping_lists"),ae("userId","==",_));E=(await ue(v)).docs.map(H=>({id:H.id,...H.data()})).filter(H=>H.isShared!==!0),oe()}catch(v){console.error("Erreur de chargement des listes: ",v)}}async function S(){const _=ye();if(!(!f||!_)){console.log(`Recherche de listes partagées pour userId: ${_}`);try{const v=ge(F(f,"shopping_lists"),ae("userId","==",_),ae("isShared","==",!0)),j=await ue(v);console.log(`Trouvé ${j.size} liste(s) partagée(s).`);const H=j.docs.map(K=>({id:K.id,...K.data()}));te(H)}catch(v){console.error("Erreur de chargement des listes partagées: ",v)}}}async function q(_=null){await $(),g.reset(),k.innerHTML="",W=[],_?(l.textContent="Modifier la liste",b.value=_.id,D.value=_.name,_.ingredients&&_.ingredients.length>0?_.ingredients.forEach(v=>ee(v)):ee()):(l.textContent="Créer une liste",b.value="",ee()),o.classList.remove("hidden")}function G(){o.classList.add("hidden")}async function me(_){_.preventDefault(),O.disabled=!0;const v=ye();if(!v){alert("Erreur : utilisateur non connecté."),O.disabled=!1;return}const j=W.filter(V=>V&&V.name&&V.quantity),H={name:D.value,ingredients:j,userId:v};if(!H.name){alert("Le nom de la liste est requis."),O.disabled=!1;return}const K=b.value;try{K?await ot(P(f,"shopping_lists",K),H):await Le(F(f,"shopping_lists"),H),G(),await A()}catch(V){console.error("Erreur de sauvegarde de la liste: ",V)}finally{O.disabled=!1}}function ee(_={quantity:"",name:"",unit:""}){const v=document.createElement("div");v.className="relative flex items-stretch space-x-2 ingredient-row";const j={..._};W.push(j);const H=W.length-1,K=document.createElement("input");K.type="text",K.className="ingredient-quantity mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm",K.placeholder="Qté",K.value=j.quantity,K.addEventListener("change",pe=>{W[H].quantity=pe.target.value});const V=document.createElement("input");V.type="text",V.className="ingredient-unit mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm bg-gray-100",V.placeholder="Unité",V.readOnly=!0,V.value=j.unit||"";const se=document.createElement("div");se.className="relative w-1/2";const U=document.createElement("input");U.type="text",U.className="ingredient-name mt-1 block w-full rounded-md border-gray-300 shadow-sm",U.placeholder="Chercher un ingrédient...",U.value=j.name,se.appendChild(U);const Y=document.createElement("div");Y.className="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto",se.appendChild(Y),U.addEventListener("input",()=>{const pe=U.value.toLowerCase();if(!pe){Y.classList.add("hidden");return}const M=X.filter(x=>x.name.toLowerCase().includes(pe));Y.innerHTML="",M.forEach(x=>{const C=document.createElement("div");C.className="p-2 hover:bg-tomato hover:text-white cursor-pointer",C.textContent=x.name,C.addEventListener("click",()=>{U.value=x.name,V.value=x.unit,Y.classList.add("hidden"),W[H].name=x.name,W[H].unit=x.unit,W[H].id=x.id}),Y.appendChild(C)});const B=document.createElement("div");B.className="p-2 bg-blue-50 hover:bg-blue-200 cursor-pointer font-bold text-blue-700",B.textContent=`+ Créer "${U.value}"`,B.addEventListener("click",async()=>{const x=U.value,C="pièce(s)";try{const N=await Le(F(f,"ingredients"),{name:x,unit:C,category:"Inconnue"});await $(),U.value=x,V.value=C,Y.classList.add("hidden"),W[H].name=x,W[H].unit=C,W[H].id=N.id}catch(N){console.error("Erreur d'ajout d'ingrédient",N),alert("L'ingrédient n'a pas pu être créé.")}}),Y.appendChild(B),Y.classList.remove("hidden")});const ne=document.createElement("button");ne.type="button",ne.className="btn btn-ghost text-red-500 hover:bg-red-50 btn-sm mt-1",ne.innerHTML='<i class="fas fa-trash"></i>',ne.addEventListener("click",()=>{v.remove(),W[H]=null}),v.appendChild(se),v.appendChild(K),v.appendChild(V),v.appendChild(ne),k.appendChild(v)}function oe(){t.innerHTML="";let _=E;if(z){const v=z.toLowerCase();_=E.filter(j=>j.name.toLowerCase().includes(v))}if(_.length===0){t.innerHTML='<p class="text-center text-gray-500 p-10 col-span-full">Aucune liste de courses trouvée.</p>';return}_.sort((v,j)=>v.name.localeCompare(j.name)),_.forEach(v=>{const j=document.createElement("div");j.className="bg-white rounded-lg shadow-md p-4 flex flex-col";const H=document.createElement("div");H.className="flex justify-between items-start border-b pb-2 mb-2";const K=document.createElement("h4");K.className="text-lg font-bold text-gray-800",K.textContent=v.name,H.appendChild(K);const V=document.createElement("div");V.className="flex space-x-2";const se=document.createElement("button");se.className="btn btn-ghost btn-sm text-blue-500",se.innerHTML='<i class="fas fa-edit"></i>',se.addEventListener("click",()=>q(v)),V.appendChild(se);const U=document.createElement("button");U.className="btn btn-ghost btn-sm text-green-500",U.innerHTML='<i class="fas fa-share-alt"></i>',U.addEventListener("click",()=>St({})),V.appendChild(U);const Y=document.createElement("button");Y.className="btn btn-ghost btn-sm text-red-500",Y.innerHTML='<i class="fas fa-trash"></i>',Y.addEventListener("click",()=>fe(v.id,v.name)),V.appendChild(Y),H.appendChild(V);const ne=document.createElement("ul");ne.className="space-y-1 text-sm text-gray-600 flex-grow",v.ingredients&&v.ingredients.length>0?v.ingredients.forEach(pe=>{const M=document.createElement("li");M.textContent=`${pe.quantity} ${pe.unit||""} - ${pe.name}`.trim(),ne.appendChild(M)}):ne.innerHTML='<li class="italic text-gray-400">Cette liste est vide.</li>',j.appendChild(H),j.appendChild(ne),t.appendChild(j)})}function te(_){if(r.innerHTML="",_.length===0){r.innerHTML='<p class="text-center text-gray-500 p-10 col-span-full">Aucune liste de courses partagée trouvée.</p>';return}_.sort((v,j)=>v.name.localeCompare(j.name)),_.forEach(v=>{const j=document.createElement("div");j.className="bg-white rounded-lg shadow-md p-4 flex flex-col";const H=document.createElement("div");H.className="flex justify-between items-start border-b pb-2 mb-2";const K=document.createElement("h4");K.className="text-lg font-bold text-gray-800",K.textContent=v.name,H.appendChild(K);const V=document.createElement("div");V.className="flex space-x-2";const se=document.createElement("button");se.className="btn btn-secondary btn-sm",se.innerHTML='<i class="fas fa-copy mr-2"></i> Copier dans mes listes',se.title="Copier cette liste dans vos listes personnelles",se.addEventListener("click",()=>Ee(v.id)),V.appendChild(se);const U=document.createElement("button");U.className="btn btn-ghost btn-sm text-red-500",U.innerHTML='<i class="fas fa-trash"></i>',U.title="Supprimer cette liste partagée",U.addEventListener("click",()=>De(v.id,v.name)),V.appendChild(U),H.appendChild(V);const Y=document.createElement("ul");Y.className="space-y-1 text-sm text-gray-600 flex-grow",v.ingredients&&v.ingredients.length>0?v.ingredients.forEach(ne=>{const pe=document.createElement("li");pe.textContent=`${ne.quantity} ${ne.unit||""} - ${ne.name}`.trim(),Y.appendChild(pe)}):Y.innerHTML='<li class="italic text-gray-400">Cette liste est vide.</li>',j.appendChild(H),j.appendChild(Y),r.appendChild(j)})}async function fe(_,v){if(confirm(`Êtes-vous sûr de vouloir supprimer la liste "${v}" ?`))try{await je(P(f,"shopping_lists",_)),await A()}catch(j){console.error("Erreur de suppression de la liste: ",j)}}async function De(_,v){if(confirm(`Êtes-vous sûr de vouloir supprimer la liste partagée "${v}" ?`))try{await je(P(f,"shopping_lists",_)),await S()}catch(j){console.error("Erreur de suppression de la liste partagée: ",j),alert("Une erreur est survenue.")}}async function Ee(_){if(confirm("Voulez-vous vraiment copier cette liste dans vos listes personnelles ? Elle ne sera plus considérée comme une liste partagée."))try{const v=P(f,"shopping_lists",_);await Ne(v,{isShared:!1}),await xe()}catch(v){console.error("Erreur lors de la copie de la liste: ",v),alert("Une erreur est survenue.")}}e.addEventListener("input",_=>{z=_.target.value,oe()}),n.addEventListener("click",()=>q()),m.addEventListener("click",G),c.addEventListener("click",G),g.addEventListener("submit",me),L.addEventListener("click",()=>ee()),f&&xe()}const xn=Object.freeze(Object.defineProperty({__proto__:null,default:vn},Symbol.toStringTag,{value:"Module"}));let Ht=[],Ft=[],Ut=()=>{},zt=()=>{};const ie={btn:null,badge:null,dropdown:null,list:null};async function En(e,t,n){const r=ye();if(r)try{const o=P(f,"shares",e);if(await Ne(o,{status:"accepted"}),t.plan){const l=n.displayName||"Inconnu",m=`Copie de "${t.plan.name}" (de ${l})`,c={...t.plan,userId:r,name:m,isShared:!0,originalOwnerId:t.senderId,sharedAt:new Date,collaborators:[]};delete c.id,await Le(F(f,"plans"),c)}t.shoppingList&&await Le(F(f,"shopping_lists"),{name:`${t.shoppingList.name} (de ${n.displayName})`,ingredients:t.shoppingList.ingredients,userId:r,isShared:!0,originalOwner:n.uid,sharedAt:new Date})}catch(o){console.error("Erreur lors de l'acceptation du partage : ",o),alert("Une erreur est survenue.")}}async function Cn(e){try{const t=P(f,"shares",e);await Ne(t,{status:"accepted"})}catch(t){console.error("Erreur lors de l'acceptation de l'invitation : ",t),alert("Une erreur est survenue.")}}async function Dt(e){try{const t=P(f,"shares",e);await Ne(t,{status:"declined"})}catch(t){console.error("Erreur lors du refus du partage : ",t),alert("Une erreur est survenue.")}}async function wn(e,t){try{await At(e,t)}catch{alert("Erreur lors de l'acceptation.")}}async function Ln(e){try{await qt(e)}catch{alert("Erreur lors du refus.")}}function Ot(){if(!ie.list)return;const e=[...Ht,...Ft];e.sort((t,n)=>n.createdAt.toMillis()-t.createdAt.toMillis()),e.length>0?(ie.badge.textContent=e.length,ie.badge.classList.remove("hidden")):ie.badge.classList.add("hidden"),ie.list.innerHTML="",e.length===0?ie.list.innerHTML='<p class="text-gray-500 text-center p-4">Aucune nouvelle notification.</p>':e.forEach(t=>{const n=In(t);ie.list.appendChild(n)})}function In(e){const t=document.createElement("div");t.className="p-3 border-b border-gray-100 hover:bg-gray-50";const n=document.createElement("p");n.className="text-sm font-medium text-gray-800";const r=document.createElement("p");r.className="text-xs text-gray-500 mb-3";const o=document.createElement("div");if(o.className="flex space-x-2 justify-end",e.data.type==="collaborative_plan_invite"){n.textContent="Invitation à collaborer",r.textContent=`${e.sender.displayName} vous invite à modifier son plan "${e.data.planName}".`;const l=Ge("Accepter","btn-secondary",c=>{c.target.textContent="...",c.target.disabled=!0,Cn(e.id)}),m=Ge("Refuser","btn-ghost text-red-500",c=>{c.target.disabled=!0,Dt(e.id)});o.append(l,m)}else if(e.type==="share"){n.textContent=`Partage de ${e.sender.displayName||e.sender.email}`;let l=[];e.data.plan&&l.push("planification"),e.data.shoppingList&&l.push("liste de courses"),r.textContent=`Contenu : ${l.join(" et ")}`;const m=Ge("Accepter","btn-secondary",g=>{g.target.textContent="...",g.target.disabled=!0,En(e.id,e.data,e.sender)}),c=Ge("Refuser","btn-ghost text-red-500",g=>{g.target.disabled=!0,Dt(e.id)});o.append(m,c)}else if(e.type==="friend_request"){n.textContent="Invitation d'ami",r.textContent=`${e.sender.displayName||e.sender.email} vous a envoyé une invitation.`;const l=Ge("Accepter","btn-secondary",c=>{c.target.textContent="...",c.target.disabled=!0,wn(e.id,e.data.senderId)}),m=Ge("Refuser","btn-ghost text-red-500",c=>{c.target.disabled=!0,Ln(e.id)});o.append(l,m)}return t.append(n,r,o),t}function Ge(e,t,n){const r=document.createElement("button");return r.className=`btn btn-xs ${t}`,r.textContent=e,r.addEventListener("click",o=>{o.stopPropagation(),n(o)}),r}function Bn(e){const t=F(f,"shares"),n=ge(t,ae("receiverId","==",e),ae("status","==","pending"));Ut=Je(n,async r=>{const o=[];for(const l of r.docs){const m=l.data(),c=await Ie(P(f,"users",m.senderId));c.exists()&&o.push({type:"share",id:l.id,data:m,sender:c.data(),createdAt:m.createdAt})}Ht=o,Ot()},r=>{console.error("Erreur d'écoute des partages:",r)})}function Sn(e){const t=F(f,"friend_requests"),n=ge(t,ae("receiverId","==",e),ae("status","==","pending"));zt=Je(n,async r=>{const o=[];for(const l of r.docs){const m=l.data(),c=await Ie(P(f,"users",m.senderId));c.exists()&&o.push({type:"friend_request",id:l.id,data:m,sender:c.data(),createdAt:m.createdAt})}Ft=o,Ot()},r=>{console.error("Erreur d'écoute des invitations d'amis:",r)})}function Vt(){if(ie.btn=document.getElementById("notifications-btn"),ie.badge=document.getElementById("notifications-badge"),ie.dropdown=document.getElementById("notifications-dropdown"),ie.list=document.getElementById("notifications-list"),!ie.btn)return;const e=ye();e&&(Ut(),zt(),Bn(e),Sn(e),ie.btn.addEventListener("click",t=>{t.stopPropagation(),ie.dropdown.classList.toggle("hidden")}),document.addEventListener("click",t=>{ie.dropdown&&!ie.dropdown.classList.contains("hidden")&&!ie.btn.contains(t.target)&&!ie.dropdown.contains(t.target)&&ie.dropdown.classList.add("hidden")}))}const Mn=Object.freeze(Object.defineProperty({__proto__:null,initNotifications:Vt},Symbol.toStringTag,{value:"Module"})),Ue=nn();let at,mt,pt,tt,Z,st,ft,gt,nt,Fe,rt,ht,bt,xt,Et,ct=null,ut=null;function Nn(){at&&at.classList.remove("hidden")}function Ct(){at&&at.classList.add("hidden"),tt&&tt.reset()}function kn(e,t){ut=e,Fe&&(Fe.value=t),st&&st.classList.remove("hidden"),Fe&&Fe.focus()}function wt(){ut=null,st&&st.classList.add("hidden"),nt&&nt.reset()}function Tn(e,t){ct=e,xt&&(xt.textContent="Confirmer la suppression"),Et&&(Et.textContent=`Êtes-vous sûr de vouloir supprimer le plan "${t}" ? Cette action est irréversible.`),rt&&rt.classList.remove("hidden")}function _t(){ct=null,rt&&rt.classList.add("hidden")}async function Dn(e){const t=Be();if(t)try{await Le(F(Ue,"plans"),{userId:t.uid,name:e,type:"personal",weeks:{},manualItems:[],defaultNumPeople:1,startDay:"Lundi",lastUpdated:new Date}),Ct()}catch(n){console.error("Error creating plan: ",n),alert("Erreur lors de la création du plan.")}}async function _n(e,t){if(!(!e||!t))try{const n=P(Ue,"plans",e);await Ne(n,{name:t}),wt()}catch(n){console.error("Error renaming plan: ",n),alert("Erreur lors du renommage du plan.")}}async function Pn(e){const t=Be()?.uid;if(!(!e||!t)&&confirm("Voulez-vous vraiment quitter ce plan partagé ? Il n'apparaîtra plus dans votre liste."))try{const n=P(Ue,"plans",e);await Ne(n,{collaborators:yt(t)})}catch(n){console.error("Erreur pour quitter le plan: ",n),alert("Une erreur est survenue.")}}async function Rn(e){if(e)try{await je(P(Ue,"plans",e))}catch(t){console.error("Error deleting plan: ",t),alert("Erreur lors de la suppression du plan.")}}function Qt(e){const t=Be();if(!t)return()=>{};let n=new Map;const r=()=>{e(Array.from(n.values()).sort((b,D)=>b.name.localeCompare(D.name)))},o=async b=>{const k=[b.userId,...b.collaborators||[]].map(O=>Ie(P(Ue,"users",O)));return(await Promise.all(k)).map(O=>O.exists()?O.data():{uid:O.id,displayName:"Inconnu"})},l=ge(F(Ue,"plans"),ae("userId","==",t.uid)),m=Je(l,async b=>{const k=b.docChanges().map(async L=>{if(L.type==="removed")n.delete(L.doc.id);else{const O=L.doc.data(),E=await o(O);n.set(L.doc.id,{id:L.doc.id,...O,isOwner:!0,participants:E})}});await Promise.all(k),r()}),c=ge(F(Ue,"plans"),ae("collaborators","array-contains",t.uid)),g=Je(c,async b=>{const k=b.docChanges().map(async L=>{if(L.type==="removed")n.delete(L.doc.id);else{const O=L.doc.data(),E=await o(O),z=E.find(X=>X.uid===O.userId);n.set(L.doc.id,{id:L.doc.id,...O,isOwner:!1,ownerName:z?.displayName||"Inconnu",participants:E})}});await Promise.all(k),r()});return()=>{m(),g()}}function Gt(e){if(!Z)return;const t=Z.value;if(Z.innerHTML="",e.length===0){const n=document.createElement("option");n.value="",n.textContent="Aucun plan personnel",n.disabled=!0,Z.appendChild(n);return}e.forEach(n=>{const r=document.createElement("option");r.value=n.id;let o=n.name;n.collaborators&&n.collaborators.length>0&&(n.isOwner?o=`👑 ${n.name} [Collab]`:o=`👥 ${n.name} [Collab] (de ${n.ownerName})`),r.textContent=o,Z.appendChild(r)}),t&&Z.querySelector(`option[value="${t}"]`)?Z.value=t:Z.selectedIndex=0}function Wt(){at=document.getElementById("create-plan-modal"),mt=document.getElementById("close-create-plan-modal"),pt=document.getElementById("cancel-create-plan-btn"),tt=document.getElementById("create-plan-form"),Z=document.getElementById("plan-select"),st=document.getElementById("rename-plan-modal"),ft=document.getElementById("close-rename-plan-modal"),gt=document.getElementById("cancel-rename-plan-btn"),nt=document.getElementById("rename-plan-form"),Fe=document.getElementById("new-plan-name"),rt=document.getElementById("delete-confirm-modal"),ht=document.getElementById("cancel-delete-btn"),bt=document.getElementById("confirm-delete-btn"),xt=document.getElementById("delete-confirm-title"),Et=document.getElementById("delete-confirm-message");const e=document.getElementById("create-plan-btn"),t=document.getElementById("rename-plan-btn"),n=document.getElementById("leave-plan-btn"),r=document.getElementById("delete-plan-btn");e&&e.addEventListener("click",Nn),t&&t.addEventListener("click",()=>{if(Z&&Z.value){const o=Z.options[Z.selectedIndex];kn(Z.value,o.text)}else alert("Veuillez sélectionner un plan à renommer.")}),n&&n.addEventListener("click",()=>{Z&&Z.value?Pn(Z.value):alert("Veuillez sélectionner un plan.")}),r&&r.addEventListener("click",()=>{if(Z&&Z.value){const o=Z.options[Z.selectedIndex].text;Tn(Z.value,o)}else alert("Veuillez sélectionner un plan à supprimer.")}),mt&&mt.addEventListener("click",Ct),pt&&pt.addEventListener("click",Ct),tt&&tt.addEventListener("submit",o=>{o.preventDefault();const l=document.getElementById("plan-name");l&&l.value&&Dn(l.value)}),ft&&ft.addEventListener("click",wt),gt&&gt.addEventListener("click",wt),nt&&nt.addEventListener("submit",o=>{o.preventDefault(),ut&&Fe.value&&_n(ut,Fe.value)}),ht&&ht.addEventListener("click",_t),bt&&bt.addEventListener("click",()=>{ct&&Rn(ct).then(()=>{_t()})})}const jn=Object.freeze(Object.defineProperty({__proto__:null,getUserPlans:Qt,initPlanManagement:Wt,populatePlanSelector:Gt},Symbol.toStringTag,{value:"Module"}));let We=null;function $n(){const e=document.getElementById("search-bar"),t=document.getElementById("category-tabs"),n=document.getElementById("recipe-list-container"),r=document.getElementById("add-recipe-btn");We&&We.destroy(),We=new It(f,"recipe-form-modal","recipe-form","recipe-modal-title","recipe-id","recipe-name","recipe-category","recipe-servings","recipe-prep-time","recipe-difficulty","recipe-steps","ingredients-list","add-ingredient-btn","save-recipe-btn","close-recipe-modal","cancel-recipe-btn"),We.setOnSaveCallback(O);let o=[],l="",m="",c=null;const g=["Entrée","Plat","Accompagnement","Dessert"],b={PLAT:"bg-orange-100",DESSERT:"bg-amber-100",ENTREE:"bg-lime-100",ACCOMPAGNEMENT:"bg-stone-200","PETIT-DEJEUNER":"bg-orange-100",BOISSON:"bg-cyan-100",SAUCE:"bg-red-100"},D={PLAT:"text-orange-800",DESSERT:"text-amber-800",ENTREE:"text-lime-800",ACCOMPAGNEMENT:"text-stone-800","PETIT-DEJEUNER":"text-orange-800",BOISSON:"text-cyan-800",SAUCE:"text-red-800"},k="bg-gray-100",L="text-gray-800";async function O(){if(console.log("fetchAllRecipes called."),!!f)try{o=(await ue(F(f,"recipes"))).docs.map(A=>({id:A.id,...A.data()})),console.log("Fetched recipes:",o),z(),X()}catch($){console.error("Erreur lors de la récupération des recettes: ",$)}}function E($){l=$,z(),X()}function z(){if(!t)return;t.innerHTML="";const A=[...new Set(o.map(S=>S.category||"Non classé"))].sort((S,q)=>{const G=oe=>{const te=oe.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();for(let fe=0;fe<g.length;fe++)if(g[fe].normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()===te)return fe;return-1},me=G(S),ee=G(q);return me>-1&&ee>-1?me-ee:me>-1?-1:ee>-1?1:S.localeCompare(q)});!l&&A.length>0&&(l=A[0]),A.forEach(S=>{const q=document.createElement("button"),G=S.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toUpperCase();if(S===l){const ee=b[G]||k,oe=D[G]||L;q.className=`px-4 py-2 text-sm font-bold rounded-t-lg ${ee} ${oe}`}else q.className="px-4 py-2 text-sm font-medium text-gray-500 hover:text-tomato";q.textContent=S,q.addEventListener("click",()=>E(S)),t.appendChild(q)})}function X(){if(!n)return;n.innerHTML="";let $=o.filter(S=>(S.category||"Non classé")===l);if(m){const S=m.toLowerCase();$=$.filter(q=>q.name.toLowerCase().includes(S))}if($.sort((S,q)=>S.name.localeCompare(q.name)),$.length===0){n.innerHTML='<p class="text-gray-500 text-center p-10">Aucune recette trouvée.</p>';return}const A=document.createElement("div");A.className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4",$.forEach(S=>{A.appendChild(W(S))}),n.appendChild(A)}function W($){let A=k;if($.category){const fe=$.category.normalize("NFD").replace(/[̀-ͯ]/g,"").toUpperCase();A=b[fe]||k}const S=document.createElement("div");S.className=`rounded-lg shadow-sm flex flex-col p-2 ${A}`;const q=document.createElement("h4");q.className="text-sm font-bold text-gray-800 truncate",q.textContent=$.name,q.title=$.name,S.appendChild(q);const G=document.createElement("p");G.className="text-xs text-gray-600 mt-1",G.textContent=`${$.difficulty||""} - Pour ${$.servings||"?"} pers.`,S.appendChild(G);const me=document.createElement("div");me.className="flex-grow",S.appendChild(me);const ee=document.createElement("div");ee.className="flex justify-end space-x-2 mt-2";const oe=document.createElement("button");oe.className="btn btn-outline btn-xs border-gray-400 hover:bg-gray-200",oe.innerHTML='<i class="fas fa-edit"></i>',oe.title="Modifier",oe.addEventListener("click",()=>We.openForm($,"Modifier la recette")),ee.appendChild(oe);const te=document.createElement("button");return te.className="btn btn-ghost text-red-700 hover:bg-red-100 btn-xs",te.innerHTML='<i class="fas fa-trash-alt"></i>',te.title="Supprimer",te.addEventListener("click",()=>xe($.id,$.name)),ee.appendChild(te),S.appendChild(ee),S}async function xe($,A){if(confirm(`Êtes-vous sûr de vouloir supprimer la recette "${A}" ?`))try{await je(P(f,"recipes",$)),O()}catch(S){console.error("Erreur lors de la suppression: ",S)}}r.addEventListener("click",()=>We.openForm(null,"Ajouter une recette")),e.addEventListener("input",$=>{const A=$.target.value;if(!m&&A&&(c=l),m=A,m){const S=m.toLowerCase(),q=o.find(G=>G.name.toLowerCase().includes(S));q&&(l=q.category||"Non classé")}else c&&(l=c,c=null);z(),X()}),f&&O()}const An=Object.freeze(Object.defineProperty({__proto__:null,default:$n},Symbol.toStringTag,{value:"Module"}));let He=null;function qn(){const e={mealPlanGrid:document.getElementById("meal-plan-grid"),currentWeekDisplay:document.getElementById("current-week-display"),prevWeekBtn:document.getElementById("prev-week-btn"),nextWeekBtn:document.getElementById("next-week-btn"),clearMenuBtn:document.getElementById("clear-menu-btn"),shoppingListContainer:document.getElementById("shopping-list"),startDaySelect:document.getElementById("start-day-select"),defaultServingsControl:document.getElementById("default-servings-control"),mealSelectModal:document.getElementById("meal-select-modal"),closeMealSelectModalBtn:document.getElementById("close-meal-select-modal"),mealSelectModalTitle:document.getElementById("meal-select-modal-title"),mealSelectList:document.getElementById("meal-select-list"),recipeFormModal:document.getElementById("edit-recipe-form-modal"),closeRecipeModalBtn:document.getElementById("close-edit-recipe-modal"),cancelRecipeBtn:document.getElementById("edit-cancel-recipe-btn"),recipeForm:document.getElementById("edit-recipe-form"),addItemInput:document.getElementById("add-item-input"),addItemBtn:document.getElementById("add-item-btn"),addItemResults:document.getElementById("add-item-results"),importListBtn:document.getElementById("import-list-btn"),importListModal:document.getElementById("import-list-modal"),closeImportListModalBtn:document.getElementById("close-import-list-modal"),importListContainer:document.getElementById("import-list-container"),exportTxtBtn:document.getElementById("export-txt-btn"),exportPdfBtn:document.getElementById("export-pdf-btn"),sharePlanBtn:document.getElementById("share-plan-btn"),planSelect:document.getElementById("plan-select")};function t(a,s){const u=document.createElement("div");u.className="flex items-center space-x-2";const d=document.createElement("button");d.className="btn btn-outline btn-xs",d.textContent="-";const i=document.createElement("span");i.className="font-medium text-center w-6",i.textContent=a;const p=document.createElement("button");return p.className="btn btn-outline btn-xs",p.textContent="+",d.addEventListener("click",()=>{let y=parseInt(i.textContent,10);y>1&&(y--,i.textContent=y,s(y))}),p.addEventListener("click",()=>{let y=parseInt(i.textContent,10);y++,i.textContent=y,s(y)}),u.appendChild(d),u.appendChild(i),u.appendChild(p),u}function n(a,s,u,d=!1){const i=document.createElement("div");i.className="flex flex-col items-center justify-center h-full";const p=document.createElement("button");p.className="btn btn-ghost btn-xs p-0 h-4 flex items-center justify-center w-full",p.innerHTML='<i class="fas fa-plus"></i>',p.disabled=d;const y=document.createElement("span");y.className="font-medium text-center text-sm my-1",y.textContent=a;const h=document.createElement("button");return h.className="btn btn-ghost btn-xs p-0 h-4 flex items-center justify-center w-full",h.innerHTML='<i class="fas fa-minus"></i>',h.disabled=d,s&&(p.classList.add("text-white"),y.classList.add("text-white"),h.classList.add("text-white")),d||(p.addEventListener("click",()=>{let I=parseInt(y.textContent,10);I++,y.textContent=I,u(I)}),h.addEventListener("click",()=>{let I=parseInt(y.textContent,10);I>1&&(I--,y.textContent=I,u(I))})),i.appendChild(p),i.appendChild(y),i.appendChild(h),i}He&&He.destroy(),He=new It(f,"edit-recipe-form-modal","edit-recipe-form","edit-recipe-modal-title","edit-recipe-id","edit-recipe-name","edit-recipe-category","edit-recipe-servings","edit-recipe-prep-time","edit-recipe-difficulty","edit-recipe-steps","edit-ingredients-list","edit-add-ingredient-btn","edit-save-recipe-btn","close-edit-recipe-modal","edit-cancel-recipe-btn"),He.setOnSaveCallback(async()=>{await xe();for(const a in l){const s=l[a];if(Array.isArray(s)){const u=s.map(d=>{if(d&&d.id){const i=D.find(p=>p.id===d.id);return i?{...i}:d}return d});l[a]=u}}A(e.mealPlanGrid,{menuData:l,servingsData:m,remarksData:c,defaultNumPeople:L,startDay:o},!1),await Ee()});let r=1,o="Lundi",l={},m={},c={};const g=[];let b=null,D=[],k=[],L=1,O=[],E=null;function z(a){return a?a.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase():""}async function X(a){const s=document.getElementById("unit-select-modal"),u=document.getElementById("unit-modal-title"),d=document.getElementById("unit-modal-list"),i=document.getElementById("unit-modal-cancel");return u.textContent=`Choisir une unité pour "${a}"`,d.innerHTML="",new Promise((p,y)=>{const h=["g","kg","ml","l","pièce(s)","c.à.s.","c.à.c.","pincée(s)"],I=w=>{s.classList.add("hidden"),p(w)};h.forEach(w=>{const T=document.createElement("button");T.className="btn btn-outline",T.textContent=w,T.addEventListener("click",()=>I(w)),d.appendChild(T)});const R=()=>{s.classList.add("hidden"),y()};i.addEventListener("click",R,{once:!0}),s.addEventListener("click",w=>{w.target===s&&R()},{once:!0}),s.classList.remove("hidden")})}async function W(){if(f)try{k=(await ue(F(f,"ingredients"))).docs.map(s=>({id:s.id,...s.data()})),k.sort((s,u)=>s.name.localeCompare(u.name))}catch(a){console.error("Erreur lors de la récupération des ingrédients: ",a)}}async function xe(){if(!f)return;const a=F(f,"recipes");try{D=(await ue(a)).docs.map(u=>({id:u.id,...u.data()}))}catch(s){console.error("Error loading available meals from Firebase:",s)}}function $(){if(!E)l={},m={},c={},L=1,o="Lundi";else{const a=E.weeks?E.weeks[r]||{}:{};l=a.menuData||{},m=a.servingsData||{},c=a.remarksData||{},L=E.defaultNumPeople||1,o=E.startDay||"Lundi"}if(e.startDaySelect&&(e.startDaySelect.value=o),e.defaultServingsControl){e.defaultServingsControl.innerHTML="";const a=t(L,async s=>{if(L=s,E){const u=P(f,"plans",E.id);await Ne(u,{defaultNumPeople:s,lastUpdated:new Date})}});e.defaultServingsControl.appendChild(a)}$e(),A(e.mealPlanGrid,{menuData:l,servingsData:m,remarksData:c,defaultNumPeople:L,startDay:o},!1),Ee()}function A(a,s,u=!1){if(!a)return;const d=s.menuData||{},i=s.servingsData||{},p=s.remarksData||{},y=s.defaultNumPeople||1,h=s.startDay||"Lundi",I=document.createDocumentFragment(),R=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"],w=["lunch","dinner"],T=5,J=R.indexOf(h);[...R.slice(J),...R.slice(0,J)].forEach(Ce=>{const he=R.indexOf(Ce),ve=document.createElement("div");ve.className="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] items-stretch border-b border-gray-300";const we=document.createElement("div");we.className="font-bold p-2 flex items-center justify-center bg-gray-100 text-sm border-r border-gray-300",we.textContent=Ce.toUpperCase(),ve.appendChild(we),w.forEach(Se=>{const le=`${he}-${Se}`,Ve=i[le]||y,be=i.hasOwnProperty(le),de=document.createElement("div"),_e=n(Ve,be,Pe=>{Xt(le,Pe)},u);let Ke="border-r border-gray-300 flex items-center justify-center transition-colors duration-300";be?Ke+=" bg-tomato":Ke+=Se==="lunch"?" bg-amber-50":" bg-stone-100",de.className=Ke,de.appendChild(_e),ve.appendChild(de);for(let Pe=0;Pe<T;Pe++){const ke=`${he}-${Se}-${Pe}`,Qe=d[ke],Re=document.createElement("div"),Ye=U(ke);let Ze="meal-slot p-1 min-h-[70px] flex flex-col justify-start border-r border-gray-300";if(Ze+=Se==="lunch"?" bg-amber-50":" bg-stone-100",Re.className=Ze,Re.dataset.slotId=ke,Ye==="Remarque")Re.appendChild(M(ke,p,u));else if(Array.isArray(Qe)&&Qe.length>0){const qe=document.createElement("div");qe.className="w-full",Qe.forEach((et,Me)=>{qe.appendChild(Y(et,ke,Me,u))}),Re.appendChild(qe),u||Re.appendChild(pe(ke,!0))}else u||Re.appendChild(pe(ke,!1));ve.appendChild(Re)}}),I.appendChild(ve)}),a.innerHTML="",a.appendChild(I),u||B()}async function S(){const a=ye();if(!f||!a)return[];try{const s=ge(F(f,"shopping_lists"),ae("userId","==",a));return(await ue(s)).docs.map(p=>({id:p.id,...p.data()})).filter(p=>p.isShared!==!0)}catch(s){return console.error("Erreur de chargement des listes de courses sauvegardées: ",s),[]}}async function q(){const a=await S();if(e.importListContainer.innerHTML="",a.length===0){e.importListContainer.innerHTML='<p class="text-center text-gray-500">Aucune liste sauvegardée.</p>';return}a.forEach(s=>{const u=document.createElement("button");u.className="w-full text-left p-2 hover:bg-gray-100 rounded-lg transition-colors duration-150",u.textContent=s.name,u.addEventListener("click",()=>{confirm(`Voulez-vous vraiment importer les ingrédients de la liste "${s.name}" ?`)&&(s.ingredients.forEach(d=>{const i=parseFloat(String(d.quantity).replace(",","."))||0;te(d.name,i,d.unit)}),G())}),e.importListContainer.appendChild(u)}),e.importListModal.classList.remove("hidden")}function G(){e.importListModal.classList.add("hidden")}function me(){e.addItemInput?.addEventListener("input",()=>{const a=e.addItemInput.value.toLowerCase(),s=e.addItemResults;if(s.innerHTML="",!a){s.classList.add("hidden");return}k.filter(i=>i.name.toLowerCase().includes(a)).forEach(i=>{const p=document.createElement("div");p.className="p-2 hover:bg-gray-100 cursor-pointer",p.textContent=i.name,p.addEventListener("click",()=>{te(i.name,1,i.unit),e.addItemInput.value="",s.classList.add("hidden")}),s.appendChild(p)});const d=document.createElement("div");d.className="p-2 bg-green-50 hover:bg-green-200 cursor-pointer font-bold text-green-700",d.textContent=`+ Créer "${e.addItemInput.value}"`,d.addEventListener("click",async()=>{const i=e.addItemInput.value;try{const p=await X(i);await Le(F(f,"ingredients"),{name:i,unit:p}),await W(),te(i,1,p),e.addItemInput.value="",s.classList.add("hidden")}catch{}}),s.appendChild(d),s.classList.remove("hidden")}),e.addItemBtn?.addEventListener("click",()=>{const a=e.addItemInput.value;a&&(te(a,1,""),e.addItemInput.value="",e.addItemResults.classList.add("hidden"))}),document.addEventListener("click",a=>{e.addItemInput&&!e.addItemInput.contains(a.target)&&!e.addItemResults.contains(a.target)&&e.addItemResults.classList.add("hidden")})}function ee(){if(g.length===0){alert("La liste de courses est vide.");return}const a=g.reduce((i,p)=>{const y=p.category||"Inconnue";return i[y]||(i[y]=[]),i[y].push(p),i},{}),s=Object.keys(a).sort((i,p)=>i==="Inconnue"?1:p==="Inconnue"?-1:i.localeCompare(p));let u=`Liste de courses - GustoPlan

`;s.forEach(i=>{u+=`--- ${i.toUpperCase()} ---
`,a[i].sort((y,h)=>y.name.localeCompare(h.name)).forEach(y=>{let I=`${Number.isInteger(y.totalQuantity)?y.totalQuantity:parseFloat(y.totalQuantity.toFixed(2))} ${y.unit||""} ${y.name}`;if(y.sources&&y.sources.length>0){const R=y.sources.reduce((T,J)=>{const re=`${J.recipeName} (${J.day} ${J.time})`;return T[re]||(T[re]=0),T[re]+=J.quantity,T},{}),w=Object.keys(R).join(" / ");I+=` *** ${w} ***`}u+=I+`
`}),u+=`
`});const d=new Blob([u],{type:"text/plain;charset=utf-8"});saveAs(d,"liste-de-courses.txt")}function oe(){if(g.length===0){alert("La liste de courses est vide.");return}const{jsPDF:a}=window.jspdf,s=new a,u=g.reduce((I,R)=>{const w=R.category||"Inconnue";return I[w]||(I[w]=[]),I[w].push(R),I},{}),d=Object.keys(u).sort((I,R)=>I==="Inconnue"?1:R==="Inconnue"?-1:I.localeCompare(R));s.setFontSize(18),s.text("Liste de courses - GustoPlan",14,22);let i=35;const p=s.internal.pageSize.height,y=20,h=()=>{i>p-y&&(s.addPage(),i=20)};d.forEach(I=>{h(),s.setFontSize(14),s.setFont(void 0,"bold"),s.text(`--- ${I.toUpperCase()} ---`,14,i),i+=8,s.setFont(void 0,"normal"),u[I].sort((w,T)=>w.name.localeCompare(T.name)).forEach(w=>{h(),s.setFontSize(12);const T=Number.isInteger(w.totalQuantity)?w.totalQuantity:parseFloat(w.totalQuantity.toFixed(2));if(s.text(`${T} ${w.unit||""} ${w.name}`,14,i),i+=6,w.sources&&w.sources.length>0){const J=w.sources.reduce((re,Ce)=>{const he=`${Ce.recipeName} (${Ce.day} ${Ce.time})`;return re[he]||(re[he]=0),re[he]+=Ce.quantity,re},{});s.setFontSize(9),s.setTextColor(100);for(const re in J)h(),s.text(`  * ${re}`,18,i),i+=5;s.setTextColor(0)}i+=2}),i+=5}),s.save("liste-de-courses.pdf")}async function te(a,s,u,d=!1){if(!E)return alert("Veuillez sélectionner un plan.");const i=P(f,"plans",E.id);try{await an(f,async p=>{const y=await p.get(i);if(!y.exists())throw"Le plan n'existe plus.";const h=y.data().manualItems||[],I=`${a.trim().toLowerCase()}_${u||""}`,R=h.findIndex(T=>`${T.name.trim().toLowerCase()}_${T.unit||""}`===I);if(R>-1)h[R].totalQuantity+=s;else{const T=k.find(J=>J.name.toLowerCase()===a.trim().toLowerCase());h.push({name:a.trim(),totalQuantity:s,unit:u,source:"manual",category:T?T.category:"Inconnue"})}const w=h.filter(T=>T.totalQuantity!==0);p.update(i,{manualItems:w,lastUpdated:new Date})})}catch(p){console.error("Erreur transactionnelle lors de l'ajustement de l'ingrédient: ",p),alert("Une erreur de synchronisation est survenue. Veuillez réessayer.")}}function fe(a){const s=a?a.toLowerCase():"";return s.includes("g")||s.includes("ml")?10:1}function De(){const a=e.shoppingListContainer;if(!a)return;if(a.innerHTML="",g.length===0){a.innerHTML='<p class="text-center text-gray-500 italic py-4">Votre liste de courses est vide.</p>';return}const s=g.reduce((d,i)=>{const p=i.category||"Inconnue";return d[p]||(d[p]=[]),d[p].push(i),d},{});Object.keys(s).sort((d,i)=>d==="Inconnue"?1:i==="Inconnue"?-1:d.localeCompare(i)).forEach(d=>{const i=document.createElement("h4");i.className="text-sm font-bold text-stone-800 bg-stone-200 mt-4 mb-2 px-3 py-1 rounded-md",i.textContent=d,a.appendChild(i);const p=document.createElement("ul");p.className="space-y-2",s[d].sort((h,I)=>h.name.localeCompare(I.name)).forEach(h=>{const I=document.createElement("li");let R="p-2 rounded";I.className=R+(h.source==="manual"?" bg-lemon":" bg-gray-50");const w=document.createElement("div");w.className="flex justify-between items-center";const T=document.createElement("span");T.className="flex-grow text-sm font-medium",T.textContent=h.name,w.appendChild(T);const J=document.createElement("div");J.className="flex items-center space-x-2 mx-2";const re=document.createElement("span");re.className="font-medium w-20 text-center text-sm";const Ce=Number.isInteger(h.totalQuantity)?h.totalQuantity:parseFloat(h.totalQuantity.toFixed(2));re.textContent=`${Ce} ${h.unit||""}`.trim();const he=document.createElement("div");he.className="flex flex-col";const ve=document.createElement("button");ve.className="btn btn-outline btn-xs rounded-b-none",ve.textContent="+",ve.addEventListener("click",async()=>{const le=fe(h.unit);await te(h.name,le,h.unit)});const we=document.createElement("button");we.className="btn btn-outline btn-xs rounded-t-none -mt-px",we.textContent="-",we.addEventListener("click",async()=>{const le=fe(h.unit);await te(h.name,-le,h.unit)}),he.appendChild(ve),he.appendChild(we),J.appendChild(re),J.appendChild(he),w.appendChild(J);const Se=document.createElement("button");if(Se.className="delete-item-btn text-red-500 hover:text-red-700",Se.innerHTML='<i class="fas fa-trash-alt"></i>',Se.addEventListener("click",()=>{te(h.name,-h.totalQuantity,h.unit,!0)}),w.appendChild(Se),I.appendChild(w),h.sources&&h.sources.length>0){const le=document.createElement("div");le.className="p-2 mt-1 ml-4 rounded-md bg-stone-100";const Ve=h.sources.reduce((be,de)=>{const _e=`${de.recipeName} (${de.day} ${de.time})`;return be[_e]||(be[_e]=0),be[_e]+=de.quantity,be},{});for(const be in Ve){const de=document.createElement("span");de.className="block text-xs text-gray-500",de.textContent=`↳ ${be}`,le.appendChild(de)}I.appendChild(le)}p.appendChild(I)}),a.appendChild(p)})}async function Ee(){if(!E){g.length=0,De();return}const a=E.manualItems?JSON.parse(JSON.stringify(E.manualItems)):[],s=new Map(a.map(i=>[`${i.name.trim().toLowerCase()}_${i.unit||""}`,i])),u=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];if(E.weeks)for(const i in E.weeks){const p=E.weeks[i],y=p.menuData||{},h=p.servingsData||{};for(const I in y){const R=y[I];if(!Array.isArray(R))continue;const[w,T]=I.split("-"),J=parseInt(w,10),re=u[J]||"Jour inconnu",Ce=T==="lunch"?"midi":"soir",he=`${J}-${T}`,ve=parseInt(h[he]||E.defaultNumPeople,10);for(const we of R){const le=D.find(be=>be.id===we.id)||we;if(!le||!Array.isArray(le.ingredients))continue;const Ve=le.servings||1;Ve<=0||le.ingredients.forEach(be=>{const{name:de,quantity:_e,unit:Ke}=be;if(!de||!_e)return;const Pe=k.find(Me=>Me.name.toLowerCase()===de.trim().toLowerCase()),ke=Pe?Pe.category:"Inconnue",Qe=parseFloat(String(_e).replace(",","."));if(isNaN(Qe))return;const Ye=Qe/Ve*ve,Ze=Ke||"",qe=`${de.trim().toLowerCase()}_${Ze}`,et={recipeName:le.name,day:`${re} (S${i})`,time:Ce,quantity:Ye};if(s.has(qe)){const Me=s.get(qe);Me.totalQuantity+=Ye,Me.source==="manual"&&(Me.source="mixed"),Array.isArray(Me.sources)?Me.sources.push(et):Me.sources=[et]}else s.set(qe,{name:de.trim(),totalQuantity:Ye,unit:Ze,source:"plan",category:ke,sources:[et]})})}}}const d=Array.from(s.values()).filter(i=>i.totalQuantity>0);g.length=0,g.push(...d.sort((i,p)=>i.name.localeCompare(p.name))),De()}function _(a){const s=U(a);if(!s||!e.mealSelectModal)return;e.mealSelectModalTitle.textContent=`Sélectionner : ${s}`,e.mealSelectList.innerHTML="";const u=document.createElement("input");u.type="text",u.placeholder="Rechercher dans la catégorie...",u.className="w-full p-2 mb-4 border border-gray-300 rounded-lg",e.mealSelectList.appendChild(u);const d=z(s),i=D.filter(h=>z(h.category)===d).sort((h,I)=>h.name.localeCompare(I.name)),p=document.createElement("div");p.className="space-y-1 max-h-80 overflow-y-auto",e.mealSelectList.appendChild(p);function y(h=""){p.innerHTML="";const I=h.toLowerCase(),R=i.filter(w=>w.name.toLowerCase().includes(I));R.length===0?p.innerHTML='<p class="text-gray-500 p-4">Aucun plat ne correspond à votre recherche.</p>':R.forEach(w=>{const T=document.createElement("button");T.className="w-full text-left p-2 hover:bg-gray-100 rounded-lg transition-colors duration-150";const J=document.createElement("p");J.className="font-medium text-gray-800 text-sm",J.textContent=w.name,T.appendChild(J),T.addEventListener("click",()=>{x(a,w),v()}),p.appendChild(T)})}u.addEventListener("input",h=>y(h.target.value)),y(),e.mealSelectModal.classList.remove("hidden"),u.focus()}function v(){e.mealSelectModal&&e.mealSelectModal.classList.add("hidden")}function j(a){b=a.target.closest(".meal-card");const s=b.closest(".meal-slot").dataset.slotId;a.dataTransfer.setData("text/plain",s),setTimeout(()=>{b&&(b.style.opacity="0.5")},0)}function H(){b&&(b.style.opacity="1",b=null)}function K(a){a.preventDefault();const s=a.target.closest(".meal-slot");s&&U(s.dataset.slotId)!=="Remarque"&&s.classList.add("bg-gray-200")}function V(a){const s=a.target.closest(".meal-slot");s&&s.classList.remove("bg-gray-200")}async function se(a){a.preventDefault();const s=a.dataTransfer.getData("text/plain"),u=a.target.closest(".meal-slot");if(u){u.classList.remove("bg-gray-200");const d=u.dataset.slotId,i=U(d);if(i==="Remarque")return;if(s&&d&&s!==d){const p=l[s],y=U(s);if(z(y)!==z(i)){alert(`Action impossible : un(e) "${y}" ne peut pas aller dans la catégorie "${i}".`);return}const h=l[d];l[d]=p,h?l[s]=h:delete l[s],A(e.mealPlanGrid,{menuData:l,servingsData:m,remarksData:c,defaultNumPeople:L,startDay:o},!1),await saveCurrentPlan(),await Ee()}}}function U(a){switch(a.split("-")[2]){case"0":return"Entrée";case"1":return"Plat";case"2":return"Accompagnement";case"3":return"Dessert";case"4":return"Remarque";default:return""}}function Y(a,s,u,d=!1){const i=document.createElement("div");i.className="meal-card p-1 flex flex-col items-center bg-white rounded shadow-sm text-center relative w-full mb-1",d||(i.classList.add("cursor-grab"),i.draggable=!0);const p=document.createElement("span");if(p.className="text-xs font-medium p-1 break-words w-full",p.textContent=a.name,i.appendChild(p),!d){const I=document.createElement("div");I.className="absolute top-0 left-0 flex";const R=document.createElement("button");R.className="edit-meal-btn text-gray-600 hover:text-gray-800 hidden px-1 py-0.5",R.innerHTML='<i class="fas fa-pencil-alt fa-xs"></i>',R.title="Modifier la recette",R.addEventListener("click",T=>{T.stopPropagation();const J=D.find(re=>re.id===a.id);He.openForm(J||a,"Modifier la recette")}),I.appendChild(R);const w=document.createElement("button");w.className="delete-meal-btn text-red-700 hover:text-red-900 hidden px-1 py-0.5",w.innerHTML='<i class="fas fa-times-circle fa-xs"></i>',w.title="Retirer du planning",w.addEventListener("click",T=>{T.stopPropagation(),C(s,u)}),I.appendChild(w),i.appendChild(I),i.addEventListener("mouseenter",()=>{R.classList.remove("hidden"),w.classList.remove("hidden")}),i.addEventListener("mouseleave",()=>{R.classList.add("hidden"),w.classList.add("hidden")})}const y=document.createElement("div");y.className="absolute bottom-1 right-1";const h=document.createElement("button");return h.className="info-meal-btn bg-gray-500 text-white hover:bg-gray-600 rounded w-3 h-3 flex items-center justify-center shadow-sm",h.innerHTML='<i class="fas fa-plus fa-xs"></i>',h.title="Plus d'infos",h.dataset.slotId=s,h.dataset.mealIndex=u,y.appendChild(h),i.appendChild(y),i}function ne(a,s){const u=a.classList.contains("info-open");if(document.querySelectorAll(".planner-ingredient-tooltip").forEach(d=>d.remove()),document.querySelectorAll(".info-meal-btn").forEach(d=>{d.classList.remove("info-open"),d.innerHTML='<i class="fas fa-plus fa-xs"></i>'}),!u){a.innerHTML='<i class="fas fa-times fa-xs"></i>',a.classList.add("info-open");const d=document.createElement("div");if(d.className="planner-ingredient-tooltip z-50 w-64 p-3 bg-white border border-gray-200 rounded-lg shadow-lg text-left text-sm",s.ingredients&&s.ingredients.length>0){if(s.servings&&s.servings>0){const w=document.createElement("p");w.className="mb-2 text-sm text-gray-600 flex items-center",w.innerHTML=`<i class="fas fa-users mr-2"></i> Pour ${s.servings} ${s.servings>1?"personnes":"personne"}`,d.appendChild(w)}const I=document.createElement("h4");I.className="font-bold mb-2 text-gray-800",I.textContent="Ingrédients :",d.appendChild(I);const R=document.createElement("ul");R.className="space-y-1 text-gray-600",s.ingredients.forEach(w=>{const T=document.createElement("li");T.textContent=`• ${w.quantity||""} ${w.unit||""} ${w.name}`.trim(),R.appendChild(T)}),d.appendChild(R)}else d.textContent="Aucun ingrédient spécifié pour cette recette.";document.body.appendChild(d);const i=a.closest(".meal-card").getBoundingClientRect(),p=d.getBoundingClientRect();let y=i.right+10;y+p.width>window.innerWidth&&(y=i.left-p.width-10);let h=i.top;h+p.height>window.innerHeight&&(h=i.bottom-p.height),h<10&&(h=10),d.style.position="fixed",d.style.left=`${y}px`,d.style.top=`${h}px`}}function pe(a,s=!1){const u=document.createElement("div"),d=document.createElement("button");return s?(u.className="w-full flex justify-center pt-1",d.className="add-more-meal-btn text-gray-400 hover:text-green-500 transition-colors duration-150",d.innerHTML='<i class="fas fa-plus-circle"></i>',d.title="Ajouter une autre recette"):(u.className="flex items-center justify-center h-full",d.className="add-meal-btn text-green-500 hover:text-green-700 transition-transform duration-150 hover:scale-125",d.innerHTML='<i class="fas fa-plus-circle text-lg"></i>'),d.addEventListener("click",()=>_(a)),u.appendChild(d),u}function M(a,s,u=!1){if(u){const i=document.createElement("p");return i.className="w-full h-full p-1 text-xs text-gray-700",i.textContent=s[a]||"",i}const d=document.createElement("textarea");return d.className="w-full h-full p-1 text-xs bg-transparent border-0 rounded focus:outline-none focus:ring-1 focus:ring-tomato resize-none",d.placeholder="Remarque...",d.value=c[a]||"",d.addEventListener("change",i=>{const p=i.target.value;p?c[a]=p:delete c[a],saveCurrentPlan()}),d}function B(){document.querySelectorAll(".meal-card").forEach(a=>{a.addEventListener("dragstart",j),a.addEventListener("dragend",H)}),document.querySelectorAll(".meal-slot").forEach(a=>{a.addEventListener("dragover",K),a.addEventListener("dragleave",V),a.addEventListener("drop",se)})}async function x(a,s){const u=JSON.parse(JSON.stringify(l)),d=u[a];Array.isArray(d)?d.push({...s}):u[a]=[s];const i=P(f,"plans",E.id);try{await Ne(i,{[`weeks.${r}.menuData`]:u,lastUpdated:new Date}),v()}catch(p){console.error("Erreur lors de l'ajout de la recette: ",p),alert("Une erreur est survenue.")}}async function C(a,s){if(!E||!l[a]||!Array.isArray(l[a]))return;const u=JSON.parse(JSON.stringify(l));u[a].splice(s,1),u[a].length===0&&delete u[a];const d=P(f,"plans",E.id);try{await Ne(d,{[`weeks.${r}.menuData`]:u,lastUpdated:new Date})}catch(i){console.error("Erreur lors de la suppression de la recette: ",i),alert("Une erreur est survenue.")}}async function N(){if(confirm("Voulez-vous vraiment vider le menu de cette semaine ?")){const a={id:availablePlans.length>0?availablePlans[0].id:`${ye()}_semaine-${r}`,name:availablePlans.length>0?availablePlans[0].name:"Mon plan",menuData:{},servingsData:{},remarksData:{},defaultNumPeople:L,startDay:o,lastUpdated:new Date};loadPlan(a),availablePlans.length>0?availablePlans[0]=a:availablePlans.push(a),await saveCurrentPlan()}}function Q(a){a>=1&&a<=52&&(r=a,$())}function $e(){e.currentWeekDisplay&&(e.currentWeekDisplay.textContent=`Semaine ${r}`)}function Xe(){e.prevWeekBtn?.addEventListener("click",()=>Q(r-1)),e.nextWeekBtn?.addEventListener("click",()=>Q(r+1)),e.clearMenuBtn?.addEventListener("click",N),e.startDaySelect?.addEventListener("change",a=>{o=a.target.value,E&&(E.startDay=o),A(e.mealPlanGrid,{menuData:l,servingsData:m,remarksData:c,defaultNumPeople:L,startDay:o},!1),saveCurrentPlan()}),e.planSelect?.addEventListener("change",Ae),e.closeMealSelectModalBtn?.addEventListener("click",v),e.mealSelectModal?.addEventListener("click",a=>{a.target===e.mealSelectModal&&v()}),e.closeRecipeModalBtn?.addEventListener("click",()=>He.closeForm()),e.cancelRecipeBtn?.addEventListener("click",()=>He.closeForm()),e.importListBtn?.addEventListener("click",q),e.closeImportListModalBtn?.addEventListener("click",G),e.importListModal?.addEventListener("click",a=>{a.target===e.importListModal&&G()}),e.exportTxtBtn?.addEventListener("click",ee),e.exportPdfBtn?.addEventListener("click",oe),e.mealPlanGrid?.addEventListener("click",a=>{const s=a.target.closest(".info-meal-btn");if(s){const u=s.dataset.slotId,d=parseInt(s.dataset.mealIndex,10);if(u&&!isNaN(d)){const i=l[u]?.[d];i&&ne(s,i)}}}),e.sharePlanBtn?.addEventListener("click",()=>{if(!E){alert("Veuillez sélectionner un plan à partager.");return}St({plan:E})})}function ze(a=""){return a.split(" ").map(d=>d[0]).join("").substring(0,2).toUpperCase()}function Oe(a=[]){const s=document.getElementById("collaborators-bar"),u=document.getElementById("name-tooltip");if(!(!s||!u)){if(s.innerHTML="",a.length<=1){s.classList.add("hidden");return}a.forEach(d=>{const i=document.createElement("div");i.className="w-8 h-8 rounded-full flex items-center justify-center bg-gray-300 text-white font-bold text-xs ring-2 ring-white cursor-pointer",i.dataset.name=d.displayName||"Inconnu",d.photoURL?i.innerHTML=`<img src="${d.photoURL}" alt="${d.displayName}" class="w-full h-full rounded-full object-cover">`:i.textContent=ze(d.displayName),i.addEventListener("mouseenter",p=>{u.textContent=p.currentTarget.dataset.name,u.classList.remove("hidden");const y=p.currentTarget.getBoundingClientRect();u.style.left=`${y.left+y.width/2-u.offsetWidth/2}px`,u.style.top=`${y.top-u.offsetHeight-5}px`}),i.addEventListener("mouseleave",()=>{u.classList.add("hidden")}),s.appendChild(i)}),s.classList.remove("hidden")}}function Ae(){const a=e.planSelect.value;E=O.find(i=>i.id===a)||null;const s=document.getElementById("delete-plan-btn"),u=document.getElementById("rename-plan-btn"),d=document.getElementById("leave-plan-btn");s&&(s.style.display=E&&E.isOwner?"inline-flex":"none"),u&&(u.style.display=E&&E.isOwner?"inline-flex":"none"),d&&(d.style.display=E&&!E.isOwner?"inline-flex":"none"),Oe(E?.participants),E&&(E.manualItems=E.manualItems||[]),$()}async function Xt(a,s){s===L?delete m[a]:m[a]=s,A(e.mealPlanGrid,{menuData:l,servingsData:m,remarksData:c,defaultNumPeople:L,startDay:o},!1),await saveCurrentPlan(),await Ee()}async function Kt(){return f?(Wt(),Xe(),me(),await W(),await xe(),await xe(),Qt(s=>{O=s,Gt(s),Ae()})):void 0}const Yt=Kt();return async()=>{const a=await Yt;typeof a=="function"&&a()}}const Hn=Object.freeze(Object.defineProperty({__proto__:null,default:qn},Symbol.toStringTag,{value:"Module"}));function Fn(){const e=Jt();return Lt(),()=>{typeof e=="function"&&e()}}async function Lt(){const e=document.getElementById("received-shares-container"),t=ye();if(!(!t||!e)){e.innerHTML='<p class="text-gray-500">Chargement des partages reçus...</p>';try{const n=ge(F(f,"plans"),ae("userId","==",t),ae("isShared","==",!0)),r=ge(F(f,"plans"),ae("collaborators","array-contains",t)),[o,l]=await Promise.all([ue(n),ue(r)]);let m=[];if(o.forEach(c=>m.push({id:c.id,type:"Planification (Copie)",...c.data()})),l.forEach(c=>m.push({id:c.id,type:"Planification (Collaboratif)",...c.data()})),m.length===0){e.innerHTML=`<p class="text-gray-500">Vous n'avez aucun contenu partagé par d'autres utilisateurs.</p>`;return}m.sort((c,g)=>(g.sharedAt?.seconds||g.lastUpdated?.seconds||0)-(c.sharedAt?.seconds||c.lastUpdated?.seconds||0)),e.innerHTML="";for(const c of m){const g=c.originalOwnerId||c.userId;if(!g)continue;const b=await Ie(P(f,"users",g)),D=b.exists()?b.data().displayName:"Utilisateur inconnu";e.appendChild(Un(c,D))}}catch(n){console.error("Erreur lors du chargement des partages reçus : ",n),e.innerHTML='<p class="text-red-500">Une erreur est survenue.</p>'}}}function Un(e,t){const n=document.createElement("div");n.className="bg-white rounded-lg p-4 flex justify-between items-center shadow-sm";const r=document.createElement("div"),o=document.createElement("p");o.className="font-bold text-gray-800";let l="";e.type.includes("Collaboratif")?l=' <span class="text-xs font-medium bg-blue-100 text-blue-800 px-2 py-1 rounded-full">Collab</span>':e.type.includes("Copie")&&(l=' <span class="text-xs font-medium bg-gray-200 text-gray-800 px-2 py-1 rounded-full">Copie</span>'),o.innerHTML=`${e.name}${l}`;const m=document.createElement("p");m.className="text-sm text-gray-500 mt-1";const c=e.sharedAt?new Date(e.sharedAt.seconds*1e3).toLocaleDateString("fr-FR"):e.lastUpdated?new Date(e.lastUpdated.seconds*1e3).toLocaleDateString("fr-FR"):"date inconnue";m.textContent=`Partagé par ${t} le ${c}`,r.appendChild(o),r.appendChild(m),n.appendChild(r);const g=document.createElement("button");return g.className="btn btn-ghost text-red-500 btn-sm",g.innerHTML='<i class="fas fa-trash"></i>',g.title="Supprimer ce contenu partagé",g.addEventListener("click",()=>zn(e.id,e.type)),n.appendChild(g),n}async function zn(e,t){if(confirm(`Voulez-vous vraiment supprimer cette ${t.toLowerCase()} partagée ?`))try{const n=t.startsWith("Planification")?"plans":"shopping_lists",r=P(f,n,e),o=await Ie(r);o.exists()&&o.data().userId===ye()?(await je(r),Lt()):(alert("Vous n'avez pas la permission de supprimer cet élément ou il a déjà été supprimé."),Lt())}catch(n){console.error("Erreur de suppression: ",n),alert("Une erreur est survenue.")}}async function Jt(){const e=document.getElementById("sent-shares-container"),t=ye();if(!t||!e)return()=>{};e.innerHTML='<p class="text-gray-500">Chargement des partages envoyés...</p>';const n=F(f,"shares"),r=ge(n,ae("senderId","==",t));return Je(r,async o=>{if(o.empty){e.innerHTML=`<p class="text-gray-500">Vous n'avez envoyé aucun partage.</p>`;return}const l=o.docs.sort((m,c)=>(c.data().createdAt?.seconds||0)-(m.data().createdAt?.seconds||0));e.innerHTML="";for(const m of l){const c=m.data();try{const g=await Ie(P(f,"users",c.receiverId));if(g.exists()){const b=g.data();e.appendChild(On(c,b.displayName,m.id))}}catch(g){console.error("Could not load receiver for sent share",g)}}},o=>{console.error("Erreur lors du chargement des partages envoyés : ",o),e&&(e.innerHTML='<p class="text-red-500">Une erreur est survenue.</p>')})}function On(e,t,n){const r=document.createElement("div");r.className="bg-white rounded-lg p-4 flex justify-between items-center shadow-sm";const o=document.createElement("div"),l=document.createElement("p");l.className="font-bold text-gray-800";let m=[];e.plan&&m.push("Planification"),e.shoppingList&&m.push("Liste de courses"),l.textContent=m.join(" et ");const c=document.createElement("p");c.className="text-sm text-gray-500";const g=new Date(e.createdAt.seconds*1e3).toLocaleDateString("fr-FR");c.textContent=`Envoyé à ${t} le ${g}`,o.appendChild(l),o.appendChild(c),r.appendChild(o);const b=document.createElement("div");b.className="flex items-center space-x-4";const D=document.createElement("span");D.textContent=e.status;let k="bg-gray-200 text-gray-800";switch(e.status){case"accepted":k="bg-green-100 text-green-800";break;case"declined":k="bg-red-100 text-red-800";break;case"pending":k="bg-yellow-100 text-yellow-800";break}D.className=`text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full ${k}`,b.appendChild(D);const L=document.createElement("button");return L.className="btn btn-ghost text-red-500 btn-sm",L.innerHTML='<i class="fas fa-trash"></i>',L.title="Annuler le partage",L.addEventListener("click",()=>Vn(n)),b.appendChild(L),r.appendChild(b),r}async function Vn(e){if(confirm("Voulez-vous vraiment annuler ce partage ? L'autre utilisateur ne le verra plus."))try{await je(P(f,"shares",e)),Jt()}catch(t){console.error("Erreur lors de la suppression du partage: ",t),alert("Une erreur est survenue.")}}const Qn=Object.freeze(Object.defineProperty({__proto__:null,default:Fn},Symbol.toStringTag,{value:"Module"})),Pt=document.querySelector("main"),Gn={menu:{html:`
        <div class="flex flex-col md:flex-row md:space-x-2">

            <!-- Left Column: Meal Planner -->
            <div class="w-full md:w-5/6">
                <section id="meal-planning-section" aria-labelledby="meal-planning-heading" class="mb-8 md:mb-12">
                                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                                        <h2 id="meal-planning-heading" class="text-xl md:text-2xl font-bold text-gray-800">Planification des repas</h2>
                                        <div class="mt-3 md:mt-0 flex items-center space-x-2 md:space-x-3">
                                            <button id="generate-plan-ai-btn" class="btn btn-primary btn-sm">
                                                <i class="fas fa-robot mr-1 md:mr-2"></i> IA Semaine
                                            </button>
                                            <button id="clear-menu-btn" class="btn btn-outline btn-sm text-red-800 hover:bg-red-100">
                                                <i class="fas fa-trash-alt mr-1 md:mr-2"></i> Vider le menu
                                            </button>
                                            <button id="share-plan-btn" class="btn btn-secondary btn-sm">
                                                <i class="fas fa-share-alt mr-1 md:mr-2"></i> Partager
                                            </button>
                                        </div>
                                    </div>
                            
                                    <!-- Week Navigation & Plan Selector -->
                                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 space-y-3 md:space-y-0">
                                        <!-- Week Navigation -->
                                        <div class="flex justify-between items-center bg-white p-2 md:p-3 rounded-lg shadow-sm">
                                            <button id="prev-week-btn" class="btn btn-ghost btn-sm" aria-label="Semaine précédente">
                                                <i class="fas fa-chevron-left mr-1 md:mr-2"></i> Préc.
                                            </button>
                                            <div id="current-week-display" class="text-gray-700 font-medium text-sm md:text-base text-center mx-4">Semaine X</div>
                                            <button id="next-week-btn" class="btn btn-ghost btn-sm" aria-label="Semaine suivante">
                                                Suiv. <i class="fas fa-chevron-right ml-1 md:ml-2"></i>
                                            </button>
                                        </div>
                                        <!-- Plan Selector -->
                                        <div class="flex items-center space-x-2 bg-white p-3 rounded-lg shadow-sm">
                                            <label for="plan-select" class="text-sm font-medium text-gray-700">Plan affiché:</label>
                                            <select id="plan-select" class="rounded-md border-gray-300 shadow-sm focus:border-tomato focus:ring focus:ring-tomato focus:ring-opacity-50 text-sm py-1">
                                                <!-- Options will be generated by JS -->
                                            </select>
                                            <button id="create-plan-btn" class="btn btn-primary btn-sm" title="Créer un nouveau plan">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                            <button id="rename-plan-btn" class="btn btn-ghost text-blue-500 hover:bg-blue-100 btn-sm" title="Renommer le plan sélectionné">
                                                <i class="fas fa-pencil-alt"></i>
                                            </button>
                                            <button id="leave-plan-btn" class="btn btn-ghost text-yellow-600 hover:bg-yellow-100 btn-sm" title="Quitter le plan collaboratif">
                                                <i class="fas fa-door-open"></i>
                                            </button>
                                            <button id="delete-plan-btn" class="btn btn-ghost text-red-500 hover:bg-red-100 btn-sm" title="Supprimer le plan sélectionné">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Collaborators Bar -->
                                    <div id="collaborators-bar" class="flex items-center space-x-2 mb-4 hidden">
                                        <!-- Avatars will be injected here -->
                                    </div>
                            
                                            <!-- Settings Section -->
                                            <div class="inline-flex items-center space-x-6 bg-white p-3 rounded-lg shadow-sm mb-4">                                        <div>
                                            <label for="start-day-select" class="text-sm font-medium text-gray-700">Début de semaine:</label>
                                            <select id="start-day-select" class="rounded-md border-gray-300 shadow-sm focus:border-tomato focus:ring-tomato text-sm py-1">
                                                <option>Lundi</option>
                                                <option>Mardi</option>
                                                <option>Mercredi</option>
                                                <option>Jeudi</option>
                                                <option>Vendredi</option>
                                                <option>Samedi</option>
                                                <option>Dimanche</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="default-servings-input" class="text-sm font-medium text-gray-700">Personnes par défaut:</label>
                                            <div id="default-servings-control" class="mt-1"></div>
                                        </div>
                                    </div>                    <!-- Meal Plan Grid -->
                    <div class="bg-white rounded-xl shadow-md p-4 overflow-x-auto">
                        <div id="meal-plan-grid-layout" class="min-w-[1400px]">
                            <!-- Header -->
                            <div class="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] gap-1 text-center mb-1">
                                <div class="p-2"></div> <!-- Empty corner -->
                                <div class="p-2 rounded-t-lg bg-amber-100 text-amber-800 font-bold col-span-6">MIDI</div>
                                <div class="p-2 rounded-t-lg bg-stone-200 text-stone-800 font-bold col-span-6">SOIR</div>
                                
                                <div class="p-1"></div> <!-- Empty under day name -->
                                <div class="p-1 text-xs font-semibold"><i class="fas fa-users"></i></div>
                                <div class="p-1 text-xs font-semibold text-gray-600">Entrée</div>
                                <div class="p-1 text-xs font-semibold text-gray-600">Plat</div>
                                <div class="p-1 text-xs font-semibold text-gray-600">Accomp.</div>
                                <div class="p-1 text-xs font-semibold text-gray-600">Dessert</div>
                                <div class="p-1 text-xs font-semibold text-gray-600">Remarque</div>

                                <div class="p-1 text-xs font-semibold"><i class="fas fa-users"></i></div>
                                <div class="p-1 text-xs font-semibold text-gray-600">Entrée</div>
                                <div class="p-1 text-xs font-semibold text-gray-600">Plat</div>
                                <div class="p-1 text-xs font-semibold text-gray-600">Accomp.</div>
                                <div class="p-1 text-xs font-semibold text-gray-600">Dessert</div>
                                <div class="p-1 text-xs font-semibold text-gray-600">Remarque</div>
                            </div>
                            <!-- Rows generated by JS -->
                            <div id="meal-plan-grid" class="space-y-1">
                                <div class="p-10 text-center text-gray-500 italic col-span-full">Chargement du planning...</div>
                            </div>                                            </div>
                                        </div>
                                    </section>


                                </div>
                    
                                <!-- Right Column: Shopping List -->
                                <div class="w-full md:w-1/6">
                                    <section id="shopping-list-section" aria-labelledby="shopping-list-heading" class="mb-8 md:mb-12 md:sticky md:top-24">
                                        <div class="bg-white rounded-xl shadow-md p-4 md:p-6">
                                            <h2 id="shopping-list-heading" class="text-xl md:text-2xl font-bold text-gray-800 mb-4">Liste de courses</h2>
                                            <div class="flex justify-end space-x-2 mb-4">
                                                <button id="import-list-btn" class="btn btn-secondary btn-sm">
                                                    <i class="fas fa-download mr-2"></i>Importer une liste
                                                </button>
                                                <div id="export-buttons-container" class="flex space-x-2">
                                                    <button id="export-txt-btn" class="btn btn-outline btn-sm">
                                                        <i class="fas fa-file-alt mr-2"></i>TXT
                                                    </button>
                                                    <button id="export-pdf-btn" class="btn btn-outline btn-sm">
                                                        <i class="fas fa-file-pdf mr-2"></i>PDF
                                                    </button>
                                                </div>
                                            </div>
                    
                                            <!-- Shopping List Container -->
                                            <div id="shopping-list-container" class="mb-4 max-h-[70vh] overflow-y-auto pr-2">                            <ul id="shopping-list" class="space-y-2 text-sm">
                                <!-- Les articles de la liste de courses seront générés ici -->
                            </ul>
                        </div>

                        <!-- Add Item Input -->
                        <div class="mt-4 flex items-stretch">
                            <div class="relative flex-grow">
                                <input type="text" id="add-item-input" placeholder="Chercher ou ajouter..." class="w-full border border-gray-300 rounded-l-lg px-2 py-1 text-xs focus:outline-none focus:ring-2 focus:ring-tomato focus:border-transparent">
                                <div id="add-item-results" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto bottom-full mb-2"></div>
                            </div>
                            <button id="add-item-btn" class="btn btn-primary rounded-l-none -ml-px btn-xs" aria-label="Ajouter l'article">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>

                         <!-- AI Shopping Tips Placeholder -->
                        <div id="ai-shopping-tip" class="mt-6 bg-avocado bg-opacity-10 rounded-lg p-3 hidden">
                            <div class="flex items-start">
                                 <div class="w-8 h-8 bg-avocado bg-opacity-20 rounded-full flex items-center justify-center mr-3 shrink-0">
                                    <i class="fas fa-lightbulb text-avocado"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-avocado mb-1 text-sm">Astuce Économique</h4>
                                    <p id="ai-shopping-tip-text" class="text-sm text-gray-700">...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <!-- Shared Plans Modal -->
        <div id="shared-plans-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-6xl max-h-[90vh] overflow-y-auto relative">
                <button id="close-shared-plans-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" aria-label="Fermer">
                    <i class="fas fa-times text-xl"></i>
                </button>
                <h3 id="shared-plans-modal-title" class="text-2xl font-bold mb-6">Plans partagés pour la Semaine X</h3>
                <div id="shared-plans-modal-container" class="space-y-6">
                    <!-- Shared plans will be loaded here -->
                </div>
            </div>
        </div>
        `,script:"./script.js"},recipes:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Recettes</h2>
            <button id="add-recipe-btn" class="btn btn-primary">
                <i class="fas fa-plus mr-2"></i> Ajouter une recette
            </button>
        </div>

        <!-- Search Bar -->
        <div class="mb-6">
            <input type="text" id="search-bar" placeholder="Rechercher une recette..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-tomato focus:border-tomato">
        </div>

        <!-- Tabs Navigation -->
        <div id="category-tabs" class="mb-6 border-b border-gray-200 flex space-x-4 flex-nowrap overflow-x-auto pb-2">
            <!-- Tabs will be generated by recipes.js here -->
        </div>

        <!-- Recipe List Container -->
        <div id="recipe-list-container">
            <!-- Recipes for the selected tab will be loaded here -->
        </div>

        <!-- Reconstructed Recipe Form Modal -->
        <div id="recipe-form-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-3xl max-h-[90vh] overflow-y-auto relative">
                <button id="close-recipe-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" aria-label="Fermer">
                    <i class="fas fa-times text-xl"></i>
                </button>
                <h3 id="recipe-modal-title" class="text-2xl font-bold mb-6">Ajouter/Modifier une recette</h3>
                <form id="recipe-form" class="space-y-4">
                    <input type="hidden" id="recipe-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label for="recipe-name" class="block text-sm font-medium text-gray-700">Nom de la recette</label>
                            <input type="text" id="recipe-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                        </div>
                        <div>
                            <label for="recipe-category" class="block text-sm font-medium text-gray-700">Catégorie</label>
                            <select id="recipe-category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                                <option>ENTREE</option>
                                <option>PLAT</option>
                                <option>ACCOMPAGNEMENT</option>
                                <option>DESSERT</option>
                            </select>
                        </div>
                        <div>
                            <label for="recipe-servings" class="block text-sm font-medium text-gray-700">Nombre de personnes</label>
                            <input type="number" id="recipe-servings" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" min="1">
                        </div>
                        <div>
                            <label for="recipe-prep-time" class="block text-sm font-medium text-gray-700">Temps de préparation (min)</label>
                            <input type="number" id="recipe-prep-time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" min="0">
                        </div>
                         <div>
                            <label for="recipe-difficulty" class="block text-sm font-medium text-gray-700">Difficulté</label>
                            <select id="recipe-difficulty" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                <option>Très facile</option>
                                <option>Facile</option>
                                <option>Moyen</option>
                                <option>Difficile</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-lg font-medium text-gray-800 mb-2">Ingrédients</h4>
                        <div id="ingredients-list" class="space-y-2"></div>
                        <button type="button" id="add-ingredient-btn" class="btn btn-outline btn-sm mt-2">
                            <i class="fas fa-plus mr-2"></i> Ajouter un ingrédient
                        </button>
                    </div>
                    <div>
                        <label for="recipe-steps" class="block text-lg font-medium text-gray-800">Préparation</label>
                        <textarea id="recipe-steps" rows="8" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                    </div>
                    <div class="flex justify-end space-x-4 pt-4">
                        <button type="button" id="cancel-recipe-btn" class="btn btn-ghost">Annuler</button>
                        <button type="submit" id="save-recipe-btn" class="btn btn-primary">Sauvegarder</button>
                    </div>
                </form>
            </div>
        </div>
        `,script:"./recipes.js"},ingredients:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Ingrédients</h2>
            <div class="flex space-x-2">
                <button id="manage-categories-btn" class="btn btn-outline">
                    <i class="fas fa-tags mr-2"></i> Gérer les catégories
                </button>
                <button id="add-ingredient-btn" class="btn btn-primary">
                    <i class="fas fa-plus mr-2"></i> Ajouter un ingrédient
                </button>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="mb-6">
            <input type="text" id="search-bar" placeholder="Rechercher un ingrédient..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-tomato focus:border-tomato">
        </div>

        <!-- Tabs Navigation -->
        <div id="category-tabs" class="mb-6 border-b border-gray-200 flex space-x-4 flex-nowrap overflow-x-auto pb-2">
            <!-- Tabs will be generated by ingredients.js here -->
        </div>

        <!-- Ingredient List Container -->
        <div id="ingredients-list-container">
            <p class="text-center text-gray-500 p-10">Chargement des ingrédients...</p>
        </div>

        <!-- Ingredient Form Modal -->
        <div id="ingredient-form-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-md relative">
                <button id="close-ingredient-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
                <h3 id="ingredient-modal-title" class="text-lg font-bold mb-4">Ajouter un Ingrédient</h3>
                <form id="ingredient-form" class="space-y-4">
                    <input type="hidden" id="ingredient-id">
                    <div>
                        <label for="ingredient-name" class="block text-sm font-medium text-gray-700">Nom</label>
                        <input type="text" id="ingredient-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                    </div>
                    <div>
                        <label for="ingredient-unit" class="block text-sm font-medium text-gray-700">Unité par défaut</label>
                        <select id="ingredient-unit" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select>
                    </div>
                    <div>
                        <label for="ingredient-category" class="block text-sm font-medium text-gray-700">Catégorie</label>
                        <select id="ingredient-category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></select>
                    </div>
                    <div class="flex justify-end space-x-4 pt-2">
                        <button type="button" id="cancel-ingredient-btn" class="btn btn-ghost">Annuler</button>
                        <button type="submit" id="save-ingredient-btn" class="btn btn-primary">Sauvegarder</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Category Management Modal -->
        <div id="category-management-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-lg relative">
                <h3 class="text-lg font-bold mb-4">Gérer les catégories d'ingrédients</h3>
                <form id="add-category-form" class="flex items-center space-x-2 mb-4">
                    <input type="text" id="new-category-name" placeholder="Nom de la nouvelle catégorie" class="flex-grow mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                    <button type="submit" class="btn btn-secondary">Ajouter</button>
                </form>
                <div id="category-list" class="max-h-64 overflow-y-auto border rounded-lg p-2"></div>
                <div class="flex justify-end space-x-4 mt-4">
                     <button type="button" id="close-category-modal" class="btn btn-ghost">Annuler</button>
                    <button type="button" id="done-category-modal-btn" class="btn btn-primary">Terminé</button>
                </div>
            </div>
        </div>
        `,script:"./ingredients.js"},lists:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Listes de Courses</h2>
            <button id="add-list-btn" class="btn btn-primary">
                <i class="fas fa-plus mr-2"></i> Créer une liste
            </button>
        </div>

        <!-- Search Bar -->
        <div class="mb-6">
            <input type="text" id="search-bar" placeholder="Rechercher une liste..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-tomato focus:border-tomato">
        </div>

        <!-- Lists Container -->
        <div id="lists-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

        <div class="mt-12">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6">Listes Partagées</h2>
            <div id="shared-lists-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Les listes partagées seront chargées ici par JS -->
            </div>
        </div>

        <!-- List Form Modal -->
        <div id="list-form-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-start justify-center z-[100] hidden pt-20">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-3xl min-h-[75vh] max-h-[90vh] overflow-y-auto relative">
                <button id="close-list-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10"><i class="fas fa-times text-xl"></i></button>
                <h3 id="list-modal-title" class="text-lg font-bold mb-4">Créer une liste</h3>
                <form id="list-form" class="space-y-4 pb-20">
                    <input type="hidden" id="list-id">
                    <div>
                        <label for="list-name" class="block text-sm font-medium text-gray-700">Nom de la liste</label>
                        <input type="text" id="list-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                    </div>
                    <div>
                        <h4 class="text-md font-medium text-gray-800 mb-2">Ingrédients</h4>
                        <div id="ingredients-list" class="space-y-2"></div>
                        <button type="button" id="add-ingredient-btn" class="btn btn-outline btn-sm mt-2">
                            <i class="fas fa-plus mr-2"></i> Ajouter un ingrédient
                        </button>
                    </div>
                </form>
                <div class="absolute bottom-0 left-0 right-0 px-6 py-4 bg-white/95 backdrop-blur-sm border-t border-gray-200 flex justify-end space-x-4">
                    <button type="button" id="cancel-list-btn" class="btn btn-ghost">Annuler</button>
                    <button type="submit" form="list-form" id="save-list-btn" class="btn btn-primary">Sauvegarder la liste</button>
                </div>
            </div>
        </div>
        `,script:"./lists.js"},friends:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Amis</h2>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="md:col-span-2 space-y-8">
                <div>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Liste d'amis</h3>
                    <div id="friends-list-container" class="space-y-4">
                        <!-- La liste d'amis sera chargée ici -->
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Demandes envoyées en attente</h3>
                    <div id="pending-requests-container" class="space-y-4">
                        <!-- Les demandes envoyées en attente seront chargées ici -->
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Demandes rejetées</h3>
                    <div id="declined-requests-container" class="space-y-4">
                        <!-- Les demandes rejetées seront chargées ici -->
                    </div>
                </div>
            </div>
            <div>
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Rechercher un ami</h3>
                    <div class="mb-4">
                        <div class="flex items-center space-x-2">
                            <input type="text" id="search-friends-input" placeholder="Nom ou email..." class="flex-grow p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-tomato focus:border-tomato">
                            <button id="search-friends-btn" class="btn btn-primary"><i class="fas fa-search"></i></button>
                        </div>
                        <div id="search-results-container" class="mt-2 space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>
        `,script:"./friends.js"},shared:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Partages</h2>
        </div>

        <div class="space-y-12">
            <div>
                <h3 class="text-xl font-bold text-gray-700 border-b pb-2 mb-4">Partages Reçus</h3>
                <div id="received-shares-container" class="space-y-4">
                    <!-- L'historique des partages acceptés sera chargé ici -->
                </div>
            </div>
            <div>
                <h3 class="text-xl font-bold text-gray-700 border-b pb-2 mb-4">Mes Partages Envoyés</h3>
                <div id="sent-shares-container" class="space-y-4">
                    <!-- L'historique des partages envoyés sera chargé ici -->
                </div>
            </div>
        </div>
        `,script:"./shared.js"}},Wn=Object.assign({"./auth.js":on,"./firebase-config.js":sn,"./form-handler.js":ln,"./friends.js":fn,"./ingredients.js":hn,"./lists.js":xn,"./main.js":rn,"./notifications.js":Mn,"./plans.js":jn,"./recipes.js":An,"./script.js":Hn,"./shared.js":Qn,"./sharing.js":yn});let it=null;async function Rt(e){typeof it=="function"&&(it(),it=null);const t=Gn[e];if(t&&Pt){if(Pt.innerHTML=t.html,t.script){const n=Wn[t.script];n?n.default&&typeof n.default=="function"&&(it=n.default()):console.error(`Module not found for path: ${t.script}`)}}else console.error(`Route not found: ${e}`)}function Jn(){const e=Be();if(e){const n=document.getElementById("user-display-name");n&&(n.textContent=e.displayName||e.email)}const t=document.querySelectorAll(".nav-btn");t.forEach(n=>{n.addEventListener("click",r=>{const o=r.currentTarget.dataset.path;Rt(o),t.forEach(l=>{l.classList.remove("bg-tomato","text-white"),l.classList.add("bg-white","text-tomato")}),r.currentTarget.classList.add("bg-tomato","text-white"),r.currentTarget.classList.remove("bg-white","text-tomato")})}),Rt("menu"),Vt()}document.addEventListener("DOMContentLoaded",()=>{jt().then(e=>{e&&Jn()})});
