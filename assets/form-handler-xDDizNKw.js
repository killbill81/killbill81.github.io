import{g as f,c as I,b,s as y,a as E}from"./main--zY2HtAH.js";class B{constructor(e,t,i,d,n,c,o,m,a,r,u,h,v,p,s,l){this.db=e,this.modal=document.getElementById(t),this.form=document.getElementById(i),this.modalTitle=document.getElementById(d),this.recipeIdInput=document.getElementById(n),this.recipeNameInput=document.getElementById(c),this.recipeCategoryInput=document.getElementById(o),this.recipeServingsInput=document.getElementById(m),this.recipePrepTimeInput=document.getElementById(a),this.recipeDifficultyInput=document.getElementById(r),this.recipeStepsTextarea=document.getElementById(u),this.ingredientsListDiv=document.getElementById(h),this.addIngredientBtn=document.getElementById(v),this.saveRecipeBtn=document.getElementById(p),this.closeButton=document.getElementById(s),this.cancelButton=document.getElementById(l),this.masterIngredientList=[],this.boundAddIngredient=()=>this.addIngredientInput(void 0,this.form.ingredients),this.boundCloseForm=()=>this.closeForm(),this.boundHandleSubmit=g=>this.handleSubmit(g),this.addIngredientBtn.addEventListener("click",this.boundAddIngredient),this.closeButton.addEventListener("click",this.boundCloseForm),this.cancelButton.addEventListener("click",this.boundCloseForm),this.saveRecipeBtn.addEventListener("click",this.boundHandleSubmit)}destroy(){this.addIngredientBtn.removeEventListener("click",this.boundAddIngredient),this.closeButton.removeEventListener("click",this.boundCloseForm),this.cancelButton.removeEventListener("click",this.boundCloseForm),this.saveRecipeBtn.removeEventListener("click",this.boundHandleSubmit)}async openForm(e=null,t="Ajouter une recette"){await this.fetchMasterIngredients(),console.log("openForm called with recipe:",e,"and title:",t),this.form.reset(),this.ingredientsListDiv.innerHTML="",this.modalTitle.textContent=t;const i=[];if(this.form.ingredients=i,e){this.recipeIdInput.value=e.id||"",this.recipeNameInput.value=e.name||"";const d=e.category||"Plat";for(const n of this.recipeCategoryInput.options)if(n.value.toLowerCase()===d.toLowerCase()){n.selected=!0;break}this.recipeServingsInput.value=parseInt(e.servings)||"",this.recipePrepTimeInput.value=parseInt(e.prepTime)||"",this.recipeDifficultyInput.value=e.difficulty||"Moyen",this.recipeStepsTextarea.value=e.steps||"",e.ingredients&&e.ingredients.length>0?e.ingredients.forEach(n=>this.addIngredientInput({...n},i)):this.addIngredientInput(void 0,i)}else this.recipeIdInput.value="",this.addIngredientInput(void 0,i);this.modal.classList.remove("hidden")}closeForm(){this.modal.classList.add("hidden")}async fetchMasterIngredients(){if(this.masterIngredientList=[],!!this.db)try{const e=await f(I(this.db,"ingredients"));this.masterIngredientList=e.docs.map(t=>({id:t.id,...t.data()})),this.masterIngredientList.sort((t,i)=>t.name.localeCompare(i.name))}catch(e){console.error("Erreur lors de la récupération de la liste des ingrédients: ",e),alert("Impossible de charger la liste des ingrédients de base. La recherche ne fonctionnera pas.")}}addIngredientInput(e={quantity:"",name:"",unit:""},t){const i=document.createElement("div");i.className="relative flex items-stretch space-x-2 ingredient-row";const d={...e};t.push(d);const n=t.length-1,c=document.createElement("input");c.type="text",c.className="ingredient-quantity mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm",c.placeholder="Qté",c.value=d.quantity,c.addEventListener("change",h=>{t[n].quantity=h.target.value});const o=document.createElement("input");o.type="text",o.className="ingredient-unit mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm bg-gray-100",o.placeholder="Unité",o.readOnly=!0,o.value=d.unit||"";const m=document.createElement("div");m.className="relative w-1/2";const a=document.createElement("input");a.type="text",a.className="ingredient-name mt-1 block w-full rounded-md border-gray-300 shadow-sm",a.placeholder="Chercher un ingrédient...",a.value=d.name,m.appendChild(a);const r=document.createElement("div");r.className="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto",m.appendChild(r),a.addEventListener("input",()=>{const h=a.value.toLowerCase();if(!h){r.classList.add("hidden");return}const v=this.masterIngredientList.filter(s=>s.name.toLowerCase().includes(h));r.innerHTML="",v.forEach(s=>{const l=document.createElement("div");l.className="p-2 hover:bg-tomato hover:text-white cursor-pointer",l.textContent=s.name,l.addEventListener("click",()=>{a.value=s.name,o.value=s.unit,r.classList.add("hidden"),t[n].name=s.name,t[n].unit=s.unit,t[n].id=s.id}),r.appendChild(l)});const p=document.createElement("div");p.className="p-2 bg-blue-50 hover:bg-blue-200 cursor-pointer font-bold text-blue-700",p.textContent=`+ Créer "${a.value}"`,p.addEventListener("click",async()=>{const s=a.value,l="pièce(s)";try{const g=await b(I(this.db,"ingredients"),{name:s,unit:l});await this.fetchMasterIngredients(),a.value=s,o.value=l,r.classList.add("hidden"),t[n].name=s,t[n].unit=l,t[n].id=g.id}catch(g){console.error("Erreur d'ajout d'ingrédient",g),alert("L'ingrédient n'a pas pu être créé.")}}),r.appendChild(p),r.classList.remove("hidden")});const u=document.createElement("button");u.type="button",u.className="btn btn-ghost text-red-500 hover:bg-red-50 btn-sm mt-1",u.innerHTML='<i class="fas fa-trash"></i>',u.addEventListener("click",()=>{i.remove(),t[n]=null}),i.appendChild(m),i.appendChild(c),i.appendChild(o),i.appendChild(u),this.ingredientsListDiv.appendChild(i)}async handleSubmit(e){e.preventDefault(),this.saveRecipeBtn.disabled=!0,this.saveRecipeBtn.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i> Sauvegarde...',console.log("Ingredients array from form before filter:",this.form.ingredients);const t=this.form.ingredients.filter(n=>n!==null&&n.quantity&&n.name);console.log("Ingredients array after filter:",t);const i={name:this.recipeNameInput.value,category:this.recipeCategoryInput.value,servings:parseInt(this.recipeServingsInput.value)||0,prepTime:parseInt(this.recipePrepTimeInput.value)||0,difficulty:this.recipeDifficultyInput.value,steps:this.recipeStepsTextarea.value,ingredients:t,imageUrl:""};console.log("Recipe data being sent to Firebase:",i);const d=this.recipeIdInput.value;try{d?await y(E(this.db,"recipes",d),i):await b(I(this.db,"recipes"),i),this.closeForm(),console.log("Recipe saved successfully!"),this.onSaveCallback&&this.onSaveCallback()}catch(n){console.error("Erreur de sauvegarde: ",n),alert("Une erreur est survenue lors de la sauvegarde.")}finally{this.saveRecipeBtn.disabled=!1,this.saveRecipeBtn.textContent="Sauvegarder"}}setOnSaveCallback(e){this.onSaveCallback=e}}export{B as RecipeFormHandler};
