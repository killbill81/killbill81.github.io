import{o as Sn,s as Vt,a as wt,q as pe,w as ee,c as U,d as y,b as Fe,e as _,g as Le,f as he,u as Te,h as Ae,i as Ne,j as ct,k as Kt,l as ht,m as Qt,n as Mn,p as Nn,r as Lt,t as Wt,v as Tn,x as Dn,y as Pn,z as _n,A as $n,B as Zt,C as Hn,D as Rn,_ as jn}from"./firebase-config-DRNfbNj5.js";const An=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"}));let vt=null;function en(){return new Promise(e=>{Sn(wt,t=>{if(vt=t,t){console.log("User is logged in:",t.uid);const n=document.getElementById("logout-btn"),a=document.getElementById("profile-btn");n&&n.classList.remove("hidden"),a&&a.classList.remove("hidden"),n&&!n.hasAttribute("data-listener-attached")&&(n.addEventListener("click",()=>{Vt(wt).catch(o=>{console.error("Sign Out Error",o)})}),n.setAttribute("data-listener-attached","true"));const i=document.getElementById("logout-btn-mobile");i&&!i.hasAttribute("data-listener-attached")&&(i.addEventListener("click",()=>{Vt(wt).catch(o=>{console.error("Sign Out Error",o)})}),i.setAttribute("data-listener-attached","true")),e(t)}else{console.log("User not logged in. Redirecting to login.html");const n=window.location.origin+"/login.html";window.location.href!==n&&(window.location.href=n),e(null)}})})}function ye(){return vt?vt.uid:null}function He(){return vt}const qn=Object.freeze(Object.defineProperty({__proto__:null,getCurrentUser:He,getCurrentUserId:ye,protectPage:en},Symbol.toStringTag,{value:"Module"}));async function Un(e){if(confirm("Voulez-vous charger cette sauvegarde ? Attention, cela √©crasera la planification de la semaine correspondante dans votre plan de travail actuel."))try{const t=ye();if(!t)throw new Error("Utilisateur non trouv√©");const n=_(y,"plan_saves",e),a=await Le(n);if(!a.exists())throw new Error("Sauvegarde non trouv√©e.");const i=a.data(),o=i.weekData.weekNumber,c=pe(U(y,"plans"),ee("userId","==",t)),p=await he(c);if(p.empty)throw new Error("Aucun plan de travail trouv√© pour y charger la sauvegarde.");const x=p.docs[0],E=_(y,"plans",x.id);await Te(E,{[`weeks.${o}`]:i.weekData}),localStorage.setItem("selectedPlanId",x.id),rt("menu")}catch(t){console.error("Erreur lors du chargement de la sauvegarde:",t),alert(t.message)}}async function Fn(e){if(confirm("√ätes-vous s√ªr de vouloir supprimer cette sauvegarde ? Cette action est d√©finitive."))try{await Ae(_(y,"plan_saves",e))}catch(t){console.error("Erreur lors de la suppression de la sauvegarde:",t),alert("La suppression a √©chou√©.")}}function On(){const e=document.getElementById("all-plans-list"),t=ye();if(!t||!e)return e.innerHTML="<p>Erreur de chargement.</p>",()=>{};const n=pe(U(y,"plan_saves"),ee("userId","==",t)),a=Fe(n,i=>{if(e.innerHTML="",i.empty){e.innerHTML=`<p class="text-center text-gray-500 p-10 col-span-full">Vous n'avez aucune sauvegarde.</p>`;return}const o=i.docs.map(c=>({id:c.id,...c.data()}));o.sort((c,p)=>p.savedAt.toMillis()-c.savedAt.toMillis()),o.forEach(c=>{const p=document.createElement("div");p.className="bg-white rounded-xl shadow-md p-4 flex flex-col justify-between";const x=c.savedAt?.toDate().toLocaleString("fr-FR")||"Date inconnue",E=c.planData;let w="Plan vide ou sans donn√©es.";if(E&&E.weeks){const R=Object.keys(E.weeks).length;R>0&&(w=`Contient ${R} semaine(s).`)}const C=document.createElement("div");C.innerHTML=`
                <h3 class="text-lg font-bold text-gray-800 mb-2">${c.name}</h3>
                <p class="text-sm text-gray-500">Sauvegard√© le : ${x}</p>
                <p class="text-sm text-gray-600 mt-2">${w}</p>
            `;const b=document.createElement("div");b.className="mt-4 pt-4 border-t border-gray-200 flex items-center justify-end space-x-2";const T=document.createElement("button");T.className="btn btn-secondary btn-sm",T.textContent="Voir",T.addEventListener("click",()=>{localStorage.setItem("selectedPlanId",c.id),rt("view-plan")});const z=document.createElement("button");z.className="btn btn-primary btn-sm",z.textContent="Charger",z.addEventListener("click",()=>Un(c.id)),z.style.display="none";const f=document.createElement("button");f.className="btn btn-ghost text-red-500 hover:bg-red-100 btn-sm",f.innerHTML='<i class="fas fa-trash"></i>',f.title="Supprimer la sauvegarde",f.addEventListener("click",()=>Fn(c.id)),b.appendChild(f),b.appendChild(T),b.appendChild(z),p.appendChild(C),p.appendChild(b),e.appendChild(p)})});return()=>{a()}}const zn=Object.freeze(Object.defineProperty({__proto__:null,default:On},Symbol.toStringTag,{value:"Module"}));class Rt{constructor(t,n,a,i,o,c,p,x,E,w,C,b,T,z,f,R){this.db=t,this.modal=document.getElementById(n),this.form=document.getElementById(a),this.modalTitle=document.getElementById(i),this.recipeIdInput=document.getElementById(o),this.recipeNameInput=document.getElementById(c),this.recipeCategoryInput=document.getElementById(p),this.recipeServingsInput=document.getElementById(x),this.recipePrepTimeInput=document.getElementById(E),this.recipeDifficultyInput=document.getElementById(w),this.recipeImageUrlInput=document.getElementById("edit-recipe-image-url"),this.recipeStepsTextarea=document.getElementById(C),this.ingredientsListDiv=document.getElementById(b),this.addIngredientBtn=document.getElementById(T),this.saveRecipeBtn=document.getElementById(z),this.closeButton=document.getElementById(f),this.cancelButton=document.getElementById(R),this.masterIngredientList=[],this.activityUpdater=null,this.boundAddIngredient=()=>this.addIngredientInput(void 0,this.form.ingredients),this.boundCloseForm=()=>this.closeForm(),this.boundHandleSubmit=X=>this.handleSubmit(X),this.addIngredientBtn.addEventListener("click",this.boundAddIngredient),this.closeButton.addEventListener("click",this.boundCloseForm),this.cancelButton.addEventListener("click",this.boundCloseForm),this.saveRecipeBtn.addEventListener("click",this.boundHandleSubmit)}setActivityUpdater(t){this.activityUpdater=t}destroy(){this.addIngredientBtn.removeEventListener("click",this.boundAddIngredient),this.closeButton.removeEventListener("click",this.boundCloseForm),this.cancelButton.removeEventListener("click",this.boundCloseForm),this.saveRecipeBtn.removeEventListener("click",this.boundHandleSubmit)}async openForm(t=null,n="Ajouter une recette"){this.activityUpdater&&this.activityUpdater("editing_recipe"),await this.fetchMasterIngredients(),console.log("openForm called with recipe:",t,"and title:",n),this.form.reset(),this.ingredientsListDiv.innerHTML="",this.modalTitle.textContent=n;const a=[];if(this.form.ingredients=a,t){this.recipeIdInput.value=t.id||"",this.recipeNameInput.value=t.name||"";const i=t.category||"Plat";for(const o of this.recipeCategoryInput.options)if(o.value.toLowerCase()===i.toLowerCase()){o.selected=!0;break}this.recipeServingsInput.value=parseInt(t.servings)||"",this.recipePrepTimeInput.value=parseInt(t.prepTime)||"",this.recipeDifficultyInput.value=t.difficulty||"Moyen",this.recipeImageUrlInput.value=t.imageUrl||"",this.recipeStepsTextarea.value=t.steps||"",t.ingredients&&t.ingredients.length>0?t.ingredients.forEach(o=>this.addIngredientInput({...o},a)):this.addIngredientInput(void 0,a)}else this.recipeIdInput.value="",this.addIngredientInput(void 0,a);this.modal.classList.remove("hidden")}closeForm(){this.activityUpdater&&this.activityUpdater("idle"),this.modal.classList.add("hidden")}async fetchMasterIngredients(){if(this.masterIngredientList=[],!!this.db)try{const t=await he(U(this.db,"ingredients"));this.masterIngredientList=t.docs.map(n=>({id:n.id,...n.data()})),this.masterIngredientList.sort((n,a)=>n.name.localeCompare(a.name))}catch(t){console.error("Erreur lors de la r√©cup√©ration de la liste des ingr√©dients: ",t),alert("Impossible de charger la liste des ingr√©dients de base. La recherche ne fonctionnera pas.")}}addIngredientInput(t={quantity:"",name:"",unit:""},n){const a=document.createElement("div");a.className="relative flex items-stretch space-x-2 ingredient-row";const i={...t};n.push(i);const o=n.length-1,c=document.createElement("input");c.type="text",c.className="ingredient-quantity mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm",c.placeholder="Qt√©",c.value=i.quantity,c.addEventListener("change",b=>{n[o].quantity=b.target.value});const p=document.createElement("input");p.type="text",p.className="ingredient-unit mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm bg-gray-100",p.placeholder="Unit√©",p.readOnly=!0,p.value=i.unit||"";const x=document.createElement("div");x.className="relative w-1/2";const E=document.createElement("input");E.type="text",E.className="ingredient-name mt-1 block w-full rounded-md border-gray-300 shadow-sm",E.placeholder="Chercher un ingr√©dient...",E.value=i.name,x.appendChild(E);const w=document.createElement("div");w.className="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto",x.appendChild(w),E.addEventListener("input",()=>{const b=E.value.toLowerCase();if(!b){w.classList.add("hidden");return}const T=this.masterIngredientList.filter(f=>f.name.toLowerCase().includes(b));w.innerHTML="",T.forEach(f=>{const R=document.createElement("div");R.className="p-2 ingredient-search-item cursor-pointer",R.textContent=f.name,R.addEventListener("click",()=>{E.value=f.name,p.value=f.unit,w.classList.add("hidden"),n[o].name=f.name,n[o].unit=f.unit,n[o].id=f.id}),w.appendChild(R)});const z=document.createElement("div");z.className="p-2 bg-blue-50 hover:bg-blue-200 cursor-pointer font-bold text-blue-700",z.textContent=`+ Cr√©er "${E.value}"`,z.addEventListener("click",async()=>{const f=E.value,R="pi√®ce(s)";try{const X=await Ne(U(this.db,"ingredients"),{name:f,unit:R});await this.fetchMasterIngredients(),E.value=f,p.value=R,w.classList.add("hidden"),n[o].name=f,n[o].unit=R,n[o].id=X.id}catch(X){console.error("Erreur d'ajout d'ingr√©dient",X),alert("L'ingr√©dient n'a pas pu √™tre cr√©√©.")}}),w.appendChild(z),w.classList.remove("hidden")});const C=document.createElement("button");C.type="button",C.className="btn btn-ghost text-red-500 hover:bg-red-50 btn-sm mt-1",C.innerHTML='<i class="fas fa-trash"></i>',C.addEventListener("click",()=>{a.remove(),n[o]=null}),a.appendChild(x),a.appendChild(c),a.appendChild(p),a.appendChild(C),this.ingredientsListDiv.appendChild(a)}async handleSubmit(t){t.preventDefault(),this.saveRecipeBtn.disabled=!0,this.saveRecipeBtn.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i> Sauvegarde...',console.log("Ingredients array from form before filter:",this.form.ingredients);const n=this.form.ingredients.filter(o=>o!==null&&o.quantity&&o.name);console.log("Ingredients array after filter:",n);const a={name:this.recipeNameInput.value,category:this.recipeCategoryInput.value,servings:parseInt(this.recipeServingsInput.value)||0,prepTime:parseInt(this.recipePrepTimeInput.value)||0,difficulty:this.recipeDifficultyInput.value,steps:this.recipeStepsTextarea.value,ingredients:n,imageUrl:this.recipeImageUrlInput.value||`https://loremflickr.com/400/300/${encodeURIComponent(this.recipeNameInput.value)}`};console.log("Recipe data being sent to Firebase:",a);const i=this.recipeIdInput.value;try{i?await ct(_(this.db,"recipes",i),a):await Ne(U(this.db,"recipes"),a),this.closeForm(),console.log("Recipe saved successfully!"),this.onSaveCallback&&this.onSaveCallback()}catch(o){console.error("Erreur de sauvegarde: ",o),alert("Une erreur est survenue lors de la sauvegarde.")}finally{this.saveRecipeBtn.disabled=!1,this.saveRecipeBtn.textContent="Sauvegarder"}}setOnSaveCallback(t){this.onSaveCallback=t}}const Vn=Object.freeze(Object.defineProperty({__proto__:null,RecipeFormHandler:Rt},Symbol.toStringTag,{value:"Module"}));let Tt=()=>{};function Qn(){const e=document.getElementById("search-friends-input");return document.getElementById("search-friends-btn").addEventListener("click",()=>Jt(e.value)),e.addEventListener("keyup",n=>{n.key==="Enter"&&Jt(e.value)}),Wn(),tn(),()=>{Tt&&Tt()}}async function Wn(){const e=document.getElementById("friends-list-container"),t=He()?.uid;if(!t||!e)return;e.innerHTML='<p class="text-gray-500">Chargement...</p>';const n=_(y,"users",t);Tt=Fe(n,async a=>{if(!a.exists()){e.innerHTML='<p class="text-red-500">Erreur: Utilisateur non trouv√©.</p>';return}const i=a.data().friends||[];if(e.innerHTML="",i.length===0){e.innerHTML=`<p class="text-gray-500">Vous n'avez pas encore d'amis. Utilisez la recherche pour en ajouter.</p>`;return}for(const o of i)try{const c=await Le(_(y,"users",o));c.exists()&&e.appendChild(Jn(c.data()))}catch(c){console.error("Erreur de chargement d'un ami",c)}})}function Jn(e){const t=document.createElement("div");t.className="bg-white p-3 rounded-lg flex items-center justify-between shadow-sm";const n=document.createElement("div");n.className="flex items-center",n.innerHTML=`
        <img src="${e.photoURL||"https://placehold.co/40"}" alt="Avatar" class="w-10 h-10 rounded-full mr-3">
        <div>
            <p class="font-bold">${e.displayName}</p>
            <p class="text-sm text-gray-500">${e.email}</p>
        </div>
    `;const a=document.createElement("button");return a.className="btn btn-ghost text-red-500 btn-sm",a.innerHTML='<i class="fas fa-user-times"></i>',a.title="Retirer cet ami",a.addEventListener("click",()=>Gn(e.uid)),t.appendChild(n),t.appendChild(a),t}async function Gn(e){const t=He()?.uid;if(!t||!e){console.error("Impossible de supprimer l'ami : ID utilisateur ou ID ami manquant.");return}if(!confirm("Voulez-vous vraiment retirer cet ami ? Cette action est unilat√©rale."))return;console.log(`Tentative de suppression de l'ami ${e} pour l'utilisateur ${t}`);const n=_(y,"users",t);try{await Te(n,{friends:Kt(e)}),console.log("Ami supprim√© avec succ√®s de la base de donn√©es.")}catch(a){console.error("Erreur lors de la suppression de l'ami: ",a),alert("Une erreur est survenue.")}}async function Jt(e){const t=document.getElementById("search-results-container"),n=He()?.uid;if(!(!e||!t)){t.innerHTML='<p class="text-gray-500">Recherche en cours...</p>';try{const a=e.toLowerCase(),i=a+"Ô£ø",o=pe(U(y,"users"),ee("displayName_lowercase",">=",a),ee("displayName_lowercase","<",i)),c=pe(U(y,"users"),ee("email","==",a)),[p,x]=await Promise.all([he(o),he(c)]),E=new Map;if(p.forEach(w=>E.set(w.id,w.data())),x.forEach(w=>E.set(w.id,w.data())),t.innerHTML="",E.size===0){t.innerHTML='<p class="text-gray-500">Aucun utilisateur trouv√©.</p>';return}E.forEach(w=>{if(w.uid===n)return;const C=document.createElement("div");C.className="bg-gray-50 p-2 rounded-lg flex items-center justify-between",C.innerHTML=`
                <div class="flex items-center">
                    <img src="${w.photoURL||"https://placehold.co/32"}" class="w-8 h-8 rounded-full mr-2">
                    <span class="font-medium text-sm">${w.displayName} (${w.email})</span>
                </div>
            `;const b=document.createElement("button");b.className="btn btn-secondary btn-xs",b.innerHTML='<i class="fas fa-user-plus"></i>',b.addEventListener("click",()=>Xn(w.uid)),C.appendChild(b),t.appendChild(C)})}catch(a){console.error("Erreur de recherche: ",a),t.innerHTML='<p class="text-red-500">Erreur de recherche.</p>'}}}async function Xn(e){const t=He()?.uid;if(!t||t===e)return;const n=pe(U(y,"friend_requests"),ee("senderId","==",t),ee("receiverId","==",e)),a=pe(U(y,"friend_requests"),ee("senderId","==",e),ee("receiverId","==",t)),[i,o]=await Promise.all([he(n),he(a)]);if(!i.empty||!o.empty)return alert("Une demande d'ami existe d√©j√† avec cet utilisateur.");if((await Le(_(y,"users",t))).data()?.friends?.includes(e))return alert("Vous √™tes d√©j√† ami avec cet utilisateur.");try{await Ne(U(y,"friend_requests"),{senderId:t,receiverId:e,status:"pending",createdAt:ht()}),alert("Demande d'ami envoy√©e !")}catch(p){console.error("Erreur lors de l'envoi de la demande d'ami: ",p),alert("Une erreur est survenue.")}}async function tn(){const e=document.getElementById("pending-requests-container"),t=document.getElementById("declined-requests-container"),n=He()?.uid;if(!(!n||!e||!t)){e.innerHTML='<p class="text-gray-500">Chargement...</p>',t.innerHTML='<p class="text-gray-500">Chargement...</p>';try{const a=pe(U(y,"friend_requests"),ee("senderId","==",n)),i=await he(a),o=[],c=[];for(const p of i.docs){const x={id:p.id,...p.data()},E=await Le(_(y,"users",x.receiverId));E.exists()&&(x.receiver=E.data()),x.status==="pending"?o.push(x):x.status==="declined"&&c.push(x)}e.innerHTML="",o.length>0?o.forEach(p=>e.appendChild(Gt(p))):e.innerHTML='<p class="text-gray-500">Aucune demande en attente.</p>',t.innerHTML="",c.length>0?c.forEach(p=>t.appendChild(Gt(p))):t.innerHTML='<p class="text-gray-500">Aucune demande rejet√©e.</p>'}catch(a){console.error("Erreur lors du chargement des demandes envoy√©es: ",a),e.innerHTML='<p class="text-red-500">Erreur de chargement.</p>',t.innerHTML='<p class="text-red-500">Erreur de chargement.</p>'}}}function Gt(e){const t=document.createElement("div");t.className="bg-white p-3 rounded-lg flex items-center justify-between shadow-sm";const n=e.receiver,a=document.createElement("div");a.className="flex items-center",a.innerHTML=`
        <img src="${n?.photoURL||"https://placehold.co/40"}" alt="Avatar" class="w-10 h-10 rounded-full mr-3">
        <div>
            <p class="font-bold">${n?.displayName||"Utilisateur inconnu"}</p>
            <p class="text-sm text-gray-500">Statut : <span class="font-medium">${e.status}</span></p>
        </div>
    `;const i=document.createElement("button");return i.className="btn btn-ghost text-red-500 btn-sm",i.innerHTML='<i class="fas fa-times-circle"></i>',i.title="Annuler la demande",i.addEventListener("click",async()=>{confirm("Voulez-vous vraiment annuler cette demande ?")&&(await Ae(_(y,"friend_requests",e.id)),tn())}),t.appendChild(a),t.appendChild(i),t}async function nn(e){try{const t=_(y,"friend_requests",e);await Te(t,{status:"accepted"})}catch(t){throw console.error("Erreur lors de l'acceptation de la demande d'ami: ",t),t}}async function an(e){try{const t=_(y,"friend_requests",e);await Te(t,{status:"declined"})}catch(t){throw console.error("Erreur lors du refus de la demande d'ami: ",t),t}}const Yn=Object.freeze(Object.defineProperty({__proto__:null,acceptFriendRequest:nn,declineFriendRequest:an,default:Qn},Symbol.toStringTag,{value:"Module"}));function Kn(){const e=document.getElementById("ingredients-list-container"),t=document.getElementById("add-ingredient-btn"),n=document.getElementById("category-tabs"),a=document.getElementById("search-bar"),i=document.getElementById("ingredient-form-modal"),o=document.getElementById("ingredient-modal-title"),c=document.getElementById("close-ingredient-modal"),p=document.getElementById("cancel-ingredient-btn"),x=document.getElementById("ingredient-form"),E=document.getElementById("ingredient-id"),w=document.getElementById("ingredient-name"),C=document.getElementById("ingredient-unit"),b=document.getElementById("ingredient-category"),T=document.getElementById("manage-categories-btn"),z=document.getElementById("category-management-modal"),f=document.getElementById("close-category-modal"),R=document.getElementById("done-category-modal-btn"),X=document.getElementById("add-category-form"),De=document.getElementById("new-category-name"),q=document.getElementById("category-list");let j=[],N=[],O="",Y="",Ce=null;const xe=["g","kg","ml","l","pi√®ce(s)","c.√†.s.","c.√†.c.","pinc√©e(s)"];async function Ee(){await Ie(),await we()}async function Ie(){if(y)try{N=(await he(U(y,"ingredient_categories"))).docs.map(P=>({id:P.id,...P.data()})),N.sort((P,M)=>P.name.localeCompare(M.name))}catch(A){console.error("Erreur lors de la r√©cup√©ration des cat√©gories: ",A)}}async function we(){if(y)try{j=(await he(U(y,"ingredients"))).docs.map(P=>({id:P.id,...P.data()})),G(),ie()}catch(A){console.error("Erreur de chargement des ingr√©dients: ",A)}}function Pe(A=null){x.reset(),C.innerHTML="",xe.forEach($=>{const te=document.createElement("option");te.value=$,te.textContent=$,C.appendChild(te)});const P=N.map($=>$.name),M=[...new Set(j.map($=>$.category).filter(Boolean))],B=[...new Set([...P,...M])];B.sort(($,te)=>$.localeCompare(te.name)),b.innerHTML="",B.forEach($=>{const te=document.createElement("option");te.value=$,te.textContent=$,b.appendChild(te)}),A?(o.textContent="Modifier l'ingr√©dient",E.value=A.id,w.value=A.name,C.value=A.unit||"",b.value=A.category||(B.length>0?B[0]:""),document.getElementById("ingredient-image-url").value=A.imageUrl||""):(o.textContent="Ajouter un ingr√©dient",E.value="",C.value=xe[0],b.value=O||(B.length>0?B[0]:"")),i.classList.remove("hidden")}function Ue(){i.classList.add("hidden")}async function F(A){A.preventDefault();const P=E.value,M={name:w.value,unit:C.value,category:b.value,imageUrl:document.getElementById("ingredient-image-url").value||`https://loremflickr.com/400/300/${encodeURIComponent(w.value)}`};if(!M.name||!M.category){alert("Le nom et la cat√©gorie sont requis.");return}try{P?await ct(_(y,"ingredients",P),M):await Ne(U(y,"ingredients"),M),Ue(),await we()}catch(B){console.error("Erreur de sauvegarde de l'ingr√©dient: ",B)}}function S(){J(),z.classList.remove("hidden")}function W(){z.classList.add("hidden")}function J(){if(q.innerHTML="",N.length===0){q.innerHTML='<p class="text-gray-500">Aucune cat√©gorie d√©finie.</p>';return}N.forEach(A=>{const P=document.createElement("div");P.className="flex items-center justify-between p-2 border-b";const M=document.createElement("span");M.textContent=A.name,P.appendChild(M);const B=document.createElement("div");B.className="flex space-x-2";const $=document.createElement("button");$.className="btn btn-ghost btn-xs text-blue-500",$.innerHTML='<i class="fas fa-edit"></i>',$.addEventListener("click",()=>Z(A)),B.appendChild($);const te=document.createElement("button");te.className="btn btn-ghost btn-xs text-red-500",te.innerHTML='<i class="fas fa-trash"></i>',te.addEventListener("click",()=>fe(A)),B.appendChild(te),P.appendChild(B),q.appendChild(P)})}async function K(A){A.preventDefault();const P=De.value.trim();if(P&&!N.find(M=>M.name.toLowerCase()===P.toLowerCase()))try{await Ne(U(y,"ingredient_categories"),{name:P}),De.value="",await Ie(),J(),G()}catch(M){console.error("Erreur d'ajout de cat√©gorie: ",M)}else alert("Cette cat√©gorie existe d√©j√† ou le nom est invalide.")}async function Z(A){const P=A.name,M=prompt(`Entrez le nouveau nom pour la cat√©gorie "${P}":`,P);if(M&&M.trim()!==""&&M!==P)try{await ct(_(y,"ingredient_categories",A.id),{name:M});const B=pe(U(y,"ingredients"),ee("category","==",P)),$=await he(B),te=Qt(y);$.forEach(We=>{te.update(We.ref,{category:M})}),await te.commit(),await Ee(),J()}catch(B){console.error("Erreur de renommage: ",B)}}async function fe(A){if(confirm(`√ätes-vous s√ªr de vouloir supprimer la cat√©gorie "${A.name}"?

Tous les ingr√©dients associ√©s seront d√©plac√©s vers la cat√©gorie "Inconnue".`))try{await Ae(_(y,"ingredient_categories",A.id));const P=pe(U(y,"ingredients"),ee("category","==",A.name)),M=await he(P),B=Qt(y);M.forEach($=>{B.update($.ref,{category:"Inconnue"})}),await B.commit(),O="",await Ee(),J()}catch(P){console.error("Erreur de suppression: ",P)}}function G(){n.innerHTML="";const A=N.map(B=>B.name),P=[...new Set(j.map(B=>B.category||"Inconnue"))];let M=[...new Set([...A,...P])];M.sort((B,$)=>B.localeCompare($)),M.includes("Inconnue")&&(M=M.filter(B=>B!=="Inconnue"),M.push("Inconnue")),M.length===0&&j.length>0&&M.push("Inconnue"),!O&&M.length>0&&(O=M[0]),M.forEach(B=>{const $=document.createElement("button"),te=B===O;$.className=`px-4 py-2 text-sm font-medium rounded-t-lg ${te?"bg-tomato text-white":"text-gray-500 hover:text-tomato"}`,$.textContent=B,$.addEventListener("click",()=>re(B)),n.appendChild($)})}function re(A){O=A,G(),ie()}function ie(){e.innerHTML="";const A=O||(N.length>0?N[0].name:"Inconnue");let P=j.filter(B=>(B.category||"Inconnue")===A);if(Y){const B=Y.toLowerCase();P=P.filter($=>$.name.toLowerCase().includes(B))}if(P.length===0){e.innerHTML='<p class="text-center text-gray-500 p-10">Aucun ingr√©dient dans cette cat√©gorie.</p>';return}P.sort((B,$)=>B.name.localeCompare($.name,"fr",{sensitivity:"base"}));const M=document.createElement("div");M.className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4",P.forEach(B=>{const $=document.createElement("div");if($.className="p-3 bg-white shadow-sm rounded-lg flex flex-col items-start space-y-2",B.imageUrl){const et=document.createElement("img");et.src=B.imageUrl,et.alt=B.name,et.className="w-full h-24 object-cover rounded-md mb-2",$.appendChild(et)}const te=document.createElement("div");te.className="flex-grow w-full flex justify-between items-center";const We=document.createElement("span");We.className="font-medium text-gray-800",We.textContent=B.name;const Ye=document.createElement("span");Ye.className="text-gray-500 text-sm bg-gray-100 px-2 py-1 rounded-full",Ye.textContent=B.unit,te.appendChild(We),te.appendChild(Ye);const Je=document.createElement("div");Je.className="w-full flex justify-end items-center space-x-2 border-t pt-2 mt-2";const Ke=document.createElement("button");Ke.className="btn btn-ghost btn-xs text-blue-500 hover:bg-blue-50",Ke.innerHTML='<i class="fas fa-edit"></i>',Ke.addEventListener("click",()=>Pe(B));const Ze=document.createElement("button");Ze.className="btn btn-ghost btn-xs text-red-500 hover:bg-red-50",Ze.innerHTML='<i class="fas fa-trash-alt"></i>',Ze.addEventListener("click",()=>Se(B.id,B.name)),Je.appendChild(Ke),Je.appendChild(Ze),$.appendChild(te),$.appendChild(Je),M.appendChild($)}),e.appendChild(M)}async function Se(A,P){if(confirm(`√ätes-vous s√ªr de vouloir supprimer l'ingr√©dient "${P}" ?`))try{await Ae(_(y,"ingredients",A)),await we()}catch(M){console.error("Erreur de suppression de l'ingr√©dient: ",M)}}a.addEventListener("input",A=>{const P=A.target.value.toLowerCase();if(!Y&&P&&(Ce=O),Y=P,Y){const M=j.find(B=>B.name.toLowerCase().includes(Y));M&&(O=M.category||"Inconnue")}else Ce&&(O=Ce,Ce=null);G(),ie()}),t.addEventListener("click",()=>Pe()),c.addEventListener("click",Ue),p.addEventListener("click",Ue),x.addEventListener("submit",F),T.addEventListener("click",S),f.addEventListener("click",W),R.addEventListener("click",W),X.addEventListener("submit",K),Ee()}const Zn=Object.freeze(Object.defineProperty({__proto__:null,default:Kn},Symbol.toStringTag,{value:"Module"})),V={modal:document.getElementById("share-modal"),closeBtn:document.getElementById("close-share-modal"),title:document.getElementById("share-modal-title"),friendsList:document.getElementById("share-friends-list"),sharePlanCheckbox:document.getElementById("share-planning-checkbox"),shareShoppingListCheckbox:document.getElementById("share-shopping-list-checkbox"),confirmBtn:document.getElementById("confirm-share-btn")};let qe={};function xt(){V.modal.classList.add("hidden");const e=document.getElementById("share-mode-selection");e&&e.classList.remove("hidden"),V.confirmBtn.textContent="Envoyer le partage";const t=V.confirmBtn.cloneNode(!0);V.confirmBtn.parentNode&&(V.confirmBtn.parentNode.replaceChild(t,V.confirmBtn),V.confirmBtn=t,t.addEventListener("click",sn))}async function sn(){const e=ye();if(!e||!qe.plan)return;const t=Array.from(V.friendsList.querySelectorAll('input[type="checkbox"]:checked')).map(a=>a.value),n=document.querySelector('input[name="share-mode"]:checked')?.value;if(t.length===0){alert("Veuillez s√©lectionner au moins un ami.");return}if(!n){alert("Veuillez s√©lectionner un mode de partage.");return}V.confirmBtn.disabled=!0,V.confirmBtn.textContent="Envoi en cours...";try{const a=U(y,"shares");let i={};n==="collaborate"?i={senderId:e,createdAt:new Date,type:"collaborative_plan_invite",planId:qe.plan.id,planName:qe.plan.name}:i={senderId:e,createdAt:new Date,type:"share",plan:{name:qe.plan.name,weeks:qe.plan.weeks||{},manualItems:qe.plan.manualItems||[],defaultNumPeople:qe.plan.defaultNumPeople||1,startDay:qe.plan.startDay||"Lundi"}};for(const o of t)await Ne(a,{...i,receiverId:o,status:"pending"});xt(),alert("Partage envoy√© avec succ√®s !")}catch(a){console.error("Erreur lors de l'envoi du partage : ",a),alert("Une erreur est survenue lors de l'envoi du partage.")}finally{V.confirmBtn.disabled=!1,V.confirmBtn.textContent="Envoyer le partage"}}async function jt(e={}){const{plan:t}=e;if(!t){alert("Aucun plan s√©lectionn√© √† partager.");return}qe={plan:t},V.title.textContent=`Partager le plan "${t.name}"`,V.friendsList.innerHTML='<p class="text-gray-500">Chargement des amis...</p>',V.modal.classList.remove("hidden");const n=ye();if(n)try{const a=await Le(_(y,"users",n));if(a.exists()){const o=a.data().friends||[];if(o.length===0){V.friendsList.innerHTML=`<p class="text-gray-500">Vous n'avez pas d'amis √† qui partager.</p>`;return}V.friendsList.innerHTML="";for(const c of o){const p=await Le(_(y,"users",c));if(p.exists()){const x=p.data(),E=document.createElement("label");E.className="flex items-center p-2 hover:bg-gray-100 rounded-lg cursor-pointer";const w=document.createElement("input");w.type="checkbox",w.value=x.uid,w.className="form-checkbox h-5 w-5 text-tomato rounded focus:ring-tomato",E.appendChild(w);const C=document.createElement("img");C.src=x.photoURL||"https://placehold.co/40x40",C.alt=x.displayName,C.className="w-8 h-8 rounded-full ml-3 mr-3",E.appendChild(C);const b=document.createElement("span");b.className="font-medium",b.textContent=x.displayName||x.email,E.appendChild(b),V.friendsList.appendChild(E)}}}}catch(a){console.error("Erreur lors du chargement des amis pour le partage : ",a),V.friendsList.innerHTML='<p class="text-red-500">Une erreur est survenue.</p>'}}async function ea(e){const t=ye();if(!t||!e)return;const n=Array.from(V.friendsList.querySelectorAll('input[type="checkbox"]:checked:not(:disabled)')).map(a=>a.value);if(n.length===0){alert("Veuillez s√©lectionner au moins un ami √† inviter.");return}V.confirmBtn.disabled=!0,V.confirmBtn.textContent="Envoi en cours...";try{const a=await Le(_(y,"plans",e));if(!a.exists())throw new Error("Plan not found");const i=a.data().name,o=U(y,"shares"),c={senderId:t,createdAt:new Date,type:"collaborative_plan_invite",planId:e,planName:i};for(const p of n)await Ne(o,{...c,receiverId:p,status:"pending"});xt(),alert("Invitation(s) envoy√©e(s) avec succ√®s !")}catch(a){console.error("Erreur lors de l'envoi de l'invitation : ",a),alert("Une erreur est survenue lors de l'envoi de l'invitation.")}finally{V.confirmBtn.disabled=!1}}async function rn(e){if(!e||!e.id){alert("Plan non valide pour l'invitation.");return}qe={plan:e},V.title.textContent=`Inviter √† collaborer sur "${e.name}"`;const t=document.getElementById("share-mode-selection");t&&t.classList.add("hidden"),V.friendsList.innerHTML='<p class="text-gray-500">Chargement des amis...</p>',V.modal.classList.remove("hidden");const n=ye();if(!n)return;try{const i=await Le(_(y,"users",n));if(i.exists()){const c=i.data().friends||[],p=[e.userId,...e.collaborators||[]];if(c.length===0){V.friendsList.innerHTML=`<p class="text-gray-500">Vous n'avez pas d'amis √† inviter.</p>`;return}V.friendsList.innerHTML="";for(const x of c){const E=await Le(_(y,"users",x));if(E.exists()){const w=E.data(),C=p.includes(w.uid),b=document.createElement("label");b.className=`flex items-center p-2 rounded-lg ${C?"opacity-50 cursor-not-allowed":"hover:bg-gray-100 cursor-pointer"}`;const T=document.createElement("input");T.type="checkbox",T.value=w.uid,T.className="form-checkbox h-5 w-5 text-tomato rounded focus:ring-tomato",C&&(T.disabled=!0,T.checked=!0),b.appendChild(T);const z=document.createElement("img");z.src=w.photoURL||"https://placehold.co/40x40",z.alt=w.displayName,z.className="w-8 h-8 rounded-full ml-3 mr-3",b.appendChild(z);const f=document.createElement("span");if(f.className="font-medium",f.textContent=w.displayName||w.email,C){const R=document.createElement("span");R.className="text-xs text-gray-400 ml-2",R.textContent="(d√©j√† membre)",f.appendChild(R)}b.appendChild(f),V.friendsList.appendChild(b)}}}}catch(i){console.error("Erreur lors du chargement des amis pour l'invitation : ",i),V.friendsList.innerHTML='<p class="text-red-500">Une erreur est survenue.</p>'}V.confirmBtn.textContent="Envoyer l'invitation";const a=V.confirmBtn.cloneNode(!0);V.confirmBtn.parentNode.replaceChild(a,V.confirmBtn),V.confirmBtn=a,a.addEventListener("click",()=>ea(e.id))}V.closeBtn?.addEventListener("click",xt);V.modal?.addEventListener("click",e=>{e.target===V.modal&&xt()});V.confirmBtn?.addEventListener("click",sn);const ta=Object.freeze(Object.defineProperty({__proto__:null,openInviteParticipantModal:rn,openShareModal:jt},Symbol.toStringTag,{value:"Module"}));function na(){const e=document.getElementById("search-bar"),t=document.getElementById("lists-container"),n=document.getElementById("add-list-btn"),a=document.getElementById("shared-lists-container"),i=document.getElementById("list-form-modal"),o=document.getElementById("list-modal-title"),c=document.getElementById("close-list-modal"),p=document.getElementById("cancel-list-btn"),x=document.getElementById("list-form"),E=document.getElementById("list-id"),w=document.getElementById("list-name"),C=document.getElementById("ingredients-list"),b=document.getElementById("add-ingredient-btn"),T=document.getElementById("save-list-btn");let z=[],f="",R=[],X=[];async function De(){await q(),await j(),await N()}async function q(){if(y)try{R=(await he(U(y,"ingredients"))).docs.map(S=>({id:S.id,...S.data()})),R.sort((S,W)=>S.name.localeCompare(W.name))}catch(F){console.error("Erreur lors de la r√©cup√©ration de la liste des ingr√©dients: ",F)}}async function j(){const F=ye();if(!(!y||!F))try{const S=pe(U(y,"shopping_lists"),ee("userId","==",F));z=(await he(S)).docs.map(J=>({id:J.id,...J.data()})).filter(J=>J.isShared!==!0),Ee()}catch(S){console.error("Erreur de chargement des listes: ",S)}}async function N(){const F=ye();if(!(!y||!F)){console.log(`Recherche de listes partag√©es pour userId: ${F}`);try{const S=pe(U(y,"shopping_lists"),ee("userId","==",F),ee("isShared","==",!0)),W=await he(S);console.log(`Trouv√© ${W.size} liste(s) partag√©e(s).`);const J=W.docs.map(K=>({id:K.id,...K.data()}));Ie(J)}catch(S){console.error("Erreur de chargement des listes partag√©es: ",S)}}}async function O(F=null){await q(),x.reset(),C.innerHTML="",X=[],F?(o.textContent="Modifier la liste",E.value=F.id,w.value=F.name,F.ingredients&&F.ingredients.length>0?F.ingredients.forEach(S=>xe(S)):xe()):(o.textContent="Cr√©er une liste",E.value="",xe()),i.classList.remove("hidden")}function Y(){i.classList.add("hidden")}async function Ce(F){F.preventDefault(),T.disabled=!0;const S=ye();if(!S){alert("Erreur : utilisateur non connect√©."),T.disabled=!1;return}const W=X.filter(Z=>Z&&Z.name&&Z.quantity),J={name:w.value,ingredients:W,userId:S};if(!J.name){alert("Le nom de la liste est requis."),T.disabled=!1;return}const K=E.value;try{K?await ct(_(y,"shopping_lists",K),J):await Ne(U(y,"shopping_lists"),J),Y(),await j()}catch(Z){console.error("Erreur de sauvegarde de la liste: ",Z)}finally{T.disabled=!1}}function xe(F={quantity:"",name:"",unit:""}){const S=document.createElement("div");S.className="relative flex items-stretch space-x-2 ingredient-row";const W={...F};X.push(W);const J=X.length-1,K=document.createElement("input");K.type="text",K.className="ingredient-quantity mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm",K.placeholder="Qt√©",K.value=W.quantity,K.addEventListener("change",Se=>{X[J].quantity=Se.target.value});const Z=document.createElement("input");Z.type="text",Z.className="ingredient-unit mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm bg-gray-100",Z.placeholder="Unit√©",Z.readOnly=!0,Z.value=W.unit||"";const fe=document.createElement("div");fe.className="relative w-1/2";const G=document.createElement("input");G.type="text",G.className="ingredient-name mt-1 block w-full rounded-md border-gray-300 shadow-sm",G.placeholder="Chercher un ingr√©dient...",G.value=W.name,fe.appendChild(G);const re=document.createElement("div");re.className="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto",fe.appendChild(re),G.addEventListener("input",()=>{const Se=G.value.toLowerCase();if(!Se){re.classList.add("hidden");return}const A=R.filter(M=>M.name.toLowerCase().includes(Se));re.innerHTML="",A.forEach(M=>{const B=document.createElement("div");B.className="p-2 ingredient-search-item cursor-pointer",B.textContent=M.name,B.addEventListener("click",()=>{G.value=M.name,Z.value=M.unit,re.classList.add("hidden"),X[J].name=M.name,X[J].unit=M.unit,X[J].id=M.id}),re.appendChild(B)});const P=document.createElement("div");P.className="p-2 bg-blue-50 hover:bg-blue-200 cursor-pointer font-bold text-blue-700",P.textContent=`+ Cr√©er "${G.value}"`,P.addEventListener("click",async()=>{const M=G.value,B="pi√®ce(s)";try{const $=await Ne(U(y,"ingredients"),{name:M,unit:B,category:"Inconnue"});await q(),G.value=M,Z.value=B,re.classList.add("hidden"),X[J].name=M,X[J].unit=B,X[J].id=$.id}catch($){console.error("Erreur d'ajout d'ingr√©dient",$),alert("L'ingr√©dient n'a pas pu √™tre cr√©√©.")}}),re.appendChild(P),re.classList.remove("hidden")});const ie=document.createElement("button");ie.type="button",ie.className="btn btn-ghost text-red-500 hover:bg-red-50 btn-sm mt-1",ie.innerHTML='<i class="fas fa-trash"></i>',ie.addEventListener("click",()=>{S.remove(),X[J]=null}),S.appendChild(fe),S.appendChild(K),S.appendChild(Z),S.appendChild(ie),C.appendChild(S)}function Ee(){t.innerHTML="";let F=z;if(f){const S=f.toLowerCase();F=z.filter(W=>W.name.toLowerCase().includes(S))}if(F.length===0){t.innerHTML='<p class="text-center text-gray-500 p-10 col-span-full">Aucune liste de courses trouv√©e.</p>';return}F.sort((S,W)=>S.name.localeCompare(W.name)),F.forEach(S=>{const W=document.createElement("div");W.className="bg-white rounded-lg shadow-md p-4 flex flex-col";const J=document.createElement("div");J.className="flex justify-between items-start border-b pb-2 mb-2";const K=document.createElement("h4");K.className="text-lg font-bold text-gray-800",K.textContent=S.name,J.appendChild(K);const Z=document.createElement("div");Z.className="flex space-x-2";const fe=document.createElement("button");fe.className="btn btn-ghost btn-sm text-blue-500",fe.innerHTML='<i class="fas fa-edit"></i>',fe.addEventListener("click",()=>O(S)),Z.appendChild(fe);const G=document.createElement("button");G.className="btn btn-ghost btn-sm text-green-500",G.innerHTML='<i class="fas fa-share-alt"></i>',G.addEventListener("click",()=>jt({})),Z.appendChild(G);const re=document.createElement("button");re.className="btn btn-ghost btn-sm text-red-500",re.innerHTML='<i class="fas fa-trash"></i>',re.addEventListener("click",()=>we(S.id,S.name)),Z.appendChild(re),J.appendChild(Z);const ie=document.createElement("ul");ie.className="space-y-1 text-sm text-gray-600 flex-grow",S.ingredients&&S.ingredients.length>0?S.ingredients.forEach(Se=>{const A=document.createElement("li");A.textContent=`${Se.quantity} ${Se.unit||""} - ${Se.name}`.trim(),ie.appendChild(A)}):ie.innerHTML='<li class="italic text-gray-400">Cette liste est vide.</li>',W.appendChild(J),W.appendChild(ie),t.appendChild(W)})}function Ie(F){if(a.innerHTML="",F.length===0){a.innerHTML='<p class="text-center text-gray-500 p-10 col-span-full">Aucune liste de courses partag√©e trouv√©e.</p>';return}F.sort((S,W)=>S.name.localeCompare(W.name)),F.forEach(S=>{const W=document.createElement("div");W.className="bg-white rounded-lg shadow-md p-4 flex flex-col";const J=document.createElement("div");J.className="flex justify-between items-start border-b pb-2 mb-2";const K=document.createElement("h4");K.className="text-lg font-bold text-gray-800",K.textContent=S.name,J.appendChild(K);const Z=document.createElement("div");Z.className="flex space-x-2";const fe=document.createElement("button");fe.className="btn btn-secondary btn-sm",fe.innerHTML='<i class="fas fa-copy mr-2"></i> Copier dans mes listes',fe.title="Copier cette liste dans vos listes personnelles",fe.addEventListener("click",()=>Ue(S.id)),Z.appendChild(fe);const G=document.createElement("button");G.className="btn btn-ghost btn-sm text-red-500",G.innerHTML='<i class="fas fa-trash"></i>',G.title="Supprimer cette liste partag√©e",G.addEventListener("click",()=>Pe(S.id,S.name)),Z.appendChild(G),J.appendChild(Z);const re=document.createElement("ul");re.className="space-y-1 text-sm text-gray-600 flex-grow",S.ingredients&&S.ingredients.length>0?S.ingredients.forEach(ie=>{const Se=document.createElement("li");Se.textContent=`${ie.quantity} ${ie.unit||""} - ${ie.name}`.trim(),re.appendChild(Se)}):re.innerHTML='<li class="italic text-gray-400">Cette liste est vide.</li>',W.appendChild(J),W.appendChild(re),a.appendChild(W)})}async function we(F,S){if(confirm(`√ätes-vous s√ªr de vouloir supprimer la liste "${S}" ?`))try{await Ae(_(y,"shopping_lists",F)),await j()}catch(W){console.error("Erreur de suppression de la liste: ",W)}}async function Pe(F,S){if(confirm(`√ätes-vous s√ªr de vouloir supprimer la liste partag√©e "${S}" ?`))try{await Ae(_(y,"shopping_lists",F)),await N()}catch(W){console.error("Erreur de suppression de la liste partag√©e: ",W),alert("Une erreur est survenue.")}}async function Ue(F){if(confirm("Voulez-vous vraiment copier cette liste dans vos listes personnelles ? Elle ne sera plus consid√©r√©e comme une liste partag√©e."))try{const S=_(y,"shopping_lists",F);await Te(S,{isShared:!1}),await De()}catch(S){console.error("Erreur lors de la copie de la liste: ",S),alert("Une erreur est survenue.")}}e.addEventListener("input",F=>{f=F.target.value,Ee()}),n.addEventListener("click",()=>O()),c.addEventListener("click",Y),p.addEventListener("click",Y),x.addEventListener("submit",Ce),b.addEventListener("click",()=>xe()),y&&De()}const aa=Object.freeze(Object.defineProperty({__proto__:null,default:na},Symbol.toStringTag,{value:"Module"})),je=Mn();let ut,Ct,It,lt,ce,mt,Bt,kt,dt,Xe,pt,St,Mt,Dt,Pt,bt=null,yt=null;function _t(){ut&&ut.classList.remove("hidden")}function it(){ut&&ut.classList.add("hidden"),lt&&lt.reset()}function on(e,t){yt=e,Xe&&(Xe.value=t),mt&&mt.classList.remove("hidden"),Xe&&Xe.focus()}function ot(){yt=null,mt&&mt.classList.add("hidden"),dt&&dt.reset()}function ln(e,t){bt=e,Dt&&(Dt.textContent="Confirmer la suppression"),Pt&&(Pt.textContent=`√ätes-vous s√ªr de vouloir supprimer le plan "${t}" ? Cette action est irr√©versible.`),pt&&pt.classList.remove("hidden")}function Nt(){bt=null,pt&&pt.classList.add("hidden")}async function sa(e){const t=He();if(t)try{await Ne(U(je,"plans"),{userId:t.uid,name:e,type:"personal",weeks:{},manualItems:[],defaultNumPeople:1,startDay:"Lundi",lastUpdated:new Date}),it()}catch(n){console.error("Error creating plan: ",n),alert("Erreur lors de la cr√©ation du plan.")}}async function ra(e,t){if(!(!e||!t))try{const n=_(je,"plans",e);await Te(n,{name:t}),ot()}catch(n){console.error("Error renaming plan: ",n),alert("Erreur lors du renommage du plan.")}}async function ia(e){const t=He()?.uid;if(!(!e||!t)&&confirm("Voulez-vous vraiment quitter ce plan partag√© ? Il n'appara√Ætra plus dans votre liste."))try{const n=_(je,"plans",e);await Te(n,{collaborators:Kt(t)})}catch(n){console.error("Erreur pour quitter le plan: ",n),alert("Une erreur est survenue.")}}async function oa(e){if(e)try{await Ae(_(je,"plans",e))}catch(t){console.error("Error deleting plan: ",t),alert("Erreur lors de la suppression du plan.")}}function dn(e){const t=He();if(!t)return()=>{};let n=new Map;const a=()=>{e(Array.from(n.values()).sort((E,w)=>E.name.localeCompare(w.name)))},i=async E=>{const C=[E.userId,...E.collaborators||[]].map(T=>Le(_(je,"users",T)));return(await Promise.all(C)).map(T=>T.exists()?T.data():{uid:T.id,displayName:"Inconnu"})},o=pe(U(je,"plans"),ee("userId","==",t.uid)),c=Fe(o,async E=>{const C=E.docChanges().map(async b=>{if(b.type==="removed")n.delete(b.doc.id);else{const T=b.doc.data(),z=await i(T);n.set(b.doc.id,{id:b.doc.id,...T,isOwner:!0,participants:z})}});await Promise.all(C),a()}),p=pe(U(je,"plans"),ee("collaborators","array-contains",t.uid)),x=Fe(p,async E=>{const C=E.docChanges().map(async b=>{if(b.type==="removed")n.delete(b.doc.id);else{const T=b.doc.data(),z=await i(T),f=z.find(R=>R.uid===T.userId);n.set(b.doc.id,{id:b.doc.id,...T,isOwner:!1,ownerName:f?.displayName||"Inconnu",participants:z})}});await Promise.all(C),a()});return()=>{c(),x()}}function cn(e){if(!ce)return;const t=ce.value;if(ce.innerHTML="",e.length===0){const n=document.createElement("option");n.value="",n.textContent="Aucun plan personnel",n.disabled=!0,ce.appendChild(n);return}e.forEach(n=>{const a=document.createElement("option");a.value=n.id;let i=n.name;n.collaborators&&n.collaborators.length>0&&(n.isOwner?i=`üëë ${n.name} [Collab]`:i=`üë• ${n.name} [Collab] (de ${n.ownerName})`),a.textContent=i,ce.appendChild(a)}),t&&ce.querySelector(`option[value="${t}"]`)?ce.value=t:ce.selectedIndex=0}function un(){ut=document.getElementById("create-plan-modal"),Ct=document.getElementById("close-create-plan-modal"),It=document.getElementById("cancel-create-plan-btn"),lt=document.getElementById("create-plan-form"),ce=document.getElementById("plan-select"),mt=document.getElementById("rename-plan-modal"),Bt=document.getElementById("close-rename-plan-modal"),kt=document.getElementById("cancel-rename-plan-btn"),dt=document.getElementById("rename-plan-form"),Xe=document.getElementById("new-plan-name"),pt=document.getElementById("delete-confirm-modal"),St=document.getElementById("cancel-delete-btn"),Mt=document.getElementById("confirm-delete-btn"),Dt=document.getElementById("delete-confirm-title"),Pt=document.getElementById("delete-confirm-message");const e=document.getElementById("create-plan-btn"),t=document.getElementById("rename-plan-btn"),n=document.getElementById("leave-plan-btn"),a=document.getElementById("delete-plan-btn"),i=w=>{w.preventDefault();const C=document.getElementById("plan-name");C&&C.value&&sa(C.value)},o=w=>{w.preventDefault(),yt&&Xe.value&&ra(yt,Xe.value)},c=()=>{bt&&oa(bt).then(()=>{Nt()})},p=()=>{if(ce&&ce.value){const w=ce.options[ce.selectedIndex];on(ce.value,w.text)}else alert("Veuillez s√©lectionner un plan √† renommer.")},x=()=>{ce&&ce.value?ia(ce.value):alert("Veuillez s√©lectionner un plan.")},E=()=>{if(ce&&ce.value){const w=ce.options[ce.selectedIndex].text;ln(ce.value,w)}else alert("Veuillez s√©lectionner un plan √† supprimer.")};return e?.addEventListener("click",_t),t?.addEventListener("click",p),n?.addEventListener("click",x),a?.addEventListener("click",E),Ct?.addEventListener("click",it),It?.addEventListener("click",it),lt?.addEventListener("submit",i),Bt?.addEventListener("click",ot),kt?.addEventListener("click",ot),dt?.addEventListener("submit",o),St?.addEventListener("click",Nt),Mt?.addEventListener("click",c),()=>{e?.removeEventListener("click",_t),t?.removeEventListener("click",p),n?.removeEventListener("click",x),a?.removeEventListener("click",E),Ct?.removeEventListener("click",it),It?.removeEventListener("click",it),lt?.removeEventListener("submit",i),Bt?.removeEventListener("click",ot),kt?.removeEventListener("click",ot),dt?.removeEventListener("submit",o),St?.removeEventListener("click",Nt),Mt?.removeEventListener("click",c)}}async function mn(e,t){if(!(!e||!t))try{const n=_(je,"plans",e);await Te(n,{collaborators:Nn(t),type:"collaborative"})}catch(n){console.error("Error adding collaborator: ",n)}}async function $t(e,t,n="Modification diverse"){if(!e||!t)return;const a=He();if(a)try{const i=U(je,"plans",e,"history"),o=JSON.parse(JSON.stringify(t));await Ne(i,{planState:o,timestamp:ht(),modifiedBy:a.uid,modifiedByName:a.displayName||a.email,description:n})}catch(i){console.error("Error saving history:",i)}}async function pn(e,t){const n=He();if(!(!n||!e||!t))try{const a=U(je,"plan_saves"),i=pe(a,ee("userId","==",n.uid),ee("name","==",e)),o=await he(i);if(o.empty)await Ne(a,{userId:n.uid,name:e,savedAt:ht(),planData:t});else{const c=o.docs[0].id,p=_(je,"plan_saves",c);await Te(p,{planData:t,savedAt:ht()})}}catch(a){console.error("Error saving or updating plan save:",a),alert("Erreur lors de la sauvegarde.")}}async function la(e,t,n){if(!e||!t||!n)return;const a=_(je,"plans",e);try{await Te(a,{[`weeks.${t}`]:n,lastUpdated:new Date}),console.log(`Week ${t} of plan ${e} saved successfully.`)}catch(i){console.error("Error saving plan week:",i),alert("Erreur lors de la sauvegarde du plan.")}}const da=Object.freeze(Object.defineProperty({__proto__:null,addCollaborator:mn,getUserPlans:dn,initPlanManagement:un,openCreatePlanModal:_t,openDeleteConfirmModal:ln,openRenamePlanModal:on,populatePlanSelector:cn,saveHistory:$t,saveOrUpdatePlanSaveByName:pn,savePlanWeek:la},Symbol.toStringTag,{value:"Module"}));let fn=[],gn=[],hn=()=>{},vn=()=>{};const Q={btn:null,btnMobile:null,badge:null,badgeMobile:null,dropdown:null,list:null};async function ca(e,t,n){const a=ye();if(a)try{const i=_(y,"shares",e);if(await Te(i,{status:"accepted"}),t.plan){const o=n.displayName||"Inconnu",c=`Copie de "${t.plan.name}" (de ${o})`,p={...t.plan,userId:a,name:c,isShared:!0,originalOwnerId:t.senderId,sharedAt:new Date,collaborators:[]};delete p.id,await Ne(U(y,"plans"),p)}t.shoppingList&&await Ne(U(y,"shopping_lists"),{name:`${t.shoppingList.name} (de ${n.displayName})`,ingredients:t.shoppingList.ingredients,userId:a,isShared:!0,originalOwner:n.uid,sharedAt:new Date})}catch(i){console.error("Erreur lors de l'acceptation du partage : ",i),alert("Une erreur est survenue.")}}async function ua(e,t){const n=ye();if(!(!n||!t||!t.planId))try{await mn(t.planId,n);const a=_(y,"shares",e);await Te(a,{status:"accepted"})}catch(a){console.error("Erreur lors de l'acceptation de l'invitation : ",a),alert("Une erreur est survenue.")}}async function Xt(e){try{const t=_(y,"shares",e);await Te(t,{status:"declined"})}catch(t){console.error("Erreur lors du refus du partage : ",t),alert("Une erreur est survenue.")}}async function ma(e){try{await nn(e)}catch{alert("Erreur lors de l'acceptation.")}}async function pa(e){try{await an(e)}catch{alert("Erreur lors du refus.")}}function bn(){if(!Q.list)return;const e=[...fn,...gn];e.sort((n,a)=>a.createdAt.toMillis()-n.createdAt.toMillis());const t=n=>{n&&(e.length>0?(n.textContent=e.length,n.classList.remove("hidden")):n.classList.add("hidden"))};t(Q.badge),t(Q.badgeMobile),Q.list.innerHTML="",e.length===0?Q.list.innerHTML='<p class="text-gray-500 text-center p-4">Aucune nouvelle notification.</p>':e.forEach(n=>{const a=fa(n);Q.list.appendChild(a)})}function fa(e){const t=document.createElement("div");t.className="p-3 border-b border-gray-100 hover:bg-gray-50";const n=document.createElement("p");n.className="text-sm font-medium text-gray-800";const a=document.createElement("p");a.className="text-xs text-gray-500 mb-3";const i=document.createElement("div");i.className="flex space-x-2 justify-end";const o=e.data.type||e.type;if(o==="collaborative_plan_invite"){n.textContent="Invitation √† collaborer",a.textContent=`${e.sender.displayName} vous invite √† modifier son plan "${e.data.planName}".`;const c=nt("Accepter","btn-secondary",x=>{x.target.textContent="...",x.target.disabled=!0,ua(e.id,e.data)}),p=nt("Refuser","btn-ghost text-red-500",x=>{x.target.disabled=!0,Xt(e.id)});i.append(c,p)}else if(o==="share"){n.textContent=`Partage de ${e.sender.displayName||e.sender.email}`;let c=[];e.data.plan&&c.push("planification"),e.data.shoppingList&&c.push("liste de courses"),a.textContent=`Contenu : ${c.join(" et ")}`;const p=nt("Accepter","btn-secondary",E=>{E.target.textContent="...",E.target.disabled=!0,ca(e.id,e.data,e.sender)}),x=nt("Refuser","btn-ghost text-red-500",E=>{E.target.disabled=!0,Xt(e.id)});i.append(p,x)}else if(o==="friend_request"){n.textContent="Invitation d'ami",a.textContent=`${e.sender.displayName||e.sender.email} vous a envoy√© une invitation.`;const c=nt("Accepter","btn-secondary",x=>{x.target.textContent="...",x.target.disabled=!0,ma(e.id)}),p=nt("Refuser","btn-ghost text-red-500",x=>{x.target.disabled=!0,pa(e.id)});i.append(c,p)}return t.append(n,a,i),t}function nt(e,t,n){const a=document.createElement("button");return a.className=`btn btn-xs ${t}`,a.textContent=e,a.addEventListener("click",i=>{i.stopPropagation(),n(i)}),a}function ga(e){const t=U(y,"shares"),n=pe(t,ee("receiverId","==",e),ee("status","==","pending"));hn=Fe(n,async a=>{const i=[];for(const o of a.docs){const c=o.data(),p=await Le(_(y,"users",c.senderId));p.exists()&&i.push({type:c.type||"share",id:o.id,data:c,sender:p.data(),createdAt:c.createdAt})}fn=i,bn()},a=>{console.error("Erreur d'√©coute des partages:",a)})}function ha(e){const t=U(y,"friend_requests"),n=pe(t,ee("receiverId","==",e),ee("status","==","pending"));vn=Fe(n,async a=>{const i=[];for(const o of a.docs){const c=o.data(),p=await Le(_(y,"users",c.senderId));p.exists()&&i.push({type:"friend_request",id:o.id,data:c,sender:p.data(),createdAt:c.createdAt})}gn=i,bn()},a=>{console.error("Erreur d'√©coute des invitations d'amis:",a)})}function yn(){if(Q.btn=document.getElementById("notifications-btn"),Q.btnMobile=document.getElementById("notifications-btn-mobile"),Q.badge=document.getElementById("notifications-badge"),Q.badgeMobile=document.getElementById("notifications-badge-mobile"),Q.dropdown=document.getElementById("notifications-dropdown"),Q.list=document.getElementById("notifications-list"),!Q.btn||!Q.dropdown)return;const e=ye();if(!e)return;hn(),vn(),ga(e),ha(e);const t=n=>{if(n.stopPropagation(),!Q.dropdown.classList.toggle("hidden")){const i=window.innerWidth<768,o=i?Q.btnMobile:Q.btn;if(!o)return;const c=o.getBoundingClientRect();Q.dropdown.style.position="fixed",i?(Q.dropdown.style.top=`${c.bottom+8}px`,Q.dropdown.style.left="50%",Q.dropdown.style.transform="translateX(-50%)",Q.dropdown.style.width="95vw",Q.dropdown.style.right="auto"):(Q.dropdown.style.top=`${c.bottom+8}px`,Q.dropdown.style.left="auto",Q.dropdown.style.right=`${window.innerWidth-c.right}px`,Q.dropdown.style.transform="none",Q.dropdown.style.width="20rem")}};Q.btn.addEventListener("click",t),Q.btnMobile&&Q.btnMobile.addEventListener("click",t),document.addEventListener("click",n=>{Q.dropdown&&!Q.dropdown.classList.contains("hidden")&&(Q.btn.contains(n.target)||Q.btnMobile&&Q.btnMobile.contains(n.target)||Q.dropdown.contains(n.target)||Q.dropdown.classList.add("hidden"))})}const va=Object.freeze(Object.defineProperty({__proto__:null,initNotifications:yn},Symbol.toStringTag,{value:"Module"}));let Qe=null,st=null;function xn(e,t){if(!Lt||!e)return;const n=He();if(!n)return;const a=Wt(Lt,`plans_presence/${e}`);Qe=Wt(Lt,`plans_presence/${e}/${n.uid}`);const i={displayName:n.displayName||n.email,photoURL:n.photoURL,status:"idle",last_seen:Zt()};Tn(Qe).remove(),Dn(Qe,i),st&&st(),st=Pn(a,o=>{const c=o.val()||{};typeof t=="function"&&t(c)})}function En(){Qe&&(_n(Qe),Qe=null),st&&(st(),st=null)}function gt(e){Qe&&$n(Qe,{status:e,last_seen:Zt()})}const ba=Object.freeze(Object.defineProperty({__proto__:null,connectToPresenceChannel:xn,disconnectFromPresenceChannel:En,updateUserActivity:gt},Symbol.toStringTag,{value:"Module"}));let at=null;async function At(e,t){if(!e)return;const n=_(y,"recipes",e);try{await Te(n,{isFavorite:!t})}catch(a){console.error("Error toggling favorite status:",a)}}function ya(){const e=document.getElementById("search-bar"),t=document.getElementById("category-tabs"),n=document.getElementById("recipe-list-container"),a=document.getElementById("add-recipe-btn");at&&at.destroy(),at=new Rt(y,"edit-recipe-form-modal","edit-recipe-form","edit-recipe-modal-title","edit-recipe-id","edit-recipe-name","edit-recipe-category","edit-recipe-servings","edit-recipe-prep-time","edit-recipe-difficulty","edit-recipe-steps","edit-ingredients-list","edit-add-ingredient-btn","edit-save-recipe-btn","close-edit-recipe-modal","edit-cancel-recipe-btn"),at.setOnSaveCallback(()=>{});let i=[],o="",c="",p=null;const x=["Entr√©e","Plat","Accompagnement","Dessert"],E={PLAT:"bg-orange-100",DESSERT:"bg-amber-100",ENTREE:"bg-lime-100",ACCOMPAGNEMENT:"bg-stone-200","PETIT-DEJEUNER":"bg-orange-100",BOISSON:"bg-cyan-100",SAUCE:"bg-red-100"},w={PLAT:"text-orange-800",DESSERT:"text-amber-800",ENTREE:"text-lime-800",ACCOMPAGNEMENT:"text-stone-800","PETIT-DEJEUNER":"text-orange-800",BOISSON:"text-cyan-800",SAUCE:"text-red-800"},C="bg-gray-100",b="text-gray-800";function T(){return y?Fe(U(y,"recipes"),j=>{console.log("Recipe data updated on /recipes page from listener."),i=j.docs.map(N=>({id:N.id,...N.data()})),f(),R()},j=>{console.error("Erreur lors de l'√©coute des recettes: ",j)}):()=>{}}function z(q){o=q,f(),R()}function f(){if(!t)return;t.innerHTML="";const j=[...new Set(i.map(N=>N.category||"Non class√©"))].sort((N,O)=>{const Y=Ee=>{const Ie=Ee.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();for(let we=0;we<x.length;we++)if(x[we].normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()===Ie)return we;return-1},Ce=Y(N),xe=Y(O);return Ce>-1&&xe>-1?Ce-xe:Ce>-1?-1:xe>-1?1:N.localeCompare(O)});!o&&j.length>0&&(o=j[0]),j.forEach(N=>{const O=document.createElement("button"),Y=N.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toUpperCase();if(N===o){const xe=E[Y]||C,Ee=w[Y]||b;O.className=`px-4 py-2 text-sm font-bold rounded-t-lg ${xe} ${Ee}`}else O.className="px-4 py-2 text-sm font-medium text-gray-500 hover:text-tomato";O.textContent=N,O.addEventListener("click",()=>z(N)),t.appendChild(O)})}function R(){if(!n)return;n.innerHTML="";let q=i.filter(N=>(N.category||"Non class√©")===o);if(c){const N=c.toLowerCase();q=q.filter(O=>O.name.toLowerCase().includes(N))}if(q.sort((N,O)=>N.name.localeCompare(O.name)),q.length===0){n.innerHTML='<p class="text-gray-500 text-center p-10">Aucune recette trouv√©e.</p>';return}const j=document.createElement("div");j.className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4",q.forEach(N=>{j.appendChild(X(N))}),n.appendChild(j)}function X(q){const j=document.createElement("div");if(j.className="bg-white dark:bg-gray-800 shadow-md rounded-lg flex flex-col p-3",q.imageUrl){const Pe=document.createElement("img");Pe.src=q.imageUrl,Pe.alt=q.name,Pe.className="w-full h-24 object-cover rounded-md mb-2",j.appendChild(Pe)}const N=document.createElement("div");N.className="w-full flex justify-between items-start";const O=document.createElement("h4");O.className="font-bold text-gray-800 dark:text-gray-200 pr-2",O.textContent=q.name,O.title=q.name,N.appendChild(O);const Y=document.createElement("button");Y.className="text-lg flex-shrink-0",Y.innerHTML='<i class="fas fa-heart"></i>',q.isFavorite?Y.classList.add("text-red-500"):Y.classList.add("text-gray-300","dark:text-gray-500","hover:text-red-400"),Y.addEventListener("click",Pe=>{Pe.stopPropagation(),At(q.id,q.isFavorite)}),N.appendChild(Y),j.appendChild(N);const Ce=document.createElement("p");Ce.className="text-sm text-gray-600 dark:text-gray-400 mt-1 w-full",Ce.textContent=`${q.difficulty||""} - Pour ${q.servings||"?"} pers.`,j.appendChild(Ce);const xe=document.createElement("div");xe.className="flex-grow",j.appendChild(xe);const Ee=document.createElement("div");Ee.className="w-full flex justify-end items-center space-x-2 border-t dark:border-gray-700 pt-2 mt-2";const Ie=document.createElement("button");Ie.className="btn btn-ghost btn-sm text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/50",Ie.innerHTML='<i class="fas fa-edit"></i>',Ie.title="Modifier",Ie.addEventListener("click",()=>at.openForm(q,"Modifier la recette")),Ee.appendChild(Ie);const we=document.createElement("button");return we.className="btn btn-ghost btn-sm text-red-500 hover:bg-red-50 dark:hover:bg-red-900/50",we.innerHTML='<i class="fas fa-trash-alt"></i>',we.title="Supprimer",we.addEventListener("click",()=>De(q.id,q.name)),Ee.appendChild(we),j.appendChild(Ee),j}async function De(q,j){if(confirm(`√ätes-vous s√ªr de vouloir supprimer la recette "${j}" ?`))try{await Ae(_(y,"recipes",q)),fetchAllRecipes()}catch(N){console.error("Erreur lors de la suppression: ",N)}}if(a.addEventListener("click",()=>at.openForm(null,"Ajouter une recette")),e.addEventListener("input",q=>{const j=q.target.value;if(!c&&j&&(p=o),c=j,c){const N=c.toLowerCase(),O=i.find(Y=>Y.name.toLowerCase().includes(N));O&&(o=O.category||"Non class√©")}else p&&(o=p,p=null);f(),R()}),y)return T()}const xa=Object.freeze(Object.defineProperty({__proto__:null,default:ya,toggleFavoriteStatus:At},Symbol.toStringTag,{value:"Module"}));let Ve=null;function Ea(){const e={mealPlanGrid:document.getElementById("meal-plan-grid"),currentWeekDisplay:document.getElementById("current-week-display"),prevWeekBtn:document.getElementById("prev-week-btn"),nextWeekBtn:document.getElementById("next-week-btn"),clearMenuBtn:document.getElementById("clear-menu-btn"),shoppingListContainer:document.getElementById("shopping-list"),startDaySelect:document.getElementById("start-day-select"),defaultServingsControl:document.getElementById("default-servings-control"),mealSelectModal:document.getElementById("meal-select-modal"),closeMealSelectModalBtn:document.getElementById("close-meal-select-modal"),mealSelectModalTitle:document.getElementById("meal-select-modal-title"),mealSelectList:document.getElementById("meal-select-list"),recipeFormModal:document.getElementById("edit-recipe-form-modal"),closeRecipeModalBtn:document.getElementById("close-edit-recipe-modal"),cancelRecipeBtn:document.getElementById("edit-cancel-recipe-btn"),recipeForm:document.getElementById("edit-recipe-form"),addItemInput:document.getElementById("add-item-input"),addItemBtn:document.getElementById("add-item-btn"),addItemResults:document.getElementById("add-item-results"),importListBtn:document.getElementById("import-list-btn"),importListModal:document.getElementById("import-list-modal"),closeImportListModalBtn:document.getElementById("close-import-list-modal"),importListContainer:document.getElementById("import-list-container"),exportTxtBtn:document.getElementById("export-txt-btn"),exportPdfBtn:document.getElementById("export-pdf-btn"),exportPlanPdfBtn:document.getElementById("export-plan-pdf-btn"),sharePlanBtn:document.getElementById("share-plan-btn"),planSelect:document.getElementById("plan-select"),inviteParticipantBtn:document.getElementById("invite-participant-btn"),historyPlanBtn:document.getElementById("history-plan-btn"),planHistoryModal:document.getElementById("plan-history-modal"),closePlanHistoryModalBtn:document.getElementById("close-plan-history-modal"),planHistoryList:document.getElementById("plan-history-list"),savePlanBtn:document.getElementById("save-plan-btn")};function t(s,l){const d=document.createElement("div");d.className="flex items-center space-x-2";const u=document.createElement("button");u.className="btn btn-outline btn-xs",u.textContent="-";const r=document.createElement("span");r.className="font-medium text-center w-6",r.textContent=s;const g=document.createElement("button");return g.className="btn btn-outline btn-xs",g.textContent="+",u.addEventListener("click",()=>{let h=parseInt(r.textContent,10);h>1&&(h--,r.textContent=h,l(h))}),g.addEventListener("click",()=>{let h=parseInt(r.textContent,10);h++,r.textContent=h,l(h)}),d.appendChild(u),d.appendChild(r),d.appendChild(g),d}function n(s,l,d,u=!1){const r=document.createElement("div");r.className="flex flex-col items-center justify-center h-full";const g=document.createElement("button");g.className="btn btn-ghost btn-xs p-0 h-4 flex items-center justify-center w-full",g.innerHTML='<i class="fas fa-plus"></i>',g.disabled=u;const h=document.createElement("span");h.className="font-medium text-center text-sm my-1",h.textContent=s;const m=document.createElement("button");return m.className="btn btn-ghost btn-xs p-0 h-4 flex items-center justify-center w-full",m.innerHTML='<i class="fas fa-minus"></i>',m.disabled=u,l&&(g.classList.add("text-white"),h.classList.add("text-white"),m.classList.add("text-white")),u||(g.addEventListener("click",()=>{let v=parseInt(h.textContent,10);v++,h.textContent=v,d(v)}),m.addEventListener("click",()=>{let v=parseInt(h.textContent,10);v>1&&(v--,h.textContent=v,d(v))})),r.appendChild(g),r.appendChild(h),r.appendChild(m),r}Ve&&Ve.destroy(),Ve=new Rt(y,"edit-recipe-form-modal","edit-recipe-form","edit-recipe-modal-title","edit-recipe-id","edit-recipe-name","edit-recipe-category","edit-recipe-servings","edit-recipe-prep-time","edit-recipe-difficulty","edit-recipe-steps","edit-ingredients-list","edit-add-ingredient-btn","edit-save-recipe-btn","close-edit-recipe-modal","edit-cancel-recipe-btn"),Ve.setActivityUpdater(gt),Ve.setOnSaveCallback(async()=>{});let a=1,i="Lundi",o={},c={},p={};const x=[];let E=null,w=[],C=[],b=1,T=null,z=[],f=null;const R=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];function X(s){return s?s.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase():""}async function De(s){const l=document.getElementById("unit-select-modal"),d=document.getElementById("unit-modal-title"),u=document.getElementById("unit-modal-list"),r=document.getElementById("unit-modal-cancel");return d.textContent=`Choisir une unit√© pour "${s}"`,u.innerHTML="",new Promise((g,h)=>{const m=["g","kg","ml","l","pi√®ce(s)","c.√†.s.","c.√†.c.","pinc√©e(s)"],v=L=>{l.classList.add("hidden"),g(L)};m.forEach(L=>{const I=document.createElement("button");I.className="btn btn-outline",I.textContent=L,I.addEventListener("click",()=>v(L)),u.appendChild(I)});const k=()=>{l.classList.add("hidden"),h()};r.addEventListener("click",k,{once:!0}),l.addEventListener("click",L=>{L.target===l&&k()},{once:!0}),l.classList.remove("hidden")})}async function q(){if(y)try{C=(await he(U(y,"ingredients"))).docs.map(l=>({id:l.id,...l.data()})),C.sort((l,d)=>l.name.localeCompare(d.name))}catch(s){console.error("Erreur lors de la r√©cup√©ration des ingr√©dients: ",s)}}function j(){if(!f)o={},c={},p={},b=1,i="Lundi";else{const s=f.weeks?f.weeks[a]||{}:{};o=s.menuData||{},c=s.servingsData||{},p=s.remarksData||{},b=f.defaultNumPeople||1,i=f.startDay||"Lundi"}if(e.startDaySelect&&(e.startDaySelect.value=i),e.defaultServingsControl){e.defaultServingsControl.innerHTML="";const s=t(b,async l=>{b=l,f&&await N({defaultNumPeople:l},`a chang√© le nombre de personnes par d√©faut √† ${l}`)});e.defaultServingsControl.appendChild(s)}Ln(),Ie(e.mealPlanGrid,{menuData:o,servingsData:c,remarksData:p,defaultNumPeople:b,startDay:i},!1),Ee(document.getElementById("mobile-meal-plan"),{menuData:o,servingsData:c,remarksData:p,defaultNumPeople:b,startDay:i},!1),G()}async function N(s,l){if(!f)return;await $t(f.id,f,l);const d=_(y,"plans",f.id);try{await Te(d,{...s,lastUpdated:new Date})}catch(u){console.error("Error updating plan:",u),alert("Une erreur de sauvegarde est survenue.")}}function O(){e.planHistoryModal.classList.add("hidden")}async function Y(s){if(f&&confirm("Voulez-vous vraiment restaurer cette version ? L'√©tat actuel sera sauvegard√© dans l'historique avant la restauration."))try{const l=_(y,"plans",f.id,"history",s),d=await Le(l);if(!d.exists())throw new Error("Version de l'historique non trouv√©e.");const u=d.data().planState;await $t(f.id,f);const r=_(y,"plans",f.id);await ct(r,u),O()}catch(l){console.error("Erreur lors du rollback :",l)}}async function Ce(s,l){if(f&&confirm("√ätes-vous s√ªr de vouloir supprimer d√©finitivement cette entr√©e de l'historique ?"))try{const d=_(y,"plans",f.id,"history",s);await Ae(d),l.remove()}catch(d){console.error("Erreur lors de la suppression de l'historique :",d),alert("Une erreur est survenue lors de la suppression.")}}async function xe(){if(f){e.planHistoryList.innerHTML="<p>Chargement de l'historique...</p>",e.planHistoryModal.classList.remove("hidden");try{const s=U(y,"plans",f.id,"history"),l=pe(s,Hn("timestamp","desc")),d=await he(l);if(e.planHistoryList.innerHTML="",d.empty){e.planHistoryList.innerHTML="<p>Aucun historique pour ce plan.</p>";return}d.forEach(u=>{const r=u.data(),g=document.createElement("div");g.className="p-3 border-b flex justify-between items-center";const h=document.createElement("div"),m=r.timestamp?.toDate().toLocaleString("fr-FR")||"Date inconnue",v=r.description||"Modification diverse",k=r.modifiedByName||"Inconnu";h.innerHTML=`
                    <p class="font-medium">${k} ${v}</p>
                    <p class="text-sm text-gray-500">${m}</p>
                `;const L=document.createElement("div");L.className="flex items-center space-x-2";const I=document.createElement("button");I.className="btn btn-secondary btn-sm",I.textContent="Revenir √† cette version",I.addEventListener("click",()=>Y(u.id));const D=document.createElement("button");D.className="btn btn-ghost text-red-500 hover:bg-red-100 btn-sm",D.innerHTML='<i class="fas fa-times"></i>',D.title="Supprimer cette version",D.addEventListener("click",H=>{H.stopPropagation(),Ce(u.id,g)}),L.appendChild(I),L.appendChild(D),g.appendChild(h),g.appendChild(L),e.planHistoryList.appendChild(g)})}catch(s){console.error("Erreur de chargement de l'historique:",s),e.planHistoryList.innerHTML=`<p class="text-red-500">Impossible de charger l'historique.</p>`}}}function Ee(s,l,d=!1){if(!s)return;const u=l.menuData||{},r=l.servingsData||{},g=l.remarksData||{},h=l.defaultNumPeople||1,m=l.startDay||"Lundi";s.innerHTML="";const v=document.createDocumentFragment(),k=R.indexOf(m);[...R.slice(k),...R.slice(0,k)].forEach(I=>{const D=R.indexOf(I),H=document.createElement("div");H.className="bg-blue-100 border border-blue-300 rounded-xl shadow-md p-4 mb-4";const ne=document.createElement("h3");ne.className="text-xl font-bold text-gray-800 mb-3",ne.textContent=I.toUpperCase(),H.appendChild(ne);const se=document.createElement("div");se.className="space-y-4",["lunch","dinner"].forEach(oe=>{const le=document.createElement("div");le.className=`border-t pt-3 ${oe==="lunch"?"bg-amber-50":"bg-stone-100"} rounded-lg p-2`;const ge=document.createElement("div");ge.className="flex justify-between items-center mb-2";const ae=document.createElement("h4");if(ae.className="text-lg font-semibold text-tomato",ae.textContent=oe==="lunch"?"Midi":"Soir",ge.appendChild(ae),!d){const me=`${D}-${oe}`,Be=r[me]||h,ve=t(Be,_e=>{Ot(me,_e)});ge.appendChild(ve)}le.appendChild(ge);const Me=document.createElement("div");Me.className="space-y-2";let de=!1;const ue=["Entr√©e","Plat","Accompagnement","Dessert","Remarque"];for(let me=0;me<ue.length;me++){const Be=ue[me],ve=`${D}-${oe}-${me}`,_e=u[ve],ke=document.createElement("div");ke.className="mb-2";const tt=document.createElement("h5");if(tt.className="text-md font-semibold text-gray-700 mb-1",tt.textContent=Be,ke.appendChild(tt),Be==="Remarque")ke.appendChild(Je(ve,g,d));else{const Re=document.createElement("div");if(Re.className="space-y-1",Array.isArray(_e)&&_e.length>0&&(de=!0,_e.forEach(($e,Ge)=>{const Oe=w.find(be=>be.id===$e.id);if(Oe){const be=te(Oe,ve,Ge,d);if(be.classList.remove("bg-white","shadow-sm"),be.classList.add("bg-emerald-200","border","border-emerald-400"),!d){const ze=be.querySelector(".edit-meal-btn"),zt=be.querySelector(".delete-meal-btn");ze&&ze.classList.remove("hidden"),zt&&zt.classList.remove("hidden")}Re.appendChild(be)}})),d)de||(Re.innerHTML='<p class="text-sm text-gray-500 italic">Aucun plat pr√©vu.</p>');else{const $e=document.createElement("button");$e.className="btn btn-outline btn-sm w-full mt-2",$e.innerHTML=`<i class="fas fa-plus mr-2"></i> Ajouter une ${Be.toLowerCase()}`,$e.addEventListener("click",()=>{re(ve)}),Re.appendChild($e)}ke.appendChild(Re)}Me.appendChild(ke)}le.appendChild(Me),se.appendChild(le)}),H.appendChild(se),v.appendChild(H)}),s.appendChild(v)}function Ie(s,l,d=!1){if(!s)return;const u=l.menuData||{},r=l.servingsData||{},g=l.remarksData||{},h=l.defaultNumPeople||1,m=l.startDay||"Lundi",v=document.createDocumentFragment(),k=["lunch","dinner"],L=5,I=R.indexOf(m);[...R.slice(I),...R.slice(0,I)].forEach(H=>{const ne=R.indexOf(H),se=document.createElement("div");se.className="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] items-stretch border-b border-gray-300";const oe=document.createElement("div");oe.className="font-bold p-2 flex items-center justify-center bg-gray-100 text-sm border-r border-gray-300",oe.textContent=H.toUpperCase(),se.appendChild(oe),k.forEach(le=>{const ge=`${ne}-${le}`,ae=r[ge]||h,Me=r.hasOwnProperty(ge),de=document.createElement("div"),ue=n(ae,Me,Be=>{Ot(ge,Be)},d);let me="border-r border-gray-300 flex items-center justify-center transition-colors duration-300";Me?me+=" bg-tomato":me+=le==="lunch"?" bg-amber-50":" bg-stone-100",de.className=me,de.appendChild(ue),se.appendChild(de);for(let Be=0;Be<L;Be++){const ve=`${ne}-${le}-${Be}`,_e=u[ve],ke=document.createElement("div"),tt=$(ve);let Re="meal-slot p-1 min-h-[70px] flex flex-col justify-start border-r border-gray-300";if(Re+=le==="lunch"?" bg-amber-50":" bg-stone-100",ke.className=Re,ke.dataset.slotId=ve,tt==="Remarque")ke.appendChild(Je(ve,g,d));else if(Array.isArray(_e)&&_e.length>0){const $e=document.createElement("div");$e.className="w-full",_e.forEach((Ge,Oe)=>{const be=w.find(ze=>ze.id===Ge.id);if(be)$e.appendChild(te(be,ve,Oe,d));else{const ze=document.createElement("div");ze.className="p-1 bg-red-100 text-red-700 rounded shadow-sm text-center text-xs font-medium",ze.textContent="Recette supprim√©e",$e.appendChild(ze)}}),ke.appendChild($e),d||ke.appendChild(Ye(ve,!0))}else d||ke.appendChild(Ye(ve,!1));se.appendChild(ke)}}),v.appendChild(se)}),s.innerHTML="",s.appendChild(v),d||Ke()}async function we(){const s=ye();if(!y||!s)return[];try{const l=pe(U(y,"shopping_lists"),ee("userId","==",s));return(await he(l)).docs.map(g=>({id:g.id,...g.data()})).filter(g=>g.isShared!==!0)}catch(l){return console.error("Erreur de chargement des listes de courses sauvegard√©es: ",l),[]}}async function Pe(){const s=await we();if(e.importListContainer.innerHTML="",s.length===0){e.importListContainer.innerHTML='<p class="text-center text-gray-500">Aucune liste sauvegard√©e.</p>';return}s.forEach(l=>{const d=document.createElement("button");d.className="w-full text-left p-2 hover:bg-gray-100 rounded-lg transition-colors duration-150",d.textContent=l.name,d.addEventListener("click",()=>{confirm(`Voulez-vous vraiment importer les ingr√©dients de la liste "${l.name}" ?`)&&(l.ingredients.forEach(u=>{const r=parseFloat(String(u.quantity).replace(",","."))||0;K(u.name,r,u.unit)}),Ue())}),e.importListContainer.appendChild(d)}),e.importListModal.classList.remove("hidden")}function Ue(){e.importListModal.classList.add("hidden")}function F(){e.addItemInput?.addEventListener("input",()=>{const s=e.addItemInput.value.toLowerCase(),l=e.addItemResults;if(l.innerHTML="",!s){l.classList.add("hidden");return}C.filter(r=>r.name.toLowerCase().includes(s)).forEach(r=>{const g=document.createElement("div");g.className="p-2 hover:bg-gray-100 cursor-pointer",g.textContent=r.name,g.addEventListener("click",()=>{K(r.name,1,r.unit),e.addItemInput.value="",l.classList.add("hidden")}),l.appendChild(g)});const u=document.createElement("div");u.className="p-2 bg-green-50 hover:bg-green-200 cursor-pointer font-bold text-green-700",u.textContent=`+ Cr√©er "${e.addItemInput.value}"`,u.addEventListener("click",async()=>{const r=e.addItemInput.value;try{const g=await De(r);await Ne(U(y,"ingredients"),{name:r,unit:g}),await q(),K(r,1,g),e.addItemInput.value="",l.classList.add("hidden")}catch{}}),l.appendChild(u),l.classList.remove("hidden")}),e.addItemBtn?.addEventListener("click",()=>{const s=e.addItemInput.value;s&&(K(s,1,""),e.addItemInput.value="",e.addItemResults.classList.add("hidden"))}),document.addEventListener("click",s=>{e.addItemInput&&!e.addItemInput.contains(s.target)&&!e.addItemResults.contains(s.target)&&e.addItemResults.classList.add("hidden")})}function S(){if(x.length===0){alert("La liste de courses est vide.");return}const s=x.reduce((r,g)=>{const h=g.category||"Inconnue";return r[h]||(r[h]=[]),r[h].push(g),r},{}),l=Object.keys(s).sort((r,g)=>r==="Inconnue"?1:g==="Inconnue"?-1:r.localeCompare(g));let d=`Liste de courses - GustoPlan

`;l.forEach(r=>{d+=`--- ${r.toUpperCase()} ---
`,s[r].sort((h,m)=>h.name.localeCompare(m.name)).forEach(h=>{let v=`${Number.isInteger(h.totalQuantity)?h.totalQuantity:parseFloat(h.totalQuantity.toFixed(2))} ${h.unit||""} ${h.name}`;if(h.sources&&h.sources.length>0){const k=h.sources.reduce((I,D)=>{const H=`${D.recipeName} (${D.day} ${D.time})`;return I[H]||(I[H]=0),I[H]+=D.quantity,I},{}),L=Object.keys(k).join(" / ");v+=` *** ${L} ***`}d+=v+`
`}),d+=`
`});const u=new Blob([d],{type:"text/plain;charset=utf-8"});saveAs(u,"liste-de-courses.txt")}function W(){if(x.length===0){alert("La liste de courses est vide.");return}const{jsPDF:s}=window.jspdf,l=new s,d=x.reduce((v,k)=>{const L=k.category||"Inconnue";return v[L]||(v[L]=[]),v[L].push(k),v},{}),u=Object.keys(d).sort((v,k)=>v==="Inconnue"?1:k==="Inconnue"?-1:v.localeCompare(k));l.setFontSize(18),l.text("Liste de courses - GustoPlan",14,22);let r=35;const g=l.internal.pageSize.height,h=20,m=()=>{r>g-h&&(l.addPage(),r=20)};u.forEach(v=>{m(),l.setFontSize(14),l.setFont(void 0,"bold"),l.text(`--- ${v.toUpperCase()} ---`,14,r),r+=8,l.setFont(void 0,"normal"),d[v].sort((L,I)=>L.name.localeCompare(I.name)).forEach(L=>{m(),l.setFontSize(12);const I=Number.isInteger(L.totalQuantity)?L.totalQuantity:parseFloat(L.totalQuantity.toFixed(2));if(l.text(`${I} ${L.unit||""} ${L.name}`,14,r),r+=6,L.sources&&L.sources.length>0){const D=L.sources.reduce((H,ne)=>{const se=`${ne.recipeName} (${ne.day} ${ne.time})`;return H[se]||(H[se]=0),H[se]+=ne.quantity,H},{});l.setFontSize(9),l.setTextColor(100);for(const H in D)m(),l.text(`  * ${H}`,18,r),r+=5;l.setTextColor(0)}r+=2}),r+=5}),l.save("liste-de-courses.pdf")}async function J(){if(!f){alert("Veuillez s√©lectionner un plan √† exporter.");return}const s=document.getElementById("loading-overlay");s&&s.classList.remove("hidden");try{const{jsPDF:l}=window.jspdf,d=new l,u=_(y,"plans",f.id),r=await Le(u),g=r.exists()?r.data():null;if(!g||!g.weeks){alert("Ce plan est vide et ne peut pas √™tre export√©.");return}d.setFontSize(18),d.text(`Plan de Repas: ${g.name}`,14,20);const h=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"],m={0:"E",1:"P",2:"A",3:"D"},v=Object.keys(g.weeks).sort((L,I)=>parseInt(L)-parseInt(I));let k=!0;for(const L of v){const D=g.weeks[L].menuData||{};if(Object.keys(D).length===0)continue;const H=[["Jour","Midi","Soir"]],ne=[],se=h.indexOf(g.startDay||"Lundi"),oe=[...h.slice(se),...h.slice(0,se)];for(const ge of oe){const ae=h.indexOf(ge);let Me=[],de=[];for(const ue of["lunch","dinner"])for(const me in m){const Be=`${ae}-${ue}-${me}`;D[Be]&&Array.isArray(D[Be])&&D[Be].forEach(ve=>{const _e=`[${m[me]}] ${ve.name}`;ue==="lunch"?Me.push(_e):de.push(_e)})}ne.push([ge,Me.join(`
`)||"-",de.join(`
`)||"-"])}d.setFontSize(14);const le=k?30:d.autoTable.previous.finalY+20;d.text(`Semaine ${L}`,14,le-5),d.autoTable({startY:le,head:H,body:ne,theme:"grid",styles:{cellPadding:2,fontSize:8,valign:"middle"},headStyles:{fillColor:[41,128,185],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[245,245,245]}}),k=!1}d.save(`plan_${g.name.replace(/ /g,"_")}.pdf`)}catch(l){console.error("Erreur lors de la g√©n√©ration du PDF du plan :",l),alert("Une erreur est survenue lors de la cr√©ation du PDF.")}finally{s&&s.classList.add("hidden")}}async function K(s,l,d,u=!1){if(!f)return alert("Veuillez s√©lectionner un plan.");const r=_(y,"plans",f.id);try{await Rn(y,async g=>{const h=await g.get(r);if(!h.exists())throw"Le plan n'existe plus.";const m=h.data().manualItems||[],v=`${s.trim().toLowerCase()}_${d||""}`,k=m.findIndex(I=>`${I.name.trim().toLowerCase()}_${I.unit||""}`===v);if(k>-1)m[k].totalQuantity+=l;else{const I=C.find(D=>D.name.toLowerCase()===s.trim().toLowerCase());m.push({name:s.trim(),totalQuantity:l,unit:d,source:"manual",category:I?.category||"Inconnue"})}const L=m.filter(I=>I.totalQuantity!==0);g.update(r,{manualItems:L,lastUpdated:new Date})})}catch(g){console.error("Erreur transactionnelle lors de l'ajustement de l'ingr√©dient: ",g),alert("Une erreur de synchronisation est survenue. Veuillez r√©essayer.")}}function Z(s){const l=s?s.toLowerCase():"";return l.includes("g")||l.includes("ml")?10:1}function fe(){const s=e.shoppingListContainer;if(!s)return;if(s.innerHTML="",x.length===0){s.innerHTML='<p class="text-center text-gray-500 italic py-4">Votre liste de courses est vide.</p>';return}const l=x.reduce((u,r)=>{const g=r.category||"Inconnue";return u[g]||(u[g]=[]),u[g].push(r),u},{});Object.keys(l).sort((u,r)=>u==="Inconnue"?1:r==="Inconnue"?-1:u.localeCompare(r)).forEach(u=>{const r=document.createElement("h4");r.className="text-sm font-bold text-stone-800 bg-stone-200 mt-4 mb-2 px-3 py-1 rounded-md",r.textContent=u,s.appendChild(r);const g=document.createElement("ul");g.className="space-y-2",l[u].sort((m,v)=>m.name.localeCompare(v.name)).forEach(m=>{const v=document.createElement("li");let k="p-2 rounded";v.className=k+(m.source==="manual"?" bg-lemon":" bg-gray-50");const L=document.createElement("div");L.className="flex justify-between items-center";const I=document.createElement("span");I.className="flex-grow text-sm font-medium",I.textContent=m.name,L.appendChild(I);const D=document.createElement("div");D.className="flex items-center space-x-2 mx-2";const H=document.createElement("span");H.className="font-medium w-20 text-center text-sm";const ne=Number.isInteger(m.totalQuantity)?m.totalQuantity:parseFloat(m.totalQuantity.toFixed(2));H.textContent=`${ne} ${m.unit||""}`.trim();const se=document.createElement("div");se.className="flex flex-col";const oe=document.createElement("button");oe.className="btn btn-outline btn-xs rounded-b-none",oe.textContent="+",oe.addEventListener("click",async()=>{const ae=Z(m.unit);await K(m.name,ae,m.unit)});const le=document.createElement("button");le.className="btn btn-outline btn-xs rounded-t-none -mt-px",le.textContent="-",le.addEventListener("click",async()=>{const ae=Z(m.unit);await K(m.name,-ae,m.unit)}),se.appendChild(oe),se.appendChild(le),D.appendChild(H),D.appendChild(se),L.appendChild(D);const ge=document.createElement("button");if(ge.className="delete-item-btn text-red-500 hover:text-red-700",ge.innerHTML='<i class="fas fa-trash-alt"></i>',ge.addEventListener("click",()=>{K(m.name,-m.totalQuantity,m.unit,!0)}),L.appendChild(ge),v.appendChild(L),m.sources&&m.sources.length>0){const ae=document.createElement("div");ae.className="p-2 mt-1 ml-4 rounded-md bg-stone-100";const Me=m.sources.reduce((de,ue)=>{const me=`${ue.recipeName} (${ue.day} ${ue.time})`;return de[me]||(de[me]=0),de[me]+=ue.quantity,de},{});for(const de in Me){const ue=document.createElement("span");ue.className="block text-xs text-gray-500",ue.textContent=`‚Ü≥ ${de}`,ae.appendChild(ue)}v.appendChild(ae)}g.appendChild(v)}),s.appendChild(g)})}async function G(){if(!f){x.length=0,fe();return}const s=f.manualItems?JSON.parse(JSON.stringify(f.manualItems)):[],l=new Map(s.map(r=>[`${r.name.trim().toLowerCase()}_${r.unit||""}`,r])),d=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];if(f.weeks)for(const r in f.weeks){const g=f.weeks[r],h=g.menuData||{},m=g.servingsData||{};for(const v in h){const k=h[v];if(!Array.isArray(k))continue;const[L,I]=v.split("-"),D=parseInt(L,10),H=d[D]||"Jour inconnu",ne=I==="lunch"?"midi":"soir",se=`${D}-${I}`,oe=parseInt(m[se]||f.defaultNumPeople,10);for(const le of k){const ae=w.find(de=>de.id===le.id)||le;if(!ae||!Array.isArray(ae.ingredients))continue;const Me=ae.servings||1;Me<=0||ae.ingredients.forEach(de=>{const{name:ue,quantity:me,unit:Be}=de;if(!ue||!me)return;const ve=C.find(be=>be.name.toLowerCase()===ue.trim().toLowerCase()),_e=ve?ve.category:"Inconnue",ke=parseFloat(String(me).replace(",","."));if(isNaN(ke))return;const Re=ke/Me*oe,$e=Be||"",Ge=`${ue.trim().toLowerCase()}_${$e}`,Oe={recipeName:ae.name,day:`${H} (S${r})`,time:ne,quantity:Re};if(l.has(Ge)){const be=l.get(Ge);be.totalQuantity+=Re,be.source==="manual"&&(be.source="mixed"),Array.isArray(be.sources)?be.sources.push(Oe):be.sources=[Oe]}else l.set(Ge,{name:ue.trim(),totalQuantity:Re,unit:$e,source:"plan",category:_e,sources:[Oe]})})}}}const u=Array.from(l.values()).filter(r=>r.totalQuantity>0);x.length=0,x.push(...u.sort((r,g)=>r.name.localeCompare(g.name))),fe()}function re(s){const l=$(s);if(!l||!e.mealSelectModal)return;e.mealSelectModalTitle.textContent=`S√©lectionner : ${l}`,e.mealSelectList.innerHTML="";const d=document.createElement("input");d.type="text",d.placeholder="Rechercher dans la cat√©gorie...",d.className="w-full p-2 mb-4 border border-gray-300 rounded-lg",e.mealSelectList.appendChild(d);const u=X(l),r=w.filter(m=>X(m.category)===u).sort((m,v)=>{const k=m.isFavorite?1:0,L=v.isFavorite?1:0;return L!==k?L-k:m.name.localeCompare(v.name)}),g=document.createElement("div");g.className="space-y-1 max-h-80 overflow-y-auto",e.mealSelectList.appendChild(g);function h(m=""){g.innerHTML="";const v=m.toLowerCase(),k=r.filter(L=>L.name.toLowerCase().includes(v));k.length===0?g.innerHTML='<p class="text-gray-500 p-4">Aucun plat ne correspond √† votre recherche.</p>':k.forEach(L=>{const I=document.createElement("button");I.className="w-full text-left p-2 hover:bg-gray-100 rounded-lg transition-colors duration-150";const D=document.createElement("p");D.className="font-medium text-gray-800 text-sm",L.isFavorite?D.innerHTML=`${L.name} <i class="fas fa-heart text-red-500 ml-2"></i>`:D.textContent=L.name,I.appendChild(D),I.addEventListener("click",()=>{Ze(s,L),ie()}),g.appendChild(I)})}d.addEventListener("input",m=>h(m.target.value)),h(),e.mealSelectModal.classList.remove("hidden"),d.focus()}function ie(){e.mealSelectModal&&e.mealSelectModal.classList.add("hidden")}function Se(s){E=s.target.closest(".meal-card");const l=E.closest(".meal-slot").dataset.slotId;s.dataTransfer.setData("text/plain",l),setTimeout(()=>{E&&(E.style.opacity="0.5")},0)}function A(){E&&(E.style.opacity="1",E=null)}function P(s){s.preventDefault();const l=s.target.closest(".meal-slot");l&&$(l.dataset.slotId)!=="Remarque"&&l.classList.add("bg-gray-200")}function M(s){const l=s.target.closest(".meal-slot");l&&l.classList.remove("bg-gray-200")}async function B(s){s.preventDefault();const l=s.dataTransfer.getData("text/plain"),d=s.target.closest(".meal-slot");if(d){d.classList.remove("bg-gray-200");const u=d.dataset.slotId,r=$(u);if(r==="Remarque")return;if(l&&u&&l!==u){const g=o[l],h=$(l);if(X(h)!==X(r)){alert(`Action impossible : un(e) "${h}" ne peut pas aller dans la cat√©gorie "${r}".`);return}const m=o[u];o[u]=g,m?o[l]=m:delete o[l],Ie(e.mealPlanGrid,{menuData:o,servingsData:c,remarksData:p,defaultNumPeople:b,startDay:i},!1),await N({[`weeks.${a}.menuData`]:o},"a d√©plac√© un plat"),await G()}}}function $(s){switch(s.split("-")[2]){case"0":return"Entr√©e";case"1":return"Plat";case"2":return"Accompagnement";case"3":return"Dessert";case"4":return"Remarque";default:return""}}function te(s,l,d,u=!1){const r=document.createElement("div");if(r.className="meal-card p-1 flex flex-col items-center bg-white rounded shadow-sm text-center relative w-full mb-1",u||(r.classList.add("cursor-grab"),r.draggable=!0),!u){const v=document.createElement("button");v.className="absolute -top-2 -right-1 text-base",v.innerHTML='<i class="fas fa-heart"></i>',s.isFavorite?v.classList.add("text-red-500"):v.classList.add("text-gray-300","hover:text-red-400"),v.addEventListener("click",k=>{k.stopPropagation(),At(s.id,s.isFavorite)}),v.addEventListener("mousedown",k=>k.stopPropagation()),r.appendChild(v)}const g=document.createElement("span");if(g.className="text-xs font-medium p-1 break-words w-full",g.textContent=s.name,s.imageUrl){const v=document.createElement("img");v.src=s.imageUrl,v.alt=s.name,v.className="w-16 h-12 object-cover rounded-md mx-auto",r.appendChild(v)}if(r.appendChild(g),!u){const v=document.createElement("div");v.className="absolute top-0 left-0 flex";const k=document.createElement("button");k.className="edit-meal-btn text-gray-600 hover:text-gray-800 hidden px-1 py-0.5",k.innerHTML='<i class="fas fa-pencil-alt fa-xs"></i>',k.title="Modifier la recette",k.addEventListener("click",I=>{I.stopPropagation();const D=w.find(H=>H.id===s.id);Ve.openForm(D||s,"Modifier la recette")}),k.addEventListener("mousedown",I=>I.stopPropagation()),v.appendChild(k);const L=document.createElement("button");L.className="delete-meal-btn text-red-700 hover:text-red-900 hidden px-1 py-0.5",L.innerHTML='<i class="fas fa-times-circle fa-xs"></i>',L.title="Retirer du planning",L.addEventListener("click",I=>{I.stopPropagation(),et(l,d)}),L.addEventListener("mousedown",I=>I.stopPropagation()),v.appendChild(L),r.appendChild(v),r.addEventListener("mouseenter",()=>{k.classList.remove("hidden"),L.classList.remove("hidden")}),r.addEventListener("mouseleave",()=>{k.classList.add("hidden"),L.classList.add("hidden")})}const h=document.createElement("div");h.className="absolute bottom-1 right-1";const m=document.createElement("button");return m.className="info-meal-btn bg-gray-500 text-white hover:bg-gray-600 rounded w-3 h-3 flex items-center justify-center shadow-sm",m.innerHTML='<i class="fas fa-plus fa-xs"></i>',m.title="Plus d'infos",m.dataset.slotId=l,m.dataset.mealIndex=d,m.addEventListener("mousedown",v=>v.stopPropagation()),h.appendChild(m),r.appendChild(h),r}function We(s,l){if(document.querySelectorAll(".planner-ingredient-tooltip").forEach(h=>h.remove()),T===s){s.classList.remove("info-open"),s.innerHTML='<i class="fas fa-plus fa-xs"></i>',T=null;return}T&&(T.classList.remove("info-open"),T.innerHTML='<i class="fas fa-plus fa-xs"></i>'),s.classList.add("info-open"),s.innerHTML='<i class="fas fa-times fa-xs"></i>',T=s;const d=document.createElement("div");if(d.className="planner-ingredient-tooltip z-50 w-64 p-3 bg-white border border-gray-200 rounded-lg shadow-lg text-left text-sm",l.ingredients&&l.ingredients.length>0){if(l.servings&&l.servings>0){const v=document.createElement("p");v.className="mb-2 text-sm text-gray-600 flex items-center",v.innerHTML=`<i class="fas fa-users mr-2"></i> Pour ${l.servings} ${l.servings>1?"personnes":"personne"}`,d.appendChild(v)}const h=document.createElement("h4");h.className="font-bold mb-2 text-gray-800",h.textContent="Ingr√©dients :",d.appendChild(h);const m=document.createElement("ul");m.className="space-y-1 text-gray-600",l.ingredients.forEach(v=>{const k=document.createElement("li");k.textContent=`‚Ä¢ ${v.quantity||""} ${v.unit||""} ${v.name}`.trim(),m.appendChild(k)}),d.appendChild(m)}else d.textContent="Aucun ingr√©dient sp√©cifi√© pour cette recette.";document.body.appendChild(d);const u=s.closest(".meal-card").getBoundingClientRect(),r=d.getBoundingClientRect();if(window.innerWidth<768){d.style.width="90vw",d.style.maxWidth="320px";const h=d.getBoundingClientRect();let m=u.bottom+10,v=(window.innerWidth-h.width)/2;m+h.height>window.innerHeight&&(m=u.top-h.height-10),d.style.top=`${m}px`,d.style.left=`${v}px`}else{let h=u.right+10;h+r.width>window.innerWidth&&(h=u.left-r.width-10);let m=u.top;m+r.height>window.innerHeight&&(m=u.bottom-r.height),m<10&&(m=10),d.style.left=`${h}px`,d.style.top=`${m}px`}d.style.position="fixed"}function Ye(s,l=!1){const d=document.createElement("div"),u=document.createElement("button");return l?(d.className="w-full flex justify-center pt-1",u.className="add-more-meal-btn text-gray-400 hover:text-green-500 transition-colors duration-150",u.innerHTML='<i class="fas fa-plus-circle"></i>',u.title="Ajouter une autre recette"):(d.className="flex items-center justify-center h-full",u.className="add-meal-btn text-green-500 hover:text-green-700 transition-transform duration-150 hover:scale-125",u.innerHTML='<i class="fas fa-plus-circle text-lg"></i>'),u.addEventListener("click",()=>re(s)),d.appendChild(u),d}function Je(s,l,d=!1){if(d){const r=document.createElement("p");return r.className="w-full h-full p-1 text-xs text-gray-700",r.textContent=l[s]||"",r}const u=document.createElement("textarea");return u.className="w-full h-full p-1 text-xs bg-white border-0 rounded focus:outline-none focus:ring-1 focus:ring-tomato resize-none",u.placeholder="Remarque...",u.value=p[s]||"",u.dataset.slotId=s,u.addEventListener("change",r=>{const g=r.target.value;g?p[s]=g:delete p[s];const[h,m]=s.split("-"),L=`a modifi√© la remarque pour ${R[parseInt(h,10)]} ${m==="lunch"?"midi":"soir"}`;N({[`weeks.${a}.remarksData`]:p},L)}),u.addEventListener("focus",r=>{gt({type:"editing_remark",fieldId:s})}),u.addEventListener("blur",r=>{gt("idle")}),u}function Ke(){document.querySelectorAll(".meal-card").forEach(s=>{s.addEventListener("dragstart",Se),s.addEventListener("dragend",A)}),document.querySelectorAll(".meal-slot").forEach(s=>{s.addEventListener("dragover",P),s.addEventListener("dragleave",M),s.addEventListener("drop",B)})}async function Ze(s,l){const d=JSON.parse(JSON.stringify(o)),u=d[s],r={id:l.id};Array.isArray(u)?u.push(r):d[s]=[r];const[g,h]=s.split("-"),m=R[parseInt(g,10)],v=h==="lunch"?"midi":"soir",k=`a ajout√© '${l.name}' √† ${m} ${v}`;await N({[`weeks.${a}.menuData`]:d},k),ie()}async function et(s,l){if(!f||!o[s]||!Array.isArray(o[s]))return;const d=o[s][l],u=JSON.parse(JSON.stringify(o));u[s].splice(l,1),u[s].length===0&&delete u[s];const[r,g]=s.split("-"),h=R[parseInt(r,10)],m=g==="lunch"?"midi":"soir",v=`a supprim√© '${d.name}' de ${h} ${m}`;await N({[`weeks.${a}.menuData`]:u},v)}async function qt(){if(confirm("Voulez-vous vraiment vider le menu de cette semaine ?")){const s={id:availablePlans.length>0?availablePlans[0].id:`${ye()}_semaine-${a}`,name:availablePlans.length>0?availablePlans[0].name:"Mon plan",menuData:{},servingsData:{},remarksData:{},defaultNumPeople:b,startDay:i,lastUpdated:new Date};loadPlan(s),availablePlans.length>0?availablePlans[0]=s:availablePlans.push(s),await N({[`weeks.${a}`]:{menuData:{},servingsData:{},remarksData:{}}},`a vid√© le menu de la semaine ${a}`)}}function Ut(s){s>=1&&s<=52&&(a=s,j())}function Ln(){e.currentWeekDisplay&&(e.currentWeekDisplay.textContent=`Semaine ${a}`)}function Cn(){e.prevWeekBtn?.addEventListener("click",()=>Ut(a-1)),e.nextWeekBtn?.addEventListener("click",()=>Ut(a+1)),e.clearMenuBtn?.addEventListener("click",qt),e.startDaySelect?.addEventListener("change",async d=>{i=d.target.value,f&&await N({startDay:i},`a chang√© le premier jour de la semaine √† '${i}'`)}),e.planSelect?.addEventListener("change",Ft),e.closeMealSelectModalBtn?.addEventListener("click",ie),e.mealSelectModal?.addEventListener("click",d=>{d.target===e.mealSelectModal&&ie()}),e.closeRecipeModalBtn?.addEventListener("click",()=>Ve.closeForm()),e.cancelRecipeBtn?.addEventListener("click",()=>Ve.closeForm()),e.importListBtn?.addEventListener("click",Pe),e.closeImportListModalBtn?.addEventListener("click",Ue),e.importListModal?.addEventListener("click",d=>{d.target===e.importListModal&&Ue()}),e.exportTxtBtn?.addEventListener("click",S),e.exportPdfBtn?.addEventListener("click",W),e.exportPlanPdfBtn?.addEventListener("click",J);const s=d=>{const u=d.target.closest(".info-meal-btn");if(u){const r=u.dataset.slotId,g=parseInt(u.dataset.mealIndex,10);if(r&&!isNaN(g)){const h=o[r]?.[g];if(h&&h.id){const m=w.find(v=>v.id===h.id);m&&We(u,m)}}}};e.mealPlanGrid?.addEventListener("click",s),document.getElementById("mobile-meal-plan")?.addEventListener("click",s),e.sharePlanBtn?.addEventListener("click",()=>{if(!f){alert("Veuillez s√©lectionner un plan √† partager.");return}jt({plan:f})}),e.inviteParticipantBtn?.addEventListener("click",()=>{if(!f){alert("Veuillez s√©lectionner un plan pour inviter des participants.");return}rn(f)}),e.historyPlanBtn?.addEventListener("click",xe),e.closePlanHistoryModalBtn?.addEventListener("click",O),e.planHistoryModal?.addEventListener("click",d=>{d.target===e.planHistoryModal&&O()}),e.savePlanBtn?.addEventListener("click",async()=>{if(!f){alert("Veuillez s√©lectionner un plan de travail avant de sauvegarder.");return}const d=document.getElementById("save-plan-as-modal"),u=document.getElementById("save-plan-as-form"),r=document.getElementById("save-plan-name"),g=document.getElementById("cancel-save-plan-as-btn"),h=document.getElementById("close-save-plan-as-modal"),m=new Date().toLocaleDateString("fr-FR"),v=f.weeks?Object.keys(f.weeks).filter(D=>f.weeks[D]&&Object.keys(f.weeks[D].menuData||{}).length>0).length:0,k=v>1?`${v} semaines`:`${v} semaine`;r.value=`${f.name} (${k}) - ${m}`,d.classList.remove("hidden");const L=async D=>{D.preventDefault();const H=r.value;if(!H)return;f.weeks||(f.weeks={}),f.weeks[a]={menuData:o,servingsData:c,remarksData:p},f.startDay=i,f.defaultNumPeople=b;const ne=JSON.parse(JSON.stringify(f));if(ne.weeks)for(const se in ne.weeks){const oe=ne.weeks[se];if(oe&&oe.menuData)for(const le in oe.menuData){const ge=oe.menuData[le];Array.isArray(ge)&&(oe.menuData[le]=ge.map(ae=>ae&&ae.id&&w.find(de=>de.id===ae.id)||ae))}}await pn(H,ne),d.classList.add("hidden"),u.removeEventListener("submit",L)},I=()=>{d.classList.add("hidden"),u.removeEventListener("submit",L)};u.addEventListener("submit",L,{once:!0}),g.addEventListener("click",I,{once:!0}),h.addEventListener("click",I,{once:!0})})}function In(s=""){return s.split(" ").map(u=>u[0]).join("").substring(0,2).toUpperCase()}function Et(s=[],l={}){const d=document.getElementById("collaborators-bar"),u=document.getElementById("activity-labels-container"),r=document.getElementById("name-tooltip");if(!d||!r||!u)return;if(d.innerHTML="",u.innerHTML="",document.querySelectorAll(".remark-lock-overlay").forEach(m=>m.remove()),document.querySelectorAll("textarea[data-slot-id]").forEach(m=>{m.disabled=!1}),s.length<=1&&Object.keys(l).length<=1){d.classList.add("hidden");return}let g="";const h=ye();s.forEach(m=>{if(!m)return;const v=l.hasOwnProperty(m.uid),k=l[m.uid]||{},L=document.createElement("div");L.className="w-8 h-8 rounded-full flex items-center justify-center bg-gray-300 text-white font-bold text-xs ring-2 ring-white cursor-pointer transition-all duration-300";const I=v?"(pr√©sent)":"(absent)";if(L.dataset.name=`${m.displayName||"Inconnu"} ${I}`,m.photoURL?L.innerHTML=`<img src="${m.photoURL}" alt="${m.displayName}" class="w-full h-full rounded-full object-cover">`:L.textContent=In(m.displayName),v||L.classList.add("grayscale","opacity-50"),L.addEventListener("mouseenter",D=>{r.textContent=D.currentTarget.dataset.name,r.classList.remove("hidden");const H=D.currentTarget.getBoundingClientRect();r.style.left=`${H.left+H.width/2-r.offsetWidth/2}px`,r.style.top=`${H.top-r.offsetHeight-5}px`}),L.addEventListener("mouseleave",()=>{r.classList.add("hidden")}),d.appendChild(L),v&&m.uid!==h){const D=k.status;if(typeof D=="object"&&D.type==="editing_remark"){const H=document.querySelector(`textarea[data-slot-id="${D.fieldId}"]`);if(H){H.disabled=!0;const ne=document.createElement("div");ne.className="remark-lock-overlay absolute inset-0 bg-gray-400 bg-opacity-25 flex items-center justify-center text-xs text-white font-bold",ne.innerHTML=`<i class="fas fa-lock mr-1"></i> ${m.displayName} √©crit...`,H.parentElement&&(H.parentElement.classList.add("relative"),H.parentElement.appendChild(ne))}}else if(typeof D=="string"&&D!=="idle"){let H="";switch(D){case"editing_recipe":H="modifie une recette...";break}H&&(g+=`<span class="italic mr-4">${m.displayName} ${H}</span>`)}}}),u.innerHTML=g,d.classList.remove("hidden")}function Ft(){En();const s=e.planSelect.value;f=z.find(h=>h.id===s)||null;const l=document.getElementById("delete-plan-btn"),d=document.getElementById("rename-plan-btn"),u=document.getElementById("leave-plan-btn"),r=document.getElementById("invite-participant-btn"),g=document.getElementById("history-plan-btn");if(l&&(l.style.display=f&&f.isOwner?"inline-flex":"none"),d&&(d.style.display=f&&f.isOwner?"inline-flex":"none"),g&&(g.style.display=f&&f.isOwner?"inline-flex":"none"),u&&(u.style.display=f&&!f.isOwner?"inline-flex":"none"),r){const h=f&&(f.type==="collaborative"||f.collaborators&&f.collaborators.length>0);r.style.display=f&&f.isOwner&&h?"inline-flex":"none"}f&&f.participants&&f.participants.length>1?(Et(f.participants,{}),xn(f.id,h=>{Et(f.participants,h)})):Et([],{}),f&&(f.manualItems=f.manualItems||[]),j()}async function Ot(s,l){if(!f)return;const d=JSON.parse(JSON.stringify(c));l===b?delete d[s]:d[s]=l;const[u,r]=s.split("-"),m=`a chang√© le nombre de personnes pour ${R[parseInt(u,10)]} ${r==="lunch"?"midi":"soir"} √† ${l}`;await N({[`weeks.${a}.servingsData`]:d},m)}async function Bn(){if(!y)return;const s=un();Cn(),F(),await q();const l=Fe(U(y,"recipes"),u=>{if(console.log("Recipe data updated from listener."),w=u.docs.map(r=>{const g=r.data();return{id:r.id,...g,imageUrl:g.imageUrl||""}}),f){for(const r in o){const g=o[r];if(Array.isArray(g)){const h=g.map(m=>{if(m&&m.id){const v=w.find(k=>k.id===m.id);return v?{...v}:m}return m});o[r]=h}}Ie(e.mealPlanGrid,{menuData:o,servingsData:c,remarksData:p,defaultNumPeople:b,startDay:i},!1),Ee(document.getElementById("mobile-meal-plan"),{menuData:o,servingsData:c,remarksData:p,defaultNumPeople:b,startDay:i},!1),G()}}),d=dn(u=>{z=u,cn(u);const r=localStorage.getItem("selectedPlanId");r&&u.some(g=>g.id===r)&&(e.planSelect.value=r,localStorage.removeItem("selectedPlanId")),Ft()});return()=>{d(),l(),s()}}const kn=Bn();return async()=>{const s=await kn;typeof s=="function"&&s()}}const wa=Object.freeze(Object.defineProperty({__proto__:null,default:Ea},Symbol.toStringTag,{value:"Module"}));function La(){const e=wn();return Ht(),()=>{typeof e=="function"&&e()}}async function Ht(){const e=document.getElementById("received-shares-container"),t=ye();if(!(!t||!e)){e.innerHTML='<p class="text-gray-500">Chargement des partages re√ßus...</p>';try{const n=pe(U(y,"plans"),ee("userId","==",t),ee("isShared","==",!0)),a=pe(U(y,"plans"),ee("collaborators","array-contains",t)),[i,o]=await Promise.all([he(n),he(a)]);let c=[];if(i.forEach(p=>c.push({id:p.id,type:"Planification (Copie)",...p.data()})),o.forEach(p=>c.push({id:p.id,type:"Planification (Collaboratif)",...p.data()})),c.length===0){e.innerHTML=`<p class="text-gray-500">Vous n'avez aucun contenu partag√© par d'autres utilisateurs.</p>`;return}c.sort((p,x)=>(x.sharedAt?.seconds||x.lastUpdated?.seconds||0)-(p.sharedAt?.seconds||p.lastUpdated?.seconds||0)),e.innerHTML="";for(const p of c){const x=p.originalOwnerId||p.userId;if(!x)continue;const E=await Le(_(y,"users",x)),w=E.exists()?E.data().displayName:"Utilisateur inconnu";e.appendChild(Ca(p,w))}}catch(n){console.error("Erreur lors du chargement des partages re√ßus : ",n),e.innerHTML='<p class="text-red-500">Une erreur est survenue.</p>'}}}function Ca(e,t){const n=document.createElement("div");n.className="bg-white rounded-lg p-4 flex justify-between items-center shadow-sm";const a=document.createElement("div"),i=document.createElement("p");i.className="font-bold text-gray-800";let o="";e.type.includes("Collaboratif")?o=' <span class="text-xs font-medium bg-blue-100 text-blue-800 px-2 py-1 rounded-full">Collab</span>':e.type.includes("Copie")&&(o=' <span class="text-xs font-medium bg-gray-200 text-gray-800 px-2 py-1 rounded-full">Copie</span>'),i.innerHTML=`${e.name}${o}`;const c=document.createElement("p");c.className="text-sm text-gray-500 mt-1";const p=e.sharedAt?new Date(e.sharedAt.seconds*1e3).toLocaleDateString("fr-FR"):e.lastUpdated?new Date(e.lastUpdated.seconds*1e3).toLocaleDateString("fr-FR"):"date inconnue";c.textContent=`Partag√© par ${t} le ${p}`,a.appendChild(i),a.appendChild(c),n.appendChild(a);const x=document.createElement("button");return x.className="btn btn-ghost text-red-500 btn-sm",x.innerHTML='<i class="fas fa-trash"></i>',x.title="Supprimer ce contenu partag√©",x.addEventListener("click",()=>Ia(e.id,e.type)),n.appendChild(x),n}async function Ia(e,t){if(confirm(`Voulez-vous vraiment supprimer cette ${t.toLowerCase()} partag√©e ?`))try{const n=t.startsWith("Planification")?"plans":"shopping_lists",a=_(y,n,e),i=await Le(a);i.exists()&&i.data().userId===ye()?(await Ae(a),Ht()):(alert("Vous n'avez pas la permission de supprimer cet √©l√©ment ou il a d√©j√† √©t√© supprim√©."),Ht())}catch(n){console.error("Erreur de suppression: ",n),alert("Une erreur est survenue.")}}async function wn(){const e=document.getElementById("sent-shares-container"),t=ye();if(!t||!e)return()=>{};e.innerHTML='<p class="text-gray-500">Chargement des partages envoy√©s...</p>';const n=U(y,"shares"),a=pe(n,ee("senderId","==",t));return Fe(a,async i=>{if(i.empty){e.innerHTML=`<p class="text-gray-500">Vous n'avez envoy√© aucun partage.</p>`;return}const o=i.docs.sort((c,p)=>(p.data().createdAt?.seconds||0)-(c.data().createdAt?.seconds||0));e.innerHTML="";for(const c of o){const p=c.data();try{const x=await Le(_(y,"users",p.receiverId));if(x.exists()){const E=x.data();e.appendChild(Ba(p,E.displayName,c.id))}}catch(x){console.error("Could not load receiver for sent share",x)}}},i=>{console.error("Erreur lors du chargement des partages envoy√©s : ",i),e&&(e.innerHTML='<p class="text-red-500">Une erreur est survenue.</p>')})}function Ba(e,t,n){const a=document.createElement("div");a.className="bg-white rounded-lg p-4 flex justify-between items-center shadow-sm";const i=document.createElement("div"),o=document.createElement("p");o.className="font-bold text-gray-800";let c=[];e.plan&&c.push("Planification"),e.shoppingList&&c.push("Liste de courses"),o.textContent=c.join(" et ");const p=document.createElement("p");p.className="text-sm text-gray-500";const x=new Date(e.createdAt.seconds*1e3).toLocaleDateString("fr-FR");p.textContent=`Envoy√© √† ${t} le ${x}`,i.appendChild(o),i.appendChild(p),a.appendChild(i);const E=document.createElement("div");E.className="flex items-center space-x-4";const w=document.createElement("span");w.textContent=e.status;let C="bg-gray-200 text-gray-800";switch(e.status){case"accepted":C="bg-green-100 text-green-800";break;case"declined":C="bg-red-100 text-red-800";break;case"pending":C="bg-yellow-100 text-yellow-800";break}w.className=`text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full ${C}`,E.appendChild(w);const b=document.createElement("button");return b.className="btn btn-ghost text-red-500 btn-sm",b.innerHTML='<i class="fas fa-trash"></i>',b.title="Annuler le partage",b.addEventListener("click",()=>ka(n)),E.appendChild(b),a.appendChild(E),a}async function ka(e){if(confirm("Voulez-vous vraiment annuler ce partage ? L'autre utilisateur ne le verra plus."))try{await Ae(_(y,"shares",e)),wn()}catch(t){console.error("Erreur lors de la suppression du partage: ",t),alert("Une erreur est survenue.")}}const Sa=Object.freeze(Object.defineProperty({__proto__:null,default:La},Symbol.toStringTag,{value:"Module"}));function Ma(){const e=localStorage.getItem("selectedPlanId"),t=document.getElementById("plan-view-name"),n=document.getElementById("meal-plan-grid"),a=document.getElementById("close-view-plan-btn");if(a&&a.addEventListener("click",()=>{localStorage.removeItem("selectedPlanId"),rt("plans")}),!e)return t&&(t.textContent="Aucune sauvegarde s√©lectionn√©e"),n&&(n.innerHTML=`<p class="text-center text-red-500">Erreur : Aucun ID de sauvegarde trouv√©. Veuillez retourner √† la page 'Mes Plans Sauvegard√©s' et en s√©lectionner une.</p>`),()=>{};async function i(){try{const o=_(y,"plan_saves",e),c=await Le(o);if(!c.exists())throw new Error("Sauvegarde non trouv√©e");const p=c.data(),x=p.planData;if(!x)throw new Error("Les donn√©es du plan sauvegard√© sont corrompues ou manquantes.");t&&(t.textContent=`Vue de : ${p.name}`),Na(n,x)}catch(o){console.error("Error fetching save:",o),t&&(t.textContent="Erreur"),n&&(n.innerHTML=`<p class="text-center text-red-500">${o.message}</p>`)}}return i(),()=>{localStorage.removeItem("selectedPlanId")}}function Na(e,t){if(!e)return;e.innerHTML="";const n=Object.keys(t.weeks||{}).sort((a,i)=>parseInt(a)-parseInt(i));if(n.length===0){e.innerHTML='<p class="text-center text-gray-500 p-10 col-span-full">Ce plan est vide.</p>';return}n.forEach(a=>{const i=t.weeks[a],o=document.createElement("h3");o.className="text-lg font-bold text-gray-700 mt-6 mb-2 col-span-full",o.textContent=`Semaine ${a}`,e.appendChild(o);const c=document.createElement("div");Ta(c,i,t.startDay,t.defaultNumPeople),e.appendChild(c)})}function Ta(e,t,n,a){const i=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"],o=i.indexOf(n||"Lundi"),c=[...i.slice(o),...i.slice(0,o)],p=t.menuData||{},x=t.servingsData||{},E=t.remarksData||{};c.forEach(w=>{const C=i.indexOf(w),b=document.createElement("div");b.className="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] items-stretch border-b border-gray-300";const T=document.createElement("div");T.className="font-bold p-2 flex items-center justify-center bg-gray-100 text-sm border-r border-gray-300",T.textContent=w.toUpperCase(),b.appendChild(T),["lunch","dinner"].forEach(z=>{const f=`${C}-${z}`,R=x[f]||a||1,X=document.createElement("div");X.className="border-r border-gray-300 flex items-center justify-center",X.innerHTML=`<div class="text-center"><i class="fas fa-users fa-xs mb-1"></i><br>${R}</div>`,b.appendChild(X);for(let De=0;De<5;De++){const q=`${C}-${z}-${De}`,j=document.createElement("div");if(j.className="meal-slot p-1 min-h-[50px] border-r border-gray-300",De===4)j.textContent=E[q]||"",j.classList.add("text-xs","italic","text-gray-600");else{const N=p[q];Array.isArray(N)&&N.length>0&&N.forEach(O=>{const Y=document.createElement("div");Y.className="p-1 bg-white rounded shadow-sm text-center text-xs font-medium",Y.textContent=O.name,j.appendChild(Y)})}b.appendChild(j)}}),e.appendChild(b)})}const Da=Object.freeze(Object.defineProperty({__proto__:null,default:Ma},Symbol.toStringTag,{value:"Module"})),Yt=document.querySelector("main"),Pa={menu:{html:`
        <div class="flex flex-col md:flex-row md:space-x-2">

            <!-- Left Column: Meal Planner -->
            <div class="w-full md:w-5/6">
                <section id="meal-planning-section" aria-labelledby="meal-planning-heading" class="mb-8 md:mb-12">
                                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                                        <h2 id="meal-planning-heading" class="text-xl md:text-2xl font-bold text-gray-800">Planification des repas</h2>
                                        <div class="mt-3 md:mt-0 flex items-center space-x-2 md:space-x-3 plan-actions">
                                            <button id="generate-plan-ai-btn" class="btn btn-primary btn-sm">
                                                <i class="fas fa-robot mr-1 md:mr-2"></i> IA Semaine
                                            </button>
                                            <button id="clear-menu-btn" class="btn btn-outline btn-sm text-red-800 hover:bg-red-100">
                                                <i class="fas fa-trash-alt mr-1 md:mr-2"></i> Vider le menu
                                            </button>
                                            <button id="export-plan-pdf-btn" class="btn btn-outline btn-sm">
                                                <i class="fas fa-file-pdf mr-1 md:mr-2"></i> Exporter Plan (PDF)
                                            </button>
                                            <button id="share-plan-btn" class="btn btn-secondary btn-sm">
                                                <i class="fas fa-share-alt mr-1 md:mr-2"></i> Partager
                                            </button>
                                            <button id="save-plan-btn" class="btn btn-secondary btn-sm">
                                                <i class="fas fa-save mr-1 md:mr-2"></i> Sauvegarder Plan
                                            </button>
                                        </div>
                                    </div>
                            
                                    <!-- Week Navigation & Plan Selector -->
                                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 space-y-3 md:space-y-0">
                                        <!-- Week Navigation -->
                                        <div class="flex justify-between items-center bg-white p-2 md:p-3 rounded-lg shadow-sm">
                                            <button id="prev-week-btn" class="btn btn-ghost btn-sm" aria-label="Semaine pr√©c√©dente">
                                                <i class="fas fa-chevron-left mr-1 md:mr-2"></i> Pr√©c.
                                            </button>
                                            <div id="current-week-display" class="text-gray-700 font-medium text-sm md:text-base text-center mx-4">Semaine X</div>
                                            <button id="next-week-btn" class="btn btn-ghost btn-sm" aria-label="Semaine suivante">
                                                Suiv. <i class="fas fa-chevron-right ml-1 md:ml-2"></i>
                                            </button>
                                        </div>
                                        <!-- Plan Selector -->
                                        <div class="flex flex-wrap items-center justify-center gap-2 bg-white p-3 rounded-lg shadow-sm">
                                            <label for="plan-select" class="text-sm font-medium text-gray-700">Plan affich√©:</label>
                                            <select id="plan-select" class="rounded-md border-gray-300 shadow-sm focus:border-tomato focus:ring focus:ring-tomato focus:ring-opacity-50 text-sm py-1">
                                                <!-- Options will be generated by JS -->
                                            </select>
                                            <button id="create-plan-btn" class="btn btn-primary btn-sm" title="Cr√©er un nouveau plan">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                            <button id="rename-plan-btn" class="btn btn-ghost text-blue-500 hover:bg-blue-100 btn-sm" title="Renommer le plan s√©lectionn√©">
                                                <i class="fas fa-pencil-alt"></i>
                                            </button>
                                            <button id="history-plan-btn" class="btn btn-ghost text-purple-500 hover:bg-purple-100 btn-sm" title="Historique des modifications">
                                                <i class="fas fa-history"></i>
                                            </button>
                                            <button id="leave-plan-btn" class="btn btn-ghost text-yellow-600 hover:bg-yellow-100 btn-sm" title="Quitter le plan collaboratif">
                                                <i class="fas fa-door-open"></i>
                                            </button>
                                            <button id="delete-plan-btn" class="btn btn-ghost text-red-500 hover:bg-red-100 btn-sm" title="Supprimer le plan s√©lectionn√©">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            <button id="invite-participant-btn" class="btn btn-ghost text-green-500 hover:bg-green-100 btn-sm hidden" title="Inviter un participant">
                                                <i class="fas fa-user-plus"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Collaborators Bar -->
                                    <div id="collaborators-bar" class="flex items-center space-x-2 mb-4 hidden">
                                        <!-- Avatars will be injected here -->
                                    </div>

                                    <!-- Activity Labels -->
                                    <div id="activity-labels-container" class="text-sm text-gray-600 mb-4 h-6">
                                        <!-- e.g., 'Sophie is adding a recipe...' -->
                                    </div>
                            
                                            <!-- Settings Section -->
                                            <div class="inline-flex items-center space-x-6 bg-white p-3 rounded-lg shadow-sm mb-4">                                        <div>
                                            <label for="start-day-select" class="text-sm font-medium text-gray-700">D√©but de semaine:</label>
                                            <select id="start-day-select" class="rounded-md border-gray-300 shadow-sm focus:border-tomato focus:ring-tomato text-sm py-1">
                                                <option>Lundi</option>
                                                <option>Mardi</option>
                                                <option>Mercredi</option>
                                                <option>Jeudi</option>
                                                <option>Vendredi</option>
                                                <option>Samedi</option>
                                                <option>Dimanche</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="default-servings-input" class="text-sm font-medium text-gray-700">Personnes par d√©faut:</label>
                                            <div id="default-servings-control" class="mt-1"></div>
                                        </div>
                                    </div>                    <!-- Responsive Meal Plan Grid -->
<div class="bg-white rounded-xl shadow-md p-4">
                        <!-- Desktop Grid (Visible on large screens) -->
                        <div id="desktop-plan-container" class="hidden lg:block">
                            <div id="meal-plan-grid-layout">
                                <!-- Header -->
                                <div class="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] gap-1 text-center mb-1">
                                    <div class="p-2"></div> <!-- Empty corner -->
                                    <div class="p-2 rounded-t-lg bg-amber-100 text-amber-800 font-bold col-span-6">MIDI</div>
                                    <div class="p-2 rounded-t-lg bg-stone-200 text-stone-800 font-bold col-span-6">SOIR</div>
                                    
                                    <div class="p-1"></div> <!-- Empty under day name -->
                                    <div class="p-1 text-xs font-semibold"><i class="fas fa-users"></i></div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Entr√©e</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Plat</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Accomp.</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Dessert</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Remarque</div>

                                    <div class="p-1 text-xs font-semibold"><i class="fas fa-users"></i></div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Entr√©e</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Plat</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Accomp.</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Dessert</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Remarque</div>
                                </div>
                                <!-- Rows generated by JS -->
                                <div id="meal-plan-grid" class="space-y-1">
                                    <div class="p-10 text-center text-gray-500 italic col-span-full">Chargement du planning...</div>
                                </div>
                            </div>
                        </div>

                        <!-- Mobile Accordion (Visible on small screens) -->
                        <div id="mobile-meal-plan" class="lg:hidden space-y-2">
                            <!-- Mobile content will be generated by JS here -->
                             <div class="p-10 text-center text-gray-500 italic col-span-full">Chargement du planning...</div>
                        </div>
                    </div>
                                    </section>


                                </div>
                    
                                <!-- Right Column: Shopping List -->
                                <div class="w-full md:w-1/6">
                                    <section id="shopping-list-section" aria-labelledby="shopping-list-heading" class="mb-8 md:mb-12 md:sticky md:top-24">
                                        <div class="bg-white rounded-xl shadow-md p-4 md:p-6">
                                            <h2 id="shopping-list-heading" class="text-xl md:text-2xl font-bold text-gray-800 mb-4">Liste de courses</h2>
                                            <div class="flex justify-end space-x-2 mb-4">
                                                <button id="import-list-btn" class="btn btn-secondary btn-sm">
                                                    <i class="fas fa-download mr-2"></i>Importer une liste
                                                </button>
                                                <div id="export-buttons-container" class="flex space-x-2">
                                                    <button id="export-txt-btn" class="btn btn-outline btn-sm">
                                                        <i class="fas fa-file-alt mr-2"></i>TXT
                                                    </button>
                                                    <button id="export-pdf-btn" class="btn btn-outline btn-sm">
                                                        <i class="fas fa-file-pdf mr-2"></i>PDF
                                                    </button>
                                                </div>
                                            </div>
                    
                                            <!-- Shopping List Container -->
                                            <div id="shopping-list-container" class="mb-4 max-h-[70vh] overflow-y-auto pr-2">                            <ul id="shopping-list" class="space-y-2 text-sm">
                                <!-- Les articles de la liste de courses seront g√©n√©r√©s ici -->
                            </ul>
                        </div>

                        <!-- Add Item Input -->
                        <div class="mt-4 flex items-stretch">
                            <div class="relative flex-grow">
                                <input type="text" id="add-item-input" placeholder="Chercher ou ajouter..." class="w-full border border-gray-300 rounded-l-lg px-2 py-1 text-xs focus:outline-none focus:ring-2 focus:ring-tomato focus:border-transparent">
                                <div id="add-item-results" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto bottom-full mb-2"></div>
                            </div>
                            <button id="add-item-btn" class="btn btn-primary rounded-l-none -ml-px btn-xs" aria-label="Ajouter l'article">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>

                         <!-- AI Shopping Tips Placeholder -->
                        <div id="ai-shopping-tip" class="mt-6 bg-avocado bg-opacity-10 rounded-lg p-3 hidden">
                            <div class="flex items-start">
                                 <div class="w-8 h-8 bg-avocado bg-opacity-20 rounded-full flex items-center justify-center mr-3 shrink-0">
                                    <i class="fas fa-lightbulb text-avocado"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-avocado mb-1 text-sm">Astuce √âconomique</h4>
                                    <p id="ai-shopping-tip-text" class="text-sm text-gray-700">...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <!-- Shared Plans Modal -->
        <div id="shared-plans-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-6xl max-h-[90vh] overflow-y-auto relative">
                <button id="close-shared-plans-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" aria-label="Fermer">
                    <i class="fas fa-times text-xl"></i>
                </button>
                <h3 id="shared-plans-modal-title" class="text-2xl font-bold mb-6">Plans partag√©s pour la Semaine X</h3>
                <div id="shared-plans-modal-container" class="space-y-6">
                    <!-- Shared plans will be loaded here -->
                </div>
            </div>
        </div>
        `,script:"./script.js"},recipes:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Recettes</h2>
            <button id="add-recipe-btn" class="btn btn-primary">
                <i class="fas fa-plus mr-2"></i> Ajouter une recette
            </button>
        </div>

        <!-- Search Bar -->
        <div class="mb-6">
            <input type="text" id="search-bar" placeholder="Rechercher une recette..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-tomato focus:border-tomato">
        </div>

        <!-- Tabs Navigation -->
        <div id="category-tabs" class="mb-6 border-b border-gray-200 flex space-x-4 flex-nowrap overflow-x-auto pb-2">
            <!-- Tabs will be generated by recipes.js here -->
        </div>

        <!-- Recipe List Container -->
        <div id="recipe-list-container">
            <!-- Recipes for the selected tab will be loaded here -->
        </div>

        <!-- Reconstructed Recipe Form Modal -->
        <div id="recipe-form-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-3xl max-h-[90vh] overflow-y-auto relative">
                <button id="close-recipe-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" aria-label="Fermer">
                    <i class="fas fa-times text-xl"></i>
                </button>
                <h3 id="recipe-modal-title" class="text-2xl font-bold mb-6">Ajouter/Modifier une recette</h3>
                <form id="recipe-form" class="space-y-4">
                    <input type="hidden" id="recipe-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label for="recipe-name" class="block text-sm font-medium text-gray-700">Nom de la recette</label>
                            <input type="text" id="recipe-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                        </div>
                        <div>
                            <label for="recipe-category" class="block text-sm font-medium text-gray-700">Cat√©gorie</label>
                            <select id="recipe-category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                                <option>ENTREE</option>
                                <option>PLAT</option>
                                <option>ACCOMPAGNEMENT</option>
                                <option>DESSERT</option>
                            </select>
                        </div>
                        <div>
                            <label for="recipe-servings" class="block text-sm font-medium text-gray-700">Nombre de personnes</label>
                            <input type="number" id="recipe-servings" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" min="1">
                        </div>
                        <div>
                            <label for="recipe-prep-time" class="block text-sm font-medium text-gray-700">Temps de pr√©paration (min)</label>
                            <input type="number" id="recipe-prep-time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" min="0">
                        </div>
                         <div>
                            <label for="recipe-difficulty" class="block text-sm font-medium text-gray-700">Difficult√©</label>
                            <select id="recipe-difficulty" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                <option>Tr√®s facile</option>
                                <option>Facile</option>
                                <option>Moyen</option>
                                <option>Difficile</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-lg font-medium text-gray-800 mb-2">Ingr√©dients</h4>
                        <div id="ingredients-list" class="space-y-2"></div>
                        <button type="button" id="add-ingredient-btn" class="btn btn-outline btn-sm mt-2">
                            <i class="fas fa-plus mr-2"></i> Ajouter un ingr√©dient
                        </button>
                    </div>
                    <div>
                        <label for="recipe-steps" class="block text-lg font-medium text-gray-800">Pr√©paration</label>
                        <textarea id="recipe-steps" rows="8" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                    </div>
                    <div class="flex justify-end space-x-4 pt-4">
                        <button type="button" id="cancel-recipe-btn" class="btn btn-ghost">Annuler</button>
                        <button type="submit" id="save-recipe-btn" class="btn btn-primary">Sauvegarder</button>
                    </div>
                </form>
            </div>
        </div>
        `,script:"./recipes.js"},ingredients:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Ingr√©dients</h2>
            <div class="flex space-x-2">
                <button id="manage-categories-btn" class="btn btn-outline">
                    <i class="fas fa-tags mr-2"></i> G√©rer les cat√©gories
                </button>
                <button id="add-ingredient-btn" class="btn btn-primary">
                    <i class="fas fa-plus mr-2"></i> Ajouter un ingr√©dient
                </button>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="mb-6">
            <input type="text" id="search-bar" placeholder="Rechercher un ingr√©dient..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-tomato focus:border-tomato">
        </div>

        <!-- Tabs Navigation -->
        <div id="category-tabs" class="mb-6 border-b border-gray-200 flex space-x-4 flex-nowrap overflow-x-auto pb-2">
            <!-- Tabs will be generated by ingredients.js here -->
        </div>

        <!-- Ingredient List Container -->
        <div id="ingredients-list-container">
            <p class="text-center text-gray-500 p-10">Chargement des ingr√©dients...</p>
        </div>

        <!-- Ingredient Form Modal -->
        <div id="ingredient-form-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-md relative">
                <button id="close-ingredient-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
                <h3 id="ingredient-modal-title" class="text-lg font-bold mb-4">Ajouter un Ingr√©dient</h3>
                <form id="ingredient-form" class="space-y-4">
                    <input type="hidden" id="ingredient-id">
                    <div>
                        <label for="ingredient-name" class="block text-sm font-medium text-gray-700">Nom</label>
                        <input type="text" id="ingredient-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                    </div>
                    <div>
                        <label for="ingredient-unit" class="block text-sm font-medium text-gray-700">Unit√© par d√©faut</label>
                        <select id="ingredient-unit" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select>
                    </div>
                    <div>
                        <label for="ingredient-category" class="block text-sm font-medium text-gray-700">Cat√©gorie</label>
                        <select id="ingredient-category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></select>
                    </div>
                    <div>
                        <label for="ingredient-image-url" class="block text-sm font-medium text-gray-700">URL de l'image</label>
                        <input type="text" id="ingredient-image-url" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="Laisser vide pour une image al√©atoire">
                    </div>
                    <div class="flex justify-end space-x-4 pt-2">
                        <button type="button" id="cancel-ingredient-btn" class="btn btn-ghost">Annuler</button>
                        <button type="submit" id="save-ingredient-btn" class="btn btn-primary">Sauvegarder</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Category Management Modal -->
        <div id="category-management-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-lg relative">
                <h3 class="text-lg font-bold mb-4">G√©rer les cat√©gories d'ingr√©dients</h3>
                <form id="add-category-form" class="flex items-center space-x-2 mb-4">
                    <input type="text" id="new-category-name" placeholder="Nom de la nouvelle cat√©gorie" class="flex-grow mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                    <button type="submit" class="btn btn-secondary">Ajouter</button>
                </form>
                <div id="category-list" class="max-h-64 overflow-y-auto border rounded-lg p-2"></div>
                <div class="flex justify-end space-x-4 mt-4">
                     <button type="button" id="close-category-modal" class="btn btn-ghost">Annuler</button>
                    <button type="button" id="done-category-modal-btn" class="btn btn-primary">Termin√©</button>
                </div>
            </div>
        </div>
        `,script:"./ingredients.js"},lists:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Listes de Courses</h2>
            <button id="add-list-btn" class="btn btn-primary">
                <i class="fas fa-plus mr-2"></i> Cr√©er une liste
            </button>
        </div>

        <!-- Search Bar -->
        <div class="mb-6">
            <input type="text" id="search-bar" placeholder="Rechercher une liste..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-tomato focus:border-tomato">
        </div>

        <!-- Lists Container -->
        <div id="lists-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

        <div class="mt-12">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6">Listes Partag√©es</h2>
            <div id="shared-lists-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Les listes partag√©es seront charg√©es ici par JS -->
            </div>
        </div>

        <!-- List Form Modal -->
        <div id="list-form-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-start justify-center z-[100] hidden pt-20">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-3xl min-h-[75vh] max-h-[90vh] overflow-y-auto relative">
                <button id="close-list-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10"><i class="fas fa-times text-xl"></i></button>
                <h3 id="list-modal-title" class="text-lg font-bold mb-4">Cr√©er une liste</h3>
                <form id="list-form" class="space-y-4 pb-20">
                    <input type="hidden" id="list-id">
                    <div>
                        <label for="list-name" class="block text-sm font-medium text-gray-700">Nom de la liste</label>
                        <input type="text" id="list-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                    </div>
                    <div>
                        <h4 class="text-md font-medium text-gray-800 mb-2">Ingr√©dients</h4>
                        <div id="ingredients-list" class="space-y-2"></div>
                        <button type="button" id="add-ingredient-btn" class="btn btn-outline btn-sm mt-2">
                            <i class="fas fa-plus mr-2"></i> Ajouter un ingr√©dient
                        </button>
                    </div>
                </form>
                <div class="absolute bottom-0 left-0 right-0 px-6 py-4 bg-white/95 backdrop-blur-sm border-t border-gray-200 flex justify-end space-x-4">
                    <button type="button" id="cancel-list-btn" class="btn btn-ghost">Annuler</button>
                    <button type="submit" form="list-form" id="save-list-btn" class="btn btn-primary">Sauvegarder la liste</button>
                </div>
            </div>
        </div>
        `,script:"./lists.js"},friends:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Amis</h2>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="md:col-span-2 space-y-8">
                <div>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Liste d'amis</h3>
                    <div id="friends-list-container" class="space-y-4">
                        <!-- La liste d'amis sera charg√©e ici -->
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Demandes envoy√©es en attente</h3>
                    <div id="pending-requests-container" class="space-y-4">
                        <!-- Les demandes envoy√©es en attente seront charg√©es ici -->
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Demandes rejet√©es</h3>
                    <div id="declined-requests-container" class="space-y-4">
                        <!-- Les demandes rejet√©es seront charg√©es ici -->
                    </div>
                </div>
            </div>
            <div>
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Rechercher un ami</h3>
                    <div class="mb-4">
                        <div class="flex items-center space-x-2">
                            <input type="text" id="search-friends-input" placeholder="Nom ou email..." class="flex-grow p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-tomato focus:border-tomato">
                            <button id="search-friends-btn" class="btn btn-primary"><i class="fas fa-search"></i></button>
                        </div>
                        <div id="search-results-container" class="mt-2 space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>
        `,script:"./friends.js"},shared:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Partages</h2>
        </div>

        <div class="space-y-12">
            <div>
                <h3 class="text-xl font-bold text-gray-700 border-b pb-2 mb-4">Partages Re√ßus</h3>
                <div id="received-shares-container" class="space-y-4">
                    <!-- L'historique des partages accept√©s sera charg√© ici -->
                </div>
            </div>
            <div>
                <h3 class="text-xl font-bold text-gray-700 border-b pb-2 mb-4">Mes Partages Envoy√©s</h3>
                <div id="sent-shares-container" class="space-y-4">
                    <!-- L'historique des partages envoy√©s sera charg√© ici -->
                </div>
            </div>
        </div>
        `,script:"./shared.js"},plans:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Plans Sauvegard√©s</h2>
        </div>
        <div id="all-plans-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- La liste des plans sera charg√©e ici -->
            <p class="text-center text-gray-500 p-10 col-span-full">Chargement de vos plans...</p>
        </div>
        `,script:"./all-plans.js"},"view-plan":{html:`
        <section aria-labelledby="meal-planning-heading" class="mb-8 md:mb-12">
            <div class="flex justify-between items-center mb-4">
                <h2 id="plan-view-name" class="text-xl md:text-2xl font-bold text-gray-800">Chargement du plan...</h2>
                <button id="close-view-plan-btn" class="btn btn-outline">
                    <i class="fas fa-times mr-2"></i> Fermer et voir mes plans
                </button>
            </div>
            <div class="bg-white rounded-xl shadow-md p-4">
                <div id="meal-plan-grid-layout">
                    <!-- Header -->
                    <div class="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] gap-1 text-center mb-1">
                        <div class="p-2"></div> <!-- Empty corner -->
                        <div class="p-2 rounded-t-lg bg-amber-100 text-amber-800 font-bold col-span-6">MIDI</div>
                        <div class="p-2 rounded-t-lg bg-stone-200 text-stone-800 font-bold col-span-6">SOIR</div>
                        <div class="p-1"></div> <!-- Empty under day name -->
                        <div class="p-1 text-xs font-semibold"><i class="fas fa-users"></i></div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Entr√©e</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Plat</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Accomp.</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Dessert</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Remarque</div>
                        <div class="p-1 text-xs font-semibold"><i class="fas fa-users"></i></div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Entr√©e</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Plat</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Accomp.</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Dessert</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Remarque</div>
                    </div>
                    <!-- Rows generated by JS -->
                    <div id="meal-plan-grid" class="space-y-1">
                        <div class="p-10 text-center text-gray-500 italic col-span-full">Chargement de la planification...</div>
                    </div>
                </div>
            </div>
        </section>
        `,script:"./view-plan.js"}},_a=Object.assign({"./all-plans.js":zn,"./auth.js":qn,"./firebase-config.js":jn,"./form-handler.js":Vn,"./friends.js":Yn,"./ingredients.js":Zn,"./lists.js":aa,"./main.js":An,"./notifications.js":va,"./plans.js":da,"./presence.js":ba,"./recipes.js":xa,"./script.js":wa,"./shared.js":Sa,"./sharing.js":ta,"./view-plan.js":Da});let ft=null;async function rt(e){typeof ft=="function"&&(ft(),ft=null);const t=Pa[e];if(t&&Yt){if(Yt.innerHTML=t.html,t.script){const n=_a[t.script];n?n.default&&typeof n.default=="function"&&(ft=n.default()):console.error(`Module not found for path: ${t.script}`)}}else console.error(`Route not found: ${e}`)}function $a(){const e=He();if(e){const n=document.getElementById("user-display-name");n&&(n.textContent=e.displayName||e.email)}const t=document.querySelectorAll(".nav-btn");t.forEach(n=>{n.addEventListener("click",a=>{const i=a.currentTarget.dataset.path;rt(i),t.forEach(o=>{o.classList.remove("bg-tomato","text-white"),o.classList.add("bg-white","text-tomato")}),a.currentTarget.classList.add("bg-tomato","text-white"),a.currentTarget.classList.remove("bg-white","text-tomato")})}),rt("menu"),yn()}document.addEventListener("DOMContentLoaded",()=>{en().then(b=>{b&&$a()});const e=document.getElementById("profile-btn"),t=document.getElementById("profile-menu");e&&t&&(e.addEventListener("click",b=>{b.stopPropagation(),t.classList.toggle("hidden");const T=!t.classList.contains("hidden");e.setAttribute("aria-expanded",T)}),document.addEventListener("click",b=>{!(t.contains(b.target)||e.contains(b.target))&&!t.classList.contains("hidden")&&(t.classList.add("hidden"),e.setAttribute("aria-expanded","false"))}));const n=document.getElementById("settings-link"),a=document.getElementById("settings-modal"),i=document.getElementById("close-settings-modal"),o=document.getElementById("dark-mode-toggle"),c=b=>{b==="dark"?(document.documentElement.classList.add("dark"),o&&(o.checked=!0)):(document.documentElement.classList.remove("dark"),o&&(o.checked=!1))},p=localStorage.getItem("theme");p?c(p):window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?c("dark"):c("light"),n&&a&&n.addEventListener("click",b=>{b.preventDefault(),a.classList.remove("hidden")}),i&&a&&i.addEventListener("click",()=>{a.classList.add("hidden")}),a&&a.addEventListener("click",b=>{b.target===a&&a.classList.add("hidden")}),o&&o.addEventListener("change",()=>{const b=o.checked?"dark":"light";localStorage.setItem("theme",b),c(b)});const x=document.getElementById("mobile-menu-btn"),E=document.getElementById("mobile-menu"),w=document.querySelectorAll(".nav-btn-mobile");x&&E&&x.addEventListener("click",()=>{E.classList.toggle("hidden")});const C=document.getElementById("profile-btn-mobile");C&&a&&C.addEventListener("click",()=>{a.classList.remove("hidden"),E&&E.classList.add("hidden")}),w.forEach(b=>{b.addEventListener("click",T=>{const z=T.currentTarget.dataset.path;rt(z),E&&E.classList.add("hidden")})})});
