import{o as In,s as Bn,a as Ft,q as ce,w as K,c as F,d as h,b as qe,e as $,g as xe,f as fe,u as ke,h as je,i as Se,j as dt,k as Wt,l as gt,m as Ut,n as Sn,p as kn,r as Et,t as Ot,v as Mn,x as Nn,y as Tn,z as Dn,A as Pn,B as Gt,C as _n,D as $n,_ as jn}from"./firebase-config-DRNfbNj5.js";const Hn=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"}));let ht=null;function Xt(){return new Promise(e=>{In(Ft,t=>{if(ht=t,t){console.log("User is logged in:",t.uid);const n=document.getElementById("logout-btn"),a=document.getElementById("profile-btn");n&&n.classList.remove("hidden"),a&&a.classList.remove("hidden"),n&&!n.hasAttribute("data-listener-attached")&&(n.addEventListener("click",()=>{Bn(Ft).catch(o=>{console.error("Sign Out Error",o)})}),n.setAttribute("data-listener-attached","true")),e(t)}else{console.log("User not logged in. Redirecting to login.html");const n=window.location.origin+"/login.html";window.location.href!==n&&(window.location.href=n),e(null)}})})}function ve(){return ht?ht.uid:null}function Te(){return ht}const An=Object.freeze(Object.defineProperty({__proto__:null,getCurrentUser:Te,getCurrentUserId:ve,protectPage:Xt},Symbol.toStringTag,{value:"Module"}));async function Rn(e){if(confirm("Voulez-vous charger cette sauvegarde ? Attention, cela écrasera la planification de la semaine correspondante dans votre plan de travail actuel."))try{const t=ve();if(!t)throw new Error("Utilisateur non trouvé");const n=$(h,"plan_saves",e),a=await xe(n);if(!a.exists())throw new Error("Sauvegarde non trouvée.");const o=a.data(),l=o.weekData.weekNumber,c=ce(F(h,"plans"),K("userId","==",t)),p=await fe(c);if(p.empty)throw new Error("Aucun plan de travail trouvé pour y charger la sauvegarde.");const v=p.docs[0],x=$(h,"plans",v.id);await ke(x,{[`weeks.${l}`]:o.weekData}),localStorage.setItem("selectedPlanId",v.id),et("menu")}catch(t){console.error("Erreur lors du chargement de la sauvegarde:",t),alert(t.message)}}async function qn(e){if(confirm("Êtes-vous sûr de vouloir supprimer cette sauvegarde ? Cette action est définitive."))try{await je($(h,"plan_saves",e))}catch(t){console.error("Erreur lors de la suppression de la sauvegarde:",t),alert("La suppression a échoué.")}}function Fn(){const e=document.getElementById("all-plans-list"),t=ve();if(!t||!e)return e.innerHTML="<p>Erreur de chargement.</p>",()=>{};const n=ce(F(h,"plan_saves"),K("userId","==",t)),a=qe(n,o=>{if(e.innerHTML="",o.empty){e.innerHTML=`<p class="text-center text-gray-500 p-10 col-span-full">Vous n'avez aucune sauvegarde.</p>`;return}const l=o.docs.map(c=>({id:c.id,...c.data()}));l.sort((c,p)=>p.savedAt.toMillis()-c.savedAt.toMillis()),l.forEach(c=>{const p=document.createElement("div");p.className="bg-white rounded-xl shadow-md p-4 flex flex-col justify-between";const v=c.savedAt?.toDate().toLocaleString("fr-FR")||"Date inconnue",x=c.planData;let w="Plan vide ou sans données.";if(x&&x.weeks){const J=Object.keys(x.weeks).length;J>0&&(w=`Contient ${J} semaine(s).`)}const I=document.createElement("div");I.innerHTML=`
                <h3 class="text-lg font-bold text-gray-800 mb-2">${c.name}</h3>
                <p class="text-sm text-gray-500">Sauvegardé le : ${v}</p>
                <p class="text-sm text-gray-600 mt-2">${w}</p>
            `;const L=document.createElement("div");L.className="mt-4 pt-4 border-t border-gray-200 flex items-center justify-end space-x-2";const C=document.createElement("button");C.className="btn btn-secondary btn-sm",C.textContent="Voir",C.addEventListener("click",()=>{localStorage.setItem("selectedPlanId",c.id),et("view-plan")});const m=document.createElement("button");m.className="btn btn-primary btn-sm",m.textContent="Charger",m.addEventListener("click",()=>Rn(c.id)),m.style.display="none";const D=document.createElement("button");D.className="btn btn-ghost text-red-500 hover:bg-red-100 btn-sm",D.innerHTML='<i class="fas fa-trash"></i>',D.title="Supprimer la sauvegarde",D.addEventListener("click",()=>qn(c.id)),L.appendChild(D),L.appendChild(C),L.appendChild(m),p.appendChild(I),p.appendChild(L),e.appendChild(p)})});return()=>{a()}}const Un=Object.freeze(Object.defineProperty({__proto__:null,default:Fn},Symbol.toStringTag,{value:"Module"}));class $t{constructor(t,n,a,o,l,c,p,v,x,w,I,L,C,m,D,J){this.db=t,this.modal=document.getElementById(n),this.form=document.getElementById(a),this.modalTitle=document.getElementById(o),this.recipeIdInput=document.getElementById(l),this.recipeNameInput=document.getElementById(c),this.recipeCategoryInput=document.getElementById(p),this.recipeServingsInput=document.getElementById(v),this.recipePrepTimeInput=document.getElementById(x),this.recipeDifficultyInput=document.getElementById(w),this.recipeStepsTextarea=document.getElementById(I),this.ingredientsListDiv=document.getElementById(L),this.addIngredientBtn=document.getElementById(C),this.saveRecipeBtn=document.getElementById(m),this.closeButton=document.getElementById(D),this.cancelButton=document.getElementById(J),this.masterIngredientList=[],this.activityUpdater=null,this.boundAddIngredient=()=>this.addIngredientInput(void 0,this.form.ingredients),this.boundCloseForm=()=>this.closeForm(),this.boundHandleSubmit=Y=>this.handleSubmit(Y),this.addIngredientBtn.addEventListener("click",this.boundAddIngredient),this.closeButton.addEventListener("click",this.boundCloseForm),this.cancelButton.addEventListener("click",this.boundCloseForm),this.saveRecipeBtn.addEventListener("click",this.boundHandleSubmit)}setActivityUpdater(t){this.activityUpdater=t}destroy(){this.addIngredientBtn.removeEventListener("click",this.boundAddIngredient),this.closeButton.removeEventListener("click",this.boundCloseForm),this.cancelButton.removeEventListener("click",this.boundCloseForm),this.saveRecipeBtn.removeEventListener("click",this.boundHandleSubmit)}async openForm(t=null,n="Ajouter une recette"){this.activityUpdater&&this.activityUpdater("editing_recipe"),await this.fetchMasterIngredients(),console.log("openForm called with recipe:",t,"and title:",n),this.form.reset(),this.ingredientsListDiv.innerHTML="",this.modalTitle.textContent=n;const a=[];if(this.form.ingredients=a,t){this.recipeIdInput.value=t.id||"",this.recipeNameInput.value=t.name||"";const o=t.category||"Plat";for(const l of this.recipeCategoryInput.options)if(l.value.toLowerCase()===o.toLowerCase()){l.selected=!0;break}this.recipeServingsInput.value=parseInt(t.servings)||"",this.recipePrepTimeInput.value=parseInt(t.prepTime)||"",this.recipeDifficultyInput.value=t.difficulty||"Moyen",this.recipeStepsTextarea.value=t.steps||"",t.ingredients&&t.ingredients.length>0?t.ingredients.forEach(l=>this.addIngredientInput({...l},a)):this.addIngredientInput(void 0,a)}else this.recipeIdInput.value="",this.addIngredientInput(void 0,a);this.modal.classList.remove("hidden")}closeForm(){this.activityUpdater&&this.activityUpdater("idle"),this.modal.classList.add("hidden")}async fetchMasterIngredients(){if(this.masterIngredientList=[],!!this.db)try{const t=await fe(F(this.db,"ingredients"));this.masterIngredientList=t.docs.map(n=>({id:n.id,...n.data()})),this.masterIngredientList.sort((n,a)=>n.name.localeCompare(a.name))}catch(t){console.error("Erreur lors de la récupération de la liste des ingrédients: ",t),alert("Impossible de charger la liste des ingrédients de base. La recherche ne fonctionnera pas.")}}addIngredientInput(t={quantity:"",name:"",unit:""},n){const a=document.createElement("div");a.className="relative flex items-stretch space-x-2 ingredient-row";const o={...t};n.push(o);const l=n.length-1,c=document.createElement("input");c.type="text",c.className="ingredient-quantity mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm",c.placeholder="Qté",c.value=o.quantity,c.addEventListener("change",L=>{n[l].quantity=L.target.value});const p=document.createElement("input");p.type="text",p.className="ingredient-unit mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm bg-gray-100",p.placeholder="Unité",p.readOnly=!0,p.value=o.unit||"";const v=document.createElement("div");v.className="relative w-1/2";const x=document.createElement("input");x.type="text",x.className="ingredient-name mt-1 block w-full rounded-md border-gray-300 shadow-sm",x.placeholder="Chercher un ingrédient...",x.value=o.name,v.appendChild(x);const w=document.createElement("div");w.className="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto",v.appendChild(w),x.addEventListener("input",()=>{const L=x.value.toLowerCase();if(!L){w.classList.add("hidden");return}const C=this.masterIngredientList.filter(D=>D.name.toLowerCase().includes(L));w.innerHTML="",C.forEach(D=>{const J=document.createElement("div");J.className="p-2 ingredient-search-item cursor-pointer",J.textContent=D.name,J.addEventListener("click",()=>{x.value=D.name,p.value=D.unit,w.classList.add("hidden"),n[l].name=D.name,n[l].unit=D.unit,n[l].id=D.id}),w.appendChild(J)});const m=document.createElement("div");m.className="p-2 bg-blue-50 hover:bg-blue-200 cursor-pointer font-bold text-blue-700",m.textContent=`+ Créer "${x.value}"`,m.addEventListener("click",async()=>{const D=x.value,J="pièce(s)";try{const Y=await Se(F(this.db,"ingredients"),{name:D,unit:J});await this.fetchMasterIngredients(),x.value=D,p.value=J,w.classList.add("hidden"),n[l].name=D,n[l].unit=J,n[l].id=Y.id}catch(Y){console.error("Erreur d'ajout d'ingrédient",Y),alert("L'ingrédient n'a pas pu être créé.")}}),w.appendChild(m),w.classList.remove("hidden")});const I=document.createElement("button");I.type="button",I.className="btn btn-ghost text-red-500 hover:bg-red-50 btn-sm mt-1",I.innerHTML='<i class="fas fa-trash"></i>',I.addEventListener("click",()=>{a.remove(),n[l]=null}),a.appendChild(v),a.appendChild(c),a.appendChild(p),a.appendChild(I),this.ingredientsListDiv.appendChild(a)}async handleSubmit(t){t.preventDefault(),this.saveRecipeBtn.disabled=!0,this.saveRecipeBtn.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i> Sauvegarde...',console.log("Ingredients array from form before filter:",this.form.ingredients);const n=this.form.ingredients.filter(l=>l!==null&&l.quantity&&l.name);console.log("Ingredients array after filter:",n);const a={name:this.recipeNameInput.value,category:this.recipeCategoryInput.value,servings:parseInt(this.recipeServingsInput.value)||0,prepTime:parseInt(this.recipePrepTimeInput.value)||0,difficulty:this.recipeDifficultyInput.value,steps:this.recipeStepsTextarea.value,ingredients:n,imageUrl:""};console.log("Recipe data being sent to Firebase:",a);const o=this.recipeIdInput.value;try{o?await dt($(this.db,"recipes",o),a):await Se(F(this.db,"recipes"),a),this.closeForm(),console.log("Recipe saved successfully!"),this.onSaveCallback&&this.onSaveCallback()}catch(l){console.error("Erreur de sauvegarde: ",l),alert("Une erreur est survenue lors de la sauvegarde.")}finally{this.saveRecipeBtn.disabled=!1,this.saveRecipeBtn.textContent="Sauvegarder"}}setOnSaveCallback(t){this.onSaveCallback=t}}const On=Object.freeze(Object.defineProperty({__proto__:null,RecipeFormHandler:$t},Symbol.toStringTag,{value:"Module"}));let Mt=()=>{};function zn(){const e=document.getElementById("search-friends-input");return document.getElementById("search-friends-btn").addEventListener("click",()=>zt(e.value)),e.addEventListener("keyup",n=>{n.key==="Enter"&&zt(e.value)}),Vn(),Yt(),()=>{Mt&&Mt()}}async function Vn(){const e=document.getElementById("friends-list-container"),t=Te()?.uid;if(!t||!e)return;e.innerHTML='<p class="text-gray-500">Chargement...</p>';const n=$(h,"users",t);Mt=qe(n,async a=>{if(!a.exists()){e.innerHTML='<p class="text-red-500">Erreur: Utilisateur non trouvé.</p>';return}const o=a.data().friends||[];if(e.innerHTML="",o.length===0){e.innerHTML=`<p class="text-gray-500">Vous n'avez pas encore d'amis. Utilisez la recherche pour en ajouter.</p>`;return}for(const l of o)try{const c=await xe($(h,"users",l));c.exists()&&e.appendChild(Qn(c.data()))}catch(c){console.error("Erreur de chargement d'un ami",c)}})}function Qn(e){const t=document.createElement("div");t.className="bg-white p-3 rounded-lg flex items-center justify-between shadow-sm";const n=document.createElement("div");n.className="flex items-center",n.innerHTML=`
        <img src="${e.photoURL||"https://placehold.co/40"}" alt="Avatar" class="w-10 h-10 rounded-full mr-3">
        <div>
            <p class="font-bold">${e.displayName}</p>
            <p class="text-sm text-gray-500">${e.email}</p>
        </div>
    `;const a=document.createElement("button");return a.className="btn btn-ghost text-red-500 btn-sm",a.innerHTML='<i class="fas fa-user-times"></i>',a.title="Retirer cet ami",a.addEventListener("click",()=>Jn(e.uid)),t.appendChild(n),t.appendChild(a),t}async function Jn(e){const t=Te()?.uid;if(!t||!e){console.error("Impossible de supprimer l'ami : ID utilisateur ou ID ami manquant.");return}if(!confirm("Voulez-vous vraiment retirer cet ami ? Cette action est unilatérale."))return;console.log(`Tentative de suppression de l'ami ${e} pour l'utilisateur ${t}`);const n=$(h,"users",t);try{await ke(n,{friends:Wt(e)}),console.log("Ami supprimé avec succès de la base de données.")}catch(a){console.error("Erreur lors de la suppression de l'ami: ",a),alert("Une erreur est survenue.")}}async function zt(e){const t=document.getElementById("search-results-container"),n=Te()?.uid;if(!(!e||!t)){t.innerHTML='<p class="text-gray-500">Recherche en cours...</p>';try{const a=e.toLowerCase(),o=a+"",l=ce(F(h,"users"),K("displayName_lowercase",">=",a),K("displayName_lowercase","<",o)),c=ce(F(h,"users"),K("email","==",a)),[p,v]=await Promise.all([fe(l),fe(c)]),x=new Map;if(p.forEach(w=>x.set(w.id,w.data())),v.forEach(w=>x.set(w.id,w.data())),t.innerHTML="",x.size===0){t.innerHTML='<p class="text-gray-500">Aucun utilisateur trouvé.</p>';return}x.forEach(w=>{if(w.uid===n)return;const I=document.createElement("div");I.className="bg-gray-50 p-2 rounded-lg flex items-center justify-between",I.innerHTML=`
                <div class="flex items-center">
                    <img src="${w.photoURL||"https://placehold.co/32"}" class="w-8 h-8 rounded-full mr-2">
                    <span class="font-medium text-sm">${w.displayName} (${w.email})</span>
                </div>
            `;const L=document.createElement("button");L.className="btn btn-secondary btn-xs",L.innerHTML='<i class="fas fa-user-plus"></i>',L.addEventListener("click",()=>Wn(w.uid)),I.appendChild(L),t.appendChild(I)})}catch(a){console.error("Erreur de recherche: ",a),t.innerHTML='<p class="text-red-500">Erreur de recherche.</p>'}}}async function Wn(e){const t=Te()?.uid;if(!t||t===e)return;const n=ce(F(h,"friend_requests"),K("senderId","==",t),K("receiverId","==",e)),a=ce(F(h,"friend_requests"),K("senderId","==",e),K("receiverId","==",t)),[o,l]=await Promise.all([fe(n),fe(a)]);if(!o.empty||!l.empty)return alert("Une demande d'ami existe déjà avec cet utilisateur.");if((await xe($(h,"users",t))).data()?.friends?.includes(e))return alert("Vous êtes déjà ami avec cet utilisateur.");try{await Se(F(h,"friend_requests"),{senderId:t,receiverId:e,status:"pending",createdAt:gt()}),alert("Demande d'ami envoyée !")}catch(p){console.error("Erreur lors de l'envoi de la demande d'ami: ",p),alert("Une erreur est survenue.")}}async function Yt(){const e=document.getElementById("pending-requests-container"),t=document.getElementById("declined-requests-container"),n=Te()?.uid;if(!(!n||!e||!t)){e.innerHTML='<p class="text-gray-500">Chargement...</p>',t.innerHTML='<p class="text-gray-500">Chargement...</p>';try{const a=ce(F(h,"friend_requests"),K("senderId","==",n)),o=await fe(a),l=[],c=[];for(const p of o.docs){const v={id:p.id,...p.data()},x=await xe($(h,"users",v.receiverId));x.exists()&&(v.receiver=x.data()),v.status==="pending"?l.push(v):v.status==="declined"&&c.push(v)}e.innerHTML="",l.length>0?l.forEach(p=>e.appendChild(Vt(p))):e.innerHTML='<p class="text-gray-500">Aucune demande en attente.</p>',t.innerHTML="",c.length>0?c.forEach(p=>t.appendChild(Vt(p))):t.innerHTML='<p class="text-gray-500">Aucune demande rejetée.</p>'}catch(a){console.error("Erreur lors du chargement des demandes envoyées: ",a),e.innerHTML='<p class="text-red-500">Erreur de chargement.</p>',t.innerHTML='<p class="text-red-500">Erreur de chargement.</p>'}}}function Vt(e){const t=document.createElement("div");t.className="bg-white p-3 rounded-lg flex items-center justify-between shadow-sm";const n=e.receiver,a=document.createElement("div");a.className="flex items-center",a.innerHTML=`
        <img src="${n?.photoURL||"https://placehold.co/40"}" alt="Avatar" class="w-10 h-10 rounded-full mr-3">
        <div>
            <p class="font-bold">${n?.displayName||"Utilisateur inconnu"}</p>
            <p class="text-sm text-gray-500">Statut : <span class="font-medium">${e.status}</span></p>
        </div>
    `;const o=document.createElement("button");return o.className="btn btn-ghost text-red-500 btn-sm",o.innerHTML='<i class="fas fa-times-circle"></i>',o.title="Annuler la demande",o.addEventListener("click",async()=>{confirm("Voulez-vous vraiment annuler cette demande ?")&&(await je($(h,"friend_requests",e.id)),Yt())}),t.appendChild(a),t.appendChild(o),t}async function Kt(e){try{const t=$(h,"friend_requests",e);await ke(t,{status:"accepted"})}catch(t){throw console.error("Erreur lors de l'acceptation de la demande d'ami: ",t),t}}async function Zt(e){try{const t=$(h,"friend_requests",e);await ke(t,{status:"declined"})}catch(t){throw console.error("Erreur lors du refus de la demande d'ami: ",t),t}}const Gn=Object.freeze(Object.defineProperty({__proto__:null,acceptFriendRequest:Kt,declineFriendRequest:Zt,default:zn},Symbol.toStringTag,{value:"Module"}));function Xn(){const e=document.getElementById("ingredients-list-container"),t=document.getElementById("add-ingredient-btn"),n=document.getElementById("category-tabs"),a=document.getElementById("search-bar"),o=document.getElementById("ingredient-form-modal"),l=document.getElementById("ingredient-modal-title"),c=document.getElementById("close-ingredient-modal"),p=document.getElementById("cancel-ingredient-btn"),v=document.getElementById("ingredient-form"),x=document.getElementById("ingredient-id"),w=document.getElementById("ingredient-name"),I=document.getElementById("ingredient-unit"),L=document.getElementById("ingredient-category"),C=document.getElementById("manage-categories-btn"),m=document.getElementById("category-management-modal"),D=document.getElementById("close-category-modal"),J=document.getElementById("done-category-modal-btn"),Y=document.getElementById("add-category-form"),Ce=document.getElementById("new-category-name"),O=document.getElementById("category-list");let j=[],P=[],V="",W="",Ee=null;const be=["g","kg","ml","l","pièce(s)","c.à.s.","c.à.c.","pincée(s)"];async function ue(){await Me(),await ye()}async function Me(){if(h)try{P=(await fe(F(h,"ingredient_categories"))).docs.map(_=>({id:_.id,..._.data()})),P.sort((_,N)=>_.name.localeCompare(N.name))}catch(A){console.error("Erreur lors de la récupération des catégories: ",A)}}async function ye(){if(h)try{j=(await fe(F(h,"ingredients"))).docs.map(_=>({id:_.id,..._.data()})),X(),me()}catch(A){console.error("Erreur de chargement des ingrédients: ",A)}}function _e(A=null){v.reset(),I.innerHTML="",be.forEach(R=>{const te=document.createElement("option");te.value=R,te.textContent=R,I.appendChild(te)});const _=P.map(R=>R.name),N=[...new Set(j.map(R=>R.category).filter(Boolean))],B=[...new Set([..._,...N])];B.sort((R,te)=>R.localeCompare(te.name)),L.innerHTML="",B.forEach(R=>{const te=document.createElement("option");te.value=R,te.textContent=R,L.appendChild(te)}),A?(l.textContent="Modifier l'ingrédient",x.value=A.id,w.value=A.name,I.value=A.unit||"",L.value=A.category||(B.length>0?B[0]:"")):(l.textContent="Ajouter un ingrédient",x.value="",I.value=be[0],L.value=V||(B.length>0?B[0]:"")),o.classList.remove("hidden")}function ze(){o.classList.add("hidden")}async function U(A){A.preventDefault();const _=x.value,N={name:w.value,unit:I.value,category:L.value};if(!N.name||!N.category){alert("Le nom et la catégorie sont requis.");return}try{_?await dt($(h,"ingredients",_),N):await Se(F(h,"ingredients"),N),ze(),await ye()}catch(B){console.error("Erreur de sauvegarde de l'ingrédient: ",B)}}function k(){q(),m.classList.remove("hidden")}function Q(){m.classList.add("hidden")}function q(){if(O.innerHTML="",P.length===0){O.innerHTML='<p class="text-gray-500">Aucune catégorie définie.</p>';return}P.forEach(A=>{const _=document.createElement("div");_.className="flex items-center justify-between p-2 border-b";const N=document.createElement("span");N.textContent=A.name,_.appendChild(N);const B=document.createElement("div");B.className="flex space-x-2";const R=document.createElement("button");R.className="btn btn-ghost btn-xs text-blue-500",R.innerHTML='<i class="fas fa-edit"></i>',R.addEventListener("click",()=>G(A)),B.appendChild(R);const te=document.createElement("button");te.className="btn btn-ghost btn-xs text-red-500",te.innerHTML='<i class="fas fa-trash"></i>',te.addEventListener("click",()=>ie(A)),B.appendChild(te),_.appendChild(B),O.appendChild(_)})}async function se(A){A.preventDefault();const _=Ce.value.trim();if(_&&!P.find(N=>N.name.toLowerCase()===_.toLowerCase()))try{await Se(F(h,"ingredient_categories"),{name:_}),Ce.value="",await Me(),q(),X()}catch(N){console.error("Erreur d'ajout de catégorie: ",N)}else alert("Cette catégorie existe déjà ou le nom est invalide.")}async function G(A){const _=A.name,N=prompt(`Entrez le nouveau nom pour la catégorie "${_}":`,_);if(N&&N.trim()!==""&&N!==_)try{await dt($(h,"ingredient_categories",A.id),{name:N});const B=ce(F(h,"ingredients"),K("category","==",_)),R=await fe(B),te=Ut(h);R.forEach(Re=>{te.update(Re.ref,{category:N})}),await te.commit(),await ue(),q()}catch(B){console.error("Erreur de renommage: ",B)}}async function ie(A){if(confirm(`Êtes-vous sûr de vouloir supprimer la catégorie "${A.name}"?

Tous les ingrédients associés seront déplacés vers la catégorie "Inconnue".`))try{await je($(h,"ingredient_categories",A.id));const _=ce(F(h,"ingredients"),K("category","==",A.name)),N=await fe(_),B=Ut(h);N.forEach(R=>{B.update(R.ref,{category:"Inconnue"})}),await B.commit(),V="",await ue(),q()}catch(_){console.error("Erreur de suppression: ",_)}}function X(){n.innerHTML="";const A=P.map(B=>B.name),_=[...new Set(j.map(B=>B.category||"Inconnue"))];let N=[...new Set([...A,..._])];N.sort((B,R)=>B.localeCompare(R)),N.includes("Inconnue")&&(N=N.filter(B=>B!=="Inconnue"),N.push("Inconnue")),N.length===0&&j.length>0&&N.push("Inconnue"),!V&&N.length>0&&(V=N[0]),N.forEach(B=>{const R=document.createElement("button"),te=B===V;R.className=`px-4 py-2 text-sm font-medium rounded-t-lg ${te?"bg-tomato text-white":"text-gray-500 hover:text-tomato"}`,R.textContent=B,R.addEventListener("click",()=>ee(B)),n.appendChild(R)})}function ee(A){V=A,X(),me()}function me(){e.innerHTML="";const A=V||(P.length>0?P[0].name:"Inconnue");let _=j.filter(B=>(B.category||"Inconnue")===A);if(W){const B=W.toLowerCase();_=_.filter(R=>R.name.toLowerCase().includes(B))}if(_.length===0){e.innerHTML='<p class="text-center text-gray-500 p-10">Aucun ingrédient dans cette catégorie.</p>';return}_.sort((B,R)=>B.name.localeCompare(R.name,"fr",{sensitivity:"base"}));const N=document.createElement("div");N.className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4",_.forEach(B=>{const R=document.createElement("div");R.className="p-3 bg-white shadow-sm rounded-lg flex flex-col items-start space-y-2";const te=document.createElement("div");te.className="flex-grow w-full flex justify-between items-center";const Re=document.createElement("span");Re.className="font-medium text-gray-800",Re.textContent=B.name;const We=document.createElement("span");We.className="text-gray-500 text-sm bg-gray-100 px-2 py-1 rounded-full",We.textContent=B.unit,te.appendChild(Re),te.appendChild(We);const Ve=document.createElement("div");Ve.className="w-full flex justify-end items-center space-x-2 border-t pt-2 mt-2";const Ge=document.createElement("button");Ge.className="btn btn-ghost btn-xs text-blue-500 hover:bg-blue-50",Ge.innerHTML='<i class="fas fa-edit"></i>',Ge.addEventListener("click",()=>_e(B));const Xe=document.createElement("button");Xe.className="btn btn-ghost btn-xs text-red-500 hover:bg-red-50",Xe.innerHTML='<i class="fas fa-trash-alt"></i>',Xe.addEventListener("click",()=>Ie(B.id,B.name)),Ve.appendChild(Ge),Ve.appendChild(Xe),R.appendChild(te),R.appendChild(Ve),N.appendChild(R)}),e.appendChild(N)}async function Ie(A,_){if(confirm(`Êtes-vous sûr de vouloir supprimer l'ingrédient "${_}" ?`))try{await je($(h,"ingredients",A)),await ye()}catch(N){console.error("Erreur de suppression de l'ingrédient: ",N)}}a.addEventListener("input",A=>{const _=A.target.value.toLowerCase();if(!W&&_&&(Ee=V),W=_,W){const N=j.find(B=>B.name.toLowerCase().includes(W));N&&(V=N.category||"Inconnue")}else Ee&&(V=Ee,Ee=null);X(),me()}),t.addEventListener("click",()=>_e()),c.addEventListener("click",ze),p.addEventListener("click",ze),v.addEventListener("submit",U),C.addEventListener("click",k),D.addEventListener("click",Q),J.addEventListener("click",Q),Y.addEventListener("submit",se),ue()}const Yn=Object.freeze(Object.defineProperty({__proto__:null,default:Xn},Symbol.toStringTag,{value:"Module"})),z={modal:document.getElementById("share-modal"),closeBtn:document.getElementById("close-share-modal"),title:document.getElementById("share-modal-title"),friendsList:document.getElementById("share-friends-list"),sharePlanCheckbox:document.getElementById("share-planning-checkbox"),shareShoppingListCheckbox:document.getElementById("share-shopping-list-checkbox"),confirmBtn:document.getElementById("confirm-share-btn")};let Ae={};function yt(){z.modal.classList.add("hidden");const e=document.getElementById("share-mode-selection");e&&e.classList.remove("hidden"),z.confirmBtn.textContent="Envoyer le partage";const t=z.confirmBtn.cloneNode(!0);z.confirmBtn.parentNode&&(z.confirmBtn.parentNode.replaceChild(t,z.confirmBtn),z.confirmBtn=t,t.addEventListener("click",en))}async function en(){const e=ve();if(!e||!Ae.plan)return;const t=Array.from(z.friendsList.querySelectorAll('input[type="checkbox"]:checked')).map(a=>a.value),n=document.querySelector('input[name="share-mode"]:checked')?.value;if(t.length===0){alert("Veuillez sélectionner au moins un ami.");return}if(!n){alert("Veuillez sélectionner un mode de partage.");return}z.confirmBtn.disabled=!0,z.confirmBtn.textContent="Envoi en cours...";try{const a=F(h,"shares");let o={};n==="collaborate"?o={senderId:e,createdAt:new Date,type:"collaborative_plan_invite",planId:Ae.plan.id,planName:Ae.plan.name}:o={senderId:e,createdAt:new Date,type:"share",plan:{name:Ae.plan.name,weeks:Ae.plan.weeks||{},manualItems:Ae.plan.manualItems||[],defaultNumPeople:Ae.plan.defaultNumPeople||1,startDay:Ae.plan.startDay||"Lundi"}};for(const l of t)await Se(a,{...o,receiverId:l,status:"pending"});yt(),alert("Partage envoyé avec succès !")}catch(a){console.error("Erreur lors de l'envoi du partage : ",a),alert("Une erreur est survenue lors de l'envoi du partage.")}finally{z.confirmBtn.disabled=!1,z.confirmBtn.textContent="Envoyer le partage"}}async function jt(e={}){const{plan:t}=e;if(!t){alert("Aucun plan sélectionné à partager.");return}Ae={plan:t},z.title.textContent=`Partager le plan "${t.name}"`,z.friendsList.innerHTML='<p class="text-gray-500">Chargement des amis...</p>',z.modal.classList.remove("hidden");const n=ve();if(n)try{const a=await xe($(h,"users",n));if(a.exists()){const l=a.data().friends||[];if(l.length===0){z.friendsList.innerHTML=`<p class="text-gray-500">Vous n'avez pas d'amis à qui partager.</p>`;return}z.friendsList.innerHTML="";for(const c of l){const p=await xe($(h,"users",c));if(p.exists()){const v=p.data(),x=document.createElement("label");x.className="flex items-center p-2 hover:bg-gray-100 rounded-lg cursor-pointer";const w=document.createElement("input");w.type="checkbox",w.value=v.uid,w.className="form-checkbox h-5 w-5 text-tomato rounded focus:ring-tomato",x.appendChild(w);const I=document.createElement("img");I.src=v.photoURL||"https://placehold.co/40x40",I.alt=v.displayName,I.className="w-8 h-8 rounded-full ml-3 mr-3",x.appendChild(I);const L=document.createElement("span");L.className="font-medium",L.textContent=v.displayName||v.email,x.appendChild(L),z.friendsList.appendChild(x)}}}}catch(a){console.error("Erreur lors du chargement des amis pour le partage : ",a),z.friendsList.innerHTML='<p class="text-red-500">Une erreur est survenue.</p>'}}async function Kn(e){const t=ve();if(!t||!e)return;const n=Array.from(z.friendsList.querySelectorAll('input[type="checkbox"]:checked:not(:disabled)')).map(a=>a.value);if(n.length===0){alert("Veuillez sélectionner au moins un ami à inviter.");return}z.confirmBtn.disabled=!0,z.confirmBtn.textContent="Envoi en cours...";try{const a=await xe($(h,"plans",e));if(!a.exists())throw new Error("Plan not found");const o=a.data().name,l=F(h,"shares"),c={senderId:t,createdAt:new Date,type:"collaborative_plan_invite",planId:e,planName:o};for(const p of n)await Se(l,{...c,receiverId:p,status:"pending"});yt(),alert("Invitation(s) envoyée(s) avec succès !")}catch(a){console.error("Erreur lors de l'envoi de l'invitation : ",a),alert("Une erreur est survenue lors de l'envoi de l'invitation.")}finally{z.confirmBtn.disabled=!1}}async function tn(e){if(!e||!e.id){alert("Plan non valide pour l'invitation.");return}Ae={plan:e},z.title.textContent=`Inviter à collaborer sur "${e.name}"`;const t=document.getElementById("share-mode-selection");t&&t.classList.add("hidden"),z.friendsList.innerHTML='<p class="text-gray-500">Chargement des amis...</p>',z.modal.classList.remove("hidden");const n=ve();if(!n)return;try{const o=await xe($(h,"users",n));if(o.exists()){const c=o.data().friends||[],p=[e.userId,...e.collaborators||[]];if(c.length===0){z.friendsList.innerHTML=`<p class="text-gray-500">Vous n'avez pas d'amis à inviter.</p>`;return}z.friendsList.innerHTML="";for(const v of c){const x=await xe($(h,"users",v));if(x.exists()){const w=x.data(),I=p.includes(w.uid),L=document.createElement("label");L.className=`flex items-center p-2 rounded-lg ${I?"opacity-50 cursor-not-allowed":"hover:bg-gray-100 cursor-pointer"}`;const C=document.createElement("input");C.type="checkbox",C.value=w.uid,C.className="form-checkbox h-5 w-5 text-tomato rounded focus:ring-tomato",I&&(C.disabled=!0,C.checked=!0),L.appendChild(C);const m=document.createElement("img");m.src=w.photoURL||"https://placehold.co/40x40",m.alt=w.displayName,m.className="w-8 h-8 rounded-full ml-3 mr-3",L.appendChild(m);const D=document.createElement("span");if(D.className="font-medium",D.textContent=w.displayName||w.email,I){const J=document.createElement("span");J.className="text-xs text-gray-400 ml-2",J.textContent="(déjà membre)",D.appendChild(J)}L.appendChild(D),z.friendsList.appendChild(L)}}}}catch(o){console.error("Erreur lors du chargement des amis pour l'invitation : ",o),z.friendsList.innerHTML='<p class="text-red-500">Une erreur est survenue.</p>'}z.confirmBtn.textContent="Envoyer l'invitation";const a=z.confirmBtn.cloneNode(!0);z.confirmBtn.parentNode.replaceChild(a,z.confirmBtn),z.confirmBtn=a,a.addEventListener("click",()=>Kn(e.id))}z.closeBtn?.addEventListener("click",yt);z.modal?.addEventListener("click",e=>{e.target===z.modal&&yt()});z.confirmBtn?.addEventListener("click",en);const Zn=Object.freeze(Object.defineProperty({__proto__:null,openInviteParticipantModal:tn,openShareModal:jt},Symbol.toStringTag,{value:"Module"}));function ea(){const e=document.getElementById("search-bar"),t=document.getElementById("lists-container"),n=document.getElementById("add-list-btn"),a=document.getElementById("shared-lists-container"),o=document.getElementById("list-form-modal"),l=document.getElementById("list-modal-title"),c=document.getElementById("close-list-modal"),p=document.getElementById("cancel-list-btn"),v=document.getElementById("list-form"),x=document.getElementById("list-id"),w=document.getElementById("list-name"),I=document.getElementById("ingredients-list"),L=document.getElementById("add-ingredient-btn"),C=document.getElementById("save-list-btn");let m=[],D="",J=[],Y=[];async function Ce(){await O(),await j(),await P()}async function O(){if(h)try{J=(await fe(F(h,"ingredients"))).docs.map(k=>({id:k.id,...k.data()})),J.sort((k,Q)=>k.name.localeCompare(Q.name))}catch(U){console.error("Erreur lors de la récupération de la liste des ingrédients: ",U)}}async function j(){const U=ve();if(!(!h||!U))try{const k=ce(F(h,"shopping_lists"),K("userId","==",U));m=(await fe(k)).docs.map(q=>({id:q.id,...q.data()})).filter(q=>q.isShared!==!0),ue()}catch(k){console.error("Erreur de chargement des listes: ",k)}}async function P(){const U=ve();if(!(!h||!U)){console.log(`Recherche de listes partagées pour userId: ${U}`);try{const k=ce(F(h,"shopping_lists"),K("userId","==",U),K("isShared","==",!0)),Q=await fe(k);console.log(`Trouvé ${Q.size} liste(s) partagée(s).`);const q=Q.docs.map(se=>({id:se.id,...se.data()}));Me(q)}catch(k){console.error("Erreur de chargement des listes partagées: ",k)}}}async function V(U=null){await O(),v.reset(),I.innerHTML="",Y=[],U?(l.textContent="Modifier la liste",x.value=U.id,w.value=U.name,U.ingredients&&U.ingredients.length>0?U.ingredients.forEach(k=>be(k)):be()):(l.textContent="Créer une liste",x.value="",be()),o.classList.remove("hidden")}function W(){o.classList.add("hidden")}async function Ee(U){U.preventDefault(),C.disabled=!0;const k=ve();if(!k){alert("Erreur : utilisateur non connecté."),C.disabled=!1;return}const Q=Y.filter(G=>G&&G.name&&G.quantity),q={name:w.value,ingredients:Q,userId:k};if(!q.name){alert("Le nom de la liste est requis."),C.disabled=!1;return}const se=x.value;try{se?await dt($(h,"shopping_lists",se),q):await Se(F(h,"shopping_lists"),q),W(),await j()}catch(G){console.error("Erreur de sauvegarde de la liste: ",G)}finally{C.disabled=!1}}function be(U={quantity:"",name:"",unit:""}){const k=document.createElement("div");k.className="relative flex items-stretch space-x-2 ingredient-row";const Q={...U};Y.push(Q);const q=Y.length-1,se=document.createElement("input");se.type="text",se.className="ingredient-quantity mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm",se.placeholder="Qté",se.value=Q.quantity,se.addEventListener("change",Ie=>{Y[q].quantity=Ie.target.value});const G=document.createElement("input");G.type="text",G.className="ingredient-unit mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm bg-gray-100",G.placeholder="Unité",G.readOnly=!0,G.value=Q.unit||"";const ie=document.createElement("div");ie.className="relative w-1/2";const X=document.createElement("input");X.type="text",X.className="ingredient-name mt-1 block w-full rounded-md border-gray-300 shadow-sm",X.placeholder="Chercher un ingrédient...",X.value=Q.name,ie.appendChild(X);const ee=document.createElement("div");ee.className="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto",ie.appendChild(ee),X.addEventListener("input",()=>{const Ie=X.value.toLowerCase();if(!Ie){ee.classList.add("hidden");return}const A=J.filter(N=>N.name.toLowerCase().includes(Ie));ee.innerHTML="",A.forEach(N=>{const B=document.createElement("div");B.className="p-2 ingredient-search-item cursor-pointer",B.textContent=N.name,B.addEventListener("click",()=>{X.value=N.name,G.value=N.unit,ee.classList.add("hidden"),Y[q].name=N.name,Y[q].unit=N.unit,Y[q].id=N.id}),ee.appendChild(B)});const _=document.createElement("div");_.className="p-2 bg-blue-50 hover:bg-blue-200 cursor-pointer font-bold text-blue-700",_.textContent=`+ Créer "${X.value}"`,_.addEventListener("click",async()=>{const N=X.value,B="pièce(s)";try{const R=await Se(F(h,"ingredients"),{name:N,unit:B,category:"Inconnue"});await O(),X.value=N,G.value=B,ee.classList.add("hidden"),Y[q].name=N,Y[q].unit=B,Y[q].id=R.id}catch(R){console.error("Erreur d'ajout d'ingrédient",R),alert("L'ingrédient n'a pas pu être créé.")}}),ee.appendChild(_),ee.classList.remove("hidden")});const me=document.createElement("button");me.type="button",me.className="btn btn-ghost text-red-500 hover:bg-red-50 btn-sm mt-1",me.innerHTML='<i class="fas fa-trash"></i>',me.addEventListener("click",()=>{k.remove(),Y[q]=null}),k.appendChild(ie),k.appendChild(se),k.appendChild(G),k.appendChild(me),I.appendChild(k)}function ue(){t.innerHTML="";let U=m;if(D){const k=D.toLowerCase();U=m.filter(Q=>Q.name.toLowerCase().includes(k))}if(U.length===0){t.innerHTML='<p class="text-center text-gray-500 p-10 col-span-full">Aucune liste de courses trouvée.</p>';return}U.sort((k,Q)=>k.name.localeCompare(Q.name)),U.forEach(k=>{const Q=document.createElement("div");Q.className="bg-white rounded-lg shadow-md p-4 flex flex-col";const q=document.createElement("div");q.className="flex justify-between items-start border-b pb-2 mb-2";const se=document.createElement("h4");se.className="text-lg font-bold text-gray-800",se.textContent=k.name,q.appendChild(se);const G=document.createElement("div");G.className="flex space-x-2";const ie=document.createElement("button");ie.className="btn btn-ghost btn-sm text-blue-500",ie.innerHTML='<i class="fas fa-edit"></i>',ie.addEventListener("click",()=>V(k)),G.appendChild(ie);const X=document.createElement("button");X.className="btn btn-ghost btn-sm text-green-500",X.innerHTML='<i class="fas fa-share-alt"></i>',X.addEventListener("click",()=>jt({})),G.appendChild(X);const ee=document.createElement("button");ee.className="btn btn-ghost btn-sm text-red-500",ee.innerHTML='<i class="fas fa-trash"></i>',ee.addEventListener("click",()=>ye(k.id,k.name)),G.appendChild(ee),q.appendChild(G);const me=document.createElement("ul");me.className="space-y-1 text-sm text-gray-600 flex-grow",k.ingredients&&k.ingredients.length>0?k.ingredients.forEach(Ie=>{const A=document.createElement("li");A.textContent=`${Ie.quantity} ${Ie.unit||""} - ${Ie.name}`.trim(),me.appendChild(A)}):me.innerHTML='<li class="italic text-gray-400">Cette liste est vide.</li>',Q.appendChild(q),Q.appendChild(me),t.appendChild(Q)})}function Me(U){if(a.innerHTML="",U.length===0){a.innerHTML='<p class="text-center text-gray-500 p-10 col-span-full">Aucune liste de courses partagée trouvée.</p>';return}U.sort((k,Q)=>k.name.localeCompare(Q.name)),U.forEach(k=>{const Q=document.createElement("div");Q.className="bg-white rounded-lg shadow-md p-4 flex flex-col";const q=document.createElement("div");q.className="flex justify-between items-start border-b pb-2 mb-2";const se=document.createElement("h4");se.className="text-lg font-bold text-gray-800",se.textContent=k.name,q.appendChild(se);const G=document.createElement("div");G.className="flex space-x-2";const ie=document.createElement("button");ie.className="btn btn-secondary btn-sm",ie.innerHTML='<i class="fas fa-copy mr-2"></i> Copier dans mes listes',ie.title="Copier cette liste dans vos listes personnelles",ie.addEventListener("click",()=>ze(k.id)),G.appendChild(ie);const X=document.createElement("button");X.className="btn btn-ghost btn-sm text-red-500",X.innerHTML='<i class="fas fa-trash"></i>',X.title="Supprimer cette liste partagée",X.addEventListener("click",()=>_e(k.id,k.name)),G.appendChild(X),q.appendChild(G);const ee=document.createElement("ul");ee.className="space-y-1 text-sm text-gray-600 flex-grow",k.ingredients&&k.ingredients.length>0?k.ingredients.forEach(me=>{const Ie=document.createElement("li");Ie.textContent=`${me.quantity} ${me.unit||""} - ${me.name}`.trim(),ee.appendChild(Ie)}):ee.innerHTML='<li class="italic text-gray-400">Cette liste est vide.</li>',Q.appendChild(q),Q.appendChild(ee),a.appendChild(Q)})}async function ye(U,k){if(confirm(`Êtes-vous sûr de vouloir supprimer la liste "${k}" ?`))try{await je($(h,"shopping_lists",U)),await j()}catch(Q){console.error("Erreur de suppression de la liste: ",Q)}}async function _e(U,k){if(confirm(`Êtes-vous sûr de vouloir supprimer la liste partagée "${k}" ?`))try{await je($(h,"shopping_lists",U)),await P()}catch(Q){console.error("Erreur de suppression de la liste partagée: ",Q),alert("Une erreur est survenue.")}}async function ze(U){if(confirm("Voulez-vous vraiment copier cette liste dans vos listes personnelles ? Elle ne sera plus considérée comme une liste partagée."))try{const k=$(h,"shopping_lists",U);await ke(k,{isShared:!1}),await Ce()}catch(k){console.error("Erreur lors de la copie de la liste: ",k),alert("Une erreur est survenue.")}}e.addEventListener("input",U=>{D=U.target.value,ue()}),n.addEventListener("click",()=>V()),c.addEventListener("click",W),p.addEventListener("click",W),v.addEventListener("submit",Ee),L.addEventListener("click",()=>be()),h&&Ce()}const ta=Object.freeze(Object.defineProperty({__proto__:null,default:ea},Symbol.toStringTag,{value:"Module"})),Pe=Sn();let ct,wt,Lt,ot,le,ut,Ct,It,lt,Je,mt,Bt,St,Nt,Tt,vt=null,bt=null;function Dt(){ct&&ct.classList.remove("hidden")}function rt(){ct&&ct.classList.add("hidden"),ot&&ot.reset()}function nn(e,t){bt=e,Je&&(Je.value=t),ut&&ut.classList.remove("hidden"),Je&&Je.focus()}function it(){bt=null,ut&&ut.classList.add("hidden"),lt&&lt.reset()}function an(e,t){vt=e,Nt&&(Nt.textContent="Confirmer la suppression"),Tt&&(Tt.textContent=`Êtes-vous sûr de vouloir supprimer le plan "${t}" ? Cette action est irréversible.`),mt&&mt.classList.remove("hidden")}function kt(){vt=null,mt&&mt.classList.add("hidden")}async function na(e){const t=Te();if(t)try{await Se(F(Pe,"plans"),{userId:t.uid,name:e,type:"personal",weeks:{},manualItems:[],defaultNumPeople:1,startDay:"Lundi",lastUpdated:new Date}),rt()}catch(n){console.error("Error creating plan: ",n),alert("Erreur lors de la création du plan.")}}async function aa(e,t){if(!(!e||!t))try{const n=$(Pe,"plans",e);await ke(n,{name:t}),it()}catch(n){console.error("Error renaming plan: ",n),alert("Erreur lors du renommage du plan.")}}async function sa(e){const t=Te()?.uid;if(!(!e||!t)&&confirm("Voulez-vous vraiment quitter ce plan partagé ? Il n'apparaîtra plus dans votre liste."))try{const n=$(Pe,"plans",e);await ke(n,{collaborators:Wt(t)})}catch(n){console.error("Erreur pour quitter le plan: ",n),alert("Une erreur est survenue.")}}async function ra(e){if(e)try{await je($(Pe,"plans",e))}catch(t){console.error("Error deleting plan: ",t),alert("Erreur lors de la suppression du plan.")}}function sn(e){const t=Te();if(!t)return()=>{};let n=new Map;const a=()=>{e(Array.from(n.values()).sort((x,w)=>x.name.localeCompare(w.name)))},o=async x=>{const I=[x.userId,...x.collaborators||[]].map(C=>xe($(Pe,"users",C)));return(await Promise.all(I)).map(C=>C.exists()?C.data():{uid:C.id,displayName:"Inconnu"})},l=ce(F(Pe,"plans"),K("userId","==",t.uid)),c=qe(l,async x=>{const I=x.docChanges().map(async L=>{if(L.type==="removed")n.delete(L.doc.id);else{const C=L.doc.data(),m=await o(C);n.set(L.doc.id,{id:L.doc.id,...C,isOwner:!0,participants:m})}});await Promise.all(I),a()}),p=ce(F(Pe,"plans"),K("collaborators","array-contains",t.uid)),v=qe(p,async x=>{const I=x.docChanges().map(async L=>{if(L.type==="removed")n.delete(L.doc.id);else{const C=L.doc.data(),m=await o(C),D=m.find(J=>J.uid===C.userId);n.set(L.doc.id,{id:L.doc.id,...C,isOwner:!1,ownerName:D?.displayName||"Inconnu",participants:m})}});await Promise.all(I),a()});return()=>{c(),v()}}function rn(e){if(!le)return;const t=le.value;if(le.innerHTML="",e.length===0){const n=document.createElement("option");n.value="",n.textContent="Aucun plan personnel",n.disabled=!0,le.appendChild(n);return}e.forEach(n=>{const a=document.createElement("option");a.value=n.id;let o=n.name;n.collaborators&&n.collaborators.length>0&&(n.isOwner?o=`👑 ${n.name} [Collab]`:o=`👥 ${n.name} [Collab] (de ${n.ownerName})`),a.textContent=o,le.appendChild(a)}),t&&le.querySelector(`option[value="${t}"]`)?le.value=t:le.selectedIndex=0}function on(){ct=document.getElementById("create-plan-modal"),wt=document.getElementById("close-create-plan-modal"),Lt=document.getElementById("cancel-create-plan-btn"),ot=document.getElementById("create-plan-form"),le=document.getElementById("plan-select"),ut=document.getElementById("rename-plan-modal"),Ct=document.getElementById("close-rename-plan-modal"),It=document.getElementById("cancel-rename-plan-btn"),lt=document.getElementById("rename-plan-form"),Je=document.getElementById("new-plan-name"),mt=document.getElementById("delete-confirm-modal"),Bt=document.getElementById("cancel-delete-btn"),St=document.getElementById("confirm-delete-btn"),Nt=document.getElementById("delete-confirm-title"),Tt=document.getElementById("delete-confirm-message");const e=document.getElementById("create-plan-btn"),t=document.getElementById("rename-plan-btn"),n=document.getElementById("leave-plan-btn"),a=document.getElementById("delete-plan-btn"),o=w=>{w.preventDefault();const I=document.getElementById("plan-name");I&&I.value&&na(I.value)},l=w=>{w.preventDefault(),bt&&Je.value&&aa(bt,Je.value)},c=()=>{vt&&ra(vt).then(()=>{kt()})},p=()=>{if(le&&le.value){const w=le.options[le.selectedIndex];nn(le.value,w.text)}else alert("Veuillez sélectionner un plan à renommer.")},v=()=>{le&&le.value?sa(le.value):alert("Veuillez sélectionner un plan.")},x=()=>{if(le&&le.value){const w=le.options[le.selectedIndex].text;an(le.value,w)}else alert("Veuillez sélectionner un plan à supprimer.")};return e?.addEventListener("click",Dt),t?.addEventListener("click",p),n?.addEventListener("click",v),a?.addEventListener("click",x),wt?.addEventListener("click",rt),Lt?.addEventListener("click",rt),ot?.addEventListener("submit",o),Ct?.addEventListener("click",it),It?.addEventListener("click",it),lt?.addEventListener("submit",l),Bt?.addEventListener("click",kt),St?.addEventListener("click",c),()=>{e?.removeEventListener("click",Dt),t?.removeEventListener("click",p),n?.removeEventListener("click",v),a?.removeEventListener("click",x),wt?.removeEventListener("click",rt),Lt?.removeEventListener("click",rt),ot?.removeEventListener("submit",o),Ct?.removeEventListener("click",it),It?.removeEventListener("click",it),lt?.removeEventListener("submit",l),Bt?.removeEventListener("click",kt),St?.removeEventListener("click",c)}}async function ln(e,t){if(!(!e||!t))try{const n=$(Pe,"plans",e);await ke(n,{collaborators:kn(t),type:"collaborative"})}catch(n){console.error("Error adding collaborator: ",n)}}async function Pt(e,t,n="Modification diverse"){if(!e||!t)return;const a=Te();if(a)try{const o=F(Pe,"plans",e,"history"),l=JSON.parse(JSON.stringify(t));await Se(o,{planState:l,timestamp:gt(),modifiedBy:a.uid,modifiedByName:a.displayName||a.email,description:n})}catch(o){console.error("Error saving history:",o)}}async function dn(e,t){const n=Te();if(!(!n||!e||!t))try{const a=F(Pe,"plan_saves"),o=ce(a,K("userId","==",n.uid),K("name","==",e)),l=await fe(o);if(l.empty)await Se(a,{userId:n.uid,name:e,savedAt:gt(),planData:t});else{const c=l.docs[0].id,p=$(Pe,"plan_saves",c);await ke(p,{planData:t,savedAt:gt()})}}catch(a){console.error("Error saving or updating plan save:",a),alert("Erreur lors de la sauvegarde.")}}async function ia(e,t,n){if(!e||!t||!n)return;const a=$(Pe,"plans",e);try{await ke(a,{[`weeks.${t}`]:n,lastUpdated:new Date}),console.log(`Week ${t} of plan ${e} saved successfully.`)}catch(o){console.error("Error saving plan week:",o),alert("Erreur lors de la sauvegarde du plan.")}}const oa=Object.freeze(Object.defineProperty({__proto__:null,addCollaborator:ln,getUserPlans:sn,initPlanManagement:on,openCreatePlanModal:Dt,openDeleteConfirmModal:an,openRenamePlanModal:nn,populatePlanSelector:rn,saveHistory:Pt,saveOrUpdatePlanSaveByName:dn,savePlanWeek:ia},Symbol.toStringTag,{value:"Module"}));let cn=[],un=[],mn=()=>{},pn=()=>{};const he={btn:null,badge:null,badgeMobile:null,dropdown:null,list:null};async function la(e,t,n){const a=ve();if(a)try{const o=$(h,"shares",e);if(await ke(o,{status:"accepted"}),t.plan){const l=n.displayName||"Inconnu",c=`Copie de "${t.plan.name}" (de ${l})`,p={...t.plan,userId:a,name:c,isShared:!0,originalOwnerId:t.senderId,sharedAt:new Date,collaborators:[]};delete p.id,await Se(F(h,"plans"),p)}t.shoppingList&&await Se(F(h,"shopping_lists"),{name:`${t.shoppingList.name} (de ${n.displayName})`,ingredients:t.shoppingList.ingredients,userId:a,isShared:!0,originalOwner:n.uid,sharedAt:new Date})}catch(o){console.error("Erreur lors de l'acceptation du partage : ",o),alert("Une erreur est survenue.")}}async function da(e,t){const n=ve();if(!(!n||!t||!t.planId))try{await ln(t.planId,n);const a=$(h,"shares",e);await ke(a,{status:"accepted"})}catch(a){console.error("Erreur lors de l'acceptation de l'invitation : ",a),alert("Une erreur est survenue.")}}async function Qt(e){try{const t=$(h,"shares",e);await ke(t,{status:"declined"})}catch(t){console.error("Erreur lors du refus du partage : ",t),alert("Une erreur est survenue.")}}async function ca(e){try{await Kt(e)}catch{alert("Erreur lors de l'acceptation.")}}async function ua(e){try{await Zt(e)}catch{alert("Erreur lors du refus.")}}function fn(){if(!he.list)return;const e=[...cn,...un];e.sort((n,a)=>a.createdAt.toMillis()-n.createdAt.toMillis());const t=n=>{n&&(e.length>0?(n.textContent=e.length,n.classList.remove("hidden")):n.classList.add("hidden"))};t(he.badge),t(he.badgeMobile),he.list.innerHTML="",e.length===0?he.list.innerHTML='<p class="text-gray-500 text-center p-4">Aucune nouvelle notification.</p>':e.forEach(n=>{const a=ma(n);he.list.appendChild(a)})}function ma(e){const t=document.createElement("div");t.className="p-3 border-b border-gray-100 hover:bg-gray-50";const n=document.createElement("p");n.className="text-sm font-medium text-gray-800";const a=document.createElement("p");a.className="text-xs text-gray-500 mb-3";const o=document.createElement("div");o.className="flex space-x-2 justify-end";const l=e.data.type||e.type;if(l==="collaborative_plan_invite"){n.textContent="Invitation à collaborer",a.textContent=`${e.sender.displayName} vous invite à modifier son plan "${e.data.planName}".`;const c=Ye("Accepter","btn-secondary",v=>{v.target.textContent="...",v.target.disabled=!0,da(e.id,e.data)}),p=Ye("Refuser","btn-ghost text-red-500",v=>{v.target.disabled=!0,Qt(e.id)});o.append(c,p)}else if(l==="share"){n.textContent=`Partage de ${e.sender.displayName||e.sender.email}`;let c=[];e.data.plan&&c.push("planification"),e.data.shoppingList&&c.push("liste de courses"),a.textContent=`Contenu : ${c.join(" et ")}`;const p=Ye("Accepter","btn-secondary",x=>{x.target.textContent="...",x.target.disabled=!0,la(e.id,e.data,e.sender)}),v=Ye("Refuser","btn-ghost text-red-500",x=>{x.target.disabled=!0,Qt(e.id)});o.append(p,v)}else if(l==="friend_request"){n.textContent="Invitation d'ami",a.textContent=`${e.sender.displayName||e.sender.email} vous a envoyé une invitation.`;const c=Ye("Accepter","btn-secondary",v=>{v.target.textContent="...",v.target.disabled=!0,ca(e.id)}),p=Ye("Refuser","btn-ghost text-red-500",v=>{v.target.disabled=!0,ua(e.id)});o.append(c,p)}return t.append(n,a,o),t}function Ye(e,t,n){const a=document.createElement("button");return a.className=`btn btn-xs ${t}`,a.textContent=e,a.addEventListener("click",o=>{o.stopPropagation(),n(o)}),a}function pa(e){const t=F(h,"shares"),n=ce(t,K("receiverId","==",e),K("status","==","pending"));mn=qe(n,async a=>{const o=[];for(const l of a.docs){const c=l.data(),p=await xe($(h,"users",c.senderId));p.exists()&&o.push({type:c.type||"share",id:l.id,data:c,sender:p.data(),createdAt:c.createdAt})}cn=o,fn()},a=>{console.error("Erreur d'écoute des partages:",a)})}function fa(e){const t=F(h,"friend_requests"),n=ce(t,K("receiverId","==",e),K("status","==","pending"));pn=qe(n,async a=>{const o=[];for(const l of a.docs){const c=l.data(),p=await xe($(h,"users",c.senderId));p.exists()&&o.push({type:"friend_request",id:l.id,data:c,sender:p.data(),createdAt:c.createdAt})}un=o,fn()},a=>{console.error("Erreur d'écoute des invitations d'amis:",a)})}function gn(){if(he.btn=document.getElementById("notifications-btn"),he.badge=document.getElementById("notifications-badge"),he.badgeMobile=document.getElementById("notifications-badge-mobile"),he.dropdown=document.getElementById("notifications-dropdown"),he.list=document.getElementById("notifications-list"),!he.btn)return;const e=ve();e&&(mn(),pn(),pa(e),fa(e),he.btn.addEventListener("click",t=>{t.stopPropagation(),he.dropdown.classList.toggle("hidden")}),document.addEventListener("click",t=>{he.dropdown&&!he.dropdown.classList.contains("hidden")&&!he.btn.contains(t.target)&&!he.dropdown.contains(t.target)&&he.dropdown.classList.add("hidden")}))}const ga=Object.freeze(Object.defineProperty({__proto__:null,initNotifications:gn},Symbol.toStringTag,{value:"Module"}));let Oe=null,Ze=null;function hn(e,t){if(!Et||!e)return;const n=Te();if(!n)return;const a=Ot(Et,`plans_presence/${e}`);Oe=Ot(Et,`plans_presence/${e}/${n.uid}`);const o={displayName:n.displayName||n.email,photoURL:n.photoURL,status:"idle",last_seen:Gt()};Mn(Oe).remove(),Nn(Oe,o),Ze&&Ze(),Ze=Tn(a,l=>{const c=l.val()||{};typeof t=="function"&&t(c)})}function vn(){Oe&&(Dn(Oe),Oe=null),Ze&&(Ze(),Ze=null)}function ft(e){Oe&&Pn(Oe,{status:e,last_seen:Gt()})}const ha=Object.freeze(Object.defineProperty({__proto__:null,connectToPresenceChannel:hn,disconnectFromPresenceChannel:vn,updateUserActivity:ft},Symbol.toStringTag,{value:"Module"}));let Ke=null;async function Ht(e,t){if(!e)return;const n=$(h,"recipes",e);try{await ke(n,{isFavorite:!t})}catch(a){console.error("Error toggling favorite status:",a)}}function va(){const e=document.getElementById("search-bar"),t=document.getElementById("category-tabs"),n=document.getElementById("recipe-list-container"),a=document.getElementById("add-recipe-btn");Ke&&Ke.destroy(),Ke=new $t(h,"recipe-form-modal","recipe-form","recipe-modal-title","recipe-id","recipe-name","recipe-category","recipe-servings","recipe-prep-time","recipe-difficulty","recipe-steps","ingredients-list","add-ingredient-btn","save-recipe-btn","close-recipe-modal","cancel-recipe-btn"),Ke.setOnSaveCallback(()=>{});let o=[],l="",c="",p=null;const v=["Entrée","Plat","Accompagnement","Dessert"],x={PLAT:"bg-orange-100",DESSERT:"bg-amber-100",ENTREE:"bg-lime-100",ACCOMPAGNEMENT:"bg-stone-200","PETIT-DEJEUNER":"bg-orange-100",BOISSON:"bg-cyan-100",SAUCE:"bg-red-100"},w={PLAT:"text-orange-800",DESSERT:"text-amber-800",ENTREE:"text-lime-800",ACCOMPAGNEMENT:"text-stone-800","PETIT-DEJEUNER":"text-orange-800",BOISSON:"text-cyan-800",SAUCE:"text-red-800"},I="bg-gray-100",L="text-gray-800";function C(){return h?qe(F(h,"recipes"),j=>{console.log("Recipe data updated on /recipes page from listener."),o=j.docs.map(P=>({id:P.id,...P.data()})),D(),J()},j=>{console.error("Erreur lors de l'écoute des recettes: ",j)}):()=>{}}function m(O){l=O,D(),J()}function D(){if(!t)return;t.innerHTML="";const j=[...new Set(o.map(P=>P.category||"Non classé"))].sort((P,V)=>{const W=ue=>{const Me=ue.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();for(let ye=0;ye<v.length;ye++)if(v[ye].normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()===Me)return ye;return-1},Ee=W(P),be=W(V);return Ee>-1&&be>-1?Ee-be:Ee>-1?-1:be>-1?1:P.localeCompare(V)});!l&&j.length>0&&(l=j[0]),j.forEach(P=>{const V=document.createElement("button"),W=P.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toUpperCase();if(P===l){const be=x[W]||I,ue=w[W]||L;V.className=`px-4 py-2 text-sm font-bold rounded-t-lg ${be} ${ue}`}else V.className="px-4 py-2 text-sm font-medium text-gray-500 hover:text-tomato";V.textContent=P,V.addEventListener("click",()=>m(P)),t.appendChild(V)})}function J(){if(!n)return;n.innerHTML="";let O=o.filter(P=>(P.category||"Non classé")===l);if(c){const P=c.toLowerCase();O=O.filter(V=>V.name.toLowerCase().includes(P))}if(O.sort((P,V)=>P.name.localeCompare(V.name)),O.length===0){n.innerHTML='<p class="text-gray-500 text-center p-10">Aucune recette trouvée.</p>';return}const j=document.createElement("div");j.className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4",O.forEach(P=>{j.appendChild(Y(P))}),n.appendChild(j)}function Y(O){const j=document.createElement("div");j.className="bg-white dark:bg-gray-800 shadow-md rounded-lg flex flex-col p-3";const P=document.createElement("div");P.className="w-full flex justify-between items-start";const V=document.createElement("h4");V.className="font-bold text-gray-800 dark:text-gray-200 pr-2",V.textContent=O.name,V.title=O.name,P.appendChild(V);const W=document.createElement("button");W.className="text-lg flex-shrink-0",W.innerHTML='<i class="fas fa-heart"></i>',O.isFavorite?W.classList.add("text-red-500"):W.classList.add("text-gray-300","dark:text-gray-500","hover:text-red-400"),W.addEventListener("click",_e=>{_e.stopPropagation(),Ht(O.id,O.isFavorite)}),P.appendChild(W),j.appendChild(P);const Ee=document.createElement("p");Ee.className="text-sm text-gray-600 dark:text-gray-400 mt-1 w-full",Ee.textContent=`${O.difficulty||""} - Pour ${O.servings||"?"} pers.`,j.appendChild(Ee);const be=document.createElement("div");be.className="flex-grow",j.appendChild(be);const ue=document.createElement("div");ue.className="w-full flex justify-end items-center space-x-2 border-t dark:border-gray-700 pt-2 mt-2";const Me=document.createElement("button");Me.className="btn btn-ghost btn-sm text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/50",Me.innerHTML='<i class="fas fa-edit"></i>',Me.title="Modifier",Me.addEventListener("click",()=>Ke.openForm(O,"Modifier la recette")),ue.appendChild(Me);const ye=document.createElement("button");return ye.className="btn btn-ghost btn-sm text-red-500 hover:bg-red-50 dark:hover:bg-red-900/50",ye.innerHTML='<i class="fas fa-trash-alt"></i>',ye.title="Supprimer",ye.addEventListener("click",()=>Ce(O.id,O.name)),ue.appendChild(ye),j.appendChild(ue),j}async function Ce(O,j){if(confirm(`Êtes-vous sûr de vouloir supprimer la recette "${j}" ?`))try{await je($(h,"recipes",O)),fetchAllRecipes()}catch(P){console.error("Erreur lors de la suppression: ",P)}}if(a.addEventListener("click",()=>Ke.openForm(null,"Ajouter une recette")),e.addEventListener("input",O=>{const j=O.target.value;if(!c&&j&&(p=l),c=j,c){const P=c.toLowerCase(),V=o.find(W=>W.name.toLowerCase().includes(P));V&&(l=V.category||"Non classé")}else p&&(l=p,p=null);D(),J()}),h)return C()}const ba=Object.freeze(Object.defineProperty({__proto__:null,default:va,toggleFavoriteStatus:Ht},Symbol.toStringTag,{value:"Module"}));let Ue=null;function ya(){const e={mealPlanGrid:document.getElementById("meal-plan-grid"),currentWeekDisplay:document.getElementById("current-week-display"),prevWeekBtn:document.getElementById("prev-week-btn"),nextWeekBtn:document.getElementById("next-week-btn"),clearMenuBtn:document.getElementById("clear-menu-btn"),shoppingListContainer:document.getElementById("shopping-list"),startDaySelect:document.getElementById("start-day-select"),defaultServingsControl:document.getElementById("default-servings-control"),mealSelectModal:document.getElementById("meal-select-modal"),closeMealSelectModalBtn:document.getElementById("close-meal-select-modal"),mealSelectModalTitle:document.getElementById("meal-select-modal-title"),mealSelectList:document.getElementById("meal-select-list"),recipeFormModal:document.getElementById("edit-recipe-form-modal"),closeRecipeModalBtn:document.getElementById("close-edit-recipe-modal"),cancelRecipeBtn:document.getElementById("edit-cancel-recipe-btn"),recipeForm:document.getElementById("edit-recipe-form"),addItemInput:document.getElementById("add-item-input"),addItemBtn:document.getElementById("add-item-btn"),addItemResults:document.getElementById("add-item-results"),importListBtn:document.getElementById("import-list-btn"),importListModal:document.getElementById("import-list-modal"),closeImportListModalBtn:document.getElementById("close-import-list-modal"),importListContainer:document.getElementById("import-list-container"),exportTxtBtn:document.getElementById("export-txt-btn"),exportPdfBtn:document.getElementById("export-pdf-btn"),exportPlanPdfBtn:document.getElementById("export-plan-pdf-btn"),sharePlanBtn:document.getElementById("share-plan-btn"),planSelect:document.getElementById("plan-select"),inviteParticipantBtn:document.getElementById("invite-participant-btn"),historyPlanBtn:document.getElementById("history-plan-btn"),planHistoryModal:document.getElementById("plan-history-modal"),closePlanHistoryModalBtn:document.getElementById("close-plan-history-modal"),planHistoryList:document.getElementById("plan-history-list"),savePlanBtn:document.getElementById("save-plan-btn")};function t(s,r){const u=document.createElement("div");u.className="flex items-center space-x-2";const d=document.createElement("button");d.className="btn btn-outline btn-xs",d.textContent="-";const i=document.createElement("span");i.className="font-medium text-center w-6",i.textContent=s;const f=document.createElement("button");return f.className="btn btn-outline btn-xs",f.textContent="+",d.addEventListener("click",()=>{let b=parseInt(i.textContent,10);b>1&&(b--,i.textContent=b,r(b))}),f.addEventListener("click",()=>{let b=parseInt(i.textContent,10);b++,i.textContent=b,r(b)}),u.appendChild(d),u.appendChild(i),u.appendChild(f),u}function n(s,r,u,d=!1){const i=document.createElement("div");i.className="flex flex-col items-center justify-center h-full";const f=document.createElement("button");f.className="btn btn-ghost btn-xs p-0 h-4 flex items-center justify-center w-full",f.innerHTML='<i class="fas fa-plus"></i>',f.disabled=d;const b=document.createElement("span");b.className="font-medium text-center text-sm my-1",b.textContent=s;const g=document.createElement("button");return g.className="btn btn-ghost btn-xs p-0 h-4 flex items-center justify-center w-full",g.innerHTML='<i class="fas fa-minus"></i>',g.disabled=d,r&&(f.classList.add("text-white"),b.classList.add("text-white"),g.classList.add("text-white")),d||(f.addEventListener("click",()=>{let E=parseInt(b.textContent,10);E++,b.textContent=E,u(E)}),g.addEventListener("click",()=>{let E=parseInt(b.textContent,10);E>1&&(E--,b.textContent=E,u(E))})),i.appendChild(f),i.appendChild(b),i.appendChild(g),i}Ue&&Ue.destroy(),Ue=new $t(h,"edit-recipe-form-modal","edit-recipe-form","edit-recipe-modal-title","edit-recipe-id","edit-recipe-name","edit-recipe-category","edit-recipe-servings","edit-recipe-prep-time","edit-recipe-difficulty","edit-recipe-steps","edit-ingredients-list","edit-add-ingredient-btn","edit-save-recipe-btn","close-edit-recipe-modal","edit-cancel-recipe-btn"),Ue.setActivityUpdater(ft),Ue.setOnSaveCallback(async()=>{});let a=1,o="Lundi",l={},c={},p={};const v=[];let x=null,w=[],I=[],L=1,C=[],m=null;const D=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];function J(s){return s?s.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase():""}async function Y(s){const r=document.getElementById("unit-select-modal"),u=document.getElementById("unit-modal-title"),d=document.getElementById("unit-modal-list"),i=document.getElementById("unit-modal-cancel");return u.textContent=`Choisir une unité pour "${s}"`,d.innerHTML="",new Promise((f,b)=>{const g=["g","kg","ml","l","pièce(s)","c.à.s.","c.à.c.","pincée(s)"],E=y=>{r.classList.add("hidden"),f(y)};g.forEach(y=>{const S=document.createElement("button");S.className="btn btn-outline",S.textContent=y,S.addEventListener("click",()=>E(y)),d.appendChild(S)});const M=()=>{r.classList.add("hidden"),b()};i.addEventListener("click",M,{once:!0}),r.addEventListener("click",y=>{y.target===r&&M()},{once:!0}),r.classList.remove("hidden")})}async function Ce(){if(h)try{I=(await fe(F(h,"ingredients"))).docs.map(r=>({id:r.id,...r.data()})),I.sort((r,u)=>r.name.localeCompare(u.name))}catch(s){console.error("Erreur lors de la récupération des ingrédients: ",s)}}function O(){if(!m)l={},c={},p={},L=1,o="Lundi";else{const s=m.weeks?m.weeks[a]||{}:{};l=s.menuData||{},c=s.servingsData||{},p=s.remarksData||{},L=m.defaultNumPeople||1,o=m.startDay||"Lundi"}if(e.startDaySelect&&(e.startDaySelect.value=o),e.defaultServingsControl){e.defaultServingsControl.innerHTML="";const s=t(L,async r=>{L=r,m&&await j({defaultNumPeople:r},`a changé le nombre de personnes par défaut à ${r}`)});e.defaultServingsControl.appendChild(s)}yn(),ue(e.mealPlanGrid,{menuData:l,servingsData:c,remarksData:p,defaultNumPeople:L,startDay:o},!1),be(document.getElementById("mobile-meal-plan"),{menuData:l,remarksData:p,startDay:o},!1),ie()}async function j(s,r){if(!m)return;await Pt(m.id,m,r);const u=$(h,"plans",m.id);try{await ke(u,{...s,lastUpdated:new Date})}catch(d){console.error("Error updating plan:",d),alert("Une erreur de sauvegarde est survenue.")}}function P(){e.planHistoryModal.classList.add("hidden")}async function V(s){if(m&&confirm("Voulez-vous vraiment restaurer cette version ? L'état actuel sera sauvegardé dans l'historique avant la restauration."))try{const r=$(h,"plans",m.id,"history",s),u=await xe(r);if(!u.exists())throw new Error("Version de l'historique non trouvée.");const d=u.data().planState;await Pt(m.id,m);const i=$(h,"plans",m.id);await dt(i,d),P()}catch(r){console.error("Erreur lors du rollback :",r)}}async function W(s,r){if(m&&confirm("Êtes-vous sûr de vouloir supprimer définitivement cette entrée de l'historique ?"))try{const u=$(h,"plans",m.id,"history",s);await je(u),r.remove()}catch(u){console.error("Erreur lors de la suppression de l'historique :",u),alert("Une erreur est survenue lors de la suppression.")}}async function Ee(){if(m){e.planHistoryList.innerHTML="<p>Chargement de l'historique...</p>",e.planHistoryModal.classList.remove("hidden");try{const s=F(h,"plans",m.id,"history"),r=ce(s,_n("timestamp","desc")),u=await fe(r);if(e.planHistoryList.innerHTML="",u.empty){e.planHistoryList.innerHTML="<p>Aucun historique pour ce plan.</p>";return}u.forEach(d=>{const i=d.data(),f=document.createElement("div");f.className="p-3 border-b flex justify-between items-center";const b=document.createElement("div"),g=i.timestamp?.toDate().toLocaleString("fr-FR")||"Date inconnue",E=i.description||"Modification diverse",M=i.modifiedByName||"Inconnu";b.innerHTML=`
                    <p class="font-medium">${M} ${E}</p>
                    <p class="text-sm text-gray-500">${g}</p>
                `;const y=document.createElement("div");y.className="flex items-center space-x-2";const S=document.createElement("button");S.className="btn btn-secondary btn-sm",S.textContent="Revenir à cette version",S.addEventListener("click",()=>V(d.id));const T=document.createElement("button");T.className="btn btn-ghost text-red-500 hover:bg-red-100 btn-sm",T.innerHTML='<i class="fas fa-times"></i>',T.title="Supprimer cette version",T.addEventListener("click",H=>{H.stopPropagation(),W(d.id,f)}),y.appendChild(S),y.appendChild(T),f.appendChild(b),f.appendChild(y),e.planHistoryList.appendChild(f)})}catch(s){console.error("Erreur de chargement de l'historique:",s),e.planHistoryList.innerHTML=`<p class="text-red-500">Impossible de charger l'historique.</p>`}}}function be(s,r,u=!1){if(!s)return;const d=r.menuData||{},i=r.remarksData||{},f=r.startDay||"Lundi";s.innerHTML="";const b=document.createDocumentFragment(),g=D.indexOf(f);[...D.slice(g),...D.slice(0,g)].forEach(M=>{const y=D.indexOf(M),S=document.createElement("div");S.className="border rounded-lg overflow-hidden";const T=document.createElement("button");T.className="w-full p-3 text-left bg-gray-100 hover:bg-gray-200 flex justify-between items-center",T.innerHTML=`<span class="font-bold text-gray-800">${M.toUpperCase()}</span><i class="fas fa-chevron-down transition-transform"></i>`;const H=document.createElement("div");H.className="hidden p-2 space-y-4",T.addEventListener("click",()=>{H.classList.toggle("hidden"),T.querySelector("i").classList.toggle("rotate-180")}),["lunch","dinner"].forEach(Z=>{const ne=document.createElement("div"),ge=document.createElement("h4");ge.className="font-bold text-lg mb-2 border-b pb-1",ge.textContent=Z==="lunch"?"Midi":"Soir",ne.appendChild(ge);const re=document.createElement("div");re.className="space-y-3";for(let we=0;we<5;we++){const ae=`${y}-${Z}-${we}`,Ne=B(ae),de=document.createElement("div"),oe=document.createElement("label");oe.className="text-sm font-semibold text-gray-600",oe.textContent=Ne,de.appendChild(oe);const pe=document.createElement("div");if(pe.className="meal-slot p-2 min-h-[50px] bg-gray-50 rounded-md",pe.dataset.slotId=ae,Ne==="Remarque")pe.appendChild(We(ae,i,u));else{const Be=d[ae];if(Array.isArray(Be)&&Be.length>0){const Le=document.createElement("div");Le.className="space-y-2",Be.forEach((He,De)=>{const tt=w.find(Fe=>Fe.id===He.id);tt&&Le.appendChild(R(tt,ae,De,u))}),pe.appendChild(Le)}u||pe.appendChild(Re(ae,!1))}de.appendChild(pe),re.appendChild(de)}ne.appendChild(re),H.appendChild(ne)}),S.appendChild(T),S.appendChild(H),b.appendChild(S)}),s.appendChild(b),u||Ve()}function ue(s,r,u=!1){if(!s)return;const d=r.menuData||{},i=r.servingsData||{},f=r.remarksData||{},b=r.defaultNumPeople||1,g=r.startDay||"Lundi",E=document.createDocumentFragment(),M=["lunch","dinner"],y=5,S=D.indexOf(g);[...D.slice(S),...D.slice(0,S)].forEach(H=>{const Z=D.indexOf(H),ne=document.createElement("div");ne.className="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] items-stretch border-b border-gray-300";const ge=document.createElement("div");ge.className="font-bold p-2 flex items-center justify-center bg-gray-100 text-sm border-r border-gray-300",ge.textContent=H.toUpperCase(),ne.appendChild(ge),M.forEach(re=>{const we=`${Z}-${re}`,ae=i[we]||b,Ne=i.hasOwnProperty(we),de=document.createElement("div"),oe=n(ae,Ne,Be=>{wn(we,Be)},u);let pe="border-r border-gray-300 flex items-center justify-center transition-colors duration-300";Ne?pe+=" bg-tomato":pe+=re==="lunch"?" bg-amber-50":" bg-stone-100",de.className=pe,de.appendChild(oe),ne.appendChild(de);for(let Be=0;Be<y;Be++){const Le=`${Z}-${re}-${Be}`,He=d[Le],De=document.createElement("div"),tt=B(Le);let Fe="meal-slot p-1 min-h-[70px] flex flex-col justify-start border-r border-gray-300";if(Fe+=re==="lunch"?" bg-amber-50":" bg-stone-100",De.className=Fe,De.dataset.slotId=Le,tt==="Remarque")De.appendChild(We(Le,f,u));else if(Array.isArray(He)&&He.length>0){const Qe=document.createElement("div");Qe.className="w-full",He.forEach((nt,at)=>{const $e=w.find(st=>st.id===nt.id);if($e)Qe.appendChild(R($e,Le,at,u));else{const st=document.createElement("div");st.className="p-1 bg-red-100 text-red-700 rounded shadow-sm text-center text-xs font-medium",st.textContent="Recette supprimée",Qe.appendChild(st)}}),De.appendChild(Qe),u||De.appendChild(Re(Le,!0))}else u||De.appendChild(Re(Le,!1));ne.appendChild(De)}}),E.appendChild(ne)}),s.innerHTML="",s.appendChild(E),u||Ve()}async function Me(){const s=ve();if(!h||!s)return[];try{const r=ce(F(h,"shopping_lists"),K("userId","==",s));return(await fe(r)).docs.map(f=>({id:f.id,...f.data()})).filter(f=>f.isShared!==!0)}catch(r){return console.error("Erreur de chargement des listes de courses sauvegardées: ",r),[]}}async function ye(){const s=await Me();if(e.importListContainer.innerHTML="",s.length===0){e.importListContainer.innerHTML='<p class="text-center text-gray-500">Aucune liste sauvegardée.</p>';return}s.forEach(r=>{const u=document.createElement("button");u.className="w-full text-left p-2 hover:bg-gray-100 rounded-lg transition-colors duration-150",u.textContent=r.name,u.addEventListener("click",()=>{confirm(`Voulez-vous vraiment importer les ingrédients de la liste "${r.name}" ?`)&&(r.ingredients.forEach(d=>{const i=parseFloat(String(d.quantity).replace(",","."))||0;q(d.name,i,d.unit)}),_e())}),e.importListContainer.appendChild(u)}),e.importListModal.classList.remove("hidden")}function _e(){e.importListModal.classList.add("hidden")}function ze(){e.addItemInput?.addEventListener("input",()=>{const s=e.addItemInput.value.toLowerCase(),r=e.addItemResults;if(r.innerHTML="",!s){r.classList.add("hidden");return}I.filter(i=>i.name.toLowerCase().includes(s)).forEach(i=>{const f=document.createElement("div");f.className="p-2 hover:bg-gray-100 cursor-pointer",f.textContent=i.name,f.addEventListener("click",()=>{q(i.name,1,i.unit),e.addItemInput.value="",r.classList.add("hidden")}),r.appendChild(f)});const d=document.createElement("div");d.className="p-2 bg-green-50 hover:bg-green-200 cursor-pointer font-bold text-green-700",d.textContent=`+ Créer "${e.addItemInput.value}"`,d.addEventListener("click",async()=>{const i=e.addItemInput.value;try{const f=await Y(i);await Se(F(h,"ingredients"),{name:i,unit:f}),await Ce(),q(i,1,f),e.addItemInput.value="",r.classList.add("hidden")}catch{}}),r.appendChild(d),r.classList.remove("hidden")}),e.addItemBtn?.addEventListener("click",()=>{const s=e.addItemInput.value;s&&(q(s,1,""),e.addItemInput.value="",e.addItemResults.classList.add("hidden"))}),document.addEventListener("click",s=>{e.addItemInput&&!e.addItemInput.contains(s.target)&&!e.addItemResults.contains(s.target)&&e.addItemResults.classList.add("hidden")})}function U(){if(v.length===0){alert("La liste de courses est vide.");return}const s=v.reduce((i,f)=>{const b=f.category||"Inconnue";return i[b]||(i[b]=[]),i[b].push(f),i},{}),r=Object.keys(s).sort((i,f)=>i==="Inconnue"?1:f==="Inconnue"?-1:i.localeCompare(f));let u=`Liste de courses - GustoPlan

`;r.forEach(i=>{u+=`--- ${i.toUpperCase()} ---
`,s[i].sort((b,g)=>b.name.localeCompare(g.name)).forEach(b=>{let E=`${Number.isInteger(b.totalQuantity)?b.totalQuantity:parseFloat(b.totalQuantity.toFixed(2))} ${b.unit||""} ${b.name}`;if(b.sources&&b.sources.length>0){const M=b.sources.reduce((S,T)=>{const H=`${T.recipeName} (${T.day} ${T.time})`;return S[H]||(S[H]=0),S[H]+=T.quantity,S},{}),y=Object.keys(M).join(" / ");E+=` *** ${y} ***`}u+=E+`
`}),u+=`
`});const d=new Blob([u],{type:"text/plain;charset=utf-8"});saveAs(d,"liste-de-courses.txt")}function k(){if(v.length===0){alert("La liste de courses est vide.");return}const{jsPDF:s}=window.jspdf,r=new s,u=v.reduce((E,M)=>{const y=M.category||"Inconnue";return E[y]||(E[y]=[]),E[y].push(M),E},{}),d=Object.keys(u).sort((E,M)=>E==="Inconnue"?1:M==="Inconnue"?-1:E.localeCompare(M));r.setFontSize(18),r.text("Liste de courses - GustoPlan",14,22);let i=35;const f=r.internal.pageSize.height,b=20,g=()=>{i>f-b&&(r.addPage(),i=20)};d.forEach(E=>{g(),r.setFontSize(14),r.setFont(void 0,"bold"),r.text(`--- ${E.toUpperCase()} ---`,14,i),i+=8,r.setFont(void 0,"normal"),u[E].sort((y,S)=>y.name.localeCompare(S.name)).forEach(y=>{g(),r.setFontSize(12);const S=Number.isInteger(y.totalQuantity)?y.totalQuantity:parseFloat(y.totalQuantity.toFixed(2));if(r.text(`${S} ${y.unit||""} ${y.name}`,14,i),i+=6,y.sources&&y.sources.length>0){const T=y.sources.reduce((H,Z)=>{const ne=`${Z.recipeName} (${Z.day} ${Z.time})`;return H[ne]||(H[ne]=0),H[ne]+=Z.quantity,H},{});r.setFontSize(9),r.setTextColor(100);for(const H in T)g(),r.text(`  * ${H}`,18,i),i+=5;r.setTextColor(0)}i+=2}),i+=5}),r.save("liste-de-courses.pdf")}async function Q(){if(!m){alert("Veuillez sélectionner un plan à exporter.");return}const s=document.getElementById("loading-overlay");s&&s.classList.remove("hidden");try{const{jsPDF:r}=window.jspdf,u=new r,d=$(h,"plans",m.id),i=await xe(d),f=i.exists()?i.data():null;if(!f||!f.weeks){alert("Ce plan est vide et ne peut pas être exporté.");return}u.setFontSize(18),u.text(`Plan de Repas: ${f.name}`,14,20);const b=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"],g={0:"E",1:"P",2:"A",3:"D"},E=Object.keys(f.weeks).sort((y,S)=>parseInt(y)-parseInt(S));let M=!0;for(const y of E){const T=f.weeks[y].menuData||{};if(Object.keys(T).length===0)continue;const H=[["Jour","Midi","Soir"]],Z=[],ne=b.indexOf(f.startDay||"Lundi"),ge=[...b.slice(ne),...b.slice(0,ne)];for(const we of ge){const ae=b.indexOf(we);let Ne=[],de=[];for(const oe of["lunch","dinner"])for(const pe in g){const Be=`${ae}-${oe}-${pe}`;T[Be]&&Array.isArray(T[Be])&&T[Be].forEach(Le=>{const He=`[${g[pe]}] ${Le.name}`;oe==="lunch"?Ne.push(He):de.push(He)})}Z.push([we,Ne.join(`
`)||"-",de.join(`
`)||"-"])}u.setFontSize(14);const re=M?30:u.autoTable.previous.finalY+20;u.text(`Semaine ${y}`,14,re-5),u.autoTable({startY:re,head:H,body:Z,theme:"grid",styles:{cellPadding:2,fontSize:8,valign:"middle"},headStyles:{fillColor:[41,128,185],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[245,245,245]}}),M=!1}u.save(`plan_${f.name.replace(/ /g,"_")}.pdf`)}catch(r){console.error("Erreur lors de la génération du PDF du plan :",r),alert("Une erreur est survenue lors de la création du PDF.")}finally{s&&s.classList.add("hidden")}}async function q(s,r,u,d=!1){if(!m)return alert("Veuillez sélectionner un plan.");const i=$(h,"plans",m.id);try{await $n(h,async f=>{const b=await f.get(i);if(!b.exists())throw"Le plan n'existe plus.";const g=b.data().manualItems||[],E=`${s.trim().toLowerCase()}_${u||""}`,M=g.findIndex(S=>`${S.name.trim().toLowerCase()}_${S.unit||""}`===E);if(M>-1)g[M].totalQuantity+=r;else{const S=I.find(T=>T.name.toLowerCase()===s.trim().toLowerCase());g.push({name:s.trim(),totalQuantity:r,unit:u,source:"manual",category:S?.category||"Inconnue"})}const y=g.filter(S=>S.totalQuantity!==0);f.update(i,{manualItems:y,lastUpdated:new Date})})}catch(f){console.error("Erreur transactionnelle lors de l'ajustement de l'ingrédient: ",f),alert("Une erreur de synchronisation est survenue. Veuillez réessayer.")}}function se(s){const r=s?s.toLowerCase():"";return r.includes("g")||r.includes("ml")?10:1}function G(){const s=e.shoppingListContainer;if(!s)return;if(s.innerHTML="",v.length===0){s.innerHTML='<p class="text-center text-gray-500 italic py-4">Votre liste de courses est vide.</p>';return}const r=v.reduce((d,i)=>{const f=i.category||"Inconnue";return d[f]||(d[f]=[]),d[f].push(i),d},{});Object.keys(r).sort((d,i)=>d==="Inconnue"?1:i==="Inconnue"?-1:d.localeCompare(i)).forEach(d=>{const i=document.createElement("h4");i.className="text-sm font-bold text-stone-800 bg-stone-200 mt-4 mb-2 px-3 py-1 rounded-md",i.textContent=d,s.appendChild(i);const f=document.createElement("ul");f.className="space-y-2",r[d].sort((g,E)=>g.name.localeCompare(E.name)).forEach(g=>{const E=document.createElement("li");let M="p-2 rounded";E.className=M+(g.source==="manual"?" bg-lemon":" bg-gray-50");const y=document.createElement("div");y.className="flex justify-between items-center";const S=document.createElement("span");S.className="flex-grow text-sm font-medium",S.textContent=g.name,y.appendChild(S);const T=document.createElement("div");T.className="flex items-center space-x-2 mx-2";const H=document.createElement("span");H.className="font-medium w-20 text-center text-sm";const Z=Number.isInteger(g.totalQuantity)?g.totalQuantity:parseFloat(g.totalQuantity.toFixed(2));H.textContent=`${Z} ${g.unit||""}`.trim();const ne=document.createElement("div");ne.className="flex flex-col";const ge=document.createElement("button");ge.className="btn btn-outline btn-xs rounded-b-none",ge.textContent="+",ge.addEventListener("click",async()=>{const ae=se(g.unit);await q(g.name,ae,g.unit)});const re=document.createElement("button");re.className="btn btn-outline btn-xs rounded-t-none -mt-px",re.textContent="-",re.addEventListener("click",async()=>{const ae=se(g.unit);await q(g.name,-ae,g.unit)}),ne.appendChild(ge),ne.appendChild(re),T.appendChild(H),T.appendChild(ne),y.appendChild(T);const we=document.createElement("button");if(we.className="delete-item-btn text-red-500 hover:text-red-700",we.innerHTML='<i class="fas fa-trash-alt"></i>',we.addEventListener("click",()=>{q(g.name,-g.totalQuantity,g.unit,!0)}),y.appendChild(we),E.appendChild(y),g.sources&&g.sources.length>0){const ae=document.createElement("div");ae.className="p-2 mt-1 ml-4 rounded-md bg-stone-100";const Ne=g.sources.reduce((de,oe)=>{const pe=`${oe.recipeName} (${oe.day} ${oe.time})`;return de[pe]||(de[pe]=0),de[pe]+=oe.quantity,de},{});for(const de in Ne){const oe=document.createElement("span");oe.className="block text-xs text-gray-500",oe.textContent=`↳ ${de}`,ae.appendChild(oe)}E.appendChild(ae)}f.appendChild(E)}),s.appendChild(f)})}async function ie(){if(!m){v.length=0,G();return}const s=m.manualItems?JSON.parse(JSON.stringify(m.manualItems)):[],r=new Map(s.map(i=>[`${i.name.trim().toLowerCase()}_${i.unit||""}`,i])),u=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];if(m.weeks)for(const i in m.weeks){const f=m.weeks[i],b=f.menuData||{},g=f.servingsData||{};for(const E in b){const M=b[E];if(!Array.isArray(M))continue;const[y,S]=E.split("-"),T=parseInt(y,10),H=u[T]||"Jour inconnu",Z=S==="lunch"?"midi":"soir",ne=`${T}-${S}`,ge=parseInt(g[ne]||m.defaultNumPeople,10);for(const re of M){const ae=w.find(de=>de.id===re.id)||re;if(!ae||!Array.isArray(ae.ingredients))continue;const Ne=ae.servings||1;Ne<=0||ae.ingredients.forEach(de=>{const{name:oe,quantity:pe,unit:Be}=de;if(!oe||!pe)return;const Le=I.find($e=>$e.name.toLowerCase()===oe.trim().toLowerCase()),He=Le?Le.category:"Inconnue",De=parseFloat(String(pe).replace(",","."));if(isNaN(De))return;const Fe=De/Ne*ge,Qe=Be||"",nt=`${oe.trim().toLowerCase()}_${Qe}`,at={recipeName:ae.name,day:`${H} (S${i})`,time:Z,quantity:Fe};if(r.has(nt)){const $e=r.get(nt);$e.totalQuantity+=Fe,$e.source==="manual"&&($e.source="mixed"),Array.isArray($e.sources)?$e.sources.push(at):$e.sources=[at]}else r.set(nt,{name:oe.trim(),totalQuantity:Fe,unit:Qe,source:"plan",category:He,sources:[at]})})}}}const d=Array.from(r.values()).filter(i=>i.totalQuantity>0);v.length=0,v.push(...d.sort((i,f)=>i.name.localeCompare(f.name))),G()}function X(s){const r=B(s);if(!r||!e.mealSelectModal)return;e.mealSelectModalTitle.textContent=`Sélectionner : ${r}`,e.mealSelectList.innerHTML="";const u=document.createElement("input");u.type="text",u.placeholder="Rechercher dans la catégorie...",u.className="w-full p-2 mb-4 border border-gray-300 rounded-lg",e.mealSelectList.appendChild(u);const d=J(r),i=w.filter(g=>J(g.category)===d).sort((g,E)=>{const M=g.isFavorite?1:0,y=E.isFavorite?1:0;return y!==M?y-M:g.name.localeCompare(E.name)}),f=document.createElement("div");f.className="space-y-1 max-h-80 overflow-y-auto",e.mealSelectList.appendChild(f);function b(g=""){f.innerHTML="";const E=g.toLowerCase(),M=i.filter(y=>y.name.toLowerCase().includes(E));M.length===0?f.innerHTML='<p class="text-gray-500 p-4">Aucun plat ne correspond à votre recherche.</p>':M.forEach(y=>{const S=document.createElement("button");S.className="w-full text-left p-2 hover:bg-gray-100 rounded-lg transition-colors duration-150";const T=document.createElement("p");T.className="font-medium text-gray-800 text-sm",y.isFavorite?T.innerHTML=`${y.name} <i class="fas fa-heart text-red-500 ml-2"></i>`:T.textContent=y.name,S.appendChild(T),S.addEventListener("click",()=>{Ge(s,y),ee()}),f.appendChild(S)})}u.addEventListener("input",g=>b(g.target.value)),b(),e.mealSelectModal.classList.remove("hidden"),u.focus()}function ee(){e.mealSelectModal&&e.mealSelectModal.classList.add("hidden")}function me(s){x=s.target.closest(".meal-card");const r=x.closest(".meal-slot").dataset.slotId;s.dataTransfer.setData("text/plain",r),setTimeout(()=>{x&&(x.style.opacity="0.5")},0)}function Ie(){x&&(x.style.opacity="1",x=null)}function A(s){s.preventDefault();const r=s.target.closest(".meal-slot");r&&B(r.dataset.slotId)!=="Remarque"&&r.classList.add("bg-gray-200")}function _(s){const r=s.target.closest(".meal-slot");r&&r.classList.remove("bg-gray-200")}async function N(s){s.preventDefault();const r=s.dataTransfer.getData("text/plain"),u=s.target.closest(".meal-slot");if(u){u.classList.remove("bg-gray-200");const d=u.dataset.slotId,i=B(d);if(i==="Remarque")return;if(r&&d&&r!==d){const f=l[r],b=B(r);if(J(b)!==J(i)){alert(`Action impossible : un(e) "${b}" ne peut pas aller dans la catégorie "${i}".`);return}const g=l[d];l[d]=f,g?l[r]=g:delete l[r],ue(e.mealPlanGrid,{menuData:l,servingsData:c,remarksData:p,defaultNumPeople:L,startDay:o},!1),await j({[`weeks.${a}.menuData`]:l},"a déplacé un plat"),await ie()}}}function B(s){switch(s.split("-")[2]){case"0":return"Entrée";case"1":return"Plat";case"2":return"Accompagnement";case"3":return"Dessert";case"4":return"Remarque";default:return""}}function R(s,r,u,d=!1){const i=document.createElement("div");if(i.className="meal-card p-1 flex flex-col items-center bg-white rounded shadow-sm text-center relative w-full mb-1",d||(i.classList.add("cursor-grab"),i.draggable=!0),!d){const E=document.createElement("button");E.className="absolute -top-2 -right-1 text-base",E.innerHTML='<i class="fas fa-heart"></i>',s.isFavorite?E.classList.add("text-red-500"):E.classList.add("text-gray-300","hover:text-red-400"),E.addEventListener("click",M=>{M.stopPropagation(),Ht(s.id,s.isFavorite)}),i.appendChild(E)}const f=document.createElement("span");if(f.className="text-xs font-medium p-1 break-words w-full",f.textContent=s.name,i.appendChild(f),!d){const E=document.createElement("div");E.className="absolute top-0 left-0 flex";const M=document.createElement("button");M.className="edit-meal-btn text-gray-600 hover:text-gray-800 hidden px-1 py-0.5",M.innerHTML='<i class="fas fa-pencil-alt fa-xs"></i>',M.title="Modifier la recette",M.addEventListener("click",S=>{S.stopPropagation();const T=w.find(H=>H.id===s.id);Ue.openForm(T||s,"Modifier la recette")}),E.appendChild(M);const y=document.createElement("button");y.className="delete-meal-btn text-red-700 hover:text-red-900 hidden px-1 py-0.5",y.innerHTML='<i class="fas fa-times-circle fa-xs"></i>',y.title="Retirer du planning",y.addEventListener("click",S=>{S.stopPropagation(),Xe(r,u)}),E.appendChild(y),i.appendChild(E),i.addEventListener("mouseenter",()=>{M.classList.remove("hidden"),y.classList.remove("hidden")}),i.addEventListener("mouseleave",()=>{M.classList.add("hidden"),y.classList.add("hidden")})}const b=document.createElement("div");b.className="absolute bottom-1 right-1";const g=document.createElement("button");return g.className="info-meal-btn bg-gray-500 text-white hover:bg-gray-600 rounded w-3 h-3 flex items-center justify-center shadow-sm",g.innerHTML='<i class="fas fa-plus fa-xs"></i>',g.title="Plus d'infos",g.dataset.slotId=r,g.dataset.mealIndex=u,b.appendChild(g),i.appendChild(b),i}function te(s,r){const u=s.classList.contains("info-open");if(document.querySelectorAll(".planner-ingredient-tooltip").forEach(d=>d.remove()),document.querySelectorAll(".info-meal-btn").forEach(d=>{d.classList.remove("info-open"),d.innerHTML='<i class="fas fa-plus fa-xs"></i>'}),!u){s.innerHTML='<i class="fas fa-times fa-xs"></i>',s.classList.add("info-open");const d=document.createElement("div");if(d.className="planner-ingredient-tooltip z-50 w-64 p-3 bg-white border border-gray-200 rounded-lg shadow-lg text-left text-sm",r.ingredients&&r.ingredients.length>0){if(r.servings&&r.servings>0){const y=document.createElement("p");y.className="mb-2 text-sm text-gray-600 flex items-center",y.innerHTML=`<i class="fas fa-users mr-2"></i> Pour ${r.servings} ${r.servings>1?"personnes":"personne"}`,d.appendChild(y)}const E=document.createElement("h4");E.className="font-bold mb-2 text-gray-800",E.textContent="Ingrédients :",d.appendChild(E);const M=document.createElement("ul");M.className="space-y-1 text-gray-600",r.ingredients.forEach(y=>{const S=document.createElement("li");S.textContent=`• ${y.quantity||""} ${y.unit||""} ${y.name}`.trim(),M.appendChild(S)}),d.appendChild(M)}else d.textContent="Aucun ingrédient spécifié pour cette recette.";document.body.appendChild(d);const i=s.closest(".meal-card").getBoundingClientRect(),f=d.getBoundingClientRect();let b=i.right+10;b+f.width>window.innerWidth&&(b=i.left-f.width-10);let g=i.top;g+f.height>window.innerHeight&&(g=i.bottom-f.height),g<10&&(g=10),d.style.position="fixed",d.style.left=`${b}px`,d.style.top=`${g}px`}}function Re(s,r=!1){const u=document.createElement("div"),d=document.createElement("button");return r?(u.className="w-full flex justify-center pt-1",d.className="add-more-meal-btn text-gray-400 hover:text-green-500 transition-colors duration-150",d.innerHTML='<i class="fas fa-plus-circle"></i>',d.title="Ajouter une autre recette"):(u.className="flex items-center justify-center h-full",d.className="add-meal-btn text-green-500 hover:text-green-700 transition-transform duration-150 hover:scale-125",d.innerHTML='<i class="fas fa-plus-circle text-lg"></i>'),d.addEventListener("click",()=>X(s)),u.appendChild(d),u}function We(s,r,u=!1){if(u){const i=document.createElement("p");return i.className="w-full h-full p-1 text-xs text-gray-700",i.textContent=r[s]||"",i}const d=document.createElement("textarea");return d.className="w-full h-full p-1 text-xs bg-transparent border-0 rounded focus:outline-none focus:ring-1 focus:ring-tomato resize-none",d.placeholder="Remarque...",d.value=p[s]||"",d.dataset.slotId=s,d.addEventListener("change",i=>{const f=i.target.value;f?p[s]=f:delete p[s];const[b,g]=s.split("-"),y=`a modifié la remarque pour ${D[parseInt(b,10)]} ${g==="lunch"?"midi":"soir"}`;j({[`weeks.${a}.remarksData`]:p},y)}),d.addEventListener("focus",i=>{ft({type:"editing_remark",fieldId:s})}),d.addEventListener("blur",i=>{ft("idle")}),d}function Ve(){document.querySelectorAll(".meal-card").forEach(s=>{s.addEventListener("dragstart",me),s.addEventListener("dragend",Ie)}),document.querySelectorAll(".meal-slot").forEach(s=>{s.addEventListener("dragover",A),s.addEventListener("dragleave",_),s.addEventListener("drop",N)})}async function Ge(s,r){const u=JSON.parse(JSON.stringify(l)),d=u[s],i={id:r.id};Array.isArray(d)?d.push(i):u[s]=[i];const[f,b]=s.split("-"),g=D[parseInt(f,10)],E=b==="lunch"?"midi":"soir",M=`a ajouté '${r.name}' à ${g} ${E}`;await j({[`weeks.${a}.menuData`]:u},M),ee()}async function Xe(s,r){if(!m||!l[s]||!Array.isArray(l[s]))return;const u=l[s][r],d=JSON.parse(JSON.stringify(l));d[s].splice(r,1),d[s].length===0&&delete d[s];const[i,f]=s.split("-"),b=D[parseInt(i,10)],g=f==="lunch"?"midi":"soir",E=`a supprimé '${u.name}' de ${b} ${g}`;await j({[`weeks.${a}.menuData`]:d},E)}async function At(){if(confirm("Voulez-vous vraiment vider le menu de cette semaine ?")){const s={id:availablePlans.length>0?availablePlans[0].id:`${ve()}_semaine-${a}`,name:availablePlans.length>0?availablePlans[0].name:"Mon plan",menuData:{},servingsData:{},remarksData:{},defaultNumPeople:L,startDay:o,lastUpdated:new Date};loadPlan(s),availablePlans.length>0?availablePlans[0]=s:availablePlans.push(s),await j({[`weeks.${a}`]:{menuData:{},servingsData:{},remarksData:{}}},`a vidé le menu de la semaine ${a}`)}}function Rt(s){s>=1&&s<=52&&(a=s,O())}function yn(){e.currentWeekDisplay&&(e.currentWeekDisplay.textContent=`Semaine ${a}`)}function xn(){e.prevWeekBtn?.addEventListener("click",()=>Rt(a-1)),e.nextWeekBtn?.addEventListener("click",()=>Rt(a+1)),e.clearMenuBtn?.addEventListener("click",At),e.startDaySelect?.addEventListener("change",async s=>{o=s.target.value,m&&await j({startDay:o},`a changé le premier jour de la semaine à '${o}'`)}),e.planSelect?.addEventListener("change",qt),e.closeMealSelectModalBtn?.addEventListener("click",ee),e.mealSelectModal?.addEventListener("click",s=>{s.target===e.mealSelectModal&&ee()}),e.closeRecipeModalBtn?.addEventListener("click",()=>Ue.closeForm()),e.cancelRecipeBtn?.addEventListener("click",()=>Ue.closeForm()),e.importListBtn?.addEventListener("click",ye),e.closeImportListModalBtn?.addEventListener("click",_e),e.importListModal?.addEventListener("click",s=>{s.target===e.importListModal&&_e()}),e.exportTxtBtn?.addEventListener("click",U),e.exportPdfBtn?.addEventListener("click",k),e.exportPlanPdfBtn?.addEventListener("click",Q),e.mealPlanGrid?.addEventListener("click",s=>{const r=s.target.closest(".info-meal-btn");if(r){const u=r.dataset.slotId,d=parseInt(r.dataset.mealIndex,10);if(u&&!isNaN(d)){const i=l[u]?.[d];i&&te(r,i)}}}),e.sharePlanBtn?.addEventListener("click",()=>{if(!m){alert("Veuillez sélectionner un plan à partager.");return}jt({plan:m})}),e.inviteParticipantBtn?.addEventListener("click",()=>{if(!m){alert("Veuillez sélectionner un plan pour inviter des participants.");return}tn(m)}),e.historyPlanBtn?.addEventListener("click",Ee),e.closePlanHistoryModalBtn?.addEventListener("click",P),e.planHistoryModal?.addEventListener("click",s=>{s.target===e.planHistoryModal&&P()}),e.savePlanBtn?.addEventListener("click",async()=>{if(!m){alert("Veuillez sélectionner un plan de travail avant de sauvegarder.");return}const s=document.getElementById("save-plan-as-modal"),r=document.getElementById("save-plan-as-form"),u=document.getElementById("save-plan-name"),d=document.getElementById("cancel-save-plan-as-btn"),i=document.getElementById("close-save-plan-as-modal"),f=new Date().toLocaleDateString("fr-FR"),b=m.weeks?Object.keys(m.weeks).filter(y=>m.weeks[y]&&Object.keys(m.weeks[y].menuData||{}).length>0).length:0,g=b>1?`${b} semaines`:`${b} semaine`;u.value=`${m.name} (${g}) - ${f}`,s.classList.remove("hidden");const E=async y=>{y.preventDefault();const S=u.value;if(!S)return;m.weeks||(m.weeks={}),m.weeks[a]={menuData:l,servingsData:c,remarksData:p},m.startDay=o,m.defaultNumPeople=L;const T=JSON.parse(JSON.stringify(m));if(T.weeks)for(const H in T.weeks){const Z=T.weeks[H];if(Z&&Z.menuData)for(const ne in Z.menuData){const ge=Z.menuData[ne];Array.isArray(ge)&&(Z.menuData[ne]=ge.map(re=>re&&re.id&&w.find(ae=>ae.id===re.id)||re))}}await dn(S,T),s.classList.add("hidden"),r.removeEventListener("submit",E)},M=()=>{s.classList.add("hidden"),r.removeEventListener("submit",E)};r.addEventListener("submit",E,{once:!0}),d.addEventListener("click",M,{once:!0}),i.addEventListener("click",M,{once:!0})})}function En(s=""){return s.split(" ").map(d=>d[0]).join("").substring(0,2).toUpperCase()}function xt(s=[],r={}){const u=document.getElementById("collaborators-bar"),d=document.getElementById("activity-labels-container"),i=document.getElementById("name-tooltip");if(!u||!i||!d)return;if(u.innerHTML="",d.innerHTML="",document.querySelectorAll(".remark-lock-overlay").forEach(g=>g.remove()),document.querySelectorAll("textarea[data-slot-id]").forEach(g=>{g.disabled=!1}),s.length<=1&&Object.keys(r).length<=1){u.classList.add("hidden");return}let f="";const b=ve();s.forEach(g=>{if(!g)return;const E=r.hasOwnProperty(g.uid),M=r[g.uid]||{},y=document.createElement("div");y.className="w-8 h-8 rounded-full flex items-center justify-center bg-gray-300 text-white font-bold text-xs ring-2 ring-white cursor-pointer transition-all duration-300";const S=E?"(présent)":"(absent)";if(y.dataset.name=`${g.displayName||"Inconnu"} ${S}`,g.photoURL?y.innerHTML=`<img src="${g.photoURL}" alt="${g.displayName}" class="w-full h-full rounded-full object-cover">`:y.textContent=En(g.displayName),E||y.classList.add("grayscale","opacity-50"),y.addEventListener("mouseenter",T=>{i.textContent=T.currentTarget.dataset.name,i.classList.remove("hidden");const H=T.currentTarget.getBoundingClientRect();i.style.left=`${H.left+H.width/2-i.offsetWidth/2}px`,i.style.top=`${H.top-i.offsetHeight-5}px`}),y.addEventListener("mouseleave",()=>{i.classList.add("hidden")}),u.appendChild(y),E&&g.uid!==b){const T=M.status;if(typeof T=="object"&&T.type==="editing_remark"){const H=document.querySelector(`textarea[data-slot-id="${T.fieldId}"]`);if(H){H.disabled=!0;const Z=document.createElement("div");Z.className="remark-lock-overlay absolute inset-0 bg-gray-400 bg-opacity-25 flex items-center justify-center text-xs text-white font-bold",Z.innerHTML=`<i class="fas fa-lock mr-1"></i> ${g.displayName} écrit...`,H.parentElement&&(H.parentElement.classList.add("relative"),H.parentElement.appendChild(Z))}}else if(typeof T=="string"&&T!=="idle"){let H="";switch(T){case"editing_recipe":H="modifie une recette...";break}H&&(f+=`<span class="italic mr-4">${g.displayName} ${H}</span>`)}}}),d.innerHTML=f,u.classList.remove("hidden")}function qt(){vn();const s=e.planSelect.value;m=C.find(b=>b.id===s)||null;const r=document.getElementById("delete-plan-btn"),u=document.getElementById("rename-plan-btn"),d=document.getElementById("leave-plan-btn"),i=document.getElementById("invite-participant-btn"),f=document.getElementById("history-plan-btn");if(r&&(r.style.display=m&&m.isOwner?"inline-flex":"none"),u&&(u.style.display=m&&m.isOwner?"inline-flex":"none"),f&&(f.style.display=m&&m.isOwner?"inline-flex":"none"),d&&(d.style.display=m&&!m.isOwner?"inline-flex":"none"),i){const b=m&&(m.type==="collaborative"||m.collaborators&&m.collaborators.length>0);i.style.display=m&&m.isOwner&&b?"inline-flex":"none"}m&&m.participants&&m.participants.length>1?(xt(m.participants,{}),hn(m.id,b=>{xt(m.participants,b)})):xt([],{}),m&&(m.manualItems=m.manualItems||[]),O()}async function wn(s,r){if(!m)return;const u=JSON.parse(JSON.stringify(c));r===L?delete u[s]:u[s]=r;const[d,i]=s.split("-"),g=`a changé le nombre de personnes pour ${D[parseInt(d,10)]} ${i==="lunch"?"midi":"soir"} à ${r}`;await j({[`weeks.${a}.servingsData`]:u},g)}async function Ln(){if(!h)return;const s=on();xn(),ze(),await Ce();const r=qe(F(h,"recipes"),d=>{if(console.log("Recipe data updated from listener."),w=d.docs.map(i=>({id:i.id,...i.data()})),m){for(const i in l){const f=l[i];if(Array.isArray(f)){const b=f.map(g=>{if(g&&g.id){const E=w.find(M=>M.id===g.id);return E?{...E}:g}return g});l[i]=b}}ue(e.mealPlanGrid,{menuData:l,servingsData:c,remarksData:p,defaultNumPeople:L,startDay:o},!1),ie()}}),u=sn(d=>{C=d,rn(d);const i=localStorage.getItem("selectedPlanId");i&&d.some(f=>f.id===i)&&(e.planSelect.value=i,localStorage.removeItem("selectedPlanId")),qt()});return()=>{u(),r(),s()}}const Cn=Ln();return async()=>{const s=await Cn;typeof s=="function"&&s()}}const xa=Object.freeze(Object.defineProperty({__proto__:null,default:ya},Symbol.toStringTag,{value:"Module"}));function Ea(){const e=bn();return _t(),()=>{typeof e=="function"&&e()}}async function _t(){const e=document.getElementById("received-shares-container"),t=ve();if(!(!t||!e)){e.innerHTML='<p class="text-gray-500">Chargement des partages reçus...</p>';try{const n=ce(F(h,"plans"),K("userId","==",t),K("isShared","==",!0)),a=ce(F(h,"plans"),K("collaborators","array-contains",t)),[o,l]=await Promise.all([fe(n),fe(a)]);let c=[];if(o.forEach(p=>c.push({id:p.id,type:"Planification (Copie)",...p.data()})),l.forEach(p=>c.push({id:p.id,type:"Planification (Collaboratif)",...p.data()})),c.length===0){e.innerHTML=`<p class="text-gray-500">Vous n'avez aucun contenu partagé par d'autres utilisateurs.</p>`;return}c.sort((p,v)=>(v.sharedAt?.seconds||v.lastUpdated?.seconds||0)-(p.sharedAt?.seconds||p.lastUpdated?.seconds||0)),e.innerHTML="";for(const p of c){const v=p.originalOwnerId||p.userId;if(!v)continue;const x=await xe($(h,"users",v)),w=x.exists()?x.data().displayName:"Utilisateur inconnu";e.appendChild(wa(p,w))}}catch(n){console.error("Erreur lors du chargement des partages reçus : ",n),e.innerHTML='<p class="text-red-500">Une erreur est survenue.</p>'}}}function wa(e,t){const n=document.createElement("div");n.className="bg-white rounded-lg p-4 flex justify-between items-center shadow-sm";const a=document.createElement("div"),o=document.createElement("p");o.className="font-bold text-gray-800";let l="";e.type.includes("Collaboratif")?l=' <span class="text-xs font-medium bg-blue-100 text-blue-800 px-2 py-1 rounded-full">Collab</span>':e.type.includes("Copie")&&(l=' <span class="text-xs font-medium bg-gray-200 text-gray-800 px-2 py-1 rounded-full">Copie</span>'),o.innerHTML=`${e.name}${l}`;const c=document.createElement("p");c.className="text-sm text-gray-500 mt-1";const p=e.sharedAt?new Date(e.sharedAt.seconds*1e3).toLocaleDateString("fr-FR"):e.lastUpdated?new Date(e.lastUpdated.seconds*1e3).toLocaleDateString("fr-FR"):"date inconnue";c.textContent=`Partagé par ${t} le ${p}`,a.appendChild(o),a.appendChild(c),n.appendChild(a);const v=document.createElement("button");return v.className="btn btn-ghost text-red-500 btn-sm",v.innerHTML='<i class="fas fa-trash"></i>',v.title="Supprimer ce contenu partagé",v.addEventListener("click",()=>La(e.id,e.type)),n.appendChild(v),n}async function La(e,t){if(confirm(`Voulez-vous vraiment supprimer cette ${t.toLowerCase()} partagée ?`))try{const n=t.startsWith("Planification")?"plans":"shopping_lists",a=$(h,n,e),o=await xe(a);o.exists()&&o.data().userId===ve()?(await je(a),_t()):(alert("Vous n'avez pas la permission de supprimer cet élément ou il a déjà été supprimé."),_t())}catch(n){console.error("Erreur de suppression: ",n),alert("Une erreur est survenue.")}}async function bn(){const e=document.getElementById("sent-shares-container"),t=ve();if(!t||!e)return()=>{};e.innerHTML='<p class="text-gray-500">Chargement des partages envoyés...</p>';const n=F(h,"shares"),a=ce(n,K("senderId","==",t));return qe(a,async o=>{if(o.empty){e.innerHTML=`<p class="text-gray-500">Vous n'avez envoyé aucun partage.</p>`;return}const l=o.docs.sort((c,p)=>(p.data().createdAt?.seconds||0)-(c.data().createdAt?.seconds||0));e.innerHTML="";for(const c of l){const p=c.data();try{const v=await xe($(h,"users",p.receiverId));if(v.exists()){const x=v.data();e.appendChild(Ca(p,x.displayName,c.id))}}catch(v){console.error("Could not load receiver for sent share",v)}}},o=>{console.error("Erreur lors du chargement des partages envoyés : ",o),e&&(e.innerHTML='<p class="text-red-500">Une erreur est survenue.</p>')})}function Ca(e,t,n){const a=document.createElement("div");a.className="bg-white rounded-lg p-4 flex justify-between items-center shadow-sm";const o=document.createElement("div"),l=document.createElement("p");l.className="font-bold text-gray-800";let c=[];e.plan&&c.push("Planification"),e.shoppingList&&c.push("Liste de courses"),l.textContent=c.join(" et ");const p=document.createElement("p");p.className="text-sm text-gray-500";const v=new Date(e.createdAt.seconds*1e3).toLocaleDateString("fr-FR");p.textContent=`Envoyé à ${t} le ${v}`,o.appendChild(l),o.appendChild(p),a.appendChild(o);const x=document.createElement("div");x.className="flex items-center space-x-4";const w=document.createElement("span");w.textContent=e.status;let I="bg-gray-200 text-gray-800";switch(e.status){case"accepted":I="bg-green-100 text-green-800";break;case"declined":I="bg-red-100 text-red-800";break;case"pending":I="bg-yellow-100 text-yellow-800";break}w.className=`text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full ${I}`,x.appendChild(w);const L=document.createElement("button");return L.className="btn btn-ghost text-red-500 btn-sm",L.innerHTML='<i class="fas fa-trash"></i>',L.title="Annuler le partage",L.addEventListener("click",()=>Ia(n)),x.appendChild(L),a.appendChild(x),a}async function Ia(e){if(confirm("Voulez-vous vraiment annuler ce partage ? L'autre utilisateur ne le verra plus."))try{await je($(h,"shares",e)),bn()}catch(t){console.error("Erreur lors de la suppression du partage: ",t),alert("Une erreur est survenue.")}}const Ba=Object.freeze(Object.defineProperty({__proto__:null,default:Ea},Symbol.toStringTag,{value:"Module"}));function Sa(){const e=localStorage.getItem("selectedPlanId"),t=document.getElementById("plan-view-name"),n=document.getElementById("meal-plan-grid"),a=document.getElementById("close-view-plan-btn");if(a&&a.addEventListener("click",()=>{localStorage.removeItem("selectedPlanId"),et("plans")}),!e)return t&&(t.textContent="Aucune sauvegarde sélectionnée"),n&&(n.innerHTML=`<p class="text-center text-red-500">Erreur : Aucun ID de sauvegarde trouvé. Veuillez retourner à la page 'Mes Plans Sauvegardés' et en sélectionner une.</p>`),()=>{};async function o(){try{const l=$(h,"plan_saves",e),c=await xe(l);if(!c.exists())throw new Error("Sauvegarde non trouvée");const p=c.data(),v=p.planData;if(!v)throw new Error("Les données du plan sauvegardé sont corrompues ou manquantes.");t&&(t.textContent=`Vue de : ${p.name}`),ka(n,v)}catch(l){console.error("Error fetching save:",l),t&&(t.textContent="Erreur"),n&&(n.innerHTML=`<p class="text-center text-red-500">${l.message}</p>`)}}return o(),()=>{localStorage.removeItem("selectedPlanId")}}function ka(e,t){if(!e)return;e.innerHTML="";const n=Object.keys(t.weeks||{}).sort((a,o)=>parseInt(a)-parseInt(o));if(n.length===0){e.innerHTML='<p class="text-center text-gray-500 p-10 col-span-full">Ce plan est vide.</p>';return}n.forEach(a=>{const o=t.weeks[a],l=document.createElement("h3");l.className="text-lg font-bold text-gray-700 mt-6 mb-2 col-span-full",l.textContent=`Semaine ${a}`,e.appendChild(l);const c=document.createElement("div");Ma(c,o,t.startDay,t.defaultNumPeople),e.appendChild(c)})}function Ma(e,t,n,a){const o=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"],l=o.indexOf(n||"Lundi"),c=[...o.slice(l),...o.slice(0,l)],p=t.menuData||{},v=t.servingsData||{},x=t.remarksData||{};c.forEach(w=>{const I=o.indexOf(w),L=document.createElement("div");L.className="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] items-stretch border-b border-gray-300";const C=document.createElement("div");C.className="font-bold p-2 flex items-center justify-center bg-gray-100 text-sm border-r border-gray-300",C.textContent=w.toUpperCase(),L.appendChild(C),["lunch","dinner"].forEach(m=>{const D=`${I}-${m}`,J=v[D]||a||1,Y=document.createElement("div");Y.className="border-r border-gray-300 flex items-center justify-center",Y.innerHTML=`<div class="text-center"><i class="fas fa-users fa-xs mb-1"></i><br>${J}</div>`,L.appendChild(Y);for(let Ce=0;Ce<5;Ce++){const O=`${I}-${m}-${Ce}`,j=document.createElement("div");if(j.className="meal-slot p-1 min-h-[50px] border-r border-gray-300",Ce===4)j.textContent=x[O]||"",j.classList.add("text-xs","italic","text-gray-600");else{const P=p[O];Array.isArray(P)&&P.length>0&&P.forEach(V=>{const W=document.createElement("div");W.className="p-1 bg-white rounded shadow-sm text-center text-xs font-medium",W.textContent=V.name,j.appendChild(W)})}L.appendChild(j)}}),e.appendChild(L)})}const Na=Object.freeze(Object.defineProperty({__proto__:null,default:Sa},Symbol.toStringTag,{value:"Module"})),Jt=document.querySelector("main"),Ta={menu:{html:`
        <div class="flex flex-col md:flex-row md:space-x-2">

            <!-- Left Column: Meal Planner -->
            <div class="w-full md:w-5/6">
                <section id="meal-planning-section" aria-labelledby="meal-planning-heading" class="mb-8 md:mb-12">
                                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                                        <h2 id="meal-planning-heading" class="text-xl md:text-2xl font-bold text-gray-800">Planification des repas</h2>
                                        <div class="mt-3 md:mt-0 flex items-center space-x-2 md:space-x-3 plan-actions">
                                            <button id="generate-plan-ai-btn" class="btn btn-primary btn-sm">
                                                <i class="fas fa-robot mr-1 md:mr-2"></i> IA Semaine
                                            </button>
                                            <button id="clear-menu-btn" class="btn btn-outline btn-sm text-red-800 hover:bg-red-100">
                                                <i class="fas fa-trash-alt mr-1 md:mr-2"></i> Vider le menu
                                            </button>
                                            <button id="export-plan-pdf-btn" class="btn btn-outline btn-sm">
                                                <i class="fas fa-file-pdf mr-1 md:mr-2"></i> Exporter Plan (PDF)
                                            </button>
                                            <button id="share-plan-btn" class="btn btn-secondary btn-sm">
                                                <i class="fas fa-share-alt mr-1 md:mr-2"></i> Partager
                                            </button>
                                            <button id="save-plan-btn" class="btn btn-secondary btn-sm">
                                                <i class="fas fa-save mr-1 md:mr-2"></i> Sauvegarder Plan
                                            </button>
                                        </div>
                                    </div>
                            
                                    <!-- Week Navigation & Plan Selector -->
                                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 space-y-3 md:space-y-0">
                                        <!-- Week Navigation -->
                                        <div class="flex justify-between items-center bg-white p-2 md:p-3 rounded-lg shadow-sm">
                                            <button id="prev-week-btn" class="btn btn-ghost btn-sm" aria-label="Semaine précédente">
                                                <i class="fas fa-chevron-left mr-1 md:mr-2"></i> Préc.
                                            </button>
                                            <div id="current-week-display" class="text-gray-700 font-medium text-sm md:text-base text-center mx-4">Semaine X</div>
                                            <button id="next-week-btn" class="btn btn-ghost btn-sm" aria-label="Semaine suivante">
                                                Suiv. <i class="fas fa-chevron-right ml-1 md:ml-2"></i>
                                            </button>
                                        </div>
                                        <!-- Plan Selector -->
                                        <div class="flex flex-wrap items-center justify-center gap-2 bg-white p-3 rounded-lg shadow-sm">
                                            <label for="plan-select" class="text-sm font-medium text-gray-700">Plan affiché:</label>
                                            <select id="plan-select" class="rounded-md border-gray-300 shadow-sm focus:border-tomato focus:ring focus:ring-tomato focus:ring-opacity-50 text-sm py-1">
                                                <!-- Options will be generated by JS -->
                                            </select>
                                            <button id="create-plan-btn" class="btn btn-primary btn-sm" title="Créer un nouveau plan">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                            <button id="rename-plan-btn" class="btn btn-ghost text-blue-500 hover:bg-blue-100 btn-sm" title="Renommer le plan sélectionné">
                                                <i class="fas fa-pencil-alt"></i>
                                            </button>
                                            <button id="history-plan-btn" class="btn btn-ghost text-purple-500 hover:bg-purple-100 btn-sm" title="Historique des modifications">
                                                <i class="fas fa-history"></i>
                                            </button>
                                            <button id="leave-plan-btn" class="btn btn-ghost text-yellow-600 hover:bg-yellow-100 btn-sm" title="Quitter le plan collaboratif">
                                                <i class="fas fa-door-open"></i>
                                            </button>
                                            <button id="delete-plan-btn" class="btn btn-ghost text-red-500 hover:bg-red-100 btn-sm" title="Supprimer le plan sélectionné">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            <button id="invite-participant-btn" class="btn btn-ghost text-green-500 hover:bg-green-100 btn-sm hidden" title="Inviter un participant">
                                                <i class="fas fa-user-plus"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Collaborators Bar -->
                                    <div id="collaborators-bar" class="flex items-center space-x-2 mb-4 hidden">
                                        <!-- Avatars will be injected here -->
                                    </div>

                                    <!-- Activity Labels -->
                                    <div id="activity-labels-container" class="text-sm text-gray-600 mb-4 h-6">
                                        <!-- e.g., 'Sophie is adding a recipe...' -->
                                    </div>
                            
                                            <!-- Settings Section -->
                                            <div class="inline-flex items-center space-x-6 bg-white p-3 rounded-lg shadow-sm mb-4">                                        <div>
                                            <label for="start-day-select" class="text-sm font-medium text-gray-700">Début de semaine:</label>
                                            <select id="start-day-select" class="rounded-md border-gray-300 shadow-sm focus:border-tomato focus:ring-tomato text-sm py-1">
                                                <option>Lundi</option>
                                                <option>Mardi</option>
                                                <option>Mercredi</option>
                                                <option>Jeudi</option>
                                                <option>Vendredi</option>
                                                <option>Samedi</option>
                                                <option>Dimanche</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="default-servings-input" class="text-sm font-medium text-gray-700">Personnes par défaut:</label>
                                            <div id="default-servings-control" class="mt-1"></div>
                                        </div>
                                    </div>                    <!-- Responsive Meal Plan Grid -->
<div class="bg-white rounded-xl shadow-md p-4">
                        <!-- Desktop Grid (Visible on large screens) -->
                        <div id="desktop-plan-container" class="hidden lg:block">
                            <div id="meal-plan-grid-layout">
                                <!-- Header -->
                                <div class="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] gap-1 text-center mb-1">
                                    <div class="p-2"></div> <!-- Empty corner -->
                                    <div class="p-2 rounded-t-lg bg-amber-100 text-amber-800 font-bold col-span-6">MIDI</div>
                                    <div class="p-2 rounded-t-lg bg-stone-200 text-stone-800 font-bold col-span-6">SOIR</div>
                                    
                                    <div class="p-1"></div> <!-- Empty under day name -->
                                    <div class="p-1 text-xs font-semibold"><i class="fas fa-users"></i></div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Entrée</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Plat</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Accomp.</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Dessert</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Remarque</div>

                                    <div class="p-1 text-xs font-semibold"><i class="fas fa-users"></i></div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Entrée</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Plat</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Accomp.</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Dessert</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Remarque</div>
                                </div>
                                <!-- Rows generated by JS -->
                                <div id="meal-plan-grid" class="space-y-1">
                                    <div class="p-10 text-center text-gray-500 italic col-span-full">Chargement du planning...</div>
                                </div>
                            </div>
                        </div>

                        <!-- Mobile Accordion (Visible on small screens) -->
                        <div id="mobile-meal-plan" class="lg:hidden space-y-2">
                            <!-- Mobile content will be generated by JS here -->
                             <div class="p-10 text-center text-gray-500 italic col-span-full">Chargement du planning...</div>
                        </div>
                    </div>
                                    </section>


                                </div>
                    
                                <!-- Right Column: Shopping List -->
                                <div class="w-full md:w-1/6">
                                    <section id="shopping-list-section" aria-labelledby="shopping-list-heading" class="mb-8 md:mb-12 md:sticky md:top-24">
                                        <div class="bg-white rounded-xl shadow-md p-4 md:p-6">
                                            <h2 id="shopping-list-heading" class="text-xl md:text-2xl font-bold text-gray-800 mb-4">Liste de courses</h2>
                                            <div class="flex justify-end space-x-2 mb-4">
                                                <button id="import-list-btn" class="btn btn-secondary btn-sm">
                                                    <i class="fas fa-download mr-2"></i>Importer une liste
                                                </button>
                                                <div id="export-buttons-container" class="flex space-x-2">
                                                    <button id="export-txt-btn" class="btn btn-outline btn-sm">
                                                        <i class="fas fa-file-alt mr-2"></i>TXT
                                                    </button>
                                                    <button id="export-pdf-btn" class="btn btn-outline btn-sm">
                                                        <i class="fas fa-file-pdf mr-2"></i>PDF
                                                    </button>
                                                </div>
                                            </div>
                    
                                            <!-- Shopping List Container -->
                                            <div id="shopping-list-container" class="mb-4 max-h-[70vh] overflow-y-auto pr-2">                            <ul id="shopping-list" class="space-y-2 text-sm">
                                <!-- Les articles de la liste de courses seront générés ici -->
                            </ul>
                        </div>

                        <!-- Add Item Input -->
                        <div class="mt-4 flex items-stretch">
                            <div class="relative flex-grow">
                                <input type="text" id="add-item-input" placeholder="Chercher ou ajouter..." class="w-full border border-gray-300 rounded-l-lg px-2 py-1 text-xs focus:outline-none focus:ring-2 focus:ring-tomato focus:border-transparent">
                                <div id="add-item-results" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto bottom-full mb-2"></div>
                            </div>
                            <button id="add-item-btn" class="btn btn-primary rounded-l-none -ml-px btn-xs" aria-label="Ajouter l'article">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>

                         <!-- AI Shopping Tips Placeholder -->
                        <div id="ai-shopping-tip" class="mt-6 bg-avocado bg-opacity-10 rounded-lg p-3 hidden">
                            <div class="flex items-start">
                                 <div class="w-8 h-8 bg-avocado bg-opacity-20 rounded-full flex items-center justify-center mr-3 shrink-0">
                                    <i class="fas fa-lightbulb text-avocado"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-avocado mb-1 text-sm">Astuce Économique</h4>
                                    <p id="ai-shopping-tip-text" class="text-sm text-gray-700">...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <!-- Shared Plans Modal -->
        <div id="shared-plans-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-6xl max-h-[90vh] overflow-y-auto relative">
                <button id="close-shared-plans-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" aria-label="Fermer">
                    <i class="fas fa-times text-xl"></i>
                </button>
                <h3 id="shared-plans-modal-title" class="text-2xl font-bold mb-6">Plans partagés pour la Semaine X</h3>
                <div id="shared-plans-modal-container" class="space-y-6">
                    <!-- Shared plans will be loaded here -->
                </div>
            </div>
        </div>
        `,script:"./script.js"},recipes:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Recettes</h2>
            <button id="add-recipe-btn" class="btn btn-primary">
                <i class="fas fa-plus mr-2"></i> Ajouter une recette
            </button>
        </div>

        <!-- Search Bar -->
        <div class="mb-6">
            <input type="text" id="search-bar" placeholder="Rechercher une recette..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-tomato focus:border-tomato">
        </div>

        <!-- Tabs Navigation -->
        <div id="category-tabs" class="mb-6 border-b border-gray-200 flex space-x-4 flex-nowrap overflow-x-auto pb-2">
            <!-- Tabs will be generated by recipes.js here -->
        </div>

        <!-- Recipe List Container -->
        <div id="recipe-list-container">
            <!-- Recipes for the selected tab will be loaded here -->
        </div>

        <!-- Reconstructed Recipe Form Modal -->
        <div id="recipe-form-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-3xl max-h-[90vh] overflow-y-auto relative">
                <button id="close-recipe-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" aria-label="Fermer">
                    <i class="fas fa-times text-xl"></i>
                </button>
                <h3 id="recipe-modal-title" class="text-2xl font-bold mb-6">Ajouter/Modifier une recette</h3>
                <form id="recipe-form" class="space-y-4">
                    <input type="hidden" id="recipe-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label for="recipe-name" class="block text-sm font-medium text-gray-700">Nom de la recette</label>
                            <input type="text" id="recipe-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                        </div>
                        <div>
                            <label for="recipe-category" class="block text-sm font-medium text-gray-700">Catégorie</label>
                            <select id="recipe-category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                                <option>ENTREE</option>
                                <option>PLAT</option>
                                <option>ACCOMPAGNEMENT</option>
                                <option>DESSERT</option>
                            </select>
                        </div>
                        <div>
                            <label for="recipe-servings" class="block text-sm font-medium text-gray-700">Nombre de personnes</label>
                            <input type="number" id="recipe-servings" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" min="1">
                        </div>
                        <div>
                            <label for="recipe-prep-time" class="block text-sm font-medium text-gray-700">Temps de préparation (min)</label>
                            <input type="number" id="recipe-prep-time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" min="0">
                        </div>
                         <div>
                            <label for="recipe-difficulty" class="block text-sm font-medium text-gray-700">Difficulté</label>
                            <select id="recipe-difficulty" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                <option>Très facile</option>
                                <option>Facile</option>
                                <option>Moyen</option>
                                <option>Difficile</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-lg font-medium text-gray-800 mb-2">Ingrédients</h4>
                        <div id="ingredients-list" class="space-y-2"></div>
                        <button type="button" id="add-ingredient-btn" class="btn btn-outline btn-sm mt-2">
                            <i class="fas fa-plus mr-2"></i> Ajouter un ingrédient
                        </button>
                    </div>
                    <div>
                        <label for="recipe-steps" class="block text-lg font-medium text-gray-800">Préparation</label>
                        <textarea id="recipe-steps" rows="8" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                    </div>
                    <div class="flex justify-end space-x-4 pt-4">
                        <button type="button" id="cancel-recipe-btn" class="btn btn-ghost">Annuler</button>
                        <button type="submit" id="save-recipe-btn" class="btn btn-primary">Sauvegarder</button>
                    </div>
                </form>
            </div>
        </div>
        `,script:"./recipes.js"},ingredients:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Ingrédients</h2>
            <div class="flex space-x-2">
                <button id="manage-categories-btn" class="btn btn-outline">
                    <i class="fas fa-tags mr-2"></i> Gérer les catégories
                </button>
                <button id="add-ingredient-btn" class="btn btn-primary">
                    <i class="fas fa-plus mr-2"></i> Ajouter un ingrédient
                </button>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="mb-6">
            <input type="text" id="search-bar" placeholder="Rechercher un ingrédient..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-tomato focus:border-tomato">
        </div>

        <!-- Tabs Navigation -->
        <div id="category-tabs" class="mb-6 border-b border-gray-200 flex space-x-4 flex-nowrap overflow-x-auto pb-2">
            <!-- Tabs will be generated by ingredients.js here -->
        </div>

        <!-- Ingredient List Container -->
        <div id="ingredients-list-container">
            <p class="text-center text-gray-500 p-10">Chargement des ingrédients...</p>
        </div>

        <!-- Ingredient Form Modal -->
        <div id="ingredient-form-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-md relative">
                <button id="close-ingredient-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
                <h3 id="ingredient-modal-title" class="text-lg font-bold mb-4">Ajouter un Ingrédient</h3>
                <form id="ingredient-form" class="space-y-4">
                    <input type="hidden" id="ingredient-id">
                    <div>
                        <label for="ingredient-name" class="block text-sm font-medium text-gray-700">Nom</label>
                        <input type="text" id="ingredient-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                    </div>
                    <div>
                        <label for="ingredient-unit" class="block text-sm font-medium text-gray-700">Unité par défaut</label>
                        <select id="ingredient-unit" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select>
                    </div>
                    <div>
                        <label for="ingredient-category" class="block text-sm font-medium text-gray-700">Catégorie</label>
                        <select id="ingredient-category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></select>
                    </div>
                    <div class="flex justify-end space-x-4 pt-2">
                        <button type="button" id="cancel-ingredient-btn" class="btn btn-ghost">Annuler</button>
                        <button type="submit" id="save-ingredient-btn" class="btn btn-primary">Sauvegarder</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Category Management Modal -->
        <div id="category-management-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-lg relative">
                <h3 class="text-lg font-bold mb-4">Gérer les catégories d'ingrédients</h3>
                <form id="add-category-form" class="flex items-center space-x-2 mb-4">
                    <input type="text" id="new-category-name" placeholder="Nom de la nouvelle catégorie" class="flex-grow mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                    <button type="submit" class="btn btn-secondary">Ajouter</button>
                </form>
                <div id="category-list" class="max-h-64 overflow-y-auto border rounded-lg p-2"></div>
                <div class="flex justify-end space-x-4 mt-4">
                     <button type="button" id="close-category-modal" class="btn btn-ghost">Annuler</button>
                    <button type="button" id="done-category-modal-btn" class="btn btn-primary">Terminé</button>
                </div>
            </div>
        </div>
        `,script:"./ingredients.js"},lists:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Listes de Courses</h2>
            <button id="add-list-btn" class="btn btn-primary">
                <i class="fas fa-plus mr-2"></i> Créer une liste
            </button>
        </div>

        <!-- Search Bar -->
        <div class="mb-6">
            <input type="text" id="search-bar" placeholder="Rechercher une liste..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-tomato focus:border-tomato">
        </div>

        <!-- Lists Container -->
        <div id="lists-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

        <div class="mt-12">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6">Listes Partagées</h2>
            <div id="shared-lists-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Les listes partagées seront chargées ici par JS -->
            </div>
        </div>

        <!-- List Form Modal -->
        <div id="list-form-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-start justify-center z-[100] hidden pt-20">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-3xl min-h-[75vh] max-h-[90vh] overflow-y-auto relative">
                <button id="close-list-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10"><i class="fas fa-times text-xl"></i></button>
                <h3 id="list-modal-title" class="text-lg font-bold mb-4">Créer une liste</h3>
                <form id="list-form" class="space-y-4 pb-20">
                    <input type="hidden" id="list-id">
                    <div>
                        <label for="list-name" class="block text-sm font-medium text-gray-700">Nom de la liste</label>
                        <input type="text" id="list-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                    </div>
                    <div>
                        <h4 class="text-md font-medium text-gray-800 mb-2">Ingrédients</h4>
                        <div id="ingredients-list" class="space-y-2"></div>
                        <button type="button" id="add-ingredient-btn" class="btn btn-outline btn-sm mt-2">
                            <i class="fas fa-plus mr-2"></i> Ajouter un ingrédient
                        </button>
                    </div>
                </form>
                <div class="absolute bottom-0 left-0 right-0 px-6 py-4 bg-white/95 backdrop-blur-sm border-t border-gray-200 flex justify-end space-x-4">
                    <button type="button" id="cancel-list-btn" class="btn btn-ghost">Annuler</button>
                    <button type="submit" form="list-form" id="save-list-btn" class="btn btn-primary">Sauvegarder la liste</button>
                </div>
            </div>
        </div>
        `,script:"./lists.js"},friends:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Amis</h2>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="md:col-span-2 space-y-8">
                <div>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Liste d'amis</h3>
                    <div id="friends-list-container" class="space-y-4">
                        <!-- La liste d'amis sera chargée ici -->
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Demandes envoyées en attente</h3>
                    <div id="pending-requests-container" class="space-y-4">
                        <!-- Les demandes envoyées en attente seront chargées ici -->
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Demandes rejetées</h3>
                    <div id="declined-requests-container" class="space-y-4">
                        <!-- Les demandes rejetées seront chargées ici -->
                    </div>
                </div>
            </div>
            <div>
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Rechercher un ami</h3>
                    <div class="mb-4">
                        <div class="flex items-center space-x-2">
                            <input type="text" id="search-friends-input" placeholder="Nom ou email..." class="flex-grow p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-tomato focus:border-tomato">
                            <button id="search-friends-btn" class="btn btn-primary"><i class="fas fa-search"></i></button>
                        </div>
                        <div id="search-results-container" class="mt-2 space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>
        `,script:"./friends.js"},shared:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Partages</h2>
        </div>

        <div class="space-y-12">
            <div>
                <h3 class="text-xl font-bold text-gray-700 border-b pb-2 mb-4">Partages Reçus</h3>
                <div id="received-shares-container" class="space-y-4">
                    <!-- L'historique des partages acceptés sera chargé ici -->
                </div>
            </div>
            <div>
                <h3 class="text-xl font-bold text-gray-700 border-b pb-2 mb-4">Mes Partages Envoyés</h3>
                <div id="sent-shares-container" class="space-y-4">
                    <!-- L'historique des partages envoyés sera chargé ici -->
                </div>
            </div>
        </div>
        `,script:"./shared.js"},plans:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Plans Sauvegardés</h2>
        </div>
        <div id="all-plans-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- La liste des plans sera chargée ici -->
            <p class="text-center text-gray-500 p-10 col-span-full">Chargement de vos plans...</p>
        </div>
        `,script:"./all-plans.js"},"view-plan":{html:`
        <section aria-labelledby="meal-planning-heading" class="mb-8 md:mb-12">
            <div class="flex justify-between items-center mb-4">
                <h2 id="plan-view-name" class="text-xl md:text-2xl font-bold text-gray-800">Chargement du plan...</h2>
                <button id="close-view-plan-btn" class="btn btn-outline">
                    <i class="fas fa-times mr-2"></i> Fermer et voir mes plans
                </button>
            </div>
            <div class="bg-white rounded-xl shadow-md p-4">
                <div id="meal-plan-grid-layout">
                    <!-- Header -->
                    <div class="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] gap-1 text-center mb-1">
                        <div class="p-2"></div> <!-- Empty corner -->
                        <div class="p-2 rounded-t-lg bg-amber-100 text-amber-800 font-bold col-span-6">MIDI</div>
                        <div class="p-2 rounded-t-lg bg-stone-200 text-stone-800 font-bold col-span-6">SOIR</div>
                        <div class="p-1"></div> <!-- Empty under day name -->
                        <div class="p-1 text-xs font-semibold"><i class="fas fa-users"></i></div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Entrée</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Plat</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Accomp.</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Dessert</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Remarque</div>
                        <div class="p-1 text-xs font-semibold"><i class="fas fa-users"></i></div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Entrée</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Plat</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Accomp.</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Dessert</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Remarque</div>
                    </div>
                    <!-- Rows generated by JS -->
                    <div id="meal-plan-grid" class="space-y-1">
                        <div class="p-10 text-center text-gray-500 italic col-span-full">Chargement de la planification...</div>
                    </div>
                </div>
            </div>
        </section>
        `,script:"./view-plan.js"}},Da=Object.assign({"./all-plans.js":Un,"./auth.js":An,"./firebase-config.js":jn,"./form-handler.js":On,"./friends.js":Gn,"./ingredients.js":Yn,"./lists.js":ta,"./main.js":Hn,"./notifications.js":ga,"./plans.js":oa,"./presence.js":ha,"./recipes.js":ba,"./script.js":xa,"./shared.js":Ba,"./sharing.js":Zn,"./view-plan.js":Na});let pt=null;async function et(e){typeof pt=="function"&&(pt(),pt=null);const t=Ta[e];if(t&&Jt){if(Jt.innerHTML=t.html,t.script){const n=Da[t.script];n?n.default&&typeof n.default=="function"&&(pt=n.default()):console.error(`Module not found for path: ${t.script}`)}}else console.error(`Route not found: ${e}`)}function Pa(){const e=Te();if(e){const n=document.getElementById("user-display-name");n&&(n.textContent=e.displayName||e.email)}const t=document.querySelectorAll(".nav-btn");t.forEach(n=>{n.addEventListener("click",a=>{const o=a.currentTarget.dataset.path;et(o),t.forEach(l=>{l.classList.remove("bg-tomato","text-white"),l.classList.add("bg-white","text-tomato")}),a.currentTarget.classList.add("bg-tomato","text-white"),a.currentTarget.classList.remove("bg-white","text-tomato")})}),et("menu"),gn()}document.addEventListener("DOMContentLoaded",()=>{Xt().then(C=>{C&&Pa()});const e=document.getElementById("profile-btn"),t=document.getElementById("profile-menu");e&&t&&(e.addEventListener("click",C=>{C.stopPropagation(),t.classList.toggle("hidden");const m=!t.classList.contains("hidden");e.setAttribute("aria-expanded",m)}),document.addEventListener("click",C=>{!(t.contains(C.target)||e.contains(C.target))&&!t.classList.contains("hidden")&&(t.classList.add("hidden"),e.setAttribute("aria-expanded","false"))}));const n=document.getElementById("settings-link"),a=document.getElementById("settings-modal"),o=document.getElementById("close-settings-modal"),l=document.getElementById("dark-mode-toggle"),c=C=>{C==="dark"?(document.documentElement.classList.add("dark"),l&&(l.checked=!0)):(document.documentElement.classList.remove("dark"),l&&(l.checked=!1))},p=localStorage.getItem("theme");p?c(p):window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?c("dark"):c("light"),n&&a&&n.addEventListener("click",C=>{C.preventDefault(),a.classList.remove("hidden")}),o&&a&&o.addEventListener("click",()=>{a.classList.add("hidden")}),a&&a.addEventListener("click",C=>{C.target===a&&a.classList.add("hidden")}),l&&l.addEventListener("change",()=>{const C=l.checked?"dark":"light";localStorage.setItem("theme",C),c(C)});const v=document.getElementById("mobile-menu-btn"),x=document.getElementById("mobile-menu"),w=document.querySelectorAll(".nav-btn-mobile"),I=document.getElementById("notifications-btn-mobile"),L=document.getElementById("notifications-dropdown");I&&L&&I.addEventListener("click",C=>{C.stopPropagation(),L.classList.toggle("hidden")}),v&&x&&v.addEventListener("click",()=>{x.classList.toggle("hidden")}),w.forEach(C=>{C.addEventListener("click",m=>{const D=m.currentTarget.dataset.path;et(D),x&&x.classList.add("hidden")})})});
