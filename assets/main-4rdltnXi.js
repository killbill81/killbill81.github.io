import{o as Sn,s as Vt,a as wt,q as me,w as Z,c as F,d as b,b as Fe,e as $,g as Le,f as ge,u as Te,h as Ae,i as Ne,j as ct,k as Kt,l as ht,m as Qt,n as Mn,p as Nn,r as Lt,t as Jt,v as Tn,x as Dn,y as Pn,z as _n,A as $n,B as Zt,C as Hn,D as jn,_ as Rn}from"./firebase-config-DRNfbNj5.js";const An=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"}));let vt=null;function en(){return new Promise(e=>{Sn(wt,t=>{if(vt=t,t){console.log("User is logged in:",t.uid);const n=document.getElementById("logout-btn"),a=document.getElementById("profile-btn");n&&n.classList.remove("hidden"),a&&a.classList.remove("hidden"),n&&!n.hasAttribute("data-listener-attached")&&(n.addEventListener("click",()=>{Vt(wt).catch(l=>{console.error("Sign Out Error",l)})}),n.setAttribute("data-listener-attached","true"));const o=document.getElementById("logout-btn-mobile");o&&!o.hasAttribute("data-listener-attached")&&(o.addEventListener("click",()=>{Vt(wt).catch(l=>{console.error("Sign Out Error",l)})}),o.setAttribute("data-listener-attached","true")),e(t)}else{console.log("User not logged in. Redirecting to login.html");const n=window.location.origin+"/login.html";window.location.href!==n&&(window.location.href=n),e(null)}})})}function ye(){return vt?vt.uid:null}function He(){return vt}const qn=Object.freeze(Object.defineProperty({__proto__:null,getCurrentUser:He,getCurrentUserId:ye,protectPage:en},Symbol.toStringTag,{value:"Module"}));async function Un(e){if(confirm("Voulez-vous charger cette sauvegarde ? Attention, cela écrasera la planification de la semaine correspondante dans votre plan de travail actuel."))try{const t=ye();if(!t)throw new Error("Utilisateur non trouvé");const n=$(b,"plan_saves",e),a=await Le(n);if(!a.exists())throw new Error("Sauvegarde non trouvée.");const o=a.data(),l=o.weekData.weekNumber,c=me(F(b,"plans"),Z("userId","==",t)),f=await ge(c);if(f.empty)throw new Error("Aucun plan de travail trouvé pour y charger la sauvegarde.");const y=f.docs[0],x=$(b,"plans",y.id);await Te(x,{[`weeks.${l}`]:o.weekData}),localStorage.setItem("selectedPlanId",y.id),rt("menu")}catch(t){console.error("Erreur lors du chargement de la sauvegarde:",t),alert(t.message)}}async function Fn(e){if(confirm("Êtes-vous sûr de vouloir supprimer cette sauvegarde ? Cette action est définitive."))try{await Ae($(b,"plan_saves",e))}catch(t){console.error("Erreur lors de la suppression de la sauvegarde:",t),alert("La suppression a échoué.")}}function On(){const e=document.getElementById("all-plans-list"),t=ye();if(!t||!e)return e.innerHTML="<p>Erreur de chargement.</p>",()=>{};const n=me(F(b,"plan_saves"),Z("userId","==",t)),a=Fe(n,o=>{if(e.innerHTML="",o.empty){e.innerHTML=`<p class="text-center text-gray-500 p-10 col-span-full">Vous n'avez aucune sauvegarde.</p>`;return}const l=o.docs.map(c=>({id:c.id,...c.data()}));l.sort((c,f)=>f.savedAt.toMillis()-c.savedAt.toMillis()),l.forEach(c=>{const f=document.createElement("div");f.className="bg-white rounded-xl shadow-md p-4 flex flex-col justify-between";const y=c.savedAt?.toDate().toLocaleString("fr-FR")||"Date inconnue",x=c.planData;let E="Plan vide ou sans données.";if(x&&x.weeks){const R=Object.keys(x.weeks).length;R>0&&(E=`Contient ${R} semaine(s).`)}const C=document.createElement("div");C.innerHTML=`
                <h3 class="text-lg font-bold text-gray-800 mb-2">${c.name}</h3>
                <p class="text-sm text-gray-500">Sauvegardé le : ${y}</p>
                <p class="text-sm text-gray-600 mt-2">${E}</p>
            `;const L=document.createElement("div");L.className="mt-4 pt-4 border-t border-gray-200 flex items-center justify-end space-x-2";const P=document.createElement("button");P.className="btn btn-secondary btn-sm",P.textContent="Voir",P.addEventListener("click",()=>{localStorage.setItem("selectedPlanId",c.id),rt("view-plan")});const N=document.createElement("button");N.className="btn btn-primary btn-sm",N.textContent="Charger",N.addEventListener("click",()=>Un(c.id)),N.style.display="none";const m=document.createElement("button");m.className="btn btn-ghost text-red-500 hover:bg-red-100 btn-sm",m.innerHTML='<i class="fas fa-trash"></i>',m.title="Supprimer la sauvegarde",m.addEventListener("click",()=>Fn(c.id)),L.appendChild(m),L.appendChild(P),L.appendChild(N),f.appendChild(C),f.appendChild(L),e.appendChild(f)})});return()=>{a()}}const zn=Object.freeze(Object.defineProperty({__proto__:null,default:On},Symbol.toStringTag,{value:"Module"}));class jt{constructor(t,n,a,o,l,c,f,y,x,E,C,L,P,N,m,R){this.db=t,this.modal=document.getElementById(n),this.form=document.getElementById(a),this.modalTitle=document.getElementById(o),this.recipeIdInput=document.getElementById(l),this.recipeNameInput=document.getElementById(c),this.recipeCategoryInput=document.getElementById(f),this.recipeServingsInput=document.getElementById(y),this.recipePrepTimeInput=document.getElementById(x),this.recipeDifficultyInput=document.getElementById(E),this.recipeImageUrlInput=document.getElementById("edit-recipe-image-url"),this.recipeStepsTextarea=document.getElementById(C),this.ingredientsListDiv=document.getElementById(L),this.addIngredientBtn=document.getElementById(P),this.saveRecipeBtn=document.getElementById(N),this.closeButton=document.getElementById(m),this.cancelButton=document.getElementById(R),this.masterIngredientList=[],this.activityUpdater=null,this.boundAddIngredient=()=>this.addIngredientInput(void 0,this.form.ingredients),this.boundCloseForm=()=>this.closeForm(),this.boundHandleSubmit=G=>this.handleSubmit(G),this.addIngredientBtn.addEventListener("click",this.boundAddIngredient),this.closeButton.addEventListener("click",this.boundCloseForm),this.cancelButton.addEventListener("click",this.boundCloseForm),this.saveRecipeBtn.addEventListener("click",this.boundHandleSubmit)}setActivityUpdater(t){this.activityUpdater=t}destroy(){this.addIngredientBtn.removeEventListener("click",this.boundAddIngredient),this.closeButton.removeEventListener("click",this.boundCloseForm),this.cancelButton.removeEventListener("click",this.boundCloseForm),this.saveRecipeBtn.removeEventListener("click",this.boundHandleSubmit)}async openForm(t=null,n="Ajouter une recette"){this.activityUpdater&&this.activityUpdater("editing_recipe"),await this.fetchMasterIngredients(),console.log("openForm called with recipe:",t,"and title:",n),this.form.reset(),this.ingredientsListDiv.innerHTML="",this.modalTitle.textContent=n;const a=[];if(this.form.ingredients=a,t){this.recipeIdInput.value=t.id||"",this.recipeNameInput.value=t.name||"";const o=t.category||"Plat";for(const l of this.recipeCategoryInput.options)if(l.value.toLowerCase()===o.toLowerCase()){l.selected=!0;break}this.recipeServingsInput.value=parseInt(t.servings)||"",this.recipePrepTimeInput.value=parseInt(t.prepTime)||"",this.recipeDifficultyInput.value=t.difficulty||"Moyen",this.recipeImageUrlInput.value=t.imageUrl||"",this.recipeStepsTextarea.value=t.steps||"",t.ingredients&&t.ingredients.length>0?t.ingredients.forEach(l=>this.addIngredientInput({...l},a)):this.addIngredientInput(void 0,a)}else this.recipeIdInput.value="",this.addIngredientInput(void 0,a);this.modal.classList.remove("hidden")}closeForm(){this.activityUpdater&&this.activityUpdater("idle"),this.modal.classList.add("hidden")}async fetchMasterIngredients(){if(this.masterIngredientList=[],!!this.db)try{const t=await ge(F(this.db,"ingredients"));this.masterIngredientList=t.docs.map(n=>({id:n.id,...n.data()})),this.masterIngredientList.sort((n,a)=>n.name.localeCompare(a.name))}catch(t){console.error("Erreur lors de la récupération de la liste des ingrédients: ",t),alert("Impossible de charger la liste des ingrédients de base. La recherche ne fonctionnera pas.")}}addIngredientInput(t={quantity:"",name:"",unit:""},n){const a=document.createElement("div");a.className="relative flex items-stretch space-x-2 ingredient-row";const o={...t};n.push(o);const l=n.length-1,c=document.createElement("input");c.type="text",c.className="ingredient-quantity mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm",c.placeholder="Qté",c.value=o.quantity,c.addEventListener("change",L=>{n[l].quantity=L.target.value});const f=document.createElement("input");f.type="text",f.className="ingredient-unit mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm bg-gray-100",f.placeholder="Unité",f.readOnly=!0,f.value=o.unit||"";const y=document.createElement("div");y.className="relative w-1/2";const x=document.createElement("input");x.type="text",x.className="ingredient-name mt-1 block w-full rounded-md border-gray-300 shadow-sm",x.placeholder="Chercher un ingrédient...",x.value=o.name,y.appendChild(x);const E=document.createElement("div");E.className="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto",y.appendChild(E),x.addEventListener("input",()=>{const L=x.value.toLowerCase();if(!L){E.classList.add("hidden");return}const P=this.masterIngredientList.filter(m=>m.name.toLowerCase().includes(L));E.innerHTML="",P.forEach(m=>{const R=document.createElement("div");R.className="p-2 ingredient-search-item cursor-pointer",R.textContent=m.name,R.addEventListener("click",()=>{x.value=m.name,f.value=m.unit,E.classList.add("hidden"),n[l].name=m.name,n[l].unit=m.unit,n[l].id=m.id}),E.appendChild(R)});const N=document.createElement("div");N.className="p-2 bg-blue-50 hover:bg-blue-200 cursor-pointer font-bold text-blue-700",N.textContent=`+ Créer "${x.value}"`,N.addEventListener("click",async()=>{const m=x.value,R="pièce(s)";try{const G=await Ne(F(this.db,"ingredients"),{name:m,unit:R});await this.fetchMasterIngredients(),x.value=m,f.value=R,E.classList.add("hidden"),n[l].name=m,n[l].unit=R,n[l].id=G.id}catch(G){console.error("Erreur d'ajout d'ingrédient",G),alert("L'ingrédient n'a pas pu être créé.")}}),E.appendChild(N),E.classList.remove("hidden")});const C=document.createElement("button");C.type="button",C.className="btn btn-ghost text-red-500 hover:bg-red-50 btn-sm mt-1",C.innerHTML='<i class="fas fa-trash"></i>',C.addEventListener("click",()=>{a.remove(),n[l]=null}),a.appendChild(y),a.appendChild(c),a.appendChild(f),a.appendChild(C),this.ingredientsListDiv.appendChild(a)}async handleSubmit(t){t.preventDefault(),this.saveRecipeBtn.disabled=!0,this.saveRecipeBtn.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i> Sauvegarde...',console.log("Ingredients array from form before filter:",this.form.ingredients);const n=this.form.ingredients.filter(l=>l!==null&&l.quantity&&l.name);console.log("Ingredients array after filter:",n);const a={name:this.recipeNameInput.value,category:this.recipeCategoryInput.value,servings:parseInt(this.recipeServingsInput.value)||0,prepTime:parseInt(this.recipePrepTimeInput.value)||0,difficulty:this.recipeDifficultyInput.value,steps:this.recipeStepsTextarea.value,ingredients:n,imageUrl:this.recipeImageUrlInput.value||`https://loremflickr.com/400/300/${encodeURIComponent(this.recipeNameInput.value)}`};console.log("Recipe data being sent to Firebase:",a);const o=this.recipeIdInput.value;try{o?await ct($(this.db,"recipes",o),a):await Ne(F(this.db,"recipes"),a),this.closeForm(),console.log("Recipe saved successfully!"),this.onSaveCallback&&this.onSaveCallback()}catch(l){console.error("Erreur de sauvegarde: ",l),alert("Une erreur est survenue lors de la sauvegarde.")}finally{this.saveRecipeBtn.disabled=!1,this.saveRecipeBtn.textContent="Sauvegarder"}}setOnSaveCallback(t){this.onSaveCallback=t}}const Vn=Object.freeze(Object.defineProperty({__proto__:null,RecipeFormHandler:jt},Symbol.toStringTag,{value:"Module"}));let Tt=()=>{};function Qn(){const e=document.getElementById("search-friends-input");return document.getElementById("search-friends-btn").addEventListener("click",()=>Wt(e.value)),e.addEventListener("keyup",n=>{n.key==="Enter"&&Wt(e.value)}),Jn(),tn(),()=>{Tt&&Tt()}}async function Jn(){const e=document.getElementById("friends-list-container"),t=He()?.uid;if(!t||!e)return;e.innerHTML='<p class="text-gray-500">Chargement...</p>';const n=$(b,"users",t);Tt=Fe(n,async a=>{if(!a.exists()){e.innerHTML='<p class="text-red-500">Erreur: Utilisateur non trouvé.</p>';return}const o=a.data().friends||[];if(e.innerHTML="",o.length===0){e.innerHTML=`<p class="text-gray-500">Vous n'avez pas encore d'amis. Utilisez la recherche pour en ajouter.</p>`;return}for(const l of o)try{const c=await Le($(b,"users",l));c.exists()&&e.appendChild(Wn(c.data()))}catch(c){console.error("Erreur de chargement d'un ami",c)}})}function Wn(e){const t=document.createElement("div");t.className="bg-white p-3 rounded-lg flex items-center justify-between shadow-sm";const n=document.createElement("div");n.className="flex items-center",n.innerHTML=`
        <img src="${e.photoURL||"https://placehold.co/40"}" alt="Avatar" class="w-10 h-10 rounded-full mr-3">
        <div>
            <p class="font-bold">${e.displayName}</p>
            <p class="text-sm text-gray-500">${e.email}</p>
        </div>
    `;const a=document.createElement("button");return a.className="btn btn-ghost text-red-500 btn-sm",a.innerHTML='<i class="fas fa-user-times"></i>',a.title="Retirer cet ami",a.addEventListener("click",()=>Gn(e.uid)),t.appendChild(n),t.appendChild(a),t}async function Gn(e){const t=He()?.uid;if(!t||!e){console.error("Impossible de supprimer l'ami : ID utilisateur ou ID ami manquant.");return}if(!confirm("Voulez-vous vraiment retirer cet ami ? Cette action est unilatérale."))return;console.log(`Tentative de suppression de l'ami ${e} pour l'utilisateur ${t}`);const n=$(b,"users",t);try{await Te(n,{friends:Kt(e)}),console.log("Ami supprimé avec succès de la base de données.")}catch(a){console.error("Erreur lors de la suppression de l'ami: ",a),alert("Une erreur est survenue.")}}async function Wt(e){const t=document.getElementById("search-results-container"),n=He()?.uid;if(!(!e||!t)){t.innerHTML='<p class="text-gray-500">Recherche en cours...</p>';try{const a=e.toLowerCase(),o=a+"",l=me(F(b,"users"),Z("displayName_lowercase",">=",a),Z("displayName_lowercase","<",o)),c=me(F(b,"users"),Z("email","==",a)),[f,y]=await Promise.all([ge(l),ge(c)]),x=new Map;if(f.forEach(E=>x.set(E.id,E.data())),y.forEach(E=>x.set(E.id,E.data())),t.innerHTML="",x.size===0){t.innerHTML='<p class="text-gray-500">Aucun utilisateur trouvé.</p>';return}x.forEach(E=>{if(E.uid===n)return;const C=document.createElement("div");C.className="bg-gray-50 p-2 rounded-lg flex items-center justify-between",C.innerHTML=`
                <div class="flex items-center">
                    <img src="${E.photoURL||"https://placehold.co/32"}" class="w-8 h-8 rounded-full mr-2">
                    <span class="font-medium text-sm">${E.displayName} (${E.email})</span>
                </div>
            `;const L=document.createElement("button");L.className="btn btn-secondary btn-xs",L.innerHTML='<i class="fas fa-user-plus"></i>',L.addEventListener("click",()=>Xn(E.uid)),C.appendChild(L),t.appendChild(C)})}catch(a){console.error("Erreur de recherche: ",a),t.innerHTML='<p class="text-red-500">Erreur de recherche.</p>'}}}async function Xn(e){const t=He()?.uid;if(!t||t===e)return;const n=me(F(b,"friend_requests"),Z("senderId","==",t),Z("receiverId","==",e)),a=me(F(b,"friend_requests"),Z("senderId","==",e),Z("receiverId","==",t)),[o,l]=await Promise.all([ge(n),ge(a)]);if(!o.empty||!l.empty)return alert("Une demande d'ami existe déjà avec cet utilisateur.");if((await Le($(b,"users",t))).data()?.friends?.includes(e))return alert("Vous êtes déjà ami avec cet utilisateur.");try{await Ne(F(b,"friend_requests"),{senderId:t,receiverId:e,status:"pending",createdAt:ht()}),alert("Demande d'ami envoyée !")}catch(f){console.error("Erreur lors de l'envoi de la demande d'ami: ",f),alert("Une erreur est survenue.")}}async function tn(){const e=document.getElementById("pending-requests-container"),t=document.getElementById("declined-requests-container"),n=He()?.uid;if(!(!n||!e||!t)){e.innerHTML='<p class="text-gray-500">Chargement...</p>',t.innerHTML='<p class="text-gray-500">Chargement...</p>';try{const a=me(F(b,"friend_requests"),Z("senderId","==",n)),o=await ge(a),l=[],c=[];for(const f of o.docs){const y={id:f.id,...f.data()},x=await Le($(b,"users",y.receiverId));x.exists()&&(y.receiver=x.data()),y.status==="pending"?l.push(y):y.status==="declined"&&c.push(y)}e.innerHTML="",l.length>0?l.forEach(f=>e.appendChild(Gt(f))):e.innerHTML='<p class="text-gray-500">Aucune demande en attente.</p>',t.innerHTML="",c.length>0?c.forEach(f=>t.appendChild(Gt(f))):t.innerHTML='<p class="text-gray-500">Aucune demande rejetée.</p>'}catch(a){console.error("Erreur lors du chargement des demandes envoyées: ",a),e.innerHTML='<p class="text-red-500">Erreur de chargement.</p>',t.innerHTML='<p class="text-red-500">Erreur de chargement.</p>'}}}function Gt(e){const t=document.createElement("div");t.className="bg-white p-3 rounded-lg flex items-center justify-between shadow-sm";const n=e.receiver,a=document.createElement("div");a.className="flex items-center",a.innerHTML=`
        <img src="${n?.photoURL||"https://placehold.co/40"}" alt="Avatar" class="w-10 h-10 rounded-full mr-3">
        <div>
            <p class="font-bold">${n?.displayName||"Utilisateur inconnu"}</p>
            <p class="text-sm text-gray-500">Statut : <span class="font-medium">${e.status}</span></p>
        </div>
    `;const o=document.createElement("button");return o.className="btn btn-ghost text-red-500 btn-sm",o.innerHTML='<i class="fas fa-times-circle"></i>',o.title="Annuler la demande",o.addEventListener("click",async()=>{confirm("Voulez-vous vraiment annuler cette demande ?")&&(await Ae($(b,"friend_requests",e.id)),tn())}),t.appendChild(a),t.appendChild(o),t}async function nn(e){try{const t=$(b,"friend_requests",e);await Te(t,{status:"accepted"})}catch(t){throw console.error("Erreur lors de l'acceptation de la demande d'ami: ",t),t}}async function an(e){try{const t=$(b,"friend_requests",e);await Te(t,{status:"declined"})}catch(t){throw console.error("Erreur lors du refus de la demande d'ami: ",t),t}}const Yn=Object.freeze(Object.defineProperty({__proto__:null,acceptFriendRequest:nn,declineFriendRequest:an,default:Qn},Symbol.toStringTag,{value:"Module"}));function Kn(){const e=document.getElementById("ingredients-list-container"),t=document.getElementById("add-ingredient-btn"),n=document.getElementById("category-tabs"),a=document.getElementById("search-bar"),o=document.getElementById("ingredient-form-modal"),l=document.getElementById("ingredient-modal-title"),c=document.getElementById("close-ingredient-modal"),f=document.getElementById("cancel-ingredient-btn"),y=document.getElementById("ingredient-form"),x=document.getElementById("ingredient-id"),E=document.getElementById("ingredient-name"),C=document.getElementById("ingredient-unit"),L=document.getElementById("ingredient-category"),P=document.getElementById("manage-categories-btn"),N=document.getElementById("category-management-modal"),m=document.getElementById("close-category-modal"),R=document.getElementById("done-category-modal-btn"),G=document.getElementById("add-category-form"),De=document.getElementById("new-category-name"),U=document.getElementById("category-list");let A=[],T=[],z="",X="",Ce=null;const xe=["g","kg","ml","l","pièce(s)","c.à.s.","c.à.c.","pincée(s)"];async function Ee(){await Ie(),await we()}async function Ie(){if(b)try{T=(await ge(F(b,"ingredient_categories"))).docs.map(_=>({id:_.id,..._.data()})),T.sort((_,M)=>_.name.localeCompare(M.name))}catch(q){console.error("Erreur lors de la récupération des catégories: ",q)}}async function we(){if(b)try{A=(await ge(F(b,"ingredients"))).docs.map(_=>({id:_.id,..._.data()})),W(),re()}catch(q){console.error("Erreur de chargement des ingrédients: ",q)}}function Pe(q=null){y.reset(),C.innerHTML="",xe.forEach(H=>{const ee=document.createElement("option");ee.value=H,ee.textContent=H,C.appendChild(ee)});const _=T.map(H=>H.name),M=[...new Set(A.map(H=>H.category).filter(Boolean))],B=[...new Set([..._,...M])];B.sort((H,ee)=>H.localeCompare(ee.name)),L.innerHTML="",B.forEach(H=>{const ee=document.createElement("option");ee.value=H,ee.textContent=H,L.appendChild(ee)}),q?(l.textContent="Modifier l'ingrédient",x.value=q.id,E.value=q.name,C.value=q.unit||"",L.value=q.category||(B.length>0?B[0]:""),document.getElementById("ingredient-image-url").value=q.imageUrl||""):(l.textContent="Ajouter un ingrédient",x.value="",C.value=xe[0],L.value=z||(B.length>0?B[0]:"")),o.classList.remove("hidden")}function Ue(){o.classList.add("hidden")}async function O(q){q.preventDefault();const _=x.value,M={name:E.value,unit:C.value,category:L.value,imageUrl:document.getElementById("ingredient-image-url").value||`https://loremflickr.com/400/300/${encodeURIComponent(E.value)}`};if(!M.name||!M.category){alert("Le nom et la catégorie sont requis.");return}try{_?await ct($(b,"ingredients",_),M):await Ne(F(b,"ingredients"),M),Ue(),await we()}catch(B){console.error("Erreur de sauvegarde de l'ingrédient: ",B)}}function S(){J(),N.classList.remove("hidden")}function Q(){N.classList.add("hidden")}function J(){if(U.innerHTML="",T.length===0){U.innerHTML='<p class="text-gray-500">Aucune catégorie définie.</p>';return}T.forEach(q=>{const _=document.createElement("div");_.className="flex items-center justify-between p-2 border-b";const M=document.createElement("span");M.textContent=q.name,_.appendChild(M);const B=document.createElement("div");B.className="flex space-x-2";const H=document.createElement("button");H.className="btn btn-ghost btn-xs text-blue-500",H.innerHTML='<i class="fas fa-edit"></i>',H.addEventListener("click",()=>K(q)),B.appendChild(H);const ee=document.createElement("button");ee.className="btn btn-ghost btn-xs text-red-500",ee.innerHTML='<i class="fas fa-trash"></i>',ee.addEventListener("click",()=>pe(q)),B.appendChild(ee),_.appendChild(B),U.appendChild(_)})}async function Y(q){q.preventDefault();const _=De.value.trim();if(_&&!T.find(M=>M.name.toLowerCase()===_.toLowerCase()))try{await Ne(F(b,"ingredient_categories"),{name:_}),De.value="",await Ie(),J(),W()}catch(M){console.error("Erreur d'ajout de catégorie: ",M)}else alert("Cette catégorie existe déjà ou le nom est invalide.")}async function K(q){const _=q.name,M=prompt(`Entrez le nouveau nom pour la catégorie "${_}":`,_);if(M&&M.trim()!==""&&M!==_)try{await ct($(b,"ingredient_categories",q.id),{name:M});const B=me(F(b,"ingredients"),Z("category","==",_)),H=await ge(B),ee=Qt(b);H.forEach(Je=>{ee.update(Je.ref,{category:M})}),await ee.commit(),await Ee(),J()}catch(B){console.error("Erreur de renommage: ",B)}}async function pe(q){if(confirm(`Êtes-vous sûr de vouloir supprimer la catégorie "${q.name}"?

Tous les ingrédients associés seront déplacés vers la catégorie "Inconnue".`))try{await Ae($(b,"ingredient_categories",q.id));const _=me(F(b,"ingredients"),Z("category","==",q.name)),M=await ge(_),B=Qt(b);M.forEach(H=>{B.update(H.ref,{category:"Inconnue"})}),await B.commit(),z="",await Ee(),J()}catch(_){console.error("Erreur de suppression: ",_)}}function W(){n.innerHTML="";const q=T.map(B=>B.name),_=[...new Set(A.map(B=>B.category||"Inconnue"))];let M=[...new Set([...q,..._])];M.sort((B,H)=>B.localeCompare(H)),M.includes("Inconnue")&&(M=M.filter(B=>B!=="Inconnue"),M.push("Inconnue")),M.length===0&&A.length>0&&M.push("Inconnue"),!z&&M.length>0&&(z=M[0]),M.forEach(B=>{const H=document.createElement("button"),ee=B===z;H.className=`px-4 py-2 text-sm font-medium rounded-t-lg ${ee?"bg-tomato text-white":"text-gray-500 hover:text-tomato"}`,H.textContent=B,H.addEventListener("click",()=>se(B)),n.appendChild(H)})}function se(q){z=q,W(),re()}function re(){e.innerHTML="";const q=z||(T.length>0?T[0].name:"Inconnue");let _=A.filter(B=>(B.category||"Inconnue")===q);if(X){const B=X.toLowerCase();_=_.filter(H=>H.name.toLowerCase().includes(B))}if(_.length===0){e.innerHTML='<p class="text-center text-gray-500 p-10">Aucun ingrédient dans cette catégorie.</p>';return}_.sort((B,H)=>B.name.localeCompare(H.name,"fr",{sensitivity:"base"}));const M=document.createElement("div");M.className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4",_.forEach(B=>{const H=document.createElement("div");if(H.className="p-3 bg-white shadow-sm rounded-lg flex flex-col items-start space-y-2",B.imageUrl){const et=document.createElement("img");et.src=B.imageUrl,et.alt=B.name,et.className="w-full h-24 object-cover rounded-md mb-2",H.appendChild(et)}const ee=document.createElement("div");ee.className="flex-grow w-full flex justify-between items-center";const Je=document.createElement("span");Je.className="font-medium text-gray-800",Je.textContent=B.name;const Ye=document.createElement("span");Ye.className="text-gray-500 text-sm bg-gray-100 px-2 py-1 rounded-full",Ye.textContent=B.unit,ee.appendChild(Je),ee.appendChild(Ye);const We=document.createElement("div");We.className="w-full flex justify-end items-center space-x-2 border-t pt-2 mt-2";const Ke=document.createElement("button");Ke.className="btn btn-ghost btn-xs text-blue-500 hover:bg-blue-50",Ke.innerHTML='<i class="fas fa-edit"></i>',Ke.addEventListener("click",()=>Pe(B));const Ze=document.createElement("button");Ze.className="btn btn-ghost btn-xs text-red-500 hover:bg-red-50",Ze.innerHTML='<i class="fas fa-trash-alt"></i>',Ze.addEventListener("click",()=>Se(B.id,B.name)),We.appendChild(Ke),We.appendChild(Ze),H.appendChild(ee),H.appendChild(We),M.appendChild(H)}),e.appendChild(M)}async function Se(q,_){if(confirm(`Êtes-vous sûr de vouloir supprimer l'ingrédient "${_}" ?`))try{await Ae($(b,"ingredients",q)),await we()}catch(M){console.error("Erreur de suppression de l'ingrédient: ",M)}}a.addEventListener("input",q=>{const _=q.target.value.toLowerCase();if(!X&&_&&(Ce=z),X=_,X){const M=A.find(B=>B.name.toLowerCase().includes(X));M&&(z=M.category||"Inconnue")}else Ce&&(z=Ce,Ce=null);W(),re()}),t.addEventListener("click",()=>Pe()),c.addEventListener("click",Ue),f.addEventListener("click",Ue),y.addEventListener("submit",O),P.addEventListener("click",S),m.addEventListener("click",Q),R.addEventListener("click",Q),G.addEventListener("submit",Y),Ee()}const Zn=Object.freeze(Object.defineProperty({__proto__:null,default:Kn},Symbol.toStringTag,{value:"Module"})),V={modal:document.getElementById("share-modal"),closeBtn:document.getElementById("close-share-modal"),title:document.getElementById("share-modal-title"),friendsList:document.getElementById("share-friends-list"),sharePlanCheckbox:document.getElementById("share-planning-checkbox"),shareShoppingListCheckbox:document.getElementById("share-shopping-list-checkbox"),confirmBtn:document.getElementById("confirm-share-btn")};let qe={};function xt(){V.modal.classList.add("hidden");const e=document.getElementById("share-mode-selection");e&&e.classList.remove("hidden"),V.confirmBtn.textContent="Envoyer le partage";const t=V.confirmBtn.cloneNode(!0);V.confirmBtn.parentNode&&(V.confirmBtn.parentNode.replaceChild(t,V.confirmBtn),V.confirmBtn=t,t.addEventListener("click",sn))}async function sn(){const e=ye();if(!e||!qe.plan)return;const t=Array.from(V.friendsList.querySelectorAll('input[type="checkbox"]:checked')).map(a=>a.value),n=document.querySelector('input[name="share-mode"]:checked')?.value;if(t.length===0){alert("Veuillez sélectionner au moins un ami.");return}if(!n){alert("Veuillez sélectionner un mode de partage.");return}V.confirmBtn.disabled=!0,V.confirmBtn.textContent="Envoi en cours...";try{const a=F(b,"shares");let o={};n==="collaborate"?o={senderId:e,createdAt:new Date,type:"collaborative_plan_invite",planId:qe.plan.id,planName:qe.plan.name}:o={senderId:e,createdAt:new Date,type:"share",plan:{name:qe.plan.name,weeks:qe.plan.weeks||{},manualItems:qe.plan.manualItems||[],defaultNumPeople:qe.plan.defaultNumPeople||1,startDay:qe.plan.startDay||"Lundi"}};for(const l of t)await Ne(a,{...o,receiverId:l,status:"pending"});xt(),alert("Partage envoyé avec succès !")}catch(a){console.error("Erreur lors de l'envoi du partage : ",a),alert("Une erreur est survenue lors de l'envoi du partage.")}finally{V.confirmBtn.disabled=!1,V.confirmBtn.textContent="Envoyer le partage"}}async function Rt(e={}){const{plan:t}=e;if(!t){alert("Aucun plan sélectionné à partager.");return}qe={plan:t},V.title.textContent=`Partager le plan "${t.name}"`,V.friendsList.innerHTML='<p class="text-gray-500">Chargement des amis...</p>',V.modal.classList.remove("hidden");const n=ye();if(n)try{const a=await Le($(b,"users",n));if(a.exists()){const l=a.data().friends||[];if(l.length===0){V.friendsList.innerHTML=`<p class="text-gray-500">Vous n'avez pas d'amis à qui partager.</p>`;return}V.friendsList.innerHTML="";for(const c of l){const f=await Le($(b,"users",c));if(f.exists()){const y=f.data(),x=document.createElement("label");x.className="flex items-center p-2 hover:bg-gray-100 rounded-lg cursor-pointer";const E=document.createElement("input");E.type="checkbox",E.value=y.uid,E.className="form-checkbox h-5 w-5 text-tomato rounded focus:ring-tomato",x.appendChild(E);const C=document.createElement("img");C.src=y.photoURL||"https://placehold.co/40x40",C.alt=y.displayName,C.className="w-8 h-8 rounded-full ml-3 mr-3",x.appendChild(C);const L=document.createElement("span");L.className="font-medium",L.textContent=y.displayName||y.email,x.appendChild(L),V.friendsList.appendChild(x)}}}}catch(a){console.error("Erreur lors du chargement des amis pour le partage : ",a),V.friendsList.innerHTML='<p class="text-red-500">Une erreur est survenue.</p>'}}async function ea(e){const t=ye();if(!t||!e)return;const n=Array.from(V.friendsList.querySelectorAll('input[type="checkbox"]:checked:not(:disabled)')).map(a=>a.value);if(n.length===0){alert("Veuillez sélectionner au moins un ami à inviter.");return}V.confirmBtn.disabled=!0,V.confirmBtn.textContent="Envoi en cours...";try{const a=await Le($(b,"plans",e));if(!a.exists())throw new Error("Plan not found");const o=a.data().name,l=F(b,"shares"),c={senderId:t,createdAt:new Date,type:"collaborative_plan_invite",planId:e,planName:o};for(const f of n)await Ne(l,{...c,receiverId:f,status:"pending"});xt(),alert("Invitation(s) envoyée(s) avec succès !")}catch(a){console.error("Erreur lors de l'envoi de l'invitation : ",a),alert("Une erreur est survenue lors de l'envoi de l'invitation.")}finally{V.confirmBtn.disabled=!1}}async function rn(e){if(!e||!e.id){alert("Plan non valide pour l'invitation.");return}qe={plan:e},V.title.textContent=`Inviter à collaborer sur "${e.name}"`;const t=document.getElementById("share-mode-selection");t&&t.classList.add("hidden"),V.friendsList.innerHTML='<p class="text-gray-500">Chargement des amis...</p>',V.modal.classList.remove("hidden");const n=ye();if(!n)return;try{const o=await Le($(b,"users",n));if(o.exists()){const c=o.data().friends||[],f=[e.userId,...e.collaborators||[]];if(c.length===0){V.friendsList.innerHTML=`<p class="text-gray-500">Vous n'avez pas d'amis à inviter.</p>`;return}V.friendsList.innerHTML="";for(const y of c){const x=await Le($(b,"users",y));if(x.exists()){const E=x.data(),C=f.includes(E.uid),L=document.createElement("label");L.className=`flex items-center p-2 rounded-lg ${C?"opacity-50 cursor-not-allowed":"hover:bg-gray-100 cursor-pointer"}`;const P=document.createElement("input");P.type="checkbox",P.value=E.uid,P.className="form-checkbox h-5 w-5 text-tomato rounded focus:ring-tomato",C&&(P.disabled=!0,P.checked=!0),L.appendChild(P);const N=document.createElement("img");N.src=E.photoURL||"https://placehold.co/40x40",N.alt=E.displayName,N.className="w-8 h-8 rounded-full ml-3 mr-3",L.appendChild(N);const m=document.createElement("span");if(m.className="font-medium",m.textContent=E.displayName||E.email,C){const R=document.createElement("span");R.className="text-xs text-gray-400 ml-2",R.textContent="(déjà membre)",m.appendChild(R)}L.appendChild(m),V.friendsList.appendChild(L)}}}}catch(o){console.error("Erreur lors du chargement des amis pour l'invitation : ",o),V.friendsList.innerHTML='<p class="text-red-500">Une erreur est survenue.</p>'}V.confirmBtn.textContent="Envoyer l'invitation";const a=V.confirmBtn.cloneNode(!0);V.confirmBtn.parentNode.replaceChild(a,V.confirmBtn),V.confirmBtn=a,a.addEventListener("click",()=>ea(e.id))}V.closeBtn?.addEventListener("click",xt);V.modal?.addEventListener("click",e=>{e.target===V.modal&&xt()});V.confirmBtn?.addEventListener("click",sn);const ta=Object.freeze(Object.defineProperty({__proto__:null,openInviteParticipantModal:rn,openShareModal:Rt},Symbol.toStringTag,{value:"Module"}));function na(){const e=document.getElementById("search-bar"),t=document.getElementById("lists-container"),n=document.getElementById("add-list-btn"),a=document.getElementById("shared-lists-container"),o=document.getElementById("list-form-modal"),l=document.getElementById("list-modal-title"),c=document.getElementById("close-list-modal"),f=document.getElementById("cancel-list-btn"),y=document.getElementById("list-form"),x=document.getElementById("list-id"),E=document.getElementById("list-name"),C=document.getElementById("ingredients-list"),L=document.getElementById("add-ingredient-btn"),P=document.getElementById("save-list-btn");let N=[],m="",R=[],G=[];async function De(){await U(),await A(),await T()}async function U(){if(b)try{R=(await ge(F(b,"ingredients"))).docs.map(S=>({id:S.id,...S.data()})),R.sort((S,Q)=>S.name.localeCompare(Q.name))}catch(O){console.error("Erreur lors de la récupération de la liste des ingrédients: ",O)}}async function A(){const O=ye();if(!(!b||!O))try{const S=me(F(b,"shopping_lists"),Z("userId","==",O));N=(await ge(S)).docs.map(J=>({id:J.id,...J.data()})).filter(J=>J.isShared!==!0),Ee()}catch(S){console.error("Erreur de chargement des listes: ",S)}}async function T(){const O=ye();if(!(!b||!O)){console.log(`Recherche de listes partagées pour userId: ${O}`);try{const S=me(F(b,"shopping_lists"),Z("userId","==",O),Z("isShared","==",!0)),Q=await ge(S);console.log(`Trouvé ${Q.size} liste(s) partagée(s).`);const J=Q.docs.map(Y=>({id:Y.id,...Y.data()}));Ie(J)}catch(S){console.error("Erreur de chargement des listes partagées: ",S)}}}async function z(O=null){await U(),y.reset(),C.innerHTML="",G=[],O?(l.textContent="Modifier la liste",x.value=O.id,E.value=O.name,O.ingredients&&O.ingredients.length>0?O.ingredients.forEach(S=>xe(S)):xe()):(l.textContent="Créer une liste",x.value="",xe()),o.classList.remove("hidden")}function X(){o.classList.add("hidden")}async function Ce(O){O.preventDefault(),P.disabled=!0;const S=ye();if(!S){alert("Erreur : utilisateur non connecté."),P.disabled=!1;return}const Q=G.filter(K=>K&&K.name&&K.quantity),J={name:E.value,ingredients:Q,userId:S};if(!J.name){alert("Le nom de la liste est requis."),P.disabled=!1;return}const Y=x.value;try{Y?await ct($(b,"shopping_lists",Y),J):await Ne(F(b,"shopping_lists"),J),X(),await A()}catch(K){console.error("Erreur de sauvegarde de la liste: ",K)}finally{P.disabled=!1}}function xe(O={quantity:"",name:"",unit:""}){const S=document.createElement("div");S.className="relative flex items-stretch space-x-2 ingredient-row";const Q={...O};G.push(Q);const J=G.length-1,Y=document.createElement("input");Y.type="text",Y.className="ingredient-quantity mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm",Y.placeholder="Qté",Y.value=Q.quantity,Y.addEventListener("change",Se=>{G[J].quantity=Se.target.value});const K=document.createElement("input");K.type="text",K.className="ingredient-unit mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm bg-gray-100",K.placeholder="Unité",K.readOnly=!0,K.value=Q.unit||"";const pe=document.createElement("div");pe.className="relative w-1/2";const W=document.createElement("input");W.type="text",W.className="ingredient-name mt-1 block w-full rounded-md border-gray-300 shadow-sm",W.placeholder="Chercher un ingrédient...",W.value=Q.name,pe.appendChild(W);const se=document.createElement("div");se.className="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto",pe.appendChild(se),W.addEventListener("input",()=>{const Se=W.value.toLowerCase();if(!Se){se.classList.add("hidden");return}const q=R.filter(M=>M.name.toLowerCase().includes(Se));se.innerHTML="",q.forEach(M=>{const B=document.createElement("div");B.className="p-2 ingredient-search-item cursor-pointer",B.textContent=M.name,B.addEventListener("click",()=>{W.value=M.name,K.value=M.unit,se.classList.add("hidden"),G[J].name=M.name,G[J].unit=M.unit,G[J].id=M.id}),se.appendChild(B)});const _=document.createElement("div");_.className="p-2 bg-blue-50 hover:bg-blue-200 cursor-pointer font-bold text-blue-700",_.textContent=`+ Créer "${W.value}"`,_.addEventListener("click",async()=>{const M=W.value,B="pièce(s)";try{const H=await Ne(F(b,"ingredients"),{name:M,unit:B,category:"Inconnue"});await U(),W.value=M,K.value=B,se.classList.add("hidden"),G[J].name=M,G[J].unit=B,G[J].id=H.id}catch(H){console.error("Erreur d'ajout d'ingrédient",H),alert("L'ingrédient n'a pas pu être créé.")}}),se.appendChild(_),se.classList.remove("hidden")});const re=document.createElement("button");re.type="button",re.className="btn btn-ghost text-red-500 hover:bg-red-50 btn-sm mt-1",re.innerHTML='<i class="fas fa-trash"></i>',re.addEventListener("click",()=>{S.remove(),G[J]=null}),S.appendChild(pe),S.appendChild(Y),S.appendChild(K),S.appendChild(re),C.appendChild(S)}function Ee(){t.innerHTML="";let O=N;if(m){const S=m.toLowerCase();O=N.filter(Q=>Q.name.toLowerCase().includes(S))}if(O.length===0){t.innerHTML='<p class="text-center text-gray-500 p-10 col-span-full">Aucune liste de courses trouvée.</p>';return}O.sort((S,Q)=>S.name.localeCompare(Q.name)),O.forEach(S=>{const Q=document.createElement("div");Q.className="bg-white rounded-lg shadow-md p-4 flex flex-col";const J=document.createElement("div");J.className="flex justify-between items-start border-b pb-2 mb-2";const Y=document.createElement("h4");Y.className="text-lg font-bold text-gray-800",Y.textContent=S.name,J.appendChild(Y);const K=document.createElement("div");K.className="flex space-x-2";const pe=document.createElement("button");pe.className="btn btn-ghost btn-sm text-blue-500",pe.innerHTML='<i class="fas fa-edit"></i>',pe.addEventListener("click",()=>z(S)),K.appendChild(pe);const W=document.createElement("button");W.className="btn btn-ghost btn-sm text-green-500",W.innerHTML='<i class="fas fa-share-alt"></i>',W.addEventListener("click",()=>Rt({})),K.appendChild(W);const se=document.createElement("button");se.className="btn btn-ghost btn-sm text-red-500",se.innerHTML='<i class="fas fa-trash"></i>',se.addEventListener("click",()=>we(S.id,S.name)),K.appendChild(se),J.appendChild(K);const re=document.createElement("ul");re.className="space-y-1 text-sm text-gray-600 flex-grow",S.ingredients&&S.ingredients.length>0?S.ingredients.forEach(Se=>{const q=document.createElement("li");q.textContent=`${Se.quantity} ${Se.unit||""} - ${Se.name}`.trim(),re.appendChild(q)}):re.innerHTML='<li class="italic text-gray-400">Cette liste est vide.</li>',Q.appendChild(J),Q.appendChild(re),t.appendChild(Q)})}function Ie(O){if(a.innerHTML="",O.length===0){a.innerHTML='<p class="text-center text-gray-500 p-10 col-span-full">Aucune liste de courses partagée trouvée.</p>';return}O.sort((S,Q)=>S.name.localeCompare(Q.name)),O.forEach(S=>{const Q=document.createElement("div");Q.className="bg-white rounded-lg shadow-md p-4 flex flex-col";const J=document.createElement("div");J.className="flex justify-between items-start border-b pb-2 mb-2";const Y=document.createElement("h4");Y.className="text-lg font-bold text-gray-800",Y.textContent=S.name,J.appendChild(Y);const K=document.createElement("div");K.className="flex space-x-2";const pe=document.createElement("button");pe.className="btn btn-secondary btn-sm",pe.innerHTML='<i class="fas fa-copy mr-2"></i> Copier dans mes listes',pe.title="Copier cette liste dans vos listes personnelles",pe.addEventListener("click",()=>Ue(S.id)),K.appendChild(pe);const W=document.createElement("button");W.className="btn btn-ghost btn-sm text-red-500",W.innerHTML='<i class="fas fa-trash"></i>',W.title="Supprimer cette liste partagée",W.addEventListener("click",()=>Pe(S.id,S.name)),K.appendChild(W),J.appendChild(K);const se=document.createElement("ul");se.className="space-y-1 text-sm text-gray-600 flex-grow",S.ingredients&&S.ingredients.length>0?S.ingredients.forEach(re=>{const Se=document.createElement("li");Se.textContent=`${re.quantity} ${re.unit||""} - ${re.name}`.trim(),se.appendChild(Se)}):se.innerHTML='<li class="italic text-gray-400">Cette liste est vide.</li>',Q.appendChild(J),Q.appendChild(se),a.appendChild(Q)})}async function we(O,S){if(confirm(`Êtes-vous sûr de vouloir supprimer la liste "${S}" ?`))try{await Ae($(b,"shopping_lists",O)),await A()}catch(Q){console.error("Erreur de suppression de la liste: ",Q)}}async function Pe(O,S){if(confirm(`Êtes-vous sûr de vouloir supprimer la liste partagée "${S}" ?`))try{await Ae($(b,"shopping_lists",O)),await T()}catch(Q){console.error("Erreur de suppression de la liste partagée: ",Q),alert("Une erreur est survenue.")}}async function Ue(O){if(confirm("Voulez-vous vraiment copier cette liste dans vos listes personnelles ? Elle ne sera plus considérée comme une liste partagée."))try{const S=$(b,"shopping_lists",O);await Te(S,{isShared:!1}),await De()}catch(S){console.error("Erreur lors de la copie de la liste: ",S),alert("Une erreur est survenue.")}}e.addEventListener("input",O=>{m=O.target.value,Ee()}),n.addEventListener("click",()=>z()),c.addEventListener("click",X),f.addEventListener("click",X),y.addEventListener("submit",Ce),L.addEventListener("click",()=>xe()),b&&De()}const aa=Object.freeze(Object.defineProperty({__proto__:null,default:na},Symbol.toStringTag,{value:"Module"})),Re=Mn();let ut,Ct,It,lt,de,mt,Bt,kt,dt,Xe,pt,St,Mt,Dt,Pt,bt=null,yt=null;function _t(){ut&&ut.classList.remove("hidden")}function it(){ut&&ut.classList.add("hidden"),lt&&lt.reset()}function on(e,t){yt=e,Xe&&(Xe.value=t),mt&&mt.classList.remove("hidden"),Xe&&Xe.focus()}function ot(){yt=null,mt&&mt.classList.add("hidden"),dt&&dt.reset()}function ln(e,t){bt=e,Dt&&(Dt.textContent="Confirmer la suppression"),Pt&&(Pt.textContent=`Êtes-vous sûr de vouloir supprimer le plan "${t}" ? Cette action est irréversible.`),pt&&pt.classList.remove("hidden")}function Nt(){bt=null,pt&&pt.classList.add("hidden")}async function sa(e){const t=He();if(t)try{await Ne(F(Re,"plans"),{userId:t.uid,name:e,type:"personal",weeks:{},manualItems:[],defaultNumPeople:1,startDay:"Lundi",lastUpdated:new Date}),it()}catch(n){console.error("Error creating plan: ",n),alert("Erreur lors de la création du plan.")}}async function ra(e,t){if(!(!e||!t))try{const n=$(Re,"plans",e);await Te(n,{name:t}),ot()}catch(n){console.error("Error renaming plan: ",n),alert("Erreur lors du renommage du plan.")}}async function ia(e){const t=He()?.uid;if(!(!e||!t)&&confirm("Voulez-vous vraiment quitter ce plan partagé ? Il n'apparaîtra plus dans votre liste."))try{const n=$(Re,"plans",e);await Te(n,{collaborators:Kt(t)})}catch(n){console.error("Erreur pour quitter le plan: ",n),alert("Une erreur est survenue.")}}async function oa(e){if(e)try{await Ae($(Re,"plans",e))}catch(t){console.error("Error deleting plan: ",t),alert("Erreur lors de la suppression du plan.")}}function dn(e){const t=He();if(!t)return()=>{};let n=new Map;const a=()=>{e(Array.from(n.values()).sort((x,E)=>x.name.localeCompare(E.name)))},o=async x=>{const C=[x.userId,...x.collaborators||[]].map(P=>Le($(Re,"users",P)));return(await Promise.all(C)).map(P=>P.exists()?P.data():{uid:P.id,displayName:"Inconnu"})},l=me(F(Re,"plans"),Z("userId","==",t.uid)),c=Fe(l,async x=>{const C=x.docChanges().map(async L=>{if(L.type==="removed")n.delete(L.doc.id);else{const P=L.doc.data(),N=await o(P);n.set(L.doc.id,{id:L.doc.id,...P,isOwner:!0,participants:N})}});await Promise.all(C),a()}),f=me(F(Re,"plans"),Z("collaborators","array-contains",t.uid)),y=Fe(f,async x=>{const C=x.docChanges().map(async L=>{if(L.type==="removed")n.delete(L.doc.id);else{const P=L.doc.data(),N=await o(P),m=N.find(R=>R.uid===P.userId);n.set(L.doc.id,{id:L.doc.id,...P,isOwner:!1,ownerName:m?.displayName||"Inconnu",participants:N})}});await Promise.all(C),a()});return()=>{c(),y()}}function cn(e){if(!de)return;const t=de.value;if(de.innerHTML="",e.length===0){const n=document.createElement("option");n.value="",n.textContent="Aucun plan personnel",n.disabled=!0,de.appendChild(n);return}e.forEach(n=>{const a=document.createElement("option");a.value=n.id;let o=n.name;n.collaborators&&n.collaborators.length>0&&(n.isOwner?o=`👑 ${n.name} [Collab]`:o=`👥 ${n.name} [Collab] (de ${n.ownerName})`),a.textContent=o,de.appendChild(a)}),t&&de.querySelector(`option[value="${t}"]`)?de.value=t:de.selectedIndex=0}function un(){ut=document.getElementById("create-plan-modal"),Ct=document.getElementById("close-create-plan-modal"),It=document.getElementById("cancel-create-plan-btn"),lt=document.getElementById("create-plan-form"),de=document.getElementById("plan-select"),mt=document.getElementById("rename-plan-modal"),Bt=document.getElementById("close-rename-plan-modal"),kt=document.getElementById("cancel-rename-plan-btn"),dt=document.getElementById("rename-plan-form"),Xe=document.getElementById("new-plan-name"),pt=document.getElementById("delete-confirm-modal"),St=document.getElementById("cancel-delete-btn"),Mt=document.getElementById("confirm-delete-btn"),Dt=document.getElementById("delete-confirm-title"),Pt=document.getElementById("delete-confirm-message");const e=document.getElementById("create-plan-btn"),t=document.getElementById("rename-plan-btn"),n=document.getElementById("leave-plan-btn"),a=document.getElementById("delete-plan-btn"),o=E=>{E.preventDefault();const C=document.getElementById("plan-name");C&&C.value&&sa(C.value)},l=E=>{E.preventDefault(),yt&&Xe.value&&ra(yt,Xe.value)},c=()=>{bt&&oa(bt).then(()=>{Nt()})},f=()=>{if(de&&de.value){const E=de.options[de.selectedIndex];on(de.value,E.text)}else alert("Veuillez sélectionner un plan à renommer.")},y=()=>{de&&de.value?ia(de.value):alert("Veuillez sélectionner un plan.")},x=()=>{if(de&&de.value){const E=de.options[de.selectedIndex].text;ln(de.value,E)}else alert("Veuillez sélectionner un plan à supprimer.")};return e?.addEventListener("click",_t),t?.addEventListener("click",f),n?.addEventListener("click",y),a?.addEventListener("click",x),Ct?.addEventListener("click",it),It?.addEventListener("click",it),lt?.addEventListener("submit",o),Bt?.addEventListener("click",ot),kt?.addEventListener("click",ot),dt?.addEventListener("submit",l),St?.addEventListener("click",Nt),Mt?.addEventListener("click",c),()=>{e?.removeEventListener("click",_t),t?.removeEventListener("click",f),n?.removeEventListener("click",y),a?.removeEventListener("click",x),Ct?.removeEventListener("click",it),It?.removeEventListener("click",it),lt?.removeEventListener("submit",o),Bt?.removeEventListener("click",ot),kt?.removeEventListener("click",ot),dt?.removeEventListener("submit",l),St?.removeEventListener("click",Nt),Mt?.removeEventListener("click",c)}}async function mn(e,t){if(!(!e||!t))try{const n=$(Re,"plans",e);await Te(n,{collaborators:Nn(t),type:"collaborative"})}catch(n){console.error("Error adding collaborator: ",n)}}async function $t(e,t,n="Modification diverse"){if(!e||!t)return;const a=He();if(a)try{const o=F(Re,"plans",e,"history"),l=JSON.parse(JSON.stringify(t));await Ne(o,{planState:l,timestamp:ht(),modifiedBy:a.uid,modifiedByName:a.displayName||a.email,description:n})}catch(o){console.error("Error saving history:",o)}}async function pn(e,t){const n=He();if(!(!n||!e||!t))try{const a=F(Re,"plan_saves"),o=me(a,Z("userId","==",n.uid),Z("name","==",e)),l=await ge(o);if(l.empty)await Ne(a,{userId:n.uid,name:e,savedAt:ht(),planData:t});else{const c=l.docs[0].id,f=$(Re,"plan_saves",c);await Te(f,{planData:t,savedAt:ht()})}}catch(a){console.error("Error saving or updating plan save:",a),alert("Erreur lors de la sauvegarde.")}}async function la(e,t,n){if(!e||!t||!n)return;const a=$(Re,"plans",e);try{await Te(a,{[`weeks.${t}`]:n,lastUpdated:new Date}),console.log(`Week ${t} of plan ${e} saved successfully.`)}catch(o){console.error("Error saving plan week:",o),alert("Erreur lors de la sauvegarde du plan.")}}const da=Object.freeze(Object.defineProperty({__proto__:null,addCollaborator:mn,getUserPlans:dn,initPlanManagement:un,openCreatePlanModal:_t,openDeleteConfirmModal:ln,openRenamePlanModal:on,populatePlanSelector:cn,saveHistory:$t,saveOrUpdatePlanSaveByName:pn,savePlanWeek:la},Symbol.toStringTag,{value:"Module"}));let fn=[],gn=[],hn=()=>{},vn=()=>{};const be={btn:null,badge:null,badgeMobile:null,dropdown:null,list:null};async function ca(e,t,n){const a=ye();if(a)try{const o=$(b,"shares",e);if(await Te(o,{status:"accepted"}),t.plan){const l=n.displayName||"Inconnu",c=`Copie de "${t.plan.name}" (de ${l})`,f={...t.plan,userId:a,name:c,isShared:!0,originalOwnerId:t.senderId,sharedAt:new Date,collaborators:[]};delete f.id,await Ne(F(b,"plans"),f)}t.shoppingList&&await Ne(F(b,"shopping_lists"),{name:`${t.shoppingList.name} (de ${n.displayName})`,ingredients:t.shoppingList.ingredients,userId:a,isShared:!0,originalOwner:n.uid,sharedAt:new Date})}catch(o){console.error("Erreur lors de l'acceptation du partage : ",o),alert("Une erreur est survenue.")}}async function ua(e,t){const n=ye();if(!(!n||!t||!t.planId))try{await mn(t.planId,n);const a=$(b,"shares",e);await Te(a,{status:"accepted"})}catch(a){console.error("Erreur lors de l'acceptation de l'invitation : ",a),alert("Une erreur est survenue.")}}async function Xt(e){try{const t=$(b,"shares",e);await Te(t,{status:"declined"})}catch(t){console.error("Erreur lors du refus du partage : ",t),alert("Une erreur est survenue.")}}async function ma(e){try{await nn(e)}catch{alert("Erreur lors de l'acceptation.")}}async function pa(e){try{await an(e)}catch{alert("Erreur lors du refus.")}}function bn(){if(!be.list)return;const e=[...fn,...gn];e.sort((n,a)=>a.createdAt.toMillis()-n.createdAt.toMillis());const t=n=>{n&&(e.length>0?(n.textContent=e.length,n.classList.remove("hidden")):n.classList.add("hidden"))};t(be.badge),t(be.badgeMobile),be.list.innerHTML="",e.length===0?be.list.innerHTML='<p class="text-gray-500 text-center p-4">Aucune nouvelle notification.</p>':e.forEach(n=>{const a=fa(n);be.list.appendChild(a)})}function fa(e){const t=document.createElement("div");t.className="p-3 border-b border-gray-100 hover:bg-gray-50";const n=document.createElement("p");n.className="text-sm font-medium text-gray-800";const a=document.createElement("p");a.className="text-xs text-gray-500 mb-3";const o=document.createElement("div");o.className="flex space-x-2 justify-end";const l=e.data.type||e.type;if(l==="collaborative_plan_invite"){n.textContent="Invitation à collaborer",a.textContent=`${e.sender.displayName} vous invite à modifier son plan "${e.data.planName}".`;const c=nt("Accepter","btn-secondary",y=>{y.target.textContent="...",y.target.disabled=!0,ua(e.id,e.data)}),f=nt("Refuser","btn-ghost text-red-500",y=>{y.target.disabled=!0,Xt(e.id)});o.append(c,f)}else if(l==="share"){n.textContent=`Partage de ${e.sender.displayName||e.sender.email}`;let c=[];e.data.plan&&c.push("planification"),e.data.shoppingList&&c.push("liste de courses"),a.textContent=`Contenu : ${c.join(" et ")}`;const f=nt("Accepter","btn-secondary",x=>{x.target.textContent="...",x.target.disabled=!0,ca(e.id,e.data,e.sender)}),y=nt("Refuser","btn-ghost text-red-500",x=>{x.target.disabled=!0,Xt(e.id)});o.append(f,y)}else if(l==="friend_request"){n.textContent="Invitation d'ami",a.textContent=`${e.sender.displayName||e.sender.email} vous a envoyé une invitation.`;const c=nt("Accepter","btn-secondary",y=>{y.target.textContent="...",y.target.disabled=!0,ma(e.id)}),f=nt("Refuser","btn-ghost text-red-500",y=>{y.target.disabled=!0,pa(e.id)});o.append(c,f)}return t.append(n,a,o),t}function nt(e,t,n){const a=document.createElement("button");return a.className=`btn btn-xs ${t}`,a.textContent=e,a.addEventListener("click",o=>{o.stopPropagation(),n(o)}),a}function ga(e){const t=F(b,"shares"),n=me(t,Z("receiverId","==",e),Z("status","==","pending"));hn=Fe(n,async a=>{const o=[];for(const l of a.docs){const c=l.data(),f=await Le($(b,"users",c.senderId));f.exists()&&o.push({type:c.type||"share",id:l.id,data:c,sender:f.data(),createdAt:c.createdAt})}fn=o,bn()},a=>{console.error("Erreur d'écoute des partages:",a)})}function ha(e){const t=F(b,"friend_requests"),n=me(t,Z("receiverId","==",e),Z("status","==","pending"));vn=Fe(n,async a=>{const o=[];for(const l of a.docs){const c=l.data(),f=await Le($(b,"users",c.senderId));f.exists()&&o.push({type:"friend_request",id:l.id,data:c,sender:f.data(),createdAt:c.createdAt})}gn=o,bn()},a=>{console.error("Erreur d'écoute des invitations d'amis:",a)})}function yn(){if(be.btn=document.getElementById("notifications-btn"),be.badge=document.getElementById("notifications-badge"),be.badgeMobile=document.getElementById("notifications-badge-mobile"),be.dropdown=document.getElementById("notifications-dropdown"),be.list=document.getElementById("notifications-list"),!be.btn)return;const e=ye();e&&(hn(),vn(),ga(e),ha(e),be.btn.addEventListener("click",t=>{t.stopPropagation(),be.dropdown.classList.toggle("hidden")}),document.addEventListener("click",t=>{be.dropdown&&!be.dropdown.classList.contains("hidden")&&!be.btn.contains(t.target)&&!be.dropdown.contains(t.target)&&be.dropdown.classList.add("hidden")}))}const va=Object.freeze(Object.defineProperty({__proto__:null,initNotifications:yn},Symbol.toStringTag,{value:"Module"}));let Qe=null,st=null;function xn(e,t){if(!Lt||!e)return;const n=He();if(!n)return;const a=Jt(Lt,`plans_presence/${e}`);Qe=Jt(Lt,`plans_presence/${e}/${n.uid}`);const o={displayName:n.displayName||n.email,photoURL:n.photoURL,status:"idle",last_seen:Zt()};Tn(Qe).remove(),Dn(Qe,o),st&&st(),st=Pn(a,l=>{const c=l.val()||{};typeof t=="function"&&t(c)})}function En(){Qe&&(_n(Qe),Qe=null),st&&(st(),st=null)}function gt(e){Qe&&$n(Qe,{status:e,last_seen:Zt()})}const ba=Object.freeze(Object.defineProperty({__proto__:null,connectToPresenceChannel:xn,disconnectFromPresenceChannel:En,updateUserActivity:gt},Symbol.toStringTag,{value:"Module"}));let at=null;async function At(e,t){if(!e)return;const n=$(b,"recipes",e);try{await Te(n,{isFavorite:!t})}catch(a){console.error("Error toggling favorite status:",a)}}function ya(){const e=document.getElementById("search-bar"),t=document.getElementById("category-tabs"),n=document.getElementById("recipe-list-container"),a=document.getElementById("add-recipe-btn");at&&at.destroy(),at=new jt(b,"edit-recipe-form-modal","edit-recipe-form","edit-recipe-modal-title","edit-recipe-id","edit-recipe-name","edit-recipe-category","edit-recipe-servings","edit-recipe-prep-time","edit-recipe-difficulty","edit-recipe-steps","edit-ingredients-list","edit-add-ingredient-btn","edit-save-recipe-btn","close-edit-recipe-modal","edit-cancel-recipe-btn"),at.setOnSaveCallback(()=>{});let o=[],l="",c="",f=null;const y=["Entrée","Plat","Accompagnement","Dessert"],x={PLAT:"bg-orange-100",DESSERT:"bg-amber-100",ENTREE:"bg-lime-100",ACCOMPAGNEMENT:"bg-stone-200","PETIT-DEJEUNER":"bg-orange-100",BOISSON:"bg-cyan-100",SAUCE:"bg-red-100"},E={PLAT:"text-orange-800",DESSERT:"text-amber-800",ENTREE:"text-lime-800",ACCOMPAGNEMENT:"text-stone-800","PETIT-DEJEUNER":"text-orange-800",BOISSON:"text-cyan-800",SAUCE:"text-red-800"},C="bg-gray-100",L="text-gray-800";function P(){return b?Fe(F(b,"recipes"),A=>{console.log("Recipe data updated on /recipes page from listener."),o=A.docs.map(T=>({id:T.id,...T.data()})),m(),R()},A=>{console.error("Erreur lors de l'écoute des recettes: ",A)}):()=>{}}function N(U){l=U,m(),R()}function m(){if(!t)return;t.innerHTML="";const A=[...new Set(o.map(T=>T.category||"Non classé"))].sort((T,z)=>{const X=Ee=>{const Ie=Ee.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();for(let we=0;we<y.length;we++)if(y[we].normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()===Ie)return we;return-1},Ce=X(T),xe=X(z);return Ce>-1&&xe>-1?Ce-xe:Ce>-1?-1:xe>-1?1:T.localeCompare(z)});!l&&A.length>0&&(l=A[0]),A.forEach(T=>{const z=document.createElement("button"),X=T.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toUpperCase();if(T===l){const xe=x[X]||C,Ee=E[X]||L;z.className=`px-4 py-2 text-sm font-bold rounded-t-lg ${xe} ${Ee}`}else z.className="px-4 py-2 text-sm font-medium text-gray-500 hover:text-tomato";z.textContent=T,z.addEventListener("click",()=>N(T)),t.appendChild(z)})}function R(){if(!n)return;n.innerHTML="";let U=o.filter(T=>(T.category||"Non classé")===l);if(c){const T=c.toLowerCase();U=U.filter(z=>z.name.toLowerCase().includes(T))}if(U.sort((T,z)=>T.name.localeCompare(z.name)),U.length===0){n.innerHTML='<p class="text-gray-500 text-center p-10">Aucune recette trouvée.</p>';return}const A=document.createElement("div");A.className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4",U.forEach(T=>{A.appendChild(G(T))}),n.appendChild(A)}function G(U){const A=document.createElement("div");if(A.className="bg-white dark:bg-gray-800 shadow-md rounded-lg flex flex-col p-3",U.imageUrl){const Pe=document.createElement("img");Pe.src=U.imageUrl,Pe.alt=U.name,Pe.className="w-full h-24 object-cover rounded-md mb-2",A.appendChild(Pe)}const T=document.createElement("div");T.className="w-full flex justify-between items-start";const z=document.createElement("h4");z.className="font-bold text-gray-800 dark:text-gray-200 pr-2",z.textContent=U.name,z.title=U.name,T.appendChild(z);const X=document.createElement("button");X.className="text-lg flex-shrink-0",X.innerHTML='<i class="fas fa-heart"></i>',U.isFavorite?X.classList.add("text-red-500"):X.classList.add("text-gray-300","dark:text-gray-500","hover:text-red-400"),X.addEventListener("click",Pe=>{Pe.stopPropagation(),At(U.id,U.isFavorite)}),T.appendChild(X),A.appendChild(T);const Ce=document.createElement("p");Ce.className="text-sm text-gray-600 dark:text-gray-400 mt-1 w-full",Ce.textContent=`${U.difficulty||""} - Pour ${U.servings||"?"} pers.`,A.appendChild(Ce);const xe=document.createElement("div");xe.className="flex-grow",A.appendChild(xe);const Ee=document.createElement("div");Ee.className="w-full flex justify-end items-center space-x-2 border-t dark:border-gray-700 pt-2 mt-2";const Ie=document.createElement("button");Ie.className="btn btn-ghost btn-sm text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/50",Ie.innerHTML='<i class="fas fa-edit"></i>',Ie.title="Modifier",Ie.addEventListener("click",()=>at.openForm(U,"Modifier la recette")),Ee.appendChild(Ie);const we=document.createElement("button");return we.className="btn btn-ghost btn-sm text-red-500 hover:bg-red-50 dark:hover:bg-red-900/50",we.innerHTML='<i class="fas fa-trash-alt"></i>',we.title="Supprimer",we.addEventListener("click",()=>De(U.id,U.name)),Ee.appendChild(we),A.appendChild(Ee),A}async function De(U,A){if(confirm(`Êtes-vous sûr de vouloir supprimer la recette "${A}" ?`))try{await Ae($(b,"recipes",U)),fetchAllRecipes()}catch(T){console.error("Erreur lors de la suppression: ",T)}}if(a.addEventListener("click",()=>at.openForm(null,"Ajouter une recette")),e.addEventListener("input",U=>{const A=U.target.value;if(!c&&A&&(f=l),c=A,c){const T=c.toLowerCase(),z=o.find(X=>X.name.toLowerCase().includes(T));z&&(l=z.category||"Non classé")}else f&&(l=f,f=null);m(),R()}),b)return P()}const xa=Object.freeze(Object.defineProperty({__proto__:null,default:ya,toggleFavoriteStatus:At},Symbol.toStringTag,{value:"Module"}));let Ve=null;function Ea(){const e={mealPlanGrid:document.getElementById("meal-plan-grid"),currentWeekDisplay:document.getElementById("current-week-display"),prevWeekBtn:document.getElementById("prev-week-btn"),nextWeekBtn:document.getElementById("next-week-btn"),clearMenuBtn:document.getElementById("clear-menu-btn"),shoppingListContainer:document.getElementById("shopping-list"),startDaySelect:document.getElementById("start-day-select"),defaultServingsControl:document.getElementById("default-servings-control"),mealSelectModal:document.getElementById("meal-select-modal"),closeMealSelectModalBtn:document.getElementById("close-meal-select-modal"),mealSelectModalTitle:document.getElementById("meal-select-modal-title"),mealSelectList:document.getElementById("meal-select-list"),recipeFormModal:document.getElementById("edit-recipe-form-modal"),closeRecipeModalBtn:document.getElementById("close-edit-recipe-modal"),cancelRecipeBtn:document.getElementById("edit-cancel-recipe-btn"),recipeForm:document.getElementById("edit-recipe-form"),addItemInput:document.getElementById("add-item-input"),addItemBtn:document.getElementById("add-item-btn"),addItemResults:document.getElementById("add-item-results"),importListBtn:document.getElementById("import-list-btn"),importListModal:document.getElementById("import-list-modal"),closeImportListModalBtn:document.getElementById("close-import-list-modal"),importListContainer:document.getElementById("import-list-container"),exportTxtBtn:document.getElementById("export-txt-btn"),exportPdfBtn:document.getElementById("export-pdf-btn"),exportPlanPdfBtn:document.getElementById("export-plan-pdf-btn"),sharePlanBtn:document.getElementById("share-plan-btn"),planSelect:document.getElementById("plan-select"),inviteParticipantBtn:document.getElementById("invite-participant-btn"),historyPlanBtn:document.getElementById("history-plan-btn"),planHistoryModal:document.getElementById("plan-history-modal"),closePlanHistoryModalBtn:document.getElementById("close-plan-history-modal"),planHistoryList:document.getElementById("plan-history-list"),savePlanBtn:document.getElementById("save-plan-btn")};function t(s,i){const d=document.createElement("div");d.className="flex items-center space-x-2";const u=document.createElement("button");u.className="btn btn-outline btn-xs",u.textContent="-";const r=document.createElement("span");r.className="font-medium text-center w-6",r.textContent=s;const g=document.createElement("button");return g.className="btn btn-outline btn-xs",g.textContent="+",u.addEventListener("click",()=>{let h=parseInt(r.textContent,10);h>1&&(h--,r.textContent=h,i(h))}),g.addEventListener("click",()=>{let h=parseInt(r.textContent,10);h++,r.textContent=h,i(h)}),d.appendChild(u),d.appendChild(r),d.appendChild(g),d}function n(s,i,d,u=!1){const r=document.createElement("div");r.className="flex flex-col items-center justify-center h-full";const g=document.createElement("button");g.className="btn btn-ghost btn-xs p-0 h-4 flex items-center justify-center w-full",g.innerHTML='<i class="fas fa-plus"></i>',g.disabled=u;const h=document.createElement("span");h.className="font-medium text-center text-sm my-1",h.textContent=s;const p=document.createElement("button");return p.className="btn btn-ghost btn-xs p-0 h-4 flex items-center justify-center w-full",p.innerHTML='<i class="fas fa-minus"></i>',p.disabled=u,i&&(g.classList.add("text-white"),h.classList.add("text-white"),p.classList.add("text-white")),u||(g.addEventListener("click",()=>{let v=parseInt(h.textContent,10);v++,h.textContent=v,d(v)}),p.addEventListener("click",()=>{let v=parseInt(h.textContent,10);v>1&&(v--,h.textContent=v,d(v))})),r.appendChild(g),r.appendChild(h),r.appendChild(p),r}Ve&&Ve.destroy(),Ve=new jt(b,"edit-recipe-form-modal","edit-recipe-form","edit-recipe-modal-title","edit-recipe-id","edit-recipe-name","edit-recipe-category","edit-recipe-servings","edit-recipe-prep-time","edit-recipe-difficulty","edit-recipe-steps","edit-ingredients-list","edit-add-ingredient-btn","edit-save-recipe-btn","close-edit-recipe-modal","edit-cancel-recipe-btn"),Ve.setActivityUpdater(gt),Ve.setOnSaveCallback(async()=>{});let a=1,o="Lundi",l={},c={},f={};const y=[];let x=null,E=[],C=[],L=1,P=null,N=[],m=null;const R=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];function G(s){return s?s.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase():""}async function De(s){const i=document.getElementById("unit-select-modal"),d=document.getElementById("unit-modal-title"),u=document.getElementById("unit-modal-list"),r=document.getElementById("unit-modal-cancel");return d.textContent=`Choisir une unité pour "${s}"`,u.innerHTML="",new Promise((g,h)=>{const p=["g","kg","ml","l","pièce(s)","c.à.s.","c.à.c.","pincée(s)"],v=w=>{i.classList.add("hidden"),g(w)};p.forEach(w=>{const I=document.createElement("button");I.className="btn btn-outline",I.textContent=w,I.addEventListener("click",()=>v(w)),u.appendChild(I)});const k=()=>{i.classList.add("hidden"),h()};r.addEventListener("click",k,{once:!0}),i.addEventListener("click",w=>{w.target===i&&k()},{once:!0}),i.classList.remove("hidden")})}async function U(){if(b)try{C=(await ge(F(b,"ingredients"))).docs.map(i=>({id:i.id,...i.data()})),C.sort((i,d)=>i.name.localeCompare(d.name))}catch(s){console.error("Erreur lors de la récupération des ingrédients: ",s)}}function A(){if(!m)l={},c={},f={},L=1,o="Lundi";else{const s=m.weeks?m.weeks[a]||{}:{};l=s.menuData||{},c=s.servingsData||{},f=s.remarksData||{},L=m.defaultNumPeople||1,o=m.startDay||"Lundi"}if(e.startDaySelect&&(e.startDaySelect.value=o),e.defaultServingsControl){e.defaultServingsControl.innerHTML="";const s=t(L,async i=>{L=i,m&&await T({defaultNumPeople:i},`a changé le nombre de personnes par défaut à ${i}`)});e.defaultServingsControl.appendChild(s)}Ln(),Ie(e.mealPlanGrid,{menuData:l,servingsData:c,remarksData:f,defaultNumPeople:L,startDay:o},!1),Ee(document.getElementById("mobile-meal-plan"),{menuData:l,servingsData:c,remarksData:f,defaultNumPeople:L,startDay:o},!1),W()}async function T(s,i){if(!m)return;await $t(m.id,m,i);const d=$(b,"plans",m.id);try{await Te(d,{...s,lastUpdated:new Date})}catch(u){console.error("Error updating plan:",u),alert("Une erreur de sauvegarde est survenue.")}}function z(){e.planHistoryModal.classList.add("hidden")}async function X(s){if(m&&confirm("Voulez-vous vraiment restaurer cette version ? L'état actuel sera sauvegardé dans l'historique avant la restauration."))try{const i=$(b,"plans",m.id,"history",s),d=await Le(i);if(!d.exists())throw new Error("Version de l'historique non trouvée.");const u=d.data().planState;await $t(m.id,m);const r=$(b,"plans",m.id);await ct(r,u),z()}catch(i){console.error("Erreur lors du rollback :",i)}}async function Ce(s,i){if(m&&confirm("Êtes-vous sûr de vouloir supprimer définitivement cette entrée de l'historique ?"))try{const d=$(b,"plans",m.id,"history",s);await Ae(d),i.remove()}catch(d){console.error("Erreur lors de la suppression de l'historique :",d),alert("Une erreur est survenue lors de la suppression.")}}async function xe(){if(m){e.planHistoryList.innerHTML="<p>Chargement de l'historique...</p>",e.planHistoryModal.classList.remove("hidden");try{const s=F(b,"plans",m.id,"history"),i=me(s,Hn("timestamp","desc")),d=await ge(i);if(e.planHistoryList.innerHTML="",d.empty){e.planHistoryList.innerHTML="<p>Aucun historique pour ce plan.</p>";return}d.forEach(u=>{const r=u.data(),g=document.createElement("div");g.className="p-3 border-b flex justify-between items-center";const h=document.createElement("div"),p=r.timestamp?.toDate().toLocaleString("fr-FR")||"Date inconnue",v=r.description||"Modification diverse",k=r.modifiedByName||"Inconnu";h.innerHTML=`
                    <p class="font-medium">${k} ${v}</p>
                    <p class="text-sm text-gray-500">${p}</p>
                `;const w=document.createElement("div");w.className="flex items-center space-x-2";const I=document.createElement("button");I.className="btn btn-secondary btn-sm",I.textContent="Revenir à cette version",I.addEventListener("click",()=>X(u.id));const D=document.createElement("button");D.className="btn btn-ghost text-red-500 hover:bg-red-100 btn-sm",D.innerHTML='<i class="fas fa-times"></i>',D.title="Supprimer cette version",D.addEventListener("click",j=>{j.stopPropagation(),Ce(u.id,g)}),w.appendChild(I),w.appendChild(D),g.appendChild(h),g.appendChild(w),e.planHistoryList.appendChild(g)})}catch(s){console.error("Erreur de chargement de l'historique:",s),e.planHistoryList.innerHTML=`<p class="text-red-500">Impossible de charger l'historique.</p>`}}}function Ee(s,i,d=!1){if(!s)return;const u=i.menuData||{},r=i.servingsData||{},g=i.remarksData||{},h=i.defaultNumPeople||1,p=i.startDay||"Lundi";s.innerHTML="";const v=document.createDocumentFragment(),k=R.indexOf(p);[...R.slice(k),...R.slice(0,k)].forEach(I=>{const D=R.indexOf(I),j=document.createElement("div");j.className="bg-blue-100 border border-blue-300 rounded-xl shadow-md p-4 mb-4";const te=document.createElement("h3");te.className="text-xl font-bold text-gray-800 mb-3",te.textContent=I.toUpperCase(),j.appendChild(te);const ae=document.createElement("div");ae.className="space-y-4",["lunch","dinner"].forEach(ie=>{const oe=document.createElement("div");oe.className=`border-t pt-3 ${ie==="lunch"?"bg-amber-50":"bg-stone-100"} rounded-lg p-2`;const fe=document.createElement("div");fe.className="flex justify-between items-center mb-2";const ne=document.createElement("h4");if(ne.className="text-lg font-semibold text-tomato",ne.textContent=ie==="lunch"?"Midi":"Soir",fe.appendChild(ne),!d){const ue=`${D}-${ie}`,Be=r[ue]||h,he=t(Be,_e=>{Ot(ue,_e)});fe.appendChild(he)}oe.appendChild(fe);const Me=document.createElement("div");Me.className="space-y-2";let le=!1;const ce=["Entrée","Plat","Accompagnement","Dessert","Remarque"];for(let ue=0;ue<ce.length;ue++){const Be=ce[ue],he=`${D}-${ie}-${ue}`,_e=u[he],ke=document.createElement("div");ke.className="mb-2";const tt=document.createElement("h5");if(tt.className="text-md font-semibold text-gray-700 mb-1",tt.textContent=Be,ke.appendChild(tt),Be==="Remarque")ke.appendChild(We(he,g,d));else{const je=document.createElement("div");if(je.className="space-y-1",Array.isArray(_e)&&_e.length>0&&(le=!0,_e.forEach(($e,Ge)=>{const Oe=E.find(ve=>ve.id===$e.id);if(Oe){const ve=ee(Oe,he,Ge,d);if(ve.classList.remove("bg-white","shadow-sm"),ve.classList.add("bg-emerald-200","border","border-emerald-400"),!d){const ze=ve.querySelector(".edit-meal-btn"),zt=ve.querySelector(".delete-meal-btn");ze&&ze.classList.remove("hidden"),zt&&zt.classList.remove("hidden")}je.appendChild(ve)}})),d)le||(je.innerHTML='<p class="text-sm text-gray-500 italic">Aucun plat prévu.</p>');else{const $e=document.createElement("button");$e.className="btn btn-outline btn-sm w-full mt-2",$e.innerHTML=`<i class="fas fa-plus mr-2"></i> Ajouter une ${Be.toLowerCase()}`,$e.addEventListener("click",()=>{se(he)}),je.appendChild($e)}ke.appendChild(je)}Me.appendChild(ke)}oe.appendChild(Me),ae.appendChild(oe)}),j.appendChild(ae),v.appendChild(j)}),s.appendChild(v)}function Ie(s,i,d=!1){if(!s)return;const u=i.menuData||{},r=i.servingsData||{},g=i.remarksData||{},h=i.defaultNumPeople||1,p=i.startDay||"Lundi",v=document.createDocumentFragment(),k=["lunch","dinner"],w=5,I=R.indexOf(p);[...R.slice(I),...R.slice(0,I)].forEach(j=>{const te=R.indexOf(j),ae=document.createElement("div");ae.className="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] items-stretch border-b border-gray-300";const ie=document.createElement("div");ie.className="font-bold p-2 flex items-center justify-center bg-gray-100 text-sm border-r border-gray-300",ie.textContent=j.toUpperCase(),ae.appendChild(ie),k.forEach(oe=>{const fe=`${te}-${oe}`,ne=r[fe]||h,Me=r.hasOwnProperty(fe),le=document.createElement("div"),ce=n(ne,Me,Be=>{Ot(fe,Be)},d);let ue="border-r border-gray-300 flex items-center justify-center transition-colors duration-300";Me?ue+=" bg-tomato":ue+=oe==="lunch"?" bg-amber-50":" bg-stone-100",le.className=ue,le.appendChild(ce),ae.appendChild(le);for(let Be=0;Be<w;Be++){const he=`${te}-${oe}-${Be}`,_e=u[he],ke=document.createElement("div"),tt=H(he);let je="meal-slot p-1 min-h-[70px] flex flex-col justify-start border-r border-gray-300";if(je+=oe==="lunch"?" bg-amber-50":" bg-stone-100",ke.className=je,ke.dataset.slotId=he,tt==="Remarque")ke.appendChild(We(he,g,d));else if(Array.isArray(_e)&&_e.length>0){const $e=document.createElement("div");$e.className="w-full",_e.forEach((Ge,Oe)=>{const ve=E.find(ze=>ze.id===Ge.id);if(ve)$e.appendChild(ee(ve,he,Oe,d));else{const ze=document.createElement("div");ze.className="p-1 bg-red-100 text-red-700 rounded shadow-sm text-center text-xs font-medium",ze.textContent="Recette supprimée",$e.appendChild(ze)}}),ke.appendChild($e),d||ke.appendChild(Ye(he,!0))}else d||ke.appendChild(Ye(he,!1));ae.appendChild(ke)}}),v.appendChild(ae)}),s.innerHTML="",s.appendChild(v),d||Ke()}async function we(){const s=ye();if(!b||!s)return[];try{const i=me(F(b,"shopping_lists"),Z("userId","==",s));return(await ge(i)).docs.map(g=>({id:g.id,...g.data()})).filter(g=>g.isShared!==!0)}catch(i){return console.error("Erreur de chargement des listes de courses sauvegardées: ",i),[]}}async function Pe(){const s=await we();if(e.importListContainer.innerHTML="",s.length===0){e.importListContainer.innerHTML='<p class="text-center text-gray-500">Aucune liste sauvegardée.</p>';return}s.forEach(i=>{const d=document.createElement("button");d.className="w-full text-left p-2 hover:bg-gray-100 rounded-lg transition-colors duration-150",d.textContent=i.name,d.addEventListener("click",()=>{confirm(`Voulez-vous vraiment importer les ingrédients de la liste "${i.name}" ?`)&&(i.ingredients.forEach(u=>{const r=parseFloat(String(u.quantity).replace(",","."))||0;Y(u.name,r,u.unit)}),Ue())}),e.importListContainer.appendChild(d)}),e.importListModal.classList.remove("hidden")}function Ue(){e.importListModal.classList.add("hidden")}function O(){e.addItemInput?.addEventListener("input",()=>{const s=e.addItemInput.value.toLowerCase(),i=e.addItemResults;if(i.innerHTML="",!s){i.classList.add("hidden");return}C.filter(r=>r.name.toLowerCase().includes(s)).forEach(r=>{const g=document.createElement("div");g.className="p-2 hover:bg-gray-100 cursor-pointer",g.textContent=r.name,g.addEventListener("click",()=>{Y(r.name,1,r.unit),e.addItemInput.value="",i.classList.add("hidden")}),i.appendChild(g)});const u=document.createElement("div");u.className="p-2 bg-green-50 hover:bg-green-200 cursor-pointer font-bold text-green-700",u.textContent=`+ Créer "${e.addItemInput.value}"`,u.addEventListener("click",async()=>{const r=e.addItemInput.value;try{const g=await De(r);await Ne(F(b,"ingredients"),{name:r,unit:g}),await U(),Y(r,1,g),e.addItemInput.value="",i.classList.add("hidden")}catch{}}),i.appendChild(u),i.classList.remove("hidden")}),e.addItemBtn?.addEventListener("click",()=>{const s=e.addItemInput.value;s&&(Y(s,1,""),e.addItemInput.value="",e.addItemResults.classList.add("hidden"))}),document.addEventListener("click",s=>{e.addItemInput&&!e.addItemInput.contains(s.target)&&!e.addItemResults.contains(s.target)&&e.addItemResults.classList.add("hidden")})}function S(){if(y.length===0){alert("La liste de courses est vide.");return}const s=y.reduce((r,g)=>{const h=g.category||"Inconnue";return r[h]||(r[h]=[]),r[h].push(g),r},{}),i=Object.keys(s).sort((r,g)=>r==="Inconnue"?1:g==="Inconnue"?-1:r.localeCompare(g));let d=`Liste de courses - GustoPlan

`;i.forEach(r=>{d+=`--- ${r.toUpperCase()} ---
`,s[r].sort((h,p)=>h.name.localeCompare(p.name)).forEach(h=>{let v=`${Number.isInteger(h.totalQuantity)?h.totalQuantity:parseFloat(h.totalQuantity.toFixed(2))} ${h.unit||""} ${h.name}`;if(h.sources&&h.sources.length>0){const k=h.sources.reduce((I,D)=>{const j=`${D.recipeName} (${D.day} ${D.time})`;return I[j]||(I[j]=0),I[j]+=D.quantity,I},{}),w=Object.keys(k).join(" / ");v+=` *** ${w} ***`}d+=v+`
`}),d+=`
`});const u=new Blob([d],{type:"text/plain;charset=utf-8"});saveAs(u,"liste-de-courses.txt")}function Q(){if(y.length===0){alert("La liste de courses est vide.");return}const{jsPDF:s}=window.jspdf,i=new s,d=y.reduce((v,k)=>{const w=k.category||"Inconnue";return v[w]||(v[w]=[]),v[w].push(k),v},{}),u=Object.keys(d).sort((v,k)=>v==="Inconnue"?1:k==="Inconnue"?-1:v.localeCompare(k));i.setFontSize(18),i.text("Liste de courses - GustoPlan",14,22);let r=35;const g=i.internal.pageSize.height,h=20,p=()=>{r>g-h&&(i.addPage(),r=20)};u.forEach(v=>{p(),i.setFontSize(14),i.setFont(void 0,"bold"),i.text(`--- ${v.toUpperCase()} ---`,14,r),r+=8,i.setFont(void 0,"normal"),d[v].sort((w,I)=>w.name.localeCompare(I.name)).forEach(w=>{p(),i.setFontSize(12);const I=Number.isInteger(w.totalQuantity)?w.totalQuantity:parseFloat(w.totalQuantity.toFixed(2));if(i.text(`${I} ${w.unit||""} ${w.name}`,14,r),r+=6,w.sources&&w.sources.length>0){const D=w.sources.reduce((j,te)=>{const ae=`${te.recipeName} (${te.day} ${te.time})`;return j[ae]||(j[ae]=0),j[ae]+=te.quantity,j},{});i.setFontSize(9),i.setTextColor(100);for(const j in D)p(),i.text(`  * ${j}`,18,r),r+=5;i.setTextColor(0)}r+=2}),r+=5}),i.save("liste-de-courses.pdf")}async function J(){if(!m){alert("Veuillez sélectionner un plan à exporter.");return}const s=document.getElementById("loading-overlay");s&&s.classList.remove("hidden");try{const{jsPDF:i}=window.jspdf,d=new i,u=$(b,"plans",m.id),r=await Le(u),g=r.exists()?r.data():null;if(!g||!g.weeks){alert("Ce plan est vide et ne peut pas être exporté.");return}d.setFontSize(18),d.text(`Plan de Repas: ${g.name}`,14,20);const h=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"],p={0:"E",1:"P",2:"A",3:"D"},v=Object.keys(g.weeks).sort((w,I)=>parseInt(w)-parseInt(I));let k=!0;for(const w of v){const D=g.weeks[w].menuData||{};if(Object.keys(D).length===0)continue;const j=[["Jour","Midi","Soir"]],te=[],ae=h.indexOf(g.startDay||"Lundi"),ie=[...h.slice(ae),...h.slice(0,ae)];for(const fe of ie){const ne=h.indexOf(fe);let Me=[],le=[];for(const ce of["lunch","dinner"])for(const ue in p){const Be=`${ne}-${ce}-${ue}`;D[Be]&&Array.isArray(D[Be])&&D[Be].forEach(he=>{const _e=`[${p[ue]}] ${he.name}`;ce==="lunch"?Me.push(_e):le.push(_e)})}te.push([fe,Me.join(`
`)||"-",le.join(`
`)||"-"])}d.setFontSize(14);const oe=k?30:d.autoTable.previous.finalY+20;d.text(`Semaine ${w}`,14,oe-5),d.autoTable({startY:oe,head:j,body:te,theme:"grid",styles:{cellPadding:2,fontSize:8,valign:"middle"},headStyles:{fillColor:[41,128,185],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[245,245,245]}}),k=!1}d.save(`plan_${g.name.replace(/ /g,"_")}.pdf`)}catch(i){console.error("Erreur lors de la génération du PDF du plan :",i),alert("Une erreur est survenue lors de la création du PDF.")}finally{s&&s.classList.add("hidden")}}async function Y(s,i,d,u=!1){if(!m)return alert("Veuillez sélectionner un plan.");const r=$(b,"plans",m.id);try{await jn(b,async g=>{const h=await g.get(r);if(!h.exists())throw"Le plan n'existe plus.";const p=h.data().manualItems||[],v=`${s.trim().toLowerCase()}_${d||""}`,k=p.findIndex(I=>`${I.name.trim().toLowerCase()}_${I.unit||""}`===v);if(k>-1)p[k].totalQuantity+=i;else{const I=C.find(D=>D.name.toLowerCase()===s.trim().toLowerCase());p.push({name:s.trim(),totalQuantity:i,unit:d,source:"manual",category:I?.category||"Inconnue"})}const w=p.filter(I=>I.totalQuantity!==0);g.update(r,{manualItems:w,lastUpdated:new Date})})}catch(g){console.error("Erreur transactionnelle lors de l'ajustement de l'ingrédient: ",g),alert("Une erreur de synchronisation est survenue. Veuillez réessayer.")}}function K(s){const i=s?s.toLowerCase():"";return i.includes("g")||i.includes("ml")?10:1}function pe(){const s=e.shoppingListContainer;if(!s)return;if(s.innerHTML="",y.length===0){s.innerHTML='<p class="text-center text-gray-500 italic py-4">Votre liste de courses est vide.</p>';return}const i=y.reduce((u,r)=>{const g=r.category||"Inconnue";return u[g]||(u[g]=[]),u[g].push(r),u},{});Object.keys(i).sort((u,r)=>u==="Inconnue"?1:r==="Inconnue"?-1:u.localeCompare(r)).forEach(u=>{const r=document.createElement("h4");r.className="text-sm font-bold text-stone-800 bg-stone-200 mt-4 mb-2 px-3 py-1 rounded-md",r.textContent=u,s.appendChild(r);const g=document.createElement("ul");g.className="space-y-2",i[u].sort((p,v)=>p.name.localeCompare(v.name)).forEach(p=>{const v=document.createElement("li");let k="p-2 rounded";v.className=k+(p.source==="manual"?" bg-lemon":" bg-gray-50");const w=document.createElement("div");w.className="flex justify-between items-center";const I=document.createElement("span");I.className="flex-grow text-sm font-medium",I.textContent=p.name,w.appendChild(I);const D=document.createElement("div");D.className="flex items-center space-x-2 mx-2";const j=document.createElement("span");j.className="font-medium w-20 text-center text-sm";const te=Number.isInteger(p.totalQuantity)?p.totalQuantity:parseFloat(p.totalQuantity.toFixed(2));j.textContent=`${te} ${p.unit||""}`.trim();const ae=document.createElement("div");ae.className="flex flex-col";const ie=document.createElement("button");ie.className="btn btn-outline btn-xs rounded-b-none",ie.textContent="+",ie.addEventListener("click",async()=>{const ne=K(p.unit);await Y(p.name,ne,p.unit)});const oe=document.createElement("button");oe.className="btn btn-outline btn-xs rounded-t-none -mt-px",oe.textContent="-",oe.addEventListener("click",async()=>{const ne=K(p.unit);await Y(p.name,-ne,p.unit)}),ae.appendChild(ie),ae.appendChild(oe),D.appendChild(j),D.appendChild(ae),w.appendChild(D);const fe=document.createElement("button");if(fe.className="delete-item-btn text-red-500 hover:text-red-700",fe.innerHTML='<i class="fas fa-trash-alt"></i>',fe.addEventListener("click",()=>{Y(p.name,-p.totalQuantity,p.unit,!0)}),w.appendChild(fe),v.appendChild(w),p.sources&&p.sources.length>0){const ne=document.createElement("div");ne.className="p-2 mt-1 ml-4 rounded-md bg-stone-100";const Me=p.sources.reduce((le,ce)=>{const ue=`${ce.recipeName} (${ce.day} ${ce.time})`;return le[ue]||(le[ue]=0),le[ue]+=ce.quantity,le},{});for(const le in Me){const ce=document.createElement("span");ce.className="block text-xs text-gray-500",ce.textContent=`↳ ${le}`,ne.appendChild(ce)}v.appendChild(ne)}g.appendChild(v)}),s.appendChild(g)})}async function W(){if(!m){y.length=0,pe();return}const s=m.manualItems?JSON.parse(JSON.stringify(m.manualItems)):[],i=new Map(s.map(r=>[`${r.name.trim().toLowerCase()}_${r.unit||""}`,r])),d=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];if(m.weeks)for(const r in m.weeks){const g=m.weeks[r],h=g.menuData||{},p=g.servingsData||{};for(const v in h){const k=h[v];if(!Array.isArray(k))continue;const[w,I]=v.split("-"),D=parseInt(w,10),j=d[D]||"Jour inconnu",te=I==="lunch"?"midi":"soir",ae=`${D}-${I}`,ie=parseInt(p[ae]||m.defaultNumPeople,10);for(const oe of k){const ne=E.find(le=>le.id===oe.id)||oe;if(!ne||!Array.isArray(ne.ingredients))continue;const Me=ne.servings||1;Me<=0||ne.ingredients.forEach(le=>{const{name:ce,quantity:ue,unit:Be}=le;if(!ce||!ue)return;const he=C.find(ve=>ve.name.toLowerCase()===ce.trim().toLowerCase()),_e=he?he.category:"Inconnue",ke=parseFloat(String(ue).replace(",","."));if(isNaN(ke))return;const je=ke/Me*ie,$e=Be||"",Ge=`${ce.trim().toLowerCase()}_${$e}`,Oe={recipeName:ne.name,day:`${j} (S${r})`,time:te,quantity:je};if(i.has(Ge)){const ve=i.get(Ge);ve.totalQuantity+=je,ve.source==="manual"&&(ve.source="mixed"),Array.isArray(ve.sources)?ve.sources.push(Oe):ve.sources=[Oe]}else i.set(Ge,{name:ce.trim(),totalQuantity:je,unit:$e,source:"plan",category:_e,sources:[Oe]})})}}}const u=Array.from(i.values()).filter(r=>r.totalQuantity>0);y.length=0,y.push(...u.sort((r,g)=>r.name.localeCompare(g.name))),pe()}function se(s){const i=H(s);if(!i||!e.mealSelectModal)return;e.mealSelectModalTitle.textContent=`Sélectionner : ${i}`,e.mealSelectList.innerHTML="";const d=document.createElement("input");d.type="text",d.placeholder="Rechercher dans la catégorie...",d.className="w-full p-2 mb-4 border border-gray-300 rounded-lg",e.mealSelectList.appendChild(d);const u=G(i),r=E.filter(p=>G(p.category)===u).sort((p,v)=>{const k=p.isFavorite?1:0,w=v.isFavorite?1:0;return w!==k?w-k:p.name.localeCompare(v.name)}),g=document.createElement("div");g.className="space-y-1 max-h-80 overflow-y-auto",e.mealSelectList.appendChild(g);function h(p=""){g.innerHTML="";const v=p.toLowerCase(),k=r.filter(w=>w.name.toLowerCase().includes(v));k.length===0?g.innerHTML='<p class="text-gray-500 p-4">Aucun plat ne correspond à votre recherche.</p>':k.forEach(w=>{const I=document.createElement("button");I.className="w-full text-left p-2 hover:bg-gray-100 rounded-lg transition-colors duration-150";const D=document.createElement("p");D.className="font-medium text-gray-800 text-sm",w.isFavorite?D.innerHTML=`${w.name} <i class="fas fa-heart text-red-500 ml-2"></i>`:D.textContent=w.name,I.appendChild(D),I.addEventListener("click",()=>{Ze(s,w),re()}),g.appendChild(I)})}d.addEventListener("input",p=>h(p.target.value)),h(),e.mealSelectModal.classList.remove("hidden"),d.focus()}function re(){e.mealSelectModal&&e.mealSelectModal.classList.add("hidden")}function Se(s){x=s.target.closest(".meal-card");const i=x.closest(".meal-slot").dataset.slotId;s.dataTransfer.setData("text/plain",i),setTimeout(()=>{x&&(x.style.opacity="0.5")},0)}function q(){x&&(x.style.opacity="1",x=null)}function _(s){s.preventDefault();const i=s.target.closest(".meal-slot");i&&H(i.dataset.slotId)!=="Remarque"&&i.classList.add("bg-gray-200")}function M(s){const i=s.target.closest(".meal-slot");i&&i.classList.remove("bg-gray-200")}async function B(s){s.preventDefault();const i=s.dataTransfer.getData("text/plain"),d=s.target.closest(".meal-slot");if(d){d.classList.remove("bg-gray-200");const u=d.dataset.slotId,r=H(u);if(r==="Remarque")return;if(i&&u&&i!==u){const g=l[i],h=H(i);if(G(h)!==G(r)){alert(`Action impossible : un(e) "${h}" ne peut pas aller dans la catégorie "${r}".`);return}const p=l[u];l[u]=g,p?l[i]=p:delete l[i],Ie(e.mealPlanGrid,{menuData:l,servingsData:c,remarksData:f,defaultNumPeople:L,startDay:o},!1),await T({[`weeks.${a}.menuData`]:l},"a déplacé un plat"),await W()}}}function H(s){switch(s.split("-")[2]){case"0":return"Entrée";case"1":return"Plat";case"2":return"Accompagnement";case"3":return"Dessert";case"4":return"Remarque";default:return""}}function ee(s,i,d,u=!1){const r=document.createElement("div");if(r.className="meal-card p-1 flex flex-col items-center bg-white rounded shadow-sm text-center relative w-full mb-1",u||(r.classList.add("cursor-grab"),r.draggable=!0),!u){const v=document.createElement("button");v.className="absolute -top-2 -right-1 text-base",v.innerHTML='<i class="fas fa-heart"></i>',s.isFavorite?v.classList.add("text-red-500"):v.classList.add("text-gray-300","hover:text-red-400"),v.addEventListener("click",k=>{k.stopPropagation(),At(s.id,s.isFavorite)}),v.addEventListener("mousedown",k=>k.stopPropagation()),r.appendChild(v)}const g=document.createElement("span");if(g.className="text-xs font-medium p-1 break-words w-full",g.textContent=s.name,s.imageUrl){const v=document.createElement("img");v.src=s.imageUrl,v.alt=s.name,v.className="w-16 h-12 object-cover rounded-md mx-auto",r.appendChild(v)}if(r.appendChild(g),!u){const v=document.createElement("div");v.className="absolute top-0 left-0 flex";const k=document.createElement("button");k.className="edit-meal-btn text-gray-600 hover:text-gray-800 hidden px-1 py-0.5",k.innerHTML='<i class="fas fa-pencil-alt fa-xs"></i>',k.title="Modifier la recette",k.addEventListener("click",I=>{I.stopPropagation();const D=E.find(j=>j.id===s.id);Ve.openForm(D||s,"Modifier la recette")}),k.addEventListener("mousedown",I=>I.stopPropagation()),v.appendChild(k);const w=document.createElement("button");w.className="delete-meal-btn text-red-700 hover:text-red-900 hidden px-1 py-0.5",w.innerHTML='<i class="fas fa-times-circle fa-xs"></i>',w.title="Retirer du planning",w.addEventListener("click",I=>{I.stopPropagation(),et(i,d)}),w.addEventListener("mousedown",I=>I.stopPropagation()),v.appendChild(w),r.appendChild(v),r.addEventListener("mouseenter",()=>{k.classList.remove("hidden"),w.classList.remove("hidden")}),r.addEventListener("mouseleave",()=>{k.classList.add("hidden"),w.classList.add("hidden")})}const h=document.createElement("div");h.className="absolute bottom-1 right-1";const p=document.createElement("button");return p.className="info-meal-btn bg-gray-500 text-white hover:bg-gray-600 rounded w-3 h-3 flex items-center justify-center shadow-sm",p.innerHTML='<i class="fas fa-plus fa-xs"></i>',p.title="Plus d'infos",p.dataset.slotId=i,p.dataset.mealIndex=d,p.addEventListener("mousedown",v=>v.stopPropagation()),h.appendChild(p),r.appendChild(h),r}function Je(s,i){if(document.querySelectorAll(".planner-ingredient-tooltip").forEach(h=>h.remove()),P===s){s.classList.remove("info-open"),s.innerHTML='<i class="fas fa-plus fa-xs"></i>',P=null;return}P&&(P.classList.remove("info-open"),P.innerHTML='<i class="fas fa-plus fa-xs"></i>'),s.classList.add("info-open"),s.innerHTML='<i class="fas fa-times fa-xs"></i>',P=s;const d=document.createElement("div");if(d.className="planner-ingredient-tooltip z-50 w-64 p-3 bg-white border border-gray-200 rounded-lg shadow-lg text-left text-sm",i.ingredients&&i.ingredients.length>0){if(i.servings&&i.servings>0){const v=document.createElement("p");v.className="mb-2 text-sm text-gray-600 flex items-center",v.innerHTML=`<i class="fas fa-users mr-2"></i> Pour ${i.servings} ${i.servings>1?"personnes":"personne"}`,d.appendChild(v)}const h=document.createElement("h4");h.className="font-bold mb-2 text-gray-800",h.textContent="Ingrédients :",d.appendChild(h);const p=document.createElement("ul");p.className="space-y-1 text-gray-600",i.ingredients.forEach(v=>{const k=document.createElement("li");k.textContent=`• ${v.quantity||""} ${v.unit||""} ${v.name}`.trim(),p.appendChild(k)}),d.appendChild(p)}else d.textContent="Aucun ingrédient spécifié pour cette recette.";document.body.appendChild(d);const u=s.closest(".meal-card").getBoundingClientRect(),r=d.getBoundingClientRect();if(window.innerWidth<768){d.style.width="90vw",d.style.maxWidth="320px";const h=d.getBoundingClientRect();let p=u.bottom+10,v=(window.innerWidth-h.width)/2;p+h.height>window.innerHeight&&(p=u.top-h.height-10),d.style.top=`${p}px`,d.style.left=`${v}px`}else{let h=u.right+10;h+r.width>window.innerWidth&&(h=u.left-r.width-10);let p=u.top;p+r.height>window.innerHeight&&(p=u.bottom-r.height),p<10&&(p=10),d.style.left=`${h}px`,d.style.top=`${p}px`}d.style.position="fixed"}function Ye(s,i=!1){const d=document.createElement("div"),u=document.createElement("button");return i?(d.className="w-full flex justify-center pt-1",u.className="add-more-meal-btn text-gray-400 hover:text-green-500 transition-colors duration-150",u.innerHTML='<i class="fas fa-plus-circle"></i>',u.title="Ajouter une autre recette"):(d.className="flex items-center justify-center h-full",u.className="add-meal-btn text-green-500 hover:text-green-700 transition-transform duration-150 hover:scale-125",u.innerHTML='<i class="fas fa-plus-circle text-lg"></i>'),u.addEventListener("click",()=>se(s)),d.appendChild(u),d}function We(s,i,d=!1){if(d){const r=document.createElement("p");return r.className="w-full h-full p-1 text-xs text-gray-700",r.textContent=i[s]||"",r}const u=document.createElement("textarea");return u.className="w-full h-full p-1 text-xs bg-white border-0 rounded focus:outline-none focus:ring-1 focus:ring-tomato resize-none",u.placeholder="Remarque...",u.value=f[s]||"",u.dataset.slotId=s,u.addEventListener("change",r=>{const g=r.target.value;g?f[s]=g:delete f[s];const[h,p]=s.split("-"),w=`a modifié la remarque pour ${R[parseInt(h,10)]} ${p==="lunch"?"midi":"soir"}`;T({[`weeks.${a}.remarksData`]:f},w)}),u.addEventListener("focus",r=>{gt({type:"editing_remark",fieldId:s})}),u.addEventListener("blur",r=>{gt("idle")}),u}function Ke(){document.querySelectorAll(".meal-card").forEach(s=>{s.addEventListener("dragstart",Se),s.addEventListener("dragend",q)}),document.querySelectorAll(".meal-slot").forEach(s=>{s.addEventListener("dragover",_),s.addEventListener("dragleave",M),s.addEventListener("drop",B)})}async function Ze(s,i){const d=JSON.parse(JSON.stringify(l)),u=d[s],r={id:i.id};Array.isArray(u)?u.push(r):d[s]=[r];const[g,h]=s.split("-"),p=R[parseInt(g,10)],v=h==="lunch"?"midi":"soir",k=`a ajouté '${i.name}' à ${p} ${v}`;await T({[`weeks.${a}.menuData`]:d},k),re()}async function et(s,i){if(!m||!l[s]||!Array.isArray(l[s]))return;const d=l[s][i],u=JSON.parse(JSON.stringify(l));u[s].splice(i,1),u[s].length===0&&delete u[s];const[r,g]=s.split("-"),h=R[parseInt(r,10)],p=g==="lunch"?"midi":"soir",v=`a supprimé '${d.name}' de ${h} ${p}`;await T({[`weeks.${a}.menuData`]:u},v)}async function qt(){if(confirm("Voulez-vous vraiment vider le menu de cette semaine ?")){const s={id:availablePlans.length>0?availablePlans[0].id:`${ye()}_semaine-${a}`,name:availablePlans.length>0?availablePlans[0].name:"Mon plan",menuData:{},servingsData:{},remarksData:{},defaultNumPeople:L,startDay:o,lastUpdated:new Date};loadPlan(s),availablePlans.length>0?availablePlans[0]=s:availablePlans.push(s),await T({[`weeks.${a}`]:{menuData:{},servingsData:{},remarksData:{}}},`a vidé le menu de la semaine ${a}`)}}function Ut(s){s>=1&&s<=52&&(a=s,A())}function Ln(){e.currentWeekDisplay&&(e.currentWeekDisplay.textContent=`Semaine ${a}`)}function Cn(){e.prevWeekBtn?.addEventListener("click",()=>Ut(a-1)),e.nextWeekBtn?.addEventListener("click",()=>Ut(a+1)),e.clearMenuBtn?.addEventListener("click",qt),e.startDaySelect?.addEventListener("change",async d=>{o=d.target.value,m&&await T({startDay:o},`a changé le premier jour de la semaine à '${o}'`)}),e.planSelect?.addEventListener("change",Ft),e.closeMealSelectModalBtn?.addEventListener("click",re),e.mealSelectModal?.addEventListener("click",d=>{d.target===e.mealSelectModal&&re()}),e.closeRecipeModalBtn?.addEventListener("click",()=>Ve.closeForm()),e.cancelRecipeBtn?.addEventListener("click",()=>Ve.closeForm()),e.importListBtn?.addEventListener("click",Pe),e.closeImportListModalBtn?.addEventListener("click",Ue),e.importListModal?.addEventListener("click",d=>{d.target===e.importListModal&&Ue()}),e.exportTxtBtn?.addEventListener("click",S),e.exportPdfBtn?.addEventListener("click",Q),e.exportPlanPdfBtn?.addEventListener("click",J);const s=d=>{const u=d.target.closest(".info-meal-btn");if(u){const r=u.dataset.slotId,g=parseInt(u.dataset.mealIndex,10);if(r&&!isNaN(g)){const h=l[r]?.[g];if(h&&h.id){const p=E.find(v=>v.id===h.id);p&&Je(u,p)}}}};e.mealPlanGrid?.addEventListener("click",s),document.getElementById("mobile-meal-plan")?.addEventListener("click",s),e.sharePlanBtn?.addEventListener("click",()=>{if(!m){alert("Veuillez sélectionner un plan à partager.");return}Rt({plan:m})}),e.inviteParticipantBtn?.addEventListener("click",()=>{if(!m){alert("Veuillez sélectionner un plan pour inviter des participants.");return}rn(m)}),e.historyPlanBtn?.addEventListener("click",xe),e.closePlanHistoryModalBtn?.addEventListener("click",z),e.planHistoryModal?.addEventListener("click",d=>{d.target===e.planHistoryModal&&z()}),e.savePlanBtn?.addEventListener("click",async()=>{if(!m){alert("Veuillez sélectionner un plan de travail avant de sauvegarder.");return}const d=document.getElementById("save-plan-as-modal"),u=document.getElementById("save-plan-as-form"),r=document.getElementById("save-plan-name"),g=document.getElementById("cancel-save-plan-as-btn"),h=document.getElementById("close-save-plan-as-modal"),p=new Date().toLocaleDateString("fr-FR"),v=m.weeks?Object.keys(m.weeks).filter(D=>m.weeks[D]&&Object.keys(m.weeks[D].menuData||{}).length>0).length:0,k=v>1?`${v} semaines`:`${v} semaine`;r.value=`${m.name} (${k}) - ${p}`,d.classList.remove("hidden");const w=async D=>{D.preventDefault();const j=r.value;if(!j)return;m.weeks||(m.weeks={}),m.weeks[a]={menuData:l,servingsData:c,remarksData:f},m.startDay=o,m.defaultNumPeople=L;const te=JSON.parse(JSON.stringify(m));if(te.weeks)for(const ae in te.weeks){const ie=te.weeks[ae];if(ie&&ie.menuData)for(const oe in ie.menuData){const fe=ie.menuData[oe];Array.isArray(fe)&&(ie.menuData[oe]=fe.map(ne=>ne&&ne.id&&E.find(le=>le.id===ne.id)||ne))}}await pn(j,te),d.classList.add("hidden"),u.removeEventListener("submit",w)},I=()=>{d.classList.add("hidden"),u.removeEventListener("submit",w)};u.addEventListener("submit",w,{once:!0}),g.addEventListener("click",I,{once:!0}),h.addEventListener("click",I,{once:!0})})}function In(s=""){return s.split(" ").map(u=>u[0]).join("").substring(0,2).toUpperCase()}function Et(s=[],i={}){const d=document.getElementById("collaborators-bar"),u=document.getElementById("activity-labels-container"),r=document.getElementById("name-tooltip");if(!d||!r||!u)return;if(d.innerHTML="",u.innerHTML="",document.querySelectorAll(".remark-lock-overlay").forEach(p=>p.remove()),document.querySelectorAll("textarea[data-slot-id]").forEach(p=>{p.disabled=!1}),s.length<=1&&Object.keys(i).length<=1){d.classList.add("hidden");return}let g="";const h=ye();s.forEach(p=>{if(!p)return;const v=i.hasOwnProperty(p.uid),k=i[p.uid]||{},w=document.createElement("div");w.className="w-8 h-8 rounded-full flex items-center justify-center bg-gray-300 text-white font-bold text-xs ring-2 ring-white cursor-pointer transition-all duration-300";const I=v?"(présent)":"(absent)";if(w.dataset.name=`${p.displayName||"Inconnu"} ${I}`,p.photoURL?w.innerHTML=`<img src="${p.photoURL}" alt="${p.displayName}" class="w-full h-full rounded-full object-cover">`:w.textContent=In(p.displayName),v||w.classList.add("grayscale","opacity-50"),w.addEventListener("mouseenter",D=>{r.textContent=D.currentTarget.dataset.name,r.classList.remove("hidden");const j=D.currentTarget.getBoundingClientRect();r.style.left=`${j.left+j.width/2-r.offsetWidth/2}px`,r.style.top=`${j.top-r.offsetHeight-5}px`}),w.addEventListener("mouseleave",()=>{r.classList.add("hidden")}),d.appendChild(w),v&&p.uid!==h){const D=k.status;if(typeof D=="object"&&D.type==="editing_remark"){const j=document.querySelector(`textarea[data-slot-id="${D.fieldId}"]`);if(j){j.disabled=!0;const te=document.createElement("div");te.className="remark-lock-overlay absolute inset-0 bg-gray-400 bg-opacity-25 flex items-center justify-center text-xs text-white font-bold",te.innerHTML=`<i class="fas fa-lock mr-1"></i> ${p.displayName} écrit...`,j.parentElement&&(j.parentElement.classList.add("relative"),j.parentElement.appendChild(te))}}else if(typeof D=="string"&&D!=="idle"){let j="";switch(D){case"editing_recipe":j="modifie une recette...";break}j&&(g+=`<span class="italic mr-4">${p.displayName} ${j}</span>`)}}}),u.innerHTML=g,d.classList.remove("hidden")}function Ft(){En();const s=e.planSelect.value;m=N.find(h=>h.id===s)||null;const i=document.getElementById("delete-plan-btn"),d=document.getElementById("rename-plan-btn"),u=document.getElementById("leave-plan-btn"),r=document.getElementById("invite-participant-btn"),g=document.getElementById("history-plan-btn");if(i&&(i.style.display=m&&m.isOwner?"inline-flex":"none"),d&&(d.style.display=m&&m.isOwner?"inline-flex":"none"),g&&(g.style.display=m&&m.isOwner?"inline-flex":"none"),u&&(u.style.display=m&&!m.isOwner?"inline-flex":"none"),r){const h=m&&(m.type==="collaborative"||m.collaborators&&m.collaborators.length>0);r.style.display=m&&m.isOwner&&h?"inline-flex":"none"}m&&m.participants&&m.participants.length>1?(Et(m.participants,{}),xn(m.id,h=>{Et(m.participants,h)})):Et([],{}),m&&(m.manualItems=m.manualItems||[]),A()}async function Ot(s,i){if(!m)return;const d=JSON.parse(JSON.stringify(c));i===L?delete d[s]:d[s]=i;const[u,r]=s.split("-"),p=`a changé le nombre de personnes pour ${R[parseInt(u,10)]} ${r==="lunch"?"midi":"soir"} à ${i}`;await T({[`weeks.${a}.servingsData`]:d},p)}async function Bn(){if(!b)return;const s=un();Cn(),O(),await U();const i=Fe(F(b,"recipes"),u=>{if(console.log("Recipe data updated from listener."),E=u.docs.map(r=>{const g=r.data();return{id:r.id,...g,imageUrl:g.imageUrl||""}}),m){for(const r in l){const g=l[r];if(Array.isArray(g)){const h=g.map(p=>{if(p&&p.id){const v=E.find(k=>k.id===p.id);return v?{...v}:p}return p});l[r]=h}}Ie(e.mealPlanGrid,{menuData:l,servingsData:c,remarksData:f,defaultNumPeople:L,startDay:o},!1),Ee(document.getElementById("mobile-meal-plan"),{menuData:l,servingsData:c,remarksData:f,defaultNumPeople:L,startDay:o},!1),W()}}),d=dn(u=>{N=u,cn(u);const r=localStorage.getItem("selectedPlanId");r&&u.some(g=>g.id===r)&&(e.planSelect.value=r,localStorage.removeItem("selectedPlanId")),Ft()});return()=>{d(),i(),s()}}const kn=Bn();return async()=>{const s=await kn;typeof s=="function"&&s()}}const wa=Object.freeze(Object.defineProperty({__proto__:null,default:Ea},Symbol.toStringTag,{value:"Module"}));function La(){const e=wn();return Ht(),()=>{typeof e=="function"&&e()}}async function Ht(){const e=document.getElementById("received-shares-container"),t=ye();if(!(!t||!e)){e.innerHTML='<p class="text-gray-500">Chargement des partages reçus...</p>';try{const n=me(F(b,"plans"),Z("userId","==",t),Z("isShared","==",!0)),a=me(F(b,"plans"),Z("collaborators","array-contains",t)),[o,l]=await Promise.all([ge(n),ge(a)]);let c=[];if(o.forEach(f=>c.push({id:f.id,type:"Planification (Copie)",...f.data()})),l.forEach(f=>c.push({id:f.id,type:"Planification (Collaboratif)",...f.data()})),c.length===0){e.innerHTML=`<p class="text-gray-500">Vous n'avez aucun contenu partagé par d'autres utilisateurs.</p>`;return}c.sort((f,y)=>(y.sharedAt?.seconds||y.lastUpdated?.seconds||0)-(f.sharedAt?.seconds||f.lastUpdated?.seconds||0)),e.innerHTML="";for(const f of c){const y=f.originalOwnerId||f.userId;if(!y)continue;const x=await Le($(b,"users",y)),E=x.exists()?x.data().displayName:"Utilisateur inconnu";e.appendChild(Ca(f,E))}}catch(n){console.error("Erreur lors du chargement des partages reçus : ",n),e.innerHTML='<p class="text-red-500">Une erreur est survenue.</p>'}}}function Ca(e,t){const n=document.createElement("div");n.className="bg-white rounded-lg p-4 flex justify-between items-center shadow-sm";const a=document.createElement("div"),o=document.createElement("p");o.className="font-bold text-gray-800";let l="";e.type.includes("Collaboratif")?l=' <span class="text-xs font-medium bg-blue-100 text-blue-800 px-2 py-1 rounded-full">Collab</span>':e.type.includes("Copie")&&(l=' <span class="text-xs font-medium bg-gray-200 text-gray-800 px-2 py-1 rounded-full">Copie</span>'),o.innerHTML=`${e.name}${l}`;const c=document.createElement("p");c.className="text-sm text-gray-500 mt-1";const f=e.sharedAt?new Date(e.sharedAt.seconds*1e3).toLocaleDateString("fr-FR"):e.lastUpdated?new Date(e.lastUpdated.seconds*1e3).toLocaleDateString("fr-FR"):"date inconnue";c.textContent=`Partagé par ${t} le ${f}`,a.appendChild(o),a.appendChild(c),n.appendChild(a);const y=document.createElement("button");return y.className="btn btn-ghost text-red-500 btn-sm",y.innerHTML='<i class="fas fa-trash"></i>',y.title="Supprimer ce contenu partagé",y.addEventListener("click",()=>Ia(e.id,e.type)),n.appendChild(y),n}async function Ia(e,t){if(confirm(`Voulez-vous vraiment supprimer cette ${t.toLowerCase()} partagée ?`))try{const n=t.startsWith("Planification")?"plans":"shopping_lists",a=$(b,n,e),o=await Le(a);o.exists()&&o.data().userId===ye()?(await Ae(a),Ht()):(alert("Vous n'avez pas la permission de supprimer cet élément ou il a déjà été supprimé."),Ht())}catch(n){console.error("Erreur de suppression: ",n),alert("Une erreur est survenue.")}}async function wn(){const e=document.getElementById("sent-shares-container"),t=ye();if(!t||!e)return()=>{};e.innerHTML='<p class="text-gray-500">Chargement des partages envoyés...</p>';const n=F(b,"shares"),a=me(n,Z("senderId","==",t));return Fe(a,async o=>{if(o.empty){e.innerHTML=`<p class="text-gray-500">Vous n'avez envoyé aucun partage.</p>`;return}const l=o.docs.sort((c,f)=>(f.data().createdAt?.seconds||0)-(c.data().createdAt?.seconds||0));e.innerHTML="";for(const c of l){const f=c.data();try{const y=await Le($(b,"users",f.receiverId));if(y.exists()){const x=y.data();e.appendChild(Ba(f,x.displayName,c.id))}}catch(y){console.error("Could not load receiver for sent share",y)}}},o=>{console.error("Erreur lors du chargement des partages envoyés : ",o),e&&(e.innerHTML='<p class="text-red-500">Une erreur est survenue.</p>')})}function Ba(e,t,n){const a=document.createElement("div");a.className="bg-white rounded-lg p-4 flex justify-between items-center shadow-sm";const o=document.createElement("div"),l=document.createElement("p");l.className="font-bold text-gray-800";let c=[];e.plan&&c.push("Planification"),e.shoppingList&&c.push("Liste de courses"),l.textContent=c.join(" et ");const f=document.createElement("p");f.className="text-sm text-gray-500";const y=new Date(e.createdAt.seconds*1e3).toLocaleDateString("fr-FR");f.textContent=`Envoyé à ${t} le ${y}`,o.appendChild(l),o.appendChild(f),a.appendChild(o);const x=document.createElement("div");x.className="flex items-center space-x-4";const E=document.createElement("span");E.textContent=e.status;let C="bg-gray-200 text-gray-800";switch(e.status){case"accepted":C="bg-green-100 text-green-800";break;case"declined":C="bg-red-100 text-red-800";break;case"pending":C="bg-yellow-100 text-yellow-800";break}E.className=`text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full ${C}`,x.appendChild(E);const L=document.createElement("button");return L.className="btn btn-ghost text-red-500 btn-sm",L.innerHTML='<i class="fas fa-trash"></i>',L.title="Annuler le partage",L.addEventListener("click",()=>ka(n)),x.appendChild(L),a.appendChild(x),a}async function ka(e){if(confirm("Voulez-vous vraiment annuler ce partage ? L'autre utilisateur ne le verra plus."))try{await Ae($(b,"shares",e)),wn()}catch(t){console.error("Erreur lors de la suppression du partage: ",t),alert("Une erreur est survenue.")}}const Sa=Object.freeze(Object.defineProperty({__proto__:null,default:La},Symbol.toStringTag,{value:"Module"}));function Ma(){const e=localStorage.getItem("selectedPlanId"),t=document.getElementById("plan-view-name"),n=document.getElementById("meal-plan-grid"),a=document.getElementById("close-view-plan-btn");if(a&&a.addEventListener("click",()=>{localStorage.removeItem("selectedPlanId"),rt("plans")}),!e)return t&&(t.textContent="Aucune sauvegarde sélectionnée"),n&&(n.innerHTML=`<p class="text-center text-red-500">Erreur : Aucun ID de sauvegarde trouvé. Veuillez retourner à la page 'Mes Plans Sauvegardés' et en sélectionner une.</p>`),()=>{};async function o(){try{const l=$(b,"plan_saves",e),c=await Le(l);if(!c.exists())throw new Error("Sauvegarde non trouvée");const f=c.data(),y=f.planData;if(!y)throw new Error("Les données du plan sauvegardé sont corrompues ou manquantes.");t&&(t.textContent=`Vue de : ${f.name}`),Na(n,y)}catch(l){console.error("Error fetching save:",l),t&&(t.textContent="Erreur"),n&&(n.innerHTML=`<p class="text-center text-red-500">${l.message}</p>`)}}return o(),()=>{localStorage.removeItem("selectedPlanId")}}function Na(e,t){if(!e)return;e.innerHTML="";const n=Object.keys(t.weeks||{}).sort((a,o)=>parseInt(a)-parseInt(o));if(n.length===0){e.innerHTML='<p class="text-center text-gray-500 p-10 col-span-full">Ce plan est vide.</p>';return}n.forEach(a=>{const o=t.weeks[a],l=document.createElement("h3");l.className="text-lg font-bold text-gray-700 mt-6 mb-2 col-span-full",l.textContent=`Semaine ${a}`,e.appendChild(l);const c=document.createElement("div");Ta(c,o,t.startDay,t.defaultNumPeople),e.appendChild(c)})}function Ta(e,t,n,a){const o=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"],l=o.indexOf(n||"Lundi"),c=[...o.slice(l),...o.slice(0,l)],f=t.menuData||{},y=t.servingsData||{},x=t.remarksData||{};c.forEach(E=>{const C=o.indexOf(E),L=document.createElement("div");L.className="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] items-stretch border-b border-gray-300";const P=document.createElement("div");P.className="font-bold p-2 flex items-center justify-center bg-gray-100 text-sm border-r border-gray-300",P.textContent=E.toUpperCase(),L.appendChild(P),["lunch","dinner"].forEach(N=>{const m=`${C}-${N}`,R=y[m]||a||1,G=document.createElement("div");G.className="border-r border-gray-300 flex items-center justify-center",G.innerHTML=`<div class="text-center"><i class="fas fa-users fa-xs mb-1"></i><br>${R}</div>`,L.appendChild(G);for(let De=0;De<5;De++){const U=`${C}-${N}-${De}`,A=document.createElement("div");if(A.className="meal-slot p-1 min-h-[50px] border-r border-gray-300",De===4)A.textContent=x[U]||"",A.classList.add("text-xs","italic","text-gray-600");else{const T=f[U];Array.isArray(T)&&T.length>0&&T.forEach(z=>{const X=document.createElement("div");X.className="p-1 bg-white rounded shadow-sm text-center text-xs font-medium",X.textContent=z.name,A.appendChild(X)})}L.appendChild(A)}}),e.appendChild(L)})}const Da=Object.freeze(Object.defineProperty({__proto__:null,default:Ma},Symbol.toStringTag,{value:"Module"})),Yt=document.querySelector("main"),Pa={menu:{html:`
        <div class="flex flex-col md:flex-row md:space-x-2">

            <!-- Left Column: Meal Planner -->
            <div class="w-full md:w-5/6">
                <section id="meal-planning-section" aria-labelledby="meal-planning-heading" class="mb-8 md:mb-12">
                                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                                        <h2 id="meal-planning-heading" class="text-xl md:text-2xl font-bold text-gray-800">Planification des repas</h2>
                                        <div class="mt-3 md:mt-0 flex items-center space-x-2 md:space-x-3 plan-actions">
                                            <button id="generate-plan-ai-btn" class="btn btn-primary btn-sm">
                                                <i class="fas fa-robot mr-1 md:mr-2"></i> IA Semaine
                                            </button>
                                            <button id="clear-menu-btn" class="btn btn-outline btn-sm text-red-800 hover:bg-red-100">
                                                <i class="fas fa-trash-alt mr-1 md:mr-2"></i> Vider le menu
                                            </button>
                                            <button id="export-plan-pdf-btn" class="btn btn-outline btn-sm">
                                                <i class="fas fa-file-pdf mr-1 md:mr-2"></i> Exporter Plan (PDF)
                                            </button>
                                            <button id="share-plan-btn" class="btn btn-secondary btn-sm">
                                                <i class="fas fa-share-alt mr-1 md:mr-2"></i> Partager
                                            </button>
                                            <button id="save-plan-btn" class="btn btn-secondary btn-sm">
                                                <i class="fas fa-save mr-1 md:mr-2"></i> Sauvegarder Plan
                                            </button>
                                        </div>
                                    </div>
                            
                                    <!-- Week Navigation & Plan Selector -->
                                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 space-y-3 md:space-y-0">
                                        <!-- Week Navigation -->
                                        <div class="flex justify-between items-center bg-white p-2 md:p-3 rounded-lg shadow-sm">
                                            <button id="prev-week-btn" class="btn btn-ghost btn-sm" aria-label="Semaine précédente">
                                                <i class="fas fa-chevron-left mr-1 md:mr-2"></i> Préc.
                                            </button>
                                            <div id="current-week-display" class="text-gray-700 font-medium text-sm md:text-base text-center mx-4">Semaine X</div>
                                            <button id="next-week-btn" class="btn btn-ghost btn-sm" aria-label="Semaine suivante">
                                                Suiv. <i class="fas fa-chevron-right ml-1 md:ml-2"></i>
                                            </button>
                                        </div>
                                        <!-- Plan Selector -->
                                        <div class="flex flex-wrap items-center justify-center gap-2 bg-white p-3 rounded-lg shadow-sm">
                                            <label for="plan-select" class="text-sm font-medium text-gray-700">Plan affiché:</label>
                                            <select id="plan-select" class="rounded-md border-gray-300 shadow-sm focus:border-tomato focus:ring focus:ring-tomato focus:ring-opacity-50 text-sm py-1">
                                                <!-- Options will be generated by JS -->
                                            </select>
                                            <button id="create-plan-btn" class="btn btn-primary btn-sm" title="Créer un nouveau plan">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                            <button id="rename-plan-btn" class="btn btn-ghost text-blue-500 hover:bg-blue-100 btn-sm" title="Renommer le plan sélectionné">
                                                <i class="fas fa-pencil-alt"></i>
                                            </button>
                                            <button id="history-plan-btn" class="btn btn-ghost text-purple-500 hover:bg-purple-100 btn-sm" title="Historique des modifications">
                                                <i class="fas fa-history"></i>
                                            </button>
                                            <button id="leave-plan-btn" class="btn btn-ghost text-yellow-600 hover:bg-yellow-100 btn-sm" title="Quitter le plan collaboratif">
                                                <i class="fas fa-door-open"></i>
                                            </button>
                                            <button id="delete-plan-btn" class="btn btn-ghost text-red-500 hover:bg-red-100 btn-sm" title="Supprimer le plan sélectionné">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            <button id="invite-participant-btn" class="btn btn-ghost text-green-500 hover:bg-green-100 btn-sm hidden" title="Inviter un participant">
                                                <i class="fas fa-user-plus"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Collaborators Bar -->
                                    <div id="collaborators-bar" class="flex items-center space-x-2 mb-4 hidden">
                                        <!-- Avatars will be injected here -->
                                    </div>

                                    <!-- Activity Labels -->
                                    <div id="activity-labels-container" class="text-sm text-gray-600 mb-4 h-6">
                                        <!-- e.g., 'Sophie is adding a recipe...' -->
                                    </div>
                            
                                            <!-- Settings Section -->
                                            <div class="inline-flex items-center space-x-6 bg-white p-3 rounded-lg shadow-sm mb-4">                                        <div>
                                            <label for="start-day-select" class="text-sm font-medium text-gray-700">Début de semaine:</label>
                                            <select id="start-day-select" class="rounded-md border-gray-300 shadow-sm focus:border-tomato focus:ring-tomato text-sm py-1">
                                                <option>Lundi</option>
                                                <option>Mardi</option>
                                                <option>Mercredi</option>
                                                <option>Jeudi</option>
                                                <option>Vendredi</option>
                                                <option>Samedi</option>
                                                <option>Dimanche</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="default-servings-input" class="text-sm font-medium text-gray-700">Personnes par défaut:</label>
                                            <div id="default-servings-control" class="mt-1"></div>
                                        </div>
                                    </div>                    <!-- Responsive Meal Plan Grid -->
<div class="bg-white rounded-xl shadow-md p-4">
                        <!-- Desktop Grid (Visible on large screens) -->
                        <div id="desktop-plan-container" class="hidden lg:block">
                            <div id="meal-plan-grid-layout">
                                <!-- Header -->
                                <div class="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] gap-1 text-center mb-1">
                                    <div class="p-2"></div> <!-- Empty corner -->
                                    <div class="p-2 rounded-t-lg bg-amber-100 text-amber-800 font-bold col-span-6">MIDI</div>
                                    <div class="p-2 rounded-t-lg bg-stone-200 text-stone-800 font-bold col-span-6">SOIR</div>
                                    
                                    <div class="p-1"></div> <!-- Empty under day name -->
                                    <div class="p-1 text-xs font-semibold"><i class="fas fa-users"></i></div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Entrée</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Plat</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Accomp.</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Dessert</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Remarque</div>

                                    <div class="p-1 text-xs font-semibold"><i class="fas fa-users"></i></div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Entrée</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Plat</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Accomp.</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Dessert</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Remarque</div>
                                </div>
                                <!-- Rows generated by JS -->
                                <div id="meal-plan-grid" class="space-y-1">
                                    <div class="p-10 text-center text-gray-500 italic col-span-full">Chargement du planning...</div>
                                </div>
                            </div>
                        </div>

                        <!-- Mobile Accordion (Visible on small screens) -->
                        <div id="mobile-meal-plan" class="lg:hidden space-y-2">
                            <!-- Mobile content will be generated by JS here -->
                             <div class="p-10 text-center text-gray-500 italic col-span-full">Chargement du planning...</div>
                        </div>
                    </div>
                                    </section>


                                </div>
                    
                                <!-- Right Column: Shopping List -->
                                <div class="w-full md:w-1/6">
                                    <section id="shopping-list-section" aria-labelledby="shopping-list-heading" class="mb-8 md:mb-12 md:sticky md:top-24">
                                        <div class="bg-white rounded-xl shadow-md p-4 md:p-6">
                                            <h2 id="shopping-list-heading" class="text-xl md:text-2xl font-bold text-gray-800 mb-4">Liste de courses</h2>
                                            <div class="flex justify-end space-x-2 mb-4">
                                                <button id="import-list-btn" class="btn btn-secondary btn-sm">
                                                    <i class="fas fa-download mr-2"></i>Importer une liste
                                                </button>
                                                <div id="export-buttons-container" class="flex space-x-2">
                                                    <button id="export-txt-btn" class="btn btn-outline btn-sm">
                                                        <i class="fas fa-file-alt mr-2"></i>TXT
                                                    </button>
                                                    <button id="export-pdf-btn" class="btn btn-outline btn-sm">
                                                        <i class="fas fa-file-pdf mr-2"></i>PDF
                                                    </button>
                                                </div>
                                            </div>
                    
                                            <!-- Shopping List Container -->
                                            <div id="shopping-list-container" class="mb-4 max-h-[70vh] overflow-y-auto pr-2">                            <ul id="shopping-list" class="space-y-2 text-sm">
                                <!-- Les articles de la liste de courses seront générés ici -->
                            </ul>
                        </div>

                        <!-- Add Item Input -->
                        <div class="mt-4 flex items-stretch">
                            <div class="relative flex-grow">
                                <input type="text" id="add-item-input" placeholder="Chercher ou ajouter..." class="w-full border border-gray-300 rounded-l-lg px-2 py-1 text-xs focus:outline-none focus:ring-2 focus:ring-tomato focus:border-transparent">
                                <div id="add-item-results" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto bottom-full mb-2"></div>
                            </div>
                            <button id="add-item-btn" class="btn btn-primary rounded-l-none -ml-px btn-xs" aria-label="Ajouter l'article">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>

                         <!-- AI Shopping Tips Placeholder -->
                        <div id="ai-shopping-tip" class="mt-6 bg-avocado bg-opacity-10 rounded-lg p-3 hidden">
                            <div class="flex items-start">
                                 <div class="w-8 h-8 bg-avocado bg-opacity-20 rounded-full flex items-center justify-center mr-3 shrink-0">
                                    <i class="fas fa-lightbulb text-avocado"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-avocado mb-1 text-sm">Astuce Économique</h4>
                                    <p id="ai-shopping-tip-text" class="text-sm text-gray-700">...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <!-- Shared Plans Modal -->
        <div id="shared-plans-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-6xl max-h-[90vh] overflow-y-auto relative">
                <button id="close-shared-plans-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" aria-label="Fermer">
                    <i class="fas fa-times text-xl"></i>
                </button>
                <h3 id="shared-plans-modal-title" class="text-2xl font-bold mb-6">Plans partagés pour la Semaine X</h3>
                <div id="shared-plans-modal-container" class="space-y-6">
                    <!-- Shared plans will be loaded here -->
                </div>
            </div>
        </div>
        `,script:"./script.js"},recipes:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Recettes</h2>
            <button id="add-recipe-btn" class="btn btn-primary">
                <i class="fas fa-plus mr-2"></i> Ajouter une recette
            </button>
        </div>

        <!-- Search Bar -->
        <div class="mb-6">
            <input type="text" id="search-bar" placeholder="Rechercher une recette..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-tomato focus:border-tomato">
        </div>

        <!-- Tabs Navigation -->
        <div id="category-tabs" class="mb-6 border-b border-gray-200 flex space-x-4 flex-nowrap overflow-x-auto pb-2">
            <!-- Tabs will be generated by recipes.js here -->
        </div>

        <!-- Recipe List Container -->
        <div id="recipe-list-container">
            <!-- Recipes for the selected tab will be loaded here -->
        </div>

        <!-- Reconstructed Recipe Form Modal -->
        <div id="recipe-form-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-3xl max-h-[90vh] overflow-y-auto relative">
                <button id="close-recipe-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" aria-label="Fermer">
                    <i class="fas fa-times text-xl"></i>
                </button>
                <h3 id="recipe-modal-title" class="text-2xl font-bold mb-6">Ajouter/Modifier une recette</h3>
                <form id="recipe-form" class="space-y-4">
                    <input type="hidden" id="recipe-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label for="recipe-name" class="block text-sm font-medium text-gray-700">Nom de la recette</label>
                            <input type="text" id="recipe-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                        </div>
                        <div>
                            <label for="recipe-category" class="block text-sm font-medium text-gray-700">Catégorie</label>
                            <select id="recipe-category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                                <option>ENTREE</option>
                                <option>PLAT</option>
                                <option>ACCOMPAGNEMENT</option>
                                <option>DESSERT</option>
                            </select>
                        </div>
                        <div>
                            <label for="recipe-servings" class="block text-sm font-medium text-gray-700">Nombre de personnes</label>
                            <input type="number" id="recipe-servings" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" min="1">
                        </div>
                        <div>
                            <label for="recipe-prep-time" class="block text-sm font-medium text-gray-700">Temps de préparation (min)</label>
                            <input type="number" id="recipe-prep-time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" min="0">
                        </div>
                         <div>
                            <label for="recipe-difficulty" class="block text-sm font-medium text-gray-700">Difficulté</label>
                            <select id="recipe-difficulty" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                <option>Très facile</option>
                                <option>Facile</option>
                                <option>Moyen</option>
                                <option>Difficile</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-lg font-medium text-gray-800 mb-2">Ingrédients</h4>
                        <div id="ingredients-list" class="space-y-2"></div>
                        <button type="button" id="add-ingredient-btn" class="btn btn-outline btn-sm mt-2">
                            <i class="fas fa-plus mr-2"></i> Ajouter un ingrédient
                        </button>
                    </div>
                    <div>
                        <label for="recipe-steps" class="block text-lg font-medium text-gray-800">Préparation</label>
                        <textarea id="recipe-steps" rows="8" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                    </div>
                    <div class="flex justify-end space-x-4 pt-4">
                        <button type="button" id="cancel-recipe-btn" class="btn btn-ghost">Annuler</button>
                        <button type="submit" id="save-recipe-btn" class="btn btn-primary">Sauvegarder</button>
                    </div>
                </form>
            </div>
        </div>
        `,script:"./recipes.js"},ingredients:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Ingrédients</h2>
            <div class="flex space-x-2">
                <button id="manage-categories-btn" class="btn btn-outline">
                    <i class="fas fa-tags mr-2"></i> Gérer les catégories
                </button>
                <button id="add-ingredient-btn" class="btn btn-primary">
                    <i class="fas fa-plus mr-2"></i> Ajouter un ingrédient
                </button>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="mb-6">
            <input type="text" id="search-bar" placeholder="Rechercher un ingrédient..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-tomato focus:border-tomato">
        </div>

        <!-- Tabs Navigation -->
        <div id="category-tabs" class="mb-6 border-b border-gray-200 flex space-x-4 flex-nowrap overflow-x-auto pb-2">
            <!-- Tabs will be generated by ingredients.js here -->
        </div>

        <!-- Ingredient List Container -->
        <div id="ingredients-list-container">
            <p class="text-center text-gray-500 p-10">Chargement des ingrédients...</p>
        </div>

        <!-- Ingredient Form Modal -->
        <div id="ingredient-form-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-md relative">
                <button id="close-ingredient-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
                <h3 id="ingredient-modal-title" class="text-lg font-bold mb-4">Ajouter un Ingrédient</h3>
                <form id="ingredient-form" class="space-y-4">
                    <input type="hidden" id="ingredient-id">
                    <div>
                        <label for="ingredient-name" class="block text-sm font-medium text-gray-700">Nom</label>
                        <input type="text" id="ingredient-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                    </div>
                    <div>
                        <label for="ingredient-unit" class="block text-sm font-medium text-gray-700">Unité par défaut</label>
                        <select id="ingredient-unit" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select>
                    </div>
                    <div>
                        <label for="ingredient-category" class="block text-sm font-medium text-gray-700">Catégorie</label>
                        <select id="ingredient-category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></select>
                    </div>
                    <div>
                        <label for="ingredient-image-url" class="block text-sm font-medium text-gray-700">URL de l'image</label>
                        <input type="text" id="ingredient-image-url" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="Laisser vide pour une image aléatoire">
                    </div>
                    <div class="flex justify-end space-x-4 pt-2">
                        <button type="button" id="cancel-ingredient-btn" class="btn btn-ghost">Annuler</button>
                        <button type="submit" id="save-ingredient-btn" class="btn btn-primary">Sauvegarder</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Category Management Modal -->
        <div id="category-management-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-lg relative">
                <h3 class="text-lg font-bold mb-4">Gérer les catégories d'ingrédients</h3>
                <form id="add-category-form" class="flex items-center space-x-2 mb-4">
                    <input type="text" id="new-category-name" placeholder="Nom de la nouvelle catégorie" class="flex-grow mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                    <button type="submit" class="btn btn-secondary">Ajouter</button>
                </form>
                <div id="category-list" class="max-h-64 overflow-y-auto border rounded-lg p-2"></div>
                <div class="flex justify-end space-x-4 mt-4">
                     <button type="button" id="close-category-modal" class="btn btn-ghost">Annuler</button>
                    <button type="button" id="done-category-modal-btn" class="btn btn-primary">Terminé</button>
                </div>
            </div>
        </div>
        `,script:"./ingredients.js"},lists:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Listes de Courses</h2>
            <button id="add-list-btn" class="btn btn-primary">
                <i class="fas fa-plus mr-2"></i> Créer une liste
            </button>
        </div>

        <!-- Search Bar -->
        <div class="mb-6">
            <input type="text" id="search-bar" placeholder="Rechercher une liste..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-tomato focus:border-tomato">
        </div>

        <!-- Lists Container -->
        <div id="lists-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

        <div class="mt-12">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6">Listes Partagées</h2>
            <div id="shared-lists-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Les listes partagées seront chargées ici par JS -->
            </div>
        </div>

        <!-- List Form Modal -->
        <div id="list-form-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-start justify-center z-[100] hidden pt-20">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-3xl min-h-[75vh] max-h-[90vh] overflow-y-auto relative">
                <button id="close-list-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10"><i class="fas fa-times text-xl"></i></button>
                <h3 id="list-modal-title" class="text-lg font-bold mb-4">Créer une liste</h3>
                <form id="list-form" class="space-y-4 pb-20">
                    <input type="hidden" id="list-id">
                    <div>
                        <label for="list-name" class="block text-sm font-medium text-gray-700">Nom de la liste</label>
                        <input type="text" id="list-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                    </div>
                    <div>
                        <h4 class="text-md font-medium text-gray-800 mb-2">Ingrédients</h4>
                        <div id="ingredients-list" class="space-y-2"></div>
                        <button type="button" id="add-ingredient-btn" class="btn btn-outline btn-sm mt-2">
                            <i class="fas fa-plus mr-2"></i> Ajouter un ingrédient
                        </button>
                    </div>
                </form>
                <div class="absolute bottom-0 left-0 right-0 px-6 py-4 bg-white/95 backdrop-blur-sm border-t border-gray-200 flex justify-end space-x-4">
                    <button type="button" id="cancel-list-btn" class="btn btn-ghost">Annuler</button>
                    <button type="submit" form="list-form" id="save-list-btn" class="btn btn-primary">Sauvegarder la liste</button>
                </div>
            </div>
        </div>
        `,script:"./lists.js"},friends:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Amis</h2>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="md:col-span-2 space-y-8">
                <div>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Liste d'amis</h3>
                    <div id="friends-list-container" class="space-y-4">
                        <!-- La liste d'amis sera chargée ici -->
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Demandes envoyées en attente</h3>
                    <div id="pending-requests-container" class="space-y-4">
                        <!-- Les demandes envoyées en attente seront chargées ici -->
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Demandes rejetées</h3>
                    <div id="declined-requests-container" class="space-y-4">
                        <!-- Les demandes rejetées seront chargées ici -->
                    </div>
                </div>
            </div>
            <div>
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Rechercher un ami</h3>
                    <div class="mb-4">
                        <div class="flex items-center space-x-2">
                            <input type="text" id="search-friends-input" placeholder="Nom ou email..." class="flex-grow p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-tomato focus:border-tomato">
                            <button id="search-friends-btn" class="btn btn-primary"><i class="fas fa-search"></i></button>
                        </div>
                        <div id="search-results-container" class="mt-2 space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>
        `,script:"./friends.js"},shared:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Partages</h2>
        </div>

        <div class="space-y-12">
            <div>
                <h3 class="text-xl font-bold text-gray-700 border-b pb-2 mb-4">Partages Reçus</h3>
                <div id="received-shares-container" class="space-y-4">
                    <!-- L'historique des partages acceptés sera chargé ici -->
                </div>
            </div>
            <div>
                <h3 class="text-xl font-bold text-gray-700 border-b pb-2 mb-4">Mes Partages Envoyés</h3>
                <div id="sent-shares-container" class="space-y-4">
                    <!-- L'historique des partages envoyés sera chargé ici -->
                </div>
            </div>
        </div>
        `,script:"./shared.js"},plans:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Plans Sauvegardés</h2>
        </div>
        <div id="all-plans-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- La liste des plans sera chargée ici -->
            <p class="text-center text-gray-500 p-10 col-span-full">Chargement de vos plans...</p>
        </div>
        `,script:"./all-plans.js"},"view-plan":{html:`
        <section aria-labelledby="meal-planning-heading" class="mb-8 md:mb-12">
            <div class="flex justify-between items-center mb-4">
                <h2 id="plan-view-name" class="text-xl md:text-2xl font-bold text-gray-800">Chargement du plan...</h2>
                <button id="close-view-plan-btn" class="btn btn-outline">
                    <i class="fas fa-times mr-2"></i> Fermer et voir mes plans
                </button>
            </div>
            <div class="bg-white rounded-xl shadow-md p-4">
                <div id="meal-plan-grid-layout">
                    <!-- Header -->
                    <div class="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] gap-1 text-center mb-1">
                        <div class="p-2"></div> <!-- Empty corner -->
                        <div class="p-2 rounded-t-lg bg-amber-100 text-amber-800 font-bold col-span-6">MIDI</div>
                        <div class="p-2 rounded-t-lg bg-stone-200 text-stone-800 font-bold col-span-6">SOIR</div>
                        <div class="p-1"></div> <!-- Empty under day name -->
                        <div class="p-1 text-xs font-semibold"><i class="fas fa-users"></i></div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Entrée</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Plat</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Accomp.</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Dessert</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Remarque</div>
                        <div class="p-1 text-xs font-semibold"><i class="fas fa-users"></i></div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Entrée</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Plat</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Accomp.</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Dessert</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Remarque</div>
                    </div>
                    <!-- Rows generated by JS -->
                    <div id="meal-plan-grid" class="space-y-1">
                        <div class="p-10 text-center text-gray-500 italic col-span-full">Chargement de la planification...</div>
                    </div>
                </div>
            </div>
        </section>
        `,script:"./view-plan.js"}},_a=Object.assign({"./all-plans.js":zn,"./auth.js":qn,"./firebase-config.js":Rn,"./form-handler.js":Vn,"./friends.js":Yn,"./ingredients.js":Zn,"./lists.js":aa,"./main.js":An,"./notifications.js":va,"./plans.js":da,"./presence.js":ba,"./recipes.js":xa,"./script.js":wa,"./shared.js":Sa,"./sharing.js":ta,"./view-plan.js":Da});let ft=null;async function rt(e){typeof ft=="function"&&(ft(),ft=null);const t=Pa[e];if(t&&Yt){if(Yt.innerHTML=t.html,t.script){const n=_a[t.script];n?n.default&&typeof n.default=="function"&&(ft=n.default()):console.error(`Module not found for path: ${t.script}`)}}else console.error(`Route not found: ${e}`)}function $a(){const e=He();if(e){const n=document.getElementById("user-display-name");n&&(n.textContent=e.displayName||e.email)}const t=document.querySelectorAll(".nav-btn");t.forEach(n=>{n.addEventListener("click",a=>{const o=a.currentTarget.dataset.path;rt(o),t.forEach(l=>{l.classList.remove("bg-tomato","text-white"),l.classList.add("bg-white","text-tomato")}),a.currentTarget.classList.add("bg-tomato","text-white"),a.currentTarget.classList.remove("bg-white","text-tomato")})}),rt("menu"),yn()}document.addEventListener("DOMContentLoaded",()=>{en().then(N=>{N&&$a()});const e=document.getElementById("profile-btn"),t=document.getElementById("profile-menu");e&&t&&(e.addEventListener("click",N=>{N.stopPropagation(),t.classList.toggle("hidden");const m=!t.classList.contains("hidden");e.setAttribute("aria-expanded",m)}),document.addEventListener("click",N=>{!(t.contains(N.target)||e.contains(N.target))&&!t.classList.contains("hidden")&&(t.classList.add("hidden"),e.setAttribute("aria-expanded","false"))}));const n=document.getElementById("settings-link"),a=document.getElementById("settings-modal"),o=document.getElementById("close-settings-modal"),l=document.getElementById("dark-mode-toggle"),c=N=>{N==="dark"?(document.documentElement.classList.add("dark"),l&&(l.checked=!0)):(document.documentElement.classList.remove("dark"),l&&(l.checked=!1))},f=localStorage.getItem("theme");f?c(f):window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?c("dark"):c("light"),n&&a&&n.addEventListener("click",N=>{N.preventDefault(),a.classList.remove("hidden")}),o&&a&&o.addEventListener("click",()=>{a.classList.add("hidden")}),a&&a.addEventListener("click",N=>{N.target===a&&a.classList.add("hidden")}),l&&l.addEventListener("change",()=>{const N=l.checked?"dark":"light";localStorage.setItem("theme",N),c(N)});const y=document.getElementById("mobile-menu-btn"),x=document.getElementById("mobile-menu"),E=document.querySelectorAll(".nav-btn-mobile"),C=document.getElementById("notifications-btn-mobile"),L=document.getElementById("notifications-dropdown");C&&L&&C.addEventListener("click",N=>{N.stopPropagation(),L.classList.toggle("hidden")}),y&&x&&y.addEventListener("click",()=>{x.classList.toggle("hidden")});const P=document.getElementById("profile-btn-mobile");P&&a&&P.addEventListener("click",()=>{a.classList.remove("hidden"),x&&x.classList.add("hidden")}),E.forEach(N=>{N.addEventListener("click",m=>{const R=m.currentTarget.dataset.path;rt(R),x&&x.classList.add("hidden")})})});
