import{d as l,g as M,c as f,a as G,f as ie,b as S,q as oe,w as U,s as Ce,u as we}from"./firebase-config-9gANoKOS.js";import{g as k}from"./main-CPC2Lv91.js";import{o as Ie}from"./sharing-JwcufOfh.js";function ke(){const de=document.getElementById("search-bar"),N=document.getElementById("lists-container"),ce=document.getElementById("add-list-btn"),T=document.getElementById("shared-lists-container"),z=document.getElementById("list-form-modal"),F=document.getElementById("list-modal-title"),le=document.getElementById("close-list-modal"),ue=document.getElementById("cancel-list-btn"),j=document.getElementById("list-form"),q=document.getElementById("list-id"),J=document.getElementById("list-name"),O=document.getElementById("ingredients-list"),me=document.getElementById("add-ingredient-btn"),E=document.getElementById("save-list-btn"),V=document.getElementById("generate-seasonal-list-btn"),Q=document.getElementById("seasonal-list-modal"),K=document.getElementById("close-seasonal-modal"),L=document.getElementById("gen-category"),b=document.getElementById("gen-preview-btn"),v=document.getElementById("gen-create-btn"),W=document.getElementById("gen-preview-section"),x=document.getElementById("gen-preview-list"),H=document.getElementsByName("gen-season"),y=document.getElementsByName("gen-mode"),X=document.getElementById("gen-month"),Y=document.getElementById("gen-season-selector"),Z=document.getElementById("gen-month-selector");let $=[],D="",g=[],A=[],u=[];async function ee(){await _(),await pe(),await C(),await te()}async function _(){if(l)try{g=(await M(f(l,"ingredients"))).docs.map(e=>({id:e.id,...e.data()})),g.sort((e,s)=>e.name.localeCompare(s.name))}catch(t){console.error("Erreur lors de la récupération de la liste des ingrédients: ",t)}}async function pe(){if(l)try{A=(await M(f(l,"ingredient_categories"))).docs.map(e=>({id:e.id,...e.data()})),A.sort((e,s)=>e.name.localeCompare(s.name))}catch(t){console.error("Erreur lors de la récupération des catégories: ",t)}}async function C(){const t=k();if(!(!l||!t))try{const e=oe(f(l,"shopping_lists"),U("userId","==",t));$=(await M(e)).docs.map(n=>({id:n.id,...n.data()})).filter(n=>n.isShared!==!0),se()}catch(e){console.error("Erreur de chargement des listes: ",e)}}async function te(){const t=k();if(!(!l||!t)){console.log(`Recherche de listes partagées pour userId: ${t}`);try{const e=oe(f(l,"shopping_lists"),U("userId","==",t),U("isShared","==",!0)),s=await M(e);console.log(`Trouvé ${s.size} liste(s) partagée(s).`);const n=s.docs.map(a=>({id:a.id,...a.data()}));ge(n)}catch(e){console.error("Erreur de chargement des listes partagées: ",e)}}}async function ne(t=null){await _(),j.reset(),O.innerHTML="",u=[],t?(F.textContent="Modifier la liste",q.value=t.id,J.value=t.name,t.ingredients&&t.ingredients.length>0?t.ingredients.forEach(e=>w(e)):w()):(F.textContent="Créer une liste",q.value="",w()),z.classList.remove("hidden")}function R(){z.classList.add("hidden")}async function he(t){t.preventDefault(),E.disabled=!0;const e=k();if(!e){alert("Erreur : utilisateur non connecté."),E.disabled=!1;return}const s=u.filter(r=>r&&r.name&&r.quantity),n={name:J.value,ingredients:s,userId:e};if(!n.name){alert("Le nom de la liste est requis."),E.disabled=!1;return}const a=q.value;try{a?await Ce(S(l,"shopping_lists",a),n):await G(f(l,"shopping_lists"),n),R(),await C()}catch(r){console.error("Erreur de sauvegarde de la liste: ",r)}finally{E.disabled=!1}}function w(t={quantity:"",name:"",unit:""}){const e=document.createElement("div");e.className="relative flex items-stretch space-x-2 ingredient-row";const s={...t};u.push(s);const n=u.length-1,a=document.createElement("input");a.type="text",a.className="ingredient-quantity mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm",a.placeholder="Qté",a.value=s.quantity,a.addEventListener("change",p=>{u[n].quantity=p.target.value});const r=document.createElement("input");r.type="text",r.className="ingredient-unit mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm bg-gray-100",r.placeholder="Unité",r.readOnly=!0,r.value=s.unit||"";const i=document.createElement("div");i.className="relative w-1/2";const o=document.createElement("input");o.type="text",o.className="ingredient-name mt-1 block w-full rounded-md border-gray-300 shadow-sm",o.placeholder="Chercher un ingrédient...",o.value=s.name,i.appendChild(o);const d=document.createElement("div");d.className="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto",i.appendChild(d),o.addEventListener("input",()=>{const p=o.value.toLowerCase();if(!p){d.classList.add("hidden");return}const I=g.filter(m=>m.name.toLowerCase().includes(p));d.innerHTML="",I.forEach(m=>{const h=document.createElement("div");h.className="p-2 ingredient-search-item cursor-pointer",h.textContent=m.name,h.addEventListener("click",()=>{o.value=m.name,r.value=m.unit,d.classList.add("hidden"),u[n].name=m.name,u[n].unit=m.unit,u[n].id=m.id}),d.appendChild(h)});const B=document.createElement("div");B.className="p-2 bg-blue-50 hover:bg-blue-200 cursor-pointer font-bold text-blue-700",B.textContent=`+ Créer "${o.value}"`,B.addEventListener("click",async()=>{const m=o.value,h="pièce(s)";try{const P=await G(f(l,"ingredients"),{name:m,unit:h,category:"Inconnue"});await _(),o.value=m,r.value=h,d.classList.add("hidden"),u[n].name=m,u[n].unit=h,u[n].id=P.id}catch(P){console.error("Erreur d'ajout d'ingrédient",P),alert("L'ingrédient n'a pas pu être créé.")}}),d.appendChild(B),d.classList.remove("hidden")});const c=document.createElement("button");c.type="button",c.className="text-red-500 hover:bg-red-50 text-sm px-3 py-1 rounded-md mt-1",c.innerHTML='<i class="fas fa-trash"></i>',c.addEventListener("click",()=>{e.remove(),u[n]=null}),e.appendChild(i),e.appendChild(a),e.appendChild(r),e.appendChild(c),O.appendChild(e)}function se(){N.innerHTML="";let t=$;if(D){const e=D.toLowerCase();t=$.filter(s=>s.name.toLowerCase().includes(e))}if(t.length===0){N.innerHTML='<p class="text-center text-gray-500 p-10 col-span-full">Aucune liste de courses trouvée.</p>';return}t.sort((e,s)=>e.name.localeCompare(s.name)),t.forEach(e=>{const s=document.createElement("div");s.className="bg-white rounded-lg shadow-md p-4 flex flex-col";const n=document.createElement("div");n.className="flex justify-between items-start border-b pb-2 mb-2";const a=document.createElement("h4");a.className="text-lg font-bold text-gray-800",a.textContent=e.name,n.appendChild(a);const r=document.createElement("div");r.className="flex space-x-2";const i=document.createElement("button");i.className="text-blue-500 hover:bg-blue-50 text-sm px-3 py-1 rounded-md",i.innerHTML='<i class="fas fa-edit"></i>',i.addEventListener("click",()=>ne(e)),r.appendChild(i);const o=document.createElement("button");o.className="text-green-500 hover:bg-green-50 text-sm px-3 py-1 rounded-md",o.innerHTML='<i class="fas fa-share-alt"></i>',o.addEventListener("click",()=>Ie({})),r.appendChild(o);const d=document.createElement("button");d.className="text-red-500 hover:bg-red-50 text-sm px-3 py-1 rounded-md",d.innerHTML='<i class="fas fa-trash"></i>',d.addEventListener("click",()=>fe(e.id,e.name)),r.appendChild(d),n.appendChild(r);const c=document.createElement("ul");c.className="space-y-1 text-sm text-gray-600 flex-grow",e.ingredients&&e.ingredients.length>0?e.ingredients.forEach(p=>{const I=document.createElement("li");I.textContent=`${p.quantity} ${p.unit||""} - ${p.name}`.trim(),c.appendChild(I)}):c.innerHTML='<li class="italic text-gray-400">Cette liste est vide.</li>',s.appendChild(n),s.appendChild(c),N.appendChild(s)})}function ge(t){if(T.innerHTML="",t.length===0){T.innerHTML='<p class="text-center text-gray-500 p-10 col-span-full">Aucune liste de courses partagée trouvée.</p>';return}t.sort((e,s)=>e.name.localeCompare(s.name)),t.forEach(e=>{const s=document.createElement("div");s.className="bg-white rounded-lg shadow-md p-4 flex flex-col";const n=document.createElement("div");n.className="flex justify-between items-start border-b pb-2 mb-2";const a=document.createElement("h4");a.className="text-lg font-bold text-gray-800",a.textContent=e.name,n.appendChild(a);const r=document.createElement("div");r.className="flex space-x-2";const i=document.createElement("button");i.className="btn btn-secondary btn-sm",i.innerHTML='<i class="fas fa-copy mr-2"></i> Copier dans mes listes',i.title="Copier cette liste dans vos listes personnelles",i.addEventListener("click",()=>ye(e.id)),r.appendChild(i);const o=document.createElement("button");o.className="text-red-500 hover:bg-red-50 text-sm px-3 py-1 rounded-md",o.innerHTML='<i class="fas fa-trash"></i>',o.title="Supprimer cette liste partagée",o.addEventListener("click",()=>ve(e.id,e.name)),r.appendChild(o),n.appendChild(r);const d=document.createElement("ul");d.className="space-y-1 text-sm text-gray-600 flex-grow",e.ingredients&&e.ingredients.length>0?e.ingredients.forEach(c=>{const p=document.createElement("li");p.textContent=`${c.quantity} ${c.unit||""} - ${c.name}`.trim(),d.appendChild(p)}):d.innerHTML='<li class="italic text-gray-400">Cette liste est vide.</li>',s.appendChild(n),s.appendChild(d),T.appendChild(s)})}async function fe(t,e){if(confirm(`Êtes-vous sûr de vouloir supprimer la liste "${e}" ?`))try{await ie(S(l,"shopping_lists",t)),await C()}catch(s){console.error("Erreur de suppression de la liste: ",s)}}async function ve(t,e){if(confirm(`Êtes-vous sûr de vouloir supprimer la liste partagée "${e}" ?`))try{await ie(S(l,"shopping_lists",t)),await te()}catch(s){console.error("Erreur de suppression de la liste partagée: ",s),alert("Une erreur est survenue.")}}async function ye(t){if(confirm("Voulez-vous vraiment copier cette liste dans vos listes personnelles ? Elle ne sera plus considérée comme une liste partagée."))try{const e=S(l,"shopping_lists",t);await we(e,{isShared:!1}),await ee()}catch(e){console.error("Erreur lors de la copie de la liste: ",e),alert("Une erreur est survenue.")}}de.addEventListener("input",t=>{D=t.target.value,se()}),ce.addEventListener("click",()=>ne()),le.addEventListener("click",R),ue.addEventListener("click",R),j.addEventListener("submit",he);function Ee(){W.classList.add("hidden"),v.classList.add("hidden"),b.classList.remove("hidden"),x.innerHTML="",H.forEach(n=>n.checked=!1),L.innerHTML="";const t=[...new Set(A.map(n=>n.name))],e=[...new Set(g.map(n=>n.category).filter(Boolean))];[...new Set([...t,...e])].sort().forEach(n=>{const a=document.createElement("option");a.value=n,a.textContent=n,L.appendChild(a)}),ae(),Q.classList.remove("hidden")}function ae(){let t="season";for(const e of y)e.checked&&(t=e.value);t==="season"?(Y.classList.remove("hidden"),Z.classList.add("hidden")):(Y.classList.add("hidden"),Z.classList.remove("hidden"))}function re(){Q.classList.add("hidden")}function Le(t){if(t.months&&t.months.length>0)return t.months;const e=t.seasons||[];let s=[];return e.includes("Printemps")&&s.push("Avril","Mai","Juin"),e.includes("Eté")&&s.push("Juillet","Août","Septembre"),e.includes("Automne")&&s.push("Octobre","Novembre","Décembre"),e.includes("Hiver")&&s.push("Janvier","Février","Mars"),s}function be(){let t="season";for(const n of y)n.checked&&(t=n.value);const e=L.value;let s=[];if(t==="season"){let n=null;for(const a of H)if(a.checked){n=a.value;break}if(!n){alert("Veuillez choisir une saison.");return}s=g.filter(a=>{const r=(a.category||"Inconnue")===e,i=a.seasons&&a.seasons.includes(n);return r&&i})}else{const n=X.value;s=g.filter(a=>{const r=(a.category||"Inconnue")===e,o=Le(a).includes(n);return r&&o})}x.innerHTML="",s.length===0?(x.innerHTML='<p class="text-sm text-gray-500 italic">Aucun ingrédient trouvé pour cette combinaison.</p>',v.classList.add("hidden")):(s.forEach(n=>{const a=document.createElement("div");a.className="flex items-center space-x-2",a.innerHTML=`
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" class="form-checkbox h-4 w-4 text-tomato focus:ring-tomato gen-ingredient-check" value="${n.id}" checked>
                        <span class="text-sm text-gray-700">${n.name} (${n.unit||"-"})</span>
                    </label>
                `,x.appendChild(a)}),v.classList.remove("hidden")),W.classList.remove("hidden"),b.classList.add("hidden")}async function xe(){const t=document.querySelectorAll(".gen-ingredient-check:checked");if(t.length===0){alert("Aucun ingrédient sélectionné.");return}const e=[];t.forEach(i=>{const o=i.value,d=g.find(c=>c.id===o);d&&e.push({name:d.name,unit:d.unit||"pièce(s)",quantity:"1",id:d.id,checked:!1})});let s="season";for(const i of y)i.checked&&(s=i.value);const n=L.value;let a="";if(s==="season"){let i=null;for(const o of H)o.checked&&(i=o.value);a=`${n} - ${i}`}else{const i=X.value;a=`${n} - ${i}`}const r=k();try{await G(f(l,"shopping_lists"),{name:a,ingredients:e,userId:r,createdAt:new Date().toISOString()}),re(),await C(),alert(`Liste "${a}" créée avec succès !`)}catch(i){console.error("Erreur création auto liste:",i),alert("Erreur lors de la création de la liste.")}}me.addEventListener("click",()=>w()),V&&V.addEventListener("click",Ee),K&&K.addEventListener("click",re),b&&b.addEventListener("click",be),v&&v.addEventListener("click",xe),y&&y.forEach(t=>t.addEventListener("change",ae)),l&&ee()}export{ke as default};
