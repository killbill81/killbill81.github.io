import{o as Un,s as Zt,a as Nt,q as Ce,w as fe,c as Y,d as w,b as Ve,e as H,g as Me,h as we,u as $e,i as Oe,j as Pe,k as yt,l as un,m as Ct,n as en,p as mn,r as Fn,t as Tt,v as tn,x as On,y as zn,z as Vn,A as Qn,B as Wn,C as pn,D as Jn,E as nn,_ as Gn}from"./firebase-config-CV1YP_xo.js";const Kn=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"}));let It=null;function fn(){return new Promise(e=>{Un(Nt,t=>{if(It=t,t){console.log("User is logged in:",t.uid);const n=document.getElementById("logout-btn"),a=document.getElementById("profile-btn");n&&n.classList.remove("hidden"),a&&a.classList.remove("hidden"),n&&!n.hasAttribute("data-listener-attached")&&(n.addEventListener("click",()=>{Zt(Nt).catch(i=>{console.error("Sign Out Error",i)})}),n.setAttribute("data-listener-attached","true"));const r=document.getElementById("logout-btn-mobile");r&&!r.hasAttribute("data-listener-attached")&&(r.addEventListener("click",()=>{Zt(Nt).catch(i=>{console.error("Sign Out Error",i)})}),r.setAttribute("data-listener-attached","true")),e(t)}else{console.log("User not logged in. Redirecting to login.html");const n=window.location.origin+"/login.html";window.location.href!==n&&(window.location.href=n),e(null)}})})}function ke(){return It?It.uid:null}function je(){return It}const Yn=Object.freeze(Object.defineProperty({__proto__:null,getCurrentUser:je,getCurrentUserId:ke,protectPage:fn},Symbol.toStringTag,{value:"Module"}));async function Xn(e){if(confirm("Voulez-vous charger cette sauvegarde ? Attention, cela √©crasera la planification de la semaine correspondante dans votre plan de travail actuel."))try{const t=ke();if(!t)throw new Error("Utilisateur non trouv√©");const n=H(w,"plan_saves",e),a=await Me(n);if(!a.exists())throw new Error("Sauvegarde non trouv√©e.");const r=a.data(),i=r.weekData.weekNumber,c=Ce(Y(w,"plans"),fe("userId","==",t)),f=await we(c);if(f.empty)throw new Error("Aucun plan de travail trouv√© pour y charger la sauvegarde.");const y=f.docs[0],p=H(w,"plans",y.id);await $e(p,{[`weeks.${i}`]:r.weekData}),localStorage.setItem("selectedPlanId",y.id),ut("menu")}catch(t){console.error("Erreur lors du chargement de la sauvegarde:",t),alert(t.message)}}async function Zn(e){if(confirm("√ätes-vous s√ªr de vouloir supprimer cette sauvegarde ? Cette action est d√©finitive."))try{await Oe(H(w,"plan_saves",e))}catch(t){console.error("Erreur lors de la suppression de la sauvegarde:",t),alert("La suppression a √©chou√©.")}}function ea(){const e=document.getElementById("all-plans-list"),t=ke();if(!t||!e)return e.innerHTML="<p>Erreur de chargement.</p>",()=>{};const n=Ce(Y(w,"plan_saves"),fe("userId","==",t)),a=Ve(n,r=>{if(e.innerHTML="",r.empty){e.innerHTML=`<p class="text-center text-gray-500 p-10 col-span-full">Vous n'avez aucune sauvegarde.</p>`;return}const i=r.docs.map(c=>({id:c.id,...c.data()}));i.sort((c,f)=>f.savedAt.toMillis()-c.savedAt.toMillis()),i.forEach(c=>{const f=document.createElement("div");f.className="bg-white rounded-xl shadow-md p-4 flex flex-col justify-between";const y=c.savedAt?.toDate().toLocaleString("fr-FR")||"Date inconnue",p=c.planData;let x="Plan vide ou sans donn√©es.";if(p&&p.weeks){const D=Object.keys(p.weeks).length;D>0&&(x=`Contient ${D} semaine(s).`)}const I=document.createElement("div");I.innerHTML=`
                <h3 class="text-lg font-bold text-gray-800 mb-2">${c.name}</h3>
                <p class="text-sm text-gray-500">Sauvegard√© le : ${y}</p>
                <p class="text-sm text-gray-600 mt-2">${x}</p>
            `;const v=document.createElement("div");v.className="mt-4 pt-4 border-t border-gray-200 flex items-center justify-end space-x-2";const M=document.createElement("button");M.className="btn btn-secondary btn-sm",M.textContent="Voir",M.addEventListener("click",()=>{localStorage.setItem("selectedPlanId",c.id),ut("view-plan")});const z=document.createElement("button");z.className="btn btn-primary btn-sm",z.textContent="Charger",z.addEventListener("click",()=>Xn(c.id)),z.style.display="none";const l=document.createElement("button");l.className="btn btn-ghost text-red-500 hover:bg-red-100 btn-sm",l.innerHTML='<i class="fas fa-trash"></i>',l.title="Supprimer la sauvegarde",l.addEventListener("click",()=>Zn(c.id)),v.appendChild(l),v.appendChild(M),v.appendChild(z),f.appendChild(I),f.appendChild(v),e.appendChild(f)})});return()=>{a()}}const ta=Object.freeze(Object.defineProperty({__proto__:null,default:ea},Symbol.toStringTag,{value:"Module"}));class Vt{constructor(t,n,a,r,i,c,f,y,p,x,I,v,M,z,l,D){this.db=t,this.modal=document.getElementById(n),this.form=document.getElementById(a),this.modalTitle=document.getElementById(r),this.recipeIdInput=document.getElementById(i),this.recipeNameInput=document.getElementById(c),this.recipeCategoryInput=document.getElementById(f),this.recipeServingsInput=document.getElementById(y),this.recipePrepTimeInput=document.getElementById(p),this.recipeDifficultyInput=document.getElementById(x),this.recipeImageUrlInput=document.getElementById("edit-recipe-image-url"),this.recipeStepsTextarea=document.getElementById(I),this.ingredientsListDiv=document.getElementById(v),this.addIngredientBtn=document.getElementById(M),this.saveRecipeBtn=document.getElementById(z),this.closeButton=document.getElementById(l),this.cancelButton=document.getElementById(D),this.masterIngredientList=[],this.activityUpdater=null,this.boundAddIngredient=()=>this.addIngredientInput(void 0,this.form.ingredients),this.boundCloseForm=()=>this.closeForm(),this.boundHandleSubmit=J=>this.handleSubmit(J),this.addIngredientBtn.addEventListener("click",this.boundAddIngredient),this.closeButton.addEventListener("click",this.boundCloseForm),this.cancelButton.addEventListener("click",this.boundCloseForm),this.saveRecipeBtn.addEventListener("click",this.boundHandleSubmit)}setActivityUpdater(t){this.activityUpdater=t}destroy(){this.addIngredientBtn.removeEventListener("click",this.boundAddIngredient),this.closeButton.removeEventListener("click",this.boundCloseForm),this.cancelButton.removeEventListener("click",this.boundCloseForm),this.saveRecipeBtn.removeEventListener("click",this.boundHandleSubmit)}async openForm(t=null,n="Ajouter une recette"){this.activityUpdater&&this.activityUpdater("editing_recipe"),await this.fetchMasterIngredients(),console.log("openForm called with recipe:",t,"and title:",n),this.form.reset(),this.ingredientsListDiv.innerHTML="",this.modalTitle.textContent=n;const a=[];if(this.form.ingredients=a,t){this.recipeIdInput.value=t.id||"",this.recipeNameInput.value=t.name||"";const r=t.category||"Plat";for(const i of this.recipeCategoryInput.options)if(i.value.toLowerCase()===r.toLowerCase()){i.selected=!0;break}this.recipeServingsInput.value=parseInt(t.servings)||"",this.recipePrepTimeInput.value=parseInt(t.prepTime)||"",this.recipeDifficultyInput.value=t.difficulty||"Moyen",this.recipeImageUrlInput.value=t.imageUrl||"",this.recipeStepsTextarea.value=t.steps||"",t.ingredients&&t.ingredients.length>0?t.ingredients.forEach(i=>this.addIngredientInput({...i},a)):this.addIngredientInput(void 0,a)}else this.recipeIdInput.value="",this.addIngredientInput(void 0,a);this.modal.classList.remove("hidden")}closeForm(){this.activityUpdater&&this.activityUpdater("idle"),this.modal.classList.add("hidden")}async fetchMasterIngredients(){if(this.masterIngredientList=[],!!this.db)try{const t=await we(Y(this.db,"ingredients"));this.masterIngredientList=t.docs.map(n=>({id:n.id,...n.data()})),this.masterIngredientList.sort((n,a)=>n.name.localeCompare(a.name))}catch(t){console.error("Erreur lors de la r√©cup√©ration de la liste des ingr√©dients: ",t),alert("Impossible de charger la liste des ingr√©dients de base. La recherche ne fonctionnera pas.")}}addIngredientInput(t={quantity:"",name:"",unit:""},n){const a=document.createElement("div");a.className="relative flex items-stretch space-x-2 ingredient-row";const r={...t};n.push(r);const i=n.length-1,c=document.createElement("input");c.type="text",c.className="ingredient-quantity mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm",c.placeholder="Qt√©",c.value=r.quantity,c.addEventListener("change",v=>{n[i].quantity=v.target.value});const f=document.createElement("input");f.type="text",f.className="ingredient-unit mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm bg-gray-100",f.placeholder="Unit√©",f.readOnly=!0,f.value=r.unit||"";const y=document.createElement("div");y.className="relative w-1/2";const p=document.createElement("input");p.type="text",p.className="ingredient-name mt-1 block w-full rounded-md border-gray-300 shadow-sm",p.placeholder="Chercher un ingr√©dient...",p.value=r.name,y.appendChild(p);const x=document.createElement("div");x.className="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto",y.appendChild(x),p.addEventListener("input",()=>{const v=p.value.toLowerCase();if(!v){x.classList.add("hidden");return}const M=this.masterIngredientList.filter(l=>l.name.toLowerCase().includes(v));x.innerHTML="",M.forEach(l=>{const D=document.createElement("div");D.className="p-2 ingredient-search-item cursor-pointer",D.textContent=l.name,D.addEventListener("click",()=>{p.value=l.name,f.value=l.unit,x.classList.add("hidden"),n[i].name=l.name,n[i].unit=l.unit,n[i].id=l.id}),x.appendChild(D)});const z=document.createElement("div");z.className="p-2 bg-blue-50 hover:bg-blue-200 cursor-pointer font-bold text-blue-700",z.textContent=`+ Cr√©er "${p.value}"`,z.addEventListener("click",async()=>{const l=p.value,D="pi√®ce(s)";try{const J=await Pe(Y(this.db,"ingredients"),{name:l,unit:D});await this.fetchMasterIngredients(),p.value=l,f.value=D,x.classList.add("hidden"),n[i].name=l,n[i].unit=D,n[i].id=J.id}catch(J){console.error("Erreur d'ajout d'ingr√©dient",J),alert("L'ingr√©dient n'a pas pu √™tre cr√©√©.")}}),x.appendChild(z),x.classList.remove("hidden")});const I=document.createElement("button");I.type="button",I.className="btn btn-ghost text-red-500 hover:bg-red-50 btn-sm mt-1",I.innerHTML='<i class="fas fa-trash"></i>',I.addEventListener("click",()=>{a.remove(),n[i]=null}),a.appendChild(y),a.appendChild(c),a.appendChild(f),a.appendChild(I),this.ingredientsListDiv.appendChild(a)}async handleSubmit(t){t.preventDefault(),this.saveRecipeBtn.disabled=!0,this.saveRecipeBtn.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i> Sauvegarde...',console.log("Ingredients array from form before filter:",this.form.ingredients);const n=this.form.ingredients.filter(i=>i!==null&&i.quantity&&i.name);console.log("Ingredients array after filter:",n);const a={name:this.recipeNameInput.value,category:this.recipeCategoryInput.value,servings:parseInt(this.recipeServingsInput.value)||0,prepTime:parseInt(this.recipePrepTimeInput.value)||0,difficulty:this.recipeDifficultyInput.value,steps:this.recipeStepsTextarea.value,ingredients:n,imageUrl:this.recipeImageUrlInput.value||`https://tse2.mm.bing.net/th?q=${encodeURIComponent(this.recipeNameInput.value)}%20recette&w=400&h=300&c=7&rs=1&p=0`};console.log("Recipe data being sent to Firebase:",a);const r=this.recipeIdInput.value;try{r?await yt(H(this.db,"recipes",r),a):await Pe(Y(this.db,"recipes"),a),this.closeForm(),console.log("Recipe saved successfully!"),this.onSaveCallback&&this.onSaveCallback()}catch(i){console.error("Erreur de sauvegarde: ",i),alert("Une erreur est survenue lors de la sauvegarde.")}finally{this.saveRecipeBtn.disabled=!1,this.saveRecipeBtn.textContent="Sauvegarder"}}setOnSaveCallback(t){this.onSaveCallback=t}}const na=Object.freeze(Object.defineProperty({__proto__:null,RecipeFormHandler:Vt},Symbol.toStringTag,{value:"Module"}));let jt=()=>{};function aa(){const e=document.getElementById("search-friends-input");return document.getElementById("search-friends-btn").addEventListener("click",()=>an(e.value)),e.addEventListener("keyup",n=>{n.key==="Enter"&&an(e.value)}),sa(),gn(),()=>{jt&&jt()}}async function sa(){const e=document.getElementById("friends-list-container"),t=je()?.uid;if(!t||!e)return;e.innerHTML='<p class="text-gray-500">Chargement...</p>';const n=H(w,"users",t);jt=Ve(n,async a=>{if(!a.exists()){e.innerHTML='<p class="text-red-500">Erreur: Utilisateur non trouv√©.</p>';return}const r=a.data().friends||[];if(e.innerHTML="",r.length===0){e.innerHTML=`<p class="text-gray-500">Vous n'avez pas encore d'amis. Utilisez la recherche pour en ajouter.</p>`;return}for(const i of r)try{const c=await Me(H(w,"users",i));c.exists()&&e.appendChild(ra(c.data()))}catch(c){console.error("Erreur de chargement d'un ami",c)}})}function ra(e){const t=document.createElement("div");t.className="bg-white p-3 rounded-lg flex items-center justify-between shadow-sm";const n=document.createElement("div");n.className="flex items-center",n.innerHTML=`
        <img src="${e.photoURL||"https://placehold.co/40"}" alt="Avatar" class="w-10 h-10 rounded-full mr-3">
        <div>
            <p class="font-bold">${e.displayName}</p>
            <p class="text-sm text-gray-500">${e.email}</p>
        </div>
    `;const a=document.createElement("button");return a.className="btn btn-ghost text-red-500 btn-sm",a.innerHTML='<i class="fas fa-user-times"></i>',a.title="Retirer cet ami",a.addEventListener("click",()=>ia(e.uid)),t.appendChild(n),t.appendChild(a),t}async function ia(e){const t=je()?.uid;if(!t||!e){console.error("Impossible de supprimer l'ami : ID utilisateur ou ID ami manquant.");return}if(!confirm("Voulez-vous vraiment retirer cet ami ? Cette action est unilat√©rale."))return;console.log(`Tentative de suppression de l'ami ${e} pour l'utilisateur ${t}`);const n=H(w,"users",t);try{await $e(n,{friends:un(e)}),console.log("Ami supprim√© avec succ√®s de la base de donn√©es.")}catch(a){console.error("Erreur lors de la suppression de l'ami: ",a),alert("Une erreur est survenue.")}}async function an(e){const t=document.getElementById("search-results-container"),n=je()?.uid;if(!(!e||!t)){t.innerHTML='<p class="text-gray-500">Recherche en cours...</p>';try{const a=e.toLowerCase(),r=a+"Ô£ø",i=Ce(Y(w,"users"),fe("displayName_lowercase",">=",a),fe("displayName_lowercase","<",r)),c=Ce(Y(w,"users"),fe("email","==",a)),[f,y]=await Promise.all([we(i),we(c)]),p=new Map;if(f.forEach(x=>p.set(x.id,x.data())),y.forEach(x=>p.set(x.id,x.data())),t.innerHTML="",p.size===0){t.innerHTML='<p class="text-gray-500">Aucun utilisateur trouv√©.</p>';return}p.forEach(x=>{if(x.uid===n)return;const I=document.createElement("div");I.className="bg-gray-50 p-2 rounded-lg flex items-center justify-between",I.innerHTML=`
                <div class="flex items-center">
                    <img src="${x.photoURL||"https://placehold.co/32"}" class="w-8 h-8 rounded-full mr-2">
                    <span class="font-medium text-sm">${x.displayName} (${x.email})</span>
                </div>
            `;const v=document.createElement("button");v.className="btn btn-secondary btn-xs",v.innerHTML='<i class="fas fa-user-plus"></i>',v.addEventListener("click",()=>oa(x.uid)),I.appendChild(v),t.appendChild(I)})}catch(a){console.error("Erreur de recherche: ",a),t.innerHTML='<p class="text-red-500">Erreur de recherche.</p>'}}}async function oa(e){const t=je()?.uid;if(!t||t===e)return;const n=Ce(Y(w,"friend_requests"),fe("senderId","==",t),fe("receiverId","==",e)),a=Ce(Y(w,"friend_requests"),fe("senderId","==",e),fe("receiverId","==",t)),[r,i]=await Promise.all([we(n),we(a)]);if(!r.empty||!i.empty)return alert("Une demande d'ami existe d√©j√† avec cet utilisateur.");if((await Me(H(w,"users",t))).data()?.friends?.includes(e))return alert("Vous √™tes d√©j√† ami avec cet utilisateur.");try{await Pe(Y(w,"friend_requests"),{senderId:t,receiverId:e,status:"pending",createdAt:Ct()}),alert("Demande d'ami envoy√©e !")}catch(f){console.error("Erreur lors de l'envoi de la demande d'ami: ",f),alert("Une erreur est survenue.")}}async function gn(){const e=document.getElementById("pending-requests-container"),t=document.getElementById("declined-requests-container"),n=je()?.uid;if(!(!n||!e||!t)){e.innerHTML='<p class="text-gray-500">Chargement...</p>',t.innerHTML='<p class="text-gray-500">Chargement...</p>';try{const a=Ce(Y(w,"friend_requests"),fe("senderId","==",n)),r=await we(a),i=[],c=[];for(const f of r.docs){const y={id:f.id,...f.data()},p=await Me(H(w,"users",y.receiverId));p.exists()&&(y.receiver=p.data()),y.status==="pending"?i.push(y):y.status==="declined"&&c.push(y)}e.innerHTML="",i.length>0?i.forEach(f=>e.appendChild(sn(f))):e.innerHTML='<p class="text-gray-500">Aucune demande en attente.</p>',t.innerHTML="",c.length>0?c.forEach(f=>t.appendChild(sn(f))):t.innerHTML='<p class="text-gray-500">Aucune demande rejet√©e.</p>'}catch(a){console.error("Erreur lors du chargement des demandes envoy√©es: ",a),e.innerHTML='<p class="text-red-500">Erreur de chargement.</p>',t.innerHTML='<p class="text-red-500">Erreur de chargement.</p>'}}}function sn(e){const t=document.createElement("div");t.className="bg-white p-3 rounded-lg flex items-center justify-between shadow-sm";const n=e.receiver,a=document.createElement("div");a.className="flex items-center",a.innerHTML=`
        <img src="${n?.photoURL||"https://placehold.co/40"}" alt="Avatar" class="w-10 h-10 rounded-full mr-3">
        <div>
            <p class="font-bold">${n?.displayName||"Utilisateur inconnu"}</p>
            <p class="text-sm text-gray-500">Statut : <span class="font-medium">${e.status}</span></p>
        </div>
    `;const r=document.createElement("button");return r.className="btn btn-ghost text-red-500 btn-sm",r.innerHTML='<i class="fas fa-times-circle"></i>',r.title="Annuler la demande",r.addEventListener("click",async()=>{confirm("Voulez-vous vraiment annuler cette demande ?")&&(await Oe(H(w,"friend_requests",e.id)),gn())}),t.appendChild(a),t.appendChild(r),t}async function hn(e){try{const t=H(w,"friend_requests",e);await $e(t,{status:"accepted"})}catch(t){throw console.error("Erreur lors de l'acceptation de la demande d'ami: ",t),t}}async function yn(e){try{const t=H(w,"friend_requests",e);await $e(t,{status:"declined"})}catch(t){throw console.error("Erreur lors du refus de la demande d'ami: ",t),t}}const la=Object.freeze(Object.defineProperty({__proto__:null,acceptFriendRequest:hn,declineFriendRequest:yn,default:aa},Symbol.toStringTag,{value:"Module"}));function da(){const e=document.getElementById("ingredients-list-container"),t=document.getElementById("add-ingredient-btn"),n=document.getElementById("category-tabs"),a=document.getElementById("search-bar"),r=document.getElementById("ingredient-form-modal"),i=document.getElementById("ingredient-modal-title"),c=document.getElementById("close-ingredient-modal"),f=document.getElementById("cancel-ingredient-btn"),y=document.getElementById("ingredient-form"),p=document.getElementById("ingredient-id"),x=document.getElementById("ingredient-name"),I=document.getElementById("ingredient-unit"),v=document.getElementById("ingredient-category"),M=document.getElementById("manage-categories-btn"),z=document.getElementById("category-management-modal"),l=document.getElementById("close-category-modal"),D=document.getElementById("done-category-modal-btn"),J=document.getElementById("add-category-form"),be=document.getElementById("new-category-name"),W=document.getElementById("category-list");let j=[],L=[],B="",P="",V=null;const X=["g","kg","ml","l","pi√®ce(s)","c.√†.s.","c.√†.c.","pinc√©e(s)"];async function G(){await re(),await F()}async function re(){if(w)try{L=(await we(Y(w,"ingredient_categories"))).docs.map(Q=>({id:Q.id,...Q.data()})),L.sort((Q,$)=>Q.name.localeCompare($.name))}catch(K){console.error("Erreur lors de la r√©cup√©ration des cat√©gories: ",K)}}async function F(){if(w)try{j=(await we(Y(w,"ingredients"))).docs.map(Q=>({id:Q.id,...Q.data()})),Z(),ce()}catch(K){console.error("Erreur de chargement des ingr√©dients: ",K)}}function le(K=null){y.reset(),I.innerHTML="",X.forEach(ee=>{const ue=document.createElement("option");ue.value=ee,ue.textContent=ee,I.appendChild(ue)});const Q=L.map(ee=>ee.name),$=[...new Set(j.map(ee=>ee.category).filter(Boolean))],_=[...new Set([...Q,...$])];_.sort((ee,ue)=>ee.localeCompare(ue.name)),v.innerHTML="",_.forEach(ee=>{const ue=document.createElement("option");ue.value=ee,ue.textContent=ee,v.appendChild(ue)}),K?(i.textContent="Modifier l'ingr√©dient",p.value=K.id,x.value=K.name,I.value=K.unit||"",v.value=K.category||(_.length>0?_[0]:""),document.getElementById("ingredient-image-url").value=K.imageUrl||""):(i.textContent="Ajouter un ingr√©dient",p.value="",I.value=X[0],v.value=B||(_.length>0?_[0]:"")),r.classList.remove("hidden")}function de(){r.classList.add("hidden")}async function T(K){K.preventDefault();const Q=p.value,$={name:x.value,unit:I.value,category:v.value,imageUrl:document.getElementById("ingredient-image-url").value||`https://tse2.mm.bing.net/th?q=${encodeURIComponent(x.value)}%20ingredient&w=400&h=300&c=7&rs=1&p=0`};if(!$.name||!$.category){alert("Le nom et la cat√©gorie sont requis.");return}try{Q?await yt(H(w,"ingredients",Q),$):await Pe(Y(w,"ingredients"),$),de(),await F()}catch(_){console.error("Erreur de sauvegarde de l'ingr√©dient: ",_)}}function S(){R(),z.classList.remove("hidden")}function U(){z.classList.add("hidden")}function R(){if(W.innerHTML="",L.length===0){W.innerHTML='<p class="text-gray-500">Aucune cat√©gorie d√©finie.</p>';return}L.forEach(K=>{const Q=document.createElement("div");Q.className="flex items-center justify-between p-2 border-b";const $=document.createElement("span");$.textContent=K.name,Q.appendChild($);const _=document.createElement("div");_.className="flex space-x-2";const ee=document.createElement("button");ee.className="btn btn-ghost btn-xs text-blue-500",ee.innerHTML='<i class="fas fa-edit"></i>',ee.addEventListener("click",()=>O(K)),_.appendChild(ee);const ue=document.createElement("button");ue.className="btn btn-ghost btn-xs text-red-500",ue.innerHTML='<i class="fas fa-trash"></i>',ue.addEventListener("click",()=>me(K)),_.appendChild(ue),Q.appendChild(_),W.appendChild(Q)})}async function te(K){K.preventDefault();const Q=be.value.trim();if(Q&&!L.find($=>$.name.toLowerCase()===Q.toLowerCase()))try{await Pe(Y(w,"ingredient_categories"),{name:Q}),be.value="",await re(),R(),Z()}catch($){console.error("Erreur d'ajout de cat√©gorie: ",$)}else alert("Cette cat√©gorie existe d√©j√† ou le nom est invalide.")}async function O(K){const Q=K.name,$=prompt(`Entrez le nouveau nom pour la cat√©gorie "${Q}":`,Q);if($&&$.trim()!==""&&$!==Q)try{await yt(H(w,"ingredient_categories",K.id),{name:$});const _=Ce(Y(w,"ingredients"),fe("category","==",Q)),ee=await we(_),ue=en(w);ee.forEach(Qe=>{ue.update(Qe.ref,{category:$})}),await ue.commit(),await G(),R()}catch(_){console.error("Erreur de renommage: ",_)}}async function me(K){if(confirm(`√ätes-vous s√ªr de vouloir supprimer la cat√©gorie "${K.name}"?

Tous les ingr√©dients associ√©s seront d√©plac√©s vers la cat√©gorie "Inconnue".`))try{await Oe(H(w,"ingredient_categories",K.id));const Q=Ce(Y(w,"ingredients"),fe("category","==",K.name)),$=await we(Q),_=en(w);$.forEach(ee=>{_.update(ee.ref,{category:"Inconnue"})}),await _.commit(),B="",await G(),R()}catch(Q){console.error("Erreur de suppression: ",Q)}}function Z(){n.innerHTML="";const K=L.map(_=>_.name),Q=[...new Set(j.map(_=>_.category||"Inconnue"))];let $=[...new Set([...K,...Q])];$.sort((_,ee)=>_.localeCompare(ee)),$.includes("Inconnue")&&($=$.filter(_=>_!=="Inconnue"),$.push("Inconnue")),$.length===0&&j.length>0&&$.push("Inconnue"),!B&&$.length>0&&(B=$[0]),$.forEach(_=>{const ee=document.createElement("button"),ue=_===B;ee.className=`px-4 py-2 text-sm font-medium rounded-t-lg ${ue?"bg-tomato text-white":"text-gray-500 hover:text-tomato"}`,ee.textContent=_,ee.addEventListener("click",()=>ie(_)),n.appendChild(ee)})}function ie(K){B=K,Z(),ce()}function ce(){e.innerHTML="";const K=B||(L.length>0?L[0].name:"Inconnue");let Q=j.filter(_=>(_.category||"Inconnue")===K);if(P){const _=P.toLowerCase();Q=Q.filter(ee=>ee.name.toLowerCase().includes(_))}if(Q.length===0){e.innerHTML='<p class="text-center text-gray-500 p-10">Aucun ingr√©dient dans cette cat√©gorie.</p>';return}Q.sort((_,ee)=>_.name.localeCompare(ee.name,"fr",{sensitivity:"base"}));const $=document.createElement("div");$.className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4",Q.forEach(_=>{const ee=document.createElement("div");if(ee.className="p-3 bg-white shadow-sm rounded-lg flex flex-col items-start space-y-2",_.imageUrl){const at=document.createElement("img");at.src=_.imageUrl,at.alt=_.name,at.className="w-full h-24 object-cover rounded-md mb-2",ee.appendChild(at)}const ue=document.createElement("div");ue.className="flex-grow w-full flex justify-between items-center";const Qe=document.createElement("span");Qe.className="font-medium text-gray-800",Qe.textContent=_.name;const mt=document.createElement("span");mt.className="text-gray-500 text-sm bg-gray-100 px-2 py-1 rounded-full",mt.textContent=_.unit,ue.appendChild(Qe),ue.appendChild(mt);const Xe=document.createElement("div");Xe.className="w-full flex justify-end items-center space-x-2 border-t pt-2 mt-2";const Ze=document.createElement("button");Ze.className="btn btn-ghost btn-xs text-blue-500 hover:bg-blue-50",Ze.innerHTML='<i class="fas fa-edit"></i>',Ze.addEventListener("click",()=>le(_));const nt=document.createElement("button");nt.className="btn btn-ghost btn-xs text-red-500 hover:bg-red-50",nt.innerHTML='<i class="fas fa-trash-alt"></i>',nt.addEventListener("click",()=>Be(_.id,_.name)),Xe.appendChild(Ze),Xe.appendChild(nt),ee.appendChild(ue),ee.appendChild(Xe),$.appendChild(ee)}),e.appendChild($)}async function Be(K,Q){if(confirm(`√ätes-vous s√ªr de vouloir supprimer l'ingr√©dient "${Q}" ?`))try{await Oe(H(w,"ingredients",K)),await F()}catch($){console.error("Erreur de suppression de l'ingr√©dient: ",$)}}a.addEventListener("input",K=>{const Q=K.target.value.toLowerCase();if(!P&&Q&&(V=B),P=Q,P){const $=j.find(_=>_.name.toLowerCase().includes(P));$&&(B=$.category||"Inconnue")}else V&&(B=V,V=null);Z(),ce()}),t.addEventListener("click",()=>le()),c.addEventListener("click",de),f.addEventListener("click",de),y.addEventListener("submit",T),M.addEventListener("click",S),l.addEventListener("click",U),D.addEventListener("click",U),J.addEventListener("submit",te),G()}const ca=Object.freeze(Object.defineProperty({__proto__:null,default:da},Symbol.toStringTag,{value:"Module"})),ne={modal:document.getElementById("share-modal"),closeBtn:document.getElementById("close-share-modal"),title:document.getElementById("share-modal-title"),friendsList:document.getElementById("share-friends-list"),sharePlanCheckbox:document.getElementById("share-planning-checkbox"),shareShoppingListCheckbox:document.getElementById("share-shopping-list-checkbox"),confirmBtn:document.getElementById("confirm-share-btn")};let ze={};function St(){ne.modal.classList.add("hidden");const e=document.getElementById("share-mode-selection");e&&e.classList.remove("hidden"),ne.confirmBtn.textContent="Envoyer le partage";const t=ne.confirmBtn.cloneNode(!0);ne.confirmBtn.parentNode&&(ne.confirmBtn.parentNode.replaceChild(t,ne.confirmBtn),ne.confirmBtn=t,t.addEventListener("click",bn))}async function bn(){const e=ke();if(!e||!ze.plan)return;const t=Array.from(ne.friendsList.querySelectorAll('input[type="checkbox"]:checked')).map(a=>a.value),n=document.querySelector('input[name="share-mode"]:checked')?.value;if(t.length===0){alert("Veuillez s√©lectionner au moins un ami.");return}if(!n){alert("Veuillez s√©lectionner un mode de partage.");return}ne.confirmBtn.disabled=!0,ne.confirmBtn.textContent="Envoi en cours...";try{const a=Y(w,"shares");let r={};n==="collaborate"?r={senderId:e,createdAt:new Date,type:"collaborative_plan_invite",planId:ze.plan.id,planName:ze.plan.name}:r={senderId:e,createdAt:new Date,type:"share",plan:{name:ze.plan.name,weeks:ze.plan.weeks||{},manualItems:ze.plan.manualItems||[],defaultNumPeople:ze.plan.defaultNumPeople||1,startDay:ze.plan.startDay||"Lundi"}};for(const i of t)await Pe(a,{...r,receiverId:i,status:"pending"});St(),alert("Partage envoy√© avec succ√®s !")}catch(a){console.error("Erreur lors de l'envoi du partage : ",a),alert("Une erreur est survenue lors de l'envoi du partage.")}finally{ne.confirmBtn.disabled=!1,ne.confirmBtn.textContent="Envoyer le partage"}}async function Qt(e={}){const{plan:t}=e;if(!t){alert("Aucun plan s√©lectionn√© √† partager.");return}ze={plan:t},ne.title.textContent=`Partager le plan "${t.name}"`,ne.friendsList.innerHTML='<p class="text-gray-500">Chargement des amis...</p>',ne.modal.classList.remove("hidden");const n=ke();if(n)try{const a=await Me(H(w,"users",n));if(a.exists()){const i=a.data().friends||[];if(i.length===0){ne.friendsList.innerHTML=`<p class="text-gray-500">Vous n'avez pas d'amis √† qui partager.</p>`;return}ne.friendsList.innerHTML="";for(const c of i){const f=await Me(H(w,"users",c));if(f.exists()){const y=f.data(),p=document.createElement("label");p.className="flex items-center p-2 hover:bg-gray-100 rounded-lg cursor-pointer";const x=document.createElement("input");x.type="checkbox",x.value=y.uid,x.className="form-checkbox h-5 w-5 text-tomato rounded focus:ring-tomato",p.appendChild(x);const I=document.createElement("img");I.src=y.photoURL||"https://placehold.co/40x40",I.alt=y.displayName,I.className="w-8 h-8 rounded-full ml-3 mr-3",p.appendChild(I);const v=document.createElement("span");v.className="font-medium",v.textContent=y.displayName||y.email,p.appendChild(v),ne.friendsList.appendChild(p)}}}}catch(a){console.error("Erreur lors du chargement des amis pour le partage : ",a),ne.friendsList.innerHTML='<p class="text-red-500">Une erreur est survenue.</p>'}}async function ua(e){const t=ke();if(!t||!e)return;const n=Array.from(ne.friendsList.querySelectorAll('input[type="checkbox"]:checked:not(:disabled)')).map(a=>a.value);if(n.length===0){alert("Veuillez s√©lectionner au moins un ami √† inviter.");return}ne.confirmBtn.disabled=!0,ne.confirmBtn.textContent="Envoi en cours...";try{const a=await Me(H(w,"plans",e));if(!a.exists())throw new Error("Plan not found");const r=a.data().name,i=Y(w,"shares"),c={senderId:t,createdAt:new Date,type:"collaborative_plan_invite",planId:e,planName:r};for(const f of n)await Pe(i,{...c,receiverId:f,status:"pending"});St(),alert("Invitation(s) envoy√©e(s) avec succ√®s !")}catch(a){console.error("Erreur lors de l'envoi de l'invitation : ",a),alert("Une erreur est survenue lors de l'envoi de l'invitation.")}finally{ne.confirmBtn.disabled=!1}}async function vn(e){if(!e||!e.id){alert("Plan non valide pour l'invitation.");return}ze={plan:e},ne.title.textContent=`Inviter √† collaborer sur "${e.name}"`;const t=document.getElementById("share-mode-selection");t&&t.classList.add("hidden"),ne.friendsList.innerHTML='<p class="text-gray-500">Chargement des amis...</p>',ne.modal.classList.remove("hidden");const n=ke();if(!n)return;try{const r=await Me(H(w,"users",n));if(r.exists()){const c=r.data().friends||[],f=[e.userId,...e.collaborators||[]];if(c.length===0){ne.friendsList.innerHTML=`<p class="text-gray-500">Vous n'avez pas d'amis √† inviter.</p>`;return}ne.friendsList.innerHTML="";for(const y of c){const p=await Me(H(w,"users",y));if(p.exists()){const x=p.data(),I=f.includes(x.uid),v=document.createElement("label");v.className=`flex items-center p-2 rounded-lg ${I?"opacity-50 cursor-not-allowed":"hover:bg-gray-100 cursor-pointer"}`;const M=document.createElement("input");M.type="checkbox",M.value=x.uid,M.className="form-checkbox h-5 w-5 text-tomato rounded focus:ring-tomato",I&&(M.disabled=!0,M.checked=!0),v.appendChild(M);const z=document.createElement("img");z.src=x.photoURL||"https://placehold.co/40x40",z.alt=x.displayName,z.className="w-8 h-8 rounded-full ml-3 mr-3",v.appendChild(z);const l=document.createElement("span");if(l.className="font-medium",l.textContent=x.displayName||x.email,I){const D=document.createElement("span");D.className="text-xs text-gray-400 ml-2",D.textContent="(d√©j√† membre)",l.appendChild(D)}v.appendChild(l),ne.friendsList.appendChild(v)}}}}catch(r){console.error("Erreur lors du chargement des amis pour l'invitation : ",r),ne.friendsList.innerHTML='<p class="text-red-500">Une erreur est survenue.</p>'}ne.confirmBtn.textContent="Envoyer l'invitation";const a=ne.confirmBtn.cloneNode(!0);ne.confirmBtn.parentNode.replaceChild(a,ne.confirmBtn),ne.confirmBtn=a,a.addEventListener("click",()=>ua(e.id))}ne.closeBtn?.addEventListener("click",St);ne.modal?.addEventListener("click",e=>{e.target===ne.modal&&St()});ne.confirmBtn?.addEventListener("click",bn);const ma=Object.freeze(Object.defineProperty({__proto__:null,openInviteParticipantModal:vn,openShareModal:Qt},Symbol.toStringTag,{value:"Module"}));function pa(){const e=document.getElementById("search-bar"),t=document.getElementById("lists-container"),n=document.getElementById("add-list-btn"),a=document.getElementById("shared-lists-container"),r=document.getElementById("list-form-modal"),i=document.getElementById("list-modal-title"),c=document.getElementById("close-list-modal"),f=document.getElementById("cancel-list-btn"),y=document.getElementById("list-form"),p=document.getElementById("list-id"),x=document.getElementById("list-name"),I=document.getElementById("ingredients-list"),v=document.getElementById("add-ingredient-btn"),M=document.getElementById("save-list-btn");let z=[],l="",D=[],J=[];async function be(){await W(),await j(),await L()}async function W(){if(w)try{D=(await we(Y(w,"ingredients"))).docs.map(S=>({id:S.id,...S.data()})),D.sort((S,U)=>S.name.localeCompare(U.name))}catch(T){console.error("Erreur lors de la r√©cup√©ration de la liste des ingr√©dients: ",T)}}async function j(){const T=ke();if(!(!w||!T))try{const S=Ce(Y(w,"shopping_lists"),fe("userId","==",T));z=(await we(S)).docs.map(R=>({id:R.id,...R.data()})).filter(R=>R.isShared!==!0),G()}catch(S){console.error("Erreur de chargement des listes: ",S)}}async function L(){const T=ke();if(!(!w||!T)){console.log(`Recherche de listes partag√©es pour userId: ${T}`);try{const S=Ce(Y(w,"shopping_lists"),fe("userId","==",T),fe("isShared","==",!0)),U=await we(S);console.log(`Trouv√© ${U.size} liste(s) partag√©e(s).`);const R=U.docs.map(te=>({id:te.id,...te.data()}));re(R)}catch(S){console.error("Erreur de chargement des listes partag√©es: ",S)}}}async function B(T=null){await W(),y.reset(),I.innerHTML="",J=[],T?(i.textContent="Modifier la liste",p.value=T.id,x.value=T.name,T.ingredients&&T.ingredients.length>0?T.ingredients.forEach(S=>X(S)):X()):(i.textContent="Cr√©er une liste",p.value="",X()),r.classList.remove("hidden")}function P(){r.classList.add("hidden")}async function V(T){T.preventDefault(),M.disabled=!0;const S=ke();if(!S){alert("Erreur : utilisateur non connect√©."),M.disabled=!1;return}const U=J.filter(O=>O&&O.name&&O.quantity),R={name:x.value,ingredients:U,userId:S};if(!R.name){alert("Le nom de la liste est requis."),M.disabled=!1;return}const te=p.value;try{te?await yt(H(w,"shopping_lists",te),R):await Pe(Y(w,"shopping_lists"),R),P(),await j()}catch(O){console.error("Erreur de sauvegarde de la liste: ",O)}finally{M.disabled=!1}}function X(T={quantity:"",name:"",unit:""}){const S=document.createElement("div");S.className="relative flex items-stretch space-x-2 ingredient-row";const U={...T};J.push(U);const R=J.length-1,te=document.createElement("input");te.type="text",te.className="ingredient-quantity mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm",te.placeholder="Qt√©",te.value=U.quantity,te.addEventListener("change",Be=>{J[R].quantity=Be.target.value});const O=document.createElement("input");O.type="text",O.className="ingredient-unit mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm bg-gray-100",O.placeholder="Unit√©",O.readOnly=!0,O.value=U.unit||"";const me=document.createElement("div");me.className="relative w-1/2";const Z=document.createElement("input");Z.type="text",Z.className="ingredient-name mt-1 block w-full rounded-md border-gray-300 shadow-sm",Z.placeholder="Chercher un ingr√©dient...",Z.value=U.name,me.appendChild(Z);const ie=document.createElement("div");ie.className="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto",me.appendChild(ie),Z.addEventListener("input",()=>{const Be=Z.value.toLowerCase();if(!Be){ie.classList.add("hidden");return}const K=D.filter($=>$.name.toLowerCase().includes(Be));ie.innerHTML="",K.forEach($=>{const _=document.createElement("div");_.className="p-2 ingredient-search-item cursor-pointer",_.textContent=$.name,_.addEventListener("click",()=>{Z.value=$.name,O.value=$.unit,ie.classList.add("hidden"),J[R].name=$.name,J[R].unit=$.unit,J[R].id=$.id}),ie.appendChild(_)});const Q=document.createElement("div");Q.className="p-2 bg-blue-50 hover:bg-blue-200 cursor-pointer font-bold text-blue-700",Q.textContent=`+ Cr√©er "${Z.value}"`,Q.addEventListener("click",async()=>{const $=Z.value,_="pi√®ce(s)";try{const ee=await Pe(Y(w,"ingredients"),{name:$,unit:_,category:"Inconnue"});await W(),Z.value=$,O.value=_,ie.classList.add("hidden"),J[R].name=$,J[R].unit=_,J[R].id=ee.id}catch(ee){console.error("Erreur d'ajout d'ingr√©dient",ee),alert("L'ingr√©dient n'a pas pu √™tre cr√©√©.")}}),ie.appendChild(Q),ie.classList.remove("hidden")});const ce=document.createElement("button");ce.type="button",ce.className="btn btn-ghost text-red-500 hover:bg-red-50 btn-sm mt-1",ce.innerHTML='<i class="fas fa-trash"></i>',ce.addEventListener("click",()=>{S.remove(),J[R]=null}),S.appendChild(me),S.appendChild(te),S.appendChild(O),S.appendChild(ce),I.appendChild(S)}function G(){t.innerHTML="";let T=z;if(l){const S=l.toLowerCase();T=z.filter(U=>U.name.toLowerCase().includes(S))}if(T.length===0){t.innerHTML='<p class="text-center text-gray-500 p-10 col-span-full">Aucune liste de courses trouv√©e.</p>';return}T.sort((S,U)=>S.name.localeCompare(U.name)),T.forEach(S=>{const U=document.createElement("div");U.className="bg-white rounded-lg shadow-md p-4 flex flex-col";const R=document.createElement("div");R.className="flex justify-between items-start border-b pb-2 mb-2";const te=document.createElement("h4");te.className="text-lg font-bold text-gray-800",te.textContent=S.name,R.appendChild(te);const O=document.createElement("div");O.className="flex space-x-2";const me=document.createElement("button");me.className="btn btn-ghost btn-sm text-blue-500",me.innerHTML='<i class="fas fa-edit"></i>',me.addEventListener("click",()=>B(S)),O.appendChild(me);const Z=document.createElement("button");Z.className="btn btn-ghost btn-sm text-green-500",Z.innerHTML='<i class="fas fa-share-alt"></i>',Z.addEventListener("click",()=>Qt({})),O.appendChild(Z);const ie=document.createElement("button");ie.className="btn btn-ghost btn-sm text-red-500",ie.innerHTML='<i class="fas fa-trash"></i>',ie.addEventListener("click",()=>F(S.id,S.name)),O.appendChild(ie),R.appendChild(O);const ce=document.createElement("ul");ce.className="space-y-1 text-sm text-gray-600 flex-grow",S.ingredients&&S.ingredients.length>0?S.ingredients.forEach(Be=>{const K=document.createElement("li");K.textContent=`${Be.quantity} ${Be.unit||""} - ${Be.name}`.trim(),ce.appendChild(K)}):ce.innerHTML='<li class="italic text-gray-400">Cette liste est vide.</li>',U.appendChild(R),U.appendChild(ce),t.appendChild(U)})}function re(T){if(a.innerHTML="",T.length===0){a.innerHTML='<p class="text-center text-gray-500 p-10 col-span-full">Aucune liste de courses partag√©e trouv√©e.</p>';return}T.sort((S,U)=>S.name.localeCompare(U.name)),T.forEach(S=>{const U=document.createElement("div");U.className="bg-white rounded-lg shadow-md p-4 flex flex-col";const R=document.createElement("div");R.className="flex justify-between items-start border-b pb-2 mb-2";const te=document.createElement("h4");te.className="text-lg font-bold text-gray-800",te.textContent=S.name,R.appendChild(te);const O=document.createElement("div");O.className="flex space-x-2";const me=document.createElement("button");me.className="btn btn-secondary btn-sm",me.innerHTML='<i class="fas fa-copy mr-2"></i> Copier dans mes listes',me.title="Copier cette liste dans vos listes personnelles",me.addEventListener("click",()=>de(S.id)),O.appendChild(me);const Z=document.createElement("button");Z.className="btn btn-ghost btn-sm text-red-500",Z.innerHTML='<i class="fas fa-trash"></i>',Z.title="Supprimer cette liste partag√©e",Z.addEventListener("click",()=>le(S.id,S.name)),O.appendChild(Z),R.appendChild(O);const ie=document.createElement("ul");ie.className="space-y-1 text-sm text-gray-600 flex-grow",S.ingredients&&S.ingredients.length>0?S.ingredients.forEach(ce=>{const Be=document.createElement("li");Be.textContent=`${ce.quantity} ${ce.unit||""} - ${ce.name}`.trim(),ie.appendChild(Be)}):ie.innerHTML='<li class="italic text-gray-400">Cette liste est vide.</li>',U.appendChild(R),U.appendChild(ie),a.appendChild(U)})}async function F(T,S){if(confirm(`√ätes-vous s√ªr de vouloir supprimer la liste "${S}" ?`))try{await Oe(H(w,"shopping_lists",T)),await j()}catch(U){console.error("Erreur de suppression de la liste: ",U)}}async function le(T,S){if(confirm(`√ätes-vous s√ªr de vouloir supprimer la liste partag√©e "${S}" ?`))try{await Oe(H(w,"shopping_lists",T)),await L()}catch(U){console.error("Erreur de suppression de la liste partag√©e: ",U),alert("Une erreur est survenue.")}}async function de(T){if(confirm("Voulez-vous vraiment copier cette liste dans vos listes personnelles ? Elle ne sera plus consid√©r√©e comme une liste partag√©e."))try{const S=H(w,"shopping_lists",T);await $e(S,{isShared:!1}),await be()}catch(S){console.error("Erreur lors de la copie de la liste: ",S),alert("Une erreur est survenue.")}}e.addEventListener("input",T=>{l=T.target.value,G()}),n.addEventListener("click",()=>B()),c.addEventListener("click",P),f.addEventListener("click",P),y.addEventListener("submit",V),v.addEventListener("click",()=>X()),w&&be()}const fa=Object.freeze(Object.defineProperty({__proto__:null,default:pa},Symbol.toStringTag,{value:"Module"})),Fe=mn();let bt,Dt,_t,gt,Ee,vt,Pt,$t,ht,tt,xt,Ht,Rt,qt,Ut,kt=null,Bt=null;function Ft(){bt&&bt.classList.remove("hidden")}function pt(){bt&&bt.classList.add("hidden"),gt&&gt.reset()}function xn(e,t){Bt=e,tt&&(tt.value=t),vt&&vt.classList.remove("hidden"),tt&&tt.focus()}function ft(){Bt=null,vt&&vt.classList.add("hidden"),ht&&ht.reset()}function En(e,t){kt=e,qt&&(qt.textContent="Confirmer la suppression"),Ut&&(Ut.textContent=`√ätes-vous s√ªr de vouloir supprimer le plan "${t}" ? Cette action est irr√©versible.`),xt&&xt.classList.remove("hidden")}function At(){kt=null,xt&&xt.classList.add("hidden")}async function ga(e){const t=je();if(t)try{await Pe(Y(Fe,"plans"),{userId:t.uid,name:e,type:"personal",weeks:{},manualItems:[],checkedItems:{},defaultNumPeople:1,startDay:"Lundi",lastUpdated:new Date}),pt()}catch(n){console.error("Error creating plan: ",n),alert("Erreur lors de la cr√©ation du plan.")}}async function ha(e,t){if(!(!e||!t))try{const n=H(Fe,"plans",e);await $e(n,{name:t}),ft()}catch(n){console.error("Error renaming plan: ",n),alert("Erreur lors du renommage du plan.")}}async function ya(e){const t=je()?.uid;if(!(!e||!t)&&confirm("Voulez-vous vraiment quitter ce plan partag√© ? Il n'appara√Ætra plus dans votre liste."))try{const n=H(Fe,"plans",e);await $e(n,{collaborators:un(t)})}catch(n){console.error("Erreur pour quitter le plan: ",n),alert("Une erreur est survenue.")}}async function ba(e){if(e)try{await Oe(H(Fe,"plans",e))}catch(t){console.error("Error deleting plan: ",t),alert("Erreur lors de la suppression du plan.")}}function Wt(e){const t=je();if(!t)return()=>{};let n=new Map;const a=()=>{e(Array.from(n.values()).sort((p,x)=>p.name.localeCompare(x.name)))},r=async p=>{const I=[p.userId,...p.collaborators||[]].map(M=>Me(H(Fe,"users",M)));return(await Promise.all(I)).map(M=>M.exists()?M.data():{uid:M.id,displayName:"Inconnu"})},i=Ce(Y(Fe,"plans"),fe("userId","==",t.uid)),c=Ve(i,async p=>{const I=p.docChanges().map(async v=>{if(v.type==="removed")n.delete(v.doc.id);else{const M=v.doc.data(),z=await r(M);n.set(v.doc.id,{id:v.doc.id,...M,isOwner:!0,participants:z})}});await Promise.all(I),a()}),f=Ce(Y(Fe,"plans"),fe("collaborators","array-contains",t.uid)),y=Ve(f,async p=>{const I=p.docChanges().map(async v=>{if(v.type==="removed")n.delete(v.doc.id);else{const M=v.doc.data(),z=await r(M),l=z.find(D=>D.uid===M.userId);n.set(v.doc.id,{id:v.doc.id,...M,isOwner:!1,ownerName:l?.displayName||"Inconnu",participants:z})}});await Promise.all(I),a()});return()=>{c(),y()}}function wn(e){if(!Ee)return;const t=Ee.value;if(Ee.innerHTML="",e.length===0){const n=document.createElement("option");n.value="",n.textContent="Aucun plan personnel",n.disabled=!0,Ee.appendChild(n);return}e.forEach(n=>{const a=document.createElement("option");a.value=n.id;let r=n.name;n.collaborators&&n.collaborators.length>0&&(n.isOwner?r=`üëë ${n.name} [Collab]`:r=`üë• ${n.name} [Collab] (de ${n.ownerName})`),a.textContent=r,Ee.appendChild(a)}),t&&Ee.querySelector(`option[value="${t}"]`)?Ee.value=t:Ee.selectedIndex=0}function Ln(){bt=document.getElementById("create-plan-modal"),Dt=document.getElementById("close-create-plan-modal"),_t=document.getElementById("cancel-create-plan-btn"),gt=document.getElementById("create-plan-form"),Ee=document.getElementById("plan-select"),vt=document.getElementById("rename-plan-modal"),Pt=document.getElementById("close-rename-plan-modal"),$t=document.getElementById("cancel-rename-plan-btn"),ht=document.getElementById("rename-plan-form"),tt=document.getElementById("new-plan-name"),xt=document.getElementById("delete-confirm-modal"),Ht=document.getElementById("cancel-delete-btn"),Rt=document.getElementById("confirm-delete-btn"),qt=document.getElementById("delete-confirm-title"),Ut=document.getElementById("delete-confirm-message");const e=document.getElementById("create-plan-btn"),t=document.getElementById("rename-plan-btn"),n=document.getElementById("leave-plan-btn"),a=document.getElementById("delete-plan-btn"),r=x=>{x.preventDefault();const I=document.getElementById("plan-name");I&&I.value&&ga(I.value)},i=x=>{x.preventDefault(),Bt&&tt.value&&ha(Bt,tt.value)},c=()=>{kt&&ba(kt).then(()=>{At()})},f=()=>{if(Ee&&Ee.value){const x=Ee.options[Ee.selectedIndex];xn(Ee.value,x.text)}else alert("Veuillez s√©lectionner un plan √† renommer.")},y=()=>{Ee&&Ee.value?ya(Ee.value):alert("Veuillez s√©lectionner un plan.")},p=()=>{if(Ee&&Ee.value){const x=Ee.options[Ee.selectedIndex].text;En(Ee.value,x)}else alert("Veuillez s√©lectionner un plan √† supprimer.")};return e?.addEventListener("click",Ft),t?.addEventListener("click",f),n?.addEventListener("click",y),a?.addEventListener("click",p),Dt?.addEventListener("click",pt),_t?.addEventListener("click",pt),gt?.addEventListener("submit",r),Pt?.addEventListener("click",ft),$t?.addEventListener("click",ft),ht?.addEventListener("submit",i),Ht?.addEventListener("click",At),Rt?.addEventListener("click",c),()=>{e?.removeEventListener("click",Ft),t?.removeEventListener("click",f),n?.removeEventListener("click",y),a?.removeEventListener("click",p),Dt?.removeEventListener("click",pt),_t?.removeEventListener("click",pt),gt?.removeEventListener("submit",r),Pt?.removeEventListener("click",ft),$t?.removeEventListener("click",ft),ht?.removeEventListener("submit",i),Ht?.removeEventListener("click",At),Rt?.removeEventListener("click",c)}}async function Cn(e,t){if(!(!e||!t))try{const n=H(Fe,"plans",e);await $e(n,{collaborators:Fn(t),type:"collaborative"})}catch(n){console.error("Error adding collaborator: ",n)}}async function Ot(e,t,n="Modification diverse"){if(!e||!t)return;const a=je();if(a)try{const r=Y(Fe,"plans",e,"history"),i=JSON.parse(JSON.stringify(t));await Pe(r,{planState:i,timestamp:Ct(),modifiedBy:a.uid,modifiedByName:a.displayName||a.email,description:n})}catch(r){console.error("Error saving history:",r)}}async function In(e,t){const n=je();if(!(!n||!e||!t))try{const a=Y(Fe,"plan_saves"),r=Ce(a,fe("userId","==",n.uid),fe("name","==",e)),i=await we(r);if(i.empty)await Pe(a,{userId:n.uid,name:e,savedAt:Ct(),planData:t});else{const c=i.docs[0].id,f=H(Fe,"plan_saves",c);await $e(f,{planData:t,savedAt:Ct()})}}catch(a){console.error("Error saving or updating plan save:",a),alert("Erreur lors de la sauvegarde.")}}async function va(e,t,n){if(!e||!t||!n)return;const a=H(Fe,"plans",e);try{await $e(a,{[`weeks.${t}`]:n,lastUpdated:new Date}),console.log(`Week ${t} of plan ${e} saved successfully.`)}catch(r){console.error("Error saving plan week:",r),alert("Erreur lors de la sauvegarde du plan.")}}const xa=Object.freeze(Object.defineProperty({__proto__:null,addCollaborator:Cn,getUserPlans:Wt,initPlanManagement:Ln,openCreatePlanModal:Ft,openDeleteConfirmModal:En,openRenamePlanModal:xn,populatePlanSelector:wn,saveHistory:Ot,saveOrUpdatePlanSaveByName:In,savePlanWeek:va},Symbol.toStringTag,{value:"Module"}));let kn=[],Bn=[],Sn=()=>{},Mn=()=>{};const se={btn:null,btnMobile:null,badge:null,badgeMobile:null,dropdown:null,list:null};async function Ea(e,t,n){const a=ke();if(a)try{const r=H(w,"shares",e);if(await $e(r,{status:"accepted"}),t.plan){const i=n.displayName||"Inconnu",c=`Copie de "${t.plan.name}" (de ${i})`,f={...t.plan,userId:a,name:c,isShared:!0,originalOwnerId:t.senderId,sharedAt:new Date,collaborators:[]};delete f.id,await Pe(Y(w,"plans"),f)}t.shoppingList&&await Pe(Y(w,"shopping_lists"),{name:`${t.shoppingList.name} (de ${n.displayName})`,ingredients:t.shoppingList.ingredients,userId:a,isShared:!0,originalOwner:n.uid,sharedAt:new Date})}catch(r){console.error("Erreur lors de l'acceptation du partage : ",r),alert("Une erreur est survenue.")}}async function wa(e,t){const n=ke();if(!(!n||!t||!t.planId))try{await Cn(t.planId,n);const a=H(w,"shares",e);await $e(a,{status:"accepted"})}catch(a){console.error("Erreur lors de l'acceptation de l'invitation : ",a),alert("Une erreur est survenue.")}}async function rn(e){try{const t=H(w,"shares",e);await $e(t,{status:"declined"})}catch(t){console.error("Erreur lors du refus du partage : ",t),alert("Une erreur est survenue.")}}async function La(e){try{await hn(e)}catch{alert("Erreur lors de l'acceptation.")}}async function Ca(e){try{await yn(e)}catch{alert("Erreur lors du refus.")}}function Nn(){if(!se.list)return;const e=[...kn,...Bn];e.sort((n,a)=>a.createdAt.toMillis()-n.createdAt.toMillis());const t=n=>{n&&(e.length>0?(n.textContent=e.length,n.classList.remove("hidden")):n.classList.add("hidden"))};t(se.badge),t(se.badgeMobile),se.list.innerHTML="",e.length===0?se.list.innerHTML='<p class="text-gray-500 text-center p-4">Aucune nouvelle notification.</p>':e.forEach(n=>{const a=Ia(n);se.list.appendChild(a)})}function Ia(e){const t=document.createElement("div");t.className="p-3 border-b border-gray-100 hover:bg-gray-50";const n=document.createElement("p");n.className="text-sm font-medium text-gray-800";const a=document.createElement("p");a.className="text-xs text-gray-500 mb-3";const r=document.createElement("div");r.className="flex space-x-2 justify-end";const i=e.data.type||e.type;if(i==="collaborative_plan_invite"){n.textContent="Invitation √† collaborer",a.textContent=`${e.sender.displayName} vous invite √† modifier son plan "${e.data.planName}".`;const c=rt("Accepter","btn-secondary",y=>{y.target.textContent="...",y.target.disabled=!0,wa(e.id,e.data)}),f=rt("Refuser","btn-ghost text-red-500",y=>{y.target.disabled=!0,rn(e.id)});r.append(c,f)}else if(i==="share"){n.textContent=`Partage de ${e.sender.displayName||e.sender.email}`;let c=[];e.data.plan&&c.push("planification"),e.data.shoppingList&&c.push("liste de courses"),a.textContent=`Contenu : ${c.join(" et ")}`;const f=rt("Accepter","btn-secondary",p=>{p.target.textContent="...",p.target.disabled=!0,Ea(e.id,e.data,e.sender)}),y=rt("Refuser","btn-ghost text-red-500",p=>{p.target.disabled=!0,rn(e.id)});r.append(f,y)}else if(i==="friend_request"){n.textContent="Invitation d'ami",a.textContent=`${e.sender.displayName||e.sender.email} vous a envoy√© une invitation.`;const c=rt("Accepter","btn-secondary",y=>{y.target.textContent="...",y.target.disabled=!0,La(e.id)}),f=rt("Refuser","btn-ghost text-red-500",y=>{y.target.disabled=!0,Ca(e.id)});r.append(c,f)}return t.append(n,a,r),t}function rt(e,t,n){const a=document.createElement("button");return a.className=`btn btn-xs ${t}`,a.textContent=e,a.addEventListener("click",r=>{r.stopPropagation(),n(r)}),a}function ka(e){const t=Y(w,"shares"),n=Ce(t,fe("receiverId","==",e),fe("status","==","pending"));Sn=Ve(n,async a=>{const r=[];for(const i of a.docs){const c=i.data(),f=await Me(H(w,"users",c.senderId));f.exists()&&r.push({type:c.type||"share",id:i.id,data:c,sender:f.data(),createdAt:c.createdAt})}kn=r,Nn()},a=>{console.error("Erreur d'√©coute des partages:",a)})}function Ba(e){const t=Y(w,"friend_requests"),n=Ce(t,fe("receiverId","==",e),fe("status","==","pending"));Mn=Ve(n,async a=>{const r=[];for(const i of a.docs){const c=i.data(),f=await Me(H(w,"users",c.senderId));f.exists()&&r.push({type:"friend_request",id:i.id,data:c,sender:f.data(),createdAt:c.createdAt})}Bn=r,Nn()},a=>{console.error("Erreur d'√©coute des invitations d'amis:",a)})}function Tn(){if(se.btn=document.getElementById("notifications-btn"),se.btnMobile=document.getElementById("notifications-btn-mobile"),se.badge=document.getElementById("notifications-badge"),se.badgeMobile=document.getElementById("notifications-badge-mobile"),se.dropdown=document.getElementById("notifications-dropdown"),se.list=document.getElementById("notifications-list"),!se.btn||!se.dropdown)return;const e=ke();if(!e)return;Sn(),Mn(),ka(e),Ba(e);const t=n=>{if(n.stopPropagation(),!se.dropdown.classList.toggle("hidden")){const r=window.innerWidth<768,i=r?se.btnMobile:se.btn;if(!i)return;const c=i.getBoundingClientRect();se.dropdown.style.position="fixed",r?(se.dropdown.style.top=`${c.bottom+8}px`,se.dropdown.style.left="50%",se.dropdown.style.transform="translateX(-50%)",se.dropdown.style.width="95vw",se.dropdown.style.right="auto"):(se.dropdown.style.top=`${c.bottom+8}px`,se.dropdown.style.left="auto",se.dropdown.style.right=`${window.innerWidth-c.right}px`,se.dropdown.style.transform="none",se.dropdown.style.width="20rem")}};se.btn.addEventListener("click",t),se.btnMobile&&se.btnMobile.addEventListener("click",t),document.addEventListener("click",n=>{se.dropdown&&!se.dropdown.classList.contains("hidden")&&(se.btn.contains(n.target)||se.btnMobile&&se.btnMobile.contains(n.target)||se.dropdown.contains(n.target)||se.dropdown.classList.add("hidden"))})}const Sa=Object.freeze(Object.defineProperty({__proto__:null,initNotifications:Tn},Symbol.toStringTag,{value:"Module"}));let Ye=null,ct=null;function Dn(e,t){if(!Tt||!e)return;const n=je();if(!n)return;const a=tn(Tt,`plans_presence/${e}`);Ye=tn(Tt,`plans_presence/${e}/${n.uid}`);const r={displayName:n.displayName||n.email,photoURL:n.photoURL,status:"idle",last_seen:pn()};On(Ye).remove(),zn(Ye,r),ct&&ct(),ct=Vn(a,i=>{const c=i.val()||{};typeof t=="function"&&t(c)})}function _n(){Ye&&(Qn(Ye),Ye=null),ct&&(ct(),ct=null)}function Lt(e){Ye&&Wn(Ye,{status:e,last_seen:pn()})}const Ma=Object.freeze(Object.defineProperty({__proto__:null,connectToPresenceChannel:Dn,disconnectFromPresenceChannel:_n,updateUserActivity:Lt},Symbol.toStringTag,{value:"Module"}));let it=null;async function Jt(e,t){if(!e)return;const n=H(w,"recipes",e);try{await $e(n,{isFavorite:!t})}catch(a){console.error("Error toggling favorite status:",a)}}function Na(){const e=document.getElementById("search-bar"),t=document.getElementById("category-tabs"),n=document.getElementById("recipe-list-container"),a=document.getElementById("add-recipe-btn");it&&it.destroy(),it=new Vt(w,"edit-recipe-form-modal","edit-recipe-form","edit-recipe-modal-title","edit-recipe-id","edit-recipe-name","edit-recipe-category","edit-recipe-servings","edit-recipe-prep-time","edit-recipe-difficulty","edit-recipe-steps","edit-ingredients-list","edit-add-ingredient-btn","edit-save-recipe-btn","close-edit-recipe-modal","edit-cancel-recipe-btn"),it.setOnSaveCallback(()=>{});let r=[],i="",c="",f=null;const y=["Entr√©e","Plat","Accompagnement","Dessert"],p={PLAT:"bg-orange-100",DESSERT:"bg-amber-100",ENTREE:"bg-lime-100",ACCOMPAGNEMENT:"bg-stone-200","PETIT-DEJEUNER":"bg-orange-100",BOISSON:"bg-cyan-100",SAUCE:"bg-red-100"},x={PLAT:"text-orange-800",DESSERT:"text-amber-800",ENTREE:"text-lime-800",ACCOMPAGNEMENT:"text-stone-800","PETIT-DEJEUNER":"text-orange-800",BOISSON:"text-cyan-800",SAUCE:"text-red-800"},I="bg-gray-100",v="text-gray-800";function M(){return w?Ve(Y(w,"recipes"),j=>{console.log("Recipe data updated on /recipes page from listener."),r=j.docs.map(L=>({id:L.id,...L.data()})),l(),D()},j=>{console.error("Erreur lors de l'√©coute des recettes: ",j)}):()=>{}}function z(W){i=W,l(),D()}function l(){if(!t)return;t.innerHTML="";const j=[...new Set(r.map(L=>L.category||"Non class√©"))].sort((L,B)=>{const P=G=>{const re=G.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();for(let F=0;F<y.length;F++)if(y[F].normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()===re)return F;return-1},V=P(L),X=P(B);return V>-1&&X>-1?V-X:V>-1?-1:X>-1?1:L.localeCompare(B)});!i&&j.length>0&&(i=j[0]),j.forEach(L=>{const B=document.createElement("button"),P=L.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toUpperCase();if(L===i){const X=p[P]||I,G=x[P]||v;B.className=`px-4 py-2 text-sm font-bold rounded-t-lg ${X} ${G}`}else B.className="px-4 py-2 text-sm font-medium text-gray-500 hover:text-tomato";B.textContent=L,B.addEventListener("click",()=>z(L)),t.appendChild(B)})}function D(){if(!n)return;n.innerHTML="";let W=r.filter(L=>(L.category||"Non class√©")===i);if(c){const L=c.toLowerCase();W=W.filter(B=>B.name.toLowerCase().includes(L))}if(W.sort((L,B)=>L.name.localeCompare(B.name)),W.length===0){n.innerHTML='<p class="text-gray-500 text-center p-10">Aucune recette trouv√©e.</p>';return}const j=document.createElement("div");j.className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4",W.forEach(L=>{j.appendChild(J(L))}),n.appendChild(j)}function J(W){const j=document.createElement("div");if(j.className="bg-white dark:bg-gray-800 shadow-md rounded-lg flex flex-col p-3",W.imageUrl){const le=document.createElement("img");le.src=W.imageUrl,le.alt=W.name,le.className="w-full h-24 object-cover rounded-md mb-2",j.appendChild(le)}const L=document.createElement("div");L.className="w-full flex justify-between items-start";const B=document.createElement("h4");B.className="font-bold text-gray-800 dark:text-gray-200 pr-2",B.textContent=W.name,B.title=W.name,L.appendChild(B);const P=document.createElement("button");P.className="text-lg flex-shrink-0",P.innerHTML='<i class="fas fa-heart"></i>',W.isFavorite?P.classList.add("text-red-500"):P.classList.add("text-gray-300","dark:text-gray-500","hover:text-red-400"),P.addEventListener("click",le=>{le.stopPropagation(),Jt(W.id,W.isFavorite)}),L.appendChild(P),j.appendChild(L);const V=document.createElement("p");V.className="text-sm text-gray-600 dark:text-gray-400 mt-1 w-full",V.textContent=`${W.difficulty||""} - Pour ${W.servings||"?"} pers.`,j.appendChild(V);const X=document.createElement("div");X.className="flex-grow",j.appendChild(X);const G=document.createElement("div");G.className="w-full flex justify-end items-center space-x-2 border-t dark:border-gray-700 pt-2 mt-2";const re=document.createElement("button");re.className="btn btn-ghost btn-sm text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/50",re.innerHTML='<i class="fas fa-edit"></i>',re.title="Modifier",re.addEventListener("click",()=>it.openForm(W,"Modifier la recette")),G.appendChild(re);const F=document.createElement("button");return F.className="btn btn-ghost btn-sm text-red-500 hover:bg-red-50 dark:hover:bg-red-900/50",F.innerHTML='<i class="fas fa-trash-alt"></i>',F.title="Supprimer",F.addEventListener("click",()=>be(W.id,W.name)),G.appendChild(F),j.appendChild(G),j}async function be(W,j){if(confirm(`√ätes-vous s√ªr de vouloir supprimer la recette "${j}" ?`))try{await Oe(H(w,"recipes",W)),fetchAllRecipes()}catch(L){console.error("Erreur lors de la suppression: ",L)}}if(a.addEventListener("click",()=>it.openForm(null,"Ajouter une recette")),e.addEventListener("input",W=>{const j=W.target.value;if(!c&&j&&(f=i),c=j,c){const L=c.toLowerCase(),B=r.find(P=>P.name.toLowerCase().includes(L));B&&(i=B.category||"Non class√©")}else f&&(i=f,f=null);l(),D()}),w)return M()}const Ta=Object.freeze(Object.defineProperty({__proto__:null,default:Na,toggleFavoriteStatus:Jt},Symbol.toStringTag,{value:"Module"})),Da="modulepreload",_a=function(e){return"/"+e},on={},dt=function(t,n,a){let r=Promise.resolve();if(n&&n.length>0){let y=function(p){return Promise.all(p.map(x=>Promise.resolve(x).then(I=>({status:"fulfilled",value:I}),I=>({status:"rejected",reason:I}))))};document.getElementsByTagName("link");const c=document.querySelector("meta[property=csp-nonce]"),f=c?.nonce||c?.getAttribute("nonce");r=y(n.map(p=>{if(p=_a(p),p in on)return;on[p]=!0;const x=p.endsWith(".css"),I=x?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${p}"]${I}`))return;const v=document.createElement("link");if(v.rel=x?"stylesheet":Da,x||(v.as="script"),v.crossOrigin="",v.href=p,f&&v.setAttribute("nonce",f),document.head.appendChild(v),x)return new Promise((M,z)=>{v.addEventListener("load",M),v.addEventListener("error",()=>z(new Error(`Unable to preload CSS for ${p}`)))})}))}function i(c){const f=new Event("vite:preloadError",{cancelable:!0});if(f.payload=c,window.dispatchEvent(f),!f.defaultPrevented)throw c}return r.then(c=>{for(const f of c||[])f.status==="rejected"&&i(f.reason);return t().catch(i)})};let Ge=null;function Pa(){const e={mealPlanGrid:document.getElementById("meal-plan-grid"),currentWeekDisplay:document.getElementById("current-week-display"),prevWeekBtn:document.getElementById("prev-week-btn"),nextWeekBtn:document.getElementById("next-week-btn"),clearMenuBtn:document.getElementById("clear-menu-btn"),shoppingListContainer:document.getElementById("shopping-list"),startDaySelect:document.getElementById("start-day-select"),defaultServingsControl:document.getElementById("default-servings-control"),mealSelectModal:document.getElementById("meal-select-modal"),closeMealSelectModalBtn:document.getElementById("close-meal-select-modal"),mealSelectModalTitle:document.getElementById("meal-select-modal-title"),mealSelectList:document.getElementById("meal-select-list"),recipeFormModal:document.getElementById("edit-recipe-form-modal"),closeRecipeModalBtn:document.getElementById("close-edit-recipe-modal"),cancelRecipeBtn:document.getElementById("edit-cancel-recipe-btn"),recipeForm:document.getElementById("edit-recipe-form"),addItemInput:document.getElementById("add-item-input"),addItemBtn:document.getElementById("add-item-btn"),addItemResults:document.getElementById("add-item-results"),importListBtn:document.getElementById("import-list-btn"),importListModal:document.getElementById("import-list-modal"),closeImportListModalBtn:document.getElementById("close-import-list-modal"),importListContainer:document.getElementById("import-list-container"),exportTxtBtn:document.getElementById("export-txt-btn"),exportPdfBtn:document.getElementById("export-pdf-btn"),exportPlanPdfBtn:document.getElementById("export-plan-pdf-btn"),sharePlanBtn:document.getElementById("share-plan-btn"),planSelect:document.getElementById("plan-select"),inviteParticipantBtn:document.getElementById("invite-participant-btn"),historyPlanBtn:document.getElementById("history-plan-btn"),planHistoryModal:document.getElementById("plan-history-modal"),closePlanHistoryModalBtn:document.getElementById("close-plan-history-modal"),planHistoryList:document.getElementById("plan-history-list"),savePlanBtn:document.getElementById("save-plan-btn"),openTrashBtn:document.getElementById("open-trash-btn"),trashCount:document.getElementById("trash-count"),trashModal:document.getElementById("trash-modal"),closeTrashModalBtn:document.getElementById("close-trash-modal"),trashListContainer:document.getElementById("trash-list-container"),emptyTrashBtn:document.getElementById("empty-trash-btn")};function t(s,o){const d=document.createElement("div");d.className="flex items-center space-x-2";const b=document.createElement("button");b.className="btn btn-outline btn-xs",b.textContent="-";const u=document.createElement("span");u.className="font-medium text-center w-6",u.textContent=s;const h=document.createElement("button");return h.className="btn btn-outline btn-xs",h.textContent="+",b.addEventListener("click",()=>{let g=parseInt(u.textContent,10);g>1&&(g--,u.textContent=g,o(g))}),h.addEventListener("click",()=>{let g=parseInt(u.textContent,10);g++,u.textContent=g,o(g)}),d.appendChild(b),d.appendChild(u),d.appendChild(h),d}function n(s,o,d,b=!1){const u=document.createElement("div");u.className="flex flex-col items-center justify-center h-full";const h=document.createElement("button");h.className="btn btn-ghost btn-xs p-0 h-4 flex items-center justify-center w-full",h.innerHTML='<i class="fas fa-plus"></i>',h.disabled=b;const g=document.createElement("span");g.className="font-medium text-center text-sm my-1",g.textContent=s;const m=document.createElement("button");return m.className="btn btn-ghost btn-xs p-0 h-4 flex items-center justify-center w-full",m.innerHTML='<i class="fas fa-minus"></i>',m.disabled=b,o&&(h.classList.add("text-white"),g.classList.add("text-white"),m.classList.add("text-white")),b||(h.addEventListener("click",()=>{let E=parseInt(g.textContent,10);E++,g.textContent=E,d(E)}),m.addEventListener("click",()=>{let E=parseInt(g.textContent,10);E>1&&(E--,g.textContent=E,d(E))})),u.appendChild(h),u.appendChild(g),u.appendChild(m),u}Ge&&Ge.destroy(),Ge=new Vt(w,"edit-recipe-form-modal","edit-recipe-form","edit-recipe-modal-title","edit-recipe-id","edit-recipe-name","edit-recipe-category","edit-recipe-servings","edit-recipe-prep-time","edit-recipe-difficulty","edit-recipe-steps","edit-ingredients-list","edit-add-ingredient-btn","edit-save-recipe-btn","close-edit-recipe-modal","edit-cancel-recipe-btn"),Ge.setActivityUpdater(Lt),Ge.setOnSaveCallback(async()=>{});let a=1,r="Lundi",i={},c={},f={};const y=[];let p=null,x=[],I=[],v=1,M=null,z=[],l=null;const D=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];function J(s){return s?s.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase():""}function be(s){return s?s.replace(/\./g,"_"):""}async function W(s){const o=document.getElementById("unit-select-modal"),d=document.getElementById("unit-modal-title"),b=document.getElementById("unit-modal-list"),u=document.getElementById("unit-modal-cancel");return d.textContent=`Choisir une unit√© pour "${s}"`,b.innerHTML="",new Promise((h,g)=>{const m=["g","kg","ml","l","pi√®ce(s)","c.√†.s.","c.√†.c.","pinc√©e(s)"],E=k=>{o.classList.add("hidden"),h(k)};m.forEach(k=>{const N=document.createElement("button");N.className="btn btn-outline",N.textContent=k,N.addEventListener("click",()=>E(k)),b.appendChild(N)});const C=()=>{o.classList.add("hidden"),g()};u.addEventListener("click",C,{once:!0}),o.addEventListener("click",k=>{k.target===o&&C()},{once:!0}),o.classList.remove("hidden")})}async function j(){if(w)try{I=(await we(Y(w,"ingredients"))).docs.map(o=>({id:o.id,...o.data()})),I.sort((o,d)=>o.name.localeCompare(d.name))}catch(s){console.error("Erreur lors de la r√©cup√©ration des ingr√©dients: ",s)}}function L(){if(!l)i={},c={},f={},v=1,r="Lundi";else{const s=l.weeks?l.weeks[a]||{}:{};i=s.menuData||{},c=s.servingsData||{},f=s.remarksData||{},v=l.defaultNumPeople||1,r=l.startDay||"Lundi"}if(e.startDaySelect&&(e.startDaySelect.value=r),e.defaultServingsControl){e.defaultServingsControl.innerHTML="";const s=t(v,async o=>{v=o,l&&await B({defaultNumPeople:o},`a chang√© le nombre de personnes par d√©faut √† ${o}`)});e.defaultServingsControl.appendChild(s)}Hn(),F(e.mealPlanGrid,{menuData:i,servingsData:c,remarksData:f,defaultNumPeople:v,startDay:r},!1),re(document.getElementById("mobile-meal-plan"),{menuData:i,servingsData:c,remarksData:f,defaultNumPeople:v,startDay:r},!1),ie()}async function B(s,o){if(!l)return;await Ot(l.id,l,o);const d=H(w,"plans",l.id);try{await $e(d,{...s,lastUpdated:new Date})}catch(b){console.error("Error updating plan:",b),alert("Une erreur de sauvegarde est survenue.")}}function P(){e.planHistoryModal.classList.add("hidden")}async function V(s){if(l&&confirm("Voulez-vous vraiment restaurer cette version ? L'√©tat actuel sera sauvegard√© dans l'historique avant la restauration."))try{const o=H(w,"plans",l.id,"history",s),d=await Me(o);if(!d.exists())throw new Error("Version de l'historique non trouv√©e.");const b=d.data().planState;await Ot(l.id,l);const u=H(w,"plans",l.id);await yt(u,b),P()}catch(o){console.error("Erreur lors du rollback :",o)}}async function X(s,o){if(l&&confirm("√ätes-vous s√ªr de vouloir supprimer d√©finitivement cette entr√©e de l'historique ?"))try{const d=H(w,"plans",l.id,"history",s);await Oe(d),o.remove()}catch(d){console.error("Erreur lors de la suppression de l'historique :",d),alert("Une erreur est survenue lors de la suppression.")}}async function G(){if(l){e.planHistoryList.innerHTML="<p>Chargement de l'historique...</p>",e.planHistoryModal.classList.remove("hidden");try{const s=Y(w,"plans",l.id,"history"),o=Ce(s,Jn("timestamp","desc")),d=await we(o);if(e.planHistoryList.innerHTML="",d.empty){e.planHistoryList.innerHTML="<p>Aucun historique pour ce plan.</p>";return}d.forEach(b=>{const u=b.data(),h=document.createElement("div");h.className="p-3 border-b flex justify-between items-center";const g=document.createElement("div"),m=u.timestamp?.toDate().toLocaleString("fr-FR")||"Date inconnue",E=u.description||"Modification diverse",C=u.modifiedByName||"Inconnu";g.innerHTML=`
                    <p class="font-medium">${C} ${E}</p>
                    <p class="text-sm text-gray-500">${m}</p>
                `;const k=document.createElement("div");k.className="flex items-center space-x-2";const N=document.createElement("button");N.className="btn btn-secondary btn-sm",N.textContent="Revenir √† cette version",N.addEventListener("click",()=>V(b.id));const A=document.createElement("button");A.className="btn btn-ghost text-red-500 hover:bg-red-100 btn-sm",A.innerHTML='<i class="fas fa-times"></i>',A.title="Supprimer cette version",A.addEventListener("click",q=>{q.stopPropagation(),X(b.id,h)}),k.appendChild(N),k.appendChild(A),h.appendChild(g),h.appendChild(k),e.planHistoryList.appendChild(h)})}catch(s){console.error("Erreur de chargement de l'historique:",s),e.planHistoryList.innerHTML=`<p class="text-red-500">Impossible de charger l'historique.</p>`}}}function re(s,o,d=!1){if(!s)return;const b=o.menuData||{},u=o.servingsData||{},h=o.remarksData||{},g=o.defaultNumPeople||1,m=o.startDay||"Lundi";s.innerHTML="";const E=document.createDocumentFragment(),C=D.indexOf(m);[...D.slice(C),...D.slice(0,C)].forEach(N=>{const A=D.indexOf(N),q=document.createElement("div");q.className="bg-blue-100 border border-blue-300 rounded-xl shadow-md p-4 mb-4";const ae=document.createElement("h3");ae.className="text-xl font-bold text-gray-800 mb-3",ae.textContent=N.toUpperCase(),q.appendChild(ae);const pe=document.createElement("div");pe.className="space-y-4",["lunch","dinner"].forEach(ge=>{const he=document.createElement("div");he.className=`border-t pt-3 ${ge==="lunch"?"bg-amber-50":"bg-stone-100"} rounded-lg p-2`;const Le=document.createElement("div");Le.className="flex justify-between items-center mb-2";const Ie=document.createElement("h4");if(Ie.className="text-lg font-semibold text-tomato",Ie.textContent=ge==="lunch"?"Midi":"Soir",Le.appendChild(Ie),!d){const ve=`${A}-${ge}`,ye=u[ve]||g,oe=t(ye,Te=>{Xt(ve,Te)});Le.appendChild(oe)}he.appendChild(Le);const _e=document.createElement("div");_e.className="space-y-2";let Ne=!1;const Se=["Entr√©e","Plat","Accompagnement","Dessert","Remarque"];for(let ve=0;ve<Se.length;ve++){const ye=Se[ve],oe=`${A}-${ge}-${ve}`,Te=b[oe],xe=document.createElement("div");xe.className="mb-2";const De=document.createElement("h5");if(De.className="text-md font-semibold text-gray-700 mb-1",De.textContent=ye,xe.appendChild(De),ye==="Remarque")xe.appendChild(Ze(oe,h,d));else{const He=document.createElement("div");if(He.className="space-y-1",Array.isArray(Te)&&Te.length>0&&(Ne=!0,Te.forEach((Re,Et)=>{const We=x.find(Ae=>Ae.id===Re.id);if(We){const Ae=Qe(We,oe,Et,d);if(Ae.classList.remove("bg-white","shadow-sm"),Ae.classList.add("bg-emerald-200","border","border-emerald-400"),!d){const qe=Ae.querySelector(".edit-meal-btn"),st=Ae.querySelector(".delete-meal-btn");qe&&qe.classList.remove("hidden"),st&&st.classList.remove("hidden")}He.appendChild(Ae)}})),d)Ne||(He.innerHTML='<p class="text-sm text-gray-500 italic">Aucun plat pr√©vu.</p>');else{const Re=document.createElement("button");Re.className="btn btn-outline btn-sm w-full mt-2",Re.innerHTML=`<i class="fas fa-plus mr-2"></i> Ajouter une ${ye.toLowerCase()}`,Re.addEventListener("click",()=>{ce(oe)}),He.appendChild(Re)}xe.appendChild(He)}_e.appendChild(xe)}he.appendChild(_e),pe.appendChild(he)}),q.appendChild(pe),E.appendChild(q)}),s.appendChild(E)}function F(s,o,d=!1){if(!s)return;const b=o.menuData||{},u=o.servingsData||{},h=o.remarksData||{},g=o.defaultNumPeople||1,m=o.startDay||"Lundi",E=document.createDocumentFragment(),C=["lunch","dinner"],k=5,N=D.indexOf(m);[...D.slice(N),...D.slice(0,N)].forEach(q=>{const ae=D.indexOf(q),pe=document.createElement("div");pe.className="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] items-stretch border-b border-gray-300";const ge=document.createElement("div");ge.className="font-bold p-2 flex items-center justify-center bg-gray-100 text-sm border-r border-gray-300",ge.textContent=q.toUpperCase(),pe.appendChild(ge),C.forEach(he=>{const Le=`${ae}-${he}`,Ie=u[Le]||g,_e=u.hasOwnProperty(Le),Ne=document.createElement("div"),Se=n(Ie,_e,ye=>{Xt(Le,ye)},d);let ve="border-r border-gray-300 flex items-center justify-center transition-colors duration-300";_e?ve+=" bg-tomato":ve+=he==="lunch"?" bg-amber-50":" bg-stone-100",Ne.className=ve,Ne.appendChild(Se),pe.appendChild(Ne);for(let ye=0;ye<k;ye++){const oe=`${ae}-${he}-${ye}`,Te=b[oe],xe=document.createElement("div"),De=ue(oe);let He="meal-slot p-1 min-h-[70px] flex flex-col justify-start border-r border-gray-300";if(He+=he==="lunch"?" bg-amber-50":" bg-stone-100",xe.className=He,xe.dataset.slotId=oe,De==="Remarque")xe.appendChild(Ze(oe,h,d));else if(Array.isArray(Te)&&Te.length>0){const Re=document.createElement("div");Re.className="w-full",Te.forEach((Et,We)=>{const Ae=x.find(qe=>qe.id===Et.id);if(Ae)Re.appendChild(Qe(Ae,oe,We,d));else{const qe=document.createElement("div");qe.className="p-1 bg-red-100 text-red-700 rounded shadow-sm text-center text-xs font-medium",qe.textContent="Recette supprim√©e",Re.appendChild(qe)}}),xe.appendChild(Re),d||xe.appendChild(Xe(oe,!0))}else d||xe.appendChild(Xe(oe,!1));pe.appendChild(xe)}}),E.appendChild(pe)}),s.innerHTML="",s.appendChild(E),d||nt()}async function le(){const s=ke();if(!w||!s)return[];try{const o=Ce(Y(w,"shopping_lists"),fe("userId","==",s));return(await we(o)).docs.map(h=>({id:h.id,...h.data()})).filter(h=>h.isShared!==!0)}catch(o){return console.error("Erreur de chargement des listes de courses sauvegard√©es: ",o),[]}}async function de(){const s=await le();if(e.importListContainer.innerHTML="",s.length===0){e.importListContainer.innerHTML='<p class="text-center text-gray-500">Aucune liste sauvegard√©e.</p>';return}s.forEach(o=>{const d=document.createElement("button");d.className="w-full text-left p-2 hover:bg-gray-100 rounded-lg transition-colors duration-150",d.textContent=o.name,d.addEventListener("click",()=>{confirm(`Voulez-vous vraiment importer les ingr√©dients de la liste "${o.name}" ?`)&&(o.ingredients.forEach(b=>{const u=parseFloat(String(b.quantity).replace(",","."))||0;O(b.name,u,b.unit)}),T())}),e.importListContainer.appendChild(d)}),e.importListModal.classList.remove("hidden")}function T(){e.importListModal.classList.add("hidden")}function S(){e.addItemInput?.addEventListener("input",()=>{const s=e.addItemInput.value.toLowerCase(),o=e.addItemResults;if(o.innerHTML="",!s){o.classList.add("hidden");return}I.filter(u=>u.name.toLowerCase().includes(s)).forEach(u=>{const h=document.createElement("div");h.className="p-2 hover:bg-gray-100 cursor-pointer",h.textContent=u.name,h.addEventListener("click",()=>{O(u.name,1,u.unit),e.addItemInput.value="",o.classList.add("hidden")}),o.appendChild(h)});const b=document.createElement("div");b.className="p-2 bg-green-50 hover:bg-green-200 cursor-pointer font-bold text-green-700",b.textContent=`+ Cr√©er "${e.addItemInput.value}"`,b.addEventListener("click",async()=>{const u=e.addItemInput.value;try{const h=await W(u);await Pe(Y(w,"ingredients"),{name:u,unit:h}),await j(),O(u,1,h),e.addItemInput.value="",o.classList.add("hidden")}catch{}}),o.appendChild(b),o.classList.remove("hidden")}),e.addItemBtn?.addEventListener("click",()=>{const s=e.addItemInput.value;s&&(O(s,1,""),e.addItemInput.value="",e.addItemResults.classList.add("hidden"))}),document.addEventListener("click",s=>{e.addItemInput&&!e.addItemInput.contains(s.target)&&!e.addItemResults.contains(s.target)&&e.addItemResults.classList.add("hidden")})}function U(){if(y.length===0){alert("La liste de courses est vide.");return}const s=y.reduce((u,h)=>{const g=h.category||"Inconnue";return u[g]||(u[g]=[]),u[g].push(h),u},{}),o=Object.keys(s).sort((u,h)=>u==="Inconnue"?1:h==="Inconnue"?-1:u.localeCompare(h));let d=`Liste de courses - GustoPlan

`;o.forEach(u=>{d+=`--- ${u.toUpperCase()} ---
`,s[u].sort((g,m)=>g.name.localeCompare(m.name)).forEach(g=>{let E=`${Number.isInteger(g.totalQuantity)?g.totalQuantity:parseFloat(g.totalQuantity.toFixed(2))} ${g.unit||""} ${g.name}`;if(g.sources&&g.sources.length>0){const C=g.sources.reduce((N,A)=>{const q=`${A.recipeName} (${A.day} ${A.time})`;return N[q]||(N[q]=0),N[q]+=A.quantity,N},{}),k=Object.keys(C).join(" / ");E+=` *** ${k} ***`}d+=E+`
`}),d+=`
`});const b=new Blob([d],{type:"text/plain;charset=utf-8"});saveAs(b,"liste-de-courses.txt")}function R(){if(y.length===0){alert("La liste de courses est vide.");return}const{jsPDF:s}=window.jspdf,o=new s,d=y.reduce((E,C)=>{const k=C.category||"Inconnue";return E[k]||(E[k]=[]),E[k].push(C),E},{}),b=Object.keys(d).sort((E,C)=>E==="Inconnue"?1:C==="Inconnue"?-1:E.localeCompare(C));o.setFontSize(18),o.text("Liste de courses - GustoPlan",14,22);let u=35;const h=o.internal.pageSize.height,g=20,m=()=>{u>h-g&&(o.addPage(),u=20)};b.forEach(E=>{m(),o.setFontSize(14),o.setFont(void 0,"bold"),o.text(`--- ${E.toUpperCase()} ---`,14,u),u+=8,o.setFont(void 0,"normal"),d[E].sort((k,N)=>k.name.localeCompare(N.name)).forEach(k=>{m(),o.setFontSize(12);const N=Number.isInteger(k.totalQuantity)?k.totalQuantity:parseFloat(k.totalQuantity.toFixed(2));if(o.text(`${N} ${k.unit||""} ${k.name}`,14,u),u+=6,k.sources&&k.sources.length>0){const A=k.sources.reduce((q,ae)=>{const pe=`${ae.recipeName} (${ae.day} ${ae.time})`;return q[pe]||(q[pe]=0),q[pe]+=ae.quantity,q},{});o.setFontSize(9),o.setTextColor(100);for(const q in A)m(),o.text(`  * ${q}`,18,u),u+=5;o.setTextColor(0)}u+=2}),u+=5}),o.save("liste-de-courses.pdf")}async function te(){if(!l){alert("Veuillez s√©lectionner un plan √† exporter.");return}const s=document.getElementById("loading-overlay");s&&s.classList.remove("hidden");try{const{jsPDF:o}=window.jspdf,d=new o,b=H(w,"plans",l.id),u=await Me(b),h=u.exists()?u.data():null;if(!h||!h.weeks){alert("Ce plan est vide et ne peut pas √™tre export√©.");return}d.setFontSize(18),d.text(`Plan de Repas: ${h.name}`,14,20);const g=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"],m={0:"E",1:"P",2:"A",3:"D"},E=Object.keys(h.weeks).sort((k,N)=>parseInt(k)-parseInt(N));let C=!0;for(const k of E){const A=h.weeks[k].menuData||{};if(Object.keys(A).length===0)continue;const q=[["Jour","Midi","Soir"]],ae=[],pe=g.indexOf(h.startDay||"Lundi"),ge=[...g.slice(pe),...g.slice(0,pe)];for(const Le of ge){const Ie=g.indexOf(Le);let _e=[],Ne=[];for(const Se of["lunch","dinner"])for(const ve in m){const ye=`${Ie}-${Se}-${ve}`;A[ye]&&Array.isArray(A[ye])&&A[ye].forEach(oe=>{const Te=`[${m[ve]}] ${oe.name}`;Se==="lunch"?_e.push(Te):Ne.push(Te)})}ae.push([Le,_e.join(`
`)||"-",Ne.join(`
`)||"-"])}d.setFontSize(14);const he=C?30:d.autoTable.previous.finalY+20;d.text(`Semaine ${k}`,14,he-5),d.autoTable({startY:he,head:q,body:ae,theme:"grid",styles:{cellPadding:2,fontSize:8,valign:"middle"},headStyles:{fillColor:[41,128,185],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[245,245,245]}}),C=!1}d.save(`plan_${h.name.replace(/ /g,"_")}.pdf`)}catch(o){console.error("Erreur lors de la g√©n√©ration du PDF du plan :",o),alert("Une erreur est survenue lors de la cr√©ation du PDF.")}finally{s&&s.classList.add("hidden")}}async function O(s,o,d,b=!1){if(!l)return alert("Veuillez s√©lectionner un plan.");const u=H(w,"plans",l.id);try{await nn(w,async h=>{const g=await h.get(u);if(!g.exists())throw"Le plan n'existe plus.";const m=g.data().manualItems||[],E=`${s.trim().toLowerCase()}_${d||""}`,C=m.findIndex(N=>`${N.name.trim().toLowerCase()}_${N.unit||""}`===E);if(C>-1)m[C].totalQuantity+=o;else{const N=I.find(A=>A.name.toLowerCase()===s.trim().toLowerCase());m.push({name:s.trim(),totalQuantity:o,unit:d,source:"manual",category:N?.category||"Inconnue"})}const k=m.filter(N=>N.totalQuantity!==0);h.update(u,{manualItems:k,lastUpdated:new Date})})}catch(h){console.error("Erreur transactionnelle lors de l'ajustement de l'ingr√©dient: ",h),alert("Une erreur de synchronisation est survenue. Veuillez r√©essayer.")}}function me(s){const o=s?s.toLowerCase():"";return o.includes("g")||o.includes("ml")?10:1}function Z(s=[]){const o=e.shoppingListContainer;if(!o)return;if(o.innerHTML="",y.length===0&&s.length===0){o.innerHTML='<p class="text-center text-gray-500 italic py-4">Votre liste de courses est vide.</p>';return}const d=l?l.checkedItems||{}:{},b=y.reduce((h,g)=>{const m=g.category||"Inconnue";return h[m]||(h[m]=[]),h[m].push(g),h},{});if(Object.keys(b).sort((h,g)=>h==="Inconnue"?1:g==="Inconnue"?-1:h.localeCompare(g)).forEach(h=>{const g=document.createElement("h4");g.className="text-sm font-bold text-stone-800 bg-stone-200 mt-4 mb-2 px-3 py-1 rounded-md",g.textContent=h,o.appendChild(g);const m=document.createElement("ul");m.className="space-y-2",b[h].sort((C,k)=>C.name.localeCompare(k.name)).forEach(C=>{const k=`${C.name}_${C.unit||""}`,N=be(k),A=d.hasOwnProperty(N)?d[N]:d[k]||!1,q=document.createElement("li");let ae="p-2 rounded";q.className=ae+(C.source==="manual"?" bg-lemon":" bg-gray-50");const pe=document.createElement("div");pe.className="flex justify-between items-center";const ge=document.createElement("div");if(ge.className="flex-grow flex items-center",A){const oe=document.createElement("i");oe.className="fas fa-check mr-2 bg-green-500 text-white rounded-full p-1 flex items-center justify-center w-5 h-5",ge.appendChild(oe)}const he=document.createElement("span");he.className="text-sm font-medium transition-all duration-200",A&&he.classList.add("line-through","text-gray-400"),he.textContent=C.name,ge.appendChild(he),pe.appendChild(ge);const Le=document.createElement("div");Le.className="flex items-center space-x-2 mx-2";const Ie=document.createElement("span");Ie.className="font-medium w-20 text-center text-sm",A&&Ie.classList.add("text-gray-400");const _e=Number.isInteger(C.totalQuantity)?C.totalQuantity:parseFloat(C.totalQuantity.toFixed(2));Ie.textContent=`${_e} ${C.unit||""}`.trim();const Ne=document.createElement("div");Ne.className="flex flex-col";const Se=document.createElement("button");Se.className="btn btn-outline btn-xs rounded-b-none",Se.textContent="+",Se.addEventListener("click",async()=>{const oe=me(C.unit);await O(C.name,oe,C.unit)});const ve=document.createElement("button");ve.className="btn btn-outline btn-xs rounded-t-none -mt-px",ve.textContent="-",ve.addEventListener("click",async()=>{const oe=me(C.unit);await O(C.name,-oe,C.unit)}),Ne.appendChild(Se),Ne.appendChild(ve),Le.appendChild(Ie),Le.appendChild(Ne),pe.appendChild(Le);const ye=document.createElement("button");if(ye.className="delete-item-btn text-red-500 hover:text-red-700",ye.innerHTML='<i class="fas fa-trash-alt"></i>',ye.addEventListener("click",()=>{O(C.name,-C.totalQuantity,C.unit,!0)}),pe.appendChild(ye),q.appendChild(pe),C.sources&&C.sources.length>0){const oe=document.createElement("div");oe.className="p-2 mt-1 ml-4 rounded-md bg-stone-100";const Te=C.sources.reduce((xe,De)=>{const He=`${De.recipeName} (${De.day} ${De.time})`;return xe[He]||(xe[He]=0),xe[He]+=De.quantity,xe},{});for(const xe in Te){const De=document.createElement("span");De.className="block text-xs text-gray-500",De.textContent=`‚Ü≥ ${xe}`,oe.appendChild(De)}q.appendChild(oe)}m.appendChild(q)}),o.appendChild(m)}),e.openTrashBtn&&(e.openTrashBtn.classList.remove("hidden"),e.trashCount&&(e.trashCount.textContent=s.length,s.length>0?(e.trashCount.classList.remove("bg-gray-200"),e.trashCount.classList.add("bg-red-500","text-white")):(e.trashCount.classList.add("bg-gray-200"),e.trashCount.classList.remove("bg-red-500","text-white")))),s&&s.length>0){if(e.emptyTrashBtn){e.emptyTrashBtn.classList.remove("hidden");const h=e.emptyTrashBtn.cloneNode(!0);e.emptyTrashBtn.parentNode.replaceChild(h,e.emptyTrashBtn),e.emptyTrashBtn=h,e.emptyTrashBtn.addEventListener("click",async()=>{if(!l||!confirm("Voulez-vous supprimer d√©finitivement tous les √©l√©ments de la corbeille ?"))return;const g=H(w,"plans",l.id),m=s.map(E=>`${E.name}_${E.unit||""}`);try{await dt(()=>import("./firebase-config-CV1YP_xo.js").then(E=>E.F),[]).then(E=>{E.updateDoc(g,{hiddenTrashItems:E.arrayUnion(...m),lastUpdated:new Date})}),e.trashModal.classList.add("hidden")}catch(E){console.error("Erreur vidage corbeille:",E)}})}if(e.trashListContainer){e.trashListContainer.innerHTML="";const h=document.createElement("ul");h.className="space-y-2",s.forEach(g=>{const m=document.createElement("li");m.className="p-2 rounded bg-gray-100 flex justify-between items-center group";const E=document.createElement("span");E.className="text-sm text-gray-500 line-through",E.textContent=g.name,m.appendChild(E);const C=document.createElement("div");C.className="flex items-center space-x-2";const k=document.createElement("button");k.className="btn btn-xs btn-outline text-blue-600 hover:bg-blue-50 border-blue-300",k.innerHTML='<i class="fas fa-undo mr-1"></i> Restaurer',k.addEventListener("click",async()=>{if(!l)return;const A=H(w,"plans",l.id);try{await nn(w,async q=>{const ae=await q.get(A);if(!ae.exists())return;const ge=(ae.data().manualItems||[]).filter(he=>!(he.name.toLowerCase()===g.name.toLowerCase()&&he.unit===g.unit));q.update(A,{manualItems:ge,lastUpdated:new Date})}),s.length<=1&&e.trashModal.classList.add("hidden")}catch(q){console.error("Erreur lors de la restauration :",q)}});const N=document.createElement("button");N.className="btn btn-xs btn-ghost text-gray-400 hover:text-red-600",N.title="Supprimer d√©finitivement",N.innerHTML='<i class="fas fa-times"></i>',N.addEventListener("click",async()=>{if(!l)return;const A=H(w,"plans",l.id),q=`${g.name}_${g.unit||""}`;try{await dt(()=>import("./firebase-config-CV1YP_xo.js").then(ae=>ae.F),[]).then(ae=>{ae.updateDoc(A,{hiddenTrashItems:ae.arrayUnion(q),lastUpdated:new Date})}),s.length<=1&&e.trashModal.classList.add("hidden")}catch(ae){console.error("Erreur suppression d√©finitive:",ae)}}),C.appendChild(k),C.appendChild(N),m.appendChild(C),h.appendChild(m)}),e.trashListContainer.appendChild(h)}}else e.trashListContainer&&(e.trashListContainer.innerHTML='<p class="text-center text-gray-500 italic py-4">La corbeille est vide.</p>'),e.emptyTrashBtn&&e.emptyTrashBtn.classList.add("hidden")}async function ie(){if(!l){y.length=0,Z();return}const s=l.manualItems?JSON.parse(JSON.stringify(l.manualItems)):[],o=new Map(s.map(m=>[`${m.name.trim().toLowerCase()}_${m.unit||""}`,m])),d=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];if(l.weeks)for(const m in l.weeks){const E=l.weeks[m],C=E.menuData||{},k=E.servingsData||{};for(const N in C){const A=C[N];if(!Array.isArray(A))continue;const[q,ae]=N.split("-"),pe=parseInt(q,10),ge=d[pe]||"Jour inconnu",he=ae==="lunch"?"midi":"soir",Le=`${pe}-${ae}`,Ie=parseInt(k[Le]||l.defaultNumPeople,10);for(const _e of A){const Se=x.find(ye=>ye.id===_e.id)||_e;if(!Se||!Array.isArray(Se.ingredients))continue;const ve=Se.servings||1;ve<=0||Se.ingredients.forEach(ye=>{const{name:oe,quantity:Te,unit:xe}=ye;if(!oe||!Te)return;const De=I.find(Je=>Je.name.toLowerCase()===oe.trim().toLowerCase()),He=De?De.category:"Inconnue",Re=parseFloat(String(Te).replace(",","."));if(isNaN(Re))return;const We=Re/ve*Ie,Ae=xe||"",qe=`${oe.trim().toLowerCase()}_${Ae}`,st={recipeName:Se.name,day:`${ge} (S${m})`,time:he,quantity:We};if(o.has(qe)){const Je=o.get(qe);Je.totalQuantity+=We,Je.source==="manual"&&(Je.source="mixed"),Array.isArray(Je.sources)?Je.sources.push(st):Je.sources=[st]}else o.set(qe,{name:oe.trim(),totalQuantity:We,unit:Ae,source:"plan",category:He,sources:[st]})})}}}const b=Array.from(o.values()),u=l.hiddenTrashItems||[],h=b.filter(m=>m.totalQuantity>0).sort((m,E)=>m.name.localeCompare(E.name)),g=b.filter(m=>{const E=`${m.name}_${m.unit||""}`;return m.totalQuantity<=0&&m.sources&&m.sources.length>0&&!u.includes(E)}).sort((m,E)=>m.name.localeCompare(E.name));y.length=0,y.push(...h),Z(g)}function ce(s){const o=ue(s);if(!o||!e.mealSelectModal)return;e.mealSelectModalTitle.textContent=`S√©lectionner : ${o}`,e.mealSelectList.innerHTML="";const d=document.createElement("input");d.type="text",d.placeholder="Rechercher dans la cat√©gorie...",d.className="w-full p-2 mb-4 border border-gray-300 rounded-lg",e.mealSelectList.appendChild(d);const b=J(o),u=x.filter(m=>J(m.category)===b).sort((m,E)=>{const C=m.isFavorite?1:0,k=E.isFavorite?1:0;return k!==C?k-C:m.name.localeCompare(E.name)}),h=document.createElement("div");h.className="space-y-1 max-h-80 overflow-y-auto",e.mealSelectList.appendChild(h);function g(m=""){h.innerHTML="";const E=m.toLowerCase(),C=u.filter(k=>k.name.toLowerCase().includes(E));C.length===0?h.innerHTML='<p class="text-gray-500 p-4">Aucun plat ne correspond √† votre recherche.</p>':C.forEach(k=>{const N=document.createElement("button");N.className="w-full text-left p-2 hover:bg-gray-100 rounded-lg transition-colors duration-150";const A=document.createElement("p");A.className="font-medium text-gray-800 text-sm",k.isFavorite?A.innerHTML=`${k.name} <i class="fas fa-heart text-red-500 ml-2"></i>`:A.textContent=k.name,N.appendChild(A),N.addEventListener("click",()=>{at(s,k),Be()}),h.appendChild(N)})}d.addEventListener("input",m=>g(m.target.value)),g(),e.mealSelectModal.classList.remove("hidden"),d.focus()}function Be(){e.mealSelectModal&&e.mealSelectModal.classList.add("hidden")}function K(s){p=s.target.closest(".meal-card");const o=p.closest(".meal-slot").dataset.slotId;s.dataTransfer.setData("text/plain",o),setTimeout(()=>{p&&(p.style.opacity="0.5")},0)}function Q(){p&&(p.style.opacity="1",p=null)}function $(s){s.preventDefault();const o=s.target.closest(".meal-slot");o&&ue(o.dataset.slotId)!=="Remarque"&&o.classList.add("bg-gray-200")}function _(s){const o=s.target.closest(".meal-slot");o&&o.classList.remove("bg-gray-200")}async function ee(s){s.preventDefault();const o=s.dataTransfer.getData("text/plain"),d=s.target.closest(".meal-slot");if(d){d.classList.remove("bg-gray-200");const b=d.dataset.slotId,u=ue(b);if(u==="Remarque")return;if(o&&b&&o!==b){const h=i[o],g=ue(o);if(J(g)!==J(u)){alert(`Action impossible : un(e) "${g}" ne peut pas aller dans la cat√©gorie "${u}".`);return}const m=i[b];i[b]=h,m?i[o]=m:delete i[o],F(e.mealPlanGrid,{menuData:i,servingsData:c,remarksData:f,defaultNumPeople:v,startDay:r},!1),await B({[`weeks.${a}.menuData`]:i},"a d√©plac√© un plat"),await ie()}}}function ue(s){switch(s.split("-")[2]){case"0":return"Entr√©e";case"1":return"Plat";case"2":return"Accompagnement";case"3":return"Dessert";case"4":return"Remarque";default:return""}}function Qe(s,o,d,b=!1){const u=document.createElement("div");if(u.className="meal-card p-1 flex flex-col items-center bg-white rounded shadow-sm text-center relative w-full mb-1",b||(u.classList.add("cursor-grab"),u.draggable=!0),!b){const E=document.createElement("button");E.className="absolute -top-2 -right-1 text-base",E.innerHTML='<i class="fas fa-heart"></i>',s.isFavorite?E.classList.add("text-red-500"):E.classList.add("text-gray-300","hover:text-red-400"),E.addEventListener("click",C=>{C.stopPropagation(),Jt(s.id,s.isFavorite)}),E.addEventListener("mousedown",C=>C.stopPropagation()),u.appendChild(E)}const h=document.createElement("span");if(h.className="text-xs font-medium p-1 break-words w-full",h.textContent=s.name,u.appendChild(h),!b){const E=document.createElement("div");E.className="absolute top-0 left-0 flex";const C=document.createElement("button");C.className="edit-meal-btn text-gray-600 hover:text-gray-800 hidden px-1 py-0.5",C.innerHTML='<i class="fas fa-pencil-alt fa-xs"></i>',C.title="Modifier la recette",C.addEventListener("click",N=>{N.stopPropagation();const A=x.find(q=>q.id===s.id);Ge.openForm(A||s,"Modifier la recette")}),C.addEventListener("mousedown",N=>N.stopPropagation()),E.appendChild(C);const k=document.createElement("button");k.className="delete-meal-btn text-red-700 hover:text-red-900 hidden px-1 py-0.5",k.innerHTML='<i class="fas fa-times-circle fa-xs"></i>',k.title="Retirer du planning",k.addEventListener("click",N=>{N.stopPropagation(),$n(o,d)}),k.addEventListener("mousedown",N=>N.stopPropagation()),E.appendChild(k),u.appendChild(E),u.addEventListener("mouseenter",()=>{C.classList.remove("hidden"),k.classList.remove("hidden")}),u.addEventListener("mouseleave",()=>{C.classList.add("hidden"),k.classList.add("hidden")})}const g=document.createElement("div");g.className="absolute bottom-1 right-1";const m=document.createElement("button");return m.className="info-meal-btn bg-gray-500 text-white hover:bg-gray-600 rounded w-3 h-3 flex items-center justify-center shadow-sm",m.innerHTML='<i class="fas fa-plus fa-xs"></i>',m.title="Plus d'infos",m.dataset.slotId=o,m.dataset.mealIndex=d,m.addEventListener("mousedown",E=>E.stopPropagation()),g.appendChild(m),u.appendChild(g),u}function mt(s,o){if(document.querySelectorAll(".planner-ingredient-tooltip").forEach(g=>g.remove()),M===s){s.classList.remove("info-open"),s.innerHTML='<i class="fas fa-plus fa-xs"></i>',M=null;return}M&&(M.classList.remove("info-open"),M.innerHTML='<i class="fas fa-plus fa-xs"></i>'),s.classList.add("info-open"),s.innerHTML='<i class="fas fa-times fa-xs"></i>',M=s;const d=document.createElement("div");if(d.className="planner-ingredient-tooltip z-50 w-64 p-3 bg-white border border-gray-200 rounded-lg shadow-lg text-left text-sm",o.ingredients&&o.ingredients.length>0){if(o.servings&&o.servings>0){const E=document.createElement("p");E.className="mb-2 text-sm text-gray-600 flex items-center",E.innerHTML=`<i class="fas fa-users mr-2"></i> Pour ${o.servings} ${o.servings>1?"personnes":"personne"}`,d.appendChild(E)}const g=document.createElement("h4");g.className="font-bold mb-2 text-gray-800",g.textContent="Ingr√©dients :",d.appendChild(g);const m=document.createElement("ul");m.className="space-y-1 text-gray-600",o.ingredients.forEach(E=>{const C=document.createElement("li");C.textContent=`‚Ä¢ ${E.quantity||""} ${E.unit||""} ${E.name}`.trim(),m.appendChild(C)}),d.appendChild(m)}else d.textContent="Aucun ingr√©dient sp√©cifi√© pour cette recette.";document.body.appendChild(d);const b=s.closest(".meal-card").getBoundingClientRect(),u=d.getBoundingClientRect();if(window.innerWidth<768){d.style.width="90vw",d.style.maxWidth="320px";const g=d.getBoundingClientRect();let m=b.bottom+10,E=(window.innerWidth-g.width)/2;m+g.height>window.innerHeight&&(m=b.top-g.height-10),d.style.top=`${m}px`,d.style.left=`${E}px`}else{let g=b.right+10;g+u.width>window.innerWidth&&(g=b.left-u.width-10);let m=b.top;m+u.height>window.innerHeight&&(m=b.bottom-u.height),m<10&&(m=10),d.style.left=`${g}px`,d.style.top=`${m}px`}d.style.position="fixed"}function Xe(s,o=!1){const d=document.createElement("div"),b=document.createElement("button");return o?(d.className="w-full flex justify-center pt-1",b.className="add-more-meal-btn text-gray-400 hover:text-green-500 transition-colors duration-150",b.innerHTML='<i class="fas fa-plus-circle"></i>',b.title="Ajouter une autre recette"):(d.className="flex items-center justify-center h-full",b.className="add-meal-btn text-green-500 hover:text-green-700 transition-transform duration-150 hover:scale-125",b.innerHTML='<i class="fas fa-plus-circle text-lg"></i>'),b.addEventListener("click",()=>ce(s)),d.appendChild(b),d}function Ze(s,o,d=!1){if(d){const u=document.createElement("p");return u.className="w-full h-full p-1 text-xs text-gray-700",u.textContent=o[s]||"",u}const b=document.createElement("textarea");return b.className="w-full h-full p-1 text-xs bg-white border-0 rounded focus:outline-none focus:ring-1 focus:ring-tomato resize-none",b.placeholder="Remarque...",b.value=f[s]||"",b.dataset.slotId=s,b.addEventListener("change",u=>{const h=u.target.value;h?f[s]=h:delete f[s];const[g,m]=s.split("-"),k=`a modifi√© la remarque pour ${D[parseInt(g,10)]} ${m==="lunch"?"midi":"soir"}`;B({[`weeks.${a}.remarksData`]:f},k)}),b.addEventListener("focus",u=>{Lt({type:"editing_remark",fieldId:s})}),b.addEventListener("blur",u=>{Lt("idle")}),b}function nt(){document.querySelectorAll(".meal-card").forEach(s=>{s.addEventListener("dragstart",K),s.addEventListener("dragend",Q)}),document.querySelectorAll(".meal-slot").forEach(s=>{s.addEventListener("dragover",$),s.addEventListener("dragleave",_),s.addEventListener("drop",ee)})}async function at(s,o){const d=JSON.parse(JSON.stringify(i)),b=d[s],u={id:o.id};Array.isArray(b)?b.push(u):d[s]=[u];const[h,g]=s.split("-"),m=D[parseInt(h,10)],E=g==="lunch"?"midi":"soir",C=`a ajout√© '${o.name}' √† ${m} ${E}`;await B({[`weeks.${a}.menuData`]:d},C),Be()}async function $n(s,o){if(!l||!i[s]||!Array.isArray(i[s]))return;const d=i[s][o],b=JSON.parse(JSON.stringify(i));b[s].splice(o,1),b[s].length===0&&delete b[s];const[u,h]=s.split("-"),g=D[parseInt(u,10)],m=h==="lunch"?"midi":"soir",E=`a supprim√© '${d.name}' de ${g} ${m}`;await B({[`weeks.${a}.menuData`]:b},E)}async function Gt(){if(confirm("Voulez-vous vraiment vider le menu de cette semaine ?")){const s={id:availablePlans.length>0?availablePlans[0].id:`${ke()}_semaine-${a}`,name:availablePlans.length>0?availablePlans[0].name:"Mon plan",menuData:{},servingsData:{},remarksData:{},defaultNumPeople:v,startDay:r,lastUpdated:new Date};loadPlan(s),availablePlans.length>0?availablePlans[0]=s:availablePlans.push(s),await B({[`weeks.${a}`]:{menuData:{},servingsData:{},remarksData:{}}},`a vid√© le menu de la semaine ${a}`)}}function Kt(s){s>=1&&s<=52&&(a=s,L())}function Hn(){e.currentWeekDisplay&&(e.currentWeekDisplay.textContent=`Semaine ${a}`)}function Rn(){e.prevWeekBtn?.addEventListener("click",()=>Kt(a-1)),e.nextWeekBtn?.addEventListener("click",()=>Kt(a+1)),e.clearMenuBtn?.addEventListener("click",Gt),e.startDaySelect?.addEventListener("change",async d=>{r=d.target.value,l&&await B({startDay:r},`a chang√© le premier jour de la semaine √† '${r}'`)}),e.planSelect?.addEventListener("change",Yt),e.closeMealSelectModalBtn?.addEventListener("click",Be),e.mealSelectModal?.addEventListener("click",d=>{d.target===e.mealSelectModal&&Be()}),e.closeRecipeModalBtn?.addEventListener("click",()=>Ge.closeForm()),e.cancelRecipeBtn?.addEventListener("click",()=>Ge.closeForm()),e.importListBtn?.addEventListener("click",de),e.closeImportListModalBtn?.addEventListener("click",T),e.importListModal?.addEventListener("click",d=>{d.target===e.importListModal&&T()}),e.exportTxtBtn?.addEventListener("click",U),e.exportPdfBtn?.addEventListener("click",R),e.exportPlanPdfBtn?.addEventListener("click",te);const s=d=>{const b=d.target.closest(".info-meal-btn");if(b){const u=b.dataset.slotId,h=parseInt(b.dataset.mealIndex,10);if(u&&!isNaN(h)){const g=i[u]?.[h];if(g&&g.id){const m=x.find(E=>E.id===g.id);m&&mt(b,m)}}}};e.mealPlanGrid?.addEventListener("click",s),document.getElementById("mobile-meal-plan")?.addEventListener("click",s),e.sharePlanBtn?.addEventListener("click",()=>{if(!l){alert("Veuillez s√©lectionner un plan √† partager.");return}Qt({plan:l})}),e.inviteParticipantBtn?.addEventListener("click",()=>{if(!l){alert("Veuillez s√©lectionner un plan pour inviter des participants.");return}vn(l)}),e.historyPlanBtn?.addEventListener("click",G),e.closePlanHistoryModalBtn?.addEventListener("click",P),e.planHistoryModal?.addEventListener("click",d=>{d.target===e.planHistoryModal&&P()}),e.openTrashBtn?.addEventListener("click",()=>{e.trashModal.classList.remove("hidden")}),e.closeTrashModalBtn?.addEventListener("click",()=>{e.trashModal.classList.add("hidden")}),e.trashModal?.addEventListener("click",d=>{d.target===e.trashModal&&e.trashModal.classList.add("hidden")}),e.savePlanBtn?.addEventListener("click",async()=>{if(!l){alert("Veuillez s√©lectionner un plan de travail avant de sauvegarder.");return}const d=document.getElementById("save-plan-as-modal"),b=document.getElementById("save-plan-as-form"),u=document.getElementById("save-plan-name"),h=document.getElementById("cancel-save-plan-as-btn"),g=document.getElementById("close-save-plan-as-modal"),m=new Date().toLocaleDateString("fr-FR"),E=l.weeks?Object.keys(l.weeks).filter(A=>l.weeks[A]&&Object.keys(l.weeks[A].menuData||{}).length>0).length:0,C=E>1?`${E} semaines`:`${E} semaine`;u.value=`${l.name} (${C}) - ${m}`,d.classList.remove("hidden");const k=async A=>{A.preventDefault();const q=u.value;if(!q)return;l.weeks||(l.weeks={}),l.weeks[a]={menuData:i,servingsData:c,remarksData:f},l.startDay=r,l.defaultNumPeople=v;const ae=JSON.parse(JSON.stringify(l));if(ae.weeks)for(const pe in ae.weeks){const ge=ae.weeks[pe];if(ge&&ge.menuData)for(const he in ge.menuData){const Le=ge.menuData[he];Array.isArray(Le)&&(ge.menuData[he]=Le.map(Ie=>Ie&&Ie.id&&x.find(Ne=>Ne.id===Ie.id)||Ie))}}await In(q,ae),d.classList.add("hidden"),b.removeEventListener("submit",k)},N=()=>{d.classList.add("hidden"),b.removeEventListener("submit",k)};b.addEventListener("submit",k,{once:!0}),h.addEventListener("click",N,{once:!0}),g.addEventListener("click",N,{once:!0})})}function An(s=""){return s.split(" ").map(b=>b[0]).join("").substring(0,2).toUpperCase()}function Mt(s=[],o={}){const d=document.getElementById("collaborators-bar"),b=document.getElementById("activity-labels-container"),u=document.getElementById("name-tooltip");if(!d||!u||!b)return;if(d.innerHTML="",b.innerHTML="",document.querySelectorAll(".remark-lock-overlay").forEach(m=>m.remove()),document.querySelectorAll("textarea[data-slot-id]").forEach(m=>{m.disabled=!1}),s.length<=1&&Object.keys(o).length<=1){d.classList.add("hidden");return}let h="";const g=ke();s.forEach(m=>{if(!m)return;const E=o.hasOwnProperty(m.uid),C=o[m.uid]||{},k=document.createElement("div");k.className="w-8 h-8 rounded-full flex items-center justify-center bg-gray-300 text-white font-bold text-xs ring-2 ring-white cursor-pointer transition-all duration-300";const N=E?"(pr√©sent)":"(absent)";if(k.dataset.name=`${m.displayName||"Inconnu"} ${N}`,m.photoURL?k.innerHTML=`<img src="${m.photoURL}" alt="${m.displayName}" class="w-full h-full rounded-full object-cover">`:k.textContent=An(m.displayName),E||k.classList.add("grayscale","opacity-50"),k.addEventListener("mouseenter",A=>{u.textContent=A.currentTarget.dataset.name,u.classList.remove("hidden");const q=A.currentTarget.getBoundingClientRect();u.style.left=`${q.left+q.width/2-u.offsetWidth/2}px`,u.style.top=`${q.top-u.offsetHeight-5}px`}),k.addEventListener("mouseleave",()=>{u.classList.add("hidden")}),d.appendChild(k),E&&m.uid!==g){const A=C.status;if(typeof A=="object"&&A.type==="editing_remark"){const q=document.querySelector(`textarea[data-slot-id="${A.fieldId}"]`);if(q){q.disabled=!0;const ae=document.createElement("div");ae.className="remark-lock-overlay absolute inset-0 bg-gray-400 bg-opacity-25 flex items-center justify-center text-xs text-white font-bold",ae.innerHTML=`<i class="fas fa-lock mr-1"></i> ${m.displayName} √©crit...`,q.parentElement&&(q.parentElement.classList.add("relative"),q.parentElement.appendChild(ae))}}else if(typeof A=="string"&&A!=="idle"){let q="";switch(A){case"editing_recipe":q="modifie une recette...";break}q&&(h+=`<span class="italic mr-4">${m.displayName} ${q}</span>`)}}}),b.innerHTML=h,d.classList.remove("hidden")}function Yt(){_n();const s=e.planSelect.value;s&&localStorage.setItem("lastActivePlanId",s),l=z.find(g=>g.id===s)||null;const o=document.getElementById("delete-plan-btn"),d=document.getElementById("rename-plan-btn"),b=document.getElementById("leave-plan-btn"),u=document.getElementById("invite-participant-btn"),h=document.getElementById("history-plan-btn");if(o&&(o.style.display=l&&l.isOwner?"inline-flex":"none"),d&&(d.style.display=l&&l.isOwner?"inline-flex":"none"),h&&(h.style.display=l&&l.isOwner?"inline-flex":"none"),b&&(b.style.display=l&&!l.isOwner?"inline-flex":"none"),u){const g=l&&(l.type==="collaborative"||l.collaborators&&l.collaborators.length>0);u.style.display=l&&l.isOwner&&g?"inline-flex":"none"}l&&l.participants&&l.participants.length>1?(Mt(l.participants,{}),Dn(l.id,g=>{Mt(l.participants,g)})):Mt([],{}),l&&(l.manualItems=l.manualItems||[]),L()}async function Xt(s,o){if(!l)return;const d=JSON.parse(JSON.stringify(c));o===v?delete d[s]:d[s]=o;const[b,u]=s.split("-"),m=`a chang√© le nombre de personnes pour ${D[parseInt(b,10)]} ${u==="lunch"?"midi":"soir"} √† ${o}`;await B({[`weeks.${a}.servingsData`]:d},m)}async function jn(){if(!w)return;const s=Ln();Rn(),S(),await j();const o=Ve(Y(w,"recipes"),b=>{if(console.log("Recipe data updated from listener."),x=b.docs.map(u=>{const h=u.data();return{id:u.id,...h,imageUrl:h.imageUrl||""}}),l){for(const u in i){const h=i[u];if(Array.isArray(h)){const g=h.map(m=>{if(m&&m.id){const E=x.find(C=>C.id===m.id);return E?{...E}:m}return m});i[u]=g}}F(e.mealPlanGrid,{menuData:i,servingsData:c,remarksData:f,defaultNumPeople:v,startDay:r},!1),re(document.getElementById("mobile-meal-plan"),{menuData:i,servingsData:c,remarksData:f,defaultNumPeople:v,startDay:r},!1),ie()}}),d=Wt(b=>{z=b,wn(b);const u=localStorage.getItem("selectedPlanId"),h=localStorage.getItem("lastActivePlanId");u&&b.some(g=>g.id===u)?(e.planSelect.value=u,localStorage.removeItem("selectedPlanId")):h&&b.some(g=>g.id===h)&&(e.planSelect.value=h),Yt()});return()=>{d(),o(),s()}}const qn=jn();return async()=>{const s=await qn;typeof s=="function"&&s()}}const $a=Object.freeze(Object.defineProperty({__proto__:null,default:Pa},Symbol.toStringTag,{value:"Module"}));function Ha(){const e=Pn();return zt(),()=>{typeof e=="function"&&e()}}async function zt(){const e=document.getElementById("received-shares-container"),t=ke();if(!(!t||!e)){e.innerHTML='<p class="text-gray-500">Chargement des partages re√ßus...</p>';try{const n=Ce(Y(w,"plans"),fe("userId","==",t),fe("isShared","==",!0)),a=Ce(Y(w,"plans"),fe("collaborators","array-contains",t)),[r,i]=await Promise.all([we(n),we(a)]);let c=[];if(r.forEach(f=>c.push({id:f.id,type:"Planification (Copie)",...f.data()})),i.forEach(f=>c.push({id:f.id,type:"Planification (Collaboratif)",...f.data()})),c.length===0){e.innerHTML=`<p class="text-gray-500">Vous n'avez aucun contenu partag√© par d'autres utilisateurs.</p>`;return}c.sort((f,y)=>(y.sharedAt?.seconds||y.lastUpdated?.seconds||0)-(f.sharedAt?.seconds||f.lastUpdated?.seconds||0)),e.innerHTML="";for(const f of c){const y=f.originalOwnerId||f.userId;if(!y)continue;const p=await Me(H(w,"users",y)),x=p.exists()?p.data().displayName:"Utilisateur inconnu";e.appendChild(Ra(f,x))}}catch(n){console.error("Erreur lors du chargement des partages re√ßus : ",n),e.innerHTML='<p class="text-red-500">Une erreur est survenue.</p>'}}}function Ra(e,t){const n=document.createElement("div");n.className="bg-white rounded-lg p-4 flex justify-between items-center shadow-sm";const a=document.createElement("div"),r=document.createElement("p");r.className="font-bold text-gray-800";let i="";e.type.includes("Collaboratif")?i=' <span class="text-xs font-medium bg-blue-100 text-blue-800 px-2 py-1 rounded-full">Collab</span>':e.type.includes("Copie")&&(i=' <span class="text-xs font-medium bg-gray-200 text-gray-800 px-2 py-1 rounded-full">Copie</span>'),r.innerHTML=`${e.name}${i}`;const c=document.createElement("p");c.className="text-sm text-gray-500 mt-1";const f=e.sharedAt?new Date(e.sharedAt.seconds*1e3).toLocaleDateString("fr-FR"):e.lastUpdated?new Date(e.lastUpdated.seconds*1e3).toLocaleDateString("fr-FR"):"date inconnue";c.textContent=`Partag√© par ${t} le ${f}`,a.appendChild(r),a.appendChild(c),n.appendChild(a);const y=document.createElement("button");return y.className="btn btn-ghost text-red-500 btn-sm",y.innerHTML='<i class="fas fa-trash"></i>',y.title="Supprimer ce contenu partag√©",y.addEventListener("click",()=>Aa(e.id,e.type)),n.appendChild(y),n}async function Aa(e,t){if(confirm(`Voulez-vous vraiment supprimer cette ${t.toLowerCase()} partag√©e ?`))try{const n=t.startsWith("Planification")?"plans":"shopping_lists",a=H(w,n,e),r=await Me(a);r.exists()&&r.data().userId===ke()?(await Oe(a),zt()):(alert("Vous n'avez pas la permission de supprimer cet √©l√©ment ou il a d√©j√† √©t√© supprim√©."),zt())}catch(n){console.error("Erreur de suppression: ",n),alert("Une erreur est survenue.")}}async function Pn(){const e=document.getElementById("sent-shares-container"),t=ke();if(!t||!e)return()=>{};e.innerHTML='<p class="text-gray-500">Chargement des partages envoy√©s...</p>';const n=Y(w,"shares"),a=Ce(n,fe("senderId","==",t));return Ve(a,async r=>{if(r.empty){e.innerHTML=`<p class="text-gray-500">Vous n'avez envoy√© aucun partage.</p>`;return}const i=r.docs.sort((c,f)=>(f.data().createdAt?.seconds||0)-(c.data().createdAt?.seconds||0));e.innerHTML="";for(const c of i){const f=c.data();try{const y=await Me(H(w,"users",f.receiverId));if(y.exists()){const p=y.data();e.appendChild(ja(f,p.displayName,c.id))}}catch(y){console.error("Could not load receiver for sent share",y)}}},r=>{console.error("Erreur lors du chargement des partages envoy√©s : ",r),e&&(e.innerHTML='<p class="text-red-500">Une erreur est survenue.</p>')})}function ja(e,t,n){const a=document.createElement("div");a.className="bg-white rounded-lg p-4 flex justify-between items-center shadow-sm";const r=document.createElement("div"),i=document.createElement("p");i.className="font-bold text-gray-800";let c=[];e.plan&&c.push("Planification"),e.shoppingList&&c.push("Liste de courses"),i.textContent=c.join(" et ");const f=document.createElement("p");f.className="text-sm text-gray-500";const y=new Date(e.createdAt.seconds*1e3).toLocaleDateString("fr-FR");f.textContent=`Envoy√© √† ${t} le ${y}`,r.appendChild(i),r.appendChild(f),a.appendChild(r);const p=document.createElement("div");p.className="flex items-center space-x-4";const x=document.createElement("span");x.textContent=e.status;let I="bg-gray-200 text-gray-800";switch(e.status){case"accepted":I="bg-green-100 text-green-800";break;case"declined":I="bg-red-100 text-red-800";break;case"pending":I="bg-yellow-100 text-yellow-800";break}x.className=`text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full ${I}`,p.appendChild(x);const v=document.createElement("button");return v.className="btn btn-ghost text-red-500 btn-sm",v.innerHTML='<i class="fas fa-trash"></i>',v.title="Annuler le partage",v.addEventListener("click",()=>qa(n)),p.appendChild(v),a.appendChild(p),a}async function qa(e){if(confirm("Voulez-vous vraiment annuler ce partage ? L'autre utilisateur ne le verra plus."))try{await Oe(H(w,"shares",e)),Pn()}catch(t){console.error("Erreur lors de la suppression du partage: ",t),alert("Une erreur est survenue.")}}const Ua=Object.freeze(Object.defineProperty({__proto__:null,default:Ha},Symbol.toStringTag,{value:"Module"})),Ke=mn();let ot=null,Ue=null,ln=[],dn=[],et={};function lt(e){return e?e.replace(/\./g,"_"):""}function Fa(){const e=document.getElementById("shopping-mode-container"),t=document.getElementById("shopping-mode-plan-select"),n=document.createElement("button");n.id="scroll-to-top-btn",n.className="hidden fixed bottom-20 right-5 bg-tomato text-white rounded-full w-12 h-12 shadow-lg z-50",n.innerHTML='<i class="fas fa-arrow-up"></i>',document.body.appendChild(n),window.addEventListener("scroll",()=>{window.pageYOffset>200?n.classList.remove("hidden"):n.classList.add("hidden")}),n.addEventListener("click",()=>{window.scrollTo({top:0,behavior:"smooth"})});async function a(){try{dn=(await we(Y(Ke,"ingredients"))).docs.map(p=>({id:p.id,...p.data()}))}catch(y){console.error("Error fetching ingredients",y)}try{ln=(await we(Y(Ke,"recipes"))).docs.map(p=>({id:p.id,...p.data()}))}catch(y){console.error("Error fetching recipes",y)}Wt(y=>{if(!t)return;if(t.innerHTML="",y.length===0){e.innerHTML='<p class="text-center p-4">Aucun plan trouv√©.</p>';return}y.forEach(x=>{const I=document.createElement("option");I.value=x.id,I.textContent=x.name,t.appendChild(I)});const p=localStorage.getItem("lastActivePlanId");p&&y.some(x=>x.id===p)?(t.value=p,r(p)):y.length>0&&r(y[0].id),t.addEventListener("change",x=>{const I=x.target.value;localStorage.setItem("lastActivePlanId",I),r(I)})})}function r(y){ot&&(ot(),ot=null);const p=H(Ke,"plans",y);ot=Ve(p,x=>{x.exists()?(Ue={id:x.id,...x.data()},et=Ue.checkedItems||{},i()):e.innerHTML='<p class="text-center p-4 text-red-500">Plan introuvable.</p>'})}function i(){if(!Ue||!e)return;const{active:y,deleted:p}=f(Ue);e.innerHTML="";const x=[],I=[];if(y.forEach(L=>{const B=`${L.name}_${L.unit||""}`,P=lt(B);(et.hasOwnProperty(P)?et[P]:et[B]||!1)?I.push(L):x.push(L)}),x.length===0&&I.length===0){e.innerHTML='<p class="text-center p-10 text-gray-500">Votre liste de courses est vide pour ce plan.</p>';return}const v=x.reduce((L,B)=>{const P=B.category||"Inconnue";return L[P]||(L[P]=[]),L[P].push(B),L},{}),M=Object.keys(v).sort((L,B)=>L==="Inconnue"?1:B==="Inconnue"?-1:L.localeCompare(B)),z=document.createElement("div");z.id="shopping-category-tabs",z.className="flex overflow-x-auto space-x-2 py-2 bg-white z-20 mb-4",e.appendChild(z);const l=L=>"category-"+L.replace(/[^a-zA-Z0-9]/g,"-").toLowerCase();if(M.forEach(L=>{const B=document.createElement("button");B.className="btn btn-sm btn-outline flex-shrink-0",B.textContent=L,B.onclick=()=>{const P=document.getElementById(l(L));if(P){const V=document.querySelector("header"),X=V?V.offsetHeight:0,re=P.getBoundingClientRect().top+window.pageYOffset-X-40;window.scrollTo({top:re,behavior:"smooth"})}},z.appendChild(B)}),M.forEach(L=>{const B=document.createElement("h3");B.className="font-bold text-lg text-gray-700 mt-6 mb-3 border-b border-gray-200 pb-1 sticky top-0 bg-white z-10",B.textContent=L,B.id=l(L),e.appendChild(B);const P=document.createElement("ul");P.className="space-y-3",v[L].sort((V,X)=>V.name.localeCompare(X.name)).forEach(V=>{const X=`${V.name}_${V.unit||""}`,G=lt(X),re=et.hasOwnProperty(G)?et[G]:et[X]||!1,F=document.createElement("li");F.className=`flex flex-col p-3 rounded-lg transition-colors duration-200 ${re?"bg-gray-100":"bg-white shadow-sm border border-gray-100"}`;const le=document.createElement("div");le.className="flex items-center w-full";const de=document.createElement("input");de.type="checkbox",de.className="form-checkbox h-6 w-6 text-tomato rounded-full border-gray-300 focus:ring-tomato cursor-pointer transition duration-150 ease-in-out",de.checked=re;const T=document.createElement("div");T.className="ml-3 flex-grow cursor-pointer select-none";const S=Number.isInteger(V.totalQuantity)?V.totalQuantity:parseFloat(V.totalQuantity.toFixed(2)),U=document.createElement("span");U.className=`font-medium text-base ${re?"line-through text-gray-400":"text-gray-800"}`,U.textContent=V.name;const R=document.createElement("span");R.className=`ml-2 font-bold text-base ${re?"text-gray-400":"text-gray-800"}`,R.textContent=` - ${S} ${V.unit||""}`.trim(),T.appendChild(U),T.appendChild(R);const te=()=>{const O=!de.checked;de.checked=O,c(G,O,F,de,U,R)};if(de.addEventListener("change",O=>{c(G,O.target.checked,F,de,U,R)}),T.addEventListener("click",te),le.appendChild(de),le.appendChild(T),F.appendChild(le),V.sources&&V.sources.length>0){const O=document.createElement("div");O.className="mt-2 ml-9 text-xs text-gray-500 space-y-1";const me=V.sources.reduce((Z,ie)=>{const ce=`${ie.recipeName} (${ie.day} ${ie.time})`;return Z[ce]||(Z[ce]=0),Z[ce]+=ie.quantity,Z},{});for(const Z in me){const ie=document.createElement("div");ie.textContent=`‚Ü≥ ${Z}`,O.appendChild(ie)}F.appendChild(O)}P.appendChild(F)}),e.appendChild(P)}),I.length>0){const L=document.createElement("div");L.className="my-8 border-t-2 border-dashed border-gray-300 pt-4 text-center";const B=document.createElement("h3");B.className="text-lg font-semibold text-gray-500",B.textContent="Articles coch√©s",L.appendChild(B),e.appendChild(L);const P=I.reduce((X,G)=>{const re=G.category||"Inconnue";return X[re]||(X[re]=[]),X[re].push(G),X},{});Object.keys(P).sort((X,G)=>X==="Inconnue"?1:G==="Inconnue"?-1:X.localeCompare(G)).forEach(X=>{const G=document.createElement("h3");G.className="font-bold text-lg text-gray-700 mt-6 mb-3 border-b border-gray-200 pb-1",G.textContent=X,e.appendChild(G);const re=document.createElement("ul");re.className="space-y-3",P[X].sort((F,le)=>F.name.localeCompare(le.name)).forEach(F=>{const le=`${F.name}_${F.unit||""}`,de=lt(le),T=!0,S=document.createElement("li");S.className="flex flex-col p-3 rounded-lg transition-colors duration-200 bg-gray-100";const U=document.createElement("div");U.className="flex items-center w-full";const R=document.createElement("input");R.type="checkbox",R.className="form-checkbox h-6 w-6 text-tomato rounded-full border-gray-300 focus:ring-tomato cursor-pointer transition duration-150 ease-in-out",R.checked=T;const te=document.createElement("div");te.className="ml-3 flex-grow cursor-pointer select-none";const O=Number.isInteger(F.totalQuantity)?F.totalQuantity:parseFloat(F.totalQuantity.toFixed(2)),me=document.createElement("span");me.className="font-medium text-base line-through text-gray-400",me.textContent=F.name;const Z=document.createElement("span");Z.className="ml-2 font-bold text-base text-gray-400",Z.textContent=` - ${O} ${F.unit||""}`.trim(),te.appendChild(me),te.appendChild(Z);const ie=()=>{const ce=!R.checked;R.checked=ce,c(de,ce,S,R,me,Z)};R.addEventListener("change",ce=>{c(de,ce.target.checked,S,R,me,Z)}),te.addEventListener("click",ie),U.appendChild(R),U.appendChild(te),S.appendChild(U),re.appendChild(S)}),e.appendChild(re)})}const D=document.getElementById("shopping-mode-trash-btn");document.getElementById("shopping-mode-trash-count");const J=document.getElementById("shopping-trash-modal"),be=document.getElementById("shopping-trash-list"),W=document.getElementById("close-shopping-trash-modal"),j=document.getElementById("shopping-empty-trash-btn");if(D&&D.classList.add("hidden"),J&&W&&(W.onclick=()=>J.classList.add("hidden"),J.addEventListener("click",L=>{L.target===J&&J.classList.add("hidden")})),p&&p.length>0){if(j){j.classList.remove("hidden");const L=j.cloneNode(!0);j.parentNode.replaceChild(L,j),L.addEventListener("click",async()=>{if(!Ue||!confirm("Tout supprimer d√©finitivement ?"))return;const B=H(Ke,"plans",Ue.id),P=p.map(V=>lt(`${V.name}_${V.unit||""}`));try{await dt(()=>import("./firebase-config-CV1YP_xo.js").then(V=>V.F),[]).then(V=>{V.updateDoc(B,{hiddenTrashItems:V.arrayUnion(...P),lastUpdated:new Date})}),J.classList.add("hidden")}catch(V){console.error("Erreur vidage corbeille:",V)}})}if(be){be.innerHTML="";const L=document.createElement("ul");L.className="space-y-3",p.forEach(B=>{const P=document.createElement("li");P.className="flex items-center p-3 rounded-lg bg-gray-100 shadow-inner justify-between";const V=document.createElement("div");V.className="flex-grow ml-2 overflow-hidden";const X=document.createElement("span");X.className="font-medium text-base text-gray-500 line-through block truncate",X.textContent=B.name,V.appendChild(X);const G=document.createElement("div");G.className="flex items-center space-x-2 flex-shrink-0";const re=document.createElement("button");re.className="text-blue-600 hover:text-blue-800 font-medium text-sm px-3 py-1 border border-blue-300 rounded-full hover:bg-blue-50 transition-colors",re.innerHTML='<i class="fas fa-undo"></i>',re.addEventListener("click",async()=>{if(!Ue)return;const le=H(Ke,"plans",Ue.id);try{await dt(()=>import("./firebase-config-CV1YP_xo.js").then(de=>de.F),[]).then(async de=>{await de.runTransaction(Ke,async T=>{const S=await T.get(le);if(!S.exists())return;const R=(S.data().manualItems||[]).filter(te=>!(te.name.toLowerCase()===B.name.toLowerCase()&&te.unit===B.unit));T.update(le,{manualItems:R,lastUpdated:new Date})}),p.length<=1&&J.classList.add("hidden")})}catch(de){console.error("Erreur lors de la restauration :",de)}});const F=document.createElement("button");F.className="text-gray-400 hover:text-red-600 font-medium text-sm px-2 py-1",F.innerHTML='<i class="fas fa-times text-lg"></i>',F.addEventListener("click",async()=>{if(!Ue)return;const le=H(Ke,"plans",Ue.id),de=lt(`${B.name}_${B.unit||""}`);try{await dt(()=>import("./firebase-config-CV1YP_xo.js").then(T=>T.F),[]).then(T=>{T.updateDoc(le,{hiddenTrashItems:T.arrayUnion(de),lastUpdated:new Date})}),p.length<=1&&J.classList.add("hidden")}catch(T){console.error("Erreur suppression d√©finitive:",T)}}),G.appendChild(re),G.appendChild(F),P.appendChild(V),P.appendChild(G),L.appendChild(P)}),be.appendChild(L)}}else be&&(be.innerHTML='<p class="text-center text-gray-500 italic py-4">La corbeille est vide.</p>'),j&&j.classList.add("hidden")}function c(y,p,x,I,v,M){if(!Ue)return;p?(x.classList.remove("bg-white","shadow-sm","border","border-gray-100"),x.classList.add("bg-gray-100"),v.classList.add("line-through","text-gray-400"),v.classList.remove("text-gray-800"),M.classList.add("text-gray-400"),M.classList.remove("text-gray-800")):(x.classList.add("bg-white","shadow-sm","border","border-gray-100"),x.classList.remove("bg-gray-100"),v.classList.remove("line-through","text-gray-400"),v.classList.add("text-gray-800"),M.classList.remove("text-gray-400"),M.classList.add("text-gray-800"));const z=H(Ke,"plans",Ue.id),l={};l[`checkedItems.${y}`]=p,l.lastUpdated=new Date,dt(()=>import("./firebase-config-CV1YP_xo.js").then(D=>D.F),[]).then(D=>{D.updateDoc(z,l)}).catch(D=>{console.error("Error updating checked item:",D)})}function f(y){const p=new Map;(y.manualItems||[]).forEach(l=>{const D=`${l.name.trim().toLowerCase()}_${l.unit||""}`;p.set(D,{name:l.name.trim(),totalQuantity:l.totalQuantity,unit:l.unit,category:l.category||"Inconnue"})});const I=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];if(y.weeks)for(const l in y.weeks){const D=y.weeks[l],J=D.menuData||{},be=D.servingsData||{};for(const W in J){const j=J[W];if(!Array.isArray(j))continue;const[L,B]=W.split("-"),P=`${L}-${B}`,V=parseInt(be[P]||y.defaultNumPeople||1,10);j.forEach(X=>{const G=ln.find(F=>F.id===X.id)||X;if(!G||!G.ingredients)return;const re=G.servings||1;G.ingredients.forEach(F=>{if(!F.name||!F.quantity)return;const le=dn.find(O=>O.name.toLowerCase()===F.name.toLowerCase()),de=le?le.category:"Inconnue",T=parseFloat(String(F.quantity).replace(",","."));if(isNaN(T))return;const U=T/re*V,R=F.unit||"",te=`${F.name.trim().toLowerCase()}_${R}`;if(p.has(te)){const O=p.get(te);O.totalQuantity+=U,O.sources||(O.sources=[]),O.sources.push({recipeName:G.name,day:I[parseInt(L,10)],time:B==="lunch"?"Midi":"Soir",quantity:U})}else p.set(te,{name:F.name.trim(),totalQuantity:U,unit:R,category:de,sources:[{recipeName:G.name,day:I[parseInt(L,10)],time:B==="lunch"?"Midi":"Soir",quantity:U}]})})})}}const v=[],M=[],z=y.hiddenTrashItems||[];return p.forEach(l=>{if(l.totalQuantity>0)v.push(l);else if(l.totalQuantity<=0&&l.sources&&l.sources.length>0){const D=`${l.name}_${l.unit||""}`,J=lt(D);!z.includes(J)&&!z.includes(D)&&M.push(l)}}),{active:v,deleted:M}}return a(),()=>{ot&&ot()}}const Oa=Object.freeze(Object.defineProperty({__proto__:null,default:Fa},Symbol.toStringTag,{value:"Module"}));function za(){const e=localStorage.getItem("selectedPlanId"),t=document.getElementById("plan-view-name"),n=document.getElementById("meal-plan-grid"),a=document.getElementById("close-view-plan-btn");if(a&&a.addEventListener("click",()=>{localStorage.removeItem("selectedPlanId"),ut("plans")}),!e)return t&&(t.textContent="Aucune sauvegarde s√©lectionn√©e"),n&&(n.innerHTML=`<p class="text-center text-red-500">Erreur : Aucun ID de sauvegarde trouv√©. Veuillez retourner √† la page 'Mes Plans Sauvegard√©s' et en s√©lectionner une.</p>`),()=>{};async function r(){try{const i=H(w,"plan_saves",e),c=await Me(i);if(!c.exists())throw new Error("Sauvegarde non trouv√©e");const f=c.data(),y=f.planData;if(!y)throw new Error("Les donn√©es du plan sauvegard√© sont corrompues ou manquantes.");t&&(t.textContent=`Vue de : ${f.name}`),Va(n,y)}catch(i){console.error("Error fetching save:",i),t&&(t.textContent="Erreur"),n&&(n.innerHTML=`<p class="text-center text-red-500">${i.message}</p>`)}}return r(),()=>{localStorage.removeItem("selectedPlanId")}}function Va(e,t){if(!e)return;e.innerHTML="";const n=Object.keys(t.weeks||{}).sort((a,r)=>parseInt(a)-parseInt(r));if(n.length===0){e.innerHTML='<p class="text-center text-gray-500 p-10 col-span-full">Ce plan est vide.</p>';return}n.forEach(a=>{const r=t.weeks[a],i=document.createElement("h3");i.className="text-lg font-bold text-gray-700 mt-6 mb-2 col-span-full",i.textContent=`Semaine ${a}`,e.appendChild(i);const c=document.createElement("div");Qa(c,r,t.startDay,t.defaultNumPeople),e.appendChild(c)})}function Qa(e,t,n,a){const r=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"],i=r.indexOf(n||"Lundi"),c=[...r.slice(i),...r.slice(0,i)],f=t.menuData||{},y=t.servingsData||{},p=t.remarksData||{};c.forEach(x=>{const I=r.indexOf(x),v=document.createElement("div");v.className="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] items-stretch border-b border-gray-300";const M=document.createElement("div");M.className="font-bold p-2 flex items-center justify-center bg-gray-100 text-sm border-r border-gray-300",M.textContent=x.toUpperCase(),v.appendChild(M),["lunch","dinner"].forEach(z=>{const l=`${I}-${z}`,D=y[l]||a||1,J=document.createElement("div");J.className="border-r border-gray-300 flex items-center justify-center",J.innerHTML=`<div class="text-center"><i class="fas fa-users fa-xs mb-1"></i><br>${D}</div>`,v.appendChild(J);for(let be=0;be<5;be++){const W=`${I}-${z}-${be}`,j=document.createElement("div");if(j.className="meal-slot p-1 min-h-[50px] border-r border-gray-300",be===4)j.textContent=p[W]||"",j.classList.add("text-xs","italic","text-gray-600");else{const L=f[W];Array.isArray(L)&&L.length>0&&L.forEach(B=>{const P=document.createElement("div");P.className="p-1 bg-white rounded shadow-sm text-center text-xs font-medium",P.textContent=B.name,j.appendChild(P)})}v.appendChild(j)}}),e.appendChild(v)})}const Wa=Object.freeze(Object.defineProperty({__proto__:null,default:za},Symbol.toStringTag,{value:"Module"})),cn=document.querySelector("main"),Ja={menu:{html:`
        <div class="flex flex-col md:flex-row md:space-x-2">

            <!-- Left Column: Meal Planner -->
            <div class="w-full md:w-5/6">
                <section id="meal-planning-section" aria-labelledby="meal-planning-heading" class="mb-8 md:mb-12">
                                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                                        <h2 id="meal-planning-heading" class="text-xl md:text-2xl font-bold text-gray-800">Planification des repas</h2>
                                        <div class="mt-3 md:mt-0 flex items-center space-x-2 md:space-x-3 plan-actions">
                                            <button id="generate-plan-ai-btn" class="btn btn-primary btn-sm">
                                                <i class="fas fa-robot mr-1 md:mr-2"></i> IA Semaine
                                            </button>
                                            <button id="clear-menu-btn" class="btn btn-outline btn-sm text-red-800 hover:bg-red-100">
                                                <i class="fas fa-trash-alt mr-1 md:mr-2"></i> Vider le menu
                                            </button>
                                            <button id="export-plan-pdf-btn" class="btn btn-outline btn-sm">
                                                <i class="fas fa-file-pdf mr-1 md:mr-2"></i> Exporter Plan (PDF)
                                            </button>
                                            <button id="share-plan-btn" class="btn btn-secondary btn-sm">
                                                <i class="fas fa-share-alt mr-1 md:mr-2"></i> Partager
                                            </button>
                                            <button id="save-plan-btn" class="btn btn-secondary btn-sm">
                                                <i class="fas fa-save mr-1 md:mr-2"></i> Sauvegarder Plan
                                            </button>
                                        </div>
                                    </div>
                            
                                    <!-- Week Navigation & Plan Selector -->
                                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 space-y-3 md:space-y-0">
                                        <!-- Week Navigation -->
                                        <div class="flex justify-between items-center bg-white p-2 md:p-3 rounded-lg shadow-sm">
                                            <button id="prev-week-btn" class="btn btn-ghost btn-sm" aria-label="Semaine pr√©c√©dente">
                                                <i class="fas fa-chevron-left mr-1 md:mr-2"></i> Pr√©c.
                                            </button>
                                            <div id="current-week-display" class="text-gray-700 font-medium text-sm md:text-base text-center mx-4">Semaine X</div>
                                            <button id="next-week-btn" class="btn btn-ghost btn-sm" aria-label="Semaine suivante">
                                                Suiv. <i class="fas fa-chevron-right ml-1 md:ml-2"></i>
                                            </button>
                                        </div>
                                        <!-- Plan Selector -->
                                        <div class="flex flex-wrap items-center justify-center gap-2 bg-white p-3 rounded-lg shadow-sm">
                                            <label for="plan-select" class="text-sm font-medium text-gray-700">Plan affich√©:</label>
                                            <select id="plan-select" class="rounded-md border-gray-300 shadow-sm focus:border-tomato focus:ring focus:ring-tomato focus:ring-opacity-50 text-sm py-1">
                                                <!-- Options will be generated by JS -->
                                            </select>
                                            <button id="create-plan-btn" class="btn btn-primary btn-sm" title="Cr√©er un nouveau plan">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                            <button id="rename-plan-btn" class="btn btn-ghost text-blue-500 hover:bg-blue-100 btn-sm" title="Renommer le plan s√©lectionn√©">
                                                <i class="fas fa-pencil-alt"></i>
                                            </button>
                                            <button id="history-plan-btn" class="btn btn-ghost text-purple-500 hover:bg-purple-100 btn-sm" title="Historique des modifications">
                                                <i class="fas fa-history"></i>
                                            </button>
                                            <button id="leave-plan-btn" class="btn btn-ghost text-yellow-600 hover:bg-yellow-100 btn-sm" title="Quitter le plan collaboratif">
                                                <i class="fas fa-door-open"></i>
                                            </button>
                                            <button id="delete-plan-btn" class="btn btn-ghost text-red-500 hover:bg-red-100 btn-sm" title="Supprimer le plan s√©lectionn√©">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            <button id="invite-participant-btn" class="btn btn-ghost text-green-500 hover:bg-green-100 btn-sm hidden" title="Inviter un participant">
                                                <i class="fas fa-user-plus"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Collaborators Bar -->
                                    <div id="collaborators-bar" class="flex items-center space-x-2 mb-4 hidden">
                                        <!-- Avatars will be injected here -->
                                    </div>

                                    <!-- Activity Labels -->
                                    <div id="activity-labels-container" class="text-sm text-gray-600 mb-4 h-6">
                                        <!-- e.g., 'Sophie is adding a recipe...' -->
                                    </div>
                            
                                            <!-- Settings Section -->
                                            <div class="inline-flex items-center space-x-6 bg-white p-3 rounded-lg shadow-sm mb-4">                                        <div>
                                            <label for="start-day-select" class="text-sm font-medium text-gray-700">D√©but de semaine:</label>
                                            <select id="start-day-select" class="rounded-md border-gray-300 shadow-sm focus:border-tomato focus:ring-tomato text-sm py-1">
                                                <option>Lundi</option>
                                                <option>Mardi</option>
                                                <option>Mercredi</option>
                                                <option>Jeudi</option>
                                                <option>Vendredi</option>
                                                <option>Samedi</option>
                                                <option>Dimanche</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="default-servings-input" class="text-sm font-medium text-gray-700">Personnes par d√©faut:</label>
                                            <div id="default-servings-control" class="mt-1"></div>
                                        </div>
                                    </div>                    <!-- Responsive Meal Plan Grid -->
<div class="bg-white rounded-xl shadow-md p-4">
                        <!-- Desktop Grid (Visible on large screens) -->
                        <div id="desktop-plan-container" class="hidden lg:block">
                            <div id="meal-plan-grid-layout">
                                <!-- Header -->
                                <div class="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] gap-1 text-center mb-1">
                                    <div class="p-2"></div> <!-- Empty corner -->
                                    <div class="p-2 rounded-t-lg bg-amber-100 text-amber-800 font-bold col-span-6">MIDI</div>
                                    <div class="p-2 rounded-t-lg bg-stone-200 text-stone-800 font-bold col-span-6">SOIR</div>
                                    
                                    <div class="p-1"></div> <!-- Empty under day name -->
                                    <div class="p-1 text-xs font-semibold"><i class="fas fa-users"></i></div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Entr√©e</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Plat</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Accomp.</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Dessert</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Remarque</div>

                                    <div class="p-1 text-xs font-semibold"><i class="fas fa-users"></i></div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Entr√©e</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Plat</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Accomp.</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Dessert</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Remarque</div>
                                </div>
                                <!-- Rows generated by JS -->
                                <div id="meal-plan-grid" class="space-y-1">
                                    <div class="p-10 text-center text-gray-500 italic col-span-full">Chargement du planning...</div>
                                </div>
                            </div>
                        </div>

                        <!-- Mobile Accordion (Visible on small screens) -->
                        <div id="mobile-meal-plan" class="lg:hidden space-y-2">
                            <!-- Mobile content will be generated by JS here -->
                             <div class="p-10 text-center text-gray-500 italic col-span-full">Chargement du planning...</div>
                        </div>
                    </div>
                                    </section>


                                </div>
                    
                                <!-- Right Column: Shopping List -->
                                <div class="w-full md:w-1/6">
                                    <section id="shopping-list-section" aria-labelledby="shopping-list-heading" class="mb-8 md:mb-12 md:sticky md:top-24">
                                        <div class="bg-white rounded-xl shadow-md p-4 md:p-6">
                                            <div class="flex justify-between items-center mb-4">
                                        <h2 class="text-2xl font-bold text-gray-800">Liste de courses</h2>
                                        <button id="open-trash-btn" class="btn btn-ghost btn-sm text-gray-500 hover:text-gray-700 ml-2">
                                            <i class="fas fa-trash-alt text-lg"></i> <span id="trash-count" class="bg-gray-200 text-xs px-1.5 py-0.5 rounded-full ml-1">0</span>
                                        </button>
                                    </div>
                                    <div class="flex justify-end space-x-2 mb-4">
                                        <button id="import-list-btn" class="btn btn-secondary btn-sm">
                                                    <i class="fas fa-download mr-2"></i>Importer une liste
                                                </button>
                                                <div id="export-buttons-container" class="flex space-x-2">
                                                    <button id="export-txt-btn" class="btn btn-outline btn-sm">
                                                        <i class="fas fa-file-alt mr-2"></i>TXT
                                                    </button>
                                                    <button id="export-pdf-btn" class="btn btn-outline btn-sm">
                                                        <i class="fas fa-file-pdf mr-2"></i>PDF
                                                    </button>
                                                </div>
                                            </div>
                    
                                            <!-- Shopping List Container -->
                                            <div id="shopping-list-container" class="mb-4 max-h-[70vh] overflow-y-auto pr-2">                            <ul id="shopping-list" class="space-y-2 text-sm">
                                <!-- Les articles de la liste de courses seront g√©n√©r√©s ici -->
                            </ul>
                        </div>

                        <!-- Add Item Input -->
                        <div class="mt-4 flex items-stretch">
                            <div class="relative flex-grow">
                                <input type="text" id="add-item-input" placeholder="Chercher ou ajouter..." class="w-full border border-gray-300 rounded-l-lg px-2 py-1 text-xs focus:outline-none focus:ring-2 focus:ring-tomato focus:border-transparent">
                                <div id="add-item-results" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto bottom-full mb-2"></div>
                            </div>
                            <button id="add-item-btn" class="btn btn-primary rounded-l-none -ml-px btn-xs" aria-label="Ajouter l'article">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>

                         <!-- AI Shopping Tips Placeholder -->
                        <div id="ai-shopping-tip" class="mt-6 bg-avocado bg-opacity-10 rounded-lg p-3 hidden">
                            <div class="flex items-start">
                                 <div class="w-8 h-8 bg-avocado bg-opacity-20 rounded-full flex items-center justify-center mr-3 shrink-0">
                                    <i class="fas fa-lightbulb text-avocado"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-avocado mb-1 text-sm">Astuce √âconomique</h4>
                                    <p id="ai-shopping-tip-text" class="text-sm text-gray-700">...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <!-- Shared Plans Modal -->
        <div id="shared-plans-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-6xl max-h-[90vh] overflow-y-auto relative">
                <button id="close-shared-plans-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" aria-label="Fermer">
                    <i class="fas fa-times text-xl"></i>
                </button>
                <h3 id="shared-plans-modal-title" class="text-2xl font-bold mb-6">Plans partag√©s pour la Semaine X</h3>
                <div id="shared-plans-modal-container" class="space-y-6">
                    <!-- Shared plans will be loaded here -->
                </div>
            </div>
        </div>
        `,script:"./script.js"},recipes:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Recettes</h2>
            <button id="add-recipe-btn" class="btn btn-primary">
                <i class="fas fa-plus mr-2"></i> Ajouter une recette
            </button>
        </div>

        <!-- Search Bar -->
        <div class="mb-6">
            <input type="text" id="search-bar" placeholder="Rechercher une recette..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-tomato focus:border-tomato">
        </div>

        <!-- Tabs Navigation -->
        <div id="category-tabs" class="mb-6 border-b border-gray-200 flex space-x-4 flex-nowrap overflow-x-auto pb-2">
            <!-- Tabs will be generated by recipes.js here -->
        </div>

        <!-- Recipe List Container -->
        <div id="recipe-list-container">
            <!-- Recipes for the selected tab will be loaded here -->
        </div>

        <!-- Reconstructed Recipe Form Modal -->
        <div id="recipe-form-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-3xl max-h-[90vh] overflow-y-auto relative">
                <button id="close-recipe-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" aria-label="Fermer">
                    <i class="fas fa-times text-xl"></i>
                </button>
                <h3 id="recipe-modal-title" class="text-2xl font-bold mb-6">Ajouter/Modifier une recette</h3>
                <form id="recipe-form" class="space-y-4">
                    <input type="hidden" id="recipe-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label for="recipe-name" class="block text-sm font-medium text-gray-700">Nom de la recette</label>
                            <input type="text" id="recipe-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                        </div>
                        <div>
                            <label for="recipe-category" class="block text-sm font-medium text-gray-700">Cat√©gorie</label>
                            <select id="recipe-category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                                <option>ENTREE</option>
                                <option>PLAT</option>
                                <option>ACCOMPAGNEMENT</option>
                                <option>DESSERT</option>
                            </select>
                        </div>
                        <div>
                            <label for="recipe-servings" class="block text-sm font-medium text-gray-700">Nombre de personnes</label>
                            <input type="number" id="recipe-servings" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" min="1">
                        </div>
                        <div>
                            <label for="recipe-prep-time" class="block text-sm font-medium text-gray-700">Temps de pr√©paration (min)</label>
                            <input type="number" id="recipe-prep-time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" min="0">
                        </div>
                         <div>
                            <label for="recipe-difficulty" class="block text-sm font-medium text-gray-700">Difficult√©</label>
                            <select id="recipe-difficulty" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                <option>Tr√®s facile</option>
                                <option>Facile</option>
                                <option>Moyen</option>
                                <option>Difficile</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-lg font-medium text-gray-800 mb-2">Ingr√©dients</h4>
                        <div id="ingredients-list" class="space-y-2"></div>
                        <button type="button" id="add-ingredient-btn" class="btn btn-outline btn-sm mt-2">
                            <i class="fas fa-plus mr-2"></i> Ajouter un ingr√©dient
                        </button>
                    </div>
                    <div>
                        <label for="recipe-steps" class="block text-lg font-medium text-gray-800">Pr√©paration</label>
                        <textarea id="recipe-steps" rows="8" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                    </div>
                    <div class="flex justify-end space-x-4 pt-4">
                        <button type="button" id="cancel-recipe-btn" class="btn btn-ghost">Annuler</button>
                        <button type="submit" id="save-recipe-btn" class="btn btn-primary">Sauvegarder</button>
                    </div>
                </form>
            </div>
        </div>
        `,script:"./recipes.js"},ingredients:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Ingr√©dients</h2>
            <div class="flex space-x-2">
                <button id="manage-categories-btn" class="btn btn-outline">
                    <i class="fas fa-tags mr-2"></i> G√©rer les cat√©gories
                </button>
                <button id="add-ingredient-btn" class="btn btn-primary">
                    <i class="fas fa-plus mr-2"></i> Ajouter un ingr√©dient
                </button>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="mb-6">
            <input type="text" id="search-bar" placeholder="Rechercher un ingr√©dient..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-tomato focus:border-tomato">
        </div>

        <!-- Tabs Navigation -->
        <div id="category-tabs" class="mb-6 border-b border-gray-200 flex space-x-4 flex-nowrap overflow-x-auto pb-2">
            <!-- Tabs will be generated by ingredients.js here -->
        </div>

        <!-- Ingredient List Container -->
        <div id="ingredients-list-container">
            <p class="text-center text-gray-500 p-10">Chargement des ingr√©dients...</p>
        </div>

        <!-- Ingredient Form Modal -->
        <div id="ingredient-form-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-md relative">
                <button id="close-ingredient-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
                <h3 id="ingredient-modal-title" class="text-lg font-bold mb-4">Ajouter un Ingr√©dient</h3>
                <form id="ingredient-form" class="space-y-4">
                    <input type="hidden" id="ingredient-id">
                    <div>
                        <label for="ingredient-name" class="block text-sm font-medium text-gray-700">Nom</label>
                        <input type="text" id="ingredient-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                    </div>
                    <div>
                        <label for="ingredient-unit" class="block text-sm font-medium text-gray-700">Unit√© par d√©faut</label>
                        <select id="ingredient-unit" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select>
                    </div>
                    <div>
                        <label for="ingredient-category" class="block text-sm font-medium text-gray-700">Cat√©gorie</label>
                        <select id="ingredient-category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></select>
                    </div>
                    <div>
                        <label for="ingredient-image-url" class="block text-sm font-medium text-gray-700">URL de l'image</label>
                        <input type="text" id="ingredient-image-url" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="Laisser vide pour une image al√©atoire">
                    </div>
                    <div class="flex justify-end space-x-4 pt-2">
                        <button type="button" id="cancel-ingredient-btn" class="btn btn-ghost">Annuler</button>
                        <button type="submit" id="save-ingredient-btn" class="btn btn-primary">Sauvegarder</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Category Management Modal -->
        <div id="category-management-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-lg relative">
                <h3 class="text-lg font-bold mb-4">G√©rer les cat√©gories d'ingr√©dients</h3>
                <form id="add-category-form" class="flex items-center space-x-2 mb-4">
                    <input type="text" id="new-category-name" placeholder="Nom de la nouvelle cat√©gorie" class="flex-grow mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                    <button type="submit" class="btn btn-secondary">Ajouter</button>
                </form>
                <div id="category-list" class="max-h-64 overflow-y-auto border rounded-lg p-2"></div>
                <div class="flex justify-end space-x-4 mt-4">
                     <button type="button" id="close-category-modal" class="btn btn-ghost">Annuler</button>
                    <button type="button" id="done-category-modal-btn" class="btn btn-primary">Termin√©</button>
                </div>
            </div>
        </div>
        `,script:"./ingredients.js"},lists:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Listes de Courses</h2>
            <button id="add-list-btn" class="btn btn-primary">
                <i class="fas fa-plus mr-2"></i> Cr√©er une liste
            </button>
        </div>

        <!-- Search Bar -->
        <div class="mb-6">
            <input type="text" id="search-bar" placeholder="Rechercher une liste..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-tomato focus:border-tomato">
        </div>

        <!-- Lists Container -->
        <div id="lists-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

        <div class="mt-12">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6">Listes Partag√©es</h2>
            <div id="shared-lists-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Les listes partag√©es seront charg√©es ici par JS -->
            </div>
        </div>

        <!-- List Form Modal -->
        <div id="list-form-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-start justify-center z-[100] hidden pt-20">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-3xl min-h-[75vh] max-h-[90vh] overflow-y-auto relative">
                <button id="close-list-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10"><i class="fas fa-times text-xl"></i></button>
                <h3 id="list-modal-title" class="text-lg font-bold mb-4">Cr√©er une liste</h3>
                <form id="list-form" class="space-y-4 pb-20">
                    <input type="hidden" id="list-id">
                    <div>
                        <label for="list-name" class="block text-sm font-medium text-gray-700">Nom de la liste</label>
                        <input type="text" id="list-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                    </div>
                    <div>
                        <h4 class="text-md font-medium text-gray-800 mb-2">Ingr√©dients</h4>
                        <div id="ingredients-list" class="space-y-2"></div>
                        <button type="button" id="add-ingredient-btn" class="btn btn-outline btn-sm mt-2">
                            <i class="fas fa-plus mr-2"></i> Ajouter un ingr√©dient
                        </button>
                    </div>
                </form>
                <div class="absolute bottom-0 left-0 right-0 px-6 py-4 bg-white/95 backdrop-blur-sm border-t border-gray-200 flex justify-end space-x-4">
                    <button type="button" id="cancel-list-btn" class="btn btn-ghost">Annuler</button>
                    <button type="submit" form="list-form" id="save-list-btn" class="btn btn-primary">Sauvegarder la liste</button>
                </div>
            </div>
        </div>
        `,script:"./lists.js"},friends:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Amis</h2>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="md:col-span-2 space-y-8">
                <div>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Liste d'amis</h3>
                    <div id="friends-list-container" class="space-y-4">
                        <!-- La liste d'amis sera charg√©e ici -->
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Demandes envoy√©es en attente</h3>
                    <div id="pending-requests-container" class="space-y-4">
                        <!-- Les demandes envoy√©es en attente seront charg√©es ici -->
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Demandes rejet√©es</h3>
                    <div id="declined-requests-container" class="space-y-4">
                        <!-- Les demandes rejet√©es seront charg√©es ici -->
                    </div>
                </div>
            </div>
            <div>
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Rechercher un ami</h3>
                    <div class="mb-4">
                        <div class="flex items-center space-x-2">
                            <input type="text" id="search-friends-input" placeholder="Nom ou email..." class="flex-grow p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-tomato focus:border-tomato">
                            <button id="search-friends-btn" class="btn btn-primary"><i class="fas fa-search"></i></button>
                        </div>
                        <div id="search-results-container" class="mt-2 space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>
        `,script:"./friends.js"},shared:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Partages</h2>
        </div>

        <div class="space-y-12">
            <div>
                <h3 class="text-xl font-bold text-gray-700 border-b pb-2 mb-4">Partages Re√ßus</h3>
                <div id="received-shares-container" class="space-y-4">
                    <!-- L'historique des partages accept√©s sera charg√© ici -->
                </div>
            </div>
            <div>
                <h3 class="text-xl font-bold text-gray-700 border-b pb-2 mb-4">Mes Partages Envoy√©s</h3>
                <div id="sent-shares-container" class="space-y-4">
                    <!-- L'historique des partages envoy√©s sera charg√© ici -->
                </div>
            </div>
        </div>
        `,script:"./shared.js"},plans:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Plans Sauvegard√©s</h2>
        </div>
        <div id="all-plans-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- La liste des plans sera charg√©e ici -->
            <p class="text-center text-gray-500 p-10 col-span-full">Chargement de vos plans...</p>
        </div>
        `,script:"./all-plans.js"},"view-plan":{html:`
        <section aria-labelledby="meal-planning-heading" class="mb-8 md:mb-12">
            <div class="flex justify-between items-center mb-4">
                <h2 id="plan-view-name" class="text-xl md:text-2xl font-bold text-gray-800">Chargement du plan...</h2>
                <button id="close-view-plan-btn" class="btn btn-outline">
                    <i class="fas fa-times mr-2"></i> Fermer et voir mes plans
                </button>
            </div>
            <div class="bg-white rounded-xl shadow-md p-4">
                <div id="meal-plan-grid-layout">
                    <!-- Header -->
                    <div class="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] gap-1 text-center mb-1">
                        <div class="p-2"></div> <!-- Empty corner -->
                        <div class="p-2 rounded-t-lg bg-amber-100 text-amber-800 font-bold col-span-6">MIDI</div>
                        <div class="p-2 rounded-t-lg bg-stone-200 text-stone-800 font-bold col-span-6">SOIR</div>
                        <div class="p-1"></div> <!-- Empty under day name -->
                        <div class="p-1 text-xs font-semibold"><i class="fas fa-users"></i></div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Entr√©e</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Plat</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Accomp.</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Dessert</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Remarque</div>
                        <div class="p-1 text-xs font-semibold"><i class="fas fa-users"></i></div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Entr√©e</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Plat</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Accomp.</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Dessert</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Remarque</div>
                    </div>
                    <!-- Rows generated by JS -->
                    <div id="meal-plan-grid" class="space-y-1">
                        <div class="p-10 text-center text-gray-500 italic col-span-full">Chargement de la planification...</div>
                    </div>
                </div>
            </div>
        </section>
        `,script:"./view-plan.js"},"shopping-mode":{html:`
        <div class="max-w-4xl mx-auto min-h-screen pb-20 md:pb-0 relative px-4">
            <div class="sticky top-0 bg-white z-20 pt-4 pb-3">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center space-x-3">
                        <button id="shopping-mode-back-btn" class="text-gray-600 hover:text-tomato">
                            <i class="fas fa-arrow-left text-xl"></i>
                        </button>
                        <h2 class="text-2xl font-bold text-gray-800">Faire les courses</h2>
                    </div>
                    <button id="shopping-mode-trash-btn" class="text-gray-500 hover:text-gray-700 relative hidden p-2">
                        <i class="fas fa-trash-alt text-lg"></i>
                        <span id="shopping-mode-trash-count" class="absolute top-0 right-0 bg-red-500 text-white text-[10px] px-1 rounded-full">0</span>
                    </button>
                </div>
                <div class="flex justify-start items-center mb-4">
                    <label for="shopping-mode-plan-select" class="text-sm font-medium text-gray-700 mr-2">Plan:</label>
                    <select id="shopping-mode-plan-select" class="text-sm border-gray-300 rounded-md shadow-sm focus:ring-tomato focus:border-tomato font-medium text-gray-700 bg-white pr-8">
                        <option>Chargement...</option>
                    </select>
                </div>
            </div>
            
            <div id="shopping-mode-container" class="p-4 -mt-4">
                <p class="text-center text-gray-500 mt-10">Chargement de la liste...</p>
            </div>

            <!-- Shopping Mode Trash Modal -->
            <div id="shopping-trash-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden" role="dialog">
                <div class="bg-white rounded-xl p-5 w-11/12 max-w-md relative max-h-[80vh] flex flex-col">
                    <button id="close-shopping-trash-modal" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 p-2">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                    <div class="flex justify-between items-center mb-4 pr-8">
                        <h3 class="text-lg font-bold text-gray-800"><i class="fas fa-trash-alt mr-2"></i> Corbeille</h3>
                        <button id="shopping-empty-trash-btn" class="text-sm text-red-500 hover:text-red-700 font-medium hover:underline hidden">
                            Vider
                        </button>
                    </div>
                    <div id="shopping-trash-list" class="flex-grow overflow-y-auto pr-1">
                        <!-- Deleted items will be generated here -->
                    </div>
                </div>
            </div>
        </div>
        `,script:"./shopping-mode.js"}},Ga=Object.assign({"./all-plans.js":ta,"./auth.js":Yn,"./firebase-config.js":Gn,"./form-handler.js":na,"./friends.js":la,"./ingredients.js":ca,"./lists.js":fa,"./main.js":Kn,"./notifications.js":Sa,"./plans.js":xa,"./presence.js":Ma,"./recipes.js":Ta,"./script.js":$a,"./shared.js":Ua,"./sharing.js":ma,"./shopping-mode.js":Oa,"./view-plan.js":Wa});let wt=null;async function ut(e){typeof wt=="function"&&(wt(),wt=null);const t=Ja[e];if(t&&cn){if(cn.innerHTML=t.html,t.script){const n=Ga[t.script];n?n.default&&typeof n.default=="function"&&(wt=n.default()):console.error(`Module not found for path: ${t.script}`)}}else console.error(`Route not found: ${e}`)}function Ka(){const e=je();if(e){const n=document.getElementById("user-display-name");n&&(n.textContent=e.displayName||e.email)}const t=document.querySelectorAll(".nav-btn");t.forEach(n=>{n.addEventListener("click",a=>{const r=a.currentTarget.dataset.path;ut(r),t.forEach(i=>{i.classList.remove("bg-tomato","text-white"),i.classList.add("bg-white","text-tomato")}),a.currentTarget.classList.add("bg-tomato","text-white"),a.currentTarget.classList.remove("bg-white","text-tomato")})}),ut("menu"),Tn()}document.addEventListener("DOMContentLoaded",()=>{fn().then(v=>{v&&Ka()});const e=document.getElementById("profile-btn"),t=document.getElementById("profile-menu");e&&t&&(e.addEventListener("click",v=>{v.stopPropagation(),t.classList.toggle("hidden");const M=!t.classList.contains("hidden");e.setAttribute("aria-expanded",M)}),document.addEventListener("click",v=>{!(t.contains(v.target)||e.contains(v.target))&&!t.classList.contains("hidden")&&(t.classList.add("hidden"),e.setAttribute("aria-expanded","false"))}));const n=document.getElementById("settings-link"),a=document.getElementById("settings-modal"),r=document.getElementById("close-settings-modal"),i=document.getElementById("dark-mode-toggle"),c=v=>{v==="dark"?(document.documentElement.classList.add("dark"),i&&(i.checked=!0)):(document.documentElement.classList.remove("dark"),i&&(i.checked=!1))},f=localStorage.getItem("theme");f?c(f):window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?c("dark"):c("light"),n&&a&&n.addEventListener("click",v=>{v.preventDefault(),a.classList.remove("hidden")}),r&&a&&r.addEventListener("click",()=>{a.classList.add("hidden")}),a&&a.addEventListener("click",v=>{v.target===a&&a.classList.add("hidden")}),i&&i.addEventListener("change",()=>{const v=i.checked?"dark":"light";localStorage.setItem("theme",v),c(v)});const y=document.getElementById("mobile-menu-btn"),p=document.getElementById("mobile-menu"),x=document.querySelectorAll(".nav-btn-mobile");y&&p&&y.addEventListener("click",()=>{p.classList.toggle("hidden")});const I=document.getElementById("profile-btn-mobile");I&&a&&I.addEventListener("click",()=>{a.classList.remove("hidden"),p&&p.classList.add("hidden")}),x.forEach(v=>{v.addEventListener("click",M=>{const z=M.currentTarget.dataset.path;ut(z),p&&p.classList.add("hidden")})})});
