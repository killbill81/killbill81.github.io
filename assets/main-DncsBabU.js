import{o as jn,s as Gt,a as It,q as Ee,w as re,c as z,d as w,b as Fe,e as j,g as Me,h as ye,u as _e,i as Re,j as Pe,k as mt,l as on,m as yt,n as Xt,p as ln,r as An,t as kt,v as Kt,x as Hn,y as Rn,z as qn,A as Un,B as Fn,C as dn,D as On,E as zn,_ as Vn}from"./firebase-config-CV1YP_xo.js";const Qn=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"}));let xt=null;function cn(){return new Promise(e=>{jn(It,t=>{if(xt=t,t){console.log("User is logged in:",t.uid);const n=document.getElementById("logout-btn"),a=document.getElementById("profile-btn");n&&n.classList.remove("hidden"),a&&a.classList.remove("hidden"),n&&!n.hasAttribute("data-listener-attached")&&(n.addEventListener("click",()=>{Gt(It).catch(i=>{console.error("Sign Out Error",i)})}),n.setAttribute("data-listener-attached","true"));const r=document.getElementById("logout-btn-mobile");r&&!r.hasAttribute("data-listener-attached")&&(r.addEventListener("click",()=>{Gt(It).catch(i=>{console.error("Sign Out Error",i)})}),r.setAttribute("data-listener-attached","true")),e(t)}else{console.log("User not logged in. Redirecting to login.html");const n=window.location.origin+"/login.html";window.location.href!==n&&(window.location.href=n),e(null)}})})}function Se(){return xt?xt.uid:null}function je(){return xt}const Wn=Object.freeze(Object.defineProperty({__proto__:null,getCurrentUser:je,getCurrentUserId:Se,protectPage:cn},Symbol.toStringTag,{value:"Module"}));async function Jn(e){if(confirm("Voulez-vous charger cette sauvegarde ? Attention, cela √©crasera la planification de la semaine correspondante dans votre plan de travail actuel."))try{const t=Se();if(!t)throw new Error("Utilisateur non trouv√©");const n=j(w,"plan_saves",e),a=await Me(n);if(!a.exists())throw new Error("Sauvegarde non trouv√©e.");const r=a.data(),i=r.weekData.weekNumber,c=Ee(z(w,"plans"),re("userId","==",t)),m=await ye(c);if(m.empty)throw new Error("Aucun plan de travail trouv√© pour y charger la sauvegarde.");const f=m.docs[0],p=j(w,"plans",f.id);await _e(p,{[`weeks.${i}`]:r.weekData}),localStorage.setItem("selectedPlanId",f.id),ot("menu")}catch(t){console.error("Erreur lors du chargement de la sauvegarde:",t),alert(t.message)}}async function Gn(e){if(confirm("√ätes-vous s√ªr de vouloir supprimer cette sauvegarde ? Cette action est d√©finitive."))try{await Re(j(w,"plan_saves",e))}catch(t){console.error("Erreur lors de la suppression de la sauvegarde:",t),alert("La suppression a √©chou√©.")}}function Xn(){const e=document.getElementById("all-plans-list"),t=Se();if(!t||!e)return e.innerHTML="<p>Erreur de chargement.</p>",()=>{};const n=Ee(z(w,"plan_saves"),re("userId","==",t)),a=Fe(n,r=>{if(e.innerHTML="",r.empty){e.innerHTML=`<p class="text-center text-gray-500 p-10 col-span-full">Vous n'avez aucune sauvegarde.</p>`;return}const i=r.docs.map(c=>({id:c.id,...c.data()}));i.sort((c,m)=>m.savedAt.toMillis()-c.savedAt.toMillis()),i.forEach(c=>{const m=document.createElement("div");m.className="bg-white rounded-xl shadow-md p-4 flex flex-col justify-between";const f=c.savedAt?.toDate().toLocaleString("fr-FR")||"Date inconnue",p=c.planData;let x="Plan vide ou sans donn√©es.";if(p&&p.weeks){const P=Object.keys(p.weeks).length;P>0&&(x=`Contient ${P} semaine(s).`)}const L=document.createElement("div");L.innerHTML=`
                <h3 class="text-lg font-bold text-gray-800 mb-2">${c.name}</h3>
                <p class="text-sm text-gray-500">Sauvegard√© le : ${f}</p>
                <p class="text-sm text-gray-600 mt-2">${x}</p>
            `;const g=document.createElement("div");g.className="mt-4 pt-4 border-t border-gray-200 flex items-center justify-end space-x-2";const C=document.createElement("button");C.className="btn btn-secondary btn-sm",C.textContent="Voir",C.addEventListener("click",()=>{localStorage.setItem("selectedPlanId",c.id),ot("view-plan")});const M=document.createElement("button");M.className="btn btn-primary btn-sm",M.textContent="Charger",M.addEventListener("click",()=>Jn(c.id)),M.style.display="none";const u=document.createElement("button");u.className="btn btn-ghost text-red-500 hover:bg-red-100 btn-sm",u.innerHTML='<i class="fas fa-trash"></i>',u.title="Supprimer la sauvegarde",u.addEventListener("click",()=>Gn(c.id)),g.appendChild(u),g.appendChild(C),g.appendChild(M),m.appendChild(L),m.appendChild(g),e.appendChild(m)})});return()=>{a()}}const Kn=Object.freeze(Object.defineProperty({__proto__:null,default:Xn},Symbol.toStringTag,{value:"Module"}));class qt{constructor(t,n,a,r,i,c,m,f,p,x,L,g,C,M,u,P){this.db=t,this.modal=document.getElementById(n),this.form=document.getElementById(a),this.modalTitle=document.getElementById(r),this.recipeIdInput=document.getElementById(i),this.recipeNameInput=document.getElementById(c),this.recipeCategoryInput=document.getElementById(m),this.recipeServingsInput=document.getElementById(f),this.recipePrepTimeInput=document.getElementById(p),this.recipeDifficultyInput=document.getElementById(x),this.recipeImageUrlInput=document.getElementById("edit-recipe-image-url"),this.recipeStepsTextarea=document.getElementById(L),this.ingredientsListDiv=document.getElementById(g),this.addIngredientBtn=document.getElementById(C),this.saveRecipeBtn=document.getElementById(M),this.closeButton=document.getElementById(u),this.cancelButton=document.getElementById(P),this.masterIngredientList=[],this.activityUpdater=null,this.boundAddIngredient=()=>this.addIngredientInput(void 0,this.form.ingredients),this.boundCloseForm=()=>this.closeForm(),this.boundHandleSubmit=Q=>this.handleSubmit(Q),this.addIngredientBtn.addEventListener("click",this.boundAddIngredient),this.closeButton.addEventListener("click",this.boundCloseForm),this.cancelButton.addEventListener("click",this.boundCloseForm),this.saveRecipeBtn.addEventListener("click",this.boundHandleSubmit)}setActivityUpdater(t){this.activityUpdater=t}destroy(){this.addIngredientBtn.removeEventListener("click",this.boundAddIngredient),this.closeButton.removeEventListener("click",this.boundCloseForm),this.cancelButton.removeEventListener("click",this.boundCloseForm),this.saveRecipeBtn.removeEventListener("click",this.boundHandleSubmit)}async openForm(t=null,n="Ajouter une recette"){this.activityUpdater&&this.activityUpdater("editing_recipe"),await this.fetchMasterIngredients(),console.log("openForm called with recipe:",t,"and title:",n),this.form.reset(),this.ingredientsListDiv.innerHTML="",this.modalTitle.textContent=n;const a=[];if(this.form.ingredients=a,t){this.recipeIdInput.value=t.id||"",this.recipeNameInput.value=t.name||"";const r=t.category||"Plat";for(const i of this.recipeCategoryInput.options)if(i.value.toLowerCase()===r.toLowerCase()){i.selected=!0;break}this.recipeServingsInput.value=parseInt(t.servings)||"",this.recipePrepTimeInput.value=parseInt(t.prepTime)||"",this.recipeDifficultyInput.value=t.difficulty||"Moyen",this.recipeImageUrlInput.value=t.imageUrl||"",this.recipeStepsTextarea.value=t.steps||"",t.ingredients&&t.ingredients.length>0?t.ingredients.forEach(i=>this.addIngredientInput({...i},a)):this.addIngredientInput(void 0,a)}else this.recipeIdInput.value="",this.addIngredientInput(void 0,a);this.modal.classList.remove("hidden")}closeForm(){this.activityUpdater&&this.activityUpdater("idle"),this.modal.classList.add("hidden")}async fetchMasterIngredients(){if(this.masterIngredientList=[],!!this.db)try{const t=await ye(z(this.db,"ingredients"));this.masterIngredientList=t.docs.map(n=>({id:n.id,...n.data()})),this.masterIngredientList.sort((n,a)=>n.name.localeCompare(a.name))}catch(t){console.error("Erreur lors de la r√©cup√©ration de la liste des ingr√©dients: ",t),alert("Impossible de charger la liste des ingr√©dients de base. La recherche ne fonctionnera pas.")}}addIngredientInput(t={quantity:"",name:"",unit:""},n){const a=document.createElement("div");a.className="relative flex items-stretch space-x-2 ingredient-row";const r={...t};n.push(r);const i=n.length-1,c=document.createElement("input");c.type="text",c.className="ingredient-quantity mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm",c.placeholder="Qt√©",c.value=r.quantity,c.addEventListener("change",g=>{n[i].quantity=g.target.value});const m=document.createElement("input");m.type="text",m.className="ingredient-unit mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm bg-gray-100",m.placeholder="Unit√©",m.readOnly=!0,m.value=r.unit||"";const f=document.createElement("div");f.className="relative w-1/2";const p=document.createElement("input");p.type="text",p.className="ingredient-name mt-1 block w-full rounded-md border-gray-300 shadow-sm",p.placeholder="Chercher un ingr√©dient...",p.value=r.name,f.appendChild(p);const x=document.createElement("div");x.className="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto",f.appendChild(x),p.addEventListener("input",()=>{const g=p.value.toLowerCase();if(!g){x.classList.add("hidden");return}const C=this.masterIngredientList.filter(u=>u.name.toLowerCase().includes(g));x.innerHTML="",C.forEach(u=>{const P=document.createElement("div");P.className="p-2 ingredient-search-item cursor-pointer",P.textContent=u.name,P.addEventListener("click",()=>{p.value=u.name,m.value=u.unit,x.classList.add("hidden"),n[i].name=u.name,n[i].unit=u.unit,n[i].id=u.id}),x.appendChild(P)});const M=document.createElement("div");M.className="p-2 bg-blue-50 hover:bg-blue-200 cursor-pointer font-bold text-blue-700",M.textContent=`+ Cr√©er "${p.value}"`,M.addEventListener("click",async()=>{const u=p.value,P="pi√®ce(s)";try{const Q=await Pe(z(this.db,"ingredients"),{name:u,unit:P});await this.fetchMasterIngredients(),p.value=u,m.value=P,x.classList.add("hidden"),n[i].name=u,n[i].unit=P,n[i].id=Q.id}catch(Q){console.error("Erreur d'ajout d'ingr√©dient",Q),alert("L'ingr√©dient n'a pas pu √™tre cr√©√©.")}}),x.appendChild(M),x.classList.remove("hidden")});const L=document.createElement("button");L.type="button",L.className="btn btn-ghost text-red-500 hover:bg-red-50 btn-sm mt-1",L.innerHTML='<i class="fas fa-trash"></i>',L.addEventListener("click",()=>{a.remove(),n[i]=null}),a.appendChild(f),a.appendChild(c),a.appendChild(m),a.appendChild(L),this.ingredientsListDiv.appendChild(a)}async handleSubmit(t){t.preventDefault(),this.saveRecipeBtn.disabled=!0,this.saveRecipeBtn.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i> Sauvegarde...',console.log("Ingredients array from form before filter:",this.form.ingredients);const n=this.form.ingredients.filter(i=>i!==null&&i.quantity&&i.name);console.log("Ingredients array after filter:",n);const a={name:this.recipeNameInput.value,category:this.recipeCategoryInput.value,servings:parseInt(this.recipeServingsInput.value)||0,prepTime:parseInt(this.recipePrepTimeInput.value)||0,difficulty:this.recipeDifficultyInput.value,steps:this.recipeStepsTextarea.value,ingredients:n,imageUrl:this.recipeImageUrlInput.value||`https://loremflickr.com/400/300/${encodeURIComponent(this.recipeNameInput.value)}`};console.log("Recipe data being sent to Firebase:",a);const r=this.recipeIdInput.value;try{r?await mt(j(this.db,"recipes",r),a):await Pe(z(this.db,"recipes"),a),this.closeForm(),console.log("Recipe saved successfully!"),this.onSaveCallback&&this.onSaveCallback()}catch(i){console.error("Erreur de sauvegarde: ",i),alert("Une erreur est survenue lors de la sauvegarde.")}finally{this.saveRecipeBtn.disabled=!1,this.saveRecipeBtn.textContent="Sauvegarder"}}setOnSaveCallback(t){this.onSaveCallback=t}}const Yn=Object.freeze(Object.defineProperty({__proto__:null,RecipeFormHandler:qt},Symbol.toStringTag,{value:"Module"}));let _t=()=>{};function Zn(){const e=document.getElementById("search-friends-input");return document.getElementById("search-friends-btn").addEventListener("click",()=>Yt(e.value)),e.addEventListener("keyup",n=>{n.key==="Enter"&&Yt(e.value)}),ea(),un(),()=>{_t&&_t()}}async function ea(){const e=document.getElementById("friends-list-container"),t=je()?.uid;if(!t||!e)return;e.innerHTML='<p class="text-gray-500">Chargement...</p>';const n=j(w,"users",t);_t=Fe(n,async a=>{if(!a.exists()){e.innerHTML='<p class="text-red-500">Erreur: Utilisateur non trouv√©.</p>';return}const r=a.data().friends||[];if(e.innerHTML="",r.length===0){e.innerHTML=`<p class="text-gray-500">Vous n'avez pas encore d'amis. Utilisez la recherche pour en ajouter.</p>`;return}for(const i of r)try{const c=await Me(j(w,"users",i));c.exists()&&e.appendChild(ta(c.data()))}catch(c){console.error("Erreur de chargement d'un ami",c)}})}function ta(e){const t=document.createElement("div");t.className="bg-white p-3 rounded-lg flex items-center justify-between shadow-sm";const n=document.createElement("div");n.className="flex items-center",n.innerHTML=`
        <img src="${e.photoURL||"https://placehold.co/40"}" alt="Avatar" class="w-10 h-10 rounded-full mr-3">
        <div>
            <p class="font-bold">${e.displayName}</p>
            <p class="text-sm text-gray-500">${e.email}</p>
        </div>
    `;const a=document.createElement("button");return a.className="btn btn-ghost text-red-500 btn-sm",a.innerHTML='<i class="fas fa-user-times"></i>',a.title="Retirer cet ami",a.addEventListener("click",()=>na(e.uid)),t.appendChild(n),t.appendChild(a),t}async function na(e){const t=je()?.uid;if(!t||!e){console.error("Impossible de supprimer l'ami : ID utilisateur ou ID ami manquant.");return}if(!confirm("Voulez-vous vraiment retirer cet ami ? Cette action est unilat√©rale."))return;console.log(`Tentative de suppression de l'ami ${e} pour l'utilisateur ${t}`);const n=j(w,"users",t);try{await _e(n,{friends:on(e)}),console.log("Ami supprim√© avec succ√®s de la base de donn√©es.")}catch(a){console.error("Erreur lors de la suppression de l'ami: ",a),alert("Une erreur est survenue.")}}async function Yt(e){const t=document.getElementById("search-results-container"),n=je()?.uid;if(!(!e||!t)){t.innerHTML='<p class="text-gray-500">Recherche en cours...</p>';try{const a=e.toLowerCase(),r=a+"Ô£ø",i=Ee(z(w,"users"),re("displayName_lowercase",">=",a),re("displayName_lowercase","<",r)),c=Ee(z(w,"users"),re("email","==",a)),[m,f]=await Promise.all([ye(i),ye(c)]),p=new Map;if(m.forEach(x=>p.set(x.id,x.data())),f.forEach(x=>p.set(x.id,x.data())),t.innerHTML="",p.size===0){t.innerHTML='<p class="text-gray-500">Aucun utilisateur trouv√©.</p>';return}p.forEach(x=>{if(x.uid===n)return;const L=document.createElement("div");L.className="bg-gray-50 p-2 rounded-lg flex items-center justify-between",L.innerHTML=`
                <div class="flex items-center">
                    <img src="${x.photoURL||"https://placehold.co/32"}" class="w-8 h-8 rounded-full mr-2">
                    <span class="font-medium text-sm">${x.displayName} (${x.email})</span>
                </div>
            `;const g=document.createElement("button");g.className="btn btn-secondary btn-xs",g.innerHTML='<i class="fas fa-user-plus"></i>',g.addEventListener("click",()=>aa(x.uid)),L.appendChild(g),t.appendChild(L)})}catch(a){console.error("Erreur de recherche: ",a),t.innerHTML='<p class="text-red-500">Erreur de recherche.</p>'}}}async function aa(e){const t=je()?.uid;if(!t||t===e)return;const n=Ee(z(w,"friend_requests"),re("senderId","==",t),re("receiverId","==",e)),a=Ee(z(w,"friend_requests"),re("senderId","==",e),re("receiverId","==",t)),[r,i]=await Promise.all([ye(n),ye(a)]);if(!r.empty||!i.empty)return alert("Une demande d'ami existe d√©j√† avec cet utilisateur.");if((await Me(j(w,"users",t))).data()?.friends?.includes(e))return alert("Vous √™tes d√©j√† ami avec cet utilisateur.");try{await Pe(z(w,"friend_requests"),{senderId:t,receiverId:e,status:"pending",createdAt:yt()}),alert("Demande d'ami envoy√©e !")}catch(m){console.error("Erreur lors de l'envoi de la demande d'ami: ",m),alert("Une erreur est survenue.")}}async function un(){const e=document.getElementById("pending-requests-container"),t=document.getElementById("declined-requests-container"),n=je()?.uid;if(!(!n||!e||!t)){e.innerHTML='<p class="text-gray-500">Chargement...</p>',t.innerHTML='<p class="text-gray-500">Chargement...</p>';try{const a=Ee(z(w,"friend_requests"),re("senderId","==",n)),r=await ye(a),i=[],c=[];for(const m of r.docs){const f={id:m.id,...m.data()},p=await Me(j(w,"users",f.receiverId));p.exists()&&(f.receiver=p.data()),f.status==="pending"?i.push(f):f.status==="declined"&&c.push(f)}e.innerHTML="",i.length>0?i.forEach(m=>e.appendChild(Zt(m))):e.innerHTML='<p class="text-gray-500">Aucune demande en attente.</p>',t.innerHTML="",c.length>0?c.forEach(m=>t.appendChild(Zt(m))):t.innerHTML='<p class="text-gray-500">Aucune demande rejet√©e.</p>'}catch(a){console.error("Erreur lors du chargement des demandes envoy√©es: ",a),e.innerHTML='<p class="text-red-500">Erreur de chargement.</p>',t.innerHTML='<p class="text-red-500">Erreur de chargement.</p>'}}}function Zt(e){const t=document.createElement("div");t.className="bg-white p-3 rounded-lg flex items-center justify-between shadow-sm";const n=e.receiver,a=document.createElement("div");a.className="flex items-center",a.innerHTML=`
        <img src="${n?.photoURL||"https://placehold.co/40"}" alt="Avatar" class="w-10 h-10 rounded-full mr-3">
        <div>
            <p class="font-bold">${n?.displayName||"Utilisateur inconnu"}</p>
            <p class="text-sm text-gray-500">Statut : <span class="font-medium">${e.status}</span></p>
        </div>
    `;const r=document.createElement("button");return r.className="btn btn-ghost text-red-500 btn-sm",r.innerHTML='<i class="fas fa-times-circle"></i>',r.title="Annuler la demande",r.addEventListener("click",async()=>{confirm("Voulez-vous vraiment annuler cette demande ?")&&(await Re(j(w,"friend_requests",e.id)),un())}),t.appendChild(a),t.appendChild(r),t}async function mn(e){try{const t=j(w,"friend_requests",e);await _e(t,{status:"accepted"})}catch(t){throw console.error("Erreur lors de l'acceptation de la demande d'ami: ",t),t}}async function pn(e){try{const t=j(w,"friend_requests",e);await _e(t,{status:"declined"})}catch(t){throw console.error("Erreur lors du refus de la demande d'ami: ",t),t}}const sa=Object.freeze(Object.defineProperty({__proto__:null,acceptFriendRequest:mn,declineFriendRequest:pn,default:Zn},Symbol.toStringTag,{value:"Module"}));function ra(){const e=document.getElementById("ingredients-list-container"),t=document.getElementById("add-ingredient-btn"),n=document.getElementById("category-tabs"),a=document.getElementById("search-bar"),r=document.getElementById("ingredient-form-modal"),i=document.getElementById("ingredient-modal-title"),c=document.getElementById("close-ingredient-modal"),m=document.getElementById("cancel-ingredient-btn"),f=document.getElementById("ingredient-form"),p=document.getElementById("ingredient-id"),x=document.getElementById("ingredient-name"),L=document.getElementById("ingredient-unit"),g=document.getElementById("ingredient-category"),C=document.getElementById("manage-categories-btn"),M=document.getElementById("category-management-modal"),u=document.getElementById("close-category-modal"),P=document.getElementById("done-category-modal-btn"),Q=document.getElementById("add-category-form"),ve=document.getElementById("new-category-name"),_=document.getElementById("category-list");let $=[],D=[],q="",J="",le=null;const ne=["g","kg","ml","l","pi√®ce(s)","c.√†.s.","c.√†.c.","pinc√©e(s)"];async function Y(){await ie(),await ae()}async function ie(){if(w)try{D=(await ye(z(w,"ingredient_categories"))).docs.map(A=>({id:A.id,...A.data()})),D.sort((A,T)=>A.name.localeCompare(T.name))}catch(O){console.error("Erreur lors de la r√©cup√©ration des cat√©gories: ",O)}}async function ae(){if(w)try{$=(await ye(z(w,"ingredients"))).docs.map(A=>({id:A.id,...A.data()})),K(),pe()}catch(O){console.error("Erreur de chargement des ingr√©dients: ",O)}}function xe(O=null){f.reset(),L.innerHTML="",ne.forEach(U=>{const oe=document.createElement("option");oe.value=U,oe.textContent=U,L.appendChild(oe)});const A=D.map(U=>U.name),T=[...new Set($.map(U=>U.category).filter(Boolean))],N=[...new Set([...A,...T])];N.sort((U,oe)=>U.localeCompare(oe.name)),g.innerHTML="",N.forEach(U=>{const oe=document.createElement("option");oe.value=U,oe.textContent=U,g.appendChild(oe)}),O?(i.textContent="Modifier l'ingr√©dient",p.value=O.id,x.value=O.name,L.value=O.unit||"",g.value=O.category||(N.length>0?N[0]:""),document.getElementById("ingredient-image-url").value=O.imageUrl||""):(i.textContent="Ajouter un ingr√©dient",p.value="",L.value=ne[0],g.value=q||(N.length>0?N[0]:"")),r.classList.remove("hidden")}function qe(){r.classList.add("hidden")}async function F(O){O.preventDefault();const A=p.value,T={name:x.value,unit:L.value,category:g.value,imageUrl:document.getElementById("ingredient-image-url").value||`https://loremflickr.com/400/300/${encodeURIComponent(x.value)}`};if(!T.name||!T.category){alert("Le nom et la cat√©gorie sont requis.");return}try{A?await mt(j(w,"ingredients",A),T):await Pe(z(w,"ingredients"),T),qe(),await ae()}catch(N){console.error("Erreur de sauvegarde de l'ingr√©dient: ",N)}}function k(){V(),M.classList.remove("hidden")}function W(){M.classList.add("hidden")}function V(){if(_.innerHTML="",D.length===0){_.innerHTML='<p class="text-gray-500">Aucune cat√©gorie d√©finie.</p>';return}D.forEach(O=>{const A=document.createElement("div");A.className="flex items-center justify-between p-2 border-b";const T=document.createElement("span");T.textContent=O.name,A.appendChild(T);const N=document.createElement("div");N.className="flex space-x-2";const U=document.createElement("button");U.className="btn btn-ghost btn-xs text-blue-500",U.innerHTML='<i class="fas fa-edit"></i>',U.addEventListener("click",()=>ee(O)),N.appendChild(U);const oe=document.createElement("button");oe.className="btn btn-ghost btn-xs text-red-500",oe.innerHTML='<i class="fas fa-trash"></i>',oe.addEventListener("click",()=>we(O)),N.appendChild(oe),A.appendChild(N),_.appendChild(A)})}async function Z(O){O.preventDefault();const A=ve.value.trim();if(A&&!D.find(T=>T.name.toLowerCase()===A.toLowerCase()))try{await Pe(z(w,"ingredient_categories"),{name:A}),ve.value="",await ie(),V(),K()}catch(T){console.error("Erreur d'ajout de cat√©gorie: ",T)}else alert("Cette cat√©gorie existe d√©j√† ou le nom est invalide.")}async function ee(O){const A=O.name,T=prompt(`Entrez le nouveau nom pour la cat√©gorie "${A}":`,A);if(T&&T.trim()!==""&&T!==A)try{await mt(j(w,"ingredient_categories",O.id),{name:T});const N=Ee(z(w,"ingredients"),re("category","==",A)),U=await ye(N),oe=Xt(w);U.forEach(We=>{oe.update(We.ref,{category:T})}),await oe.commit(),await Y(),V()}catch(N){console.error("Erreur de renommage: ",N)}}async function we(O){if(confirm(`√ätes-vous s√ªr de vouloir supprimer la cat√©gorie "${O.name}"?

Tous les ingr√©dients associ√©s seront d√©plac√©s vers la cat√©gorie "Inconnue".`))try{await Re(j(w,"ingredient_categories",O.id));const A=Ee(z(w,"ingredients"),re("category","==",O.name)),T=await ye(A),N=Xt(w);T.forEach(U=>{N.update(U.ref,{category:"Inconnue"})}),await N.commit(),q="",await Y(),V()}catch(A){console.error("Erreur de suppression: ",A)}}function K(){n.innerHTML="";const O=D.map(N=>N.name),A=[...new Set($.map(N=>N.category||"Inconnue"))];let T=[...new Set([...O,...A])];T.sort((N,U)=>N.localeCompare(U)),T.includes("Inconnue")&&(T=T.filter(N=>N!=="Inconnue"),T.push("Inconnue")),T.length===0&&$.length>0&&T.push("Inconnue"),!q&&T.length>0&&(q=T[0]),T.forEach(N=>{const U=document.createElement("button"),oe=N===q;U.className=`px-4 py-2 text-sm font-medium rounded-t-lg ${oe?"bg-tomato text-white":"text-gray-500 hover:text-tomato"}`,U.textContent=N,U.addEventListener("click",()=>ue(N)),n.appendChild(U)})}function ue(O){q=O,K(),pe()}function pe(){e.innerHTML="";const O=q||(D.length>0?D[0].name:"Inconnue");let A=$.filter(N=>(N.category||"Inconnue")===O);if(J){const N=J.toLowerCase();A=A.filter(U=>U.name.toLowerCase().includes(N))}if(A.length===0){e.innerHTML='<p class="text-center text-gray-500 p-10">Aucun ingr√©dient dans cette cat√©gorie.</p>';return}A.sort((N,U)=>N.name.localeCompare(U.name,"fr",{sensitivity:"base"}));const T=document.createElement("div");T.className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4",A.forEach(N=>{const U=document.createElement("div");if(U.className="p-3 bg-white shadow-sm rounded-lg flex flex-col items-start space-y-2",N.imageUrl){const et=document.createElement("img");et.src=N.imageUrl,et.alt=N.name,et.className="w-full h-24 object-cover rounded-md mb-2",U.appendChild(et)}const oe=document.createElement("div");oe.className="flex-grow w-full flex justify-between items-center";const We=document.createElement("span");We.className="font-medium text-gray-800",We.textContent=N.name;const Ke=document.createElement("span");Ke.className="text-gray-500 text-sm bg-gray-100 px-2 py-1 rounded-full",Ke.textContent=N.unit,oe.appendChild(We),oe.appendChild(Ke);const Je=document.createElement("div");Je.className="w-full flex justify-end items-center space-x-2 border-t pt-2 mt-2";const Ye=document.createElement("button");Ye.className="btn btn-ghost btn-xs text-blue-500 hover:bg-blue-50",Ye.innerHTML='<i class="fas fa-edit"></i>',Ye.addEventListener("click",()=>xe(N));const Ze=document.createElement("button");Ze.className="btn btn-ghost btn-xs text-red-500 hover:bg-red-50",Ze.innerHTML='<i class="fas fa-trash-alt"></i>',Ze.addEventListener("click",()=>Te(N.id,N.name)),Je.appendChild(Ye),Je.appendChild(Ze),U.appendChild(oe),U.appendChild(Je),T.appendChild(U)}),e.appendChild(T)}async function Te(O,A){if(confirm(`√ätes-vous s√ªr de vouloir supprimer l'ingr√©dient "${A}" ?`))try{await Re(j(w,"ingredients",O)),await ae()}catch(T){console.error("Erreur de suppression de l'ingr√©dient: ",T)}}a.addEventListener("input",O=>{const A=O.target.value.toLowerCase();if(!J&&A&&(le=q),J=A,J){const T=$.find(N=>N.name.toLowerCase().includes(J));T&&(q=T.category||"Inconnue")}else le&&(q=le,le=null);K(),pe()}),t.addEventListener("click",()=>xe()),c.addEventListener("click",qe),m.addEventListener("click",qe),f.addEventListener("submit",F),C.addEventListener("click",k),u.addEventListener("click",W),P.addEventListener("click",W),Q.addEventListener("submit",Z),Y()}const ia=Object.freeze(Object.defineProperty({__proto__:null,default:ra},Symbol.toStringTag,{value:"Module"})),G={modal:document.getElementById("share-modal"),closeBtn:document.getElementById("close-share-modal"),title:document.getElementById("share-modal-title"),friendsList:document.getElementById("share-friends-list"),sharePlanCheckbox:document.getElementById("share-planning-checkbox"),shareShoppingListCheckbox:document.getElementById("share-shopping-list-checkbox"),confirmBtn:document.getElementById("confirm-share-btn")};let Ue={};function Lt(){G.modal.classList.add("hidden");const e=document.getElementById("share-mode-selection");e&&e.classList.remove("hidden"),G.confirmBtn.textContent="Envoyer le partage";const t=G.confirmBtn.cloneNode(!0);G.confirmBtn.parentNode&&(G.confirmBtn.parentNode.replaceChild(t,G.confirmBtn),G.confirmBtn=t,t.addEventListener("click",fn))}async function fn(){const e=Se();if(!e||!Ue.plan)return;const t=Array.from(G.friendsList.querySelectorAll('input[type="checkbox"]:checked')).map(a=>a.value),n=document.querySelector('input[name="share-mode"]:checked')?.value;if(t.length===0){alert("Veuillez s√©lectionner au moins un ami.");return}if(!n){alert("Veuillez s√©lectionner un mode de partage.");return}G.confirmBtn.disabled=!0,G.confirmBtn.textContent="Envoi en cours...";try{const a=z(w,"shares");let r={};n==="collaborate"?r={senderId:e,createdAt:new Date,type:"collaborative_plan_invite",planId:Ue.plan.id,planName:Ue.plan.name}:r={senderId:e,createdAt:new Date,type:"share",plan:{name:Ue.plan.name,weeks:Ue.plan.weeks||{},manualItems:Ue.plan.manualItems||[],defaultNumPeople:Ue.plan.defaultNumPeople||1,startDay:Ue.plan.startDay||"Lundi"}};for(const i of t)await Pe(a,{...r,receiverId:i,status:"pending"});Lt(),alert("Partage envoy√© avec succ√®s !")}catch(a){console.error("Erreur lors de l'envoi du partage : ",a),alert("Une erreur est survenue lors de l'envoi du partage.")}finally{G.confirmBtn.disabled=!1,G.confirmBtn.textContent="Envoyer le partage"}}async function Ut(e={}){const{plan:t}=e;if(!t){alert("Aucun plan s√©lectionn√© √† partager.");return}Ue={plan:t},G.title.textContent=`Partager le plan "${t.name}"`,G.friendsList.innerHTML='<p class="text-gray-500">Chargement des amis...</p>',G.modal.classList.remove("hidden");const n=Se();if(n)try{const a=await Me(j(w,"users",n));if(a.exists()){const i=a.data().friends||[];if(i.length===0){G.friendsList.innerHTML=`<p class="text-gray-500">Vous n'avez pas d'amis √† qui partager.</p>`;return}G.friendsList.innerHTML="";for(const c of i){const m=await Me(j(w,"users",c));if(m.exists()){const f=m.data(),p=document.createElement("label");p.className="flex items-center p-2 hover:bg-gray-100 rounded-lg cursor-pointer";const x=document.createElement("input");x.type="checkbox",x.value=f.uid,x.className="form-checkbox h-5 w-5 text-tomato rounded focus:ring-tomato",p.appendChild(x);const L=document.createElement("img");L.src=f.photoURL||"https://placehold.co/40x40",L.alt=f.displayName,L.className="w-8 h-8 rounded-full ml-3 mr-3",p.appendChild(L);const g=document.createElement("span");g.className="font-medium",g.textContent=f.displayName||f.email,p.appendChild(g),G.friendsList.appendChild(p)}}}}catch(a){console.error("Erreur lors du chargement des amis pour le partage : ",a),G.friendsList.innerHTML='<p class="text-red-500">Une erreur est survenue.</p>'}}async function oa(e){const t=Se();if(!t||!e)return;const n=Array.from(G.friendsList.querySelectorAll('input[type="checkbox"]:checked:not(:disabled)')).map(a=>a.value);if(n.length===0){alert("Veuillez s√©lectionner au moins un ami √† inviter.");return}G.confirmBtn.disabled=!0,G.confirmBtn.textContent="Envoi en cours...";try{const a=await Me(j(w,"plans",e));if(!a.exists())throw new Error("Plan not found");const r=a.data().name,i=z(w,"shares"),c={senderId:t,createdAt:new Date,type:"collaborative_plan_invite",planId:e,planName:r};for(const m of n)await Pe(i,{...c,receiverId:m,status:"pending"});Lt(),alert("Invitation(s) envoy√©e(s) avec succ√®s !")}catch(a){console.error("Erreur lors de l'envoi de l'invitation : ",a),alert("Une erreur est survenue lors de l'envoi de l'invitation.")}finally{G.confirmBtn.disabled=!1}}async function gn(e){if(!e||!e.id){alert("Plan non valide pour l'invitation.");return}Ue={plan:e},G.title.textContent=`Inviter √† collaborer sur "${e.name}"`;const t=document.getElementById("share-mode-selection");t&&t.classList.add("hidden"),G.friendsList.innerHTML='<p class="text-gray-500">Chargement des amis...</p>',G.modal.classList.remove("hidden");const n=Se();if(!n)return;try{const r=await Me(j(w,"users",n));if(r.exists()){const c=r.data().friends||[],m=[e.userId,...e.collaborators||[]];if(c.length===0){G.friendsList.innerHTML=`<p class="text-gray-500">Vous n'avez pas d'amis √† inviter.</p>`;return}G.friendsList.innerHTML="";for(const f of c){const p=await Me(j(w,"users",f));if(p.exists()){const x=p.data(),L=m.includes(x.uid),g=document.createElement("label");g.className=`flex items-center p-2 rounded-lg ${L?"opacity-50 cursor-not-allowed":"hover:bg-gray-100 cursor-pointer"}`;const C=document.createElement("input");C.type="checkbox",C.value=x.uid,C.className="form-checkbox h-5 w-5 text-tomato rounded focus:ring-tomato",L&&(C.disabled=!0,C.checked=!0),g.appendChild(C);const M=document.createElement("img");M.src=x.photoURL||"https://placehold.co/40x40",M.alt=x.displayName,M.className="w-8 h-8 rounded-full ml-3 mr-3",g.appendChild(M);const u=document.createElement("span");if(u.className="font-medium",u.textContent=x.displayName||x.email,L){const P=document.createElement("span");P.className="text-xs text-gray-400 ml-2",P.textContent="(d√©j√† membre)",u.appendChild(P)}g.appendChild(u),G.friendsList.appendChild(g)}}}}catch(r){console.error("Erreur lors du chargement des amis pour l'invitation : ",r),G.friendsList.innerHTML='<p class="text-red-500">Une erreur est survenue.</p>'}G.confirmBtn.textContent="Envoyer l'invitation";const a=G.confirmBtn.cloneNode(!0);G.confirmBtn.parentNode.replaceChild(a,G.confirmBtn),G.confirmBtn=a,a.addEventListener("click",()=>oa(e.id))}G.closeBtn?.addEventListener("click",Lt);G.modal?.addEventListener("click",e=>{e.target===G.modal&&Lt()});G.confirmBtn?.addEventListener("click",fn);const la=Object.freeze(Object.defineProperty({__proto__:null,openInviteParticipantModal:gn,openShareModal:Ut},Symbol.toStringTag,{value:"Module"}));function da(){const e=document.getElementById("search-bar"),t=document.getElementById("lists-container"),n=document.getElementById("add-list-btn"),a=document.getElementById("shared-lists-container"),r=document.getElementById("list-form-modal"),i=document.getElementById("list-modal-title"),c=document.getElementById("close-list-modal"),m=document.getElementById("cancel-list-btn"),f=document.getElementById("list-form"),p=document.getElementById("list-id"),x=document.getElementById("list-name"),L=document.getElementById("ingredients-list"),g=document.getElementById("add-ingredient-btn"),C=document.getElementById("save-list-btn");let M=[],u="",P=[],Q=[];async function ve(){await _(),await $(),await D()}async function _(){if(w)try{P=(await ye(z(w,"ingredients"))).docs.map(k=>({id:k.id,...k.data()})),P.sort((k,W)=>k.name.localeCompare(W.name))}catch(F){console.error("Erreur lors de la r√©cup√©ration de la liste des ingr√©dients: ",F)}}async function $(){const F=Se();if(!(!w||!F))try{const k=Ee(z(w,"shopping_lists"),re("userId","==",F));M=(await ye(k)).docs.map(V=>({id:V.id,...V.data()})).filter(V=>V.isShared!==!0),Y()}catch(k){console.error("Erreur de chargement des listes: ",k)}}async function D(){const F=Se();if(!(!w||!F)){console.log(`Recherche de listes partag√©es pour userId: ${F}`);try{const k=Ee(z(w,"shopping_lists"),re("userId","==",F),re("isShared","==",!0)),W=await ye(k);console.log(`Trouv√© ${W.size} liste(s) partag√©e(s).`);const V=W.docs.map(Z=>({id:Z.id,...Z.data()}));ie(V)}catch(k){console.error("Erreur de chargement des listes partag√©es: ",k)}}}async function q(F=null){await _(),f.reset(),L.innerHTML="",Q=[],F?(i.textContent="Modifier la liste",p.value=F.id,x.value=F.name,F.ingredients&&F.ingredients.length>0?F.ingredients.forEach(k=>ne(k)):ne()):(i.textContent="Cr√©er une liste",p.value="",ne()),r.classList.remove("hidden")}function J(){r.classList.add("hidden")}async function le(F){F.preventDefault(),C.disabled=!0;const k=Se();if(!k){alert("Erreur : utilisateur non connect√©."),C.disabled=!1;return}const W=Q.filter(ee=>ee&&ee.name&&ee.quantity),V={name:x.value,ingredients:W,userId:k};if(!V.name){alert("Le nom de la liste est requis."),C.disabled=!1;return}const Z=p.value;try{Z?await mt(j(w,"shopping_lists",Z),V):await Pe(z(w,"shopping_lists"),V),J(),await $()}catch(ee){console.error("Erreur de sauvegarde de la liste: ",ee)}finally{C.disabled=!1}}function ne(F={quantity:"",name:"",unit:""}){const k=document.createElement("div");k.className="relative flex items-stretch space-x-2 ingredient-row";const W={...F};Q.push(W);const V=Q.length-1,Z=document.createElement("input");Z.type="text",Z.className="ingredient-quantity mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm",Z.placeholder="Qt√©",Z.value=W.quantity,Z.addEventListener("change",Te=>{Q[V].quantity=Te.target.value});const ee=document.createElement("input");ee.type="text",ee.className="ingredient-unit mt-1 block w-1/4 rounded-md border-gray-300 shadow-sm bg-gray-100",ee.placeholder="Unit√©",ee.readOnly=!0,ee.value=W.unit||"";const we=document.createElement("div");we.className="relative w-1/2";const K=document.createElement("input");K.type="text",K.className="ingredient-name mt-1 block w-full rounded-md border-gray-300 shadow-sm",K.placeholder="Chercher un ingr√©dient...",K.value=W.name,we.appendChild(K);const ue=document.createElement("div");ue.className="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto",we.appendChild(ue),K.addEventListener("input",()=>{const Te=K.value.toLowerCase();if(!Te){ue.classList.add("hidden");return}const O=P.filter(T=>T.name.toLowerCase().includes(Te));ue.innerHTML="",O.forEach(T=>{const N=document.createElement("div");N.className="p-2 ingredient-search-item cursor-pointer",N.textContent=T.name,N.addEventListener("click",()=>{K.value=T.name,ee.value=T.unit,ue.classList.add("hidden"),Q[V].name=T.name,Q[V].unit=T.unit,Q[V].id=T.id}),ue.appendChild(N)});const A=document.createElement("div");A.className="p-2 bg-blue-50 hover:bg-blue-200 cursor-pointer font-bold text-blue-700",A.textContent=`+ Cr√©er "${K.value}"`,A.addEventListener("click",async()=>{const T=K.value,N="pi√®ce(s)";try{const U=await Pe(z(w,"ingredients"),{name:T,unit:N,category:"Inconnue"});await _(),K.value=T,ee.value=N,ue.classList.add("hidden"),Q[V].name=T,Q[V].unit=N,Q[V].id=U.id}catch(U){console.error("Erreur d'ajout d'ingr√©dient",U),alert("L'ingr√©dient n'a pas pu √™tre cr√©√©.")}}),ue.appendChild(A),ue.classList.remove("hidden")});const pe=document.createElement("button");pe.type="button",pe.className="btn btn-ghost text-red-500 hover:bg-red-50 btn-sm mt-1",pe.innerHTML='<i class="fas fa-trash"></i>',pe.addEventListener("click",()=>{k.remove(),Q[V]=null}),k.appendChild(we),k.appendChild(Z),k.appendChild(ee),k.appendChild(pe),L.appendChild(k)}function Y(){t.innerHTML="";let F=M;if(u){const k=u.toLowerCase();F=M.filter(W=>W.name.toLowerCase().includes(k))}if(F.length===0){t.innerHTML='<p class="text-center text-gray-500 p-10 col-span-full">Aucune liste de courses trouv√©e.</p>';return}F.sort((k,W)=>k.name.localeCompare(W.name)),F.forEach(k=>{const W=document.createElement("div");W.className="bg-white rounded-lg shadow-md p-4 flex flex-col";const V=document.createElement("div");V.className="flex justify-between items-start border-b pb-2 mb-2";const Z=document.createElement("h4");Z.className="text-lg font-bold text-gray-800",Z.textContent=k.name,V.appendChild(Z);const ee=document.createElement("div");ee.className="flex space-x-2";const we=document.createElement("button");we.className="btn btn-ghost btn-sm text-blue-500",we.innerHTML='<i class="fas fa-edit"></i>',we.addEventListener("click",()=>q(k)),ee.appendChild(we);const K=document.createElement("button");K.className="btn btn-ghost btn-sm text-green-500",K.innerHTML='<i class="fas fa-share-alt"></i>',K.addEventListener("click",()=>Ut({})),ee.appendChild(K);const ue=document.createElement("button");ue.className="btn btn-ghost btn-sm text-red-500",ue.innerHTML='<i class="fas fa-trash"></i>',ue.addEventListener("click",()=>ae(k.id,k.name)),ee.appendChild(ue),V.appendChild(ee);const pe=document.createElement("ul");pe.className="space-y-1 text-sm text-gray-600 flex-grow",k.ingredients&&k.ingredients.length>0?k.ingredients.forEach(Te=>{const O=document.createElement("li");O.textContent=`${Te.quantity} ${Te.unit||""} - ${Te.name}`.trim(),pe.appendChild(O)}):pe.innerHTML='<li class="italic text-gray-400">Cette liste est vide.</li>',W.appendChild(V),W.appendChild(pe),t.appendChild(W)})}function ie(F){if(a.innerHTML="",F.length===0){a.innerHTML='<p class="text-center text-gray-500 p-10 col-span-full">Aucune liste de courses partag√©e trouv√©e.</p>';return}F.sort((k,W)=>k.name.localeCompare(W.name)),F.forEach(k=>{const W=document.createElement("div");W.className="bg-white rounded-lg shadow-md p-4 flex flex-col";const V=document.createElement("div");V.className="flex justify-between items-start border-b pb-2 mb-2";const Z=document.createElement("h4");Z.className="text-lg font-bold text-gray-800",Z.textContent=k.name,V.appendChild(Z);const ee=document.createElement("div");ee.className="flex space-x-2";const we=document.createElement("button");we.className="btn btn-secondary btn-sm",we.innerHTML='<i class="fas fa-copy mr-2"></i> Copier dans mes listes',we.title="Copier cette liste dans vos listes personnelles",we.addEventListener("click",()=>qe(k.id)),ee.appendChild(we);const K=document.createElement("button");K.className="btn btn-ghost btn-sm text-red-500",K.innerHTML='<i class="fas fa-trash"></i>',K.title="Supprimer cette liste partag√©e",K.addEventListener("click",()=>xe(k.id,k.name)),ee.appendChild(K),V.appendChild(ee);const ue=document.createElement("ul");ue.className="space-y-1 text-sm text-gray-600 flex-grow",k.ingredients&&k.ingredients.length>0?k.ingredients.forEach(pe=>{const Te=document.createElement("li");Te.textContent=`${pe.quantity} ${pe.unit||""} - ${pe.name}`.trim(),ue.appendChild(Te)}):ue.innerHTML='<li class="italic text-gray-400">Cette liste est vide.</li>',W.appendChild(V),W.appendChild(ue),a.appendChild(W)})}async function ae(F,k){if(confirm(`√ätes-vous s√ªr de vouloir supprimer la liste "${k}" ?`))try{await Re(j(w,"shopping_lists",F)),await $()}catch(W){console.error("Erreur de suppression de la liste: ",W)}}async function xe(F,k){if(confirm(`√ätes-vous s√ªr de vouloir supprimer la liste partag√©e "${k}" ?`))try{await Re(j(w,"shopping_lists",F)),await D()}catch(W){console.error("Erreur de suppression de la liste partag√©e: ",W),alert("Une erreur est survenue.")}}async function qe(F){if(confirm("Voulez-vous vraiment copier cette liste dans vos listes personnelles ? Elle ne sera plus consid√©r√©e comme une liste partag√©e."))try{const k=j(w,"shopping_lists",F);await _e(k,{isShared:!1}),await ve()}catch(k){console.error("Erreur lors de la copie de la liste: ",k),alert("Une erreur est survenue.")}}e.addEventListener("input",F=>{u=F.target.value,Y()}),n.addEventListener("click",()=>q()),c.addEventListener("click",J),m.addEventListener("click",J),f.addEventListener("submit",le),g.addEventListener("click",()=>ne()),w&&ve()}const ca=Object.freeze(Object.defineProperty({__proto__:null,default:da},Symbol.toStringTag,{value:"Module"})),He=ln();let pt,St,Bt,ct,be,ft,Mt,Nt,ut,Xe,gt,Dt,Tt,$t,jt,Et=null,wt=null;function At(){pt&&pt.classList.remove("hidden")}function lt(){pt&&pt.classList.add("hidden"),ct&&ct.reset()}function hn(e,t){wt=e,Xe&&(Xe.value=t),ft&&ft.classList.remove("hidden"),Xe&&Xe.focus()}function dt(){wt=null,ft&&ft.classList.add("hidden"),ut&&ut.reset()}function vn(e,t){Et=e,$t&&($t.textContent="Confirmer la suppression"),jt&&(jt.textContent=`√ätes-vous s√ªr de vouloir supprimer le plan "${t}" ? Cette action est irr√©versible.`),gt&&gt.classList.remove("hidden")}function Pt(){Et=null,gt&&gt.classList.add("hidden")}async function ua(e){const t=je();if(t)try{await Pe(z(He,"plans"),{userId:t.uid,name:e,type:"personal",weeks:{},manualItems:[],checkedItems:{},defaultNumPeople:1,startDay:"Lundi",lastUpdated:new Date}),lt()}catch(n){console.error("Error creating plan: ",n),alert("Erreur lors de la cr√©ation du plan.")}}async function ma(e,t){if(!(!e||!t))try{const n=j(He,"plans",e);await _e(n,{name:t}),dt()}catch(n){console.error("Error renaming plan: ",n),alert("Erreur lors du renommage du plan.")}}async function pa(e){const t=je()?.uid;if(!(!e||!t)&&confirm("Voulez-vous vraiment quitter ce plan partag√© ? Il n'appara√Ætra plus dans votre liste."))try{const n=j(He,"plans",e);await _e(n,{collaborators:on(t)})}catch(n){console.error("Erreur pour quitter le plan: ",n),alert("Une erreur est survenue.")}}async function fa(e){if(e)try{await Re(j(He,"plans",e))}catch(t){console.error("Error deleting plan: ",t),alert("Erreur lors de la suppression du plan.")}}function Ft(e){const t=je();if(!t)return()=>{};let n=new Map;const a=()=>{e(Array.from(n.values()).sort((p,x)=>p.name.localeCompare(x.name)))},r=async p=>{const L=[p.userId,...p.collaborators||[]].map(C=>Me(j(He,"users",C)));return(await Promise.all(L)).map(C=>C.exists()?C.data():{uid:C.id,displayName:"Inconnu"})},i=Ee(z(He,"plans"),re("userId","==",t.uid)),c=Fe(i,async p=>{const L=p.docChanges().map(async g=>{if(g.type==="removed")n.delete(g.doc.id);else{const C=g.doc.data(),M=await r(C);n.set(g.doc.id,{id:g.doc.id,...C,isOwner:!0,participants:M})}});await Promise.all(L),a()}),m=Ee(z(He,"plans"),re("collaborators","array-contains",t.uid)),f=Fe(m,async p=>{const L=p.docChanges().map(async g=>{if(g.type==="removed")n.delete(g.doc.id);else{const C=g.doc.data(),M=await r(C),u=M.find(P=>P.uid===C.userId);n.set(g.doc.id,{id:g.doc.id,...C,isOwner:!1,ownerName:u?.displayName||"Inconnu",participants:M})}});await Promise.all(L),a()});return()=>{c(),f()}}function bn(e){if(!be)return;const t=be.value;if(be.innerHTML="",e.length===0){const n=document.createElement("option");n.value="",n.textContent="Aucun plan personnel",n.disabled=!0,be.appendChild(n);return}e.forEach(n=>{const a=document.createElement("option");a.value=n.id;let r=n.name;n.collaborators&&n.collaborators.length>0&&(n.isOwner?r=`üëë ${n.name} [Collab]`:r=`üë• ${n.name} [Collab] (de ${n.ownerName})`),a.textContent=r,be.appendChild(a)}),t&&be.querySelector(`option[value="${t}"]`)?be.value=t:be.selectedIndex=0}function yn(){pt=document.getElementById("create-plan-modal"),St=document.getElementById("close-create-plan-modal"),Bt=document.getElementById("cancel-create-plan-btn"),ct=document.getElementById("create-plan-form"),be=document.getElementById("plan-select"),ft=document.getElementById("rename-plan-modal"),Mt=document.getElementById("close-rename-plan-modal"),Nt=document.getElementById("cancel-rename-plan-btn"),ut=document.getElementById("rename-plan-form"),Xe=document.getElementById("new-plan-name"),gt=document.getElementById("delete-confirm-modal"),Dt=document.getElementById("cancel-delete-btn"),Tt=document.getElementById("confirm-delete-btn"),$t=document.getElementById("delete-confirm-title"),jt=document.getElementById("delete-confirm-message");const e=document.getElementById("create-plan-btn"),t=document.getElementById("rename-plan-btn"),n=document.getElementById("leave-plan-btn"),a=document.getElementById("delete-plan-btn"),r=x=>{x.preventDefault();const L=document.getElementById("plan-name");L&&L.value&&ua(L.value)},i=x=>{x.preventDefault(),wt&&Xe.value&&ma(wt,Xe.value)},c=()=>{Et&&fa(Et).then(()=>{Pt()})},m=()=>{if(be&&be.value){const x=be.options[be.selectedIndex];hn(be.value,x.text)}else alert("Veuillez s√©lectionner un plan √† renommer.")},f=()=>{be&&be.value?pa(be.value):alert("Veuillez s√©lectionner un plan.")},p=()=>{if(be&&be.value){const x=be.options[be.selectedIndex].text;vn(be.value,x)}else alert("Veuillez s√©lectionner un plan √† supprimer.")};return e?.addEventListener("click",At),t?.addEventListener("click",m),n?.addEventListener("click",f),a?.addEventListener("click",p),St?.addEventListener("click",lt),Bt?.addEventListener("click",lt),ct?.addEventListener("submit",r),Mt?.addEventListener("click",dt),Nt?.addEventListener("click",dt),ut?.addEventListener("submit",i),Dt?.addEventListener("click",Pt),Tt?.addEventListener("click",c),()=>{e?.removeEventListener("click",At),t?.removeEventListener("click",m),n?.removeEventListener("click",f),a?.removeEventListener("click",p),St?.removeEventListener("click",lt),Bt?.removeEventListener("click",lt),ct?.removeEventListener("submit",r),Mt?.removeEventListener("click",dt),Nt?.removeEventListener("click",dt),ut?.removeEventListener("submit",i),Dt?.removeEventListener("click",Pt),Tt?.removeEventListener("click",c)}}async function xn(e,t){if(!(!e||!t))try{const n=j(He,"plans",e);await _e(n,{collaborators:An(t),type:"collaborative"})}catch(n){console.error("Error adding collaborator: ",n)}}async function Ht(e,t,n="Modification diverse"){if(!e||!t)return;const a=je();if(a)try{const r=z(He,"plans",e,"history"),i=JSON.parse(JSON.stringify(t));await Pe(r,{planState:i,timestamp:yt(),modifiedBy:a.uid,modifiedByName:a.displayName||a.email,description:n})}catch(r){console.error("Error saving history:",r)}}async function En(e,t){const n=je();if(!(!n||!e||!t))try{const a=z(He,"plan_saves"),r=Ee(a,re("userId","==",n.uid),re("name","==",e)),i=await ye(r);if(i.empty)await Pe(a,{userId:n.uid,name:e,savedAt:yt(),planData:t});else{const c=i.docs[0].id,m=j(He,"plan_saves",c);await _e(m,{planData:t,savedAt:yt()})}}catch(a){console.error("Error saving or updating plan save:",a),alert("Erreur lors de la sauvegarde.")}}async function ga(e,t,n){if(!e||!t||!n)return;const a=j(He,"plans",e);try{await _e(a,{[`weeks.${t}`]:n,lastUpdated:new Date}),console.log(`Week ${t} of plan ${e} saved successfully.`)}catch(r){console.error("Error saving plan week:",r),alert("Erreur lors de la sauvegarde du plan.")}}const ha=Object.freeze(Object.defineProperty({__proto__:null,addCollaborator:xn,getUserPlans:Ft,initPlanManagement:yn,openCreatePlanModal:At,openDeleteConfirmModal:vn,openRenamePlanModal:hn,populatePlanSelector:bn,saveHistory:Ht,saveOrUpdatePlanSaveByName:En,savePlanWeek:ga},Symbol.toStringTag,{value:"Module"}));let wn=[],Ln=[],Cn=()=>{},In=()=>{};const X={btn:null,btnMobile:null,badge:null,badgeMobile:null,dropdown:null,list:null};async function va(e,t,n){const a=Se();if(a)try{const r=j(w,"shares",e);if(await _e(r,{status:"accepted"}),t.plan){const i=n.displayName||"Inconnu",c=`Copie de "${t.plan.name}" (de ${i})`,m={...t.plan,userId:a,name:c,isShared:!0,originalOwnerId:t.senderId,sharedAt:new Date,collaborators:[]};delete m.id,await Pe(z(w,"plans"),m)}t.shoppingList&&await Pe(z(w,"shopping_lists"),{name:`${t.shoppingList.name} (de ${n.displayName})`,ingredients:t.shoppingList.ingredients,userId:a,isShared:!0,originalOwner:n.uid,sharedAt:new Date})}catch(r){console.error("Erreur lors de l'acceptation du partage : ",r),alert("Une erreur est survenue.")}}async function ba(e,t){const n=Se();if(!(!n||!t||!t.planId))try{await xn(t.planId,n);const a=j(w,"shares",e);await _e(a,{status:"accepted"})}catch(a){console.error("Erreur lors de l'acceptation de l'invitation : ",a),alert("Une erreur est survenue.")}}async function en(e){try{const t=j(w,"shares",e);await _e(t,{status:"declined"})}catch(t){console.error("Erreur lors du refus du partage : ",t),alert("Une erreur est survenue.")}}async function ya(e){try{await mn(e)}catch{alert("Erreur lors de l'acceptation.")}}async function xa(e){try{await pn(e)}catch{alert("Erreur lors du refus.")}}function kn(){if(!X.list)return;const e=[...wn,...Ln];e.sort((n,a)=>a.createdAt.toMillis()-n.createdAt.toMillis());const t=n=>{n&&(e.length>0?(n.textContent=e.length,n.classList.remove("hidden")):n.classList.add("hidden"))};t(X.badge),t(X.badgeMobile),X.list.innerHTML="",e.length===0?X.list.innerHTML='<p class="text-gray-500 text-center p-4">Aucune nouvelle notification.</p>':e.forEach(n=>{const a=Ea(n);X.list.appendChild(a)})}function Ea(e){const t=document.createElement("div");t.className="p-3 border-b border-gray-100 hover:bg-gray-50";const n=document.createElement("p");n.className="text-sm font-medium text-gray-800";const a=document.createElement("p");a.className="text-xs text-gray-500 mb-3";const r=document.createElement("div");r.className="flex space-x-2 justify-end";const i=e.data.type||e.type;if(i==="collaborative_plan_invite"){n.textContent="Invitation √† collaborer",a.textContent=`${e.sender.displayName} vous invite √† modifier son plan "${e.data.planName}".`;const c=nt("Accepter","btn-secondary",f=>{f.target.textContent="...",f.target.disabled=!0,ba(e.id,e.data)}),m=nt("Refuser","btn-ghost text-red-500",f=>{f.target.disabled=!0,en(e.id)});r.append(c,m)}else if(i==="share"){n.textContent=`Partage de ${e.sender.displayName||e.sender.email}`;let c=[];e.data.plan&&c.push("planification"),e.data.shoppingList&&c.push("liste de courses"),a.textContent=`Contenu : ${c.join(" et ")}`;const m=nt("Accepter","btn-secondary",p=>{p.target.textContent="...",p.target.disabled=!0,va(e.id,e.data,e.sender)}),f=nt("Refuser","btn-ghost text-red-500",p=>{p.target.disabled=!0,en(e.id)});r.append(m,f)}else if(i==="friend_request"){n.textContent="Invitation d'ami",a.textContent=`${e.sender.displayName||e.sender.email} vous a envoy√© une invitation.`;const c=nt("Accepter","btn-secondary",f=>{f.target.textContent="...",f.target.disabled=!0,ya(e.id)}),m=nt("Refuser","btn-ghost text-red-500",f=>{f.target.disabled=!0,xa(e.id)});r.append(c,m)}return t.append(n,a,r),t}function nt(e,t,n){const a=document.createElement("button");return a.className=`btn btn-xs ${t}`,a.textContent=e,a.addEventListener("click",r=>{r.stopPropagation(),n(r)}),a}function wa(e){const t=z(w,"shares"),n=Ee(t,re("receiverId","==",e),re("status","==","pending"));Cn=Fe(n,async a=>{const r=[];for(const i of a.docs){const c=i.data(),m=await Me(j(w,"users",c.senderId));m.exists()&&r.push({type:c.type||"share",id:i.id,data:c,sender:m.data(),createdAt:c.createdAt})}wn=r,kn()},a=>{console.error("Erreur d'√©coute des partages:",a)})}function La(e){const t=z(w,"friend_requests"),n=Ee(t,re("receiverId","==",e),re("status","==","pending"));In=Fe(n,async a=>{const r=[];for(const i of a.docs){const c=i.data(),m=await Me(j(w,"users",c.senderId));m.exists()&&r.push({type:"friend_request",id:i.id,data:c,sender:m.data(),createdAt:c.createdAt})}Ln=r,kn()},a=>{console.error("Erreur d'√©coute des invitations d'amis:",a)})}function Sn(){if(X.btn=document.getElementById("notifications-btn"),X.btnMobile=document.getElementById("notifications-btn-mobile"),X.badge=document.getElementById("notifications-badge"),X.badgeMobile=document.getElementById("notifications-badge-mobile"),X.dropdown=document.getElementById("notifications-dropdown"),X.list=document.getElementById("notifications-list"),!X.btn||!X.dropdown)return;const e=Se();if(!e)return;Cn(),In(),wa(e),La(e);const t=n=>{if(n.stopPropagation(),!X.dropdown.classList.toggle("hidden")){const r=window.innerWidth<768,i=r?X.btnMobile:X.btn;if(!i)return;const c=i.getBoundingClientRect();X.dropdown.style.position="fixed",r?(X.dropdown.style.top=`${c.bottom+8}px`,X.dropdown.style.left="50%",X.dropdown.style.transform="translateX(-50%)",X.dropdown.style.width="95vw",X.dropdown.style.right="auto"):(X.dropdown.style.top=`${c.bottom+8}px`,X.dropdown.style.left="auto",X.dropdown.style.right=`${window.innerWidth-c.right}px`,X.dropdown.style.transform="none",X.dropdown.style.width="20rem")}};X.btn.addEventListener("click",t),X.btnMobile&&X.btnMobile.addEventListener("click",t),document.addEventListener("click",n=>{X.dropdown&&!X.dropdown.classList.contains("hidden")&&(X.btn.contains(n.target)||X.btnMobile&&X.btnMobile.contains(n.target)||X.dropdown.contains(n.target)||X.dropdown.classList.add("hidden"))})}const Ca=Object.freeze(Object.defineProperty({__proto__:null,initNotifications:Sn},Symbol.toStringTag,{value:"Module"}));let Qe=null,it=null;function Bn(e,t){if(!kt||!e)return;const n=je();if(!n)return;const a=Kt(kt,`plans_presence/${e}`);Qe=Kt(kt,`plans_presence/${e}/${n.uid}`);const r={displayName:n.displayName||n.email,photoURL:n.photoURL,status:"idle",last_seen:dn()};Hn(Qe).remove(),Rn(Qe,r),it&&it(),it=qn(a,i=>{const c=i.val()||{};typeof t=="function"&&t(c)})}function Mn(){Qe&&(Un(Qe),Qe=null),it&&(it(),it=null)}function bt(e){Qe&&Fn(Qe,{status:e,last_seen:dn()})}const Ia=Object.freeze(Object.defineProperty({__proto__:null,connectToPresenceChannel:Bn,disconnectFromPresenceChannel:Mn,updateUserActivity:bt},Symbol.toStringTag,{value:"Module"}));let at=null;async function Ot(e,t){if(!e)return;const n=j(w,"recipes",e);try{await _e(n,{isFavorite:!t})}catch(a){console.error("Error toggling favorite status:",a)}}function ka(){const e=document.getElementById("search-bar"),t=document.getElementById("category-tabs"),n=document.getElementById("recipe-list-container"),a=document.getElementById("add-recipe-btn");at&&at.destroy(),at=new qt(w,"edit-recipe-form-modal","edit-recipe-form","edit-recipe-modal-title","edit-recipe-id","edit-recipe-name","edit-recipe-category","edit-recipe-servings","edit-recipe-prep-time","edit-recipe-difficulty","edit-recipe-steps","edit-ingredients-list","edit-add-ingredient-btn","edit-save-recipe-btn","close-edit-recipe-modal","edit-cancel-recipe-btn"),at.setOnSaveCallback(()=>{});let r=[],i="",c="",m=null;const f=["Entr√©e","Plat","Accompagnement","Dessert"],p={PLAT:"bg-orange-100",DESSERT:"bg-amber-100",ENTREE:"bg-lime-100",ACCOMPAGNEMENT:"bg-stone-200","PETIT-DEJEUNER":"bg-orange-100",BOISSON:"bg-cyan-100",SAUCE:"bg-red-100"},x={PLAT:"text-orange-800",DESSERT:"text-amber-800",ENTREE:"text-lime-800",ACCOMPAGNEMENT:"text-stone-800","PETIT-DEJEUNER":"text-orange-800",BOISSON:"text-cyan-800",SAUCE:"text-red-800"},L="bg-gray-100",g="text-gray-800";function C(){return w?Fe(z(w,"recipes"),$=>{console.log("Recipe data updated on /recipes page from listener."),r=$.docs.map(D=>({id:D.id,...D.data()})),u(),P()},$=>{console.error("Erreur lors de l'√©coute des recettes: ",$)}):()=>{}}function M(_){i=_,u(),P()}function u(){if(!t)return;t.innerHTML="";const $=[...new Set(r.map(D=>D.category||"Non class√©"))].sort((D,q)=>{const J=Y=>{const ie=Y.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();for(let ae=0;ae<f.length;ae++)if(f[ae].normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()===ie)return ae;return-1},le=J(D),ne=J(q);return le>-1&&ne>-1?le-ne:le>-1?-1:ne>-1?1:D.localeCompare(q)});!i&&$.length>0&&(i=$[0]),$.forEach(D=>{const q=document.createElement("button"),J=D.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toUpperCase();if(D===i){const ne=p[J]||L,Y=x[J]||g;q.className=`px-4 py-2 text-sm font-bold rounded-t-lg ${ne} ${Y}`}else q.className="px-4 py-2 text-sm font-medium text-gray-500 hover:text-tomato";q.textContent=D,q.addEventListener("click",()=>M(D)),t.appendChild(q)})}function P(){if(!n)return;n.innerHTML="";let _=r.filter(D=>(D.category||"Non class√©")===i);if(c){const D=c.toLowerCase();_=_.filter(q=>q.name.toLowerCase().includes(D))}if(_.sort((D,q)=>D.name.localeCompare(q.name)),_.length===0){n.innerHTML='<p class="text-gray-500 text-center p-10">Aucune recette trouv√©e.</p>';return}const $=document.createElement("div");$.className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4",_.forEach(D=>{$.appendChild(Q(D))}),n.appendChild($)}function Q(_){const $=document.createElement("div");if($.className="bg-white dark:bg-gray-800 shadow-md rounded-lg flex flex-col p-3",_.imageUrl){const xe=document.createElement("img");xe.src=_.imageUrl,xe.alt=_.name,xe.className="w-full h-24 object-cover rounded-md mb-2",$.appendChild(xe)}const D=document.createElement("div");D.className="w-full flex justify-between items-start";const q=document.createElement("h4");q.className="font-bold text-gray-800 dark:text-gray-200 pr-2",q.textContent=_.name,q.title=_.name,D.appendChild(q);const J=document.createElement("button");J.className="text-lg flex-shrink-0",J.innerHTML='<i class="fas fa-heart"></i>',_.isFavorite?J.classList.add("text-red-500"):J.classList.add("text-gray-300","dark:text-gray-500","hover:text-red-400"),J.addEventListener("click",xe=>{xe.stopPropagation(),Ot(_.id,_.isFavorite)}),D.appendChild(J),$.appendChild(D);const le=document.createElement("p");le.className="text-sm text-gray-600 dark:text-gray-400 mt-1 w-full",le.textContent=`${_.difficulty||""} - Pour ${_.servings||"?"} pers.`,$.appendChild(le);const ne=document.createElement("div");ne.className="flex-grow",$.appendChild(ne);const Y=document.createElement("div");Y.className="w-full flex justify-end items-center space-x-2 border-t dark:border-gray-700 pt-2 mt-2";const ie=document.createElement("button");ie.className="btn btn-ghost btn-sm text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/50",ie.innerHTML='<i class="fas fa-edit"></i>',ie.title="Modifier",ie.addEventListener("click",()=>at.openForm(_,"Modifier la recette")),Y.appendChild(ie);const ae=document.createElement("button");return ae.className="btn btn-ghost btn-sm text-red-500 hover:bg-red-50 dark:hover:bg-red-900/50",ae.innerHTML='<i class="fas fa-trash-alt"></i>',ae.title="Supprimer",ae.addEventListener("click",()=>ve(_.id,_.name)),Y.appendChild(ae),$.appendChild(Y),$}async function ve(_,$){if(confirm(`√ätes-vous s√ªr de vouloir supprimer la recette "${$}" ?`))try{await Re(j(w,"recipes",_)),fetchAllRecipes()}catch(D){console.error("Erreur lors de la suppression: ",D)}}if(a.addEventListener("click",()=>at.openForm(null,"Ajouter une recette")),e.addEventListener("input",_=>{const $=_.target.value;if(!c&&$&&(m=i),c=$,c){const D=c.toLowerCase(),q=r.find(J=>J.name.toLowerCase().includes(D));q&&(i=q.category||"Non class√©")}else m&&(i=m,m=null);u(),P()}),w)return C()}const Sa=Object.freeze(Object.defineProperty({__proto__:null,default:ka,toggleFavoriteStatus:Ot},Symbol.toStringTag,{value:"Module"}));let Ve=null;function Ba(){const e={mealPlanGrid:document.getElementById("meal-plan-grid"),currentWeekDisplay:document.getElementById("current-week-display"),prevWeekBtn:document.getElementById("prev-week-btn"),nextWeekBtn:document.getElementById("next-week-btn"),clearMenuBtn:document.getElementById("clear-menu-btn"),shoppingListContainer:document.getElementById("shopping-list"),startDaySelect:document.getElementById("start-day-select"),defaultServingsControl:document.getElementById("default-servings-control"),mealSelectModal:document.getElementById("meal-select-modal"),closeMealSelectModalBtn:document.getElementById("close-meal-select-modal"),mealSelectModalTitle:document.getElementById("meal-select-modal-title"),mealSelectList:document.getElementById("meal-select-list"),recipeFormModal:document.getElementById("edit-recipe-form-modal"),closeRecipeModalBtn:document.getElementById("close-edit-recipe-modal"),cancelRecipeBtn:document.getElementById("edit-cancel-recipe-btn"),recipeForm:document.getElementById("edit-recipe-form"),addItemInput:document.getElementById("add-item-input"),addItemBtn:document.getElementById("add-item-btn"),addItemResults:document.getElementById("add-item-results"),importListBtn:document.getElementById("import-list-btn"),importListModal:document.getElementById("import-list-modal"),closeImportListModalBtn:document.getElementById("close-import-list-modal"),importListContainer:document.getElementById("import-list-container"),exportTxtBtn:document.getElementById("export-txt-btn"),exportPdfBtn:document.getElementById("export-pdf-btn"),exportPlanPdfBtn:document.getElementById("export-plan-pdf-btn"),sharePlanBtn:document.getElementById("share-plan-btn"),planSelect:document.getElementById("plan-select"),inviteParticipantBtn:document.getElementById("invite-participant-btn"),historyPlanBtn:document.getElementById("history-plan-btn"),planHistoryModal:document.getElementById("plan-history-modal"),closePlanHistoryModalBtn:document.getElementById("close-plan-history-modal"),planHistoryList:document.getElementById("plan-history-list"),savePlanBtn:document.getElementById("save-plan-btn")};function t(s,l){const d=document.createElement("div");d.className="flex items-center space-x-2";const b=document.createElement("button");b.className="btn btn-outline btn-xs",b.textContent="-";const o=document.createElement("span");o.className="font-medium text-center w-6",o.textContent=s;const h=document.createElement("button");return h.className="btn btn-outline btn-xs",h.textContent="+",b.addEventListener("click",()=>{let y=parseInt(o.textContent,10);y>1&&(y--,o.textContent=y,l(y))}),h.addEventListener("click",()=>{let y=parseInt(o.textContent,10);y++,o.textContent=y,l(y)}),d.appendChild(b),d.appendChild(o),d.appendChild(h),d}function n(s,l,d,b=!1){const o=document.createElement("div");o.className="flex flex-col items-center justify-center h-full";const h=document.createElement("button");h.className="btn btn-ghost btn-xs p-0 h-4 flex items-center justify-center w-full",h.innerHTML='<i class="fas fa-plus"></i>',h.disabled=b;const y=document.createElement("span");y.className="font-medium text-center text-sm my-1",y.textContent=s;const E=document.createElement("button");return E.className="btn btn-ghost btn-xs p-0 h-4 flex items-center justify-center w-full",E.innerHTML='<i class="fas fa-minus"></i>',E.disabled=b,l&&(h.classList.add("text-white"),y.classList.add("text-white"),E.classList.add("text-white")),b||(h.addEventListener("click",()=>{let v=parseInt(y.textContent,10);v++,y.textContent=v,d(v)}),E.addEventListener("click",()=>{let v=parseInt(y.textContent,10);v>1&&(v--,y.textContent=v,d(v))})),o.appendChild(h),o.appendChild(y),o.appendChild(E),o}Ve&&Ve.destroy(),Ve=new qt(w,"edit-recipe-form-modal","edit-recipe-form","edit-recipe-modal-title","edit-recipe-id","edit-recipe-name","edit-recipe-category","edit-recipe-servings","edit-recipe-prep-time","edit-recipe-difficulty","edit-recipe-steps","edit-ingredients-list","edit-add-ingredient-btn","edit-save-recipe-btn","close-edit-recipe-modal","edit-cancel-recipe-btn"),Ve.setActivityUpdater(bt),Ve.setOnSaveCallback(async()=>{});let a=1,r="Lundi",i={},c={},m={};const f=[];let p=null,x=[],L=[],g=1,C=null,M=[],u=null;const P=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];function Q(s){return s?s.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase():""}async function ve(s){const l=document.getElementById("unit-select-modal"),d=document.getElementById("unit-modal-title"),b=document.getElementById("unit-modal-list"),o=document.getElementById("unit-modal-cancel");return d.textContent=`Choisir une unit√© pour "${s}"`,b.innerHTML="",new Promise((h,y)=>{const E=["g","kg","ml","l","pi√®ce(s)","c.√†.s.","c.√†.c.","pinc√©e(s)"],v=I=>{l.classList.add("hidden"),h(I)};E.forEach(I=>{const B=document.createElement("button");B.className="btn btn-outline",B.textContent=I,B.addEventListener("click",()=>v(I)),b.appendChild(B)});const S=()=>{l.classList.add("hidden"),y()};o.addEventListener("click",S,{once:!0}),l.addEventListener("click",I=>{I.target===l&&S()},{once:!0}),l.classList.remove("hidden")})}async function _(){if(w)try{L=(await ye(z(w,"ingredients"))).docs.map(l=>({id:l.id,...l.data()})),L.sort((l,d)=>l.name.localeCompare(d.name))}catch(s){console.error("Erreur lors de la r√©cup√©ration des ingr√©dients: ",s)}}function $(){if(!u)i={},c={},m={},g=1,r="Lundi";else{const s=u.weeks?u.weeks[a]||{}:{};i=s.menuData||{},c=s.servingsData||{},m=s.remarksData||{},g=u.defaultNumPeople||1,r=u.startDay||"Lundi"}if(e.startDaySelect&&(e.startDaySelect.value=r),e.defaultServingsControl){e.defaultServingsControl.innerHTML="";const s=t(g,async l=>{g=l,u&&await D({defaultNumPeople:l},`a chang√© le nombre de personnes par d√©faut √† ${l}`)});e.defaultServingsControl.appendChild(s)}Dn(),ie(e.mealPlanGrid,{menuData:i,servingsData:c,remarksData:m,defaultNumPeople:g,startDay:r},!1),Y(document.getElementById("mobile-meal-plan"),{menuData:i,servingsData:c,remarksData:m,defaultNumPeople:g,startDay:r},!1),K()}async function D(s,l){if(!u)return;await Ht(u.id,u,l);const d=j(w,"plans",u.id);try{await _e(d,{...s,lastUpdated:new Date})}catch(b){console.error("Error updating plan:",b),alert("Une erreur de sauvegarde est survenue.")}}function q(){e.planHistoryModal.classList.add("hidden")}async function J(s){if(u&&confirm("Voulez-vous vraiment restaurer cette version ? L'√©tat actuel sera sauvegard√© dans l'historique avant la restauration."))try{const l=j(w,"plans",u.id,"history",s),d=await Me(l);if(!d.exists())throw new Error("Version de l'historique non trouv√©e.");const b=d.data().planState;await Ht(u.id,u);const o=j(w,"plans",u.id);await mt(o,b),q()}catch(l){console.error("Erreur lors du rollback :",l)}}async function le(s,l){if(u&&confirm("√ätes-vous s√ªr de vouloir supprimer d√©finitivement cette entr√©e de l'historique ?"))try{const d=j(w,"plans",u.id,"history",s);await Re(d),l.remove()}catch(d){console.error("Erreur lors de la suppression de l'historique :",d),alert("Une erreur est survenue lors de la suppression.")}}async function ne(){if(u){e.planHistoryList.innerHTML="<p>Chargement de l'historique...</p>",e.planHistoryModal.classList.remove("hidden");try{const s=z(w,"plans",u.id,"history"),l=Ee(s,On("timestamp","desc")),d=await ye(l);if(e.planHistoryList.innerHTML="",d.empty){e.planHistoryList.innerHTML="<p>Aucun historique pour ce plan.</p>";return}d.forEach(b=>{const o=b.data(),h=document.createElement("div");h.className="p-3 border-b flex justify-between items-center";const y=document.createElement("div"),E=o.timestamp?.toDate().toLocaleString("fr-FR")||"Date inconnue",v=o.description||"Modification diverse",S=o.modifiedByName||"Inconnu";y.innerHTML=`
                    <p class="font-medium">${S} ${v}</p>
                    <p class="text-sm text-gray-500">${E}</p>
                `;const I=document.createElement("div");I.className="flex items-center space-x-2";const B=document.createElement("button");B.className="btn btn-secondary btn-sm",B.textContent="Revenir √† cette version",B.addEventListener("click",()=>J(b.id));const H=document.createElement("button");H.className="btn btn-ghost text-red-500 hover:bg-red-100 btn-sm",H.innerHTML='<i class="fas fa-times"></i>',H.title="Supprimer cette version",H.addEventListener("click",R=>{R.stopPropagation(),le(b.id,h)}),I.appendChild(B),I.appendChild(H),h.appendChild(y),h.appendChild(I),e.planHistoryList.appendChild(h)})}catch(s){console.error("Erreur de chargement de l'historique:",s),e.planHistoryList.innerHTML=`<p class="text-red-500">Impossible de charger l'historique.</p>`}}}function Y(s,l,d=!1){if(!s)return;const b=l.menuData||{},o=l.servingsData||{},h=l.remarksData||{},y=l.defaultNumPeople||1,E=l.startDay||"Lundi";s.innerHTML="";const v=document.createDocumentFragment(),S=P.indexOf(E);[...P.slice(S),...P.slice(0,S)].forEach(B=>{const H=P.indexOf(B),R=document.createElement("div");R.className="bg-blue-100 border border-blue-300 rounded-xl shadow-md p-4 mb-4";const te=document.createElement("h3");te.className="text-xl font-bold text-gray-800 mb-3",te.textContent=B.toUpperCase(),R.appendChild(te);const ce=document.createElement("div");ce.className="space-y-4",["lunch","dinner"].forEach(fe=>{const ge=document.createElement("div");ge.className=`border-t pt-3 ${fe==="lunch"?"bg-amber-50":"bg-stone-100"} rounded-lg p-2`;const Ne=document.createElement("div");Ne.className="flex justify-between items-center mb-2";const me=document.createElement("h4");if(me.className="text-lg font-semibold text-tomato",me.textContent=fe==="lunch"?"Midi":"Soir",Ne.appendChild(me),!d){const se=`${H}-${fe}`,Ie=o[se]||y,de=t(Ie,he=>{Wt(se,he)});Ne.appendChild(de)}ge.appendChild(Ne);const Be=document.createElement("div");Be.className="space-y-2";let Le=!1;const De=["Entr√©e","Plat","Accompagnement","Dessert","Remarque"];for(let se=0;se<De.length;se++){const Ie=De[se],de=`${H}-${fe}-${se}`,he=b[de],Ce=document.createElement("div");Ce.className="mb-2";const tt=document.createElement("h5");if(tt.className="text-md font-semibold text-gray-700 mb-1",tt.textContent=Ie,Ce.appendChild(tt),Ie==="Remarque")Ce.appendChild(Je(de,h,d));else{const Ae=document.createElement("div");if(Ae.className="space-y-1",Array.isArray(he)&&he.length>0&&(Le=!0,he.forEach(($e,Ge)=>{const Oe=x.find(ke=>ke.id===$e.id);if(Oe){const ke=oe(Oe,de,Ge,d);if(ke.classList.remove("bg-white","shadow-sm"),ke.classList.add("bg-emerald-200","border","border-emerald-400"),!d){const ze=ke.querySelector(".edit-meal-btn"),Jt=ke.querySelector(".delete-meal-btn");ze&&ze.classList.remove("hidden"),Jt&&Jt.classList.remove("hidden")}Ae.appendChild(ke)}})),d)Le||(Ae.innerHTML='<p class="text-sm text-gray-500 italic">Aucun plat pr√©vu.</p>');else{const $e=document.createElement("button");$e.className="btn btn-outline btn-sm w-full mt-2",$e.innerHTML=`<i class="fas fa-plus mr-2"></i> Ajouter une ${Ie.toLowerCase()}`,$e.addEventListener("click",()=>{ue(de)}),Ae.appendChild($e)}Ce.appendChild(Ae)}Be.appendChild(Ce)}ge.appendChild(Be),ce.appendChild(ge)}),R.appendChild(ce),v.appendChild(R)}),s.appendChild(v)}function ie(s,l,d=!1){if(!s)return;const b=l.menuData||{},o=l.servingsData||{},h=l.remarksData||{},y=l.defaultNumPeople||1,E=l.startDay||"Lundi",v=document.createDocumentFragment(),S=["lunch","dinner"],I=5,B=P.indexOf(E);[...P.slice(B),...P.slice(0,B)].forEach(R=>{const te=P.indexOf(R),ce=document.createElement("div");ce.className="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] items-stretch border-b border-gray-300";const fe=document.createElement("div");fe.className="font-bold p-2 flex items-center justify-center bg-gray-100 text-sm border-r border-gray-300",fe.textContent=R.toUpperCase(),ce.appendChild(fe),S.forEach(ge=>{const Ne=`${te}-${ge}`,me=o[Ne]||y,Be=o.hasOwnProperty(Ne),Le=document.createElement("div"),De=n(me,Be,Ie=>{Wt(Ne,Ie)},d);let se="border-r border-gray-300 flex items-center justify-center transition-colors duration-300";Be?se+=" bg-tomato":se+=ge==="lunch"?" bg-amber-50":" bg-stone-100",Le.className=se,Le.appendChild(De),ce.appendChild(Le);for(let Ie=0;Ie<I;Ie++){const de=`${te}-${ge}-${Ie}`,he=b[de],Ce=document.createElement("div"),tt=U(de);let Ae="meal-slot p-1 min-h-[70px] flex flex-col justify-start border-r border-gray-300";if(Ae+=ge==="lunch"?" bg-amber-50":" bg-stone-100",Ce.className=Ae,Ce.dataset.slotId=de,tt==="Remarque")Ce.appendChild(Je(de,h,d));else if(Array.isArray(he)&&he.length>0){const $e=document.createElement("div");$e.className="w-full",he.forEach((Ge,Oe)=>{const ke=x.find(ze=>ze.id===Ge.id);if(ke)$e.appendChild(oe(ke,de,Oe,d));else{const ze=document.createElement("div");ze.className="p-1 bg-red-100 text-red-700 rounded shadow-sm text-center text-xs font-medium",ze.textContent="Recette supprim√©e",$e.appendChild(ze)}}),Ce.appendChild($e),d||Ce.appendChild(Ke(de,!0))}else d||Ce.appendChild(Ke(de,!1));ce.appendChild(Ce)}}),v.appendChild(ce)}),s.innerHTML="",s.appendChild(v),d||Ye()}async function ae(){const s=Se();if(!w||!s)return[];try{const l=Ee(z(w,"shopping_lists"),re("userId","==",s));return(await ye(l)).docs.map(h=>({id:h.id,...h.data()})).filter(h=>h.isShared!==!0)}catch(l){return console.error("Erreur de chargement des listes de courses sauvegard√©es: ",l),[]}}async function xe(){const s=await ae();if(e.importListContainer.innerHTML="",s.length===0){e.importListContainer.innerHTML='<p class="text-center text-gray-500">Aucune liste sauvegard√©e.</p>';return}s.forEach(l=>{const d=document.createElement("button");d.className="w-full text-left p-2 hover:bg-gray-100 rounded-lg transition-colors duration-150",d.textContent=l.name,d.addEventListener("click",()=>{confirm(`Voulez-vous vraiment importer les ingr√©dients de la liste "${l.name}" ?`)&&(l.ingredients.forEach(b=>{const o=parseFloat(String(b.quantity).replace(",","."))||0;Z(b.name,o,b.unit)}),qe())}),e.importListContainer.appendChild(d)}),e.importListModal.classList.remove("hidden")}function qe(){e.importListModal.classList.add("hidden")}function F(){e.addItemInput?.addEventListener("input",()=>{const s=e.addItemInput.value.toLowerCase(),l=e.addItemResults;if(l.innerHTML="",!s){l.classList.add("hidden");return}L.filter(o=>o.name.toLowerCase().includes(s)).forEach(o=>{const h=document.createElement("div");h.className="p-2 hover:bg-gray-100 cursor-pointer",h.textContent=o.name,h.addEventListener("click",()=>{Z(o.name,1,o.unit),e.addItemInput.value="",l.classList.add("hidden")}),l.appendChild(h)});const b=document.createElement("div");b.className="p-2 bg-green-50 hover:bg-green-200 cursor-pointer font-bold text-green-700",b.textContent=`+ Cr√©er "${e.addItemInput.value}"`,b.addEventListener("click",async()=>{const o=e.addItemInput.value;try{const h=await ve(o);await Pe(z(w,"ingredients"),{name:o,unit:h}),await _(),Z(o,1,h),e.addItemInput.value="",l.classList.add("hidden")}catch{}}),l.appendChild(b),l.classList.remove("hidden")}),e.addItemBtn?.addEventListener("click",()=>{const s=e.addItemInput.value;s&&(Z(s,1,""),e.addItemInput.value="",e.addItemResults.classList.add("hidden"))}),document.addEventListener("click",s=>{e.addItemInput&&!e.addItemInput.contains(s.target)&&!e.addItemResults.contains(s.target)&&e.addItemResults.classList.add("hidden")})}function k(){if(f.length===0){alert("La liste de courses est vide.");return}const s=f.reduce((o,h)=>{const y=h.category||"Inconnue";return o[y]||(o[y]=[]),o[y].push(h),o},{}),l=Object.keys(s).sort((o,h)=>o==="Inconnue"?1:h==="Inconnue"?-1:o.localeCompare(h));let d=`Liste de courses - GustoPlan

`;l.forEach(o=>{d+=`--- ${o.toUpperCase()} ---
`,s[o].sort((y,E)=>y.name.localeCompare(E.name)).forEach(y=>{let v=`${Number.isInteger(y.totalQuantity)?y.totalQuantity:parseFloat(y.totalQuantity.toFixed(2))} ${y.unit||""} ${y.name}`;if(y.sources&&y.sources.length>0){const S=y.sources.reduce((B,H)=>{const R=`${H.recipeName} (${H.day} ${H.time})`;return B[R]||(B[R]=0),B[R]+=H.quantity,B},{}),I=Object.keys(S).join(" / ");v+=` *** ${I} ***`}d+=v+`
`}),d+=`
`});const b=new Blob([d],{type:"text/plain;charset=utf-8"});saveAs(b,"liste-de-courses.txt")}function W(){if(f.length===0){alert("La liste de courses est vide.");return}const{jsPDF:s}=window.jspdf,l=new s,d=f.reduce((v,S)=>{const I=S.category||"Inconnue";return v[I]||(v[I]=[]),v[I].push(S),v},{}),b=Object.keys(d).sort((v,S)=>v==="Inconnue"?1:S==="Inconnue"?-1:v.localeCompare(S));l.setFontSize(18),l.text("Liste de courses - GustoPlan",14,22);let o=35;const h=l.internal.pageSize.height,y=20,E=()=>{o>h-y&&(l.addPage(),o=20)};b.forEach(v=>{E(),l.setFontSize(14),l.setFont(void 0,"bold"),l.text(`--- ${v.toUpperCase()} ---`,14,o),o+=8,l.setFont(void 0,"normal"),d[v].sort((I,B)=>I.name.localeCompare(B.name)).forEach(I=>{E(),l.setFontSize(12);const B=Number.isInteger(I.totalQuantity)?I.totalQuantity:parseFloat(I.totalQuantity.toFixed(2));if(l.text(`${B} ${I.unit||""} ${I.name}`,14,o),o+=6,I.sources&&I.sources.length>0){const H=I.sources.reduce((R,te)=>{const ce=`${te.recipeName} (${te.day} ${te.time})`;return R[ce]||(R[ce]=0),R[ce]+=te.quantity,R},{});l.setFontSize(9),l.setTextColor(100);for(const R in H)E(),l.text(`  * ${R}`,18,o),o+=5;l.setTextColor(0)}o+=2}),o+=5}),l.save("liste-de-courses.pdf")}async function V(){if(!u){alert("Veuillez s√©lectionner un plan √† exporter.");return}const s=document.getElementById("loading-overlay");s&&s.classList.remove("hidden");try{const{jsPDF:l}=window.jspdf,d=new l,b=j(w,"plans",u.id),o=await Me(b),h=o.exists()?o.data():null;if(!h||!h.weeks){alert("Ce plan est vide et ne peut pas √™tre export√©.");return}d.setFontSize(18),d.text(`Plan de Repas: ${h.name}`,14,20);const y=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"],E={0:"E",1:"P",2:"A",3:"D"},v=Object.keys(h.weeks).sort((I,B)=>parseInt(I)-parseInt(B));let S=!0;for(const I of v){const H=h.weeks[I].menuData||{};if(Object.keys(H).length===0)continue;const R=[["Jour","Midi","Soir"]],te=[],ce=y.indexOf(h.startDay||"Lundi"),fe=[...y.slice(ce),...y.slice(0,ce)];for(const Ne of fe){const me=y.indexOf(Ne);let Be=[],Le=[];for(const De of["lunch","dinner"])for(const se in E){const Ie=`${me}-${De}-${se}`;H[Ie]&&Array.isArray(H[Ie])&&H[Ie].forEach(de=>{const he=`[${E[se]}] ${de.name}`;De==="lunch"?Be.push(he):Le.push(he)})}te.push([Ne,Be.join(`
`)||"-",Le.join(`
`)||"-"])}d.setFontSize(14);const ge=S?30:d.autoTable.previous.finalY+20;d.text(`Semaine ${I}`,14,ge-5),d.autoTable({startY:ge,head:R,body:te,theme:"grid",styles:{cellPadding:2,fontSize:8,valign:"middle"},headStyles:{fillColor:[41,128,185],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[245,245,245]}}),S=!1}d.save(`plan_${h.name.replace(/ /g,"_")}.pdf`)}catch(l){console.error("Erreur lors de la g√©n√©ration du PDF du plan :",l),alert("Une erreur est survenue lors de la cr√©ation du PDF.")}finally{s&&s.classList.add("hidden")}}async function Z(s,l,d,b=!1){if(!u)return alert("Veuillez s√©lectionner un plan.");const o=j(w,"plans",u.id);try{await zn(w,async h=>{const y=await h.get(o);if(!y.exists())throw"Le plan n'existe plus.";const E=y.data().manualItems||[],v=`${s.trim().toLowerCase()}_${d||""}`,S=E.findIndex(B=>`${B.name.trim().toLowerCase()}_${B.unit||""}`===v);if(S>-1)E[S].totalQuantity+=l;else{const B=L.find(H=>H.name.toLowerCase()===s.trim().toLowerCase());E.push({name:s.trim(),totalQuantity:l,unit:d,source:"manual",category:B?.category||"Inconnue"})}const I=E.filter(B=>B.totalQuantity!==0);h.update(o,{manualItems:I,lastUpdated:new Date})})}catch(h){console.error("Erreur transactionnelle lors de l'ajustement de l'ingr√©dient: ",h),alert("Une erreur de synchronisation est survenue. Veuillez r√©essayer.")}}function ee(s){const l=s?s.toLowerCase():"";return l.includes("g")||l.includes("ml")?10:1}function we(){const s=e.shoppingListContainer;if(!s)return;if(s.innerHTML="",f.length===0){s.innerHTML='<p class="text-center text-gray-500 italic py-4">Votre liste de courses est vide.</p>';return}const l=u?u.checkedItems||{}:{},d=f.reduce((o,h)=>{const y=h.category||"Inconnue";return o[y]||(o[y]=[]),o[y].push(h),o},{});Object.keys(d).sort((o,h)=>o==="Inconnue"?1:h==="Inconnue"?-1:o.localeCompare(h)).forEach(o=>{const h=document.createElement("h4");h.className="text-sm font-bold text-stone-800 bg-stone-200 mt-4 mb-2 px-3 py-1 rounded-md",h.textContent=o,s.appendChild(h);const y=document.createElement("ul");y.className="space-y-2",d[o].sort((v,S)=>v.name.localeCompare(S.name)).forEach(v=>{const S=`${v.name}_${v.unit||""}`,I=l[S],B=document.createElement("li");let H="p-2 rounded";B.className=H+(v.source==="manual"?" bg-lemon":" bg-gray-50");const R=document.createElement("div");R.className="flex justify-between items-center";const te=document.createElement("div");if(te.className="flex-grow flex items-center",I){const se=document.createElement("i");se.className="fas fa-check mr-2 bg-green-500 text-white rounded-full p-1 flex items-center justify-center w-5 h-5",te.appendChild(se)}const ce=document.createElement("span");ce.className="text-sm font-medium transition-all duration-200",I&&ce.classList.add("line-through","text-gray-400"),ce.textContent=v.name,te.appendChild(ce),R.appendChild(te);const fe=document.createElement("div");fe.className="flex items-center space-x-2 mx-2";const ge=document.createElement("span");ge.className="font-medium w-20 text-center text-sm",I&&ge.classList.add("text-gray-400");const Ne=Number.isInteger(v.totalQuantity)?v.totalQuantity:parseFloat(v.totalQuantity.toFixed(2));ge.textContent=`${Ne} ${v.unit||""}`.trim();const me=document.createElement("div");me.className="flex flex-col";const Be=document.createElement("button");Be.className="btn btn-outline btn-xs rounded-b-none",Be.textContent="+",Be.addEventListener("click",async()=>{const se=ee(v.unit);await Z(v.name,se,v.unit)});const Le=document.createElement("button");Le.className="btn btn-outline btn-xs rounded-t-none -mt-px",Le.textContent="-",Le.addEventListener("click",async()=>{const se=ee(v.unit);await Z(v.name,-se,v.unit)}),me.appendChild(Be),me.appendChild(Le),fe.appendChild(ge),fe.appendChild(me),R.appendChild(fe);const De=document.createElement("button");if(De.className="delete-item-btn text-red-500 hover:text-red-700",De.innerHTML='<i class="fas fa-trash-alt"></i>',De.addEventListener("click",()=>{Z(v.name,-v.totalQuantity,v.unit,!0)}),R.appendChild(De),B.appendChild(R),v.sources&&v.sources.length>0){const se=document.createElement("div");se.className="p-2 mt-1 ml-4 rounded-md bg-stone-100";const Ie=v.sources.reduce((de,he)=>{const Ce=`${he.recipeName} (${he.day} ${he.time})`;return de[Ce]||(de[Ce]=0),de[Ce]+=he.quantity,de},{});for(const de in Ie){const he=document.createElement("span");he.className="block text-xs text-gray-500",he.textContent=`‚Ü≥ ${de}`,se.appendChild(he)}B.appendChild(se)}y.appendChild(B)}),s.appendChild(y)})}async function K(){if(!u){f.length=0,we();return}const s=u.manualItems?JSON.parse(JSON.stringify(u.manualItems)):[],l=new Map(s.map(o=>[`${o.name.trim().toLowerCase()}_${o.unit||""}`,o])),d=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];if(u.weeks)for(const o in u.weeks){const h=u.weeks[o],y=h.menuData||{},E=h.servingsData||{};for(const v in y){const S=y[v];if(!Array.isArray(S))continue;const[I,B]=v.split("-"),H=parseInt(I,10),R=d[H]||"Jour inconnu",te=B==="lunch"?"midi":"soir",ce=`${H}-${B}`,fe=parseInt(E[ce]||u.defaultNumPeople,10);for(const ge of S){const me=x.find(Le=>Le.id===ge.id)||ge;if(!me||!Array.isArray(me.ingredients))continue;const Be=me.servings||1;Be<=0||me.ingredients.forEach(Le=>{const{name:De,quantity:se,unit:Ie}=Le;if(!De||!se)return;const de=L.find(ke=>ke.name.toLowerCase()===De.trim().toLowerCase()),he=de?de.category:"Inconnue",Ce=parseFloat(String(se).replace(",","."));if(isNaN(Ce))return;const Ae=Ce/Be*fe,$e=Ie||"",Ge=`${De.trim().toLowerCase()}_${$e}`,Oe={recipeName:me.name,day:`${R} (S${o})`,time:te,quantity:Ae};if(l.has(Ge)){const ke=l.get(Ge);ke.totalQuantity+=Ae,ke.source==="manual"&&(ke.source="mixed"),Array.isArray(ke.sources)?ke.sources.push(Oe):ke.sources=[Oe]}else l.set(Ge,{name:De.trim(),totalQuantity:Ae,unit:$e,source:"plan",category:he,sources:[Oe]})})}}}const b=Array.from(l.values()).filter(o=>o.totalQuantity>0);f.length=0,f.push(...b.sort((o,h)=>o.name.localeCompare(h.name))),we()}function ue(s){const l=U(s);if(!l||!e.mealSelectModal)return;e.mealSelectModalTitle.textContent=`S√©lectionner : ${l}`,e.mealSelectList.innerHTML="";const d=document.createElement("input");d.type="text",d.placeholder="Rechercher dans la cat√©gorie...",d.className="w-full p-2 mb-4 border border-gray-300 rounded-lg",e.mealSelectList.appendChild(d);const b=Q(l),o=x.filter(E=>Q(E.category)===b).sort((E,v)=>{const S=E.isFavorite?1:0,I=v.isFavorite?1:0;return I!==S?I-S:E.name.localeCompare(v.name)}),h=document.createElement("div");h.className="space-y-1 max-h-80 overflow-y-auto",e.mealSelectList.appendChild(h);function y(E=""){h.innerHTML="";const v=E.toLowerCase(),S=o.filter(I=>I.name.toLowerCase().includes(v));S.length===0?h.innerHTML='<p class="text-gray-500 p-4">Aucun plat ne correspond √† votre recherche.</p>':S.forEach(I=>{const B=document.createElement("button");B.className="w-full text-left p-2 hover:bg-gray-100 rounded-lg transition-colors duration-150";const H=document.createElement("p");H.className="font-medium text-gray-800 text-sm",I.isFavorite?H.innerHTML=`${I.name} <i class="fas fa-heart text-red-500 ml-2"></i>`:H.textContent=I.name,B.appendChild(H),B.addEventListener("click",()=>{Ze(s,I),pe()}),h.appendChild(B)})}d.addEventListener("input",E=>y(E.target.value)),y(),e.mealSelectModal.classList.remove("hidden"),d.focus()}function pe(){e.mealSelectModal&&e.mealSelectModal.classList.add("hidden")}function Te(s){p=s.target.closest(".meal-card");const l=p.closest(".meal-slot").dataset.slotId;s.dataTransfer.setData("text/plain",l),setTimeout(()=>{p&&(p.style.opacity="0.5")},0)}function O(){p&&(p.style.opacity="1",p=null)}function A(s){s.preventDefault();const l=s.target.closest(".meal-slot");l&&U(l.dataset.slotId)!=="Remarque"&&l.classList.add("bg-gray-200")}function T(s){const l=s.target.closest(".meal-slot");l&&l.classList.remove("bg-gray-200")}async function N(s){s.preventDefault();const l=s.dataTransfer.getData("text/plain"),d=s.target.closest(".meal-slot");if(d){d.classList.remove("bg-gray-200");const b=d.dataset.slotId,o=U(b);if(o==="Remarque")return;if(l&&b&&l!==b){const h=i[l],y=U(l);if(Q(y)!==Q(o)){alert(`Action impossible : un(e) "${y}" ne peut pas aller dans la cat√©gorie "${o}".`);return}const E=i[b];i[b]=h,E?i[l]=E:delete i[l],ie(e.mealPlanGrid,{menuData:i,servingsData:c,remarksData:m,defaultNumPeople:g,startDay:r},!1),await D({[`weeks.${a}.menuData`]:i},"a d√©plac√© un plat"),await K()}}}function U(s){switch(s.split("-")[2]){case"0":return"Entr√©e";case"1":return"Plat";case"2":return"Accompagnement";case"3":return"Dessert";case"4":return"Remarque";default:return""}}function oe(s,l,d,b=!1){const o=document.createElement("div");if(o.className="meal-card p-1 flex flex-col items-center bg-white rounded shadow-sm text-center relative w-full mb-1",b||(o.classList.add("cursor-grab"),o.draggable=!0),!b){const v=document.createElement("button");v.className="absolute -top-2 -right-1 text-base",v.innerHTML='<i class="fas fa-heart"></i>',s.isFavorite?v.classList.add("text-red-500"):v.classList.add("text-gray-300","hover:text-red-400"),v.addEventListener("click",S=>{S.stopPropagation(),Ot(s.id,s.isFavorite)}),v.addEventListener("mousedown",S=>S.stopPropagation()),o.appendChild(v)}const h=document.createElement("span");if(h.className="text-xs font-medium p-1 break-words w-full",h.textContent=s.name,s.imageUrl){const v=document.createElement("img");v.src=s.imageUrl,v.alt=s.name,v.className="w-16 h-12 object-cover rounded-md mx-auto",o.appendChild(v)}if(o.appendChild(h),!b){const v=document.createElement("div");v.className="absolute top-0 left-0 flex";const S=document.createElement("button");S.className="edit-meal-btn text-gray-600 hover:text-gray-800 hidden px-1 py-0.5",S.innerHTML='<i class="fas fa-pencil-alt fa-xs"></i>',S.title="Modifier la recette",S.addEventListener("click",B=>{B.stopPropagation();const H=x.find(R=>R.id===s.id);Ve.openForm(H||s,"Modifier la recette")}),S.addEventListener("mousedown",B=>B.stopPropagation()),v.appendChild(S);const I=document.createElement("button");I.className="delete-meal-btn text-red-700 hover:text-red-900 hidden px-1 py-0.5",I.innerHTML='<i class="fas fa-times-circle fa-xs"></i>',I.title="Retirer du planning",I.addEventListener("click",B=>{B.stopPropagation(),et(l,d)}),I.addEventListener("mousedown",B=>B.stopPropagation()),v.appendChild(I),o.appendChild(v),o.addEventListener("mouseenter",()=>{S.classList.remove("hidden"),I.classList.remove("hidden")}),o.addEventListener("mouseleave",()=>{S.classList.add("hidden"),I.classList.add("hidden")})}const y=document.createElement("div");y.className="absolute bottom-1 right-1";const E=document.createElement("button");return E.className="info-meal-btn bg-gray-500 text-white hover:bg-gray-600 rounded w-3 h-3 flex items-center justify-center shadow-sm",E.innerHTML='<i class="fas fa-plus fa-xs"></i>',E.title="Plus d'infos",E.dataset.slotId=l,E.dataset.mealIndex=d,E.addEventListener("mousedown",v=>v.stopPropagation()),y.appendChild(E),o.appendChild(y),o}function We(s,l){if(document.querySelectorAll(".planner-ingredient-tooltip").forEach(y=>y.remove()),C===s){s.classList.remove("info-open"),s.innerHTML='<i class="fas fa-plus fa-xs"></i>',C=null;return}C&&(C.classList.remove("info-open"),C.innerHTML='<i class="fas fa-plus fa-xs"></i>'),s.classList.add("info-open"),s.innerHTML='<i class="fas fa-times fa-xs"></i>',C=s;const d=document.createElement("div");if(d.className="planner-ingredient-tooltip z-50 w-64 p-3 bg-white border border-gray-200 rounded-lg shadow-lg text-left text-sm",l.ingredients&&l.ingredients.length>0){if(l.servings&&l.servings>0){const v=document.createElement("p");v.className="mb-2 text-sm text-gray-600 flex items-center",v.innerHTML=`<i class="fas fa-users mr-2"></i> Pour ${l.servings} ${l.servings>1?"personnes":"personne"}`,d.appendChild(v)}const y=document.createElement("h4");y.className="font-bold mb-2 text-gray-800",y.textContent="Ingr√©dients :",d.appendChild(y);const E=document.createElement("ul");E.className="space-y-1 text-gray-600",l.ingredients.forEach(v=>{const S=document.createElement("li");S.textContent=`‚Ä¢ ${v.quantity||""} ${v.unit||""} ${v.name}`.trim(),E.appendChild(S)}),d.appendChild(E)}else d.textContent="Aucun ingr√©dient sp√©cifi√© pour cette recette.";document.body.appendChild(d);const b=s.closest(".meal-card").getBoundingClientRect(),o=d.getBoundingClientRect();if(window.innerWidth<768){d.style.width="90vw",d.style.maxWidth="320px";const y=d.getBoundingClientRect();let E=b.bottom+10,v=(window.innerWidth-y.width)/2;E+y.height>window.innerHeight&&(E=b.top-y.height-10),d.style.top=`${E}px`,d.style.left=`${v}px`}else{let y=b.right+10;y+o.width>window.innerWidth&&(y=b.left-o.width-10);let E=b.top;E+o.height>window.innerHeight&&(E=b.bottom-o.height),E<10&&(E=10),d.style.left=`${y}px`,d.style.top=`${E}px`}d.style.position="fixed"}function Ke(s,l=!1){const d=document.createElement("div"),b=document.createElement("button");return l?(d.className="w-full flex justify-center pt-1",b.className="add-more-meal-btn text-gray-400 hover:text-green-500 transition-colors duration-150",b.innerHTML='<i class="fas fa-plus-circle"></i>',b.title="Ajouter une autre recette"):(d.className="flex items-center justify-center h-full",b.className="add-meal-btn text-green-500 hover:text-green-700 transition-transform duration-150 hover:scale-125",b.innerHTML='<i class="fas fa-plus-circle text-lg"></i>'),b.addEventListener("click",()=>ue(s)),d.appendChild(b),d}function Je(s,l,d=!1){if(d){const o=document.createElement("p");return o.className="w-full h-full p-1 text-xs text-gray-700",o.textContent=l[s]||"",o}const b=document.createElement("textarea");return b.className="w-full h-full p-1 text-xs bg-white border-0 rounded focus:outline-none focus:ring-1 focus:ring-tomato resize-none",b.placeholder="Remarque...",b.value=m[s]||"",b.dataset.slotId=s,b.addEventListener("change",o=>{const h=o.target.value;h?m[s]=h:delete m[s];const[y,E]=s.split("-"),I=`a modifi√© la remarque pour ${P[parseInt(y,10)]} ${E==="lunch"?"midi":"soir"}`;D({[`weeks.${a}.remarksData`]:m},I)}),b.addEventListener("focus",o=>{bt({type:"editing_remark",fieldId:s})}),b.addEventListener("blur",o=>{bt("idle")}),b}function Ye(){document.querySelectorAll(".meal-card").forEach(s=>{s.addEventListener("dragstart",Te),s.addEventListener("dragend",O)}),document.querySelectorAll(".meal-slot").forEach(s=>{s.addEventListener("dragover",A),s.addEventListener("dragleave",T),s.addEventListener("drop",N)})}async function Ze(s,l){const d=JSON.parse(JSON.stringify(i)),b=d[s],o={id:l.id};Array.isArray(b)?b.push(o):d[s]=[o];const[h,y]=s.split("-"),E=P[parseInt(h,10)],v=y==="lunch"?"midi":"soir",S=`a ajout√© '${l.name}' √† ${E} ${v}`;await D({[`weeks.${a}.menuData`]:d},S),pe()}async function et(s,l){if(!u||!i[s]||!Array.isArray(i[s]))return;const d=i[s][l],b=JSON.parse(JSON.stringify(i));b[s].splice(l,1),b[s].length===0&&delete b[s];const[o,h]=s.split("-"),y=P[parseInt(o,10)],E=h==="lunch"?"midi":"soir",v=`a supprim√© '${d.name}' de ${y} ${E}`;await D({[`weeks.${a}.menuData`]:b},v)}async function zt(){if(confirm("Voulez-vous vraiment vider le menu de cette semaine ?")){const s={id:availablePlans.length>0?availablePlans[0].id:`${Se()}_semaine-${a}`,name:availablePlans.length>0?availablePlans[0].name:"Mon plan",menuData:{},servingsData:{},remarksData:{},defaultNumPeople:g,startDay:r,lastUpdated:new Date};loadPlan(s),availablePlans.length>0?availablePlans[0]=s:availablePlans.push(s),await D({[`weeks.${a}`]:{menuData:{},servingsData:{},remarksData:{}}},`a vid√© le menu de la semaine ${a}`)}}function Vt(s){s>=1&&s<=52&&(a=s,$())}function Dn(){e.currentWeekDisplay&&(e.currentWeekDisplay.textContent=`Semaine ${a}`)}function Tn(){e.prevWeekBtn?.addEventListener("click",()=>Vt(a-1)),e.nextWeekBtn?.addEventListener("click",()=>Vt(a+1)),e.clearMenuBtn?.addEventListener("click",zt),e.startDaySelect?.addEventListener("change",async d=>{r=d.target.value,u&&await D({startDay:r},`a chang√© le premier jour de la semaine √† '${r}'`)}),e.planSelect?.addEventListener("change",Qt),e.closeMealSelectModalBtn?.addEventListener("click",pe),e.mealSelectModal?.addEventListener("click",d=>{d.target===e.mealSelectModal&&pe()}),e.closeRecipeModalBtn?.addEventListener("click",()=>Ve.closeForm()),e.cancelRecipeBtn?.addEventListener("click",()=>Ve.closeForm()),e.importListBtn?.addEventListener("click",xe),e.closeImportListModalBtn?.addEventListener("click",qe),e.importListModal?.addEventListener("click",d=>{d.target===e.importListModal&&qe()}),e.exportTxtBtn?.addEventListener("click",k),e.exportPdfBtn?.addEventListener("click",W),e.exportPlanPdfBtn?.addEventListener("click",V);const s=d=>{const b=d.target.closest(".info-meal-btn");if(b){const o=b.dataset.slotId,h=parseInt(b.dataset.mealIndex,10);if(o&&!isNaN(h)){const y=i[o]?.[h];if(y&&y.id){const E=x.find(v=>v.id===y.id);E&&We(b,E)}}}};e.mealPlanGrid?.addEventListener("click",s),document.getElementById("mobile-meal-plan")?.addEventListener("click",s),e.sharePlanBtn?.addEventListener("click",()=>{if(!u){alert("Veuillez s√©lectionner un plan √† partager.");return}Ut({plan:u})}),e.inviteParticipantBtn?.addEventListener("click",()=>{if(!u){alert("Veuillez s√©lectionner un plan pour inviter des participants.");return}gn(u)}),e.historyPlanBtn?.addEventListener("click",ne),e.closePlanHistoryModalBtn?.addEventListener("click",q),e.planHistoryModal?.addEventListener("click",d=>{d.target===e.planHistoryModal&&q()}),e.savePlanBtn?.addEventListener("click",async()=>{if(!u){alert("Veuillez s√©lectionner un plan de travail avant de sauvegarder.");return}const d=document.getElementById("save-plan-as-modal"),b=document.getElementById("save-plan-as-form"),o=document.getElementById("save-plan-name"),h=document.getElementById("cancel-save-plan-as-btn"),y=document.getElementById("close-save-plan-as-modal"),E=new Date().toLocaleDateString("fr-FR"),v=u.weeks?Object.keys(u.weeks).filter(H=>u.weeks[H]&&Object.keys(u.weeks[H].menuData||{}).length>0).length:0,S=v>1?`${v} semaines`:`${v} semaine`;o.value=`${u.name} (${S}) - ${E}`,d.classList.remove("hidden");const I=async H=>{H.preventDefault();const R=o.value;if(!R)return;u.weeks||(u.weeks={}),u.weeks[a]={menuData:i,servingsData:c,remarksData:m},u.startDay=r,u.defaultNumPeople=g;const te=JSON.parse(JSON.stringify(u));if(te.weeks)for(const ce in te.weeks){const fe=te.weeks[ce];if(fe&&fe.menuData)for(const ge in fe.menuData){const Ne=fe.menuData[ge];Array.isArray(Ne)&&(fe.menuData[ge]=Ne.map(me=>me&&me.id&&x.find(Le=>Le.id===me.id)||me))}}await En(R,te),d.classList.add("hidden"),b.removeEventListener("submit",I)},B=()=>{d.classList.add("hidden"),b.removeEventListener("submit",I)};b.addEventListener("submit",I,{once:!0}),h.addEventListener("click",B,{once:!0}),y.addEventListener("click",B,{once:!0})})}function Pn(s=""){return s.split(" ").map(b=>b[0]).join("").substring(0,2).toUpperCase()}function Ct(s=[],l={}){const d=document.getElementById("collaborators-bar"),b=document.getElementById("activity-labels-container"),o=document.getElementById("name-tooltip");if(!d||!o||!b)return;if(d.innerHTML="",b.innerHTML="",document.querySelectorAll(".remark-lock-overlay").forEach(E=>E.remove()),document.querySelectorAll("textarea[data-slot-id]").forEach(E=>{E.disabled=!1}),s.length<=1&&Object.keys(l).length<=1){d.classList.add("hidden");return}let h="";const y=Se();s.forEach(E=>{if(!E)return;const v=l.hasOwnProperty(E.uid),S=l[E.uid]||{},I=document.createElement("div");I.className="w-8 h-8 rounded-full flex items-center justify-center bg-gray-300 text-white font-bold text-xs ring-2 ring-white cursor-pointer transition-all duration-300";const B=v?"(pr√©sent)":"(absent)";if(I.dataset.name=`${E.displayName||"Inconnu"} ${B}`,E.photoURL?I.innerHTML=`<img src="${E.photoURL}" alt="${E.displayName}" class="w-full h-full rounded-full object-cover">`:I.textContent=Pn(E.displayName),v||I.classList.add("grayscale","opacity-50"),I.addEventListener("mouseenter",H=>{o.textContent=H.currentTarget.dataset.name,o.classList.remove("hidden");const R=H.currentTarget.getBoundingClientRect();o.style.left=`${R.left+R.width/2-o.offsetWidth/2}px`,o.style.top=`${R.top-o.offsetHeight-5}px`}),I.addEventListener("mouseleave",()=>{o.classList.add("hidden")}),d.appendChild(I),v&&E.uid!==y){const H=S.status;if(typeof H=="object"&&H.type==="editing_remark"){const R=document.querySelector(`textarea[data-slot-id="${H.fieldId}"]`);if(R){R.disabled=!0;const te=document.createElement("div");te.className="remark-lock-overlay absolute inset-0 bg-gray-400 bg-opacity-25 flex items-center justify-center text-xs text-white font-bold",te.innerHTML=`<i class="fas fa-lock mr-1"></i> ${E.displayName} √©crit...`,R.parentElement&&(R.parentElement.classList.add("relative"),R.parentElement.appendChild(te))}}else if(typeof H=="string"&&H!=="idle"){let R="";switch(H){case"editing_recipe":R="modifie une recette...";break}R&&(h+=`<span class="italic mr-4">${E.displayName} ${R}</span>`)}}}),b.innerHTML=h,d.classList.remove("hidden")}function Qt(){Mn();const s=e.planSelect.value;s&&localStorage.setItem("lastActivePlanId",s),u=M.find(y=>y.id===s)||null;const l=document.getElementById("delete-plan-btn"),d=document.getElementById("rename-plan-btn"),b=document.getElementById("leave-plan-btn"),o=document.getElementById("invite-participant-btn"),h=document.getElementById("history-plan-btn");if(l&&(l.style.display=u&&u.isOwner?"inline-flex":"none"),d&&(d.style.display=u&&u.isOwner?"inline-flex":"none"),h&&(h.style.display=u&&u.isOwner?"inline-flex":"none"),b&&(b.style.display=u&&!u.isOwner?"inline-flex":"none"),o){const y=u&&(u.type==="collaborative"||u.collaborators&&u.collaborators.length>0);o.style.display=u&&u.isOwner&&y?"inline-flex":"none"}u&&u.participants&&u.participants.length>1?(Ct(u.participants,{}),Bn(u.id,y=>{Ct(u.participants,y)})):Ct([],{}),u&&(u.manualItems=u.manualItems||[]),$()}async function Wt(s,l){if(!u)return;const d=JSON.parse(JSON.stringify(c));l===g?delete d[s]:d[s]=l;const[b,o]=s.split("-"),E=`a chang√© le nombre de personnes pour ${P[parseInt(b,10)]} ${o==="lunch"?"midi":"soir"} √† ${l}`;await D({[`weeks.${a}.servingsData`]:d},E)}async function _n(){if(!w)return;const s=yn();Tn(),F(),await _();const l=Fe(z(w,"recipes"),b=>{if(console.log("Recipe data updated from listener."),x=b.docs.map(o=>{const h=o.data();return{id:o.id,...h,imageUrl:h.imageUrl||""}}),u){for(const o in i){const h=i[o];if(Array.isArray(h)){const y=h.map(E=>{if(E&&E.id){const v=x.find(S=>S.id===E.id);return v?{...v}:E}return E});i[o]=y}}ie(e.mealPlanGrid,{menuData:i,servingsData:c,remarksData:m,defaultNumPeople:g,startDay:r},!1),Y(document.getElementById("mobile-meal-plan"),{menuData:i,servingsData:c,remarksData:m,defaultNumPeople:g,startDay:r},!1),K()}}),d=Ft(b=>{M=b,bn(b);const o=localStorage.getItem("selectedPlanId"),h=localStorage.getItem("lastActivePlanId");o&&b.some(y=>y.id===o)?(e.planSelect.value=o,localStorage.removeItem("selectedPlanId")):h&&b.some(y=>y.id===h)&&(e.planSelect.value=h),Qt()});return()=>{d(),l(),s()}}const $n=_n();return async()=>{const s=await $n;typeof s=="function"&&s()}}const Ma=Object.freeze(Object.defineProperty({__proto__:null,default:Ba},Symbol.toStringTag,{value:"Module"}));function Na(){const e=Nn();return Rt(),()=>{typeof e=="function"&&e()}}async function Rt(){const e=document.getElementById("received-shares-container"),t=Se();if(!(!t||!e)){e.innerHTML='<p class="text-gray-500">Chargement des partages re√ßus...</p>';try{const n=Ee(z(w,"plans"),re("userId","==",t),re("isShared","==",!0)),a=Ee(z(w,"plans"),re("collaborators","array-contains",t)),[r,i]=await Promise.all([ye(n),ye(a)]);let c=[];if(r.forEach(m=>c.push({id:m.id,type:"Planification (Copie)",...m.data()})),i.forEach(m=>c.push({id:m.id,type:"Planification (Collaboratif)",...m.data()})),c.length===0){e.innerHTML=`<p class="text-gray-500">Vous n'avez aucun contenu partag√© par d'autres utilisateurs.</p>`;return}c.sort((m,f)=>(f.sharedAt?.seconds||f.lastUpdated?.seconds||0)-(m.sharedAt?.seconds||m.lastUpdated?.seconds||0)),e.innerHTML="";for(const m of c){const f=m.originalOwnerId||m.userId;if(!f)continue;const p=await Me(j(w,"users",f)),x=p.exists()?p.data().displayName:"Utilisateur inconnu";e.appendChild(Da(m,x))}}catch(n){console.error("Erreur lors du chargement des partages re√ßus : ",n),e.innerHTML='<p class="text-red-500">Une erreur est survenue.</p>'}}}function Da(e,t){const n=document.createElement("div");n.className="bg-white rounded-lg p-4 flex justify-between items-center shadow-sm";const a=document.createElement("div"),r=document.createElement("p");r.className="font-bold text-gray-800";let i="";e.type.includes("Collaboratif")?i=' <span class="text-xs font-medium bg-blue-100 text-blue-800 px-2 py-1 rounded-full">Collab</span>':e.type.includes("Copie")&&(i=' <span class="text-xs font-medium bg-gray-200 text-gray-800 px-2 py-1 rounded-full">Copie</span>'),r.innerHTML=`${e.name}${i}`;const c=document.createElement("p");c.className="text-sm text-gray-500 mt-1";const m=e.sharedAt?new Date(e.sharedAt.seconds*1e3).toLocaleDateString("fr-FR"):e.lastUpdated?new Date(e.lastUpdated.seconds*1e3).toLocaleDateString("fr-FR"):"date inconnue";c.textContent=`Partag√© par ${t} le ${m}`,a.appendChild(r),a.appendChild(c),n.appendChild(a);const f=document.createElement("button");return f.className="btn btn-ghost text-red-500 btn-sm",f.innerHTML='<i class="fas fa-trash"></i>',f.title="Supprimer ce contenu partag√©",f.addEventListener("click",()=>Ta(e.id,e.type)),n.appendChild(f),n}async function Ta(e,t){if(confirm(`Voulez-vous vraiment supprimer cette ${t.toLowerCase()} partag√©e ?`))try{const n=t.startsWith("Planification")?"plans":"shopping_lists",a=j(w,n,e),r=await Me(a);r.exists()&&r.data().userId===Se()?(await Re(a),Rt()):(alert("Vous n'avez pas la permission de supprimer cet √©l√©ment ou il a d√©j√† √©t√© supprim√©."),Rt())}catch(n){console.error("Erreur de suppression: ",n),alert("Une erreur est survenue.")}}async function Nn(){const e=document.getElementById("sent-shares-container"),t=Se();if(!t||!e)return()=>{};e.innerHTML='<p class="text-gray-500">Chargement des partages envoy√©s...</p>';const n=z(w,"shares"),a=Ee(n,re("senderId","==",t));return Fe(a,async r=>{if(r.empty){e.innerHTML=`<p class="text-gray-500">Vous n'avez envoy√© aucun partage.</p>`;return}const i=r.docs.sort((c,m)=>(m.data().createdAt?.seconds||0)-(c.data().createdAt?.seconds||0));e.innerHTML="";for(const c of i){const m=c.data();try{const f=await Me(j(w,"users",m.receiverId));if(f.exists()){const p=f.data();e.appendChild(Pa(m,p.displayName,c.id))}}catch(f){console.error("Could not load receiver for sent share",f)}}},r=>{console.error("Erreur lors du chargement des partages envoy√©s : ",r),e&&(e.innerHTML='<p class="text-red-500">Une erreur est survenue.</p>')})}function Pa(e,t,n){const a=document.createElement("div");a.className="bg-white rounded-lg p-4 flex justify-between items-center shadow-sm";const r=document.createElement("div"),i=document.createElement("p");i.className="font-bold text-gray-800";let c=[];e.plan&&c.push("Planification"),e.shoppingList&&c.push("Liste de courses"),i.textContent=c.join(" et ");const m=document.createElement("p");m.className="text-sm text-gray-500";const f=new Date(e.createdAt.seconds*1e3).toLocaleDateString("fr-FR");m.textContent=`Envoy√© √† ${t} le ${f}`,r.appendChild(i),r.appendChild(m),a.appendChild(r);const p=document.createElement("div");p.className="flex items-center space-x-4";const x=document.createElement("span");x.textContent=e.status;let L="bg-gray-200 text-gray-800";switch(e.status){case"accepted":L="bg-green-100 text-green-800";break;case"declined":L="bg-red-100 text-red-800";break;case"pending":L="bg-yellow-100 text-yellow-800";break}x.className=`text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full ${L}`,p.appendChild(x);const g=document.createElement("button");return g.className="btn btn-ghost text-red-500 btn-sm",g.innerHTML='<i class="fas fa-trash"></i>',g.title="Annuler le partage",g.addEventListener("click",()=>_a(n)),p.appendChild(g),a.appendChild(p),a}async function _a(e){if(confirm("Voulez-vous vraiment annuler ce partage ? L'autre utilisateur ne le verra plus."))try{await Re(j(w,"shares",e)),Nn()}catch(t){console.error("Erreur lors de la suppression du partage: ",t),alert("Une erreur est survenue.")}}const $a=Object.freeze(Object.defineProperty({__proto__:null,default:Na},Symbol.toStringTag,{value:"Module"})),ja="modulepreload",Aa=function(e){return"/"+e},tn={},Ha=function(t,n,a){let r=Promise.resolve();if(n&&n.length>0){let f=function(p){return Promise.all(p.map(x=>Promise.resolve(x).then(L=>({status:"fulfilled",value:L}),L=>({status:"rejected",reason:L}))))};document.getElementsByTagName("link");const c=document.querySelector("meta[property=csp-nonce]"),m=c?.nonce||c?.getAttribute("nonce");r=f(n.map(p=>{if(p=Aa(p),p in tn)return;tn[p]=!0;const x=p.endsWith(".css"),L=x?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${p}"]${L}`))return;const g=document.createElement("link");if(g.rel=x?"stylesheet":ja,x||(g.as="script"),g.crossOrigin="",g.href=p,m&&g.setAttribute("nonce",m),document.head.appendChild(g),x)return new Promise((C,M)=>{g.addEventListener("load",C),g.addEventListener("error",()=>M(new Error(`Unable to preload CSS for ${p}`)))})}))}function i(c){const m=new Event("vite:preloadError",{cancelable:!0});if(m.payload=c,window.dispatchEvent(m),!m.defaultPrevented)throw c}return r.then(c=>{for(const m of c||[])m.status==="rejected"&&i(m.reason);return t().catch(i)})},ht=ln();let st=null,rt=null,nn=[],an=[],sn={};function Ra(){const e=document.getElementById("shopping-mode-container"),t=document.getElementById("shopping-mode-plan-select"),n=document.getElementById("shopping-mode-back-btn");n&&n.addEventListener("click",()=>{window.location.hash="#menu";const f=document.querySelector('button[data-path="menu"]');f&&f.click()});async function a(){try{an=(await ye(z(ht,"ingredients"))).docs.map(p=>({id:p.id,...p.data()}))}catch(f){console.error("Error fetching ingredients",f)}try{nn=(await ye(z(ht,"recipes"))).docs.map(p=>({id:p.id,...p.data()}))}catch(f){console.error("Error fetching recipes",f)}Ft(f=>{if(!t)return;if(t.innerHTML="",f.length===0){e.innerHTML='<p class="text-center p-4">Aucun plan trouv√©.</p>';return}f.forEach(x=>{const L=document.createElement("option");L.value=x.id,L.textContent=x.name,t.appendChild(L)});const p=localStorage.getItem("lastActivePlanId");p&&f.some(x=>x.id===p)?(t.value=p,r(p)):f.length>0&&r(f[0].id),t.addEventListener("change",x=>{const L=x.target.value;localStorage.setItem("lastActivePlanId",L),r(L)})})}function r(f){st&&(st(),st=null);const p=j(ht,"plans",f);st=Fe(p,x=>{x.exists()?(rt={id:x.id,...x.data()},sn=rt.checkedItems||{},i()):e.innerHTML='<p class="text-center p-4 text-red-500">Plan introuvable.</p>'})}function i(){if(!rt||!e)return;const f=m(rt);if(e.innerHTML="",f.length===0){e.innerHTML='<p class="text-center p-10 text-gray-500">Votre liste de courses est vide pour ce plan.</p>';return}const p=f.reduce((L,g)=>{const C=g.category||"Inconnue";return L[C]||(L[C]=[]),L[C].push(g),L},{});Object.keys(p).sort((L,g)=>L==="Inconnue"?1:g==="Inconnue"?-1:L.localeCompare(g)).forEach(L=>{const g=document.createElement("h3");g.className="font-bold text-lg text-gray-700 mt-6 mb-3 border-b border-gray-200 pb-1 sticky top-0 bg-white z-10",g.textContent=L,e.appendChild(g);const C=document.createElement("ul");C.className="space-y-3",p[L].sort((M,u)=>M.name.localeCompare(u.name)).forEach(M=>{const u=`${M.name}_${M.unit||""}`,P=sn[u]||!1,Q=document.createElement("li");Q.className=`flex flex-col p-3 rounded-lg transition-colors duration-200 ${P?"bg-gray-100":"bg-white shadow-sm border border-gray-100"}`;const ve=document.createElement("div");ve.className="flex items-center w-full";const _=document.createElement("input");_.type="checkbox",_.className="form-checkbox h-6 w-6 text-tomato rounded-full border-gray-300 focus:ring-tomato cursor-pointer transition duration-150 ease-in-out",_.checked=P;const $=document.createElement("div");$.className="ml-3 flex-grow cursor-pointer select-none";const D=Number.isInteger(M.totalQuantity)?M.totalQuantity:parseFloat(M.totalQuantity.toFixed(2)),q=document.createElement("span");q.className=`font-medium text-base ${P?"line-through text-gray-400":"text-gray-800"}`,q.textContent=M.name;const J=document.createElement("span");J.className=`ml-2 font-bold text-base ${P?"text-gray-400":"text-gray-800"}`,J.textContent=` - ${D} ${M.unit||""}`.trim(),$.appendChild(q),$.appendChild(J);const le=()=>{const ne=!_.checked;_.checked=ne,c(u,ne,Q,_,q,J)};if(_.addEventListener("change",ne=>{c(u,ne.target.checked,Q,_,q,J)}),$.addEventListener("click",le),ve.appendChild(_),ve.appendChild($),Q.appendChild(ve),M.sources&&M.sources.length>0){const ne=document.createElement("div");ne.className="mt-2 ml-9 text-xs text-gray-500 space-y-1";const Y=M.sources.reduce((ie,ae)=>{const xe=`${ae.recipeName} (${ae.day} ${ae.time})`;return ie[xe]||(ie[xe]=0),ie[xe]+=ae.quantity,ie},{});for(const ie in Y){const ae=document.createElement("div");ae.textContent=`‚Ü≥ ${ie}`,ne.appendChild(ae)}Q.appendChild(ne)}C.appendChild(Q)}),e.appendChild(C)})}function c(f,p,x,L,g,C){if(!rt)return;p?(x.classList.remove("bg-white","shadow-sm","border","border-gray-100"),x.classList.add("bg-gray-100"),g.classList.add("line-through","text-gray-400"),g.classList.remove("text-gray-800"),C.classList.add("text-gray-400"),C.classList.remove("text-gray-800")):(x.classList.add("bg-white","shadow-sm","border","border-gray-100"),x.classList.remove("bg-gray-100"),g.classList.remove("line-through","text-gray-400"),g.classList.add("text-gray-800"),C.classList.remove("text-gray-400"),C.classList.add("text-gray-800"));const M=j(ht,"plans",rt.id),u={};u[`checkedItems.${f}`]=p,u.lastUpdated=new Date,Ha(()=>import("./firebase-config-CV1YP_xo.js").then(P=>P.F),[]).then(P=>{P.updateDoc(M,u)}).catch(P=>{console.error("Error updating checked item:",P)})}function m(f){const p=[],x=new Map;(f.manualItems||[]).forEach(C=>{const M=`${C.name.trim().toLowerCase()}_${C.unit||""}`;x.set(M,{name:C.name.trim(),totalQuantity:C.totalQuantity,unit:C.unit,category:C.category||"Inconnue"})});const g=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];if(f.weeks)for(const C in f.weeks){const M=f.weeks[C],u=M.menuData||{},P=M.servingsData||{};for(const Q in u){const ve=u[Q];if(!Array.isArray(ve))continue;const[_,$]=Q.split("-"),D=`${_}-${$}`,q=parseInt(P[D]||f.defaultNumPeople||1,10);ve.forEach(J=>{const le=nn.find(Y=>Y.id===J.id)||J;if(!le||!le.ingredients)return;const ne=le.servings||1;le.ingredients.forEach(Y=>{if(!Y.name||!Y.quantity)return;const ie=an.find(V=>V.name.toLowerCase()===Y.name.toLowerCase()),ae=ie?ie.category:"Inconnue",xe=parseFloat(String(Y.quantity).replace(",","."));if(isNaN(xe))return;const F=xe/ne*q,k=Y.unit||"",W=`${Y.name.trim().toLowerCase()}_${k}`;if(x.has(W)){const V=x.get(W);V.totalQuantity+=F,V.sources||(V.sources=[]),V.sources.push({recipeName:le.name,day:g[parseInt(_,10)],time:$==="lunch"?"Midi":"Soir",quantity:F})}else x.set(W,{name:Y.name.trim(),totalQuantity:F,unit:k,category:ae,sources:[{recipeName:le.name,day:g[parseInt(_,10)],time:$==="lunch"?"Midi":"Soir",quantity:F}]})})})}}return x.forEach(C=>{C.totalQuantity>0&&p.push(C)}),p}return a(),()=>{st&&st()}}const qa=Object.freeze(Object.defineProperty({__proto__:null,default:Ra},Symbol.toStringTag,{value:"Module"}));function Ua(){const e=localStorage.getItem("selectedPlanId"),t=document.getElementById("plan-view-name"),n=document.getElementById("meal-plan-grid"),a=document.getElementById("close-view-plan-btn");if(a&&a.addEventListener("click",()=>{localStorage.removeItem("selectedPlanId"),ot("plans")}),!e)return t&&(t.textContent="Aucune sauvegarde s√©lectionn√©e"),n&&(n.innerHTML=`<p class="text-center text-red-500">Erreur : Aucun ID de sauvegarde trouv√©. Veuillez retourner √† la page 'Mes Plans Sauvegard√©s' et en s√©lectionner une.</p>`),()=>{};async function r(){try{const i=j(w,"plan_saves",e),c=await Me(i);if(!c.exists())throw new Error("Sauvegarde non trouv√©e");const m=c.data(),f=m.planData;if(!f)throw new Error("Les donn√©es du plan sauvegard√© sont corrompues ou manquantes.");t&&(t.textContent=`Vue de : ${m.name}`),Fa(n,f)}catch(i){console.error("Error fetching save:",i),t&&(t.textContent="Erreur"),n&&(n.innerHTML=`<p class="text-center text-red-500">${i.message}</p>`)}}return r(),()=>{localStorage.removeItem("selectedPlanId")}}function Fa(e,t){if(!e)return;e.innerHTML="";const n=Object.keys(t.weeks||{}).sort((a,r)=>parseInt(a)-parseInt(r));if(n.length===0){e.innerHTML='<p class="text-center text-gray-500 p-10 col-span-full">Ce plan est vide.</p>';return}n.forEach(a=>{const r=t.weeks[a],i=document.createElement("h3");i.className="text-lg font-bold text-gray-700 mt-6 mb-2 col-span-full",i.textContent=`Semaine ${a}`,e.appendChild(i);const c=document.createElement("div");Oa(c,r,t.startDay,t.defaultNumPeople),e.appendChild(c)})}function Oa(e,t,n,a){const r=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"],i=r.indexOf(n||"Lundi"),c=[...r.slice(i),...r.slice(0,i)],m=t.menuData||{},f=t.servingsData||{},p=t.remarksData||{};c.forEach(x=>{const L=r.indexOf(x),g=document.createElement("div");g.className="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] items-stretch border-b border-gray-300";const C=document.createElement("div");C.className="font-bold p-2 flex items-center justify-center bg-gray-100 text-sm border-r border-gray-300",C.textContent=x.toUpperCase(),g.appendChild(C),["lunch","dinner"].forEach(M=>{const u=`${L}-${M}`,P=f[u]||a||1,Q=document.createElement("div");Q.className="border-r border-gray-300 flex items-center justify-center",Q.innerHTML=`<div class="text-center"><i class="fas fa-users fa-xs mb-1"></i><br>${P}</div>`,g.appendChild(Q);for(let ve=0;ve<5;ve++){const _=`${L}-${M}-${ve}`,$=document.createElement("div");if($.className="meal-slot p-1 min-h-[50px] border-r border-gray-300",ve===4)$.textContent=p[_]||"",$.classList.add("text-xs","italic","text-gray-600");else{const D=m[_];Array.isArray(D)&&D.length>0&&D.forEach(q=>{const J=document.createElement("div");J.className="p-1 bg-white rounded shadow-sm text-center text-xs font-medium",J.textContent=q.name,$.appendChild(J)})}g.appendChild($)}}),e.appendChild(g)})}const za=Object.freeze(Object.defineProperty({__proto__:null,default:Ua},Symbol.toStringTag,{value:"Module"})),rn=document.querySelector("main"),Va={menu:{html:`
        <div class="flex flex-col md:flex-row md:space-x-2">

            <!-- Left Column: Meal Planner -->
            <div class="w-full md:w-5/6">
                <section id="meal-planning-section" aria-labelledby="meal-planning-heading" class="mb-8 md:mb-12">
                                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                                        <h2 id="meal-planning-heading" class="text-xl md:text-2xl font-bold text-gray-800">Planification des repas</h2>
                                        <div class="mt-3 md:mt-0 flex items-center space-x-2 md:space-x-3 plan-actions">
                                            <button id="generate-plan-ai-btn" class="btn btn-primary btn-sm">
                                                <i class="fas fa-robot mr-1 md:mr-2"></i> IA Semaine
                                            </button>
                                            <button id="clear-menu-btn" class="btn btn-outline btn-sm text-red-800 hover:bg-red-100">
                                                <i class="fas fa-trash-alt mr-1 md:mr-2"></i> Vider le menu
                                            </button>
                                            <button id="export-plan-pdf-btn" class="btn btn-outline btn-sm">
                                                <i class="fas fa-file-pdf mr-1 md:mr-2"></i> Exporter Plan (PDF)
                                            </button>
                                            <button id="share-plan-btn" class="btn btn-secondary btn-sm">
                                                <i class="fas fa-share-alt mr-1 md:mr-2"></i> Partager
                                            </button>
                                            <button id="save-plan-btn" class="btn btn-secondary btn-sm">
                                                <i class="fas fa-save mr-1 md:mr-2"></i> Sauvegarder Plan
                                            </button>
                                        </div>
                                    </div>
                            
                                    <!-- Week Navigation & Plan Selector -->
                                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 space-y-3 md:space-y-0">
                                        <!-- Week Navigation -->
                                        <div class="flex justify-between items-center bg-white p-2 md:p-3 rounded-lg shadow-sm">
                                            <button id="prev-week-btn" class="btn btn-ghost btn-sm" aria-label="Semaine pr√©c√©dente">
                                                <i class="fas fa-chevron-left mr-1 md:mr-2"></i> Pr√©c.
                                            </button>
                                            <div id="current-week-display" class="text-gray-700 font-medium text-sm md:text-base text-center mx-4">Semaine X</div>
                                            <button id="next-week-btn" class="btn btn-ghost btn-sm" aria-label="Semaine suivante">
                                                Suiv. <i class="fas fa-chevron-right ml-1 md:ml-2"></i>
                                            </button>
                                        </div>
                                        <!-- Plan Selector -->
                                        <div class="flex flex-wrap items-center justify-center gap-2 bg-white p-3 rounded-lg shadow-sm">
                                            <label for="plan-select" class="text-sm font-medium text-gray-700">Plan affich√©:</label>
                                            <select id="plan-select" class="rounded-md border-gray-300 shadow-sm focus:border-tomato focus:ring focus:ring-tomato focus:ring-opacity-50 text-sm py-1">
                                                <!-- Options will be generated by JS -->
                                            </select>
                                            <button id="create-plan-btn" class="btn btn-primary btn-sm" title="Cr√©er un nouveau plan">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                            <button id="rename-plan-btn" class="btn btn-ghost text-blue-500 hover:bg-blue-100 btn-sm" title="Renommer le plan s√©lectionn√©">
                                                <i class="fas fa-pencil-alt"></i>
                                            </button>
                                            <button id="history-plan-btn" class="btn btn-ghost text-purple-500 hover:bg-purple-100 btn-sm" title="Historique des modifications">
                                                <i class="fas fa-history"></i>
                                            </button>
                                            <button id="leave-plan-btn" class="btn btn-ghost text-yellow-600 hover:bg-yellow-100 btn-sm" title="Quitter le plan collaboratif">
                                                <i class="fas fa-door-open"></i>
                                            </button>
                                            <button id="delete-plan-btn" class="btn btn-ghost text-red-500 hover:bg-red-100 btn-sm" title="Supprimer le plan s√©lectionn√©">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            <button id="invite-participant-btn" class="btn btn-ghost text-green-500 hover:bg-green-100 btn-sm hidden" title="Inviter un participant">
                                                <i class="fas fa-user-plus"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Collaborators Bar -->
                                    <div id="collaborators-bar" class="flex items-center space-x-2 mb-4 hidden">
                                        <!-- Avatars will be injected here -->
                                    </div>

                                    <!-- Activity Labels -->
                                    <div id="activity-labels-container" class="text-sm text-gray-600 mb-4 h-6">
                                        <!-- e.g., 'Sophie is adding a recipe...' -->
                                    </div>
                            
                                            <!-- Settings Section -->
                                            <div class="inline-flex items-center space-x-6 bg-white p-3 rounded-lg shadow-sm mb-4">                                        <div>
                                            <label for="start-day-select" class="text-sm font-medium text-gray-700">D√©but de semaine:</label>
                                            <select id="start-day-select" class="rounded-md border-gray-300 shadow-sm focus:border-tomato focus:ring-tomato text-sm py-1">
                                                <option>Lundi</option>
                                                <option>Mardi</option>
                                                <option>Mercredi</option>
                                                <option>Jeudi</option>
                                                <option>Vendredi</option>
                                                <option>Samedi</option>
                                                <option>Dimanche</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="default-servings-input" class="text-sm font-medium text-gray-700">Personnes par d√©faut:</label>
                                            <div id="default-servings-control" class="mt-1"></div>
                                        </div>
                                    </div>                    <!-- Responsive Meal Plan Grid -->
<div class="bg-white rounded-xl shadow-md p-4">
                        <!-- Desktop Grid (Visible on large screens) -->
                        <div id="desktop-plan-container" class="hidden lg:block">
                            <div id="meal-plan-grid-layout">
                                <!-- Header -->
                                <div class="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] gap-1 text-center mb-1">
                                    <div class="p-2"></div> <!-- Empty corner -->
                                    <div class="p-2 rounded-t-lg bg-amber-100 text-amber-800 font-bold col-span-6">MIDI</div>
                                    <div class="p-2 rounded-t-lg bg-stone-200 text-stone-800 font-bold col-span-6">SOIR</div>
                                    
                                    <div class="p-1"></div> <!-- Empty under day name -->
                                    <div class="p-1 text-xs font-semibold"><i class="fas fa-users"></i></div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Entr√©e</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Plat</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Accomp.</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Dessert</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Remarque</div>

                                    <div class="p-1 text-xs font-semibold"><i class="fas fa-users"></i></div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Entr√©e</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Plat</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Accomp.</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Dessert</div>
                                    <div class="p-1 text-xs font-semibold text-gray-600">Remarque</div>
                                </div>
                                <!-- Rows generated by JS -->
                                <div id="meal-plan-grid" class="space-y-1">
                                    <div class="p-10 text-center text-gray-500 italic col-span-full">Chargement du planning...</div>
                                </div>
                            </div>
                        </div>

                        <!-- Mobile Accordion (Visible on small screens) -->
                        <div id="mobile-meal-plan" class="lg:hidden space-y-2">
                            <!-- Mobile content will be generated by JS here -->
                             <div class="p-10 text-center text-gray-500 italic col-span-full">Chargement du planning...</div>
                        </div>
                    </div>
                                    </section>


                                </div>
                    
                                <!-- Right Column: Shopping List -->
                                <div class="w-full md:w-1/6">
                                    <section id="shopping-list-section" aria-labelledby="shopping-list-heading" class="mb-8 md:mb-12 md:sticky md:top-24">
                                        <div class="bg-white rounded-xl shadow-md p-4 md:p-6">
                                            <div class="flex justify-between items-center mb-4">
                                                <h2 id="shopping-list-heading" class="text-xl md:text-2xl font-bold text-gray-800">Liste de courses</h2>

                                            </div>
                                            <div class="flex justify-end space-x-2 mb-4">
                                                <button id="import-list-btn" class="btn btn-secondary btn-sm">
                                                    <i class="fas fa-download mr-2"></i>Importer une liste
                                                </button>
                                                <div id="export-buttons-container" class="flex space-x-2">
                                                    <button id="export-txt-btn" class="btn btn-outline btn-sm">
                                                        <i class="fas fa-file-alt mr-2"></i>TXT
                                                    </button>
                                                    <button id="export-pdf-btn" class="btn btn-outline btn-sm">
                                                        <i class="fas fa-file-pdf mr-2"></i>PDF
                                                    </button>
                                                </div>
                                            </div>
                    
                                            <!-- Shopping List Container -->
                                            <div id="shopping-list-container" class="mb-4 max-h-[70vh] overflow-y-auto pr-2">                            <ul id="shopping-list" class="space-y-2 text-sm">
                                <!-- Les articles de la liste de courses seront g√©n√©r√©s ici -->
                            </ul>
                        </div>

                        <!-- Add Item Input -->
                        <div class="mt-4 flex items-stretch">
                            <div class="relative flex-grow">
                                <input type="text" id="add-item-input" placeholder="Chercher ou ajouter..." class="w-full border border-gray-300 rounded-l-lg px-2 py-1 text-xs focus:outline-none focus:ring-2 focus:ring-tomato focus:border-transparent">
                                <div id="add-item-results" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto bottom-full mb-2"></div>
                            </div>
                            <button id="add-item-btn" class="btn btn-primary rounded-l-none -ml-px btn-xs" aria-label="Ajouter l'article">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>

                         <!-- AI Shopping Tips Placeholder -->
                        <div id="ai-shopping-tip" class="mt-6 bg-avocado bg-opacity-10 rounded-lg p-3 hidden">
                            <div class="flex items-start">
                                 <div class="w-8 h-8 bg-avocado bg-opacity-20 rounded-full flex items-center justify-center mr-3 shrink-0">
                                    <i class="fas fa-lightbulb text-avocado"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-avocado mb-1 text-sm">Astuce √âconomique</h4>
                                    <p id="ai-shopping-tip-text" class="text-sm text-gray-700">...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <!-- Shared Plans Modal -->
        <div id="shared-plans-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-6xl max-h-[90vh] overflow-y-auto relative">
                <button id="close-shared-plans-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" aria-label="Fermer">
                    <i class="fas fa-times text-xl"></i>
                </button>
                <h3 id="shared-plans-modal-title" class="text-2xl font-bold mb-6">Plans partag√©s pour la Semaine X</h3>
                <div id="shared-plans-modal-container" class="space-y-6">
                    <!-- Shared plans will be loaded here -->
                </div>
            </div>
        </div>
        `,script:"./script.js"},recipes:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Recettes</h2>
            <button id="add-recipe-btn" class="btn btn-primary">
                <i class="fas fa-plus mr-2"></i> Ajouter une recette
            </button>
        </div>

        <!-- Search Bar -->
        <div class="mb-6">
            <input type="text" id="search-bar" placeholder="Rechercher une recette..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-tomato focus:border-tomato">
        </div>

        <!-- Tabs Navigation -->
        <div id="category-tabs" class="mb-6 border-b border-gray-200 flex space-x-4 flex-nowrap overflow-x-auto pb-2">
            <!-- Tabs will be generated by recipes.js here -->
        </div>

        <!-- Recipe List Container -->
        <div id="recipe-list-container">
            <!-- Recipes for the selected tab will be loaded here -->
        </div>

        <!-- Reconstructed Recipe Form Modal -->
        <div id="recipe-form-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-3xl max-h-[90vh] overflow-y-auto relative">
                <button id="close-recipe-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" aria-label="Fermer">
                    <i class="fas fa-times text-xl"></i>
                </button>
                <h3 id="recipe-modal-title" class="text-2xl font-bold mb-6">Ajouter/Modifier une recette</h3>
                <form id="recipe-form" class="space-y-4">
                    <input type="hidden" id="recipe-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label for="recipe-name" class="block text-sm font-medium text-gray-700">Nom de la recette</label>
                            <input type="text" id="recipe-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                        </div>
                        <div>
                            <label for="recipe-category" class="block text-sm font-medium text-gray-700">Cat√©gorie</label>
                            <select id="recipe-category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                                <option>ENTREE</option>
                                <option>PLAT</option>
                                <option>ACCOMPAGNEMENT</option>
                                <option>DESSERT</option>
                            </select>
                        </div>
                        <div>
                            <label for="recipe-servings" class="block text-sm font-medium text-gray-700">Nombre de personnes</label>
                            <input type="number" id="recipe-servings" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" min="1">
                        </div>
                        <div>
                            <label for="recipe-prep-time" class="block text-sm font-medium text-gray-700">Temps de pr√©paration (min)</label>
                            <input type="number" id="recipe-prep-time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" min="0">
                        </div>
                         <div>
                            <label for="recipe-difficulty" class="block text-sm font-medium text-gray-700">Difficult√©</label>
                            <select id="recipe-difficulty" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                <option>Tr√®s facile</option>
                                <option>Facile</option>
                                <option>Moyen</option>
                                <option>Difficile</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-lg font-medium text-gray-800 mb-2">Ingr√©dients</h4>
                        <div id="ingredients-list" class="space-y-2"></div>
                        <button type="button" id="add-ingredient-btn" class="btn btn-outline btn-sm mt-2">
                            <i class="fas fa-plus mr-2"></i> Ajouter un ingr√©dient
                        </button>
                    </div>
                    <div>
                        <label for="recipe-steps" class="block text-lg font-medium text-gray-800">Pr√©paration</label>
                        <textarea id="recipe-steps" rows="8" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                    </div>
                    <div class="flex justify-end space-x-4 pt-4">
                        <button type="button" id="cancel-recipe-btn" class="btn btn-ghost">Annuler</button>
                        <button type="submit" id="save-recipe-btn" class="btn btn-primary">Sauvegarder</button>
                    </div>
                </form>
            </div>
        </div>
        `,script:"./recipes.js"},ingredients:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Ingr√©dients</h2>
            <div class="flex space-x-2">
                <button id="manage-categories-btn" class="btn btn-outline">
                    <i class="fas fa-tags mr-2"></i> G√©rer les cat√©gories
                </button>
                <button id="add-ingredient-btn" class="btn btn-primary">
                    <i class="fas fa-plus mr-2"></i> Ajouter un ingr√©dient
                </button>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="mb-6">
            <input type="text" id="search-bar" placeholder="Rechercher un ingr√©dient..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-tomato focus:border-tomato">
        </div>

        <!-- Tabs Navigation -->
        <div id="category-tabs" class="mb-6 border-b border-gray-200 flex space-x-4 flex-nowrap overflow-x-auto pb-2">
            <!-- Tabs will be generated by ingredients.js here -->
        </div>

        <!-- Ingredient List Container -->
        <div id="ingredients-list-container">
            <p class="text-center text-gray-500 p-10">Chargement des ingr√©dients...</p>
        </div>

        <!-- Ingredient Form Modal -->
        <div id="ingredient-form-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-md relative">
                <button id="close-ingredient-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
                <h3 id="ingredient-modal-title" class="text-lg font-bold mb-4">Ajouter un Ingr√©dient</h3>
                <form id="ingredient-form" class="space-y-4">
                    <input type="hidden" id="ingredient-id">
                    <div>
                        <label for="ingredient-name" class="block text-sm font-medium text-gray-700">Nom</label>
                        <input type="text" id="ingredient-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                    </div>
                    <div>
                        <label for="ingredient-unit" class="block text-sm font-medium text-gray-700">Unit√© par d√©faut</label>
                        <select id="ingredient-unit" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select>
                    </div>
                    <div>
                        <label for="ingredient-category" class="block text-sm font-medium text-gray-700">Cat√©gorie</label>
                        <select id="ingredient-category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></select>
                    </div>
                    <div>
                        <label for="ingredient-image-url" class="block text-sm font-medium text-gray-700">URL de l'image</label>
                        <input type="text" id="ingredient-image-url" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="Laisser vide pour une image al√©atoire">
                    </div>
                    <div class="flex justify-end space-x-4 pt-2">
                        <button type="button" id="cancel-ingredient-btn" class="btn btn-ghost">Annuler</button>
                        <button type="submit" id="save-ingredient-btn" class="btn btn-primary">Sauvegarder</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Category Management Modal -->
        <div id="category-management-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-lg relative">
                <h3 class="text-lg font-bold mb-4">G√©rer les cat√©gories d'ingr√©dients</h3>
                <form id="add-category-form" class="flex items-center space-x-2 mb-4">
                    <input type="text" id="new-category-name" placeholder="Nom de la nouvelle cat√©gorie" class="flex-grow mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                    <button type="submit" class="btn btn-secondary">Ajouter</button>
                </form>
                <div id="category-list" class="max-h-64 overflow-y-auto border rounded-lg p-2"></div>
                <div class="flex justify-end space-x-4 mt-4">
                     <button type="button" id="close-category-modal" class="btn btn-ghost">Annuler</button>
                    <button type="button" id="done-category-modal-btn" class="btn btn-primary">Termin√©</button>
                </div>
            </div>
        </div>
        `,script:"./ingredients.js"},lists:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Listes de Courses</h2>
            <button id="add-list-btn" class="btn btn-primary">
                <i class="fas fa-plus mr-2"></i> Cr√©er une liste
            </button>
        </div>

        <!-- Search Bar -->
        <div class="mb-6">
            <input type="text" id="search-bar" placeholder="Rechercher une liste..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-tomato focus:border-tomato">
        </div>

        <!-- Lists Container -->
        <div id="lists-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

        <div class="mt-12">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6">Listes Partag√©es</h2>
            <div id="shared-lists-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Les listes partag√©es seront charg√©es ici par JS -->
            </div>
        </div>

        <!-- List Form Modal -->
        <div id="list-form-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-start justify-center z-[100] hidden pt-20">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-3xl min-h-[75vh] max-h-[90vh] overflow-y-auto relative">
                <button id="close-list-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10"><i class="fas fa-times text-xl"></i></button>
                <h3 id="list-modal-title" class="text-lg font-bold mb-4">Cr√©er une liste</h3>
                <form id="list-form" class="space-y-4 pb-20">
                    <input type="hidden" id="list-id">
                    <div>
                        <label for="list-name" class="block text-sm font-medium text-gray-700">Nom de la liste</label>
                        <input type="text" id="list-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                    </div>
                    <div>
                        <h4 class="text-md font-medium text-gray-800 mb-2">Ingr√©dients</h4>
                        <div id="ingredients-list" class="space-y-2"></div>
                        <button type="button" id="add-ingredient-btn" class="btn btn-outline btn-sm mt-2">
                            <i class="fas fa-plus mr-2"></i> Ajouter un ingr√©dient
                        </button>
                    </div>
                </form>
                <div class="absolute bottom-0 left-0 right-0 px-6 py-4 bg-white/95 backdrop-blur-sm border-t border-gray-200 flex justify-end space-x-4">
                    <button type="button" id="cancel-list-btn" class="btn btn-ghost">Annuler</button>
                    <button type="submit" form="list-form" id="save-list-btn" class="btn btn-primary">Sauvegarder la liste</button>
                </div>
            </div>
        </div>
        `,script:"./lists.js"},friends:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Amis</h2>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="md:col-span-2 space-y-8">
                <div>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Liste d'amis</h3>
                    <div id="friends-list-container" class="space-y-4">
                        <!-- La liste d'amis sera charg√©e ici -->
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Demandes envoy√©es en attente</h3>
                    <div id="pending-requests-container" class="space-y-4">
                        <!-- Les demandes envoy√©es en attente seront charg√©es ici -->
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Demandes rejet√©es</h3>
                    <div id="declined-requests-container" class="space-y-4">
                        <!-- Les demandes rejet√©es seront charg√©es ici -->
                    </div>
                </div>
            </div>
            <div>
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Rechercher un ami</h3>
                    <div class="mb-4">
                        <div class="flex items-center space-x-2">
                            <input type="text" id="search-friends-input" placeholder="Nom ou email..." class="flex-grow p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-tomato focus:border-tomato">
                            <button id="search-friends-btn" class="btn btn-primary"><i class="fas fa-search"></i></button>
                        </div>
                        <div id="search-results-container" class="mt-2 space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>
        `,script:"./friends.js"},shared:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Partages</h2>
        </div>

        <div class="space-y-12">
            <div>
                <h3 class="text-xl font-bold text-gray-700 border-b pb-2 mb-4">Partages Re√ßus</h3>
                <div id="received-shares-container" class="space-y-4">
                    <!-- L'historique des partages accept√©s sera charg√© ici -->
                </div>
            </div>
            <div>
                <h3 class="text-xl font-bold text-gray-700 border-b pb-2 mb-4">Mes Partages Envoy√©s</h3>
                <div id="sent-shares-container" class="space-y-4">
                    <!-- L'historique des partages envoy√©s sera charg√© ici -->
                </div>
            </div>
        </div>
        `,script:"./shared.js"},plans:{html:`
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Mes Plans Sauvegard√©s</h2>
        </div>
        <div id="all-plans-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- La liste des plans sera charg√©e ici -->
            <p class="text-center text-gray-500 p-10 col-span-full">Chargement de vos plans...</p>
        </div>
        `,script:"./all-plans.js"},"view-plan":{html:`
        <section aria-labelledby="meal-planning-heading" class="mb-8 md:mb-12">
            <div class="flex justify-between items-center mb-4">
                <h2 id="plan-view-name" class="text-xl md:text-2xl font-bold text-gray-800">Chargement du plan...</h2>
                <button id="close-view-plan-btn" class="btn btn-outline">
                    <i class="fas fa-times mr-2"></i> Fermer et voir mes plans
                </button>
            </div>
            <div class="bg-white rounded-xl shadow-md p-4">
                <div id="meal-plan-grid-layout">
                    <!-- Header -->
                    <div class="grid grid-cols-[100px_35px_repeat(5,_minmax(0,_1fr))_35px_repeat(5,_minmax(0,_1fr))] gap-1 text-center mb-1">
                        <div class="p-2"></div> <!-- Empty corner -->
                        <div class="p-2 rounded-t-lg bg-amber-100 text-amber-800 font-bold col-span-6">MIDI</div>
                        <div class="p-2 rounded-t-lg bg-stone-200 text-stone-800 font-bold col-span-6">SOIR</div>
                        <div class="p-1"></div> <!-- Empty under day name -->
                        <div class="p-1 text-xs font-semibold"><i class="fas fa-users"></i></div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Entr√©e</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Plat</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Accomp.</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Dessert</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Remarque</div>
                        <div class="p-1 text-xs font-semibold"><i class="fas fa-users"></i></div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Entr√©e</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Plat</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Accomp.</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Dessert</div>
                        <div class="p-1 text-xs font-semibold text-gray-600">Remarque</div>
                    </div>
                    <!-- Rows generated by JS -->
                    <div id="meal-plan-grid" class="space-y-1">
                        <div class="p-10 text-center text-gray-500 italic col-span-full">Chargement de la planification...</div>
                    </div>
                </div>
            </div>
        </section>
        `,script:"./view-plan.js"},"shopping-mode":{html:`
        <div class="max-w-2xl mx-auto bg-white min-h-screen pb-20 md:pb-0">
            <div class="sticky top-0 bg-white z-20 border-b border-gray-200 shadow-sm px-4 py-3 flex justify-between items-center">
                <button id="shopping-mode-back-btn" class="text-gray-600 hover:text-tomato">
                    <i class="fas fa-arrow-left text-xl"></i>
                </button>
                <h2 class="text-xl font-bold text-gray-800">Faire les courses</h2>
                <select id="shopping-mode-plan-select" class="text-sm border-none focus:ring-0 font-medium text-tomato bg-transparent text-right w-32 md:w-auto overflow-hidden text-ellipsis">
                    <option>Chargement...</option>
                </select>
            </div>
            
            <div id="shopping-mode-container" class="p-4">
                <p class="text-center text-gray-500 mt-10">Chargement de la liste...</p>
            </div>
        </div>
        `,script:"./shopping-mode.js"}},Qa=Object.assign({"./all-plans.js":Kn,"./auth.js":Wn,"./firebase-config.js":Vn,"./form-handler.js":Yn,"./friends.js":sa,"./ingredients.js":ia,"./lists.js":ca,"./main.js":Qn,"./notifications.js":Ca,"./plans.js":ha,"./presence.js":Ia,"./recipes.js":Sa,"./script.js":Ma,"./shared.js":$a,"./sharing.js":la,"./shopping-mode.js":qa,"./view-plan.js":za});let vt=null;async function ot(e){typeof vt=="function"&&(vt(),vt=null);const t=Va[e];if(t&&rn){if(rn.innerHTML=t.html,t.script){const n=Qa[t.script];n?n.default&&typeof n.default=="function"&&(vt=n.default()):console.error(`Module not found for path: ${t.script}`)}}else console.error(`Route not found: ${e}`)}function Wa(){const e=je();if(e){const n=document.getElementById("user-display-name");n&&(n.textContent=e.displayName||e.email)}const t=document.querySelectorAll(".nav-btn");t.forEach(n=>{n.addEventListener("click",a=>{const r=a.currentTarget.dataset.path;ot(r),t.forEach(i=>{i.classList.remove("bg-tomato","text-white"),i.classList.add("bg-white","text-tomato")}),a.currentTarget.classList.add("bg-tomato","text-white"),a.currentTarget.classList.remove("bg-white","text-tomato")})}),ot("menu"),Sn()}document.addEventListener("DOMContentLoaded",()=>{cn().then(g=>{g&&Wa()});const e=document.getElementById("profile-btn"),t=document.getElementById("profile-menu");e&&t&&(e.addEventListener("click",g=>{g.stopPropagation(),t.classList.toggle("hidden");const C=!t.classList.contains("hidden");e.setAttribute("aria-expanded",C)}),document.addEventListener("click",g=>{!(t.contains(g.target)||e.contains(g.target))&&!t.classList.contains("hidden")&&(t.classList.add("hidden"),e.setAttribute("aria-expanded","false"))}));const n=document.getElementById("settings-link"),a=document.getElementById("settings-modal"),r=document.getElementById("close-settings-modal"),i=document.getElementById("dark-mode-toggle"),c=g=>{g==="dark"?(document.documentElement.classList.add("dark"),i&&(i.checked=!0)):(document.documentElement.classList.remove("dark"),i&&(i.checked=!1))},m=localStorage.getItem("theme");m?c(m):window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?c("dark"):c("light"),n&&a&&n.addEventListener("click",g=>{g.preventDefault(),a.classList.remove("hidden")}),r&&a&&r.addEventListener("click",()=>{a.classList.add("hidden")}),a&&a.addEventListener("click",g=>{g.target===a&&a.classList.add("hidden")}),i&&i.addEventListener("change",()=>{const g=i.checked?"dark":"light";localStorage.setItem("theme",g),c(g)});const f=document.getElementById("mobile-menu-btn"),p=document.getElementById("mobile-menu"),x=document.querySelectorAll(".nav-btn-mobile");f&&p&&f.addEventListener("click",()=>{p.classList.toggle("hidden")});const L=document.getElementById("profile-btn-mobile");L&&a&&L.addEventListener("click",()=>{a.classList.remove("hidden"),p&&p.classList.add("hidden")}),x.forEach(g=>{g.addEventListener("click",C=>{const M=C.currentTarget.dataset.path;ot(M),p&&p.classList.add("hidden")})})});
