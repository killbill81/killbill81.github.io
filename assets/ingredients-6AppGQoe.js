import{d,g as I,c as L,a as ge,s as fe,b as j,q as G,w as K,e as z,f as W,h as he,i as ye}from"./firebase-config-DVWBM_53.js";import{s as S}from"./main-3FHrQZxb.js";import{ingredientModalManager as X}from"./ingredient-modal-CeAX3Sgs.js";function Ee(){const O=document.getElementById("ingredients-list-container"),Y=document.getElementById("add-ingredient-btn"),F=document.getElementById("category-tabs"),Z=document.getElementById("search-bar"),ee=document.getElementById("manage-categories-btn"),P=document.getElementById("category-management-modal"),te=document.getElementById("close-category-modal"),ne=document.getElementById("done-category-modal-btn"),ae=document.getElementById("add-category-form"),_=document.getElementById("new-category-name"),U=document.getElementById("category-list"),v=document.getElementById("audit-ingredients-btn"),B=document.getElementById("audit-modal"),J=document.getElementById("close-audit-modal"),h=document.getElementById("apply-audit-btn"),E=document.getElementById("audit-results-list");let p=[],y=[],g="",C="",N=null;async function k(){await V(),await M()}async function V(){if(d)try{y=(await I(L(d,"ingredient_categories"))).docs.map(t=>({id:t.id,...t.data()})),y.sort((t,n)=>t.name.localeCompare(n.name))}catch(r){console.error("Erreur lors de la r√©cup√©ration des cat√©gories: ",r)}}async function M(){if(d)try{p=(await I(L(d,"ingredients"))).docs.map(t=>({id:t.id,...t.data()})),A(),H()}catch(r){console.error("Erreur de chargement des ingr√©dients: ",r)}}function re(){T(),P.classList.remove("hidden")}function Q(){P.classList.add("hidden")}function T(){if(U.innerHTML="",y.length===0){U.innerHTML='<p class="text-gray-500">Aucune cat√©gorie d√©finie.</p>';return}y.forEach(r=>{const t=document.createElement("div");t.className="flex items-center justify-between p-2 border-b";const n=document.createElement("span");n.textContent=r.name,t.appendChild(n);const e=document.createElement("div");e.className="flex space-x-2";const a=document.createElement("button");a.className="text-blue-500 hover:bg-blue-50 text-xs px-2 py-1 rounded-md",a.innerHTML='<i class="fas fa-edit"></i>',a.addEventListener("click",()=>se(r)),e.appendChild(a);const i=document.createElement("button");i.className="text-red-500 hover:bg-red-50 text-xs px-2 py-1 rounded-md",i.innerHTML='<i class="fas fa-trash"></i>',i.addEventListener("click",()=>ie(r)),e.appendChild(i),t.appendChild(e),U.appendChild(t)})}async function oe(r){r.preventDefault();const t=_.value.trim();if(t&&!y.find(n=>n.name.toLowerCase()===t.toLowerCase()))try{await ge(L(d,"ingredient_categories"),{name:t}),_.value="",await V(),T(),A()}catch(n){console.error("Erreur d'ajout de cat√©gorie: ",n)}else alert("Cette cat√©gorie existe d√©j√† ou le nom est invalide.")}async function se(r){const t=r.name,n=prompt(`Entrez le nouveau nom pour la cat√©gorie "${t}":`,t);if(n&&n.trim()!==""&&n!==t)try{await fe(j(d,"ingredient_categories",r.id),{name:n});const e=G(L(d,"ingredients"),K("category","==",t)),a=await I(e),i=z(d);a.forEach(s=>{i.update(s.ref,{category:n})}),await i.commit(),await k(),T()}catch(e){console.error("Erreur de renommage: ",e)}}async function ie(r){if(confirm(`√ätes-vous s√ªr de vouloir supprimer la cat√©gorie "${r.name}"?

Tous les ingr√©dients associ√©s seront d√©plac√©s vers la cat√©gorie "Inconnue".`))try{await W(j(d,"ingredient_categories",r.id));const t=G(L(d,"ingredients"),K("category","==",r.name)),n=await I(t),e=z(d);n.forEach(a=>{e.update(a.ref,{category:"Inconnue"})}),await e.commit(),g="",await k(),T()}catch(t){console.error("Erreur de suppression: ",t)}}function A(){F.innerHTML="";const r=y.map(e=>e.name),t=[...new Set(p.map(e=>e.category||"Inconnue"))];let n=[...new Set([...r,...t])];n.sort((e,a)=>e.localeCompare(a)),n.includes("Inconnue")&&(n=n.filter(e=>e!=="Inconnue"),n.push("Inconnue")),n.length===0&&p.length>0&&n.push("Inconnue"),!g&&n.length>0&&(g=n[0]),n.forEach(e=>{const a=document.createElement("button"),i=e===g;a.className=`px-4 py-2 text-sm font-medium rounded-t-lg ${i?"bg-tomato text-white":"text-gray-500 hover:text-tomato"}`,a.textContent=e,a.addEventListener("click",()=>de(e)),F.appendChild(a)})}function de(r){g=r,A(),H()}function H(){O.innerHTML="";const r=g||(y.length>0?y[0].name:"Inconnue");let t=p.filter(e=>(e.category||"Inconnue")===r);if(C){const e=C.toLowerCase();t=t.filter(a=>a.name.toLowerCase().includes(e))}if(t.forEach(e=>e.seasonScore=S.getIngredientScore(e)),S.config.offSeasonBehavior==="hide"&&(t=t.filter(e=>e.seasonScore>0)),t.length===0){O.innerHTML='<p class="text-center text-gray-500 p-10">Aucun ingr√©dient dans cette cat√©gorie (ou tout est masqu√©).</p>';return}S.config.offSeasonBehavior==="last"||S.config.offSeasonBehavior==="dim"?t.sort((e,a)=>a.seasonScore!==e.seasonScore?a.seasonScore-e.seasonScore:e.name.localeCompare(a.name,"fr",{sensitivity:"base"})):t.sort((e,a)=>e.name.localeCompare(a.name,"fr",{sensitivity:"base"}));const n=document.createElement("div");n.className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4",t.forEach(e=>{const a=e.seasonScore===0,i=a&&S.config.offSeasonBehavior==="dim"?"opacity-50 grayscale transition-all hover:grayscale-0 hover:opacity-100":"",s=document.createElement("div");if(s.className=`p-3 bg-white shadow-sm rounded-lg flex flex-col items-start space-y-2 relative border border-transparent ${i}`,e.imageUrl){const o=document.createElement("div");o.className="relative w-full h-24 mb-2";const l=document.createElement("img");if(l.src=e.imageUrl,l.alt=e.name,l.className="w-full h-full object-cover rounded-md",o.appendChild(l),e.seasonScore===2){const c=document.createElement("div");c.className="absolute top-1 right-1 bg-green-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm z-10",c.textContent="De saison",o.appendChild(c)}else if(a){const c=document.createElement("div");c.className="absolute top-1 right-1 bg-gray-500/80 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm backdrop-blur-sm z-10",c.textContent="Hors saison",o.appendChild(c)}s.appendChild(o)}else if(e.seasonScore===2){s.classList.add("border-green-100");const o=document.createElement("div");o.className="absolute top-2 right-2 bg-green-100 text-green-700 text-[10px] font-bold px-2 py-0.5 rounded-full border border-green-200 shadow-sm z-10",o.textContent="De saison",s.appendChild(o)}else if(a){const o=document.createElement("div");o.className="absolute top-2 right-2 bg-gray-100 text-gray-500 text-[10px] font-bold px-2 py-0.5 rounded-full border border-gray-200 shadow-sm z-10",o.textContent="Hors saison",s.appendChild(o)}const x=document.createElement("div");x.className="flex-grow w-full flex justify-between items-center";const m=document.createElement("span");m.className="font-medium text-gray-800",m.textContent=e.name;const f=document.createElement("span");f.className="text-gray-500 text-sm bg-gray-100 px-2 py-1 rounded-full",f.textContent=e.unit,x.appendChild(m),x.appendChild(f),s.appendChild(x);const b=document.createElement("div");b.className="w-full flex flex-col gap-1 mt-1 px-1";let R=!1;if(e.seasons&&e.seasons.length>0){R=!0;const o=document.createElement("div");o.className="flex flex-wrap gap-1";const l={Printemps:"üå∏",Et√©:"‚òÄÔ∏è",Automne:"üçÇ",Hiver:"‚ùÑÔ∏è"},c=["Printemps","Et√©","Automne","Hiver"];e.seasons.sort((u,w)=>c.indexOf(u)-c.indexOf(w)).forEach(u=>{const w=document.createElement("span");w.textContent=`${l[u]||""} ${u}`,w.title=u,w.className="text-[10px] text-gray-600 bg-gray-100 px-1.5 py-0.5 rounded-full border border-gray-200 whitespace-nowrap",o.appendChild(w)}),b.appendChild(o)}if(e.months&&e.months.length>0){R=!0;const o=document.createElement("div");o.className="flex flex-wrap gap-1";const l=["Janvier","F√©vrier","Mars","Avril","Mai","Juin","Juillet","Ao√ªt","Septembre","Octobre","Novembre","D√©cembre"];e.months.sort((c,u)=>l.indexOf(c)-l.indexOf(u)),e.months.forEach(c=>{const u=document.createElement("span");u.textContent=c.slice(0,3)+".",u.title=c,u.className="text-[10px] text-gray-600 bg-blue-50 px-1.5 py-0.5 rounded-full border border-blue-100 whitespace-nowrap",o.appendChild(u)}),b.appendChild(o)}if(!R){const o=document.createElement("div");o.className="flex flex-wrap gap-1";const l=document.createElement("span");l.textContent="Toute l'ann√©e üåç",l.className="text-[10px] text-green-700 bg-green-50 px-1.5 py-0.5 rounded-full border border-green-200 whitespace-nowrap",o.appendChild(l),b.appendChild(o)}s.appendChild(b);const $=document.createElement("div");$.className="w-full flex justify-end items-center space-x-2 border-t pt-2 mt-2";const D=document.createElement("button");D.className="text-blue-500 hover:bg-blue-50 text-xs px-2 py-1 rounded-md",D.innerHTML='<i class="fas fa-edit"></i>',D.addEventListener("click",()=>X.open(e,M));const q=document.createElement("button");q.className="text-red-500 hover:bg-red-50 text-xs px-2 py-1 rounded-md",q.innerHTML='<i class="fas fa-trash-alt"></i>',q.addEventListener("click",()=>ce(e.id,e.name)),$.appendChild(D),$.appendChild(q),s.appendChild($),n.appendChild(s)}),O.appendChild(n)}async function ce(r,t){if(confirm(`√ätes-vous s√ªr de vouloir supprimer l'ingr√©dient "${t}" ?`))try{await W(j(d,"ingredients",r)),await M()}catch(n){console.error("Erreur de suppression de l'ingr√©dient: ",n)}}async function le(){if(p.length===0){alert("Aucun ingr√©dient √† auditer.");return}v.disabled=!0,v.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i> Audit en cours...',E.innerHTML=`<tr><td colspan="5" class="p-6 text-center text-gray-500 italic"><i class="fas fa-spinner fa-spin mr-2"></i> Analyse en cours (cela peut prendre du temps si vous avez beaucoup d'ingr√©dients)...</td></tr>`;try{const r=he(),t=ye(r,"auditIngredients"),n=50;let e=[];for(let a=0;a<p.length;a+=n){const i=p.slice(a,a+n),s=await t({ingredients:i});s.data&&s.data.suggestions&&(e=e.concat(s.data.suggestions))}me(e),B.classList.remove("hidden")}catch(r){console.error("Audit failed:",r),alert("Erreur lors de l'audit : "+r.message)}finally{v.disabled=!1,v.innerHTML='<i class="fas fa-stethoscope mr-2"></i> Audit Qualit√© IA'}}function me(r){E.innerHTML="",r.forEach(t=>{const n=p.find(i=>i.name===t.name);if(!n||!(t.unit!==(n.unit||"")||t.cat!==(n.category||"")))return;const a=document.createElement("tr");a.className="hover:bg-gray-50 dark:hover:bg-gray-700/30 transition-colors",a.innerHTML=`
                <td class="px-4 py-4 text-sm font-semibold text-gray-900 dark:text-gray-100">${t.name}</td>
                <td class="px-4 py-4 text-sm text-gray-600 dark:text-gray-400">
                    <div class="flex flex-col gap-1">
                        <span class="inline-flex items-center px-1.5 py-0.5 rounded-md bg-gray-100 dark:bg-gray-700 text-[10px] font-medium text-gray-600 dark:text-gray-400">U: ${n.unit||"n/a"}</span>
                        <span class="inline-flex items-center px-1.5 py-0.5 rounded-md bg-gray-100 dark:bg-gray-700 text-[10px] font-medium text-gray-600 dark:text-gray-400">C: ${n.category||"n/a"}</span>
                    </div>
                </td>
                <td class="px-4 py-4 text-sm">
                    <div class="flex flex-col gap-1">
                        <span class="inline-flex items-center px-1.5 py-0.5 rounded-md bg-tomato/10 text-tomato text-[10px] font-bold border border-tomato/20">${t.unit}</span>
                        <span class="inline-flex items-center px-1.5 py-0.5 rounded-md bg-tomato/10 text-tomato text-[10px] font-bold border border-tomato/20">${t.cat}</span>
                    </div>
                </td>
                <td class="px-4 py-4 text-xs text-gray-500 dark:text-gray-400 italic font-medium leading-relaxed max-w-[200px] break-words" title="${t.reason}">${t.reason}</td>
                <td class="px-4 py-4 text-center">
                    <div class="flex items-center justify-center">
                        <input type="checkbox" class="audit-apply-checkbox w-6 h-6 border-2 border-gray-300 dark:border-gray-600 rounded cursor-pointer accent-tomato" 
                            data-id="${n.id}" 
                            data-unit="${t.unit}" 
                            data-cat="${t.cat}" checked>
                    </div>
                </td>
            `,E.appendChild(a)}),E.innerHTML===""?(E.innerHTML='<tr><td colspan="5" class="p-12 text-center text-gray-500 dark:text-gray-400 italic text-lg font-medium">‚ú® Aucune am√©lioration sugg√©r√©e. Vos donn√©es sont parfaites !</td></tr>',h.classList.add("hidden")):h.classList.remove("hidden")}async function ue(){const r=E.querySelectorAll(".audit-apply-checkbox:checked");if(r.length===0){B.classList.add("hidden");return}const t=`Vous allez mettre √† jour ${r.length} ingr√©dients. 

IMPORTANT : Ces changements seront √©galement propag√©s √† toutes vos recettes existantes pour garantir la coh√©rence des unit√©s. 

Souhaitez-vous continuer ?`;if(confirm(t)){h.disabled=!0,h.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i> Application...';try{const n=z(d),e=[];r.forEach(a=>{const i=a.dataset.id,s=a.dataset.unit,x=a.dataset.cat,m=p.find(f=>f.id===i);m&&e.push({name:m.name,oldUnit:m.unit,newUnit:s}),n.update(j(d,"ingredients",i),{unit:s,category:x})}),await n.commit(),await pe(e),alert(`${r.length} ingr√©dients mis √† jour et propag√©s aux recettes !`),B.classList.add("hidden"),await k()}catch(n){console.error("Batch update failed:",n),alert("Erreur lors de la mise √† jour : "+n.message)}finally{h.disabled=!1,h.innerHTML="Enregistrer les s√©lectionn√©s"}}}async function pe(r){const t=await I(L(d,"recipes")),n=z(d);let e=0;t.forEach(a=>{const i=a.data();let s=!1;const x=(i.ingredients||[]).map(m=>{const f=r.find(b=>b.name===m.name);return f&&m.unit!==f.newUnit?(s=!0,{...m,unit:f.newUnit}):m});s&&(n.update(a.ref,{ingredients:x}),e++)}),e>0&&(await n.commit(),console.log(`Propagatated changes to ${e} recipes.`))}window.addEventListener("seasonality-config-changed",()=>{H()}),Z.addEventListener("input",r=>{const t=r.target.value.toLowerCase();if(!C&&t&&(N=g),C=t,C){const n=p.find(e=>e.name.toLowerCase().includes(C));n&&(g=n.category||"Inconnue")}else N&&(g=N,N=null);A(),H()}),Y.addEventListener("click",()=>X.open(null,M)),ee.addEventListener("click",re),te.addEventListener("click",Q),ne.addEventListener("click",Q),ae.addEventListener("submit",oe),v&&v.addEventListener("click",le),J&&J.addEventListener("click",()=>B.classList.add("hidden")),h&&h.addEventListener("click",ue),k()}export{Ee as default};
